const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-0PuXI_Dv.js","assets/build-message-history-Dxr5bVnZ.js","assets/index-DQfoDVCK.js","assets/index-sZ3hiXm2.css","assets/routes-C5PhwoUX.js","assets/index-DN5Sxtf9.js","assets/objectWithoutPropertiesLoose-BjXSgPXB.js","assets/index-yo8sdyKX.js","assets/index-Ux8lesU9.css"])))=>i.map(i=>d[i]);
import{c as be,r as i,j as t,P as I,i as Ce,u as ee,g as R,h as ae,s as se,Y as Se,y as b,p as Le,_ as te,L as De,ae as Me,W as ne,ac as Re,ap as re,C as ke,__tla as Ee}from"./index-DQfoDVCK.js";import{B as ie,__tla as Fe}from"./routes-C5PhwoUX.js";import{u as Te,__tla as Ae}from"./index-BZBIgGUy.js";import{ar as Ie,I as Oe,L as S,j as le,A as Pe,p as Ve,k as Be,v as Je,F as ze,w as qe,r as Ue,__tla as We}from"./build-message-history-Dxr5bVnZ.js";import He,{__tla as Ye}from"./copy-FLwQeHnS.js";import Ge,{__tla as Ke}from"./refresh-ccw-D3P_b69w.js";import $e,{__tla as Qe}from"./volume-2-B7PGr3SH.js";import{__tla as Xe}from"./createLucideIcon-CNZWHefm.js";let oe,Ze=Promise.all([(()=>{try{return Ee}catch{}})(),(()=>{try{return Fe}catch{}})(),(()=>{try{return Ae}catch{}})(),(()=>{try{return We}catch{}})(),(()=>{try{return Ye}catch{}})(),(()=>{try{return Ke}catch{}})(),(()=>{try{return Qe}catch{}})(),(()=>{try{return Xe}catch{}})()]).then(async()=>{var T="Avatar",[ce,ea]=be(T),[de,O]=ce(T),P=i.forwardRef((e,n)=>{const{__scopeAvatar:s,...l}=e,[o,r]=i.useState("idle");return t.jsx(de,{scope:s,imageLoadingStatus:o,onImageLoadingStatusChange:r,children:t.jsx(I.span,{...l,ref:n})})});P.displayName=T;var V="AvatarImage",B=i.forwardRef((e,n)=>{const{__scopeAvatar:s,src:l,onLoadingStatusChange:o=()=>{},...r}=e,c=O(V,s),u=ue(l,r.referrerPolicy),a=Ce(h=>{o(h),c.onImageLoadingStatusChange(h)});return ee(()=>{u!=="idle"&&a(u)},[u,a]),u==="loaded"?t.jsx(I.img,{...r,ref:n,src:l}):null});B.displayName=V;var J="AvatarFallback",z=i.forwardRef((e,n)=>{const{__scopeAvatar:s,delayMs:l,...o}=e,r=O(J,s),[c,u]=i.useState(l===void 0);return i.useEffect(()=>{if(l!==void 0){const a=window.setTimeout(()=>u(!0),l);return()=>window.clearTimeout(a)}},[l]),c&&r.imageLoadingStatus!=="loaded"?t.jsx(I.span,{...o,ref:n}):null});z.displayName=J;function ue(e,n){const[s,l]=i.useState("idle");return ee(()=>{if(!e){l("error");return}let o=!0;const r=new window.Image,c=u=>()=>{o&&l(u)};return l("loading"),r.onload=c("loaded"),r.onerror=c("error"),r.src=e,n&&(r.referrerPolicy=n),()=>{o=!1}},[e,n]),s}var q=P,U=B,W=z;const H=i.forwardRef(({className:e,...n},s)=>t.jsx(q,{ref:s,className:R("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...n}));H.displayName=q.displayName;const Y=i.forwardRef(({className:e,...n},s)=>t.jsx(U,{ref:s,className:R("aspect-square h-full w-full",e),...n}));Y.displayName=U.displayName;const G=i.forwardRef(({className:e,...n},s)=>t.jsx(W,{ref:s,className:R("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...n}));G.displayName=W.displayName;function K(){return t.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",className:"text-foreground",children:[t.jsx("circle",{cx:"4",cy:"12",r:"2",fill:"currentColor",children:t.jsx("animate",{id:"spinner_qFRN",begin:"0;spinner_OcgL.end+0.25s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),t.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",children:t.jsx("animate",{begin:"spinner_qFRN.begin+0.1s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),t.jsx("circle",{cx:"20",cy:"12",r:"2",fill:"currentColor",children:t.jsx("animate",{id:"spinner_OcgL",begin:"spinner_qFRN.begin+0.2s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})})]})}const me=ae("flex gap-2 max-w-[60%] items-end relative group",{variants:{variant:{received:"self-start",sent:"self-end flex-row-reverse"},layout:{default:"",ai:"max-w-full w-full items-center"}},defaultVariants:{variant:"received",layout:"default"}}),$=i.forwardRef(({className:e,variant:n,layout:s,children:l,...o},r)=>t.jsx("div",{className:R(me({variant:n,layout:s,className:e}),"relative group"),ref:r,...o,children:i.Children.map(l,c=>i.isValidElement(c)&&typeof c.type!="string"?i.cloneElement(c,{variant:n,layout:s}):c)}));$.displayName="ChatBubble";const fe=({src:e,fallback:n,className:s})=>t.jsxs(H,{className:s,children:[t.jsx(Y,{src:e,alt:"Avatar"}),t.jsx(G,{children:n})]}),pe=ae("p-4",{variants:{variant:{received:"bg-secondary text-secondary-foreground rounded-r-lg rounded-tl-lg",sent:"bg-primary text-primary-foreground rounded-l-lg rounded-tr-lg"},layout:{default:"",ai:"border-t w-full rounded-none bg-transparent"}},defaultVariants:{variant:"received",layout:"default"}}),Q=i.forwardRef(({className:e,variant:n,layout:s,isLoading:l=!1,children:o,...r},c)=>t.jsx("div",{className:R(pe({variant:n,layout:s,className:e}),"break-words max-w-full whitespace-pre-wrap"),ref:c,...r,children:l?t.jsx("div",{className:"flex items-center space-x-2",children:t.jsx(K,{})}):o}));Q.displayName="ChatBubbleMessage";const he=({icon:e,onClick:n,className:s,variant:l="ghost",size:o="icon",...r})=>t.jsx(ie,{variant:l,size:o,className:s,onClick:n,...r,children:e}),ge=i.forwardRef(({variant:e,className:n,children:s,...l},o)=>t.jsx("div",{ref:o,className:R("absolute top-1/2 -translate-y-1/2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200",e==="sent"?"-left-1 -translate-x-full flex-row-reverse":"-right-1 translate-x-full",n),...l,children:s}));ge.displayName="ChatBubbleActionWrapper";const X=i.forwardRef(({className:e,children:n,...s},l)=>t.jsx("div",{className:R("flex flex-col w-full h-full p-4 gap-6 overflow-y-auto",e),ref:l,...s,children:n}));X.displayName="ChatMessageList";const _e=()=>{var w;const[e,n]=i.useState(),[s,l]=i.useState(),[o,r]=i.useState(),c=i.useRef(),u=i.useRef({}),a=se(d=>d.currentSession),h=Se(d=>d.loadModel),v=i.useCallback(async()=>{var d,x;try{if(u.current.handling=a==null?void 0:a.id,!(a!=null&&a.id)||!(a!=null&&a.main_source_id)||(a==null?void 0:a.main_source_type)!=="Thread")return;const[m,f]=await Promise.all([b("Thread").findOne({where:{id:a.main_source_id,session_id:a.id}}),b("FlowNode").findOne({where:{source_id:a.main_source_id,source_type:"Thread",session_id:a.id}})]);if(!m||!f)return;const g=await b("FlowEdge").find({where:{session_id:a.id,target:f.id}}),{flowNodes:k,flowNodeDatas:L}=await Ie({where:{session_id:a.id,id:Oe(g.map(p=>p.source))}}),N=(await b("FlowEdge").find({where:{session_id:a.id}})).filter(p=>p.target===f.id).map(p=>{var Z;const j=k.find(A=>A.id===p.source);return{connection:p,source:j,entity:(Z=L==null?void 0:L[j.source_type])==null?void 0:Z.find(A=>A.id===j.source_id)}}),E=N.find(p=>p.source.source_type==="LLM"),D=N.filter(p=>p.source.source_type==="Prompt"),M=N.find(p=>p.source.source_type==="Schema");if(!(E!=null&&E.entity))return;const F=await b("FlowEdge").findOne({where:{session_id:a.id,source:f.id},order:{id:"DESC"}});if(F){const p=await b("FlowNode").findOne({where:{id:F.target,session_id:a.id}});if(!p)return;const j=await b("JSONData").findOne({where:{id:p.source_id,session_id:a.id}});if(!j)return;(d=c.current)==null||d.call(c,j.data),r({node:p,enity:j})}else{const p=await b("JSONData").save({headers:"item",session_id:a.id,json:"",data:[]});if(!p)return;const j=await b("FlowNode").save({session_id:a.id,source_id:p.id,source_type:"JSONData",node_type:"JSON_DATA",x:0,y:0});if(!j)return;await b("FlowEdge").save({session_id:a.id,source:f.id,target:j.id}),(x=c.current)==null||x.call(c,[]),r({node:j,enity:p})}console.log("here"),l({llm:E.entity,status:S.Started,progress:""}),n({thread:m,prompts:(D==null?void 0:D.map(p=>p.entity))||[],schema:M==null?void 0:M.entity}),u.current.handled=a.id}finally{u.current.handling=void 0}},[a==null?void 0:a.id,a==null?void 0:a.main_source_id,a==null?void 0:a.main_source_type]),C=i.useCallback(async()=>{if(s!=null&&s.llm.name)try{l(d=>d&&{...d,status:S.Loading}),await h(s==null?void 0:s.llm.name,d=>{l(x=>x&&{...x,progress:d.text})}),l(d=>d&&{...d,status:S.Loaded,progress:""})}catch{l(d=>d&&{...d,status:S.Started,progress:""})}},[(w=s==null?void 0:s.llm)==null?void 0:w.name,h]),y=i.useCallback(d=>(c.current=d,()=>{c.current=void 0}),[]),_=i.useCallback(async d=>{!(o!=null&&o.node)||!(o!=null&&o.enity)||await b("JSONData").save({...o.enity,data:d})},[o==null?void 0:o.enity,o==null?void 0:o.node]);return i.useEffect(()=>{u.current.handling||(u==null?void 0:u.current.handled)===(a==null?void 0:a.id)||v()},[a==null?void 0:a.id,v]),{...e,loadLLM:C,mainLLMInfo:s,currentDataNode:o,updateMessagesData:_,onThreadMessagesLoaded:y}},ye=i.memo(({llm:e,status:n,loadLLM:s,progress:l})=>{const{t:o}=Le("flows"),[r,c]=i.useState();i.useEffect(()=>{r||!(e!=null&&e.name)||te(()=>import("./index-0PuXI_Dv.js").then(async h=>(await h.__tla,h)),__vite__mapDeps([0,1,2,3,4])).then(async({hasModelInCache:h,functionCallingModelIds:v,prebuiltAppConfig:C})=>{const y=await h(e==null?void 0:e.name);c({hasCache:y,isFunctionCalling:v.includes(e==null?void 0:e.name),info:C.model_list.find(_=>_.model_id===(e==null?void 0:e.name))})})},[e==null?void 0:e.name,r]);const u=i.useCallback(async()=>{await(s==null?void 0:s())},[s]),a=i.useMemo(()=>{switch(n){case S.Downloading:return t.jsx(De,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case S.Loaded:return t.jsx(le,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"});default:return t.jsx(le,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"})}},[e==null?void 0:e.name,n]);return t.jsxs(Pe,{className:"flex justify-center max-w-xl",children:[a,t.jsxs("div",{className:"ml-2 pt-1 max-w-lg",children:[t.jsx(Ve,{className:"flex gap-2 items-center pr-6",children:`${(e==null?void 0:e.name)||""}`}),t.jsxs("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:[t.jsx(Be,{model:r==null?void 0:r.info,isFunctionCalling:(r==null?void 0:r.isFunctionCalling)||!1,name:e==null?void 0:e.name,isCached:(r==null?void 0:r.hasCache)||!1}),n!==S.Loaded?t.jsx(ie,{variant:l?"ghost":"default",disabled:n===S.Loading,onClick:u,className:"mt-4 w-full",children:l||o(r!=null&&r.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")}):void 0]})]})]})}),we=()=>{const[e]=i.useState(!1),n=Me(r=>r.similaritySearchWithScore),{stream:s}=Je(),l=i.useCallback(async(r,c)=>{const{placeholders:u}=c||{};if(!(u!=null&&u.length))return[];const a=[];return await Promise.all(u.map(async h=>{var C,y,_,w,d,x;const v=(C=h.node.data)==null?void 0:C.entity;if(v)switch(v.placeholder_type){case ze.VECTOR_DATABASE_RETREIVER:{const m=(y=h.connectedNodes)==null?void 0:y.find(g=>g.type===ne.VectorDatabase),f=(_=m==null?void 0:m.data)==null?void 0:_.entity;return(x=(d=(w=h.connectedNodes)==null?void 0:w.find(g=>g.type===ne.Prompt))==null?void 0:d.data)!=null&&x.entity,void 0}}})),a},[n]),o=i.useCallback(async(r,c,u,{onMessageUpdate:a})=>{const{prompts:h,tools:v,schemas:C,placeholders:y}=c||{},_=[];y!=null&&y.length&&_.push(...await l(r,c));const{history:w,systems:d}=qe(u,h||[]),x=[...d,..._,...w,new Re(r)],{content:m}=await s(x,{tools:v,schemas:C,onMessageUpdate:({content:f})=>{a==null||a({nodeData:{loading:!0,content:f}})}});return a==null||a({nodeData:{content:m}}),m},[l,s]);return{loading:e,sendMessage:o}},xe=i.lazy(()=>te(()=>import("./index-DN5Sxtf9.js").then(async e=>(await e.__tla,e)),__vite__mapDeps([5,6,2,3,7,8]))),ve=[{icon:He,label:"Copy"},{icon:Ge,label:"Refresh"},{icon:$e,label:"Volume"}],Ne=i.memo(()=>{const[e,n]=i.useState(!1),{mainLLMInfo:s,loadLLM:l,updateMessagesData:o,onThreadMessagesLoaded:r}=_e(),{sendMessage:c}=we(),{input:u,messages:a,handleSubmit:h,handleInputChange:v,isLoading:C,reload:y,setMessages:_}=Te({fetch:async(m,f)=>{const g=JSON.parse(f==null?void 0:f.body),k=re(),L=g.messages[g.messages.length-1];return _(N=>[...N,{id:re(),content:L.content,role:"user"},{id:k,content:"Thinking...",role:"assistant"}]),await c(L.content,void 0,[],{onMessageUpdate(N){console.log("info.nodeData.content",N.nodeData.content),_(E=>{const D=[...E],M=D.findIndex(F=>F.id===k);return M!==-1&&(D[M]={...D[M],content:N.nodeData.content||""}),D})}}),_(N=>(o(N),N)),new Response},onResponse(m){m&&(console.log(m),n(!1))},onError(m){m&&n(!1)}}),w=i.useRef(null);i.useEffect(()=>{const m=r(f=>{_(f||[]),w.current&&(w.current.scrollTop=w.current.scrollHeight)});return()=>{m()}},[_,r]);const d=async(m,f)=>(n(!0),h(f),!0),x=async(m,f)=>{if(m==="Refresh"){n(!0);try{await y()}catch(g){console.error("Error reloading:",g)}finally{n(!1)}}if(m==="Copy"){const g=a[f];g&&g.role==="assistant"&&navigator.clipboard.writeText(g.content)}};return t.jsxs("main",{className:"flex h-full w-full max-w-2xl flex-col items-center mx-auto py-6 max-h-full",children:[t.jsxs(X,{ref:w,children:[t.jsx("div",{className:"flex justify-center items-center",children:t.jsx(ye,{llm:s==null?void 0:s.llm,status:s==null?void 0:s.status,progress:s==null?void 0:s.progress,loadLLM:l})}),a&&a.map((m,f)=>t.jsxs($,{variant:m.role=="user"?"sent":"received",children:[t.jsx(fe,{src:"",fallback:m.role=="user"?"\u{1F468}\u{1F3FD}":"\u{1F916}"}),t.jsxs(Q,{children:[t.jsx(i.Suspense,{fallback:t.jsx(K,{}),children:t.jsx(xe,{className:"!text-sm [&_p]:leading-relaxed !max-w-full !bg-transparent !text-inherit !font-sans",source:m.content||""})}),m.role==="assistant"&&a.length-1===f&&t.jsx("div",{className:"flex items-center mt-1.5 gap-1",children:!e&&t.jsx(t.Fragment,{children:ve.map((g,k)=>{const L=g.icon;return t.jsx(he,{variant:"ghost",className:"size-5",icon:t.jsx(L,{className:"size-3"}),onClick:()=>x(g.label,f)},k)})})})]})]},f))]}),t.jsx(Ue,{className:"!max-w-2xl px-4",onSubmit:d,disabled:C||(s==null?void 0:s.status)!==S.Loaded,placeholder:"Type your message here...",maxHeight:72,value:u,onChange:v})]})}),je=Ne;oe=function(){const e=se(n=>n.currentSession);if(!e)return t.jsx(ke,{flickeringGrid:!0,className:"w-full h-full"});if(e.main_source_type==="Thread")return t.jsx(je,{})}});export{Ze as __tla,oe as default};
