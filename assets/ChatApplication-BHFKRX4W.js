const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CpUNJZhr.js","assets/LLMIcon-tZAM1-Q5.js","assets/index-CMO0DEG8.js","assets/index-Vcso_2OS.css","assets/routes-PTuNXW4r.js","assets/dot-DgXqs9Cs.js","assets/createLucideIcon-D9I8Id43.js","assets/pdf.min-CuXHMbRf.js","assets/pdf.worker.min-C3F6LUbf.js"])))=>i.map(i=>d[i]);
import{r,j as a,c as J,v as Ee,e as z,w as X,f as Me,_ as ne,L as H,a as sa,P as re,x as na,y as ke,l as Ie,z as ra,__tla as ia}from"./index-CMO0DEG8.js";import{e as Re,g as S,F as oa,A as Oe,S as la,H as ca,B as ie,V as Y,r as da,s as ma,t as ua,v as ha,w as pa,x as fa,y as wa,z as _a,L as ga,E as ya,G as va,J as xa,K as ba,M as Na,N as ja,Q as Ca,U as K,__tla as La}from"./routes-PTuNXW4r.js";import{u as Da,__tla as Sa}from"./index-NG96fDX5.js";import{A as Ea,__tla as Ma}from"./popover-D5bX1ZI1.js";import{f as oe,F as ka,e as le,P as Ia,C as Fe,L as Ra,a as Oa,W as Fa,T as Z,D as Ta,I as Pa,b as Aa,V as Va,d as Ba,g as Ja,h as ee,M as Te,i as qa,j as Wa,k as $a,__tla as za}from"./chunk-C-PGUsed.js";import{a as Ha,I as ce,p as Ua,b as q,S as Ga,u as Pe,l as Ka,c as Ae,__tla as Qa}from"./LLMIcon-tZAM1-Q5.js";import{u as Xa,__tla as Ya}from"./use-load-model-D8cgNFQT.js";import{A as Za,a as et,b as at,c as tt,d as st,e as nt,f as rt,g as it,__tla as ot}from"./alert-dialog-DsDftYsJ.js";import"./toNumber-DbuxrpaZ.js";import{__tla as lt}from"./index-Ddm2im3W.js";import"./dot-DgXqs9Cs.js";import"./createLucideIcon-D9I8Id43.js";import{__tla as ct}from"./index-B94_Zgu3.js";let Ve,dt=Promise.all([(()=>{try{return ia}catch{}})(),(()=>{try{return La}catch{}})(),(()=>{try{return Sa}catch{}})(),(()=>{try{return Ma}catch{}})(),(()=>{try{return za}catch{}})(),(()=>{try{return Qa}catch{}})(),(()=>{try{return Ya}catch{}})(),(()=>{try{return ot}catch{}})(),(()=>{try{return lt}catch{}})(),(()=>{try{return ct}catch{}})()]).then(async()=>{const de=r.forwardRef(({className:e,children:t,...i},n)=>a.jsx("div",{className:J("flex flex-col w-full h-full p-4 gap-6 overflow-y-auto",e),ref:n,...i,children:t}));de.displayName="ChatMessageList";const Be=()=>{var $,B;const[e,t]=r.useState(),[i,n]=r.useState(),[o,c]=r.useState(),[l,h]=r.useState(),[p,d]=r.useState([]),[u,y]=r.useState(),_=r.useRef(),v=r.useRef({}),s=Re(m=>m.currentSession),{loadModel:N}=Xa(),{modalRef:R}=Ha(Ga),E=r.useCallback(async m=>{var w;if(!s)return;const f=await S("JSONData").findOne({where:{id:m.source_id,session_id:s==null?void 0:s.id}});f&&((w=_.current)==null||w.call(_,f.data?f.data:[]),y({node:m,enity:f}))},[s]),j=r.useCallback(async m=>{var T;const f=(m==null?void 0:m.sessionId)||(s==null?void 0:s.id),w=(m==null?void 0:m.threadNode)||(o==null?void 0:o.threadNode),M=(m==null?void 0:m.prompts)||(e==null?void 0:e.prompts);if(!f||!(w!=null&&w.id))return;const F=M==null?void 0:M.map(k=>{if(k.type!=="few_shot_example")switch(k.role){case"ai":case"assistant":case"tool":return{id:k.id,content:k.content,role:"assistant"};case"system":return{id:k.id,content:k.content,role:"system"};default:return{id:k.id,content:k.content,role:"user"}}}).filter(Boolean),L=await S("JSONData").save({headers:"item",session_id:f,json:"",data:F});if(!L)return;const g=await S("FlowNode").save({session_id:f,source_id:L.id,source_type:"JSONData",node_type:"JSON_DATA",x:0,y:0});if(g)return await S("FlowEdge").save({session_id:f,source:w.id,target:g.id}),(T=_.current)==null||T.call(_,F),y({node:g,enity:L}),{jsonData:L,jsonDataNode:g}},[e==null?void 0:e.prompts,s==null?void 0:s.id,o==null?void 0:o.threadNode]),D=r.useCallback(async(m,f)=>{if(!s)return;const w=await S("FlowEdge").findOne({where:{session_id:s.id,source:m.id},order:{id:"DESC"}});if(w){const M=await S("FlowNode").findOne({where:{id:w.target,session_id:s.id}});if(!M)return;await E(M)}else if(!await j({sessionId:s.id,threadNode:m,prompts:f||[]}))return},[j,s,E]),x=r.useCallback(async m=>{if(m!=null&&m.length&&(s!=null&&s.id)){const f=(await Promise.all(m.map(async w=>S("FlowEdge").find({where:{target:w.source.id}}).then(M=>oe({where:{session_id:s.id,id:ce(M.map(F=>F.source))}}).then(F=>({...F,...w})))))).map(w=>{var T,k,W,P;const M=w.flowNodes.find(A=>A.source_type==="Prompt"),F=w.flowNodes.find(A=>A.source_type==="VectorDatabase");if(!F||!M)return;const L=(k=(T=w.flowNodeDatas)==null?void 0:T.Prompt)==null?void 0:k.find(A=>A.id===M.source_id),g=(P=(W=w.flowNodeDatas)==null?void 0:W.VectorDatabase)==null?void 0:P.find(A=>A.id===F.source_id);return{promptNode:M,vectorDatabaseNode:F,placeholderNode:w.source,placeholderEntity:w.entity,promptEntity:L,vectorDatabaseEntity:g}}).filter(Boolean);d(f)}},[s==null?void 0:s.id]),I=r.useCallback(async()=>{try{if(v.current.handling=s==null?void 0:s.id,!(s!=null&&s.id)||!(s!=null&&s.main_source_id)||(s==null?void 0:s.main_source_type)!=="Thread")return;const[m,f]=await Promise.all([S("Thread").findOne({where:{id:s.main_source_id,session_id:s.id}}),S("FlowNode").findOne({where:{id:s.main_node_id}})]);if(!m||!f)return;const w=await S("FlowEdge").find({where:{session_id:s.id,target:f.id}}),{flowNodes:M,flowNodeDatas:F}=await oe({where:{session_id:s.id,id:ce(w.map(b=>b.source))}}),L=(await S("FlowEdge").find({where:{session_id:s.id}})).filter(b=>b.target===f.id).map(b=>{var Se;const G=M.find(se=>se.id===b.source);return{connection:b,source:G,entity:(Se=F==null?void 0:F[G.source_type])==null?void 0:Se.find(se=>se.id===G.source_id)}}),g=L.find(b=>b.source.source_type==="LLM"),T=L.filter(b=>b.source.source_type==="Prompt"),k=L.find(b=>b.source.source_type==="Schema"),W=g==null?void 0:g.entity;if(!W)return;s.passphrase&&await Ua(s.passphrase,R.current);const P=L.filter(b=>b.source.source_type==="FlowNodePlaceholder");await x(P),await D(f,(T==null?void 0:T.map(b=>b.entity))||[]);const A=await S("FlowNode").findOne({where:{node_type:oa.DefaultEmbeddingModel,source_type:"FlowNodePlaceholder"}});if(A){const b=await S("FlowNodePlaceholder").findOne({where:{id:A.source_id}});n({embedding:b})}h({llm:W,status:W.status||q.Started,progress:""}),c({thread:m,threadNode:f});const V=k==null?void 0:k.entity;if(V){const b=await S("SchemaItem").find({where:{schema_id:V.id}});V.schema_items=b||[]}t({prompts:(T==null?void 0:T.map(b=>b.entity))||[],schema:V}),v.current.handled=s.id}finally{v.current.handling=void 0}},[s==null?void 0:s.id,s==null?void 0:s.main_node_id,s==null?void 0:s.main_source_id,s==null?void 0:s.main_source_type,s==null?void 0:s.passphrase,x,D,R]),C=r.useCallback(async()=>{var m;if((m=l==null?void 0:l.llm)!=null&&m.name)try{h(f=>f&&{...f,status:q.Loading}),await N(l.llm.provider,l==null?void 0:l.llm.name,{provider:l.llm.provider,callback:f=>{h(w=>w&&{...w,progress:f.text})}}),h(f=>f&&{...f,status:q.Loaded,progress:""})}catch{h(f=>f&&{...f,status:q.Started,progress:""})}},[($=l==null?void 0:l.llm)==null?void 0:$.name,(B=l==null?void 0:l.llm)==null?void 0:B.provider,N]),O=r.useCallback(m=>(_.current=m,()=>{_.current=void 0}),[]),U=r.useCallback(async m=>{!(u!=null&&u.node)||!(u!=null&&u.enity)||await S("JSONData").save({...u.enity,data:m})},[u==null?void 0:u.enity,u==null?void 0:u.node]);return r.useEffect(()=>{v.current.handling||(v==null?void 0:v.current.handled)===(s==null?void 0:s.id)||I()},[s==null?void 0:s.id,I]),{...e,loadLLM:C,threadInfo:o,mainLLMInfo:l,mainEmbeddingInfo:i,retriverInfo:p,currentDataNode:u,updateMessagesData:U,addNewDataNode:j,selectDataNode:E,setLLMInfo:h,onThreadMessagesLoaded:O}},Je=e=>{const t={},i=[];return e.schema_items&&e.schema_items.length>0&&e.schema_items.forEach(n=>{if(n.name){const o=ae(n);t[n.name]=o,n.required&&i.push(n.name)}}),{name:e.name,schema:{type:"object",properties:t,...i.length>0&&{required:i},additionalProperties:!1}}},ae=e=>{const t={type:e.type.toLowerCase()};if(e.description&&(t.description=e.description),e.enum)try{t.enum=JSON.parse(e.enum)}catch{t.enum=e.enum.split(",").map(i=>i.trim())}if(e.type==="object"&&e.schemas&&e.schemas.length>0){t.properties={};const i=[];e.schemas.forEach(n=>{n.name&&t.properties&&(t.properties[n.name]=ae(n),n.required&&i.push(n.name))}),i.length>0&&(t.required=i)}return e.type==="array"&&e.schemas&&e.schemas.length>0&&(t.items=ae(e.schemas[0])),t},qe=e=>{var c;const[t]=r.useState(!1),{confirmPassphrase:i}=Pe(),n=r.useCallback(async(l,h)=>{if(!(h!=null&&h.length))return[];const p=[];return await Promise.all(h.map(async d=>{var y,_,v,s,N;const u=d.placeholderEntity;if(u)switch(u.placeholder_type){case ka.VECTOR_DATABASE_RETREIVER:{if(!d.promptNode||!d.promptEntity||!d.vectorDatabaseNode||!d.vectorDatabaseEntity)return;const R=(y=u.metadata)!=null&&y.k?+((_=u.metadata)==null?void 0:_.k):1;let E=(v=u.metadata)!=null&&v.minimalScore?+((s=u.metadata)==null?void 0:s.minimalScore):void 0;E&&E>1&&(E=E/100),await i();const j=await le.similaritySearchWithScore((N=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:N.embedding,{database:{databaseId:d.vectorDatabaseEntity.id}},l,R);if(!j)return[];const D=new Ia({template:d.promptEntity.content,inputVariables:["context"]});p.push(new Oe(await D.format({context:E?j.filter(([,x])=>x>=E).map(([x])=>x.pageContent).join(`
`):j.map(([x])=>x.pageContent).join(`
`)})))}}})),p},[(c=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:c.embedding,i]),o=r.useCallback(async(l,h,{retriverInfo:p},{schema:d,onMessageUpdate:u,onResponseMessageCreate:y,onInjectedMessages:_})=>{var R,E;if(!((R=e.mainLLMInfo)!=null&&R.llm)||((E=e.mainLLMInfo)==null?void 0:E.status)!==q.Loaded)throw new Error("LLM not found");const v=[];p!=null&&p.length&&(v.push(...await n(l,p)),_==null||_(v));const s=h.map(j=>j.role==="system"?new la(j.content):j.role==="user"?new ca(j.content):new Oe(j.content));y==null||y(),await i();const N=await Ka.stream(e.mainLLMInfo.llm.provider,[...v,...s],{schemas:d?[Je(d)]:void 0,llm:e.mainLLMInfo.llm,onMessageUpdate:({content:j})=>{u==null||u({nodeData:{loading:!0,content:j}})}});return u==null||u({nodeData:{content:typeof N=="string"?N:N==null?void 0:N.content}}),typeof N=="string"?N:N==null?void 0:N.content},[n,i,e.mainLLMInfo]);return{loading:t,sendMessage:o}},We=Ee(({onDelete:e})=>{const{t}=z("dialogs"),[i,n]=r.useState(!1),o=X(),{toast:c}=Me(),l=async()=>{try{n(!0),await e(),o.hide()}catch{c({variant:"destructive",description:t("delete_chat_data_node.errors.delete_failed")})}finally{n(!1)}};return a.jsx(Za,{open:o.visible,onOpenChange:o.hide,children:a.jsxs(et,{children:[a.jsxs(at,{children:[a.jsx(tt,{children:t("delete_chat_data_node.title")}),a.jsx(st,{children:t("delete_chat_data_node.description")})]}),a.jsxs(nt,{children:[a.jsx(rt,{onClick:o.hide,children:t("delete_chat_data_node.cancel")}),a.jsx(it,{disabled:i,onClick:l,children:t("delete_chat_data_node.delete")})]})]})})});function Q(){return a.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",className:"text-foreground",children:[a.jsx("circle",{cx:"4",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_qFRN",begin:"0;spinner_OcgL.end+0.25s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{begin:"spinner_qFRN.begin+0.1s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"20",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_OcgL",begin:"spinner_qFRN.begin+0.2s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})})]})}const $e=r.memo(({llm:e,status:t,loadLLM:i,progress:n})=>{const{t:o}=z("flows"),[c,l]=r.useState();r.useEffect(()=>{if(!(c||!(e!=null&&e.name))){if((e==null?void 0:e.provider)!=="WebLLM"){l({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:e==null?void 0:e.name,model:e==null?void 0:e.name,model_lib:e==null?void 0:e.provider,model_type:2}});return}ne(()=>import("./index-CpUNJZhr.js").then(async d=>(await d.__tla,d)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:d,functionCallingModelIds:u,prebuiltAppConfig:y})=>{const _=await d(e==null?void 0:e.name);l({hasCache:_,isFunctionCalling:u.includes(e==null?void 0:e.name),info:y.model_list.find(v=>v.model_id===(e==null?void 0:e.name))})})}},[e==null?void 0:e.name,c]);const h=r.useCallback(async()=>{await(i==null?void 0:i())},[i]),p=r.useMemo(()=>{switch(t){case q.Downloading:return a.jsx(H,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case q.Loaded:return a.jsx(Ae,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"});default:return a.jsx(Ae,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"})}},[e==null?void 0:e.name,t]);return a.jsx(Fe,{className:"flex justify-center !bg-inherit !p-2 max-w-full overflow-y-hidden !mb-2 m-2 !mt-0",children:a.jsxs("div",{className:"ml-2 pt-1 max-w-full",children:[a.jsxs("p",{className:"flex gap-2 items-center pr-6 !text-sm font-semibold",children:[p,`${(e==null?void 0:e.name)||""}`]}),a.jsxs("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:[a.jsx(Ra,{model:c==null?void 0:c.info,isFunctionCalling:(c==null?void 0:c.isFunctionCalling)||!1,name:e==null?void 0:e.name,isCached:(c==null?void 0:c.hasCache)||!1,cloud:(c==null?void 0:c.cloud)||!1}),t!==q.Loaded?n?a.jsx("div",{className:"text-sm break-words flex-wrap",children:n}):a.jsx(ie,{disabled:t===q.Loading,onClick:h,className:"mt-4 w-full",children:o(c!=null&&c.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")}):void 0]})]})})}),ze=e=>{const[t,i]=r.useState(!1),{t:n}=z("flows"),{toast:o}=Me(),{confirmPassphrase:c}=Pe(),l=r.useCallback(async(p,d)=>{try{if(!(d!=null&&d.vectorDatabase)){o({variant:"destructive",title:n("vector_database_node.errors.vector_database_not_found")});return}if((d==null?void 0:d.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for similarity search");return i(!0),await c(),await le.similaritySearchWithScore(e==null?void 0:e.embedding,{database:{databaseId:d.vectorDatabase.id}},p,d==null?void 0:d.k)}catch{o({variant:"destructive",title:n("vector_database_node.errors.similarity_search_failed")})}finally{i(!1)}},[o,n,e==null?void 0:e.embedding,c]),h=r.useCallback(async(p,d)=>{var u;try{i(!0);const y=p.content?[new da({pageContent:p.content,id:p.id,metadata:{id:p.id}})]:p.documents;if(!(y!=null&&y.length)){o({variant:"destructive",title:n("vector_database_node.errors.content_not_found")});return}if(!(d!=null&&d.vectorDatabase)){o({variant:"destructive",title:n("vector_database_node.errors.vector_database_not_found")});return}if((d==null?void 0:d.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for indexing");{const _=Oa(y,10);let v=0;for(const s of _)(u=d==null?void 0:d.onProgressReport)==null||u.call(d,{handling:s.length,handled:v,total:y.length}),await c(),await le.index(e==null?void 0:e.embedding,{database:{databaseId:d.vectorDatabase.id}},s),v+=s.length}}catch{o({variant:"destructive",title:n("vector_database_node.errors.similarity_search_failed")})}finally{i(!1)}},[o,n,e==null?void 0:e.embedding,c]);return{loading:t,indexData:h,similaritySearchWithScore:l}},He=Ee(({retriverInfo:e,mainEmbeddingInfo:t})=>{var R,E,j;const{t:i}=z("applications"),{loading:n,similaritySearchWithScore:o,indexData:c}=ze(t),[l,h]=r.useState("search"),[p,d]=r.useState(0),u=X(),y=r.useMemo(()=>{var I,C;if(!((I=e==null?void 0:e.vectorDatabaseEntity)!=null&&I.raw))return{headers:[],rows:[]};const D=["content","embedding","metadata"],x=ma((C=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:C.raw);return{headers:D,rows:x.map(O=>{try{return JSON.parse(O)}catch{return[]}})}},[(R=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:R.raw]),_=r.useCallback(async(...D)=>{const[x,I]=D;await c(x,{...I,vectorDatabase:e.vectorDatabaseEntity})},[c,e.vectorDatabaseEntity]),v=r.useCallback(async(D,x)=>{const I=D.trim(),C=await o(I,{k:x,vectorDatabase:e.vectorDatabaseEntity});if(C!=null&&C.length)return C},[e.vectorDatabaseEntity,o]),s=r.useCallback(async D=>{if(D.type.includes("text")||D.type.includes("txt")){const x=new FileReader;x.onload=async I=>{var O;const C=(O=I.target)==null?void 0:O.result;await _({content:C},{vectorDatabase:e.vectorDatabaseEntity})},x.readAsText(D)}else if(D.type.endsWith("pdf")){const x=new Blob([D],{type:"application/pdf"}),I=await new Fa(x,{pdfjs:async()=>{const C=await ne(()=>import("./pdf.min-CuXHMbRf.js").then(async O=>(await O.__tla,O)),__vite__mapDeps([7,2,3,1,4,5,6]));return await ne(()=>import("./pdf.worker.min-C3F6LUbf.js").then(async O=>(await O.__tla,O)),__vite__mapDeps([8,1,2,3,4,5,6])),C.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),C},parsedItemSeparator:" "}).load();await _({documents:I},{vectorDatabase:e.vectorDatabaseEntity,onProgressReport:C=>{d((C.handled+C.handling)/C.total)}})}},[_,e.vectorDatabaseEntity]),N=r.useMemo(()=>{switch(l){case"search":return a.jsx(Z,{value:"search",children:a.jsx(Va,{loading:n,onSimilaritySearch:v})});case"new":return a.jsx(Z,{className:"min-w-80",value:"new",children:a.jsx(Aa,{loading:n,onCreateData:_})});case"file":return a.jsx(Z,{value:"file",children:a.jsx(Pa,{loading:n,progress:p,onFileSubmit:s,fileOptions:{accept:".pdf,.txt,.text",maxSize:1}})});case"view":return a.jsx(Z,{value:"view",className:"max-h-full overflow-auto",children:a.jsx(Ta,{data:y.rows,headers:y.headers,limitLengthByColumns:{embedding:32}})})}},[_,s,v,n,l,p,y]);return a.jsx(ua,{open:u.visible,onOpenChange:u.hide,children:a.jsxs(ha,{className:"max-w-3xl",children:[a.jsx(pa,{children:a.jsxs("div",{className:"flex",children:[a.jsx(H,{name:"file",className:"mr-2 h-4 w-4"}),a.jsx(fa,{children:i("chat.vector_database")})]})}),a.jsx("div",{className:"mx-auto w-full min-h-96 max-h-full overflow-hidden",children:a.jsx("div",{className:"w-full h-full",children:a.jsxs(Ba,{value:l,onValueChange:h,defaultValue:"search",className:J("w-full h-full mt-4"),children:[a.jsxs(Ja,{className:J("grid w-full grid-cols-3",((E=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:E.storage)===Y.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[a.jsx(ee,{value:"search",children:i("chat.search")}),a.jsx(ee,{value:"new",children:i("chat.text")}),a.jsx(ee,{value:"file",children:i("chat.file")}),((j=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:j.storage)===Y.DatabaseNode?a.jsx(ee,{value:"view",children:i("chat.view")}):void 0]}),N]})})})]})})}),Ue=e=>{const[t,i]=r.useState([]),n=Re(l=>l.currentSession),o=r.useCallback(async()=>{if(!e||!(n!=null&&n.id))return;const l=await S("FlowEdge").find({where:{session_id:n.id,source:e.id},order:{id:"DESC"}}),{flowNodes:h,flowNodeDatas:p}=await oe({where:{session_id:n.id,id:ce(l.map(d=>d.target)),source_type:"JSONData"},order:{updated_at:"DESC"},select:["id","source_id","source_type","updated_at"]});i(h.reduce((d,u)=>{var _;const y=(_=p[u.source_type])==null?void 0:_.find(v=>v.id===u.source_id);return y&&d.push({node:u,entity:y}),d},[]))},[n==null?void 0:n.id,e]),c=r.useCallback(async l=>{await S("FlowNode").delete(l.id),await S("JSONData").delete(l.source_id);const h=await S("FlowEdge").find({where:[{source:l.id},{target:l.id}]});await Promise.all(h.map(p=>S("FlowEdge").delete(p.id))),o()},[o]);return r.useEffect(()=>{e&&o()},[o,e]),{chatList:t,deleteChat:c,getChatList:o}};function Ge({schema:e,mainLLMInfo:t,mainEmbeddingInfo:i,loadLLM:n,retriverInfo:o,threadNode:c,onSelectThread:l,onAddNewThread:h,currentDataNode:p,setLLMInfo:d,changeLLMOptions:u,...y}){var $,B;const{t:_}=z("applications"),[v,s]=r.useState(!1),N=X(We),R=X(He),{chatList:E,getChatList:j,deleteChat:D}=Ue(c),x=r.useCallback(async()=>{try{s(!0),await(h==null?void 0:h()),j()}finally{s(!1)}},[j,h]),I=r.useCallback(()=>{R.show({retriverInfo:o[0],mainEmbeddingInfo:i})},[i,o,R]),C=r.useCallback(async(m,f)=>{m.stopPropagation(),N.show({onDelete:()=>D(f)})},[D,N]),O=r.useCallback(async m=>{t!=null&&t.llm&&(await u(t==null?void 0:t.llm,m),d(f=>f?{...f,llm:{...f.llm,options:m}}:void 0))},[u,t==null?void 0:t.llm,d]),U=r.useMemo(()=>{var m;return a.jsx(Te,{className:J("overflow-hidden break-words whitespace-pre-wrap w-full rounded-lg"),source:(m=e==null?void 0:e.schema_items)!=null&&m.length?`\`\`\`javascript
${qa((e==null?void 0:e.schema_items)||[])}
\`\`\``:""})},[e==null?void 0:e.schema_items]);return a.jsxs(wa,{variant:"sidebar",side:"right",collapsible:"none",...y,children:[a.jsx("div",{className:"h-1"}),a.jsxs(_a,{className:"justify-between",children:[a.jsx("div",{className:"text-sm pl-2",children:_("chat.history")}),a.jsx(ga,{loading:v,onClick:x,variant:"link",className:"mr-[-6px]",children:a.jsx(H,{name:"circle-plus"})})]}),a.jsxs(ya,{children:[a.jsx(va,{className:"flex-1",children:a.jsx(xa,{children:E.map(({node:m},f)=>{var w;return a.jsx(ba,{onClick:()=>l(m),children:a.jsx(Na,{className:"cursor-pointer",children:a.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx(H,{size:16,name:((w=p==null?void 0:p.node)==null?void 0:w.id)===m.id?"check":"chevron-right",className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"}),a.jsx("span",{children:`Thread ${f+1}`})]}),a.jsx(H,{onClick:M=>C(M,m),size:16,name:"trash-2"})]})})},m.id)})})}),o!=null&&o.length?a.jsxs(Fe,{className:"m-2 p-2 max-w-full",children:[a.jsx("pre",{className:"overflow-auto",children:o.map((m,f)=>{var w;return a.jsx("span",{children:((w=m.promptEntity)==null?void 0:w.content)||""},`${f}`)})}),a.jsx(ie,{onClick:I,className:"w-full mt-4",children:_("chat.vector_database")})]}):void 0,($=e==null?void 0:e.schema_items)!=null&&$.length?a.jsx("div",{className:"m-2 !mb-0",children:a.jsx(r.Suspense,{fallback:a.jsx(Q,{}),children:U})}):void 0,a.jsx(Wa,{options:(B=t==null?void 0:t.llm)==null?void 0:B.options,onChangeOptions:O,className:"p-2"}),a.jsx($e,{llm:t==null?void 0:t.llm,status:t==null?void 0:t.status,progress:t==null?void 0:t.progress,loadLLM:n})]})]})}var te="Avatar",[Ke,mt]=sa(te),[Qe,me]=Ke(te),ue=r.forwardRef((e,t)=>{const{__scopeAvatar:i,...n}=e,[o,c]=r.useState("idle");return a.jsx(Qe,{scope:i,imageLoadingStatus:o,onImageLoadingStatusChange:c,children:a.jsx(re.span,{...n,ref:t})})});ue.displayName=te;var he="AvatarImage",pe=r.forwardRef((e,t)=>{const{__scopeAvatar:i,src:n,onLoadingStatusChange:o=()=>{},...c}=e,l=me(he,i),h=Xe(n,c.referrerPolicy),p=na(d=>{o(d),l.onImageLoadingStatusChange(d)});return ke(()=>{h!=="idle"&&p(h)},[h,p]),h==="loaded"?a.jsx(re.img,{...c,ref:t,src:n}):null});pe.displayName=he;var fe="AvatarFallback",we=r.forwardRef((e,t)=>{const{__scopeAvatar:i,delayMs:n,...o}=e,c=me(fe,i),[l,h]=r.useState(n===void 0);return r.useEffect(()=>{if(n!==void 0){const p=window.setTimeout(()=>h(!0),n);return()=>window.clearTimeout(p)}},[n]),l&&c.imageLoadingStatus!=="loaded"?a.jsx(re.span,{...o,ref:t}):null});we.displayName=fe;function Xe(e,t){const[i,n]=r.useState("idle");return ke(()=>{if(!e){n("error");return}let o=!0;const c=new window.Image,l=h=>()=>{o&&n(h)};return n("loading"),c.onload=l("loaded"),c.onerror=l("error"),c.src=e,t&&(c.referrerPolicy=t),()=>{o=!1}},[e,t]),i}var _e=ue,ge=pe,ye=we;const ve=r.forwardRef(({className:e,...t},i)=>a.jsx(_e,{ref:i,className:J("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...t}));ve.displayName=_e.displayName;const xe=r.forwardRef(({className:e,...t},i)=>a.jsx(ge,{ref:i,className:J("aspect-square h-full w-full",e),...t}));xe.displayName=ge.displayName;const be=r.forwardRef(({className:e,...t},i)=>a.jsx(ye,{ref:i,className:J("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...t}));be.displayName=ye.displayName;const Ye=Ie("flex gap-2 max-w-[60%] items-end relative group",{variants:{variant:{received:"self-start",sent:"self-end flex-row-reverse"},layout:{default:"",ai:"max-w-full w-full items-center"}},defaultVariants:{variant:"received",layout:"default"}}),Ne=r.forwardRef(({className:e,variant:t,layout:i,children:n,...o},c)=>a.jsx("div",{className:J(Ye({variant:t,layout:i,className:e}),"relative group"),ref:c,...o,children:r.Children.map(n,l=>r.isValidElement(l)&&typeof l.type!="string"?r.cloneElement(l,{variant:t,layout:i,className:o==null?void 0:o.innerclassname}):l)}));Ne.displayName="ChatBubble";const Ze=({src:e,fallback:t,className:i})=>a.jsxs(ve,{className:i,children:[a.jsx(xe,{src:e,alt:"Avatar"}),a.jsx(be,{children:t})]}),ea=Ie("p-4",{variants:{variant:{received:"bg-secondary text-secondary-foreground rounded-r-lg rounded-tl-lg",sent:"border border-border rounded-l-lg rounded-tr-lg"},layout:{default:"",ai:"border-t w-full rounded-none bg-transparent"}},defaultVariants:{variant:"received",layout:"default"}}),je=r.forwardRef(({className:e,variant:t,layout:i,isLoading:n=!1,children:o,...c},l)=>a.jsx("div",{className:J(ea({variant:t,layout:i,className:e}),"break-words max-w-full whitespace-pre-wrap"),ref:l,...c,children:n?a.jsx("div",{className:"flex items-center space-x-2",children:a.jsx(Q,{})}):o}));je.displayName="ChatBubbleMessage";const aa=({icon:e,onClick:t,className:i,variant:n="ghost",size:o="icon",...c})=>a.jsx(ie,{variant:n,size:o,className:i,onClick:t,...c,children:e}),ta=r.forwardRef(({variant:e,className:t,children:i,...n},o)=>a.jsx("div",{ref:o,className:J("absolute top-1/2 -translate-y-1/2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200",e==="sent"?"-left-1 -translate-x-full flex-row-reverse":"-right-1 translate-x-full",t),...n,children:i}));ta.displayName="ChatBubbleActionWrapper";let Ce,Le,De;Ce=[{icon:"copy",label:"Copy"},{icon:"refresh-ccw",label:"Refresh"},{icon:"volume-2",label:"Volume"}],Le=r.memo(({message:e,index:t,isLastMessage:i,isGenerating:n,isSchema:o,onActionClick:c})=>{const l=r.useMemo(()=>a.jsx(Te,{style:{color:"unset !important"},source:e.content?o?`\`\`\`json
${e.content}
\`\`\``:e.content:""}),[o,e.content]);return a.jsxs(Ne,{innerclassname:e.role=="system"?"!bg-transparent font-semibold":void 0,variant:e.role=="user"?"sent":"received",children:[e.role==="system"?a.jsx("div",{className:"w-10 h-10"}):e.role==="assistant"?a.jsx(Ze,{src:"",fallback:e.data&&typeof e.data=="object"&&"injectedMessage"in e.data?"\u{1F4C2}":"\u{1F916}"}):void 0,a.jsxs(je,{children:[n&&i&&(!e.content||o)?a.jsx(Q,{}):a.jsxs(r.Suspense,{fallback:a.jsx(Q,{}),children:[e.role==="system"?a.jsx($a,{className:"!text-sm mb-1",children:"System"}):void 0,l]}),e.role==="assistant"&&i&&a.jsx("div",{className:"flex items-center mt-1.5 gap-1",children:!n&&a.jsx(a.Fragment,{children:Ce.map((h,p)=>a.jsx(aa,{variant:"ghost",className:"size-5",icon:a.jsx(H,{name:h.icon,className:"size-3"}),onClick:()=>c(h.label,e)},p))})})]})]},t)},()=>!1),De=()=>({changeLLMOptions:r.useCallback(async(e,t)=>{e&&await S("LLM").update(e.id,{options:t})},[])}),Ve=r.memo(()=>{const{t:e}=z("applications"),t=r.useRef(!1),[i,n]=r.useState(!1),o=r.useCallback(()=>{setTimeout(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},50)},[]),c=Be(),{schema:l,threadInfo:h,mainLLMInfo:p,retriverInfo:d,currentDataNode:u,loadLLM:y,setLLMInfo:_,addNewDataNode:v,selectDataNode:s,updateMessagesData:N,onThreadMessagesLoaded:R}=c,{changeLLMOptions:E}=De(),{sendMessage:j}=qe(c),{input:D,messages:x,isLoading:I,reload:C,setInput:O,handleSubmit:U,handleInputChange:$,setMessages:B}=Da({fetch:async(L,g)=>{try{n(!0);const T=JSON.parse(g==null?void 0:g.body),k=K(),W=T.messages[T.messages.length-1];return t.current=!0,B(P=>[...P,{id:K(),content:W.content,role:"user"}]),await j(W.content,T.messages||[],{retriverInfo:d},{schema:l,onInjectedMessages:P=>{P.length&&B(A=>[...A,...P.map(V=>V._getType()==="system"?{id:K(),content:`${V.content}`,role:"system",data:{injectedMessage:!0}}:V._getType()==="human"?{id:K(),content:`${V.content}`,role:"user",data:{injectedMessage:!0}}:{id:K(),content:`${V.content}`,role:"assistant",data:{injectedMessage:!0}})])},onResponseMessageCreate:P=>{B(A=>[...A,{id:k,content:P||"",role:"assistant"}])},onMessageUpdate:P=>{B(A=>{const V=[...A],b=V.findIndex(G=>G.id===k);return b!==-1&&(V[b]={...V[b],content:P.nodeData.content||""}),V}),t.current&&o()}}),B(P=>(N(P),P)),n(!1),O(""),t.current&&o(),new Response}finally{n(!1)}}}),m=r.useRef(null);r.useEffect(()=>{const L=R(g=>{B(g||[]),o()});return()=>{L()}},[B,R,o]);const f=async(L,g)=>(n(!0),await U(g),!0),w=r.useCallback(async(L,g)=>{if(L==="Refresh"){n(!0);try{await C()}finally{n(!1)}}L==="Copy"&&g&&g.role==="assistant"&&navigator.clipboard.writeText(g.content),L==="Volume"&&(g!=null&&g.content)&&await ra.speak((g==null?void 0:g.content)||"")},[C]),M=r.useCallback(()=>t.current=!1,[]),F=r.useMemo(()=>x&&x.map((L,g)=>a.jsx(Le,{message:L,index:g,isLastMessage:g===x.length-1,isGenerating:i,isSchema:!!l,onActionClick:w},L.id||`${g}`)),[x,i,l,w]);return a.jsxs(ja,{onClick:M,className:"max-h-full !overflow-hidden !min-h-full",style:{minHeight:"unset"},defaultOpen:!0,children:[a.jsx(Ca,{className:"!max-h-full !overflow-hidden",style:{minHeight:"unset"},children:a.jsxs("main",{className:"flex h-full w-full max-w-2xl flex-col items-center mx-auto overflow-hidden",children:[a.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden min-w-full max-w-full",children:a.jsx(de,{className:"!max-h-full",ref:m,children:F})}),a.jsx(Ea,{className:"!max-w-2xl px-4",onSubmit:f,disabled:I||i||(p==null?void 0:p.status)!==q.Loaded,placeholder:e("chat.input_message_placeholder"),value:D,onChange:$})]})}),a.jsx(Ge,{schema:l,currentDataNode:u,threadNode:h==null?void 0:h.threadNode,loadLLM:y,mainLLMInfo:p,mainEmbeddingInfo:c.mainEmbeddingInfo,retriverInfo:d,onAddNewThread:v,onSelectThread:s,changeLLMOptions:E,setLLMInfo:_})]})})});export{dt as __tla,Ve as default};
