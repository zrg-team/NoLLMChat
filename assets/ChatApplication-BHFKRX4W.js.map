{"version":3,"mappings":"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","names":["ChatMessageList","className","children","ref","cn","useChatApplicationData","chatInfo","setChatInfo","useState","mainEmbeddingInfo","setThreadInfo","mainLLMInfo","setLLMInfo","currentDataNode","setCurrentDataNode","onThreadMessagesLoadedRef","useRef","sessionHandleStatus","currentSession","useSessionState","state","useLoadModel","sessionPassphraseDialogRef","useModalRef","selectDataNode","useCallback","dataNode","jsonData","getRepository","addNewDataNode","input","sessionId","threadNode","initialMessages","prompt","jsonDataNode","threadInfo","handleThreadData","prompts","threadData","getRetrieveVectorDatabase","placeholderInfo","info","findFlowNodesWithSource","connections","connection","result","promptNode","item","node","vectorDatabaseNode","promptEntity","nodeData","vectorDatabaseEntity","setRetriverInfo","retriverInfo","thread","threadConnections","flowNodeDatas","In","threadConnectedNodes","llm","promptInfo","embeddingNode","FlowNodeTypeEnum","embeddingEntity","schemaEntity","pre","LLMStatusEnum","loadModel","data","callback","updateMessagesData","useEffect","getChatApplicationData","loadLLM","onThreadMessagesLoaded","properties","required","schema","convertSchemaItemToProperty","property","v","nestedRequired","nestedItem","useSendMessage","chatApplicationData","loading","content","injectedMessages","placeholderRecord","FlowNodePlaceholderTypeEnum","k","minimalScore","template","PromptTemplate","AIMessage","documents","score","doc","sendMessage","handlePlaceholders","message","onInjectedMessages","formatedMessages","SystemMessage","HumanMessage","onResponseMessageCreate","response","convertSchemaToOpenAI","onMessageUpdate","confirmPassphrase","create","onDelete","useTranslation","setLoading","currentModal","useToast","handleSubmit","toast","jsx","AlertDialog","AlertDialogFooter","AlertDialogCancel","AlertDialogAction","progress","t","llmInfo","__vitePreload","functionCallingModelIds","prebuiltAppConfig","hasCache","LazyIcon","LLMIcon","Card","jsxs","llmIcon","LLMInfo","status","Button","handleLoadLLM","useVectorDatabaseActions","useConfirmPassphrase","similaritySearchWithScore","options","VectorDatabaseStorageEnum","handledCount","partDocuments","chunkedDocuments","embeddingHandler","VectorDatabaseDialog","setMode","setProgress","useModal","vectorDatabaseData","useMemo","headers","decodeLine","row","args","indexData","file","reader","e","blob","pdfjs","handleCreateData","renderContent","mode","TabsContent","VectorSearch","IndexNewText","IndexNewFile","handleIndexPDF","DataViewer","Dialog","DialogContent","DialogHeader","Tabs","TabsList","TabsTrigger","chatList","setChatList","threadDataEdged","edge","flowNodes","all","entity","allEdges","getChatList","deleteChat","ChatPanel","onSelectThread","onAddNewThread","changeLLMOptions","React.useState","DeleteChatDataNodeDialog","vectorDatabaseDialog","React.useCallback","handleDeleteDataNode","deleteChatDataNodeDialog","handleChangeOptions","React.useMemo","convertToZodSchemaString","Sidebar","SidebarGroupLabel","SidebarContent","SidebarMenu","index","SidebarMenuItem","key","React.Suspense","MessageLoading","ChatLLMInfo","AVATAR_NAME","createAvatarContext","createAvatarScope","createContextScope","AvatarProvider","React.forwardRef","forwardedRef","avatarProps","imageLoadingStatus","setImageLoadingStatus","Avatar","AvatarImage","props","__scopeAvatar","src","onLoadingStatusChange","useAvatarContext","IMAGE_NAME","context","useLayoutEffect","handleLoadingStatusChange","Primitive","FALLBACK_NAME","AvatarFallback","canRender","setCanRender","delayMs","React.useEffect","timerId","fallbackProps","useImageLoadingStatus","loadingStatus","setLoadingStatus","updateStatus","image","referrerPolicy","Root","Image","Fallback","AvatarPrimitive.Root","AvatarPrimitive.Image","AvatarPrimitive.Fallback","chatBubbleVariant","ChatBubble","layout","variant","React.isValidElement","React.cloneElement","fallback","chatBubbleMessageVariants","isLoading","ChatBubbleMessage","size","onClick","ChatItem","isSchema","onActionClick","MarkdownViewer","ChatBubbleAvatar","isGenerating","isLastMessage","Suspense","Fragment","ChatAiIcons","iconIndex","ChatBubbleAction","icon","useUpdateLLMOptions","ChatApplication","memo","messagesRef","messages","setInput","setMessages","_input","init","setIsGenerating","body","nanoid","lastMessage","isScrolling","newMessages","newMessageId","scrollToBottom","cleandUp","onSubmit","_value","handleActionClick","action","reload","handleStopScroll","SidebarInset","AIInput"],"ignoreList":[10],"sources":["../../src/lib/shadcn/chat/chat-message-list.tsx","../../src/components/pages/ChatApplication/hooks/use-chat-application-data.ts","../../src/components/pages/ChatApplication/hooks/use-send-message.ts","../../src/components/dialogs/DeleteChatDataNodeDialog/index.tsx","../../src/lib/shadcn/chat/message-loading.tsx","../../src/components/pages/ChatApplication/components/ChatLLMInfo.tsx","../../src/components/pages/ChatApplication/hooks/use-vector-database-actions.ts","../../src/components/pages/ChatApplication/components/VectorDatabaseDialog/index.tsx","../../src/components/pages/ChatApplication/hooks/use-chat-list.ts","../../src/components/pages/ChatApplication/components/ChatPanel.tsx","../../node_modules/@radix-ui/react-avatar/dist/index.mjs","../../src/lib/shadcn/ui/avatar.tsx","../../src/lib/shadcn/chat/chat-bubble.tsx","../../src/components/pages/ChatApplication/components/ChatItem.tsx","../../src/components/pages/ChatApplication/hooks/use-update-llm-options.ts","../../src/components/pages/ChatApplication/ChatApplication.tsx"],"sourcesContent":["import * as React from 'react'\nimport { cn } from 'src/lib/utils'\n\ntype ChatMessageListProps = React.HTMLAttributes<HTMLDivElement>\n\nconst ChatMessageList = React.forwardRef<HTMLDivElement, ChatMessageListProps>(\n  ({ className, children, ...props }, ref) => (\n    <div\n      className={cn('flex flex-col w-full h-full p-4 gap-6 overflow-y-auto', className)}\n      ref={ref}\n      {...props}\n    >\n      {children}\n    </div>\n  ),\n)\n\nChatMessageList.displayName = 'ChatMessageList'\n\nexport { ChatMessageList }\n","import { useCallback, useEffect, useRef, useState } from 'react'\nimport { getRepository } from 'src/services/database/database'\nimport { useSessionState } from 'src/states/session'\nimport { findFlowNodesWithSource } from 'src/states/flow/actions'\nimport {\n  EntityTypes,\n  FlowEdge,\n  FlowNode,\n  FlowNodePlaceholder,\n  FlowNodeTypeEnum,\n  JSONData,\n  LLM,\n  LLMStatusEnum,\n  Prompt,\n  Schema,\n  Thread,\n  VectorDatabase,\n} from 'src/services/database/types'\nimport { In } from 'src/services/database/typeorm-wrapper'\nimport { Message } from 'ai/react'\nimport { useLoadModel } from 'src/hooks/mutations/use-load-model'\nimport SessionPassphraseDialog from 'src/components/dialogs/SessionPassphraseDialog'\nimport { passphraseConfirm } from 'src/utils/passphrase'\nimport { useModalRef } from 'src/hooks/use-modal-ref'\n\nexport const useChatApplicationData = () => {\n  const [chatInfo, setChatInfo] = useState<{\n    prompts?: Prompt[]\n    schema?: Schema\n  }>()\n  const [mainEmbeddingInfo, setMainEmbeddingInfo] = useState<{\n    embedding?: FlowNodePlaceholder\n  }>()\n  const [threadInfo, setThreadInfo] = useState<{ thread: Thread; threadNode: FlowNode }>()\n  const [mainLLMInfo, setLLMInfo] = useState<{\n    llm: LLM\n    status: `${LLMStatusEnum}`\n    progress?: string\n  }>()\n  const [retriverInfo, setRetriverInfo] = useState<\n    {\n      promptNode: FlowNode\n      vectorDatabaseNode: FlowNode\n      placeholderNode: FlowNode\n      placeholderEntity: FlowNodePlaceholder\n      promptEntity: Prompt\n      vectorDatabaseEntity: VectorDatabase\n    }[]\n  >([])\n  const [currentDataNode, setCurrentDataNode] = useState<{ node: FlowNode; enity: JSONData }>()\n  const onThreadMessagesLoadedRef = useRef<(messages: Message[]) => void>()\n  const sessionHandleStatus = useRef<{ handling?: string; handled?: string }>({})\n  const currentSession = useSessionState((state) => state.currentSession)\n  const { loadModel } = useLoadModel()\n  const { modalRef: sessionPassphraseDialogRef } = useModalRef(SessionPassphraseDialog)\n\n  const selectDataNode = useCallback(\n    async (dataNode: FlowNode) => {\n      if (!currentSession) {\n        return\n      }\n      const jsonData = await getRepository('JSONData').findOne({\n        where: { id: dataNode.source_id, session_id: currentSession?.id },\n      })\n      if (!jsonData) {\n        return\n      }\n      onThreadMessagesLoadedRef.current?.(\n        jsonData.data ? (jsonData.data as unknown as Message[]) : [],\n      )\n      setCurrentDataNode({\n        node: dataNode,\n        enity: jsonData,\n      })\n    },\n    [currentSession],\n  )\n\n  const addNewDataNode = useCallback(\n    async (input?: { sessionId?: string; threadNode?: FlowNode; prompts?: Prompt[] }) => {\n      const sessionId = input?.sessionId || currentSession?.id\n      const threadNode = input?.threadNode || threadInfo?.threadNode\n      const systemPrompt = input?.prompts || chatInfo?.prompts\n\n      if (!sessionId || !threadNode?.id) {\n        return\n      }\n      const initialMessages = systemPrompt\n        ?.map((prompt) => {\n          if (prompt.type === 'few_shot_example') {\n            return undefined\n          }\n          switch (prompt.role) {\n            case 'ai':\n            case 'assistant':\n            case 'tool':\n              return {\n                id: prompt.id,\n                content: prompt.content,\n                role: 'assistant',\n              }\n            case 'system':\n              return {\n                id: prompt.id,\n                content: prompt.content,\n                role: 'system',\n              }\n            default:\n              return {\n                id: prompt.id,\n                content: prompt.content,\n                role: 'user',\n              }\n          }\n        })\n        .filter(Boolean) as Message[]\n      const jsonData = await getRepository('JSONData').save({\n        headers: 'item',\n        session_id: sessionId,\n        json: '',\n        data: initialMessages,\n      })\n      if (!jsonData) {\n        return\n      }\n      const jsonDataNode = await getRepository('FlowNode').save({\n        session_id: sessionId,\n        source_id: jsonData.id,\n        source_type: 'JSONData',\n        node_type: 'JSON_DATA',\n        x: 0,\n        y: 0,\n      })\n      if (!jsonDataNode) {\n        return\n      }\n      await getRepository('FlowEdge').save({\n        session_id: sessionId,\n        source: threadNode.id,\n        target: jsonDataNode.id,\n      })\n      onThreadMessagesLoadedRef.current?.(initialMessages)\n      setCurrentDataNode({\n        node: jsonDataNode,\n        enity: jsonData,\n      })\n      return {\n        jsonData,\n        jsonDataNode,\n      }\n    },\n    [chatInfo?.prompts, currentSession?.id, threadInfo?.threadNode],\n  )\n\n  const handleThreadData = useCallback(\n    async (threadNode: FlowNode, prompts: Prompt[]) => {\n      if (!currentSession) {\n        return\n      }\n      const threadData = await getRepository('FlowEdge').findOne({\n        where: { session_id: currentSession.id, source: threadNode.id },\n        order: { id: 'DESC' },\n      })\n      if (!threadData) {\n        const result = await addNewDataNode({\n          sessionId: currentSession.id,\n          threadNode,\n          prompts: prompts || [],\n        })\n        if (!result) {\n          return\n        }\n      } else {\n        const dataNode = await getRepository('FlowNode').findOne({\n          where: { id: threadData.target, session_id: currentSession.id },\n        })\n        if (!dataNode) {\n          return\n        }\n        await selectDataNode(dataNode)\n      }\n    },\n    [addNewDataNode, currentSession, selectDataNode],\n  )\n\n  const getRetrieveVectorDatabase = useCallback(\n    async (\n      placeholderInfo: {\n        connection: FlowEdge\n        source: FlowNode\n        entity?: EntityTypes\n      }[],\n    ) => {\n      if (placeholderInfo?.length && currentSession?.id) {\n        const data = await Promise.all(\n          placeholderInfo.map(async (info) => {\n            return getRepository('FlowEdge')\n              .find({\n                where: {\n                  target: info.source.id,\n                },\n              })\n              .then((connections) => {\n                return findFlowNodesWithSource({\n                  where: {\n                    session_id: currentSession.id,\n                    id: In(connections.map((connection) => connection.source)),\n                  },\n                }).then((result) => ({\n                  ...result,\n                  ...info,\n                }))\n              })\n          }),\n        )\n        const retriverInfo = data\n          .map((item) => {\n            const promptNode = item.flowNodes.find((node) => node.source_type === 'Prompt')\n            const vectorDatabaseNode = item.flowNodes.find(\n              (node) => node.source_type === 'VectorDatabase',\n            )\n            if (!vectorDatabaseNode || !promptNode) {\n              return\n            }\n            const promptEntity = item.flowNodeDatas?.Prompt?.find(\n              (nodeData) => nodeData.id === promptNode.source_id,\n            )\n            const vectorDatabaseEntity = item.flowNodeDatas?.VectorDatabase?.find(\n              (nodeData) => nodeData.id === vectorDatabaseNode.source_id,\n            )\n            return {\n              promptNode,\n              vectorDatabaseNode,\n              placeholderNode: item.source,\n              placeholderEntity: item.entity,\n              promptEntity: promptEntity as Prompt,\n              vectorDatabaseEntity: vectorDatabaseEntity as VectorDatabase,\n            }\n          })\n          .filter(Boolean) as {\n          promptNode: FlowNode\n          vectorDatabaseNode: FlowNode\n          placeholderNode: FlowNode\n          placeholderEntity: FlowNodePlaceholder\n          promptEntity: Prompt\n          vectorDatabaseEntity: VectorDatabase\n        }[]\n        setRetriverInfo(retriverInfo)\n      }\n    },\n    [currentSession?.id],\n  )\n\n  const getChatApplicationData = useCallback(async () => {\n    try {\n      sessionHandleStatus.current.handling = currentSession?.id\n      if (\n        !currentSession?.id ||\n        !currentSession?.main_source_id ||\n        currentSession?.main_source_type !== 'Thread'\n      ) {\n        return\n      }\n      const [thread, threadNode] = await Promise.all([\n        getRepository('Thread').findOne({\n          where: { id: currentSession.main_source_id, session_id: currentSession.id },\n        }),\n        getRepository('FlowNode').findOne({\n          where: {\n            id: currentSession.main_node_id,\n          },\n        }),\n      ])\n      if (!thread || !threadNode) {\n        return\n      }\n      const threadConnections = await getRepository('FlowEdge').find({\n        where: { session_id: currentSession.id, target: threadNode.id },\n      })\n      const { flowNodes, flowNodeDatas } = await findFlowNodesWithSource({\n        where: {\n          session_id: currentSession.id,\n          id: In(threadConnections.map((connection) => connection.source)),\n        },\n      })\n      const allConnections = await getRepository('FlowEdge').find({\n        where: { session_id: currentSession.id },\n      })\n\n      const threadConnectedNodes = allConnections\n        .filter((connection) => connection.target === threadNode.id)\n        .map((connection) => {\n          const node = flowNodes.find((node) => node.id === connection.source)!\n          return {\n            connection,\n            source: node,\n            entity: flowNodeDatas?.[node.source_type]?.find(\n              (nodeData) => nodeData.id === node.source_id,\n            ),\n          }\n        })\n\n      const llmInfo = threadConnectedNodes.find((node) => node.source.source_type === 'LLM')\n      const promptInfo = threadConnectedNodes.filter((node) => node.source.source_type === 'Prompt')\n      const schemaInfo = threadConnectedNodes.find((node) => node.source.source_type === 'Schema')\n\n      const llm = llmInfo?.entity as LLM\n\n      if (!llm) {\n        return\n      }\n\n      if (currentSession.passphrase) {\n        await passphraseConfirm(currentSession.passphrase!, sessionPassphraseDialogRef.current)\n      }\n\n      const placeholderInfo = threadConnectedNodes.filter(\n        (node) => node.source.source_type === 'FlowNodePlaceholder',\n      )\n\n      await getRetrieveVectorDatabase(placeholderInfo)\n      await handleThreadData(threadNode, promptInfo?.map((info) => info.entity as Prompt) || [])\n\n      // Handle Embedding Node\n      const embeddingNode = await getRepository('FlowNode').findOne({\n        where: {\n          node_type: FlowNodeTypeEnum.DefaultEmbeddingModel,\n          source_type: 'FlowNodePlaceholder',\n        },\n      })\n\n      if (embeddingNode) {\n        const embeddingEntity = await getRepository('FlowNodePlaceholder').findOne({\n          where: { id: embeddingNode.source_id },\n        })\n        setMainEmbeddingInfo({\n          embedding: embeddingEntity,\n        })\n      }\n\n      setLLMInfo({\n        llm,\n        status: llm.status || LLMStatusEnum.Started,\n        progress: '',\n      })\n      setThreadInfo({\n        thread,\n        threadNode,\n      })\n      const schemaEntity = schemaInfo?.entity as Schema\n      if (schemaEntity) {\n        const schemaItems = await getRepository('SchemaItem').find({\n          where: { schema_id: schemaEntity.id },\n        })\n        schemaEntity.schema_items = schemaItems || []\n      }\n\n      setChatInfo({\n        prompts: promptInfo?.map((info) => info.entity as Prompt) || [],\n        schema: schemaEntity,\n      })\n\n      sessionHandleStatus.current.handled = currentSession.id\n    } finally {\n      sessionHandleStatus.current.handling = undefined\n    }\n  }, [\n    currentSession?.id,\n    currentSession?.main_node_id,\n    currentSession?.main_source_id,\n    currentSession?.main_source_type,\n    currentSession?.passphrase,\n    getRetrieveVectorDatabase,\n    handleThreadData,\n    sessionPassphraseDialogRef,\n  ])\n\n  const loadLLM = useCallback(async () => {\n    if (!mainLLMInfo?.llm?.name) {\n      return\n    }\n    try {\n      setLLMInfo((pre) => (pre ? { ...pre, status: LLMStatusEnum.Loading } : pre))\n      await loadModel(mainLLMInfo.llm.provider, mainLLMInfo?.llm.name, {\n        provider: mainLLMInfo.llm.provider,\n        callback: (data) => {\n          setLLMInfo((pre) => (pre ? { ...pre, progress: data.text } : pre))\n        },\n      })\n      setLLMInfo((pre) => (pre ? { ...pre, status: LLMStatusEnum.Loaded, progress: '' } : pre))\n    } catch {\n      setLLMInfo((pre) => (pre ? { ...pre, status: LLMStatusEnum.Started, progress: '' } : pre))\n    }\n  }, [mainLLMInfo?.llm?.name, mainLLMInfo?.llm?.provider, loadModel])\n\n  const onThreadMessagesLoaded = useCallback((callback: (messages: Message[]) => void) => {\n    onThreadMessagesLoadedRef.current = callback\n    return () => {\n      onThreadMessagesLoadedRef.current = undefined\n    }\n  }, [])\n\n  const updateMessagesData = useCallback(\n    async (messages: Message[]) => {\n      if (!currentDataNode?.node || !currentDataNode?.enity) {\n        return\n      }\n      await getRepository('JSONData').save({\n        ...currentDataNode.enity,\n        data: messages,\n      })\n    },\n    [currentDataNode?.enity, currentDataNode?.node],\n  )\n\n  useEffect(() => {\n    if (\n      sessionHandleStatus.current.handling ||\n      sessionHandleStatus?.current.handled === currentSession?.id\n    ) {\n      return\n    }\n    getChatApplicationData()\n  }, [currentSession?.id, getChatApplicationData])\n\n  return {\n    ...chatInfo,\n    loadLLM,\n    threadInfo,\n    mainLLMInfo,\n    mainEmbeddingInfo,\n    retriverInfo,\n    currentDataNode,\n    updateMessagesData,\n    addNewDataNode,\n    selectDataNode,\n    setLLMInfo,\n    onThreadMessagesLoaded,\n  }\n}\n","import { useCallback, useState } from 'react'\nimport { PromptTemplate } from '@langchain/core/prompts'\nimport { MessageNodeProps } from 'src/components/flows/Nodes/chat/MessageNode/type'\nimport {\n  FlowNodePlaceholderTypeEnum,\n  LLMStatusEnum,\n  Schema,\n  SchemaItem,\n} from 'src/services/database/types'\nimport { AIMessage, BaseMessage, HumanMessage, SystemMessage } from '@langchain/core/messages'\nimport { Message } from 'ai/react'\nimport { llmHandler } from 'src/handlers'\nimport { useConfirmPassphrase } from 'src/hooks/mutations/use-confirm-passphrase'\nimport { useChatApplicationData } from './use-chat-application-data'\nimport { embeddingHandler } from 'src/handlers/embedding-handler'\nimport { OpenAISchema, OpenAISchemaProperty } from 'src/types/openai'\n\ntype CreateMessageOption = {\n  schema?: Schema\n  onMessageUpdate: (info: { id?: string; nodeData: Partial<MessageNodeProps['data']> }) => void\n  onResponseMessageCreate: (message?: string) => void\n  onInjectedMessages: (messages: BaseMessage[]) => void\n}\n// Convert database Schema to OpenAI format\nconst convertSchemaToOpenAI = (schema: Schema): OpenAISchema => {\n  const properties: Record<string, OpenAISchemaProperty> = {}\n  const required: string[] = []\n\n  // Parse schema items into properties\n  if (schema.schema_items && schema.schema_items.length > 0) {\n    schema.schema_items.forEach((item) => {\n      if (item.name) {\n        const property = convertSchemaItemToProperty(item)\n        properties[item.name] = property\n\n        if (item.required) {\n          required.push(item.name)\n        }\n      }\n    })\n  }\n\n  return {\n    name: schema.name,\n    schema: {\n      type: 'object',\n      properties,\n      ...(required.length > 0 && { required }),\n      additionalProperties: false,\n    },\n  }\n}\n\n// Convert individual SchemaItem to OpenAI property format\nconst convertSchemaItemToProperty = (item: SchemaItem): OpenAISchemaProperty => {\n  const property: OpenAISchemaProperty = {\n    type: item.type.toLowerCase(),\n  }\n\n  if (item.description) {\n    property.description = item.description\n  }\n\n  if (item.enum) {\n    try {\n      property.enum = JSON.parse(item.enum)\n    } catch {\n      // If enum is not valid JSON, treat as comma-separated values\n      property.enum = item.enum.split(',').map((v) => v.trim())\n    }\n  }\n\n  // Handle nested objects and arrays\n  if (item.type === 'object' && item.schemas && item.schemas.length > 0) {\n    property.properties = {}\n    const nestedRequired: string[] = []\n\n    item.schemas.forEach((nestedItem) => {\n      if (nestedItem.name && property.properties) {\n        property.properties[nestedItem.name] = convertSchemaItemToProperty(nestedItem)\n        if (nestedItem.required) {\n          nestedRequired.push(nestedItem.name)\n        }\n      }\n    })\n\n    if (nestedRequired.length > 0) {\n      property.required = nestedRequired\n    }\n  }\n\n  if (item.type === 'array' && item.schemas && item.schemas.length > 0) {\n    // For arrays, use the first schema item as the items definition\n    property.items = convertSchemaItemToProperty(item.schemas[0])\n  }\n\n  return property\n}\n\nexport const useSendMessage = (chatApplicationData: ReturnType<typeof useChatApplicationData>) => {\n  const [loading] = useState(false)\n  const { confirmPassphrase } = useConfirmPassphrase()\n\n  const handlePlaceholders = useCallback(\n    async (\n      content: string,\n      retriverInfo: ReturnType<typeof useChatApplicationData>['retriverInfo'],\n    ): Promise<BaseMessage[]> => {\n      if (!retriverInfo?.length) {\n        return []\n      }\n      const injectedMessages: BaseMessage[] = []\n      await Promise.all(\n        retriverInfo.map(async (item) => {\n          const placeholderRecord = item.placeholderEntity\n          if (!placeholderRecord) {\n            return\n          }\n          switch (placeholderRecord.placeholder_type) {\n            case FlowNodePlaceholderTypeEnum.VECTOR_DATABASE_RETREIVER: {\n              if (\n                !item.promptNode ||\n                !item.promptEntity ||\n                !item.vectorDatabaseNode ||\n                !item.vectorDatabaseEntity\n              ) {\n                return\n              }\n              const k = placeholderRecord.metadata?.k ? +placeholderRecord.metadata?.k : 1\n              let minimalScore = placeholderRecord.metadata?.minimalScore\n                ? +placeholderRecord.metadata?.minimalScore\n                : undefined\n              if (minimalScore && minimalScore > 1) {\n                minimalScore = minimalScore / 100\n              }\n              await confirmPassphrase()\n              const documents = await embeddingHandler.similaritySearchWithScore(\n                chatApplicationData?.mainEmbeddingInfo?.embedding,\n                {\n                  database: {\n                    databaseId: item.vectorDatabaseEntity.id,\n                  },\n                },\n                content,\n                k,\n              )\n              if (!documents) {\n                return []\n              }\n              const template = new PromptTemplate({\n                template: item.promptEntity.content,\n                inputVariables: ['context'],\n              })\n              injectedMessages.push(\n                new AIMessage(\n                  await template.format({\n                    context: !minimalScore\n                      ? documents.map(([doc]) => doc.pageContent).join('\\n')\n                      : documents\n                          .filter(([, score]) => score >= minimalScore)\n                          .map(([doc]) => doc.pageContent)\n                          .join('\\n'),\n                  }),\n                ),\n              )\n            }\n          }\n        }),\n      )\n      return injectedMessages\n    },\n    [chatApplicationData?.mainEmbeddingInfo?.embedding, confirmPassphrase],\n  )\n\n  const sendMessage = useCallback(\n    async (\n      message: string,\n      messages: Message[],\n      {\n        retriverInfo,\n      }: {\n        retriverInfo?: ReturnType<typeof useChatApplicationData>['retriverInfo']\n      },\n      { schema, onMessageUpdate, onResponseMessageCreate, onInjectedMessages }: CreateMessageOption,\n    ) => {\n      if (\n        !chatApplicationData.mainLLMInfo?.llm ||\n        chatApplicationData.mainLLMInfo?.status !== LLMStatusEnum.Loaded\n      ) {\n        throw new Error('LLM not found')\n      }\n\n      const injectedMessages: BaseMessage[] = []\n\n      if (retriverInfo?.length) {\n        injectedMessages.push(...(await handlePlaceholders(message, retriverInfo)))\n        onInjectedMessages?.(injectedMessages)\n      }\n\n      const formatedMessages = messages.map((message) => {\n        if (message.role === 'system') {\n          return new SystemMessage(message.content)\n        }\n        if (message.role === 'user') {\n          return new HumanMessage(message.content)\n        }\n        return new AIMessage(message.content)\n      })\n\n      onResponseMessageCreate?.()\n\n      await confirmPassphrase()\n      const response = await llmHandler.stream(\n        chatApplicationData.mainLLMInfo.llm.provider,\n        [...injectedMessages, ...formatedMessages],\n        {\n          schemas: schema ? [convertSchemaToOpenAI(schema)] : undefined,\n          llm: chatApplicationData.mainLLMInfo.llm,\n          onMessageUpdate: ({ content }) => {\n            onMessageUpdate?.({\n              nodeData: {\n                loading: true,\n                content: content,\n              },\n            })\n          },\n        },\n      )\n\n      onMessageUpdate?.({\n        nodeData: {\n          content: typeof response === 'string' ? response : response?.content,\n        },\n      })\n      return typeof response === 'string' ? response : response?.content\n    },\n    [handlePlaceholders, confirmPassphrase, chatApplicationData.mainLLMInfo],\n  )\n\n  return {\n    loading,\n    sendMessage,\n  }\n}\n","import { create, useModal } from '@ebay/nice-modal-react'\nimport { useState } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { useToast } from 'src/lib/hooks/use-toast'\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from 'src/lib/shadcn/ui/alert-dialog'\n\ntype DeleteSessionDialogProps = {\n  onDelete: () => Promise<void>\n}\nconst DeleteChatDataNodeDialog = create<DeleteSessionDialogProps>(({ onDelete }) => {\n  const { t } = useTranslation('dialogs')\n  const [loading, setLoading] = useState(false)\n  const currentModal = useModal()\n  const { toast } = useToast()\n\n  const handleSubmit = async () => {\n    try {\n      setLoading(true)\n      await onDelete()\n      currentModal.hide()\n    } catch {\n      toast({\n        variant: 'destructive',\n        description: t('delete_chat_data_node.errors.delete_failed'),\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <AlertDialog open={currentModal.visible} onOpenChange={currentModal.hide}>\n      <AlertDialogContent>\n        <AlertDialogHeader>\n          <AlertDialogTitle>{t('delete_chat_data_node.title')}</AlertDialogTitle>\n          <AlertDialogDescription>{t('delete_chat_data_node.description')}</AlertDialogDescription>\n        </AlertDialogHeader>\n        <AlertDialogFooter>\n          <AlertDialogCancel onClick={currentModal.hide}>\n            {t('delete_chat_data_node.cancel')}\n          </AlertDialogCancel>\n          <AlertDialogAction disabled={loading} onClick={handleSubmit}>\n            {t('delete_chat_data_node.delete')}\n          </AlertDialogAction>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  )\n})\n\nexport default DeleteChatDataNodeDialog\n","// @hidden\nexport default function MessageLoading() {\n  return (\n    <svg\n      width=\"24\"\n      height=\"24\"\n      viewBox=\"0 0 24 24\"\n      xmlns=\"http://www.w3.org/2000/svg\"\n      className=\"text-foreground\"\n    >\n      <circle cx=\"4\" cy=\"12\" r=\"2\" fill=\"currentColor\">\n        <animate\n          id=\"spinner_qFRN\"\n          begin=\"0;spinner_OcgL.end+0.25s\"\n          attributeName=\"cy\"\n          calcMode=\"spline\"\n          dur=\"0.6s\"\n          values=\"12;6;12\"\n          keySplines=\".33,.66,.66,1;.33,0,.66,.33\"\n        />\n      </circle>\n      <circle cx=\"12\" cy=\"12\" r=\"2\" fill=\"currentColor\">\n        <animate\n          begin=\"spinner_qFRN.begin+0.1s\"\n          attributeName=\"cy\"\n          calcMode=\"spline\"\n          dur=\"0.6s\"\n          values=\"12;6;12\"\n          keySplines=\".33,.66,.66,1;.33,0,.66,.33\"\n        />\n      </circle>\n      <circle cx=\"20\" cy=\"12\" r=\"2\" fill=\"currentColor\">\n        <animate\n          id=\"spinner_OcgL\"\n          begin=\"spinner_qFRN.begin+0.2s\"\n          attributeName=\"cy\"\n          calcMode=\"spline\"\n          dur=\"0.6s\"\n          values=\"12;6;12\"\n          keySplines=\".33,.66,.66,1;.33,0,.66,.33\"\n        />\n      </circle>\n    </svg>\n  )\n}\n","import { memo, useCallback, useEffect, useMemo, useState } from 'react'\nimport LazyIcon from 'src/components/atoms/LazyIcon'\nimport { LLMStatusEnum } from 'src/services/database/types/llm'\nimport type { ModelRecord } from '@mlc-ai/web-llm'\nimport LLMIcon from 'src/components/atoms/LLMIcon'\nimport { LLMInfo } from 'src/components/atoms/LLMInfo'\n\nimport { LLM } from 'src/services/database/types'\nimport { Button } from 'src/lib/shadcn/ui/button'\nimport { useTranslation } from 'react-i18next'\nimport { Card } from 'src/lib/shadcn/ui/card'\n\nexport const ChatLLMInfo = memo(\n  ({\n    llm,\n    status,\n    loadLLM,\n    progress,\n  }: {\n    llm?: LLM\n    progress?: string\n    status?: `${LLMStatusEnum}`\n    loadLLM?: () => Promise<void>\n  }) => {\n    const { t } = useTranslation('flows')\n    const [llmInfo, setLLMInfo] = useState<\n      | { hasCache: boolean; isFunctionCalling: boolean; info?: ModelRecord; cloud?: boolean }\n      | undefined\n    >()\n\n    useEffect(() => {\n      if (llmInfo || !llm?.name) {\n        return\n      }\n      if (llm?.provider !== 'WebLLM') {\n        setLLMInfo({\n          hasCache: false,\n          cloud: true,\n          isFunctionCalling: true,\n          info: {\n            model_id: llm?.name,\n            model: llm?.name,\n            model_lib: llm?.provider,\n            model_type: 2,\n          },\n        })\n        return\n      }\n      import('@mlc-ai/web-llm').then(\n        async ({ hasModelInCache, functionCallingModelIds, prebuiltAppConfig }) => {\n          const hasCache = await hasModelInCache(llm?.name)\n          setLLMInfo({\n            hasCache,\n            isFunctionCalling: functionCallingModelIds.includes(llm?.name),\n            info: prebuiltAppConfig.model_list.find((item) => item.model_id === llm?.name),\n          })\n        },\n      )\n    }, [llm?.name, llmInfo])\n\n    const handleLoadLLM = useCallback(async () => {\n      await loadLLM?.()\n    }, [loadLLM])\n\n    const llmIcon = useMemo(() => {\n      switch (status) {\n        case LLMStatusEnum.Downloading:\n          return <LazyIcon className={'animate-spin w-7 h-7'} name={'arrow-big-down-dash'} />\n        case LLMStatusEnum.Loaded:\n          return <LLMIcon name={llm?.name || 'brain'} className=\"w-7 h-7\" />\n        default:\n          return <LLMIcon name={llm?.name || 'brain'} className=\"w-7 h-7\" />\n      }\n    }, [llm?.name, status])\n    return (\n      <Card className=\"flex justify-center !bg-inherit !p-2 max-w-full overflow-y-hidden !mb-2 m-2 !mt-0\">\n        <div className=\"ml-2 pt-1 max-w-full\">\n          <p className=\"flex gap-2 items-center pr-6 !text-sm font-semibold\">\n            {llmIcon}\n            {`${llm?.name || ''}`}\n          </p>\n          <div className=\"max-w-full mt-2 flex-wrap flex gap-1\">\n            <LLMInfo\n              model={llmInfo?.info}\n              isFunctionCalling={llmInfo?.isFunctionCalling || false}\n              name={llm?.name}\n              isCached={llmInfo?.hasCache || false}\n              cloud={llmInfo?.cloud || false}\n            />\n            {status !== LLMStatusEnum.Loaded ? (\n              progress ? (\n                <div className=\"text-sm break-words flex-wrap\">{progress}</div>\n              ) : (\n                <Button\n                  disabled={status === LLMStatusEnum.Loading}\n                  onClick={handleLoadLLM}\n                  className=\"mt-4 w-full\"\n                >\n                  {t(\n                    llmInfo?.hasCache\n                      ? 'llm_node.load_model_button'\n                      : 'llm_node.download_model_button',\n                  )}\n                </Button>\n              )\n            ) : undefined}\n          </div>\n        </div>\n      </Card>\n    )\n  },\n)\n","import { Document } from '@langchain/core/documents'\nimport chunk from 'lodash/chunk'\nimport { useCallback, useState } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { embeddingHandler } from 'src/handlers/embedding-handler'\nimport { useToast } from 'src/lib/hooks/use-toast'\nimport { useConfirmPassphrase } from 'src/hooks/mutations/use-confirm-passphrase'\nimport type { VectorDatabase } from 'src/services/database/types'\nimport { VectorDatabaseStorageEnum } from 'src/services/database/types'\nimport { useChatApplicationData } from './use-chat-application-data'\n\nexport const useVectorDatabaseActions = (\n  mainEmbeddingInfo?: ReturnType<typeof useChatApplicationData>['mainEmbeddingInfo'],\n) => {\n  const [loading, setLoading] = useState(false)\n  const { t } = useTranslation('flows')\n  const { toast } = useToast()\n  const { confirmPassphrase } = useConfirmPassphrase()\n\n  const similaritySearchWithScore = useCallback(\n    async (input: string, options?: { k?: number; vectorDatabase: VectorDatabase }) => {\n      try {\n        if (!options?.vectorDatabase) {\n          toast({\n            variant: 'destructive',\n            title: t('vector_database_node.errors.vector_database_not_found'),\n          })\n          return\n        }\n        if (options?.vectorDatabase.storage === VectorDatabaseStorageEnum.DataNode) {\n          throw new Error('DataNode storage is not supported for similarity search')\n        } else {\n          setLoading(true)\n          await confirmPassphrase()\n          const result = await embeddingHandler.similaritySearchWithScore(\n            mainEmbeddingInfo?.embedding,\n            {\n              database: {\n                databaseId: options.vectorDatabase.id,\n              },\n            },\n            input,\n            options?.k,\n          )\n          return result\n        }\n      } catch {\n        toast({\n          variant: 'destructive',\n          title: t('vector_database_node.errors.similarity_search_failed'),\n        })\n      } finally {\n        setLoading(false)\n      }\n    },\n    [toast, t, mainEmbeddingInfo?.embedding, confirmPassphrase],\n  )\n\n  const indexData = useCallback(\n    async (\n      data: { id?: string; content?: string; documents?: Document[] },\n      options?: {\n        vectorDatabase: VectorDatabase\n        onProgressReport?: (info: { total: number; handled: number; handling: number }) => void\n      },\n    ) => {\n      try {\n        setLoading(true)\n        const documents = data.content\n          ? [\n              new Document({\n                pageContent: data.content,\n                id: data.id,\n                metadata: {\n                  id: data.id,\n                },\n              }),\n            ]\n          : data.documents\n\n        if (!documents?.length) {\n          toast({\n            variant: 'destructive',\n            title: t('vector_database_node.errors.content_not_found'),\n          })\n          return\n        }\n\n        if (!options?.vectorDatabase) {\n          toast({\n            variant: 'destructive',\n            title: t('vector_database_node.errors.vector_database_not_found'),\n          })\n          return\n        }\n\n        if (options?.vectorDatabase.storage === VectorDatabaseStorageEnum.DataNode) {\n          throw new Error('DataNode storage is not supported for indexing')\n        } else {\n          // DEFAULT OPTION IS INDEXING AND STORED DIRECTLY TO VECTOR DATABASE ENTITY\n          const chunkedDocuments = chunk(documents, 10)\n          let handledCount = 0\n\n          for (const partDocuments of chunkedDocuments) {\n            options?.onProgressReport?.({\n              handling: partDocuments.length,\n              handled: handledCount,\n              total: documents.length,\n            })\n            await confirmPassphrase()\n            await embeddingHandler.index(\n              mainEmbeddingInfo?.embedding,\n              {\n                database: {\n                  databaseId: options.vectorDatabase.id,\n                },\n              },\n              partDocuments,\n            )\n            handledCount += partDocuments.length\n          }\n        }\n      } catch {\n        toast({\n          variant: 'destructive',\n          title: t('vector_database_node.errors.similarity_search_failed'),\n        })\n      } finally {\n        setLoading(false)\n      }\n    },\n    [toast, t, mainEmbeddingInfo?.embedding, confirmPassphrase],\n  )\n\n  return {\n    loading,\n    indexData,\n    similaritySearchWithScore,\n  }\n}\n","import { useCallback, useMemo, useState } from 'react'\nimport { create, useModal } from '@ebay/nice-modal-react'\nimport LazyIcon from 'src/components/atoms/LazyIcon'\nimport { WebPDFLoader } from '@langchain/community/document_loaders/web/pdf'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from 'src/lib/shadcn/ui/tabs'\nimport { VectorDatabaseStorageEnum } from 'src/services/database/types'\nimport { useTranslation } from 'react-i18next'\nimport { cn } from 'src/lib/utils'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from 'src/lib/shadcn/ui/dialog'\nimport { VectorSearch } from 'src/components/flows/Nodes/data/VectorDatabaseNode/components/VectorSearch'\nimport IndexNewText from 'src/components/flows/Nodes/data/VectorDatabaseNode/components/IndexNewText'\nimport IndexNewFile from 'src/components/flows/Nodes/data/VectorDatabaseNode/components/IndexNewFile'\nimport { DataViewer } from 'src/components/molecules/Nodes/DataViewer'\nimport { decodeLine } from 'src/utils/string-data'\nimport { useVectorDatabaseActions } from 'src/components/pages/ChatApplication/hooks/use-vector-database-actions'\nimport { useChatApplicationData } from 'src/components/pages/ChatApplication/hooks/use-chat-application-data'\n\ntype VectorDatabaseDialogProps = {\n  retriverInfo: ReturnType<typeof useChatApplicationData>['retriverInfo'][number]\n  mainEmbeddingInfo?: ReturnType<typeof useChatApplicationData>['mainEmbeddingInfo']\n}\n\nconst VectorDatabaseDialog = create<VectorDatabaseDialogProps>(\n  ({ retriverInfo, mainEmbeddingInfo }) => {\n    const { t } = useTranslation('applications')\n    const { loading, similaritySearchWithScore, indexData } =\n      useVectorDatabaseActions(mainEmbeddingInfo)\n\n    const [mode, setMode] = useState('search')\n    const [progress, setProgress] = useState(0)\n    const currentModal = useModal()\n\n    const vectorDatabaseData = useMemo(() => {\n      if (!retriverInfo?.vectorDatabaseEntity?.raw) {\n        return {\n          headers: [],\n          rows: [],\n        }\n      }\n\n      const headers = ['content', 'embedding', 'metadata']\n      const lines = decodeLine(retriverInfo?.vectorDatabaseEntity?.raw)\n      return {\n        headers,\n        rows: lines.map((row) => {\n          try {\n            const data = JSON.parse(row)\n            return data\n          } catch {\n            return []\n          }\n        }),\n      }\n    }, [retriverInfo?.vectorDatabaseEntity?.raw])\n\n    const handleCreateData = useCallback(\n      async (...args: Parameters<typeof indexData>) => {\n        const [data, options] = args\n        await indexData(data, {\n          ...options,\n          vectorDatabase: retriverInfo.vectorDatabaseEntity,\n        })\n      },\n      [indexData, retriverInfo.vectorDatabaseEntity],\n    )\n\n    const handleSimilaritySearch = useCallback(\n      async (value: string, k?: number) => {\n        const input = value.trim()\n        const documents = await similaritySearchWithScore(input, {\n          k,\n          vectorDatabase: retriverInfo.vectorDatabaseEntity,\n        })\n        if (!documents?.length) {\n          return\n        }\n        return documents\n      },\n      [retriverInfo.vectorDatabaseEntity, similaritySearchWithScore],\n    )\n\n    const handleIndexPDF = useCallback(\n      async (file: File) => {\n        if (file.type.includes('text') || file.type.includes('txt')) {\n          const reader = new FileReader()\n          reader.onload = async (e) => {\n            const content = e.target?.result as string\n            await handleCreateData(\n              { content },\n              {\n                vectorDatabase: retriverInfo.vectorDatabaseEntity,\n              },\n            )\n          }\n          reader.readAsText(file)\n        } else if (file.type.endsWith('pdf')) {\n          // File to blob\n          const blob = new Blob([file], { type: 'application/pdf' })\n          const customBuildLoader = new WebPDFLoader(blob, {\n            // you may need to add `.then(m => m.default)` to the end of the import\n            pdfjs: async () => {\n              const pdfjs = await import('pdfjs-dist/legacy/build/pdf.min.mjs')\n              await import('pdfjs-dist/legacy/build/pdf.worker.min.mjs')\n              pdfjs.GlobalWorkerOptions.workerSrc = new URL(\n                'pdfjs-dist/build/pdf.worker.min.js',\n                import.meta.url,\n              ).toString()\n              return pdfjs\n            },\n            parsedItemSeparator: ' ',\n          })\n          const documents = await customBuildLoader.load()\n          await handleCreateData(\n            { documents },\n            {\n              vectorDatabase: retriverInfo.vectorDatabaseEntity,\n              onProgressReport: (info) => {\n                setProgress((info.handled + info.handling) / info.total)\n              },\n            },\n          )\n        }\n      },\n      [handleCreateData, retriverInfo.vectorDatabaseEntity],\n    )\n\n    const renderContent = useMemo(() => {\n      switch (mode) {\n        case 'search':\n          return (\n            <TabsContent value=\"search\">\n              <VectorSearch loading={loading} onSimilaritySearch={handleSimilaritySearch} />\n            </TabsContent>\n          )\n        case 'new':\n          return (\n            <TabsContent className=\"min-w-80\" value=\"new\">\n              <IndexNewText loading={loading} onCreateData={handleCreateData} />\n            </TabsContent>\n          )\n        case 'file':\n          return (\n            <TabsContent value=\"file\">\n              <IndexNewFile\n                loading={loading}\n                progress={progress}\n                onFileSubmit={handleIndexPDF}\n                fileOptions={{ accept: '.pdf,.txt,.text', maxSize: 1 }}\n              />\n            </TabsContent>\n          )\n        case 'view': {\n          return (\n            <TabsContent value=\"view\" className=\"max-h-full overflow-auto\">\n              <DataViewer\n                data={vectorDatabaseData.rows}\n                headers={vectorDatabaseData.headers}\n                limitLengthByColumns={{\n                  embedding: 32,\n                }}\n              />\n            </TabsContent>\n          )\n        }\n      }\n    }, [\n      handleCreateData,\n      handleIndexPDF,\n      handleSimilaritySearch,\n      loading,\n      mode,\n      progress,\n      vectorDatabaseData,\n    ])\n\n    return (\n      <Dialog open={currentModal.visible} onOpenChange={currentModal.hide}>\n        <DialogContent className=\"max-w-3xl\">\n          <DialogHeader>\n            <div className=\"flex\">\n              <LazyIcon name=\"file\" className=\"mr-2 h-4 w-4\" />\n              <DialogTitle>{t('chat.vector_database')}</DialogTitle>\n            </div>\n          </DialogHeader>\n          <div className=\"mx-auto w-full min-h-96 max-h-full overflow-hidden\">\n            <div className=\"w-full h-full\">\n              <Tabs\n                value={mode}\n                onValueChange={setMode}\n                defaultValue=\"search\"\n                className={cn('w-full h-full mt-4')}\n              >\n                <TabsList\n                  className={cn(\n                    'grid w-full grid-cols-3',\n                    retriverInfo?.vectorDatabaseEntity?.storage ===\n                      VectorDatabaseStorageEnum.DatabaseNode\n                      ? 'grid-cols-4'\n                      : 'grid-cols-3',\n                  )}\n                >\n                  <TabsTrigger value=\"search\">{t('chat.search')}</TabsTrigger>\n                  <TabsTrigger value=\"new\">{t('chat.text')}</TabsTrigger>\n                  <TabsTrigger value=\"file\">{t('chat.file')}</TabsTrigger>\n                  {retriverInfo?.vectorDatabaseEntity?.storage ===\n                  VectorDatabaseStorageEnum.DatabaseNode ? (\n                    <TabsTrigger value=\"view\">{t('chat.view')}</TabsTrigger>\n                  ) : undefined}\n                </TabsList>\n                {renderContent}\n              </Tabs>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    )\n  },\n)\n\nexport default VectorDatabaseDialog\n","import { useCallback, useEffect, useState } from 'react'\nimport { useSessionState } from 'src/states/session'\nimport { FlowNode, JSONData } from 'src/services/database/types'\nimport { getRepository } from 'src/services/database/database'\nimport { In } from 'src/services/database/typeorm-wrapper'\nimport { findFlowNodesWithSource } from 'src/states/flow/actions'\n\nexport const useChatList = (threadNode?: FlowNode) => {\n  const [chatList, setChatList] = useState<{ node: FlowNode; entity: JSONData }[]>([])\n  const currentSession = useSessionState((state) => state.currentSession)\n\n  const getChatList = useCallback(async () => {\n    if (!threadNode || !currentSession?.id) {\n      return\n    }\n    const threadDataEdged = await getRepository('FlowEdge').find({\n      where: { session_id: currentSession.id, source: threadNode.id },\n      order: { id: 'DESC' },\n    })\n    const { flowNodes, flowNodeDatas } = await findFlowNodesWithSource({\n      where: {\n        session_id: currentSession.id,\n        id: In(threadDataEdged.map((edge) => edge.target)),\n        source_type: 'JSONData',\n      },\n      order: { updated_at: 'DESC' },\n      select: ['id', 'source_id', 'source_type', 'updated_at'],\n    })\n    setChatList(\n      flowNodes.reduce((all: { node: FlowNode; entity: JSONData }[], node) => {\n        const entity = flowNodeDatas[node.source_type]?.find((data) => data.id === node.source_id)\n        if (entity) {\n          all.push({\n            node,\n            entity: entity as JSONData,\n          })\n        }\n        return all\n      }, []),\n    )\n  }, [currentSession?.id, threadNode])\n  const deleteChat = useCallback(\n    async (node: FlowNode) => {\n      await getRepository('FlowNode').delete(node.id)\n      await getRepository('JSONData').delete(node.source_id)\n      const allEdges = await getRepository('FlowEdge').find({\n        where: [{ source: node.id }, { target: node.id }],\n      })\n      await Promise.all(\n        allEdges.map((edge) => {\n          return getRepository('FlowEdge').delete(edge.id)\n        }),\n      )\n\n      getChatList()\n    },\n    [getChatList],\n  )\n\n  useEffect(() => {\n    if (!threadNode) {\n      return\n    }\n    getChatList()\n  }, [getChatList, threadNode])\n\n  return {\n    chatList,\n    deleteChat,\n    getChatList,\n  }\n}\n","import * as React from 'react'\n\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n} from 'src/lib/shadcn/ui/sidebar'\nimport { useModal } from '@ebay/nice-modal-react'\nimport DeleteChatDataNodeDialog from 'src/components/dialogs/DeleteChatDataNodeDialog'\nimport LazyIcon from 'src/components/atoms/LazyIcon'\nimport { FlowNode, Schema } from 'src/services/database/types'\nimport { useTranslation } from 'react-i18next'\nimport LoadingButton from 'src/components/atoms/LoadingButton'\nimport { convertToZodSchemaString } from 'src/utils/schema-format'\nimport MessageLoading from 'src/lib/shadcn/chat/message-loading'\nimport { cn } from 'src/lib/utils'\nimport { MarkdownViewer } from 'src/components/molecules/MarkdownViewer'\nimport { Card } from 'src/lib/shadcn/ui/card'\nimport { Button } from 'src/lib/shadcn/ui/button'\nimport { LLMSetting } from 'src/components/atoms/LLMSetting'\n\nimport { ChatLLMInfo } from './ChatLLMInfo'\nimport VectorDatabaseDialog from './VectorDatabaseDialog'\nimport { useChatApplicationData } from '../hooks/use-chat-application-data'\nimport { useChatList } from '../hooks/use-chat-list'\nimport { useUpdateLLMOptions } from '../hooks/use-update-llm-options'\n\nexport function ChatPanel({\n  schema,\n  mainLLMInfo,\n  mainEmbeddingInfo,\n  loadLLM,\n  retriverInfo,\n  threadNode,\n  onSelectThread,\n  onAddNewThread,\n  currentDataNode,\n  setLLMInfo,\n  changeLLMOptions,\n  ...props\n}: React.ComponentProps<typeof Sidebar> & {\n  schema?: Schema\n  threadNode?: FlowNode\n  onAddNewThread?: () => void\n  onSelectThread: (node: FlowNode) => void\n  retriverInfo: ReturnType<typeof useChatApplicationData>['retriverInfo']\n  currentDataNode: ReturnType<typeof useChatApplicationData>['currentDataNode']\n  loadLLM: ReturnType<typeof useChatApplicationData>['loadLLM']\n  mainLLMInfo: ReturnType<typeof useChatApplicationData>['mainLLMInfo']\n  mainEmbeddingInfo?: ReturnType<typeof useChatApplicationData>['mainEmbeddingInfo']\n  setLLMInfo: ReturnType<typeof useChatApplicationData>['setLLMInfo']\n  changeLLMOptions: ReturnType<typeof useUpdateLLMOptions>['changeLLMOptions']\n}) {\n  const { t } = useTranslation('applications')\n  const [loading, setLoading] = React.useState(false)\n  const deleteChatDataNodeDialog = useModal(DeleteChatDataNodeDialog)\n  const vectorDatabaseDialog = useModal(VectorDatabaseDialog)\n  const { chatList, getChatList, deleteChat } = useChatList(threadNode)\n\n  const handleAddNewThread = React.useCallback(async () => {\n    try {\n      setLoading(true)\n      await onAddNewThread?.()\n      getChatList()\n    } finally {\n      setLoading(false)\n    }\n  }, [getChatList, onAddNewThread])\n\n  const handleShowVectorDatabase = React.useCallback(() => {\n    vectorDatabaseDialog.show({\n      retriverInfo: retriverInfo[0],\n      mainEmbeddingInfo: mainEmbeddingInfo,\n    })\n  }, [mainEmbeddingInfo, retriverInfo, vectorDatabaseDialog])\n\n  const handleDeleteDataNode = React.useCallback(\n    async (e: React.MouseEvent, node: FlowNode) => {\n      e.stopPropagation()\n      deleteChatDataNodeDialog.show({ onDelete: () => deleteChat(node) })\n    },\n    [deleteChat, deleteChatDataNodeDialog],\n  )\n\n  const handleChangeOptions = React.useCallback(\n    async (options: Record<string, unknown>) => {\n      if (!mainLLMInfo?.llm) {\n        return\n      }\n      await changeLLMOptions(mainLLMInfo?.llm, options)\n      setLLMInfo((pre) =>\n        pre\n          ? {\n              ...pre,\n              llm: {\n                ...pre.llm,\n                options,\n              },\n            }\n          : undefined,\n      )\n    },\n    [changeLLMOptions, mainLLMInfo?.llm, setLLMInfo],\n  )\n\n  const content = React.useMemo(() => {\n    return (\n      <MarkdownViewer\n        className={cn('overflow-hidden break-words whitespace-pre-wrap w-full rounded-lg')}\n        source={\n          schema?.schema_items?.length\n            ? `\\`\\`\\`javascript\\n${convertToZodSchemaString(schema?.schema_items || [])}\\n\\`\\`\\``\n            : ''\n        }\n      />\n    )\n  }, [schema?.schema_items])\n\n  return (\n    <Sidebar variant=\"sidebar\" side=\"right\" collapsible=\"none\" {...props}>\n      <div className=\"h-1\" />\n      <SidebarGroupLabel className=\"justify-between\">\n        <div className=\"text-sm pl-2\">{t('chat.history')}</div>\n        <LoadingButton\n          loading={loading}\n          onClick={handleAddNewThread}\n          variant=\"link\"\n          className=\"mr-[-6px]\"\n        >\n          <LazyIcon name=\"circle-plus\" />\n        </LoadingButton>\n      </SidebarGroupLabel>\n      <SidebarContent>\n        <SidebarGroup className=\"flex-1\">\n          <SidebarMenu>\n            {chatList.map(({ node }, index) => (\n              <SidebarMenuItem key={node.id} onClick={() => onSelectThread(node)}>\n                <SidebarMenuButton className=\"cursor-pointer\">\n                  <div className=\"flex flex-row justify-between items-center w-full\">\n                    <div className=\"flex gap-2\">\n                      <LazyIcon\n                        size={16}\n                        name={currentDataNode?.node?.id === node.id ? 'check' : 'chevron-right'}\n                        className=\"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90\"\n                      />\n                      <span>{`Thread ${index + 1}`}</span>\n                    </div>\n                    <LazyIcon\n                      onClick={(e) => handleDeleteDataNode(e, node)}\n                      size={16}\n                      name=\"trash-2\"\n                    />\n                  </div>\n                </SidebarMenuButton>\n              </SidebarMenuItem>\n            ))}\n          </SidebarMenu>\n        </SidebarGroup>\n        {retriverInfo?.length ? (\n          <Card className=\"m-2 p-2 max-w-full\">\n            <pre className=\"overflow-auto\">\n              {retriverInfo.map((info, key) => (\n                <span key={`${key}`}>{info.promptEntity?.content || ''}</span>\n              ))}\n            </pre>\n            <Button onClick={handleShowVectorDatabase} className=\"w-full mt-4\">\n              {t('chat.vector_database')}\n            </Button>\n          </Card>\n        ) : undefined}\n        {schema?.schema_items?.length ? (\n          <div className=\"m-2 !mb-0\">\n            <React.Suspense fallback={<MessageLoading />}>{content}</React.Suspense>\n          </div>\n        ) : undefined}\n        <LLMSetting\n          options={mainLLMInfo?.llm?.options}\n          onChangeOptions={handleChangeOptions}\n          className=\"p-2\"\n        />\n        <ChatLLMInfo\n          llm={mainLLMInfo?.llm}\n          status={mainLLMInfo?.status}\n          progress={mainLLMInfo?.progress}\n          loadLLM={loadLLM}\n        />\n      </SidebarContent>\n    </Sidebar>\n  )\n}\n","\"use client\";\n\n// packages/react/avatar/src/Avatar.tsx\nimport * as React from \"react\";\nimport { createContextScope } from \"@radix-ui/react-context\";\nimport { useCallbackRef } from \"@radix-ui/react-use-callback-ref\";\nimport { useLayoutEffect } from \"@radix-ui/react-use-layout-effect\";\nimport { Primitive } from \"@radix-ui/react-primitive\";\nimport { jsx } from \"react/jsx-runtime\";\nvar AVATAR_NAME = \"Avatar\";\nvar [createAvatarContext, createAvatarScope] = createContextScope(AVATAR_NAME);\nvar [AvatarProvider, useAvatarContext] = createAvatarContext(AVATAR_NAME);\nvar Avatar = React.forwardRef(\n  (props, forwardedRef) => {\n    const { __scopeAvatar, ...avatarProps } = props;\n    const [imageLoadingStatus, setImageLoadingStatus] = React.useState(\"idle\");\n    return /* @__PURE__ */ jsx(\n      AvatarProvider,\n      {\n        scope: __scopeAvatar,\n        imageLoadingStatus,\n        onImageLoadingStatusChange: setImageLoadingStatus,\n        children: /* @__PURE__ */ jsx(Primitive.span, { ...avatarProps, ref: forwardedRef })\n      }\n    );\n  }\n);\nAvatar.displayName = AVATAR_NAME;\nvar IMAGE_NAME = \"AvatarImage\";\nvar AvatarImage = React.forwardRef(\n  (props, forwardedRef) => {\n    const { __scopeAvatar, src, onLoadingStatusChange = () => {\n    }, ...imageProps } = props;\n    const context = useAvatarContext(IMAGE_NAME, __scopeAvatar);\n    const imageLoadingStatus = useImageLoadingStatus(src, imageProps.referrerPolicy);\n    const handleLoadingStatusChange = useCallbackRef((status) => {\n      onLoadingStatusChange(status);\n      context.onImageLoadingStatusChange(status);\n    });\n    useLayoutEffect(() => {\n      if (imageLoadingStatus !== \"idle\") {\n        handleLoadingStatusChange(imageLoadingStatus);\n      }\n    }, [imageLoadingStatus, handleLoadingStatusChange]);\n    return imageLoadingStatus === \"loaded\" ? /* @__PURE__ */ jsx(Primitive.img, { ...imageProps, ref: forwardedRef, src }) : null;\n  }\n);\nAvatarImage.displayName = IMAGE_NAME;\nvar FALLBACK_NAME = \"AvatarFallback\";\nvar AvatarFallback = React.forwardRef(\n  (props, forwardedRef) => {\n    const { __scopeAvatar, delayMs, ...fallbackProps } = props;\n    const context = useAvatarContext(FALLBACK_NAME, __scopeAvatar);\n    const [canRender, setCanRender] = React.useState(delayMs === void 0);\n    React.useEffect(() => {\n      if (delayMs !== void 0) {\n        const timerId = window.setTimeout(() => setCanRender(true), delayMs);\n        return () => window.clearTimeout(timerId);\n      }\n    }, [delayMs]);\n    return canRender && context.imageLoadingStatus !== \"loaded\" ? /* @__PURE__ */ jsx(Primitive.span, { ...fallbackProps, ref: forwardedRef }) : null;\n  }\n);\nAvatarFallback.displayName = FALLBACK_NAME;\nfunction useImageLoadingStatus(src, referrerPolicy) {\n  const [loadingStatus, setLoadingStatus] = React.useState(\"idle\");\n  useLayoutEffect(() => {\n    if (!src) {\n      setLoadingStatus(\"error\");\n      return;\n    }\n    let isMounted = true;\n    const image = new window.Image();\n    const updateStatus = (status) => () => {\n      if (!isMounted) return;\n      setLoadingStatus(status);\n    };\n    setLoadingStatus(\"loading\");\n    image.onload = updateStatus(\"loaded\");\n    image.onerror = updateStatus(\"error\");\n    image.src = src;\n    if (referrerPolicy) {\n      image.referrerPolicy = referrerPolicy;\n    }\n    return () => {\n      isMounted = false;\n    };\n  }, [src, referrerPolicy]);\n  return loadingStatus;\n}\nvar Root = Avatar;\nvar Image = AvatarImage;\nvar Fallback = AvatarFallback;\nexport {\n  Avatar,\n  AvatarFallback,\n  AvatarImage,\n  Fallback,\n  Image,\n  Root,\n  createAvatarScope\n};\n//# sourceMappingURL=index.mjs.map\n","import * as React from 'react'\nimport * as AvatarPrimitive from '@radix-ui/react-avatar'\n\nimport { cn } from 'src/lib/utils'\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn('relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full', className)}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn('aspect-square h-full w-full', className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      'flex h-full w-full items-center justify-center rounded-full bg-muted',\n      className,\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","import * as React from 'react'\nimport { cva, type VariantProps } from 'class-variance-authority'\nimport { cn } from 'src/lib/utils'\nimport { Avatar, AvatarImage, AvatarFallback } from 'src/lib/shadcn/ui/avatar'\nimport MessageLoading from 'src/lib/shadcn/chat/message-loading'\nimport { Button, ButtonProps } from 'src/lib/shadcn/ui/button'\n\n// ChatBubble\nconst chatBubbleVariant = cva('flex gap-2 max-w-[60%] items-end relative group', {\n  variants: {\n    variant: {\n      received: 'self-start',\n      sent: 'self-end flex-row-reverse',\n    },\n    layout: {\n      default: '',\n      ai: 'max-w-full w-full items-center',\n    },\n  },\n  defaultVariants: {\n    variant: 'received',\n    layout: 'default',\n  },\n})\n\ninterface ChatBubbleProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof chatBubbleVariant> {\n  innerclassname?: string\n}\n\nconst ChatBubble = React.forwardRef<HTMLDivElement, ChatBubbleProps>(\n  ({ className, variant, layout, children, ...props }, ref) => (\n    <div\n      className={cn(chatBubbleVariant({ variant, layout, className }), 'relative group')}\n      ref={ref}\n      {...props}\n    >\n      {React.Children.map(children, (child) =>\n        React.isValidElement(child) && typeof child.type !== 'string'\n          ? React.cloneElement(child, {\n              variant,\n              layout,\n              className: props?.innerclassname,\n            } as React.ComponentProps<typeof child.type>)\n          : child,\n      )}\n    </div>\n  ),\n)\nChatBubble.displayName = 'ChatBubble'\n\n// ChatBubbleAvatar\ninterface ChatBubbleAvatarProps {\n  src?: string\n  fallback?: string\n  className?: string\n}\n\nconst ChatBubbleAvatar: React.FC<ChatBubbleAvatarProps> = ({ src, fallback, className }) => (\n  <Avatar className={className}>\n    <AvatarImage src={src} alt=\"Avatar\" />\n    <AvatarFallback>{fallback}</AvatarFallback>\n  </Avatar>\n)\n\n// ChatBubbleMessage\nconst chatBubbleMessageVariants = cva('p-4', {\n  variants: {\n    variant: {\n      received: 'bg-secondary text-secondary-foreground rounded-r-lg rounded-tl-lg',\n      sent: 'border border-border rounded-l-lg rounded-tr-lg',\n    },\n    layout: {\n      default: '',\n      ai: 'border-t w-full rounded-none bg-transparent',\n    },\n  },\n  defaultVariants: {\n    variant: 'received',\n    layout: 'default',\n  },\n})\n\ninterface ChatBubbleMessageProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof chatBubbleMessageVariants> {\n  isLoading?: boolean\n}\n\nconst ChatBubbleMessage = React.forwardRef<HTMLDivElement, ChatBubbleMessageProps>(\n  ({ className, variant, layout, isLoading = false, children, ...props }, ref) => (\n    <div\n      className={cn(\n        chatBubbleMessageVariants({ variant, layout, className }),\n        'break-words max-w-full whitespace-pre-wrap',\n      )}\n      ref={ref}\n      {...props}\n    >\n      {isLoading ? (\n        <div className=\"flex items-center space-x-2\">\n          <MessageLoading />\n        </div>\n      ) : (\n        children\n      )}\n    </div>\n  ),\n)\nChatBubbleMessage.displayName = 'ChatBubbleMessage'\n\n// ChatBubbleTimestamp\ninterface ChatBubbleTimestampProps extends React.HTMLAttributes<HTMLDivElement> {\n  timestamp: string\n}\n\nconst ChatBubbleTimestamp: React.FC<ChatBubbleTimestampProps> = ({\n  timestamp,\n  className,\n  ...props\n}) => (\n  <div className={cn('text-xs mt-2 text-right', className)} {...props}>\n    {timestamp}\n  </div>\n)\n\n// ChatBubbleAction\ntype ChatBubbleActionProps = ButtonProps & {\n  icon: React.ReactNode\n}\n\nconst ChatBubbleAction: React.FC<ChatBubbleActionProps> = ({\n  icon,\n  onClick,\n  className,\n  variant = 'ghost',\n  size = 'icon',\n  ...props\n}) => (\n  <Button variant={variant} size={size} className={className} onClick={onClick} {...props}>\n    {icon}\n  </Button>\n)\n\ninterface ChatBubbleActionWrapperProps extends React.HTMLAttributes<HTMLDivElement> {\n  variant?: 'sent' | 'received'\n  className?: string\n}\n\nconst ChatBubbleActionWrapper = React.forwardRef<HTMLDivElement, ChatBubbleActionWrapperProps>(\n  ({ variant, className, children, ...props }, ref) => (\n    <div\n      ref={ref}\n      className={cn(\n        'absolute top-1/2 -translate-y-1/2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200',\n        variant === 'sent'\n          ? '-left-1 -translate-x-full flex-row-reverse'\n          : '-right-1 translate-x-full',\n        className,\n      )}\n      {...props}\n    >\n      {children}\n    </div>\n  ),\n)\nChatBubbleActionWrapper.displayName = 'ChatBubbleActionWrapper'\n\nexport {\n  ChatBubble,\n  ChatBubbleAvatar,\n  ChatBubbleMessage,\n  ChatBubbleTimestamp,\n  chatBubbleVariant,\n  chatBubbleMessageVariants,\n  ChatBubbleAction,\n  ChatBubbleActionWrapper,\n}\n","import { memo, Suspense, useMemo } from 'react'\nimport { Message } from 'ai/react'\nimport LazyIcon from 'src/components/atoms/LazyIcon'\nimport {\n  ChatBubble,\n  ChatBubbleAction,\n  ChatBubbleAvatar,\n  ChatBubbleMessage,\n} from 'src/lib/shadcn/chat/chat-bubble'\nimport MessageLoading from 'src/lib/shadcn/chat/message-loading'\nimport { Badge } from 'src/lib/shadcn/ui/badge'\nimport { MarkdownViewer } from 'src/components/molecules/MarkdownViewer'\n\nconst ChatAiIcons = [\n  {\n    icon: 'copy' as const,\n    label: 'Copy',\n  },\n  {\n    icon: 'refresh-ccw' as const,\n    label: 'Refresh',\n  },\n  {\n    icon: 'volume-2' as const,\n    label: 'Volume',\n  },\n]\n\nexport const ChatItem = memo(\n  ({\n    message,\n    index,\n    isLastMessage,\n    isGenerating,\n    isSchema,\n    onActionClick,\n  }: {\n    message: Message\n    index: number\n    isLastMessage: boolean\n    isGenerating?: boolean\n    isSchema?: boolean\n    onActionClick: (action: string, message: Message) => Promise<void>\n  }) => {\n    const content = useMemo(() => {\n      return (\n        <MarkdownViewer\n          style={{\n            color: 'unset !important',\n          }}\n          source={\n            message.content\n              ? isSchema\n                ? `\\`\\`\\`json\\n${message.content}\\n\\`\\`\\``\n                : message.content\n              : ''\n          }\n        />\n      )\n    }, [isSchema, message.content])\n    return (\n      <ChatBubble\n        innerclassname={message.role == 'system' ? '!bg-transparent font-semibold' : undefined}\n        key={index}\n        variant={message.role == 'user' ? 'sent' : 'received'}\n      >\n        {message.role === 'system' ? (\n          <div className=\"w-10 h-10\" />\n        ) : message.role === 'assistant' ? (\n          <ChatBubbleAvatar\n            src=\"\"\n            fallback={\n              message.data && typeof message.data === 'object' && 'injectedMessage' in message.data\n                ? '📂'\n                : '🤖'\n            }\n          />\n        ) : undefined}\n        <ChatBubbleMessage>\n          {isGenerating && isLastMessage && (!message.content || isSchema) ? (\n            <MessageLoading />\n          ) : (\n            <Suspense fallback={<MessageLoading />}>\n              {message.role === 'system' ? (\n                <Badge className=\"!text-sm mb-1\">System</Badge>\n              ) : undefined}\n              {content}\n            </Suspense>\n          )}\n          {message.role === 'assistant' && isLastMessage && (\n            <div className=\"flex items-center mt-1.5 gap-1\">\n              {!isGenerating && (\n                <>\n                  {ChatAiIcons.map((icon, iconIndex) => {\n                    return (\n                      <ChatBubbleAction\n                        variant=\"ghost\"\n                        className=\"size-5\"\n                        key={iconIndex}\n                        icon={<LazyIcon name={icon.icon} className=\"size-3\" />}\n                        onClick={() => onActionClick(icon.label, message)}\n                      />\n                    )\n                  })}\n                </>\n              )}\n            </div>\n          )}\n        </ChatBubbleMessage>\n      </ChatBubble>\n    )\n  },\n  () => false,\n)\n","import { useCallback } from 'react'\nimport { getRepository } from 'src/services/database/database'\nimport { LLM } from 'src/services/database/types'\n\nexport const useUpdateLLMOptions = () => {\n  const changeLLMOptions = useCallback(async (llm: LLM, options: Record<string, unknown>) => {\n    if (llm) {\n      await getRepository('LLM').update(llm.id, { options })\n    }\n  }, [])\n\n  return {\n    changeLLMOptions,\n  }\n}\n","'use client'\n\nimport {\n  memo,\n  useEffect,\n  useRef,\n  useState,\n  KeyboardEvent,\n  MouseEvent,\n  useCallback,\n  useMemo,\n} from 'react'\nimport { nanoid } from 'nanoid'\nimport { useTranslation } from 'react-i18next'\nimport { ChatMessageList } from 'src/lib/shadcn/chat/chat-message-list'\nimport { Message, useChat } from 'ai/react'\nimport AIInput from 'src/lib/kokonutui/ai-input'\nimport { LLMStatusEnum } from 'src/services/database/types'\nimport textToSpeech from 'src/utils/text-to-speech'\nimport { SidebarInset, SidebarProvider } from 'src/lib/shadcn/ui/sidebar'\n\nimport { useChatApplicationData } from './hooks/use-chat-application-data'\nimport { useSendMessage } from './hooks/use-send-message'\nimport { ChatPanel } from './components/ChatPanel'\nimport { ChatItem } from './components/ChatItem'\nimport { useUpdateLLMOptions } from './hooks/use-update-llm-options'\n\nconst ChatApplication = memo(() => {\n  const { t } = useTranslation('applications')\n  const isScrolling = useRef(false)\n  const [isGenerating, setIsGenerating] = useState(false)\n\n  const scrollToBottom = useCallback(() => {\n    setTimeout(() => {\n      if (messagesRef.current) {\n        messagesRef.current.scrollTop = messagesRef.current.scrollHeight\n      }\n    }, 50)\n  }, [])\n\n  const chatApplicationData = useChatApplicationData()\n  const {\n    schema,\n    threadInfo,\n    mainLLMInfo,\n    retriverInfo,\n    currentDataNode,\n    loadLLM,\n    setLLMInfo,\n    addNewDataNode,\n    selectDataNode,\n    updateMessagesData,\n    onThreadMessagesLoaded,\n  } = chatApplicationData\n  const { changeLLMOptions } = useUpdateLLMOptions()\n  const { sendMessage } = useSendMessage(chatApplicationData)\n  const {\n    input,\n    messages,\n    isLoading,\n    reload,\n    setInput,\n    handleSubmit,\n    handleInputChange,\n    setMessages,\n  } = useChat({\n    fetch: async (_input: RequestInfo | URL, init?: RequestInit) => {\n      try {\n        setIsGenerating(true)\n        const body = JSON.parse(init?.body as string) as { messages: Message[] }\n        const newMessageId = nanoid()\n        const lastMessage = body.messages[body.messages.length - 1]\n        isScrolling.current = true\n        setMessages((messages) => [\n          ...messages,\n          { id: nanoid(), content: lastMessage.content, role: 'user' },\n        ])\n        await sendMessage(\n          lastMessage.content,\n          body.messages || [],\n          { retriverInfo },\n          {\n            schema,\n            onInjectedMessages: (injectedMessages) => {\n              if (injectedMessages.length) {\n                setMessages((messages) => [\n                  ...messages,\n                  ...injectedMessages.map((message) => {\n                    if (message._getType() === 'system') {\n                      return {\n                        id: nanoid(),\n                        content: `${message.content}`,\n                        role: 'system' as const,\n                        data: { injectedMessage: true },\n                      }\n                    } else if (message._getType() === 'human') {\n                      return {\n                        id: nanoid(),\n                        content: `${message.content}`,\n                        role: 'user' as const,\n                        data: { injectedMessage: true },\n                      }\n                    }\n                    return {\n                      id: nanoid(),\n                      content: `${message.content}`,\n                      role: 'assistant' as const,\n                      data: { injectedMessage: true },\n                    }\n                  }),\n                ])\n              }\n            },\n            onResponseMessageCreate: (content) => {\n              setMessages((messages) => [\n                ...messages,\n                { id: newMessageId, content: content || '', role: 'assistant' },\n              ])\n            },\n            onMessageUpdate: (info) => {\n              setMessages((messages) => {\n                const newMessages = [...messages]\n                const index = newMessages.findIndex((message) => message.id === newMessageId)\n                if (index !== -1) {\n                  newMessages[index] = {\n                    ...newMessages[index],\n                    content: info.nodeData.content || '',\n                  }\n                }\n                return newMessages\n              })\n              if (isScrolling.current) {\n                scrollToBottom()\n              }\n            },\n          },\n        )\n        setMessages((messages) => {\n          updateMessagesData(messages)\n          return messages\n        })\n        setIsGenerating(false)\n        setInput('')\n        if (isScrolling.current) {\n          scrollToBottom()\n        }\n        return new Response()\n      } finally {\n        setIsGenerating(false)\n      }\n    },\n  })\n\n  const messagesRef = useRef<HTMLDivElement>(null)\n\n  useEffect(() => {\n    const cleandUp = onThreadMessagesLoaded((messages) => {\n      setMessages(messages || [])\n      scrollToBottom()\n    })\n    return () => {\n      cleandUp()\n    }\n  }, [setMessages, onThreadMessagesLoaded, scrollToBottom])\n\n  const onSubmit = async (\n    _value: string,\n    e: KeyboardEvent<HTMLTextAreaElement> | MouseEvent<HTMLButtonElement>,\n  ) => {\n    setIsGenerating(true)\n    await handleSubmit(e)\n    return true\n  }\n\n  const handleActionClick = useCallback(\n    async (action: string, message: Message) => {\n      if (action === 'Refresh') {\n        setIsGenerating(true)\n        try {\n          await reload()\n        } finally {\n          setIsGenerating(false)\n        }\n      }\n\n      if (action === 'Copy') {\n        if (message && message.role === 'assistant') {\n          navigator.clipboard.writeText(message.content)\n        }\n      }\n\n      if (action === 'Volume') {\n        if (message?.content) {\n          await textToSpeech.speak(message?.content || '')\n        }\n      }\n    },\n    [reload],\n  )\n\n  const handleStopScroll = useCallback(() => (isScrolling.current = false), [])\n\n  const messageList = useMemo(() => {\n    return (\n      messages &&\n      messages.map((message, index) => (\n        <ChatItem\n          key={message.id || `${index}`}\n          message={message}\n          index={index}\n          isLastMessage={index === messages.length - 1}\n          isGenerating={isGenerating}\n          isSchema={schema ? true : false}\n          onActionClick={handleActionClick}\n        />\n      ))\n    )\n  }, [messages, isGenerating, schema, handleActionClick])\n\n  return (\n    <SidebarProvider\n      onClick={handleStopScroll}\n      className=\"max-h-full !overflow-hidden !min-h-full\"\n      style={{ minHeight: 'unset' }}\n      defaultOpen={true}\n    >\n      <SidebarInset className=\"!max-h-full !overflow-hidden\" style={{ minHeight: 'unset' }}>\n        <main className=\"flex h-full w-full max-w-2xl flex-col items-center mx-auto overflow-hidden\">\n          <div className=\"flex-1 overflow-y-auto overflow-x-hidden min-w-full max-w-full\">\n            <ChatMessageList className=\"!max-h-full\" ref={messagesRef}>\n              {messageList}\n            </ChatMessageList>\n          </div>\n          <AIInput\n            className=\"!max-w-2xl px-4\"\n            onSubmit={onSubmit}\n            disabled={isLoading || isGenerating || mainLLMInfo?.status !== LLMStatusEnum.Loaded}\n            placeholder={t('chat.input_message_placeholder')}\n            value={input}\n            onChange={handleInputChange}\n          />\n        </main>\n      </SidebarInset>\n      <ChatPanel\n        schema={schema}\n        currentDataNode={currentDataNode}\n        threadNode={threadInfo?.threadNode}\n        loadLLM={loadLLM}\n        mainLLMInfo={mainLLMInfo}\n        mainEmbeddingInfo={chatApplicationData.mainEmbeddingInfo}\n        retriverInfo={retriverInfo}\n        onAddNewThread={addNewDataNode}\n        onSelectThread={selectDataNode}\n        changeLLMOptions={changeLLMOptions}\n        setLLMInfo={setLLMInfo}\n      />\n    </SidebarProvider>\n  )\n})\n\nexport default ChatApplication\n"],"file":"assets/ChatApplication-BHFKRX4W.js"}