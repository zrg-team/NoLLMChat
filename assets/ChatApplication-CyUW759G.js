const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-ZNlOYtrD.js","assets/LLMIcon-mV0klbiM.js","assets/index-D_ELiTRG.js","assets/index-BHmW4Jet.css","assets/routes-BC22d4F8.js","assets/dot-BZFBpF5w.js","assets/createLucideIcon-DAzac-JV.js","assets/pdf.min-Dd_1aOTd.js","assets/pdf.worker.min-biMvLEJm.js"])))=>i.map(i=>d[i]);
import{r as n,j as a,g as W,w as Le,o as H,x as X,y as Se,_ as se,L as q,c as ea,P as ne,i as aa,u as Ee,h as Me,O as ta,__tla as sa}from"./index-D_ELiTRG.js";import{u as ke,g as S,F as na,A as Ie,S as ra,H as ia,a as oa,b as la,c as da,d as ca,e as ma,f as ua,h as ha,i as fa,B as re,V as Y,D as pa,j as wa,k as ga,l as ya,m as xa,n as _a,o as va,p as ba,L as Na,q as ja,r as Ca,s as Da,t as La,v as Sa,w as Ea,x as Ma,y as K,__tla as ka}from"./routes-BC22d4F8.js";import{u as Ia,__tla as Ra}from"./index-DyEjF3oh.js";import{A as Oa,__tla as Fa}from"./popover-exEqeTvl.js";import{f as ie,u as Re,F as Ta,P as Aa,C as Oe,L as Pa,c as Va,W as Ba,T as Z,D as Wa,I as za,a as Ja,V as $a,b as Ha,d as qa,e as ee,M as Fe,g as Ua,B as Ga,__tla as Ka}from"./chunk-D7wkyXCV.js";import{u as Qa,a as Xa,I as oe,p as Ya,L as z,S as Za,b as et,c as Te,d as at,__tla as tt}from"./LLMIcon-mV0klbiM.js";import"./toNumber-DGeRjXqq.js";import{__tla as st}from"./index-Dzfaeq0k.js";import"./dot-BZFBpF5w.js";import"./createLucideIcon-DAzac-JV.js";let Ae,nt=Promise.all([(()=>{try{return sa}catch{}})(),(()=>{try{return ka}catch{}})(),(()=>{try{return Ra}catch{}})(),(()=>{try{return Fa}catch{}})(),(()=>{try{return Ka}catch{}})(),(()=>{try{return tt}catch{}})(),(()=>{try{return st}catch{}})()]).then(async()=>{const le=n.forwardRef(({className:e,children:s,...l},i)=>a.jsx("div",{className:W("flex flex-col w-full h-full p-4 gap-6 overflow-y-auto",e),ref:i,...l,children:s}));le.displayName="ChatMessageList";const Pe=()=>{var $,B;const[e,s]=n.useState(),[l,i]=n.useState(),[r,c]=n.useState(),[d,h]=n.useState(),[w,f]=n.useState([]),[o,y]=n.useState(),p=n.useRef(),v=n.useRef({}),t=ke(m=>m.currentSession),{loadModel:E}=Qa(),{modalRef:I}=Xa(Za),P=n.useCallback(async m=>{var g;if(!t)return;const u=await S("JSONData").findOne({where:{id:m.source_id,session_id:t==null?void 0:t.id}});u&&((g=p.current)==null||g.call(p,u.data?u.data:[]),y({node:m,enity:u}))},[t]),L=n.useCallback(async m=>{var F;const u=(m==null?void 0:m.sessionId)||(t==null?void 0:t.id),g=(m==null?void 0:m.threadNode)||(r==null?void 0:r.threadNode),M=(m==null?void 0:m.prompts)||(e==null?void 0:e.prompts);if(!u||!(g!=null&&g.id))return;const O=M==null?void 0:M.map(k=>{if(k.type!=="few_shot_example")switch(k.role){case"ai":case"assistant":case"tool":return{id:k.id,content:k.content,role:"assistant"};case"system":return{id:k.id,content:k.content,role:"system"};default:return{id:k.id,content:k.content,role:"user"}}}).filter(Boolean),D=await S("JSONData").save({headers:"item",session_id:u,json:"",data:O});if(!D)return;const x=await S("FlowNode").save({session_id:u,source_id:D.id,source_type:"JSONData",node_type:"JSON_DATA",x:0,y:0});if(x)return await S("FlowEdge").save({session_id:u,source:g.id,target:x.id}),(F=p.current)==null||F.call(p,O),y({node:x,enity:D}),{jsonData:D,jsonDataNode:x}},[e==null?void 0:e.prompts,t==null?void 0:t.id,r==null?void 0:r.threadNode]),_=n.useCallback(async(m,u)=>{if(!t)return;const g=await S("FlowEdge").findOne({where:{session_id:t.id,source:m.id},order:{id:"DESC"}});if(g){const M=await S("FlowNode").findOne({where:{id:g.target,session_id:t.id}});if(!M)return;await P(M)}else if(!await L({sessionId:t.id,threadNode:m,prompts:u||[]}))return},[L,t,P]),C=n.useCallback(async m=>{if(m!=null&&m.length&&(t!=null&&t.id)){const u=(await Promise.all(m.map(async g=>S("FlowEdge").find({where:{target:g.source.id}}).then(M=>ie({where:{session_id:t.id,id:oe(M.map(O=>O.source))}}).then(O=>({...O,...g})))))).map(g=>{var F,k,J,T;const M=g.flowNodes.find(A=>A.source_type==="Prompt"),O=g.flowNodes.find(A=>A.source_type==="VectorDatabase");if(!O||!M)return;const D=(k=(F=g.flowNodeDatas)==null?void 0:F.Prompt)==null?void 0:k.find(A=>A.id===M.source_id),x=(T=(J=g.flowNodeDatas)==null?void 0:J.VectorDatabase)==null?void 0:T.find(A=>A.id===O.source_id);return{promptNode:M,vectorDatabaseNode:O,placeholderNode:g.source,placeholderEntity:g.entity,promptEntity:D,vectorDatabaseEntity:x}}).filter(Boolean);f(u)}},[t==null?void 0:t.id]),N=n.useCallback(async()=>{try{if(v.current.handling=t==null?void 0:t.id,!(t!=null&&t.id)||!(t!=null&&t.main_source_id)||(t==null?void 0:t.main_source_type)!=="Thread")return;const[m,u]=await Promise.all([S("Thread").findOne({where:{id:t.main_source_id,session_id:t.id}}),S("FlowNode").findOne({where:{id:t.main_node_id}})]);if(!m||!u)return;const g=await S("FlowEdge").find({where:{session_id:t.id,target:u.id}}),{flowNodes:M,flowNodeDatas:O}=await ie({where:{session_id:t.id,id:oe(g.map(b=>b.source))}}),D=(await S("FlowEdge").find({where:{session_id:t.id}})).filter(b=>b.target===u.id).map(b=>{var De;const G=M.find(te=>te.id===b.source);return{connection:b,source:G,entity:(De=O==null?void 0:O[G.source_type])==null?void 0:De.find(te=>te.id===G.source_id)}}),x=D.find(b=>b.source.source_type==="LLM"),F=D.filter(b=>b.source.source_type==="Prompt"),k=D.find(b=>b.source.source_type==="Schema"),J=x==null?void 0:x.entity;if(!J)return;t.passphrase&&await Ya(t.passphrase,I.current);const T=D.filter(b=>b.source.source_type==="FlowNodePlaceholder");await C(T),await _(u,(F==null?void 0:F.map(b=>b.entity))||[]);const A=await S("FlowNode").findOne({where:{node_type:na.DefaultEmbeddingModel,source_type:"FlowNodePlaceholder"}});if(A){const b=await S("FlowNodePlaceholder").findOne({where:{id:A.source_id}});i({embedding:b})}h({llm:J,status:J.status||z.Started,progress:""}),c({thread:m,threadNode:u});const V=k==null?void 0:k.entity;if(V){const b=await S("SchemaItem").find({where:{schema_id:V.id}});V.schema_items=b||[]}s({prompts:(F==null?void 0:F.map(b=>b.entity))||[],schema:V}),v.current.handled=t.id}finally{v.current.handling=void 0}},[t==null?void 0:t.id,t==null?void 0:t.main_node_id,t==null?void 0:t.main_source_id,t==null?void 0:t.main_source_type,t==null?void 0:t.passphrase,C,_,I]),j=n.useCallback(async()=>{var m;if((m=d==null?void 0:d.llm)!=null&&m.name)try{h(u=>u&&{...u,status:z.Loading}),await E(d.llm.provider,d==null?void 0:d.llm.name,u=>{h(g=>g&&{...g,progress:u.text})}),h(u=>u&&{...u,status:z.Loaded,progress:""})}catch{h(u=>u&&{...u,status:z.Started,progress:""})}},[($=d==null?void 0:d.llm)==null?void 0:$.name,(B=d==null?void 0:d.llm)==null?void 0:B.provider,E]),R=n.useCallback(m=>(p.current=m,()=>{p.current=void 0}),[]),U=n.useCallback(async m=>{!(o!=null&&o.node)||!(o!=null&&o.enity)||await S("JSONData").save({...o.enity,data:m})},[o==null?void 0:o.enity,o==null?void 0:o.node]);return n.useEffect(()=>{v.current.handling||(v==null?void 0:v.current.handled)===(t==null?void 0:t.id)||N()},[t==null?void 0:t.id,N]),{...e,loadLLM:j,threadInfo:r,mainLLMInfo:d,mainEmbeddingInfo:l,retriverInfo:w,currentDataNode:o,updateMessagesData:U,addNewDataNode:L,selectDataNode:P,setLLMInfo:h,onThreadMessagesLoaded:R}},Ve=e=>{var d;const[s]=n.useState(!1),{similaritySearchWithScore:l}=Re(),{stream:i}=et(),r=n.useCallback(async(h,w)=>{if(!(w!=null&&w.length))return[];const f=[];return await Promise.all(w.map(async o=>{var p,v,t,E,I;const y=o.placeholderEntity;if(y)switch(y.placeholder_type){case Ta.VECTOR_DATABASE_RETREIVER:{if(!o.promptNode||!o.promptEntity||!o.vectorDatabaseNode||!o.vectorDatabaseEntity)return;const P=(p=y.metadata)!=null&&p.k?+((v=y.metadata)==null?void 0:v.k):1;let L=(t=y.metadata)!=null&&t.minimalScore?+((E=y.metadata)==null?void 0:E.minimalScore):void 0;L&&L>1&&(L=L/100);const _=await l((I=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:I.embedding,{database:{databaseId:o.vectorDatabaseEntity.id}},h,P);if(!_)return[];const C=new Aa({template:o.promptEntity.content,inputVariables:["context"]});f.push(new Ie(await C.format({context:L?_.filter(([,N])=>N>=L).map(([N])=>N.pageContent).join(`
`):_.map(([N])=>N.pageContent).join(`
`)})))}}})),f},[l,(d=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:d.embedding]),c=n.useCallback(async(h,w,{retriverInfo:f},{schema:o,onMessageUpdate:y,onResponseMessageCreate:p,onInjectedMessages:v})=>{var P,L;if(!((P=e.mainLLMInfo)!=null&&P.llm)||((L=e.mainLLMInfo)==null?void 0:L.status)!==z.Loaded)throw new Error("LLM not found");const t=[];f!=null&&f.length&&(t.push(...await r(h,f)),v==null||v(t));const E=w.map(_=>_.role==="system"?new ra(_.content):_.role==="user"?new ia(_.content):new Ie(_.content));p==null||p();const{content:I}=await i(e.mainLLMInfo.llm.provider,[...t,...E],{schemas:o?[o]:void 0,onMessageUpdate:({content:_})=>{y==null||y({nodeData:{loading:!0,content:_}})},llm:e.mainLLMInfo.llm});return y==null||y({nodeData:{content:I}}),I},[r,i,e.mainLLMInfo]);return{loading:s,sendMessage:c}},Be=Le(({onDelete:e})=>{const{t:s}=H("dialogs"),[l,i]=n.useState(!1),r=X(),{toast:c}=Se(),d=async()=>{try{i(!0),await e(),r.hide()}catch{c({variant:"destructive",description:s("delete_chat_data_node.errors.delete_failed")})}finally{i(!1)}};return a.jsx(oa,{open:r.visible,onOpenChange:r.hide,children:a.jsxs(la,{children:[a.jsxs(da,{children:[a.jsx(ca,{children:s("delete_chat_data_node.title")}),a.jsx(ma,{children:s("delete_chat_data_node.description")})]}),a.jsxs(ua,{children:[a.jsx(ha,{onClick:r.hide,children:s("delete_chat_data_node.cancel")}),a.jsx(fa,{disabled:l,onClick:d,children:s("delete_chat_data_node.delete")})]})]})})});function Q(){return a.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",className:"text-foreground",children:[a.jsx("circle",{cx:"4",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_qFRN",begin:"0;spinner_OcgL.end+0.25s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{begin:"spinner_qFRN.begin+0.1s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"20",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_OcgL",begin:"spinner_qFRN.begin+0.2s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})})]})}const We=n.memo(({llm:e,status:s,loadLLM:l,progress:i})=>{const{t:r}=H("flows"),[c,d]=n.useState();n.useEffect(()=>{if(!(c||!(e!=null&&e.name))){if((e==null?void 0:e.provider)!=="WebLLM"){d({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:e==null?void 0:e.name,model:e==null?void 0:e.name,model_lib:e==null?void 0:e.provider,model_type:2}});return}se(()=>import("./index-ZNlOYtrD.js").then(async f=>(await f.__tla,f)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:f,functionCallingModelIds:o,prebuiltAppConfig:y})=>{const p=await f(e==null?void 0:e.name);d({hasCache:p,isFunctionCalling:o.includes(e==null?void 0:e.name),info:y.model_list.find(v=>v.model_id===(e==null?void 0:e.name))})})}},[e==null?void 0:e.name,c]);const h=n.useCallback(async()=>{await(l==null?void 0:l())},[l]),w=n.useMemo(()=>{switch(s){case z.Downloading:return a.jsx(q,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case z.Loaded:return a.jsx(Te,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"});default:return a.jsx(Te,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"})}},[e==null?void 0:e.name,s]);return a.jsx(Oe,{className:"flex justify-center !bg-inherit !p-2 max-w-full overflow-y-hidden !mb-2 m-2 !mt-0",children:a.jsxs("div",{className:"ml-2 pt-1 max-w-full",children:[a.jsxs("p",{className:"flex gap-2 items-center pr-6 !text-sm font-semibold",children:[w,`${(e==null?void 0:e.name)||""}`]}),a.jsxs("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:[a.jsx(Pa,{model:c==null?void 0:c.info,isFunctionCalling:(c==null?void 0:c.isFunctionCalling)||!1,name:e==null?void 0:e.name,isCached:(c==null?void 0:c.hasCache)||!1,cloud:(c==null?void 0:c.cloud)||!1}),s!==z.Loaded?i?a.jsx("div",{className:"text-sm break-words flex-wrap",children:i}):a.jsx(re,{disabled:s===z.Loading,onClick:h,className:"mt-4 w-full",children:r(c!=null&&c.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")}):void 0]})]})})}),ze=e=>{const[s,l]=n.useState(!1),{t:i}=H("flows"),{toast:r}=Se(),{index:c,similaritySearchWithScore:d}=Re(),h=n.useCallback(async(f,o)=>{try{if(!(o!=null&&o.vectorDatabase)){r({variant:"destructive",title:i("vector_database_node.errors.vector_database_not_found")});return}if((o==null?void 0:o.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for similarity search");return l(!0),await d(e==null?void 0:e.embedding,{database:{databaseId:o.vectorDatabase.id}},f,o==null?void 0:o.k)}catch{r({variant:"destructive",title:i("vector_database_node.errors.similarity_search_failed")})}finally{l(!1)}},[r,i,d,e==null?void 0:e.embedding]),w=n.useCallback(async(f,o)=>{var y;try{l(!0);const p=f.content?[new pa({pageContent:f.content,id:f.id,metadata:{id:f.id}})]:f.documents;if(!(p!=null&&p.length)){r({variant:"destructive",title:i("vector_database_node.errors.content_not_found")});return}if(!(o!=null&&o.vectorDatabase)){r({variant:"destructive",title:i("vector_database_node.errors.vector_database_not_found")});return}if((o==null?void 0:o.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for indexing");{const v=Va(p,10);let t=0;for(const E of v)(y=o==null?void 0:o.onProgressReport)==null||y.call(o,{handling:E.length,handled:t,total:p.length}),await c(e==null?void 0:e.embedding,{database:{databaseId:o.vectorDatabase.id}},E),t+=E.length}}catch{r({variant:"destructive",title:i("vector_database_node.errors.similarity_search_failed")})}finally{l(!1)}},[r,i,c,e==null?void 0:e.embedding]);return{loading:s,indexData:w,similaritySearchWithScore:h}},Je=Le(({retriverInfo:e,mainEmbeddingInfo:s})=>{var I,P,L;const{t:l}=H("applications"),{loading:i,similaritySearchWithScore:r,indexData:c}=ze(s),[d,h]=n.useState("search"),[w,f]=n.useState(0),o=X(),y=n.useMemo(()=>{var N,j;if(!((N=e==null?void 0:e.vectorDatabaseEntity)!=null&&N.raw))return{headers:[],rows:[]};const _=["content","embedding","metadata"],C=wa((j=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:j.raw);return{headers:_,rows:C.map(R=>{try{return JSON.parse(R)}catch{return[]}})}},[(I=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:I.raw]),p=n.useCallback(async(..._)=>{const[C,N]=_;await c(C,{...N,vectorDatabase:e.vectorDatabaseEntity})},[c,e.vectorDatabaseEntity]),v=n.useCallback(async(_,C)=>{const N=_.trim(),j=await r(N,{k:C,vectorDatabase:e.vectorDatabaseEntity});if(j!=null&&j.length)return j},[e.vectorDatabaseEntity,r]),t=n.useCallback(async _=>{if(_.type.includes("text")||_.type.includes("txt")){const C=new FileReader;C.onload=async N=>{var R;const j=(R=N.target)==null?void 0:R.result;await p({content:j},{vectorDatabase:e.vectorDatabaseEntity})},C.readAsText(_)}else if(_.type.endsWith("pdf")){const C=new Blob([_],{type:"application/pdf"}),N=await new Ba(C,{pdfjs:async()=>{const j=await se(()=>import("./pdf.min-Dd_1aOTd.js").then(async R=>(await R.__tla,R)),__vite__mapDeps([7,2,3,1,4,5,6]));return await se(()=>import("./pdf.worker.min-biMvLEJm.js").then(async R=>(await R.__tla,R)),__vite__mapDeps([8,1,2,3,4,5,6])),j.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),j},parsedItemSeparator:" "}).load();await p({documents:N},{vectorDatabase:e.vectorDatabaseEntity,onProgressReport:j=>{f((j.handled+j.handling)/j.total)}})}},[p,e.vectorDatabaseEntity]),E=n.useMemo(()=>{switch(d){case"search":return a.jsx(Z,{value:"search",children:a.jsx($a,{loading:i,onSimilaritySearch:v})});case"new":return a.jsx(Z,{className:"min-w-80",value:"new",children:a.jsx(Ja,{loading:i,onCreateData:p})});case"file":return a.jsx(Z,{value:"file",children:a.jsx(za,{loading:i,progress:w,onFileSubmit:t,fileOptions:{accept:".pdf,.txt,.text",maxSize:1}})});case"view":return a.jsx(Z,{value:"view",className:"max-h-full overflow-auto",children:a.jsx(Wa,{data:y.rows,headers:y.headers,limitLengthByColumns:{embedding:32}})})}},[p,t,v,i,d,w,y]);return a.jsx(ga,{open:o.visible,onOpenChange:o.hide,children:a.jsxs(ya,{className:"max-w-3xl",children:[a.jsx(xa,{children:a.jsxs("div",{className:"flex",children:[a.jsx(q,{name:"file",className:"mr-2 h-4 w-4"}),a.jsx(_a,{children:l("chat.vector_database")})]})}),a.jsx("div",{className:"mx-auto w-full min-h-96 max-h-full overflow-hidden",children:a.jsx("div",{className:"w-full h-full",children:a.jsxs(Ha,{value:d,onValueChange:h,defaultValue:"search",className:W("w-full h-full mt-4"),children:[a.jsxs(qa,{className:W("grid w-full grid-cols-3",((P=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:P.storage)===Y.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[a.jsx(ee,{value:"search",children:l("chat.search")}),a.jsx(ee,{value:"new",children:l("chat.text")}),a.jsx(ee,{value:"file",children:l("chat.file")}),((L=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:L.storage)===Y.DatabaseNode?a.jsx(ee,{value:"view",children:l("chat.view")}):void 0]}),E]})})})]})})}),$e=e=>{const[s,l]=n.useState([]),i=ke(d=>d.currentSession),r=n.useCallback(async()=>{if(!e||!(i!=null&&i.id))return;const d=await S("FlowEdge").find({where:{session_id:i.id,source:e.id},order:{id:"DESC"}}),{flowNodes:h,flowNodeDatas:w}=await ie({where:{session_id:i.id,id:oe(d.map(f=>f.target)),source_type:"JSONData"},order:{updated_at:"DESC"},select:["id","source_id","source_type","updated_at"]});l(h.reduce((f,o)=>{var p;const y=(p=w[o.source_type])==null?void 0:p.find(v=>v.id===o.source_id);return y&&f.push({node:o,entity:y}),f},[]))},[i==null?void 0:i.id,e]),c=n.useCallback(async d=>{await S("FlowNode").delete(d.id),await S("JSONData").delete(d.source_id);const h=await S("FlowEdge").find({where:[{source:d.id},{target:d.id}]});await Promise.all(h.map(w=>S("FlowEdge").delete(w.id))),r()},[r]);return n.useEffect(()=>{e&&r()},[r,e]),{chatList:s,deleteChat:c,getChatList:r}};function He({schema:e,mainLLMInfo:s,mainEmbeddingInfo:l,loadLLM:i,retriverInfo:r,threadNode:c,onSelectThread:d,onAddNewThread:h,currentDataNode:w,setLLMInfo:f,changeLLMOptions:o,...y}){var $,B;const{t:p}=H("applications"),[v,t]=n.useState(!1),E=X(Be),I=X(Je),{chatList:P,getChatList:L,deleteChat:_}=$e(c),C=n.useCallback(async()=>{try{t(!0),await(h==null?void 0:h()),L()}finally{t(!1)}},[L,h]),N=n.useCallback(()=>{I.show({retriverInfo:r[0],mainEmbeddingInfo:l})},[l,r,I]),j=n.useCallback(async(m,u)=>{m.stopPropagation(),E.show({onDelete:()=>_(u)})},[_,E]),R=n.useCallback(async m=>{s!=null&&s.llm&&(await o(s==null?void 0:s.llm,m),f(u=>u?{...u,llm:{...u.llm,options:m}}:void 0))},[o,s==null?void 0:s.llm,f]),U=n.useMemo(()=>{var m;return a.jsx(Fe,{className:W("overflow-hidden break-words whitespace-pre-wrap w-full rounded-lg"),source:(m=e==null?void 0:e.schema_items)!=null&&m.length?`\`\`\`javascript
${at((e==null?void 0:e.schema_items)||[])}
\`\`\``:""})},[e==null?void 0:e.schema_items]);return a.jsxs(va,{variant:"sidebar",side:"right",collapsible:"none",...y,children:[a.jsx("div",{className:"h-1"}),a.jsxs(ba,{className:"justify-between",children:[a.jsx("div",{className:"text-sm pl-2",children:p("chat.history")}),a.jsx(Na,{loading:v,onClick:C,variant:"link",className:"mr-[-6px]",children:a.jsx(q,{name:"circle-plus"})})]}),a.jsxs(ja,{children:[a.jsx(Ca,{className:"flex-1",children:a.jsx(Da,{children:P.map(({node:m},u)=>{var g;return a.jsx(La,{onClick:()=>d(m),children:a.jsx(Sa,{className:"cursor-pointer",children:a.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx(q,{size:16,name:((g=w==null?void 0:w.node)==null?void 0:g.id)===m.id?"check":"chevron-right",className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"}),a.jsx("span",{children:`Thread ${u+1}`})]}),a.jsx(q,{onClick:M=>j(M,m),size:16,name:"trash-2"})]})})},m.id)})})}),r!=null&&r.length?a.jsxs(Oe,{className:"m-2 p-2 max-w-full",children:[a.jsx("pre",{className:"overflow-auto",children:r.map((m,u)=>{var g;return a.jsx("span",{children:((g=m.promptEntity)==null?void 0:g.content)||""},`${u}`)})}),a.jsx(re,{onClick:N,className:"w-full mt-4",children:p("chat.vector_database")})]}):void 0,($=e==null?void 0:e.schema_items)!=null&&$.length?a.jsx("div",{className:"m-2 !mb-0",children:a.jsx(n.Suspense,{fallback:a.jsx(Q,{}),children:U})}):void 0,a.jsx(Ua,{options:(B=s==null?void 0:s.llm)==null?void 0:B.options,onChangeOptions:R,className:"p-2"}),a.jsx(We,{llm:s==null?void 0:s.llm,status:s==null?void 0:s.status,progress:s==null?void 0:s.progress,loadLLM:i})]})]})}var ae="Avatar",[qe,rt]=ea(ae),[Ue,de]=qe(ae),ce=n.forwardRef((e,s)=>{const{__scopeAvatar:l,...i}=e,[r,c]=n.useState("idle");return a.jsx(Ue,{scope:l,imageLoadingStatus:r,onImageLoadingStatusChange:c,children:a.jsx(ne.span,{...i,ref:s})})});ce.displayName=ae;var me="AvatarImage",ue=n.forwardRef((e,s)=>{const{__scopeAvatar:l,src:i,onLoadingStatusChange:r=()=>{},...c}=e,d=de(me,l),h=Ge(i,c.referrerPolicy),w=aa(f=>{r(f),d.onImageLoadingStatusChange(f)});return Ee(()=>{h!=="idle"&&w(h)},[h,w]),h==="loaded"?a.jsx(ne.img,{...c,ref:s,src:i}):null});ue.displayName=me;var he="AvatarFallback",fe=n.forwardRef((e,s)=>{const{__scopeAvatar:l,delayMs:i,...r}=e,c=de(he,l),[d,h]=n.useState(i===void 0);return n.useEffect(()=>{if(i!==void 0){const w=window.setTimeout(()=>h(!0),i);return()=>window.clearTimeout(w)}},[i]),d&&c.imageLoadingStatus!=="loaded"?a.jsx(ne.span,{...r,ref:s}):null});fe.displayName=he;function Ge(e,s){const[l,i]=n.useState("idle");return Ee(()=>{if(!e){i("error");return}let r=!0;const c=new window.Image,d=h=>()=>{r&&i(h)};return i("loading"),c.onload=d("loaded"),c.onerror=d("error"),c.src=e,s&&(c.referrerPolicy=s),()=>{r=!1}},[e,s]),l}var pe=ce,we=ue,ge=fe;const ye=n.forwardRef(({className:e,...s},l)=>a.jsx(pe,{ref:l,className:W("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...s}));ye.displayName=pe.displayName;const xe=n.forwardRef(({className:e,...s},l)=>a.jsx(we,{ref:l,className:W("aspect-square h-full w-full",e),...s}));xe.displayName=we.displayName;const _e=n.forwardRef(({className:e,...s},l)=>a.jsx(ge,{ref:l,className:W("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...s}));_e.displayName=ge.displayName;const Ke=Me("flex gap-2 max-w-[60%] items-end relative group",{variants:{variant:{received:"self-start",sent:"self-end flex-row-reverse"},layout:{default:"",ai:"max-w-full w-full items-center"}},defaultVariants:{variant:"received",layout:"default"}}),ve=n.forwardRef(({className:e,variant:s,layout:l,children:i,...r},c)=>a.jsx("div",{className:W(Ke({variant:s,layout:l,className:e}),"relative group"),ref:c,...r,children:n.Children.map(i,d=>n.isValidElement(d)&&typeof d.type!="string"?n.cloneElement(d,{variant:s,layout:l,className:r==null?void 0:r.innerclassname}):d)}));ve.displayName="ChatBubble";const Qe=({src:e,fallback:s,className:l})=>a.jsxs(ye,{className:l,children:[a.jsx(xe,{src:e,alt:"Avatar"}),a.jsx(_e,{children:s})]}),Xe=Me("p-4",{variants:{variant:{received:"bg-secondary text-secondary-foreground rounded-r-lg rounded-tl-lg",sent:"border border-border rounded-l-lg rounded-tr-lg"},layout:{default:"",ai:"border-t w-full rounded-none bg-transparent"}},defaultVariants:{variant:"received",layout:"default"}}),be=n.forwardRef(({className:e,variant:s,layout:l,isLoading:i=!1,children:r,...c},d)=>a.jsx("div",{className:W(Xe({variant:s,layout:l,className:e}),"break-words max-w-full whitespace-pre-wrap"),ref:d,...c,children:i?a.jsx("div",{className:"flex items-center space-x-2",children:a.jsx(Q,{})}):r}));be.displayName="ChatBubbleMessage";const Ye=({icon:e,onClick:s,className:l,variant:i="ghost",size:r="icon",...c})=>a.jsx(re,{variant:i,size:r,className:l,onClick:s,...c,children:e}),Ze=n.forwardRef(({variant:e,className:s,children:l,...i},r)=>a.jsx("div",{ref:r,className:W("absolute top-1/2 -translate-y-1/2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200",e==="sent"?"-left-1 -translate-x-full flex-row-reverse":"-right-1 translate-x-full",s),...i,children:l}));Ze.displayName="ChatBubbleActionWrapper";let Ne,je,Ce;Ne=[{icon:"copy",label:"Copy"},{icon:"refresh-ccw",label:"Refresh"},{icon:"volume-2",label:"Volume"}],je=n.memo(({message:e,index:s,isLastMessage:l,isGenerating:i,isSchema:r,onActionClick:c})=>{const d=n.useMemo(()=>a.jsx(Fe,{style:{color:"unset !important"},source:e.content?r?`\`\`\`json
${e.content}
\`\`\``:e.content:""}),[r,e.content]);return a.jsxs(ve,{innerclassname:e.role=="system"?"!bg-transparent font-semibold":void 0,variant:e.role=="user"?"sent":"received",children:[e.role==="system"?a.jsx("div",{className:"w-10 h-10"}):e.role==="assistant"?a.jsx(Qe,{src:"",fallback:e.data&&typeof e.data=="object"&&"injectedMessage"in e.data?"\u{1F4C2}":"\u{1F916}"}):void 0,a.jsxs(be,{children:[i&&l&&(!e.content||r)?a.jsx(Q,{}):a.jsxs(n.Suspense,{fallback:a.jsx(Q,{}),children:[e.role==="system"?a.jsx(Ga,{className:"!text-sm mb-1",children:"System"}):void 0,d]}),e.role==="assistant"&&l&&a.jsx("div",{className:"flex items-center mt-1.5 gap-1",children:!i&&a.jsx(a.Fragment,{children:Ne.map((h,w)=>a.jsx(Ye,{variant:"ghost",className:"size-5",icon:a.jsx(q,{name:h.icon,className:"size-3"}),onClick:()=>c(h.label,e)},w))})})]})]},s)},()=>!1),Ce=()=>({changeLLMOptions:n.useCallback(async(e,s)=>{e&&await S("LLM").update(e.id,{options:s})},[])}),Ae=n.memo(()=>{const{t:e}=H("applications"),s=n.useRef(!1),[l,i]=n.useState(!1),r=n.useCallback(()=>{setTimeout(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},50)},[]),c=Pe(),{schema:d,threadInfo:h,mainLLMInfo:w,retriverInfo:f,currentDataNode:o,loadLLM:y,setLLMInfo:p,addNewDataNode:v,selectDataNode:t,updateMessagesData:E,onThreadMessagesLoaded:I}=c,{changeLLMOptions:P}=Ce(),{sendMessage:L}=Ve(c),{input:_,messages:C,isLoading:N,reload:j,setInput:R,handleSubmit:U,handleInputChange:$,setMessages:B}=Ia({fetch:async(D,x)=>{try{i(!0);const F=JSON.parse(x==null?void 0:x.body),k=K(),J=F.messages[F.messages.length-1];return s.current=!0,B(T=>[...T,{id:K(),content:J.content,role:"user"}]),await L(J.content,F.messages||[],{retriverInfo:f},{schema:d,onInjectedMessages:T=>{T.length&&B(A=>[...A,...T.map(V=>V._getType()==="system"?{id:K(),content:`${V.content}`,role:"system",data:{injectedMessage:!0}}:V._getType()==="human"?{id:K(),content:`${V.content}`,role:"user",data:{injectedMessage:!0}}:{id:K(),content:`${V.content}`,role:"assistant",data:{injectedMessage:!0}})])},onResponseMessageCreate:T=>{B(A=>[...A,{id:k,content:T||"",role:"assistant"}])},onMessageUpdate:T=>{B(A=>{const V=[...A],b=V.findIndex(G=>G.id===k);return b!==-1&&(V[b]={...V[b],content:T.nodeData.content||""}),V}),s.current&&r()}}),B(T=>(E(T),T)),i(!1),R(""),s.current&&r(),new Response}finally{i(!1)}}}),m=n.useRef(null);n.useEffect(()=>{const D=I(x=>{B(x||[]),r()});return()=>{D()}},[B,I,r]);const u=async(D,x)=>(i(!0),await U(x),!0),g=n.useCallback(async(D,x)=>{if(D==="Refresh"){i(!0);try{await j()}finally{i(!1)}}D==="Copy"&&x&&x.role==="assistant"&&navigator.clipboard.writeText(x.content),D==="Volume"&&(x!=null&&x.content)&&await ta.speak((x==null?void 0:x.content)||"")},[j]),M=n.useCallback(()=>s.current=!1,[]),O=n.useMemo(()=>C&&C.map((D,x)=>a.jsx(je,{message:D,index:x,isLastMessage:x===C.length-1,isGenerating:l,isSchema:!!d,onActionClick:g},D.id||`${x}`)),[C,l,d,g]);return a.jsxs(Ea,{onClick:M,className:"max-h-full !overflow-hidden !min-h-full",style:{minHeight:"unset"},defaultOpen:!0,children:[a.jsx(Ma,{className:"!max-h-full !overflow-hidden",style:{minHeight:"unset"},children:a.jsxs("main",{className:"flex h-full w-full max-w-2xl flex-col items-center mx-auto overflow-hidden",children:[a.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden min-w-full max-w-full",children:a.jsx(le,{className:"!max-h-full",ref:m,children:O})}),a.jsx(Oa,{className:"!max-w-2xl px-4",onSubmit:u,disabled:N||l||(w==null?void 0:w.status)!==z.Loaded,placeholder:e("chat.input_message_placeholder"),value:_,onChange:$})]})}),a.jsx(He,{schema:d,currentDataNode:o,threadNode:h==null?void 0:h.threadNode,loadLLM:y,mainLLMInfo:w,mainEmbeddingInfo:c.mainEmbeddingInfo,retriverInfo:f,onAddNewThread:v,onSelectThread:t,changeLLMOptions:P,setLLMInfo:p})]})})});export{nt as __tla,Ae as default};
