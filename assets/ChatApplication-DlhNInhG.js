const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Bwf_PJv9.js","assets/LLMIcon-Bjn_z1Gm.js","assets/index-RiB-44Db.js","assets/index-Vcso_2OS.css","assets/routes-lkvfg71l.js","assets/dot-C2v_uavk.js","assets/createLucideIcon-BEhd4ns2.js","assets/pdf.min-D4jC9lwf.js","assets/pdf.worker.min-aWEOw8WF.js"])))=>i.map(i=>d[i]);
import{r as n,j as a,c as J,v as Se,e as q,w as X,f as Ee,_ as se,L as H,a as aa,P as ne,x as ta,y as Me,l as ke,z as sa,__tla as na}from"./index-RiB-44Db.js";import{u as Ie,g as D,F as ra,A as Re,S as ia,H as oa,B as re,V as Y,o as la,q as da,r as ca,s as ma,t as ua,v as ha,w as pa,x as fa,L as wa,y as _a,z as ga,E as xa,G as ya,J as va,K as ba,M as Na,N as K,__tla as ja}from"./routes-lkvfg71l.js";import{u as Ca,__tla as La}from"./index-D-Bs0KoB.js";import{A as Da,__tla as Sa}from"./popover-BAFmrVzo.js";import{f as ie,F as Ea,e as oe,P as Ma,C as Oe,L as ka,a as Ia,W as Ra,T as Z,D as Oa,I as Fa,b as Ta,V as Aa,d as Pa,g as Va,h as ee,M as Fe,i as Ba,j as Ja,__tla as za}from"./chunk-C7yk9hgX.js";import{a as Wa,b as $a,I as le,p as qa,L as z,S as Ha,u as Te,l as Ua,c as Ae,d as Ga,__tla as Ka}from"./LLMIcon-Bjn_z1Gm.js";import{A as Qa,a as Xa,b as Ya,c as Za,d as et,e as at,f as tt,g as st,__tla as nt}from"./alert-dialog-CfOmAZPR.js";import"./toNumber-Byg5v6VR.js";import{__tla as rt}from"./index-Dlu-JPPf.js";import"./dot-C2v_uavk.js";import"./createLucideIcon-BEhd4ns2.js";import{__tla as it}from"./index-DV-zg8VY.js";let Pe,ot=Promise.all([(()=>{try{return na}catch{}})(),(()=>{try{return ja}catch{}})(),(()=>{try{return La}catch{}})(),(()=>{try{return Sa}catch{}})(),(()=>{try{return za}catch{}})(),(()=>{try{return Ka}catch{}})(),(()=>{try{return nt}catch{}})(),(()=>{try{return rt}catch{}})(),(()=>{try{return it}catch{}})()]).then(async()=>{const de=n.forwardRef(({className:e,children:s,...o},i)=>a.jsx("div",{className:J("flex flex-col w-full h-full p-4 gap-6 overflow-y-auto",e),ref:i,...o,children:s}));de.displayName="ChatMessageList";const Ve=()=>{var $,B;const[e,s]=n.useState(),[o,i]=n.useState(),[r,d]=n.useState(),[l,h]=n.useState(),[p,c]=n.useState([]),[u,x]=n.useState(),_=n.useRef(),y=n.useRef({}),t=Ie(m=>m.currentSession),{loadModel:E}=Wa(),{modalRef:R}=$a(Ha),S=n.useCallback(async m=>{var w;if(!t)return;const f=await D("JSONData").findOne({where:{id:m.source_id,session_id:t==null?void 0:t.id}});f&&((w=_.current)==null||w.call(_,f.data?f.data:[]),x({node:m,enity:f}))},[t]),N=n.useCallback(async m=>{var T;const f=(m==null?void 0:m.sessionId)||(t==null?void 0:t.id),w=(m==null?void 0:m.threadNode)||(r==null?void 0:r.threadNode),M=(m==null?void 0:m.prompts)||(e==null?void 0:e.prompts);if(!f||!(w!=null&&w.id))return;const F=M==null?void 0:M.map(k=>{if(k.type!=="few_shot_example")switch(k.role){case"ai":case"assistant":case"tool":return{id:k.id,content:k.content,role:"assistant"};case"system":return{id:k.id,content:k.content,role:"system"};default:return{id:k.id,content:k.content,role:"user"}}}).filter(Boolean),C=await D("JSONData").save({headers:"item",session_id:f,json:"",data:F});if(!C)return;const g=await D("FlowNode").save({session_id:f,source_id:C.id,source_type:"JSONData",node_type:"JSON_DATA",x:0,y:0});if(g)return await D("FlowEdge").save({session_id:f,source:w.id,target:g.id}),(T=_.current)==null||T.call(_,F),x({node:g,enity:C}),{jsonData:C,jsonDataNode:g}},[e==null?void 0:e.prompts,t==null?void 0:t.id,r==null?void 0:r.threadNode]),L=n.useCallback(async(m,f)=>{if(!t)return;const w=await D("FlowEdge").findOne({where:{session_id:t.id,source:m.id},order:{id:"DESC"}});if(w){const M=await D("FlowNode").findOne({where:{id:w.target,session_id:t.id}});if(!M)return;await S(M)}else if(!await N({sessionId:t.id,threadNode:m,prompts:f||[]}))return},[N,t,S]),v=n.useCallback(async m=>{if(m!=null&&m.length&&(t!=null&&t.id)){const f=(await Promise.all(m.map(async w=>D("FlowEdge").find({where:{target:w.source.id}}).then(M=>ie({where:{session_id:t.id,id:le(M.map(F=>F.source))}}).then(F=>({...F,...w})))))).map(w=>{var T,k,W,A;const M=w.flowNodes.find(P=>P.source_type==="Prompt"),F=w.flowNodes.find(P=>P.source_type==="VectorDatabase");if(!F||!M)return;const C=(k=(T=w.flowNodeDatas)==null?void 0:T.Prompt)==null?void 0:k.find(P=>P.id===M.source_id),g=(A=(W=w.flowNodeDatas)==null?void 0:W.VectorDatabase)==null?void 0:A.find(P=>P.id===F.source_id);return{promptNode:M,vectorDatabaseNode:F,placeholderNode:w.source,placeholderEntity:w.entity,promptEntity:C,vectorDatabaseEntity:g}}).filter(Boolean);c(f)}},[t==null?void 0:t.id]),I=n.useCallback(async()=>{try{if(y.current.handling=t==null?void 0:t.id,!(t!=null&&t.id)||!(t!=null&&t.main_source_id)||(t==null?void 0:t.main_source_type)!=="Thread")return;const[m,f]=await Promise.all([D("Thread").findOne({where:{id:t.main_source_id,session_id:t.id}}),D("FlowNode").findOne({where:{id:t.main_node_id}})]);if(!m||!f)return;const w=await D("FlowEdge").find({where:{session_id:t.id,target:f.id}}),{flowNodes:M,flowNodeDatas:F}=await ie({where:{session_id:t.id,id:le(w.map(b=>b.source))}}),C=(await D("FlowEdge").find({where:{session_id:t.id}})).filter(b=>b.target===f.id).map(b=>{var De;const G=M.find(te=>te.id===b.source);return{connection:b,source:G,entity:(De=F==null?void 0:F[G.source_type])==null?void 0:De.find(te=>te.id===G.source_id)}}),g=C.find(b=>b.source.source_type==="LLM"),T=C.filter(b=>b.source.source_type==="Prompt"),k=C.find(b=>b.source.source_type==="Schema"),W=g==null?void 0:g.entity;if(!W)return;t.passphrase&&await qa(t.passphrase,R.current);const A=C.filter(b=>b.source.source_type==="FlowNodePlaceholder");await v(A),await L(f,(T==null?void 0:T.map(b=>b.entity))||[]);const P=await D("FlowNode").findOne({where:{node_type:ra.DefaultEmbeddingModel,source_type:"FlowNodePlaceholder"}});if(P){const b=await D("FlowNodePlaceholder").findOne({where:{id:P.source_id}});i({embedding:b})}h({llm:W,status:W.status||z.Started,progress:""}),d({thread:m,threadNode:f});const V=k==null?void 0:k.entity;if(V){const b=await D("SchemaItem").find({where:{schema_id:V.id}});V.schema_items=b||[]}s({prompts:(T==null?void 0:T.map(b=>b.entity))||[],schema:V}),y.current.handled=t.id}finally{y.current.handling=void 0}},[t==null?void 0:t.id,t==null?void 0:t.main_node_id,t==null?void 0:t.main_source_id,t==null?void 0:t.main_source_type,t==null?void 0:t.passphrase,v,L,R]),j=n.useCallback(async()=>{var m;if((m=l==null?void 0:l.llm)!=null&&m.name)try{h(f=>f&&{...f,status:z.Loading}),await E(l.llm.provider,l==null?void 0:l.llm.name,{provider:l.llm.provider,callback:f=>{h(w=>w&&{...w,progress:f.text})}}),h(f=>f&&{...f,status:z.Loaded,progress:""})}catch{h(f=>f&&{...f,status:z.Started,progress:""})}},[($=l==null?void 0:l.llm)==null?void 0:$.name,(B=l==null?void 0:l.llm)==null?void 0:B.provider,E]),O=n.useCallback(m=>(_.current=m,()=>{_.current=void 0}),[]),U=n.useCallback(async m=>{!(u!=null&&u.node)||!(u!=null&&u.enity)||await D("JSONData").save({...u.enity,data:m})},[u==null?void 0:u.enity,u==null?void 0:u.node]);return n.useEffect(()=>{y.current.handling||(y==null?void 0:y.current.handled)===(t==null?void 0:t.id)||I()},[t==null?void 0:t.id,I]),{...e,loadLLM:j,threadInfo:r,mainLLMInfo:l,mainEmbeddingInfo:o,retriverInfo:p,currentDataNode:u,updateMessagesData:U,addNewDataNode:N,selectDataNode:S,setLLMInfo:h,onThreadMessagesLoaded:O}},Be=e=>{var d;const[s]=n.useState(!1),{confirmPassphrase:o}=Te(),i=n.useCallback(async(l,h)=>{if(!(h!=null&&h.length))return[];const p=[];return await Promise.all(h.map(async c=>{var x,_,y,t,E;const u=c.placeholderEntity;if(u)switch(u.placeholder_type){case Ea.VECTOR_DATABASE_RETREIVER:{if(!c.promptNode||!c.promptEntity||!c.vectorDatabaseNode||!c.vectorDatabaseEntity)return;const R=(x=u.metadata)!=null&&x.k?+((_=u.metadata)==null?void 0:_.k):1;let S=(y=u.metadata)!=null&&y.minimalScore?+((t=u.metadata)==null?void 0:t.minimalScore):void 0;S&&S>1&&(S=S/100),await o();const N=await oe.similaritySearchWithScore((E=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:E.embedding,{database:{databaseId:c.vectorDatabaseEntity.id}},l,R);if(!N)return[];const L=new Ma({template:c.promptEntity.content,inputVariables:["context"]});p.push(new Re(await L.format({context:S?N.filter(([,v])=>v>=S).map(([v])=>v.pageContent).join(`
`):N.map(([v])=>v.pageContent).join(`
`)})))}}})),p},[(d=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:d.embedding,o]),r=n.useCallback(async(l,h,{retriverInfo:p},{schema:c,onMessageUpdate:u,onResponseMessageCreate:x,onInjectedMessages:_})=>{var R,S;if(!((R=e.mainLLMInfo)!=null&&R.llm)||((S=e.mainLLMInfo)==null?void 0:S.status)!==z.Loaded)throw new Error("LLM not found");const y=[];p!=null&&p.length&&(y.push(...await i(l,p)),_==null||_(y));const t=h.map(N=>N.role==="system"?new ia(N.content):N.role==="user"?new oa(N.content):new Re(N.content));x==null||x(),await o();const E=await Ua.stream(e.mainLLMInfo.llm.provider,[...y,...t],{schemas:c?[c]:void 0,llm:e.mainLLMInfo.llm,onMessageUpdate:({content:N})=>{u==null||u({nodeData:{loading:!0,content:N}})}});return u==null||u({nodeData:{content:E==null?void 0:E.content}}),E==null?void 0:E.content},[i,o,e.mainLLMInfo]);return{loading:s,sendMessage:r}},Je=Se(({onDelete:e})=>{const{t:s}=q("dialogs"),[o,i]=n.useState(!1),r=X(),{toast:d}=Ee(),l=async()=>{try{i(!0),await e(),r.hide()}catch{d({variant:"destructive",description:s("delete_chat_data_node.errors.delete_failed")})}finally{i(!1)}};return a.jsx(Qa,{open:r.visible,onOpenChange:r.hide,children:a.jsxs(Xa,{children:[a.jsxs(Ya,{children:[a.jsx(Za,{children:s("delete_chat_data_node.title")}),a.jsx(et,{children:s("delete_chat_data_node.description")})]}),a.jsxs(at,{children:[a.jsx(tt,{onClick:r.hide,children:s("delete_chat_data_node.cancel")}),a.jsx(st,{disabled:o,onClick:l,children:s("delete_chat_data_node.delete")})]})]})})});function Q(){return a.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",className:"text-foreground",children:[a.jsx("circle",{cx:"4",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_qFRN",begin:"0;spinner_OcgL.end+0.25s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{begin:"spinner_qFRN.begin+0.1s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"20",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_OcgL",begin:"spinner_qFRN.begin+0.2s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})})]})}const ze=n.memo(({llm:e,status:s,loadLLM:o,progress:i})=>{const{t:r}=q("flows"),[d,l]=n.useState();n.useEffect(()=>{if(!(d||!(e!=null&&e.name))){if((e==null?void 0:e.provider)!=="WebLLM"){l({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:e==null?void 0:e.name,model:e==null?void 0:e.name,model_lib:e==null?void 0:e.provider,model_type:2}});return}se(()=>import("./index-Bwf_PJv9.js").then(async c=>(await c.__tla,c)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:c,functionCallingModelIds:u,prebuiltAppConfig:x})=>{const _=await c(e==null?void 0:e.name);l({hasCache:_,isFunctionCalling:u.includes(e==null?void 0:e.name),info:x.model_list.find(y=>y.model_id===(e==null?void 0:e.name))})})}},[e==null?void 0:e.name,d]);const h=n.useCallback(async()=>{await(o==null?void 0:o())},[o]),p=n.useMemo(()=>{switch(s){case z.Downloading:return a.jsx(H,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case z.Loaded:return a.jsx(Ae,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"});default:return a.jsx(Ae,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"})}},[e==null?void 0:e.name,s]);return a.jsx(Oe,{className:"flex justify-center !bg-inherit !p-2 max-w-full overflow-y-hidden !mb-2 m-2 !mt-0",children:a.jsxs("div",{className:"ml-2 pt-1 max-w-full",children:[a.jsxs("p",{className:"flex gap-2 items-center pr-6 !text-sm font-semibold",children:[p,`${(e==null?void 0:e.name)||""}`]}),a.jsxs("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:[a.jsx(ka,{model:d==null?void 0:d.info,isFunctionCalling:(d==null?void 0:d.isFunctionCalling)||!1,name:e==null?void 0:e.name,isCached:(d==null?void 0:d.hasCache)||!1,cloud:(d==null?void 0:d.cloud)||!1}),s!==z.Loaded?i?a.jsx("div",{className:"text-sm break-words flex-wrap",children:i}):a.jsx(re,{disabled:s===z.Loading,onClick:h,className:"mt-4 w-full",children:r(d!=null&&d.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")}):void 0]})]})})}),We=e=>{const[s,o]=n.useState(!1),{t:i}=q("flows"),{toast:r}=Ee(),{confirmPassphrase:d}=Te(),l=n.useCallback(async(p,c)=>{try{if(!(c!=null&&c.vectorDatabase)){r({variant:"destructive",title:i("vector_database_node.errors.vector_database_not_found")});return}if((c==null?void 0:c.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for similarity search");return o(!0),await d(),await oe.similaritySearchWithScore(e==null?void 0:e.embedding,{database:{databaseId:c.vectorDatabase.id}},p,c==null?void 0:c.k)}catch{r({variant:"destructive",title:i("vector_database_node.errors.similarity_search_failed")})}finally{o(!1)}},[r,i,e==null?void 0:e.embedding,d]),h=n.useCallback(async(p,c)=>{var u;try{o(!0);const x=p.content?[new la({pageContent:p.content,id:p.id,metadata:{id:p.id}})]:p.documents;if(!(x!=null&&x.length)){r({variant:"destructive",title:i("vector_database_node.errors.content_not_found")});return}if(!(c!=null&&c.vectorDatabase)){r({variant:"destructive",title:i("vector_database_node.errors.vector_database_not_found")});return}if((c==null?void 0:c.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for indexing");{const _=Ia(x,10);let y=0;for(const t of _)(u=c==null?void 0:c.onProgressReport)==null||u.call(c,{handling:t.length,handled:y,total:x.length}),await d(),await oe.index(e==null?void 0:e.embedding,{database:{databaseId:c.vectorDatabase.id}},t),y+=t.length}}catch{r({variant:"destructive",title:i("vector_database_node.errors.similarity_search_failed")})}finally{o(!1)}},[r,i,e==null?void 0:e.embedding,d]);return{loading:s,indexData:h,similaritySearchWithScore:l}},$e=Se(({retriverInfo:e,mainEmbeddingInfo:s})=>{var R,S,N;const{t:o}=q("applications"),{loading:i,similaritySearchWithScore:r,indexData:d}=We(s),[l,h]=n.useState("search"),[p,c]=n.useState(0),u=X(),x=n.useMemo(()=>{var I,j;if(!((I=e==null?void 0:e.vectorDatabaseEntity)!=null&&I.raw))return{headers:[],rows:[]};const L=["content","embedding","metadata"],v=da((j=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:j.raw);return{headers:L,rows:v.map(O=>{try{return JSON.parse(O)}catch{return[]}})}},[(R=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:R.raw]),_=n.useCallback(async(...L)=>{const[v,I]=L;await d(v,{...I,vectorDatabase:e.vectorDatabaseEntity})},[d,e.vectorDatabaseEntity]),y=n.useCallback(async(L,v)=>{const I=L.trim(),j=await r(I,{k:v,vectorDatabase:e.vectorDatabaseEntity});if(j!=null&&j.length)return j},[e.vectorDatabaseEntity,r]),t=n.useCallback(async L=>{if(L.type.includes("text")||L.type.includes("txt")){const v=new FileReader;v.onload=async I=>{var O;const j=(O=I.target)==null?void 0:O.result;await _({content:j},{vectorDatabase:e.vectorDatabaseEntity})},v.readAsText(L)}else if(L.type.endsWith("pdf")){const v=new Blob([L],{type:"application/pdf"}),I=await new Ra(v,{pdfjs:async()=>{const j=await se(()=>import("./pdf.min-D4jC9lwf.js").then(async O=>(await O.__tla,O)),__vite__mapDeps([7,2,3,1,4,5,6]));return await se(()=>import("./pdf.worker.min-aWEOw8WF.js").then(async O=>(await O.__tla,O)),__vite__mapDeps([8,1,2,3,4,5,6])),j.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),j},parsedItemSeparator:" "}).load();await _({documents:I},{vectorDatabase:e.vectorDatabaseEntity,onProgressReport:j=>{c((j.handled+j.handling)/j.total)}})}},[_,e.vectorDatabaseEntity]),E=n.useMemo(()=>{switch(l){case"search":return a.jsx(Z,{value:"search",children:a.jsx(Aa,{loading:i,onSimilaritySearch:y})});case"new":return a.jsx(Z,{className:"min-w-80",value:"new",children:a.jsx(Ta,{loading:i,onCreateData:_})});case"file":return a.jsx(Z,{value:"file",children:a.jsx(Fa,{loading:i,progress:p,onFileSubmit:t,fileOptions:{accept:".pdf,.txt,.text",maxSize:1}})});case"view":return a.jsx(Z,{value:"view",className:"max-h-full overflow-auto",children:a.jsx(Oa,{data:x.rows,headers:x.headers,limitLengthByColumns:{embedding:32}})})}},[_,t,y,i,l,p,x]);return a.jsx(ca,{open:u.visible,onOpenChange:u.hide,children:a.jsxs(ma,{className:"max-w-3xl",children:[a.jsx(ua,{children:a.jsxs("div",{className:"flex",children:[a.jsx(H,{name:"file",className:"mr-2 h-4 w-4"}),a.jsx(ha,{children:o("chat.vector_database")})]})}),a.jsx("div",{className:"mx-auto w-full min-h-96 max-h-full overflow-hidden",children:a.jsx("div",{className:"w-full h-full",children:a.jsxs(Pa,{value:l,onValueChange:h,defaultValue:"search",className:J("w-full h-full mt-4"),children:[a.jsxs(Va,{className:J("grid w-full grid-cols-3",((S=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:S.storage)===Y.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[a.jsx(ee,{value:"search",children:o("chat.search")}),a.jsx(ee,{value:"new",children:o("chat.text")}),a.jsx(ee,{value:"file",children:o("chat.file")}),((N=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:N.storage)===Y.DatabaseNode?a.jsx(ee,{value:"view",children:o("chat.view")}):void 0]}),E]})})})]})})}),qe=e=>{const[s,o]=n.useState([]),i=Ie(l=>l.currentSession),r=n.useCallback(async()=>{if(!e||!(i!=null&&i.id))return;const l=await D("FlowEdge").find({where:{session_id:i.id,source:e.id},order:{id:"DESC"}}),{flowNodes:h,flowNodeDatas:p}=await ie({where:{session_id:i.id,id:le(l.map(c=>c.target)),source_type:"JSONData"},order:{updated_at:"DESC"},select:["id","source_id","source_type","updated_at"]});o(h.reduce((c,u)=>{var _;const x=(_=p[u.source_type])==null?void 0:_.find(y=>y.id===u.source_id);return x&&c.push({node:u,entity:x}),c},[]))},[i==null?void 0:i.id,e]),d=n.useCallback(async l=>{await D("FlowNode").delete(l.id),await D("JSONData").delete(l.source_id);const h=await D("FlowEdge").find({where:[{source:l.id},{target:l.id}]});await Promise.all(h.map(p=>D("FlowEdge").delete(p.id))),r()},[r]);return n.useEffect(()=>{e&&r()},[r,e]),{chatList:s,deleteChat:d,getChatList:r}};function He({schema:e,mainLLMInfo:s,mainEmbeddingInfo:o,loadLLM:i,retriverInfo:r,threadNode:d,onSelectThread:l,onAddNewThread:h,currentDataNode:p,setLLMInfo:c,changeLLMOptions:u,...x}){var $,B;const{t:_}=q("applications"),[y,t]=n.useState(!1),E=X(Je),R=X($e),{chatList:S,getChatList:N,deleteChat:L}=qe(d),v=n.useCallback(async()=>{try{t(!0),await(h==null?void 0:h()),N()}finally{t(!1)}},[N,h]),I=n.useCallback(()=>{R.show({retriverInfo:r[0],mainEmbeddingInfo:o})},[o,r,R]),j=n.useCallback(async(m,f)=>{m.stopPropagation(),E.show({onDelete:()=>L(f)})},[L,E]),O=n.useCallback(async m=>{s!=null&&s.llm&&(await u(s==null?void 0:s.llm,m),c(f=>f?{...f,llm:{...f.llm,options:m}}:void 0))},[u,s==null?void 0:s.llm,c]),U=n.useMemo(()=>{var m;return a.jsx(Fe,{className:J("overflow-hidden break-words whitespace-pre-wrap w-full rounded-lg"),source:(m=e==null?void 0:e.schema_items)!=null&&m.length?`\`\`\`javascript
${Ga((e==null?void 0:e.schema_items)||[])}
\`\`\``:""})},[e==null?void 0:e.schema_items]);return a.jsxs(pa,{variant:"sidebar",side:"right",collapsible:"none",...x,children:[a.jsx("div",{className:"h-1"}),a.jsxs(fa,{className:"justify-between",children:[a.jsx("div",{className:"text-sm pl-2",children:_("chat.history")}),a.jsx(wa,{loading:y,onClick:v,variant:"link",className:"mr-[-6px]",children:a.jsx(H,{name:"circle-plus"})})]}),a.jsxs(_a,{children:[a.jsx(ga,{className:"flex-1",children:a.jsx(xa,{children:S.map(({node:m},f)=>{var w;return a.jsx(ya,{onClick:()=>l(m),children:a.jsx(va,{className:"cursor-pointer",children:a.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx(H,{size:16,name:((w=p==null?void 0:p.node)==null?void 0:w.id)===m.id?"check":"chevron-right",className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"}),a.jsx("span",{children:`Thread ${f+1}`})]}),a.jsx(H,{onClick:M=>j(M,m),size:16,name:"trash-2"})]})})},m.id)})})}),r!=null&&r.length?a.jsxs(Oe,{className:"m-2 p-2 max-w-full",children:[a.jsx("pre",{className:"overflow-auto",children:r.map((m,f)=>{var w;return a.jsx("span",{children:((w=m.promptEntity)==null?void 0:w.content)||""},`${f}`)})}),a.jsx(re,{onClick:I,className:"w-full mt-4",children:_("chat.vector_database")})]}):void 0,($=e==null?void 0:e.schema_items)!=null&&$.length?a.jsx("div",{className:"m-2 !mb-0",children:a.jsx(n.Suspense,{fallback:a.jsx(Q,{}),children:U})}):void 0,a.jsx(Ba,{options:(B=s==null?void 0:s.llm)==null?void 0:B.options,onChangeOptions:O,className:"p-2"}),a.jsx(ze,{llm:s==null?void 0:s.llm,status:s==null?void 0:s.status,progress:s==null?void 0:s.progress,loadLLM:i})]})]})}var ae="Avatar",[Ue,lt]=aa(ae),[Ge,ce]=Ue(ae),me=n.forwardRef((e,s)=>{const{__scopeAvatar:o,...i}=e,[r,d]=n.useState("idle");return a.jsx(Ge,{scope:o,imageLoadingStatus:r,onImageLoadingStatusChange:d,children:a.jsx(ne.span,{...i,ref:s})})});me.displayName=ae;var ue="AvatarImage",he=n.forwardRef((e,s)=>{const{__scopeAvatar:o,src:i,onLoadingStatusChange:r=()=>{},...d}=e,l=ce(ue,o),h=Ke(i,d.referrerPolicy),p=ta(c=>{r(c),l.onImageLoadingStatusChange(c)});return Me(()=>{h!=="idle"&&p(h)},[h,p]),h==="loaded"?a.jsx(ne.img,{...d,ref:s,src:i}):null});he.displayName=ue;var pe="AvatarFallback",fe=n.forwardRef((e,s)=>{const{__scopeAvatar:o,delayMs:i,...r}=e,d=ce(pe,o),[l,h]=n.useState(i===void 0);return n.useEffect(()=>{if(i!==void 0){const p=window.setTimeout(()=>h(!0),i);return()=>window.clearTimeout(p)}},[i]),l&&d.imageLoadingStatus!=="loaded"?a.jsx(ne.span,{...r,ref:s}):null});fe.displayName=pe;function Ke(e,s){const[o,i]=n.useState("idle");return Me(()=>{if(!e){i("error");return}let r=!0;const d=new window.Image,l=h=>()=>{r&&i(h)};return i("loading"),d.onload=l("loaded"),d.onerror=l("error"),d.src=e,s&&(d.referrerPolicy=s),()=>{r=!1}},[e,s]),o}var we=me,_e=he,ge=fe;const xe=n.forwardRef(({className:e,...s},o)=>a.jsx(we,{ref:o,className:J("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...s}));xe.displayName=we.displayName;const ye=n.forwardRef(({className:e,...s},o)=>a.jsx(_e,{ref:o,className:J("aspect-square h-full w-full",e),...s}));ye.displayName=_e.displayName;const ve=n.forwardRef(({className:e,...s},o)=>a.jsx(ge,{ref:o,className:J("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...s}));ve.displayName=ge.displayName;const Qe=ke("flex gap-2 max-w-[60%] items-end relative group",{variants:{variant:{received:"self-start",sent:"self-end flex-row-reverse"},layout:{default:"",ai:"max-w-full w-full items-center"}},defaultVariants:{variant:"received",layout:"default"}}),be=n.forwardRef(({className:e,variant:s,layout:o,children:i,...r},d)=>a.jsx("div",{className:J(Qe({variant:s,layout:o,className:e}),"relative group"),ref:d,...r,children:n.Children.map(i,l=>n.isValidElement(l)&&typeof l.type!="string"?n.cloneElement(l,{variant:s,layout:o,className:r==null?void 0:r.innerclassname}):l)}));be.displayName="ChatBubble";const Xe=({src:e,fallback:s,className:o})=>a.jsxs(xe,{className:o,children:[a.jsx(ye,{src:e,alt:"Avatar"}),a.jsx(ve,{children:s})]}),Ye=ke("p-4",{variants:{variant:{received:"bg-secondary text-secondary-foreground rounded-r-lg rounded-tl-lg",sent:"border border-border rounded-l-lg rounded-tr-lg"},layout:{default:"",ai:"border-t w-full rounded-none bg-transparent"}},defaultVariants:{variant:"received",layout:"default"}}),Ne=n.forwardRef(({className:e,variant:s,layout:o,isLoading:i=!1,children:r,...d},l)=>a.jsx("div",{className:J(Ye({variant:s,layout:o,className:e}),"break-words max-w-full whitespace-pre-wrap"),ref:l,...d,children:i?a.jsx("div",{className:"flex items-center space-x-2",children:a.jsx(Q,{})}):r}));Ne.displayName="ChatBubbleMessage";const Ze=({icon:e,onClick:s,className:o,variant:i="ghost",size:r="icon",...d})=>a.jsx(re,{variant:i,size:r,className:o,onClick:s,...d,children:e}),ea=n.forwardRef(({variant:e,className:s,children:o,...i},r)=>a.jsx("div",{ref:r,className:J("absolute top-1/2 -translate-y-1/2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200",e==="sent"?"-left-1 -translate-x-full flex-row-reverse":"-right-1 translate-x-full",s),...i,children:o}));ea.displayName="ChatBubbleActionWrapper";let je,Ce,Le;je=[{icon:"copy",label:"Copy"},{icon:"refresh-ccw",label:"Refresh"},{icon:"volume-2",label:"Volume"}],Ce=n.memo(({message:e,index:s,isLastMessage:o,isGenerating:i,isSchema:r,onActionClick:d})=>{const l=n.useMemo(()=>a.jsx(Fe,{style:{color:"unset !important"},source:e.content?r?`\`\`\`json
${e.content}
\`\`\``:e.content:""}),[r,e.content]);return a.jsxs(be,{innerclassname:e.role=="system"?"!bg-transparent font-semibold":void 0,variant:e.role=="user"?"sent":"received",children:[e.role==="system"?a.jsx("div",{className:"w-10 h-10"}):e.role==="assistant"?a.jsx(Xe,{src:"",fallback:e.data&&typeof e.data=="object"&&"injectedMessage"in e.data?"\u{1F4C2}":"\u{1F916}"}):void 0,a.jsxs(Ne,{children:[i&&o&&(!e.content||r)?a.jsx(Q,{}):a.jsxs(n.Suspense,{fallback:a.jsx(Q,{}),children:[e.role==="system"?a.jsx(Ja,{className:"!text-sm mb-1",children:"System"}):void 0,l]}),e.role==="assistant"&&o&&a.jsx("div",{className:"flex items-center mt-1.5 gap-1",children:!i&&a.jsx(a.Fragment,{children:je.map((h,p)=>a.jsx(Ze,{variant:"ghost",className:"size-5",icon:a.jsx(H,{name:h.icon,className:"size-3"}),onClick:()=>d(h.label,e)},p))})})]})]},s)},()=>!1),Le=()=>({changeLLMOptions:n.useCallback(async(e,s)=>{e&&await D("LLM").update(e.id,{options:s})},[])}),Pe=n.memo(()=>{const{t:e}=q("applications"),s=n.useRef(!1),[o,i]=n.useState(!1),r=n.useCallback(()=>{setTimeout(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},50)},[]),d=Ve(),{schema:l,threadInfo:h,mainLLMInfo:p,retriverInfo:c,currentDataNode:u,loadLLM:x,setLLMInfo:_,addNewDataNode:y,selectDataNode:t,updateMessagesData:E,onThreadMessagesLoaded:R}=d,{changeLLMOptions:S}=Le(),{sendMessage:N}=Be(d),{input:L,messages:v,isLoading:I,reload:j,setInput:O,handleSubmit:U,handleInputChange:$,setMessages:B}=Ca({fetch:async(C,g)=>{try{i(!0);const T=JSON.parse(g==null?void 0:g.body),k=K(),W=T.messages[T.messages.length-1];return s.current=!0,B(A=>[...A,{id:K(),content:W.content,role:"user"}]),await N(W.content,T.messages||[],{retriverInfo:c},{schema:l,onInjectedMessages:A=>{A.length&&B(P=>[...P,...A.map(V=>V._getType()==="system"?{id:K(),content:`${V.content}`,role:"system",data:{injectedMessage:!0}}:V._getType()==="human"?{id:K(),content:`${V.content}`,role:"user",data:{injectedMessage:!0}}:{id:K(),content:`${V.content}`,role:"assistant",data:{injectedMessage:!0}})])},onResponseMessageCreate:A=>{B(P=>[...P,{id:k,content:A||"",role:"assistant"}])},onMessageUpdate:A=>{B(P=>{const V=[...P],b=V.findIndex(G=>G.id===k);return b!==-1&&(V[b]={...V[b],content:A.nodeData.content||""}),V}),s.current&&r()}}),B(A=>(E(A),A)),i(!1),O(""),s.current&&r(),new Response}finally{i(!1)}}}),m=n.useRef(null);n.useEffect(()=>{const C=R(g=>{B(g||[]),r()});return()=>{C()}},[B,R,r]);const f=async(C,g)=>(i(!0),await U(g),!0),w=n.useCallback(async(C,g)=>{if(C==="Refresh"){i(!0);try{await j()}finally{i(!1)}}C==="Copy"&&g&&g.role==="assistant"&&navigator.clipboard.writeText(g.content),C==="Volume"&&(g!=null&&g.content)&&await sa.speak((g==null?void 0:g.content)||"")},[j]),M=n.useCallback(()=>s.current=!1,[]),F=n.useMemo(()=>v&&v.map((C,g)=>a.jsx(Ce,{message:C,index:g,isLastMessage:g===v.length-1,isGenerating:o,isSchema:!!l,onActionClick:w},C.id||`${g}`)),[v,o,l,w]);return a.jsxs(ba,{onClick:M,className:"max-h-full !overflow-hidden !min-h-full",style:{minHeight:"unset"},defaultOpen:!0,children:[a.jsx(Na,{className:"!max-h-full !overflow-hidden",style:{minHeight:"unset"},children:a.jsxs("main",{className:"flex h-full w-full max-w-2xl flex-col items-center mx-auto overflow-hidden",children:[a.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden min-w-full max-w-full",children:a.jsx(de,{className:"!max-h-full",ref:m,children:F})}),a.jsx(Da,{className:"!max-w-2xl px-4",onSubmit:f,disabled:I||o||(p==null?void 0:p.status)!==z.Loaded,placeholder:e("chat.input_message_placeholder"),value:L,onChange:$})]})}),a.jsx(He,{schema:l,currentDataNode:u,threadNode:h==null?void 0:h.threadNode,loadLLM:x,mainLLMInfo:p,mainEmbeddingInfo:d.mainEmbeddingInfo,retriverInfo:c,onAddNewThread:y,onSelectThread:t,changeLLMOptions:S,setLLMInfo:_})]})})});export{ot as __tla,Pe as default};
