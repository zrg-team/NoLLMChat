const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CFeuNoUh.js","assets/LLMIcon-CZS-ODRN.js","assets/index-D8zyPWIn.js","assets/index-CKMZ0OYe.css","assets/routes-DU39yQk1.js","assets/dot-HIRY-eDy.js","assets/createLucideIcon-BBHVmnqG.js","assets/pdf.min-DG-tGUe3.js","assets/pdf.worker.min-DXTiFl-L.js"])))=>i.map(i=>d[i]);
import{r as n,j as a,c as z,o as Le,u as H,p as X,a as Se,_ as se,L as q,b as ea,P as ne,q as aa,s as Ee,t as Me,v as ta,__tla as sa}from"./index-D8zyPWIn.js";import{u as ke,g as E,F as na,A as Ie,S as ra,H as ia,h as oa,i as la,j as da,k as ca,l as ma,m as ua,n as ha,o as fa,B as re,V as Y,D as pa,q as wa,r as ga,s as ya,t as xa,v as _a,w as va,x as ba,L as Na,y as ja,z as Ca,C as Da,E as La,G as Sa,J as Ea,K as Ma,M as K,__tla as ka}from"./routes-DU39yQk1.js";import{u as Ia,__tla as Ra}from"./index-C0fBlnBF.js";import{A as Oa,__tla as Fa}from"./popover-CNDhZaXq.js";import{f as ie,u as Re,F as Ta,P as Aa,C as Oe,L as Pa,a as Va,W as Ba,T as Z,D as za,I as Ja,b as Wa,V as $a,d as Ha,e as qa,g as ee,M as Fe,h as Ga,i as Ua,__tla as Ka}from"./chunk-kPJu7z3i.js";import{a as Qa,b as Xa,I as oe,p as Ya,L as J,S as Za,u as et,c as Te,d as at,__tla as tt}from"./LLMIcon-CZS-ODRN.js";import"./toNumber-Cd5am1kN.js";import{__tla as st}from"./index-B7BQPxIA.js";import"./dot-HIRY-eDy.js";import"./createLucideIcon-BBHVmnqG.js";let Ae,nt=Promise.all([(()=>{try{return sa}catch{}})(),(()=>{try{return ka}catch{}})(),(()=>{try{return Ra}catch{}})(),(()=>{try{return Fa}catch{}})(),(()=>{try{return Ka}catch{}})(),(()=>{try{return tt}catch{}})(),(()=>{try{return st}catch{}})()]).then(async()=>{const le=n.forwardRef(({className:e,children:s,...d},i)=>a.jsx("div",{className:z("flex flex-col w-full h-full p-4 gap-6 overflow-y-auto",e),ref:i,...d,children:s}));le.displayName="ChatMessageList";const Pe=()=>{var $,B;const[e,s]=n.useState(),[d,i]=n.useState(),[r,c]=n.useState(),[l,h]=n.useState(),[w,f]=n.useState([]),[o,y]=n.useState(),p=n.useRef(),v=n.useRef({}),t=ke(m=>m.currentSession),{loadModel:M}=Qa(),{modalRef:L}=Xa(Za),P=n.useCallback(async m=>{var g;if(!t)return;const u=await E("JSONData").findOne({where:{id:m.source_id,session_id:t==null?void 0:t.id}});u&&((g=p.current)==null||g.call(p,u.data?u.data:[]),y({node:m,enity:u}))},[t]),S=n.useCallback(async m=>{var F;const u=(m==null?void 0:m.sessionId)||(t==null?void 0:t.id),g=(m==null?void 0:m.threadNode)||(r==null?void 0:r.threadNode),k=(m==null?void 0:m.prompts)||(e==null?void 0:e.prompts);if(!u||!(g!=null&&g.id))return;const O=k==null?void 0:k.map(I=>{if(I.type!=="few_shot_example")switch(I.role){case"ai":case"assistant":case"tool":return{id:I.id,content:I.content,role:"assistant"};case"system":return{id:I.id,content:I.content,role:"system"};default:return{id:I.id,content:I.content,role:"user"}}}).filter(Boolean),D=await E("JSONData").save({headers:"item",session_id:u,json:"",data:O});if(!D)return;const x=await E("FlowNode").save({session_id:u,source_id:D.id,source_type:"JSONData",node_type:"JSON_DATA",x:0,y:0});if(x)return await E("FlowEdge").save({session_id:u,source:g.id,target:x.id}),(F=p.current)==null||F.call(p,O),y({node:x,enity:D}),{jsonData:D,jsonDataNode:x}},[e==null?void 0:e.prompts,t==null?void 0:t.id,r==null?void 0:r.threadNode]),_=n.useCallback(async(m,u)=>{if(!t)return;const g=await E("FlowEdge").findOne({where:{session_id:t.id,source:m.id},order:{id:"DESC"}});if(g){const k=await E("FlowNode").findOne({where:{id:g.target,session_id:t.id}});if(!k)return;await P(k)}else if(!await S({sessionId:t.id,threadNode:m,prompts:u||[]}))return},[S,t,P]),C=n.useCallback(async m=>{if(m!=null&&m.length&&(t!=null&&t.id)){const u=(await Promise.all(m.map(async g=>E("FlowEdge").find({where:{target:g.source.id}}).then(k=>ie({where:{session_id:t.id,id:oe(k.map(O=>O.source))}}).then(O=>({...O,...g})))))).map(g=>{var F,I,W,T;const k=g.flowNodes.find(A=>A.source_type==="Prompt"),O=g.flowNodes.find(A=>A.source_type==="VectorDatabase");if(!O||!k)return;const D=(I=(F=g.flowNodeDatas)==null?void 0:F.Prompt)==null?void 0:I.find(A=>A.id===k.source_id),x=(T=(W=g.flowNodeDatas)==null?void 0:W.VectorDatabase)==null?void 0:T.find(A=>A.id===O.source_id);return{promptNode:k,vectorDatabaseNode:O,placeholderNode:g.source,placeholderEntity:g.entity,promptEntity:D,vectorDatabaseEntity:x}}).filter(Boolean);f(u)}},[t==null?void 0:t.id]),N=n.useCallback(async()=>{try{if(v.current.handling=t==null?void 0:t.id,!(t!=null&&t.id)||!(t!=null&&t.main_source_id)||(t==null?void 0:t.main_source_type)!=="Thread")return;const[m,u]=await Promise.all([E("Thread").findOne({where:{id:t.main_source_id,session_id:t.id}}),E("FlowNode").findOne({where:{id:t.main_node_id}})]);if(!m||!u)return;const g=await E("FlowEdge").find({where:{session_id:t.id,target:u.id}}),{flowNodes:k,flowNodeDatas:O}=await ie({where:{session_id:t.id,id:oe(g.map(b=>b.source))}}),D=(await E("FlowEdge").find({where:{session_id:t.id}})).filter(b=>b.target===u.id).map(b=>{var De;const U=k.find(te=>te.id===b.source);return{connection:b,source:U,entity:(De=O==null?void 0:O[U.source_type])==null?void 0:De.find(te=>te.id===U.source_id)}}),x=D.find(b=>b.source.source_type==="LLM"),F=D.filter(b=>b.source.source_type==="Prompt"),I=D.find(b=>b.source.source_type==="Schema"),W=x==null?void 0:x.entity;if(!W)return;t.passphrase&&await Ya(t.passphrase,L.current);const T=D.filter(b=>b.source.source_type==="FlowNodePlaceholder");await C(T),await _(u,(F==null?void 0:F.map(b=>b.entity))||[]);const A=await E("FlowNode").findOne({where:{node_type:na.DefaultEmbeddingModel,source_type:"FlowNodePlaceholder"}});if(A){const b=await E("FlowNodePlaceholder").findOne({where:{id:A.source_id}});i({embedding:b})}h({llm:W,status:W.status||J.Started,progress:""}),c({thread:m,threadNode:u});const V=I==null?void 0:I.entity;if(V){const b=await E("SchemaItem").find({where:{schema_id:V.id}});V.schema_items=b||[]}s({prompts:(F==null?void 0:F.map(b=>b.entity))||[],schema:V}),v.current.handled=t.id}finally{v.current.handling=void 0}},[t==null?void 0:t.id,t==null?void 0:t.main_node_id,t==null?void 0:t.main_source_id,t==null?void 0:t.main_source_type,t==null?void 0:t.passphrase,C,_,L]),j=n.useCallback(async()=>{var m;if((m=l==null?void 0:l.llm)!=null&&m.name)try{h(u=>u&&{...u,status:J.Loading}),await M(l.llm.provider,l==null?void 0:l.llm.name,{provider:l.llm.provider,callback:u=>{h(g=>g&&{...g,progress:u.text})}}),h(u=>u&&{...u,status:J.Loaded,progress:""})}catch{h(u=>u&&{...u,status:J.Started,progress:""})}},[($=l==null?void 0:l.llm)==null?void 0:$.name,(B=l==null?void 0:l.llm)==null?void 0:B.provider,M]),R=n.useCallback(m=>(p.current=m,()=>{p.current=void 0}),[]),G=n.useCallback(async m=>{!(o!=null&&o.node)||!(o!=null&&o.enity)||await E("JSONData").save({...o.enity,data:m})},[o==null?void 0:o.enity,o==null?void 0:o.node]);return n.useEffect(()=>{v.current.handling||(v==null?void 0:v.current.handled)===(t==null?void 0:t.id)||N()},[t==null?void 0:t.id,N]),{...e,loadLLM:j,threadInfo:r,mainLLMInfo:l,mainEmbeddingInfo:d,retriverInfo:w,currentDataNode:o,updateMessagesData:G,addNewDataNode:S,selectDataNode:P,setLLMInfo:h,onThreadMessagesLoaded:R}},Ve=e=>{var l;const[s]=n.useState(!1),{similaritySearchWithScore:d}=Re(),{stream:i}=et(),r=n.useCallback(async(h,w)=>{if(!(w!=null&&w.length))return[];const f=[];return await Promise.all(w.map(async o=>{var p,v,t,M,L;const y=o.placeholderEntity;if(y)switch(y.placeholder_type){case Ta.VECTOR_DATABASE_RETREIVER:{if(!o.promptNode||!o.promptEntity||!o.vectorDatabaseNode||!o.vectorDatabaseEntity)return;const P=(p=y.metadata)!=null&&p.k?+((v=y.metadata)==null?void 0:v.k):1;let S=(t=y.metadata)!=null&&t.minimalScore?+((M=y.metadata)==null?void 0:M.minimalScore):void 0;S&&S>1&&(S=S/100);const _=await d((L=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:L.embedding,{database:{databaseId:o.vectorDatabaseEntity.id}},h,P);if(!_)return[];const C=new Aa({template:o.promptEntity.content,inputVariables:["context"]});f.push(new Ie(await C.format({context:S?_.filter(([,N])=>N>=S).map(([N])=>N.pageContent).join(`
`):_.map(([N])=>N.pageContent).join(`
`)})))}}})),f},[d,(l=e==null?void 0:e.mainEmbeddingInfo)==null?void 0:l.embedding]),c=n.useCallback(async(h,w,{retriverInfo:f},{schema:o,onMessageUpdate:y,onResponseMessageCreate:p,onInjectedMessages:v})=>{var P,S;if(!((P=e.mainLLMInfo)!=null&&P.llm)||((S=e.mainLLMInfo)==null?void 0:S.status)!==J.Loaded)throw new Error("LLM not found");const t=[];f!=null&&f.length&&(t.push(...await r(h,f)),v==null||v(t));const M=w.map(_=>_.role==="system"?new ra(_.content):_.role==="user"?new ia(_.content):new Ie(_.content));p==null||p();const L=await i(e.mainLLMInfo.llm.provider,[...t,...M],{schemas:o?[o]:void 0,onMessageUpdate:({content:_})=>{y==null||y({nodeData:{loading:!0,content:_}})},llm:e.mainLLMInfo.llm});return y==null||y({nodeData:{content:L==null?void 0:L.content}}),L==null?void 0:L.content},[r,i,e.mainLLMInfo]);return{loading:s,sendMessage:c}},Be=Le(({onDelete:e})=>{const{t:s}=H("dialogs"),[d,i]=n.useState(!1),r=X(),{toast:c}=Se(),l=async()=>{try{i(!0),await e(),r.hide()}catch{c({variant:"destructive",description:s("delete_chat_data_node.errors.delete_failed")})}finally{i(!1)}};return a.jsx(oa,{open:r.visible,onOpenChange:r.hide,children:a.jsxs(la,{children:[a.jsxs(da,{children:[a.jsx(ca,{children:s("delete_chat_data_node.title")}),a.jsx(ma,{children:s("delete_chat_data_node.description")})]}),a.jsxs(ua,{children:[a.jsx(ha,{onClick:r.hide,children:s("delete_chat_data_node.cancel")}),a.jsx(fa,{disabled:d,onClick:l,children:s("delete_chat_data_node.delete")})]})]})})});function Q(){return a.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",className:"text-foreground",children:[a.jsx("circle",{cx:"4",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_qFRN",begin:"0;spinner_OcgL.end+0.25s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{begin:"spinner_qFRN.begin+0.1s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})}),a.jsx("circle",{cx:"20",cy:"12",r:"2",fill:"currentColor",children:a.jsx("animate",{id:"spinner_OcgL",begin:"spinner_qFRN.begin+0.2s",attributeName:"cy",calcMode:"spline",dur:"0.6s",values:"12;6;12",keySplines:".33,.66,.66,1;.33,0,.66,.33"})})]})}const ze=n.memo(({llm:e,status:s,loadLLM:d,progress:i})=>{const{t:r}=H("flows"),[c,l]=n.useState();n.useEffect(()=>{if(!(c||!(e!=null&&e.name))){if((e==null?void 0:e.provider)!=="WebLLM"){l({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:e==null?void 0:e.name,model:e==null?void 0:e.name,model_lib:e==null?void 0:e.provider,model_type:2}});return}se(()=>import("./index-CFeuNoUh.js").then(async f=>(await f.__tla,f)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:f,functionCallingModelIds:o,prebuiltAppConfig:y})=>{const p=await f(e==null?void 0:e.name);l({hasCache:p,isFunctionCalling:o.includes(e==null?void 0:e.name),info:y.model_list.find(v=>v.model_id===(e==null?void 0:e.name))})})}},[e==null?void 0:e.name,c]);const h=n.useCallback(async()=>{await(d==null?void 0:d())},[d]),w=n.useMemo(()=>{switch(s){case J.Downloading:return a.jsx(q,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case J.Loaded:return a.jsx(Te,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"});default:return a.jsx(Te,{name:(e==null?void 0:e.name)||"brain",className:"w-7 h-7"})}},[e==null?void 0:e.name,s]);return a.jsx(Oe,{className:"flex justify-center !bg-inherit !p-2 max-w-full overflow-y-hidden !mb-2 m-2 !mt-0",children:a.jsxs("div",{className:"ml-2 pt-1 max-w-full",children:[a.jsxs("p",{className:"flex gap-2 items-center pr-6 !text-sm font-semibold",children:[w,`${(e==null?void 0:e.name)||""}`]}),a.jsxs("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:[a.jsx(Pa,{model:c==null?void 0:c.info,isFunctionCalling:(c==null?void 0:c.isFunctionCalling)||!1,name:e==null?void 0:e.name,isCached:(c==null?void 0:c.hasCache)||!1,cloud:(c==null?void 0:c.cloud)||!1}),s!==J.Loaded?i?a.jsx("div",{className:"text-sm break-words flex-wrap",children:i}):a.jsx(re,{disabled:s===J.Loading,onClick:h,className:"mt-4 w-full",children:r(c!=null&&c.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")}):void 0]})]})})}),Je=e=>{const[s,d]=n.useState(!1),{t:i}=H("flows"),{toast:r}=Se(),{index:c,similaritySearchWithScore:l}=Re(),h=n.useCallback(async(f,o)=>{try{if(!(o!=null&&o.vectorDatabase)){r({variant:"destructive",title:i("vector_database_node.errors.vector_database_not_found")});return}if((o==null?void 0:o.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for similarity search");return d(!0),await l(e==null?void 0:e.embedding,{database:{databaseId:o.vectorDatabase.id}},f,o==null?void 0:o.k)}catch{r({variant:"destructive",title:i("vector_database_node.errors.similarity_search_failed")})}finally{d(!1)}},[r,i,l,e==null?void 0:e.embedding]),w=n.useCallback(async(f,o)=>{var y;try{d(!0);const p=f.content?[new pa({pageContent:f.content,id:f.id,metadata:{id:f.id}})]:f.documents;if(!(p!=null&&p.length)){r({variant:"destructive",title:i("vector_database_node.errors.content_not_found")});return}if(!(o!=null&&o.vectorDatabase)){r({variant:"destructive",title:i("vector_database_node.errors.vector_database_not_found")});return}if((o==null?void 0:o.vectorDatabase.storage)===Y.DataNode)throw new Error("DataNode storage is not supported for indexing");{const v=Va(p,10);let t=0;for(const M of v)(y=o==null?void 0:o.onProgressReport)==null||y.call(o,{handling:M.length,handled:t,total:p.length}),await c(e==null?void 0:e.embedding,{database:{databaseId:o.vectorDatabase.id}},M),t+=M.length}}catch{r({variant:"destructive",title:i("vector_database_node.errors.similarity_search_failed")})}finally{d(!1)}},[r,i,c,e==null?void 0:e.embedding]);return{loading:s,indexData:w,similaritySearchWithScore:h}},We=Le(({retriverInfo:e,mainEmbeddingInfo:s})=>{var L,P,S;const{t:d}=H("applications"),{loading:i,similaritySearchWithScore:r,indexData:c}=Je(s),[l,h]=n.useState("search"),[w,f]=n.useState(0),o=X(),y=n.useMemo(()=>{var N,j;if(!((N=e==null?void 0:e.vectorDatabaseEntity)!=null&&N.raw))return{headers:[],rows:[]};const _=["content","embedding","metadata"],C=wa((j=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:j.raw);return{headers:_,rows:C.map(R=>{try{return JSON.parse(R)}catch{return[]}})}},[(L=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:L.raw]),p=n.useCallback(async(..._)=>{const[C,N]=_;await c(C,{...N,vectorDatabase:e.vectorDatabaseEntity})},[c,e.vectorDatabaseEntity]),v=n.useCallback(async(_,C)=>{const N=_.trim(),j=await r(N,{k:C,vectorDatabase:e.vectorDatabaseEntity});if(j!=null&&j.length)return j},[e.vectorDatabaseEntity,r]),t=n.useCallback(async _=>{if(_.type.includes("text")||_.type.includes("txt")){const C=new FileReader;C.onload=async N=>{var R;const j=(R=N.target)==null?void 0:R.result;await p({content:j},{vectorDatabase:e.vectorDatabaseEntity})},C.readAsText(_)}else if(_.type.endsWith("pdf")){const C=new Blob([_],{type:"application/pdf"}),N=await new Ba(C,{pdfjs:async()=>{const j=await se(()=>import("./pdf.min-DG-tGUe3.js").then(async R=>(await R.__tla,R)),__vite__mapDeps([7,2,3,1,4,5,6]));return await se(()=>import("./pdf.worker.min-DXTiFl-L.js").then(async R=>(await R.__tla,R)),__vite__mapDeps([8,1,2,3,4,5,6])),j.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),j},parsedItemSeparator:" "}).load();await p({documents:N},{vectorDatabase:e.vectorDatabaseEntity,onProgressReport:j=>{f((j.handled+j.handling)/j.total)}})}},[p,e.vectorDatabaseEntity]),M=n.useMemo(()=>{switch(l){case"search":return a.jsx(Z,{value:"search",children:a.jsx($a,{loading:i,onSimilaritySearch:v})});case"new":return a.jsx(Z,{className:"min-w-80",value:"new",children:a.jsx(Wa,{loading:i,onCreateData:p})});case"file":return a.jsx(Z,{value:"file",children:a.jsx(Ja,{loading:i,progress:w,onFileSubmit:t,fileOptions:{accept:".pdf,.txt,.text",maxSize:1}})});case"view":return a.jsx(Z,{value:"view",className:"max-h-full overflow-auto",children:a.jsx(za,{data:y.rows,headers:y.headers,limitLengthByColumns:{embedding:32}})})}},[p,t,v,i,l,w,y]);return a.jsx(ga,{open:o.visible,onOpenChange:o.hide,children:a.jsxs(ya,{className:"max-w-3xl",children:[a.jsx(xa,{children:a.jsxs("div",{className:"flex",children:[a.jsx(q,{name:"file",className:"mr-2 h-4 w-4"}),a.jsx(_a,{children:d("chat.vector_database")})]})}),a.jsx("div",{className:"mx-auto w-full min-h-96 max-h-full overflow-hidden",children:a.jsx("div",{className:"w-full h-full",children:a.jsxs(Ha,{value:l,onValueChange:h,defaultValue:"search",className:z("w-full h-full mt-4"),children:[a.jsxs(qa,{className:z("grid w-full grid-cols-3",((P=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:P.storage)===Y.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[a.jsx(ee,{value:"search",children:d("chat.search")}),a.jsx(ee,{value:"new",children:d("chat.text")}),a.jsx(ee,{value:"file",children:d("chat.file")}),((S=e==null?void 0:e.vectorDatabaseEntity)==null?void 0:S.storage)===Y.DatabaseNode?a.jsx(ee,{value:"view",children:d("chat.view")}):void 0]}),M]})})})]})})}),$e=e=>{const[s,d]=n.useState([]),i=ke(l=>l.currentSession),r=n.useCallback(async()=>{if(!e||!(i!=null&&i.id))return;const l=await E("FlowEdge").find({where:{session_id:i.id,source:e.id},order:{id:"DESC"}}),{flowNodes:h,flowNodeDatas:w}=await ie({where:{session_id:i.id,id:oe(l.map(f=>f.target)),source_type:"JSONData"},order:{updated_at:"DESC"},select:["id","source_id","source_type","updated_at"]});d(h.reduce((f,o)=>{var p;const y=(p=w[o.source_type])==null?void 0:p.find(v=>v.id===o.source_id);return y&&f.push({node:o,entity:y}),f},[]))},[i==null?void 0:i.id,e]),c=n.useCallback(async l=>{await E("FlowNode").delete(l.id),await E("JSONData").delete(l.source_id);const h=await E("FlowEdge").find({where:[{source:l.id},{target:l.id}]});await Promise.all(h.map(w=>E("FlowEdge").delete(w.id))),r()},[r]);return n.useEffect(()=>{e&&r()},[r,e]),{chatList:s,deleteChat:c,getChatList:r}};function He({schema:e,mainLLMInfo:s,mainEmbeddingInfo:d,loadLLM:i,retriverInfo:r,threadNode:c,onSelectThread:l,onAddNewThread:h,currentDataNode:w,setLLMInfo:f,changeLLMOptions:o,...y}){var $,B;const{t:p}=H("applications"),[v,t]=n.useState(!1),M=X(Be),L=X(We),{chatList:P,getChatList:S,deleteChat:_}=$e(c),C=n.useCallback(async()=>{try{t(!0),await(h==null?void 0:h()),S()}finally{t(!1)}},[S,h]),N=n.useCallback(()=>{L.show({retriverInfo:r[0],mainEmbeddingInfo:d})},[d,r,L]),j=n.useCallback(async(m,u)=>{m.stopPropagation(),M.show({onDelete:()=>_(u)})},[_,M]),R=n.useCallback(async m=>{s!=null&&s.llm&&(await o(s==null?void 0:s.llm,m),f(u=>u?{...u,llm:{...u.llm,options:m}}:void 0))},[o,s==null?void 0:s.llm,f]),G=n.useMemo(()=>{var m;return a.jsx(Fe,{className:z("overflow-hidden break-words whitespace-pre-wrap w-full rounded-lg"),source:(m=e==null?void 0:e.schema_items)!=null&&m.length?`\`\`\`javascript
${at((e==null?void 0:e.schema_items)||[])}
\`\`\``:""})},[e==null?void 0:e.schema_items]);return a.jsxs(va,{variant:"sidebar",side:"right",collapsible:"none",...y,children:[a.jsx("div",{className:"h-1"}),a.jsxs(ba,{className:"justify-between",children:[a.jsx("div",{className:"text-sm pl-2",children:p("chat.history")}),a.jsx(Na,{loading:v,onClick:C,variant:"link",className:"mr-[-6px]",children:a.jsx(q,{name:"circle-plus"})})]}),a.jsxs(ja,{children:[a.jsx(Ca,{className:"flex-1",children:a.jsx(Da,{children:P.map(({node:m},u)=>{var g;return a.jsx(La,{onClick:()=>l(m),children:a.jsx(Sa,{className:"cursor-pointer",children:a.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsx(q,{size:16,name:((g=w==null?void 0:w.node)==null?void 0:g.id)===m.id?"check":"chevron-right",className:"ml-auto transition-transform duration-200 group-data-[state=open]/collapsible:rotate-90"}),a.jsx("span",{children:`Thread ${u+1}`})]}),a.jsx(q,{onClick:k=>j(k,m),size:16,name:"trash-2"})]})})},m.id)})})}),r!=null&&r.length?a.jsxs(Oe,{className:"m-2 p-2 max-w-full",children:[a.jsx("pre",{className:"overflow-auto",children:r.map((m,u)=>{var g;return a.jsx("span",{children:((g=m.promptEntity)==null?void 0:g.content)||""},`${u}`)})}),a.jsx(re,{onClick:N,className:"w-full mt-4",children:p("chat.vector_database")})]}):void 0,($=e==null?void 0:e.schema_items)!=null&&$.length?a.jsx("div",{className:"m-2 !mb-0",children:a.jsx(n.Suspense,{fallback:a.jsx(Q,{}),children:G})}):void 0,a.jsx(Ga,{options:(B=s==null?void 0:s.llm)==null?void 0:B.options,onChangeOptions:R,className:"p-2"}),a.jsx(ze,{llm:s==null?void 0:s.llm,status:s==null?void 0:s.status,progress:s==null?void 0:s.progress,loadLLM:i})]})]})}var ae="Avatar",[qe,rt]=ea(ae),[Ge,de]=qe(ae),ce=n.forwardRef((e,s)=>{const{__scopeAvatar:d,...i}=e,[r,c]=n.useState("idle");return a.jsx(Ge,{scope:d,imageLoadingStatus:r,onImageLoadingStatusChange:c,children:a.jsx(ne.span,{...i,ref:s})})});ce.displayName=ae;var me="AvatarImage",ue=n.forwardRef((e,s)=>{const{__scopeAvatar:d,src:i,onLoadingStatusChange:r=()=>{},...c}=e,l=de(me,d),h=Ue(i,c.referrerPolicy),w=aa(f=>{r(f),l.onImageLoadingStatusChange(f)});return Ee(()=>{h!=="idle"&&w(h)},[h,w]),h==="loaded"?a.jsx(ne.img,{...c,ref:s,src:i}):null});ue.displayName=me;var he="AvatarFallback",fe=n.forwardRef((e,s)=>{const{__scopeAvatar:d,delayMs:i,...r}=e,c=de(he,d),[l,h]=n.useState(i===void 0);return n.useEffect(()=>{if(i!==void 0){const w=window.setTimeout(()=>h(!0),i);return()=>window.clearTimeout(w)}},[i]),l&&c.imageLoadingStatus!=="loaded"?a.jsx(ne.span,{...r,ref:s}):null});fe.displayName=he;function Ue(e,s){const[d,i]=n.useState("idle");return Ee(()=>{if(!e){i("error");return}let r=!0;const c=new window.Image,l=h=>()=>{r&&i(h)};return i("loading"),c.onload=l("loaded"),c.onerror=l("error"),c.src=e,s&&(c.referrerPolicy=s),()=>{r=!1}},[e,s]),d}var pe=ce,we=ue,ge=fe;const ye=n.forwardRef(({className:e,...s},d)=>a.jsx(pe,{ref:d,className:z("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...s}));ye.displayName=pe.displayName;const xe=n.forwardRef(({className:e,...s},d)=>a.jsx(we,{ref:d,className:z("aspect-square h-full w-full",e),...s}));xe.displayName=we.displayName;const _e=n.forwardRef(({className:e,...s},d)=>a.jsx(ge,{ref:d,className:z("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...s}));_e.displayName=ge.displayName;const Ke=Me("flex gap-2 max-w-[60%] items-end relative group",{variants:{variant:{received:"self-start",sent:"self-end flex-row-reverse"},layout:{default:"",ai:"max-w-full w-full items-center"}},defaultVariants:{variant:"received",layout:"default"}}),ve=n.forwardRef(({className:e,variant:s,layout:d,children:i,...r},c)=>a.jsx("div",{className:z(Ke({variant:s,layout:d,className:e}),"relative group"),ref:c,...r,children:n.Children.map(i,l=>n.isValidElement(l)&&typeof l.type!="string"?n.cloneElement(l,{variant:s,layout:d,className:r==null?void 0:r.innerclassname}):l)}));ve.displayName="ChatBubble";const Qe=({src:e,fallback:s,className:d})=>a.jsxs(ye,{className:d,children:[a.jsx(xe,{src:e,alt:"Avatar"}),a.jsx(_e,{children:s})]}),Xe=Me("p-4",{variants:{variant:{received:"bg-secondary text-secondary-foreground rounded-r-lg rounded-tl-lg",sent:"border border-border rounded-l-lg rounded-tr-lg"},layout:{default:"",ai:"border-t w-full rounded-none bg-transparent"}},defaultVariants:{variant:"received",layout:"default"}}),be=n.forwardRef(({className:e,variant:s,layout:d,isLoading:i=!1,children:r,...c},l)=>a.jsx("div",{className:z(Xe({variant:s,layout:d,className:e}),"break-words max-w-full whitespace-pre-wrap"),ref:l,...c,children:i?a.jsx("div",{className:"flex items-center space-x-2",children:a.jsx(Q,{})}):r}));be.displayName="ChatBubbleMessage";const Ye=({icon:e,onClick:s,className:d,variant:i="ghost",size:r="icon",...c})=>a.jsx(re,{variant:i,size:r,className:d,onClick:s,...c,children:e}),Ze=n.forwardRef(({variant:e,className:s,children:d,...i},r)=>a.jsx("div",{ref:r,className:z("absolute top-1/2 -translate-y-1/2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200",e==="sent"?"-left-1 -translate-x-full flex-row-reverse":"-right-1 translate-x-full",s),...i,children:d}));Ze.displayName="ChatBubbleActionWrapper";let Ne,je,Ce;Ne=[{icon:"copy",label:"Copy"},{icon:"refresh-ccw",label:"Refresh"},{icon:"volume-2",label:"Volume"}],je=n.memo(({message:e,index:s,isLastMessage:d,isGenerating:i,isSchema:r,onActionClick:c})=>{const l=n.useMemo(()=>a.jsx(Fe,{style:{color:"unset !important"},source:e.content?r?`\`\`\`json
${e.content}
\`\`\``:e.content:""}),[r,e.content]);return a.jsxs(ve,{innerclassname:e.role=="system"?"!bg-transparent font-semibold":void 0,variant:e.role=="user"?"sent":"received",children:[e.role==="system"?a.jsx("div",{className:"w-10 h-10"}):e.role==="assistant"?a.jsx(Qe,{src:"",fallback:e.data&&typeof e.data=="object"&&"injectedMessage"in e.data?"\u{1F4C2}":"\u{1F916}"}):void 0,a.jsxs(be,{children:[i&&d&&(!e.content||r)?a.jsx(Q,{}):a.jsxs(n.Suspense,{fallback:a.jsx(Q,{}),children:[e.role==="system"?a.jsx(Ua,{className:"!text-sm mb-1",children:"System"}):void 0,l]}),e.role==="assistant"&&d&&a.jsx("div",{className:"flex items-center mt-1.5 gap-1",children:!i&&a.jsx(a.Fragment,{children:Ne.map((h,w)=>a.jsx(Ye,{variant:"ghost",className:"size-5",icon:a.jsx(q,{name:h.icon,className:"size-3"}),onClick:()=>c(h.label,e)},w))})})]})]},s)},()=>!1),Ce=()=>({changeLLMOptions:n.useCallback(async(e,s)=>{e&&await E("LLM").update(e.id,{options:s})},[])}),Ae=n.memo(()=>{const{t:e}=H("applications"),s=n.useRef(!1),[d,i]=n.useState(!1),r=n.useCallback(()=>{setTimeout(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},50)},[]),c=Pe(),{schema:l,threadInfo:h,mainLLMInfo:w,retriverInfo:f,currentDataNode:o,loadLLM:y,setLLMInfo:p,addNewDataNode:v,selectDataNode:t,updateMessagesData:M,onThreadMessagesLoaded:L}=c,{changeLLMOptions:P}=Ce(),{sendMessage:S}=Ve(c),{input:_,messages:C,isLoading:N,reload:j,setInput:R,handleSubmit:G,handleInputChange:$,setMessages:B}=Ia({fetch:async(D,x)=>{try{i(!0);const F=JSON.parse(x==null?void 0:x.body),I=K(),W=F.messages[F.messages.length-1];return s.current=!0,B(T=>[...T,{id:K(),content:W.content,role:"user"}]),await S(W.content,F.messages||[],{retriverInfo:f},{schema:l,onInjectedMessages:T=>{T.length&&B(A=>[...A,...T.map(V=>V._getType()==="system"?{id:K(),content:`${V.content}`,role:"system",data:{injectedMessage:!0}}:V._getType()==="human"?{id:K(),content:`${V.content}`,role:"user",data:{injectedMessage:!0}}:{id:K(),content:`${V.content}`,role:"assistant",data:{injectedMessage:!0}})])},onResponseMessageCreate:T=>{B(A=>[...A,{id:I,content:T||"",role:"assistant"}])},onMessageUpdate:T=>{B(A=>{const V=[...A],b=V.findIndex(U=>U.id===I);return b!==-1&&(V[b]={...V[b],content:T.nodeData.content||""}),V}),s.current&&r()}}),B(T=>(M(T),T)),i(!1),R(""),s.current&&r(),new Response}finally{i(!1)}}}),m=n.useRef(null);n.useEffect(()=>{const D=L(x=>{B(x||[]),r()});return()=>{D()}},[B,L,r]);const u=async(D,x)=>(i(!0),await G(x),!0),g=n.useCallback(async(D,x)=>{if(D==="Refresh"){i(!0);try{await j()}finally{i(!1)}}D==="Copy"&&x&&x.role==="assistant"&&navigator.clipboard.writeText(x.content),D==="Volume"&&(x!=null&&x.content)&&await ta.speak((x==null?void 0:x.content)||"")},[j]),k=n.useCallback(()=>s.current=!1,[]),O=n.useMemo(()=>C&&C.map((D,x)=>a.jsx(je,{message:D,index:x,isLastMessage:x===C.length-1,isGenerating:d,isSchema:!!l,onActionClick:g},D.id||`${x}`)),[C,d,l,g]);return a.jsxs(Ea,{onClick:k,className:"max-h-full !overflow-hidden !min-h-full",style:{minHeight:"unset"},defaultOpen:!0,children:[a.jsx(Ma,{className:"!max-h-full !overflow-hidden",style:{minHeight:"unset"},children:a.jsxs("main",{className:"flex h-full w-full max-w-2xl flex-col items-center mx-auto overflow-hidden",children:[a.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden min-w-full max-w-full",children:a.jsx(le,{className:"!max-h-full",ref:m,children:O})}),a.jsx(Oa,{className:"!max-w-2xl px-4",onSubmit:u,disabled:N||d||(w==null?void 0:w.status)!==J.Loaded,placeholder:e("chat.input_message_placeholder"),value:_,onChange:$})]})}),a.jsx(He,{schema:l,currentDataNode:o,threadNode:h==null?void 0:h.threadNode,loadLLM:y,mainLLMInfo:w,mainEmbeddingInfo:c.mainEmbeddingInfo,retriverInfo:f,onAddNewThread:v,onSelectThread:t,changeLLMOptions:P,setLLMInfo:p})]})})});export{nt as __tla,Ae as default};
