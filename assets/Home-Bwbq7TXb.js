const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CTcNp3aO.js","assets/LLMIcon-8SFnyBlJ.js","assets/index-Dm1R2z7R.js","assets/index-BHmW4Jet.css","assets/routes-BQtx4Swg.js","assets/dot-C-EbcjRb.js","assets/createLucideIcon-B-o_1Xz_.js","assets/pdf.min-C2SM6UYQ.js","assets/pdf.worker.min-BeMNPJVi.js","assets/index-C7yn_S32.js","assets/toNumber-BU9jO53P.js","assets/use-prevent-pitch-zoom-CRhJfjI7.js","assets/index-Ck543mmG.js","assets/index-CkK3dOa3.js","assets/index-BohVFg5g.js","assets/link-bqe1Soi3.js","assets/trash-2-Dr3QpDM-.js","assets/index-uPlhTHZf.js","assets/index-uEu2-lE9.js","assets/text-MCiekkJt.js","assets/external-link-D2Xo9RJm.js","assets/unlink-OnIkTQZo.js","assets/index-yTRa8vdE.js","assets/list-DuaSjwBt.js","assets/list-ordered-mMDsLiZN.js","assets/list-todo-Dq7PpD_H.js","assets/indent-increase-C9QTNXko.js","assets/pilcrow-Bx8qynvh.js","assets/heading-1-CZgiY8ue.js","assets/heading-2-BB43o2Kt.js","assets/heading-3-B-YlK6Ff.js","assets/table-CbZ3iAJn.js","assets/file-code-4L9yKPn_.js","assets/quote-BbRTHGm6.js","assets/minus-DN2hKd9J.js","assets/square-C9ktdT6z.js","assets/chevron-right-Y8OgkNl0.js","assets/image-CVdmAATJ.js","assets/table-of-contents-DhgboIYf.js","assets/columns-3-L0ibrh0z.js","assets/link-2-CDJfwbyV.js","assets/calendar-N2btT5Id.js","assets/plus-DrOgU6bW.js","assets/wrap-text-DcONBKlN.js","assets/pen-B5wcFn9n.js","assets/eye-BBp876to.js","assets/indent-decrease-ClI4GXwo.js","assets/pointer-DNpfDgLY.js","assets/wand-sparkles-aw-DUdGk.js","assets/bold-CQUo-EMw.js","assets/italic-BNNmeTK6.js","assets/underline-Bw0uuFTR.js","assets/strikethrough-_273d5T8.js","assets/code-xml-DG_uqMCL.js","assets/baseline-C7YVdYxi.js","assets/paint-bucket-aju9mTrs.js","assets/arrow-up-to-line-DW3l_5dH.js","assets/index-BCYu3EnN.css","assets/CodeContainerApp-CJLJkU9g.js","assets/file-tree-JWOQ6MD3.js","assets/chunk-GdREbNHQ.js","assets/popover-Cui8Ka4E.js","assets/index-yeDnoptH.js","assets/objectWithoutPropertiesLoose-BjXSgPXB.js","assets/index-HBk6v5Fv.js","assets/check-CjRNSoFn.js","assets/circle-PgwYZjSO.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{a3 as bn,r as d,a2 as jn,ae as fo,a5 as Nn,af as go,ag as Cn,ah as xo,ai as Qt,aj as Sn,ak as _o,al as yo,y as vo,c as wo,b as bo,j as e,P as Ne,f as jo,d as Se,g as q,L as $,Q as No,am as Co,U as So,q as ee,w as T,$ as j,s as xt,t as Te,o as H,a9 as _t,v as ge,_ as xe,x as yt,an as qe,N as Eo,a1 as nt,E as En,ao as ko,ap as Mo,C as Lo,aq as Do,a0 as kn,ar as Io,p as Mn,h as Ln,as as To,at as Ao,__tla as Oo}from"./index-Dm1R2z7R.js";import{h as Fo,i as Ro,j as ie,R as Dn,L as vt,A as ve,C as te,k as oe,l as ue,m as de,S as Ee,n as ke,o as Me,p as Le,q as me,r as Ae,s as Po,t as $o,v as Vo,w as Ho,x as In,y as Tn,z as wt,E as ea,G as An,H as ta,J as we,K as zo,N as W,O as bt,Q as Bo,U as Oe,X as rt,g as Uo,Y as On,u as aa,F as it,P as qo,Z as Fn,_ as Rn,B as Be,M as Go,$ as Wo,a0 as Jo,b as Pn,d as $n,e as Ge,T as We,D as sa,a1 as Vn,a2 as jt,c as Hn,W as Ko,I as Xo,a as Zo,V as Yo,a3 as Qo,a4 as na,a5 as ed,a6 as td,a7 as ad,a8 as sd,a9 as nd,aa as rd,ab as id,ac as od,ad as dd,ae as ld,af as cd,ag as ud,__tla as md}from"./chunk-GdREbNHQ.js";import{b1 as pd,ap as zn,aq as hd,as as fd,at as gd,b2 as xd,b3 as _d,b4 as yd,b5 as vd,b6 as wd,b7 as bd,b8 as jd,b9 as Nd,ba as Cd,bb as Sd,bc as Ed,bd as kd,be as Md,ar as De,bf as Ld,bg as Dd,bh as Id,bi as Td,bj as Ad,bk as Od,j as Nt,k as Ct,l as St,m as Et,E as Bn,F as Un,B as Y,z as ot,an as B,ao as pe,L as Ie,bl as ra,bm as Fd,bn as Rd,V as Fe,bo as qn,bp as Pd,bq as $d,br as Vd,A as kt,H as Je,bs as Gn,S as Wn,bt as ia,i as oa,bu as da,aj as Hd,D as Jn,aZ as zd,a_ as la,a$ as ca,b0 as ua,bv as Kn,__tla as Bd}from"./routes-BQtx4Swg.js";import{i as J,L as le,j as Mt,k as Ud,l as Xn,m as Ke,n as qd,o as Gd,q as Zn,a as Wd,f as Yn,c as Re,r as Jd,u as Kd,I as ma,b as pa,s as Xd,d as Zd,h as Yd,__tla as Qd}from"./LLMIcon-8SFnyBlJ.js";import{P as Qn,b as er,T as dt,A as el,a as tl,__tla as al}from"./popover-Cui8Ka4E.js";import{a as sl,__tla as nl}from"./index-BohVFg5g.js";import{s as rl}from"./toNumber-BU9jO53P.js";import{R as tr,I as il,a as ar,b as sr,c as nr,__tla as ol}from"./index-uEu2-lE9.js";import{p as dl,a as ll,u as cl}from"./file-tree-JWOQ6MD3.js";let ha,rr,se,A,ul=Promise.all([(()=>{try{return Oo}catch{}})(),(()=>{try{return md}catch{}})(),(()=>{try{return Bd}catch{}})(),(()=>{try{return Qd}catch{}})(),(()=>{try{return al}catch{}})(),(()=>{try{return nl}catch{}})(),(()=>{try{return ol}catch{}})()]).then(async()=>{function Lt(t){const n=bn(()=>fo(t)),{isStatic:a}=d.useContext(jn);if(a){const[,r]=d.useState(t);d.useEffect(()=>n.on("change",r),[])}return n}function fa(t,n){const a=Lt(n()),r=()=>a.set(n());return r(),Nn(()=>{const s=()=>Cn.preRender(r,!1,!0),o=t.map(i=>i.on("change",s));return()=>{o.forEach(i=>i()),go(r)}}),a}const ir=t=>t&&typeof t=="object"&&t.mix,or=t=>ir(t)?t.mix:void 0;function dr(...t){const n=!Array.isArray(t[0]),a=n?0:-1,r=t[0+a],s=t[1+a],o=t[2+a],i=t[3+a],l=xo(s,o,{mixer:or(o[0]),...i});return n?l(r):l}function lr(t){Qt.current=[],t();const n=fa(Qt.current,t);return Qt.current=void 0,n}function ga(t,n,a,r){if(typeof t=="function")return lr(t);const s=typeof n=="function"?n:dr(n,a,r);return Array.isArray(t)?xa(t,s):xa([t],([o])=>s(o))}function xa(t,n){const a=bn(()=>[]);return fa(t,()=>{a.length=0;const r=t.length;for(let s=0;s<r;s++)a[s]=t[s].get();return n(a)})}function _a(t){return typeof t=="number"?t:parseFloat(t)}function cr(t,n={}){const{isStatic:a}=d.useContext(jn),r=d.useRef(null),s=Lt(Sn(t)?_a(t.get()):t),o=d.useRef(s.get()),i=d.useRef(()=>{}),l=()=>{const u=r.current;u&&u.time===0&&u.sample(_o.delta),c(),r.current=yo({keyframes:[s.get(),o.current],velocity:s.getVelocity(),type:"spring",restDelta:.001,restSpeed:.01,...n,onUpdate:i.current})},c=()=>{r.current&&r.current.stop()};return d.useInsertionEffect(()=>s.attach((u,p)=>a?p(u):(o.current=u,i.current=p,Cn.update(l),s.get()),c),[JSON.stringify(n)]),Nn(()=>{if(Sn(t))return t.on("change",u=>s.set(_a(u)))},[s]),s}var _e=(t=>(t.Started="started",t.Inprogress="inprogress",t.Success="success",t.Failed="failed",t))(_e||{}),he=(t=>(t.Human="human",t.User="user",t.AI="ai",t.System="system",t.Assistant="assistant",t.Tool="tool",t.FewShotExample="few_shot_example",t))(he||{}),lt=(t=>(t.Started="started",t.Inprogress="inprogress",t.Done="done",t))(lt||{}),fe=(t=>(t.Chat="chat",t.FewShotExample="few_shot_example",t))(fe||{}),ct="Menubar",[Dt,ur,mr]=vo(ct),[ya,ml]=wo(ct,[mr,zn]),ne=pd(),va=zn(),[pr,It]=ya(ct),wa=d.forwardRef((t,n)=>{const{__scopeMenubar:a,value:r,onValueChange:s,defaultValue:o,loop:i=!0,dir:l,...c}=t,u=hd(l),p=va(a),[m="",h]=bo({prop:r,onChange:s,defaultProp:o}),[x,f]=d.useState(null);return e.jsx(pr,{scope:a,value:m,onMenuOpen:d.useCallback(g=>{h(g),f(g)},[h]),onMenuClose:d.useCallback(()=>h(""),[h]),onMenuToggle:d.useCallback(g=>{h(_=>_?"":g),f(g)},[h]),dir:u,loop:i,children:e.jsx(Dt.Provider,{scope:a,children:e.jsx(Dt.Slot,{scope:a,children:e.jsx(fd,{asChild:!0,...p,orientation:"horizontal",loop:i,dir:u,currentTabStopId:x,onCurrentTabStopIdChange:f,children:e.jsx(Ne.div,{role:"menubar",...c,ref:n})})})})})});wa.displayName=ct;var Tt="MenubarMenu",[hr,ba]=ya(Tt),ja=t=>{const{__scopeMenubar:n,value:a,...r}=t,s=De(),o=a||s||"LEGACY_REACT_AUTO_VALUE",i=It(Tt,n),l=ne(n),c=d.useRef(null),u=d.useRef(!1),p=i.value===o;return d.useEffect(()=>{p||(u.current=!1)},[p]),e.jsx(hr,{scope:n,value:o,triggerId:De(),triggerRef:c,contentId:De(),wasKeyboardTriggerOpenRef:u,children:e.jsx(Ld,{...l,open:p,onOpenChange:m=>{m||i.onMenuClose()},modal:!1,dir:i.dir,...r})})};ja.displayName=Tt;var At="MenubarTrigger",Na=d.forwardRef((t,n)=>{const{__scopeMenubar:a,disabled:r=!1,...s}=t,o=va(a),i=ne(a),l=It(At,a),c=ba(At,a),u=d.useRef(null),p=jo(n,u,c.triggerRef),[m,h]=d.useState(!1),x=l.value===c.value;return e.jsx(Dt.ItemSlot,{scope:a,value:c.value,disabled:r,children:e.jsx(gd,{asChild:!0,...o,focusable:!r,tabStopId:c.value,children:e.jsx(xd,{asChild:!0,...i,children:e.jsx(Ne.button,{type:"button",role:"menuitem",id:c.triggerId,"aria-haspopup":"menu","aria-expanded":x,"aria-controls":x?c.contentId:void 0,"data-highlighted":m?"":void 0,"data-state":x?"open":"closed","data-disabled":r?"":void 0,disabled:r,...s,ref:p,onPointerDown:Se(t.onPointerDown,f=>{!r&&f.button===0&&f.ctrlKey===!1&&(l.onMenuOpen(c.value),x||f.preventDefault())}),onPointerEnter:Se(t.onPointerEnter,()=>{var f;l.value&&!x&&(l.onMenuOpen(c.value),(f=u.current)==null||f.focus())}),onKeyDown:Se(t.onKeyDown,f=>{r||(["Enter"," "].includes(f.key)&&l.onMenuToggle(c.value),f.key==="ArrowDown"&&l.onMenuOpen(c.value),["Enter"," ","ArrowDown"].includes(f.key)&&(c.wasKeyboardTriggerOpenRef.current=!0,f.preventDefault()))}),onFocus:Se(t.onFocus,()=>h(!0)),onBlur:Se(t.onBlur,()=>h(!1))})})})})});Na.displayName=At;var fr="MenubarPortal",Ca=t=>{const{__scopeMenubar:n,...a}=t,r=ne(n);return e.jsx(Dd,{...r,...a})};Ca.displayName=fr;var Ot="MenubarContent",Sa=d.forwardRef((t,n)=>{const{__scopeMenubar:a,align:r="start",...s}=t,o=ne(a),i=It(Ot,a),l=ba(Ot,a),c=ur(a),u=d.useRef(!1);return e.jsx(_d,{id:l.contentId,"aria-labelledby":l.triggerId,"data-radix-menubar-content":"",...o,...s,ref:n,align:r,onCloseAutoFocus:Se(t.onCloseAutoFocus,p=>{var m;!i.value&&!u.current&&((m=l.triggerRef.current)==null||m.focus()),u.current=!1,p.preventDefault()}),onFocusOutside:Se(t.onFocusOutside,p=>{const m=p.target;c().some(h=>{var x;return(x=h.ref.current)==null?void 0:x.contains(m)})&&p.preventDefault()}),onInteractOutside:Se(t.onInteractOutside,()=>{u.current=!0}),onEntryFocus:p=>{l.wasKeyboardTriggerOpenRef.current||p.preventDefault()},onKeyDown:Se(t.onKeyDown,p=>{if(["ArrowRight","ArrowLeft"].includes(p.key)){const m=p.target,h=m.hasAttribute("data-radix-menubar-subtrigger"),x=m.closest("[data-radix-menubar-content]")!==p.currentTarget,f=(i.dir==="rtl"?"ArrowRight":"ArrowLeft")===p.key;if(!f&&h||x&&f)return;let g=c().filter(M=>!M.disabled).map(M=>M.value);f&&g.reverse();const _=g.indexOf(l.value);g=i.loop?Lr(g,_+1):g.slice(_+1);const[y]=g;y&&i.onMenuOpen(y)}},{checkForDefaultPrevented:!1}),style:{...t.style,"--radix-menubar-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-menubar-content-available-width":"var(--radix-popper-available-width)","--radix-menubar-content-available-height":"var(--radix-popper-available-height)","--radix-menubar-trigger-width":"var(--radix-popper-anchor-width)","--radix-menubar-trigger-height":"var(--radix-popper-anchor-height)"}})});Sa.displayName=Ot;var gr="MenubarGroup",xr=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(yd,{...s,...r,ref:n})});xr.displayName=gr;var _r="MenubarLabel",Ea=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(vd,{...s,...r,ref:n})});Ea.displayName=_r;var yr="MenubarItem",ka=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(wd,{...s,...r,ref:n})});ka.displayName=yr;var vr="MenubarCheckboxItem",Ma=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(bd,{...s,...r,ref:n})});Ma.displayName=vr;var wr="MenubarRadioGroup",br=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(jd,{...s,...r,ref:n})});br.displayName=wr;var jr="MenubarRadioItem",La=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(Nd,{...s,...r,ref:n})});La.displayName=jr;var Nr="MenubarItemIndicator",Da=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(Cd,{...s,...r,ref:n})});Da.displayName=Nr;var Cr="MenubarSeparator",Ia=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(Sd,{...s,...r,ref:n})});Ia.displayName=Cr;var Sr="MenubarArrow",Er=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(Ed,{...s,...r,ref:n})});Er.displayName=Sr;var kr="MenubarSubTrigger",Ta=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(kd,{"data-radix-menubar-subtrigger":"",...s,...r,ref:n})});Ta.displayName=kr;var Mr="MenubarSubContent",Aa=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ne(a);return e.jsx(Md,{...s,"data-radix-menubar-content":"",...r,ref:n,style:{...t.style,"--radix-menubar-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-menubar-content-available-width":"var(--radix-popper-available-width)","--radix-menubar-content-available-height":"var(--radix-popper-available-height)","--radix-menubar-trigger-width":"var(--radix-popper-anchor-width)","--radix-menubar-trigger-height":"var(--radix-popper-anchor-height)"}})});Aa.displayName=Mr;function Lr(t,n){return t.map((a,r)=>t[(n+r)%t.length])}var Oa=wa,Dr=ja,Fa=Na,Ir=Ca,Ra=Sa,Pa=Ea,$a=ka,Va=Ma,Ha=La,za=Da,Ba=Ia,Ua=Ta,qa=Aa;const Ft=Dr,Ga=d.forwardRef(({className:t,...n},a)=>e.jsx(Oa,{ref:a,className:q("flex h-10 items-center space-x-1 rounded-md border bg-background p-1",t),...n}));Ga.displayName=Oa.displayName;const Rt=d.forwardRef(({className:t,...n},a)=>e.jsx(Fa,{ref:a,className:q("flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",t),...n}));Rt.displayName=Fa.displayName;const Tr=d.forwardRef(({className:t,inset:n,children:a,...r},s)=>e.jsxs(Ua,{ref:s,className:q("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",n&&"pl-8",t),...r,children:[a,e.jsx($,{name:"chevron-right",className:"ml-auto h-4 w-4"})]}));Tr.displayName=Ua.displayName;const Ar=d.forwardRef(({className:t,...n},a)=>e.jsx(qa,{ref:a,className:q("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...n}));Ar.displayName=qa.displayName;const Wa=d.forwardRef(({className:t,align:n="start",alignOffset:a=-4,sideOffset:r=8,...s},o)=>e.jsx(Ir,{children:e.jsx(Ra,{ref:o,align:n,alignOffset:a,sideOffset:r,className:q("z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s})}));Wa.displayName=Ra.displayName;const Ja=d.forwardRef(({className:t,inset:n,...a},r)=>e.jsx($a,{ref:r,className:q("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n&&"pl-8",t),...a}));Ja.displayName=$a.displayName;const Or=d.forwardRef(({className:t,children:n,checked:a,...r},s)=>e.jsxs(Va,{ref:s,className:q("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),checked:a,...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(za,{children:e.jsx($,{name:"check",className:"h-4 w-4"})})}),n]}));Or.displayName=Va.displayName;const Fr=d.forwardRef(({className:t,children:n,...a},r)=>e.jsxs(Ha,{ref:r,className:q("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(za,{children:e.jsx($,{name:"circle",className:"h-2 w-2 fill-current"})})}),n]}));Fr.displayName=Ha.displayName;const Rr=d.forwardRef(({className:t,inset:n,...a},r)=>e.jsx(Pa,{ref:r,className:q("px-2 py-1.5 text-sm font-semibold",n&&"pl-8",t),...a}));Rr.displayName=Pa.displayName;const Pr=d.forwardRef(({className:t,...n},a)=>e.jsx(Ba,{ref:a,className:q("-mx-1 my-1 h-px bg-muted",t),...n}));Pr.displayName=Ba.displayName;let Ka;A=No()(Co(So((t,n)=>({...Fo,...Ro(t,n)})))),Ka=()=>{const t=ee(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=A(i=>i.pushSyncNodeQueue),s=A(i=>i.createOrUpdateFlowNode),o=d.useCallback(async(i,l)=>{try{if(!t)throw new Error("Session not found");if(!l.provider||!l.name)throw new Error("Provider and name are required");a(!0);const c=await T("LLM").findOne({where:{name:l.name,session_id:t}});return c?(r("LLM",{where:{source_type:"LLM",source_id:c.id}}),c):T("LLM").save({name:`${l.name}`,status:l.provider===J.WebLLM?le.Started:le.Loaded,session_id:t,provider:l.provider,metadata:JSON.stringify(l.metadata||{}),model_type:l.model_type||Mt.LLM,parameters:l.parameters||void 0,encrypted:l.encrypted||void 0,...l}).then(async u=>{var p,m,h;return await s({source_id:u.id,source_type:"LLM",node_type:j.LLM,x:(p=i.position)==null?void 0:p.x,y:((m=i.position)==null?void 0:m.y)+(((h=i.measured)==null?void 0:h.height)||0)+30}),u})}finally{a(!1)}},[s,r,t]);return{loading:n,createLLM:o}};var Xa=1,$r=.9,Vr=.8,Hr=.17,Pt=.1,$t=.999,zr=.9999,Br=.99,Ur=/[\\\/_+.#"@\[\(\{&]/,qr=/[\\\/_+.#"@\[\(\{&]/g,Gr=/[\s-]/,Za=/[\s-]/g;function Vt(t,n,a,r,s,o,i){if(o===n.length)return s===t.length?Xa:Br;var l=`${s},${o}`;if(i[l]!==void 0)return i[l];for(var c=r.charAt(o),u=a.indexOf(c,s),p=0,m,h,x,f;u>=0;)m=Vt(t,n,a,r,u+1,o+1,i),m>p&&(u===s?m*=Xa:Ur.test(t.charAt(u-1))?(m*=Vr,x=t.slice(s,u-1).match(qr),x&&s>0&&(m*=Math.pow($t,x.length))):Gr.test(t.charAt(u-1))?(m*=$r,f=t.slice(s,u-1).match(Za),f&&s>0&&(m*=Math.pow($t,f.length))):(m*=Hr,s>0&&(m*=Math.pow($t,u-s))),t.charAt(u)!==n.charAt(o)&&(m*=zr)),(m<Pt&&a.charAt(u-1)===r.charAt(o+1)||r.charAt(o+1)===r.charAt(o)&&a.charAt(u-1)!==r.charAt(o))&&(h=Vt(t,n,a,r,u+1,o+2,i),h*Pt>m&&(m=h*Pt)),m>p&&(p=m),u=a.indexOf(c,u+1);return i[l]=p,p}function Ya(t){return t.toLowerCase().replace(Za," ")}function Wr(t,n,a){return t=a&&a.length>0?`${t+" "+a.join(" ")}`:t,Vt(t,n,Ya(t),Ya(n),0,0,{})}var Xe='[cmdk-group=""]',Ht='[cmdk-group-items=""]',Jr='[cmdk-group-heading=""]',zt='[cmdk-item=""]',Qa=`${zt}:not([aria-disabled="true"])`,Bt="cmdk-item-select",Pe="data-value",Kr=(t,n,a)=>Wr(t,n,a),es=d.createContext(void 0),Ze=()=>d.useContext(es),ts=d.createContext(void 0),Ut=()=>d.useContext(ts),as=d.createContext(void 0),ss=d.forwardRef((t,n)=>{let a=Ue(()=>{var S,P;return{search:"",value:(P=(S=t.value)!=null?S:t.defaultValue)!=null?P:"",filtered:{count:0,items:new Map,groups:new Set}}}),r=Ue(()=>new Set),s=Ue(()=>new Map),o=Ue(()=>new Map),i=Ue(()=>new Set),l=ns(t),{label:c,children:u,value:p,onValueChange:m,filter:h,shouldFilter:x,loop:f,disablePointerSelection:g=!1,vimBindings:_=!0,...y}=t,M=De(),D=De(),b=De(),E=d.useRef(null),v=ii();$e(()=>{if(p!==void 0){let S=p.trim();a.current.value=S,N.emit()}},[p]),$e(()=>{v(6,F)},[]);let N=d.useMemo(()=>({subscribe:S=>(i.current.add(S),()=>i.current.delete(S)),snapshot:()=>a.current,setState:(S,P,w)=>{var k,z,X;if(!Object.is(a.current[S],P)){if(a.current[S]=P,S==="search")I(),V(),v(1,L);else if(S==="value"&&(w||v(5,F),((k=l.current)==null?void 0:k.value)!==void 0)){let re=P??"";(X=(z=l.current).onValueChange)==null||X.call(z,re);return}N.emit()}},emit:()=>{i.current.forEach(S=>S())}}),[]),O=d.useMemo(()=>({value:(S,P,w)=>{var k;P!==((k=o.current.get(S))==null?void 0:k.value)&&(o.current.set(S,{value:P,keywords:w}),a.current.filtered.items.set(S,U(P,w)),v(2,()=>{V(),N.emit()}))},item:(S,P)=>(r.current.add(S),P&&(s.current.has(P)?s.current.get(P).add(S):s.current.set(P,new Set([S]))),v(3,()=>{I(),V(),a.current.value||L(),N.emit()}),()=>{o.current.delete(S),r.current.delete(S),a.current.filtered.items.delete(S);let w=C();v(4,()=>{I(),(w==null?void 0:w.getAttribute("id"))===S&&L(),N.emit()})}),group:S=>(s.current.has(S)||s.current.set(S,new Set),()=>{o.current.delete(S),s.current.delete(S)}),filter:()=>l.current.shouldFilter,label:c||t["aria-label"],getDisablePointerSelection:()=>l.current.disablePointerSelection,listId:M,inputId:b,labelId:D,listInnerRef:E}),[]);function U(S,P){var w,k;let z=(k=(w=l.current)==null?void 0:w.filter)!=null?k:Kr;return S?z(S,a.current.search,P):0}function V(){if(!a.current.search||l.current.shouldFilter===!1)return;let S=a.current.filtered.items,P=[];a.current.filtered.groups.forEach(k=>{let z=s.current.get(k),X=0;z.forEach(re=>{let je=S.get(re);X=Math.max(je,X)}),P.push([k,X])});let w=E.current;R().sort((k,z)=>{var X,re;let je=k.getAttribute("id"),ze=z.getAttribute("id");return((X=S.get(ze))!=null?X:0)-((re=S.get(je))!=null?re:0)}).forEach(k=>{let z=k.closest(Ht);z?z.appendChild(k.parentElement===z?k:k.closest(`${Ht} > *`)):w.appendChild(k.parentElement===w?k:k.closest(`${Ht} > *`))}),P.sort((k,z)=>z[1]-k[1]).forEach(k=>{var z;let X=(z=E.current)==null?void 0:z.querySelector(`${Xe}[${Pe}="${encodeURIComponent(k[0])}"]`);X==null||X.parentElement.appendChild(X)})}function L(){let S=R().find(w=>w.getAttribute("aria-disabled")!=="true"),P=S==null?void 0:S.getAttribute(Pe);N.setState("value",P||void 0)}function I(){var S,P,w,k;if(!a.current.search||l.current.shouldFilter===!1){a.current.filtered.count=r.current.size;return}a.current.filtered.groups=new Set;let z=0;for(let X of r.current){let re=(P=(S=o.current.get(X))==null?void 0:S.value)!=null?P:"",je=(k=(w=o.current.get(X))==null?void 0:w.keywords)!=null?k:[],ze=U(re,je);a.current.filtered.items.set(X,ze),ze>0&&z++}for(let[X,re]of s.current)for(let je of re)if(a.current.filtered.items.get(je)>0){a.current.filtered.groups.add(X);break}a.current.filtered.count=z}function F(){var S,P,w;let k=C();k&&(((S=k.parentElement)==null?void 0:S.firstChild)===k&&((w=(P=k.closest(Xe))==null?void 0:P.querySelector(Jr))==null||w.scrollIntoView({block:"nearest"})),k.scrollIntoView({block:"nearest"}))}function C(){var S;return(S=E.current)==null?void 0:S.querySelector(`${zt}[aria-selected="true"]`)}function R(){var S;return Array.from(((S=E.current)==null?void 0:S.querySelectorAll(Qa))||[])}function Z(S){let P=R()[S];P&&N.setState("value",P.getAttribute(Pe))}function K(S){var P;let w=C(),k=R(),z=k.findIndex(re=>re===w),X=k[z+S];(P=l.current)!=null&&P.loop&&(X=z+S<0?k[k.length-1]:z+S===k.length?k[0]:k[z+S]),X&&N.setState("value",X.getAttribute(Pe))}function Q(S){let P=C(),w=P==null?void 0:P.closest(Xe),k;for(;w&&!k;)w=S>0?ni(w,Xe):ri(w,Xe),k=w==null?void 0:w.querySelector(Qa);k?N.setState("value",k.getAttribute(Pe)):K(S)}let be=()=>Z(R().length-1),He=S=>{S.preventDefault(),S.metaKey?be():S.altKey?Q(1):K(1)},ye=S=>{S.preventDefault(),S.metaKey?Z(0):S.altKey?Q(-1):K(-1)};return d.createElement(Ne.div,{ref:n,tabIndex:-1,...y,"cmdk-root":"",onKeyDown:S=>{var P;if((P=y.onKeyDown)==null||P.call(y,S),!S.defaultPrevented)switch(S.key){case"n":case"j":{_&&S.ctrlKey&&He(S);break}case"ArrowDown":{He(S);break}case"p":case"k":{_&&S.ctrlKey&&ye(S);break}case"ArrowUp":{ye(S);break}case"Home":{S.preventDefault(),Z(0);break}case"End":{S.preventDefault(),be();break}case"Enter":if(!S.nativeEvent.isComposing&&S.keyCode!==229){S.preventDefault();let w=C();if(w){let k=new Event(Bt);w.dispatchEvent(k)}}}}},d.createElement("label",{"cmdk-label":"",htmlFor:O.inputId,id:O.labelId,style:di},c),ut(t,S=>d.createElement(ts.Provider,{value:N},d.createElement(es.Provider,{value:O},S))))}),Xr=d.forwardRef((t,n)=>{var a,r;let s=De(),o=d.useRef(null),i=d.useContext(as),l=Ze(),c=ns(t),u=(r=(a=c.current)==null?void 0:a.forceMount)!=null?r:i==null?void 0:i.forceMount;$e(()=>{if(!u)return l.item(s,i==null?void 0:i.id)},[u]);let p=rs(s,o,[t.value,t.children,o],t.keywords),m=Ut(),h=Ve(v=>v.value&&v.value===p.current),x=Ve(v=>u||l.filter()===!1?!0:v.search?v.filtered.items.get(s)>0:!0);d.useEffect(()=>{let v=o.current;if(!(!v||t.disabled))return v.addEventListener(Bt,f),()=>v.removeEventListener(Bt,f)},[x,t.onSelect,t.disabled]);function f(){var v,N;g(),(N=(v=c.current).onSelect)==null||N.call(v,p.current)}function g(){m.setState("value",p.current,!0)}if(!x)return null;let{disabled:_,value:y,onSelect:M,forceMount:D,keywords:b,...E}=t;return d.createElement(Ne.div,{ref:Ye([o,n]),...E,id:s,"cmdk-item":"",role:"option","aria-disabled":!!_,"aria-selected":!!h,"data-disabled":!!_,"data-selected":!!h,onPointerMove:_||l.getDisablePointerSelection()?void 0:g,onClick:_?void 0:f},t.children)}),Zr=d.forwardRef((t,n)=>{let{heading:a,children:r,forceMount:s,...o}=t,i=De(),l=d.useRef(null),c=d.useRef(null),u=De(),p=Ze(),m=Ve(x=>s||p.filter()===!1?!0:x.search?x.filtered.groups.has(i):!0);$e(()=>p.group(i),[]),rs(i,l,[t.value,t.heading,c]);let h=d.useMemo(()=>({id:i,forceMount:s}),[s]);return d.createElement(Ne.div,{ref:Ye([l,n]),...o,"cmdk-group":"",role:"presentation",hidden:m?void 0:!0},a&&d.createElement("div",{ref:c,"cmdk-group-heading":"","aria-hidden":!0,id:u},a),ut(t,x=>d.createElement("div",{"cmdk-group-items":"",role:"group","aria-labelledby":a?u:void 0},d.createElement(as.Provider,{value:h},x))))}),Yr=d.forwardRef((t,n)=>{let{alwaysRender:a,...r}=t,s=d.useRef(null),o=Ve(i=>!i.search);return!a&&!o?null:d.createElement(Ne.div,{ref:Ye([s,n]),...r,"cmdk-separator":"",role:"separator"})}),Qr=d.forwardRef((t,n)=>{let{onValueChange:a,...r}=t,s=t.value!=null,o=Ut(),i=Ve(p=>p.search),l=Ve(p=>p.value),c=Ze(),u=d.useMemo(()=>{var p;let m=(p=c.listInnerRef.current)==null?void 0:p.querySelector(`${zt}[${Pe}="${encodeURIComponent(l)}"]`);return m==null?void 0:m.getAttribute("id")},[]);return d.useEffect(()=>{t.value!=null&&o.setState("search",t.value)},[t.value]),d.createElement(Ne.input,{ref:n,...r,"cmdk-input":"",autoComplete:"off",autoCorrect:"off",spellCheck:!1,"aria-autocomplete":"list",role:"combobox","aria-expanded":!0,"aria-controls":c.listId,"aria-labelledby":c.labelId,"aria-activedescendant":u,id:c.inputId,type:"text",value:s?t.value:i,onChange:p=>{s||o.setState("search",p.target.value),a==null||a(p.target.value)}})}),ei=d.forwardRef((t,n)=>{let{children:a,label:r="Suggestions",...s}=t,o=d.useRef(null),i=d.useRef(null),l=Ze();return d.useEffect(()=>{if(i.current&&o.current){let c=i.current,u=o.current,p,m=new ResizeObserver(()=>{p=requestAnimationFrame(()=>{let h=c.offsetHeight;u.style.setProperty("--cmdk-list-height",h.toFixed(1)+"px")})});return m.observe(c),()=>{cancelAnimationFrame(p),m.unobserve(c)}}},[]),d.createElement(Ne.div,{ref:Ye([o,n]),...s,"cmdk-list":"",role:"listbox","aria-label":r,id:l.listId},ut(t,c=>d.createElement("div",{ref:Ye([i,l.listInnerRef]),"cmdk-list-sizer":""},c)))}),ti=d.forwardRef((t,n)=>{let{open:a,onOpenChange:r,overlayClassName:s,contentClassName:o,container:i,...l}=t;return d.createElement(Id,{open:a,onOpenChange:r},d.createElement(Td,{container:i},d.createElement(Ad,{"cmdk-overlay":"",className:s}),d.createElement(Od,{"aria-label":t.label,"cmdk-dialog":"",className:o},d.createElement(ss,{ref:n,...l}))))}),ai=d.forwardRef((t,n)=>Ve(a=>a.filtered.count===0)?d.createElement(Ne.div,{ref:n,...t,"cmdk-empty":"",role:"presentation"}):null),si=d.forwardRef((t,n)=>{let{progress:a,children:r,label:s="Loading...",...o}=t;return d.createElement(Ne.div,{ref:n,...o,"cmdk-loading":"",role:"progressbar","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":100,"aria-label":s},ut(t,i=>d.createElement("div",{"aria-hidden":!0},i)))}),ce=Object.assign(ss,{List:ei,Item:Xr,Input:Qr,Group:Zr,Separator:Yr,Dialog:ti,Empty:ai,Loading:si});function ni(t,n){let a=t.nextElementSibling;for(;a;){if(a.matches(n))return a;a=a.nextElementSibling}}function ri(t,n){let a=t.previousElementSibling;for(;a;){if(a.matches(n))return a;a=a.previousElementSibling}}function ns(t){let n=d.useRef(t);return $e(()=>{n.current=t}),n}var $e=typeof window>"u"?d.useEffect:d.useLayoutEffect;function Ue(t){let n=d.useRef();return n.current===void 0&&(n.current=t()),n}function Ye(t){return n=>{t.forEach(a=>{typeof a=="function"?a(n):a!=null&&(a.current=n)})}}function Ve(t){let n=Ut(),a=()=>t(n.snapshot());return rl.useSyncExternalStore(n.subscribe,a,a)}function rs(t,n,a,r=[]){let s=d.useRef(),o=Ze();return $e(()=>{var i;let l=(()=>{var u;for(let p of a){if(typeof p=="string")return p.trim();if(typeof p=="object"&&"current"in p)return p.current?(u=p.current.textContent)==null?void 0:u.trim():s.current}})(),c=r.map(u=>u.trim());o.value(t,l,c),(i=n.current)==null||i.setAttribute(Pe,l),s.current=l}),s}var ii=()=>{let[t,n]=d.useState(),a=Ue(()=>new Map);return $e(()=>{a.current.forEach(r=>r()),a.current=new Map},[t]),(r,s)=>{a.current.set(r,s),n({})}};function oi(t){let n=t.type;return typeof n=="function"?n(t.props):"render"in n?n.render(t.props):t}function ut({asChild:t,children:n},a){return t&&d.isValidElement(n)?d.cloneElement(oi(n),{ref:n.ref},a(n.props.children)):a(n)}var di={position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"};const is=d.forwardRef(({className:t,...n},a)=>e.jsx(ce,{ref:a,className:q("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...n}));is.displayName=ce.displayName;const os=d.forwardRef(({className:t,...n},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx($,{name:"search",className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(ce.Input,{ref:a,className:q("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...n})]}));os.displayName=ce.Input.displayName;const ds=d.forwardRef(({className:t,...n},a)=>e.jsx(ce.List,{ref:a,className:q("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...n}));ds.displayName=ce.List.displayName;const ls=d.forwardRef((t,n)=>e.jsx(ce.Empty,{ref:n,className:"py-6 text-center text-sm",...t}));ls.displayName=ce.Empty.displayName;const cs=d.forwardRef(({className:t,...n},a)=>e.jsx(ce.Group,{ref:a,className:q("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...n}));cs.displayName=ce.Group.displayName;const li=d.forwardRef(({className:t,...n},a)=>e.jsx(ce.Separator,{ref:a,className:q("-mx-1 h-px bg-border",t),...n}));li.displayName=ce.Separator.displayName;const Qe=d.forwardRef(({className:t,...n},a)=>e.jsx(ce.Item,{ref:a,className:q("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",t),...n}));Qe.displayName=ce.Item.displayName;const qt=d.forwardRef(({className:t,...n},a)=>e.jsx(tr,{ref:a,className:q("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...n,children:e.jsx(il,{className:q("flex items-center justify-center text-current"),children:e.jsx($,{name:"check",className:"h-4 w-4"})})}));qt.displayName=tr.displayName;const ci=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo"],ui=["deepseek-r1-distill-llama-70b","llama-3.2-90b-vision-preview","llama-3.3-70b-versatile","llama-3.3-70b-specdec","llama3-70b-8192","gemma2-9b-it","llama3-8b-8192","mixtral-8x7b-32768"],mi=["llama-3.2-90b-vision-preview"],pi=["gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"],mt="https://aistudio.google.com/app/apikey",pt="https://platform.openai.com/api-keys",us="https://console.groq.com/keys",hi=[J.WebLLM,J.OpenAI,J.GoogleGenerativeAI,J.Groq],fi=xt(({onConfirm:t,onCancel:n})=>{const a=Te(),{t:r}=H("dialogs"),[s,o]=d.useState(""),i=u=>{o(u)},l=async()=>{try{if((s==null?void 0:s.length)!==6)return;await(t==null?void 0:t(s)),o(""),a.resolve(!0),a.hide()}catch(u){a.reject(u)}},c=()=>{n==null||n(),o(""),a.resolve(!1),a.hide()};return e.jsx(Nt,{open:a.visible,onOpenChange:c,children:e.jsxs(Ct,{className:"w-[330px]",children:[e.jsxs(St,{children:[e.jsx(Et,{children:r("create_session_passkey.title")}),e.jsx(Bn,{children:r("create_session_passkey.description")})]}),e.jsx("div",{className:"py-4",children:e.jsxs(Ud,{onChange:i,maxLength:6,children:[e.jsxs(Xn,{children:[e.jsx(Ke,{index:0,hidden:!0}),e.jsx(Ke,{index:1,hidden:!0}),e.jsx(Ke,{index:2,hidden:!0})]}),e.jsx(qd,{}),e.jsxs(Xn,{children:[e.jsx(Ke,{index:3,hidden:!0}),e.jsx(Ke,{index:4,hidden:!0}),e.jsx(Ke,{index:5,hidden:!0})]})]})}),e.jsx(Un,{children:e.jsx(Y,{disabled:(s==null?void 0:s.length)!==6,onClick:l,type:"submit",children:r("create_session_passkey.confirm")})})]})})}),gi=()=>{const[t,n]=d.useState(!1),a=ee(o=>o.currentSession),r=ee(o=>o.setCurrentSession),s=d.useCallback(async o=>{if(!(!a||!o))try{n(!0);const i=await Gd(),l=await Zn(i,o);await T("Session").update(a.id,{passphrase:l});const c=await T("Session").findOne({where:{id:a.id}});return c&&r(c),{passphrase:i,encrypted:l}}finally{n(!1)}},[a,r]);return{loading:t,updateSessionPassphrase:s}},ms=()=>{const t=ee(s=>s.currentSession),{modalRef:n}=Wd(fi),{updateSessionPassphrase:a}=gi(),{confirmPassphrase:r}=Yn();return{confirmOrCreatePassphrase:d.useCallback(async()=>{if(t!=null&&t.passphrase)await r();else{let s="";if(await n.current.show({onConfirm:async i=>{s=i}}),!s)throw new Error("Passphrase is required");const o=await a(s);if(!o)throw new Error("Failed to update session passphrase");await _t.set("passphrase",o.passphrase)}return _t.get("passphrase")},[r,n,t==null?void 0:t.passphrase,a])}};function xi(t){var S,P;const{id:n,setDialog:a}=t,{t:r}=H("components"),{toast:s}=ge(),o=ie(n),[i,l]=d.useState(!1),[c,u]=d.useState(""),[p,m]=d.useState(!1),[h,x]=d.useState(""),[f,g]=d.useState(),[_,y]=d.useState(J.WebLLM),[M,D]=d.useState(!1),[b,E]=d.useState(),v=ee(w=>w.currentSession),N=ot(w=>w.syncCachedLLMURLs),O=ot(w=>w.cachedLLMURLs),{loading:U,createLLM:V}=Ka(),{confirmOrCreatePassphrase:L}=ms();d.useEffect(()=>{xe(()=>import("./index-CTcNp3aO.js").then(async w=>(await w.__tla,w)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({functionCallingModelIds:w,prebuiltAppConfig:k})=>{const z=k.model_list;E({modelList:z,functionCallingModelIds:w})})},[]),d.useEffect(()=>{N()},[N]);const I=d.useMemo(()=>c?_!==J.WebLLM:!1,[c,_]),F=d.useMemo(()=>!(b!=null&&b.functionCallingModelIds)||!(b!=null&&b.modelList)?[]:((h?b==null?void 0:b.modelList.filter(w=>w.model_id.toLowerCase().includes(h.toLowerCase())):b==null?void 0:b.modelList)||[]).sort((w,k)=>{const z=O.some(Yt=>Yt.includes(w.model_id)),X=O.some(Yt=>Yt.includes(k.model_id));if(z&&!X)return-1;if(!z&&X)return 1;const re=Dn.includes(w.model_id),je=Dn.includes(k.model_id);if(re&&!je)return-1;if(!re&&je)return 1;const ze=b==null?void 0:b.functionCallingModelIds.includes(w.model_id),wn=b==null?void 0:b.functionCallingModelIds.includes(k.model_id);return ze&&!wn?-1:!ze&&wn?1:w.vram_required_MB&&k.vram_required_MB&&w.vram_required_MB!==k.vram_required_MB?w.vram_required_MB-k.vram_required_MB:w.model_id.localeCompare(k.model_id)}),[b==null?void 0:b.modelList,b==null?void 0:b.functionCallingModelIds,h,O]),C=d.useMemo(()=>{if(c)switch(_){case J.WebLLM:return(b==null?void 0:b.modelList)&&F.find(w=>w.model_id===c);case J.Groq:return g({}),{model:c,model_id:c,model_type:mi.includes(c)?2:0,overrides:{}};case J.OpenAI:return g({}),{model:c,model_id:c,model_type:2,overrides:{}};case J.GoogleGenerativeAI:return g({}),{model:c,model_id:c,model_type:2,overrides:{}}}},[c,b==null?void 0:b.modelList,F,_]);d.useEffect(()=>{!(C!=null&&C.model_id)||!O||D(O.some(w=>w.includes(C.model_id)))},[O,C==null?void 0:C.model_id]),d.useEffect(()=>{v!=null&&v.id&&(y(J.WebLLM),u(""),x(""),g({}))},[v==null?void 0:v.id]);const R=d.useCallback(w=>{u(w),m(!1)},[]),Z=d.useCallback(w=>{x(w)},[]),K=d.useCallback(w=>{y(w),u(""),x(""),g({})},[]),Q=async()=>{var w;if(!(!o||!v))try{l(!0);let k;if(I){const z=await L();if(!z)throw new Error("Passphrase is not found");k=await Jd(f||{},z)}await V(o,{name:c,model_type:be(C==null?void 0:C.model_type),function_calling:C!=null&&C.model_id?(w=b==null?void 0:b.functionCallingModelIds)==null?void 0:w.includes(C==null?void 0:C.model_id):!1,encrypted:k,provider:_}),a==null||a(!1)}catch(k){yt("Create LLM",k),s({variant:"destructive",description:r("add_llm_card.errors.failed_to_create")})}finally{l(!1),y(J.WebLLM),g({}),u(""),x("")}},be=d.useCallback(w=>w===1?Mt.embedding:w===2?Mt.VLM:Mt.LLM,[]),He=d.useMemo(()=>{switch(_){case J.WebLLM:return F.map(w=>{var k;return e.jsxs(Qe,{value:w.model_id,onSelect:R,children:[c===w.model_id?e.jsx($,{name:"check",className:"mr-2 h-4 w-4"}):e.jsx("div",{className:"mr-2 h-4 w-4"}),e.jsxs("span",{className:"max-w-md",children:[e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx(Re,{name:w.model_id}),w.model_id]}),e.jsx("div",{className:"flex max-w-full flex-wrap gap-1",children:e.jsx(vt,{model:w,isFunctionCalling:((k=b==null?void 0:b.functionCallingModelIds)==null?void 0:k.includes(w.model_id))||!1,name:w.model_id,isCached:O.some(z=>z.includes(w.model_id))||!1,cloud:_!==J.WebLLM})})]})]},w.model_id)});case J.OpenAI:return ci.map(w=>e.jsxs(Qe,{value:w,onSelect:R,children:[c===w?e.jsx($,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Re,{name:w}),w]})})]},w));case J.GoogleGenerativeAI:return pi.map(w=>e.jsxs(Qe,{value:w,onSelect:R,children:[c===w?e.jsx($,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Re,{name:w}),w]})})]},w));case J.Groq:return ui.map(w=>e.jsxs(Qe,{value:w,onSelect:R,children:[c===w?e.jsx($,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Re,{name:w}),w]})})]},w))}},[O,R,c,b==null?void 0:b.functionCallingModelIds,F,_]),ye=d.useMemo(()=>{if(I)switch(_){case J.Groq:case J.OpenAI:return e.jsxs(e.Fragment,{children:[e.jsx(ve,{variant:"destructive",className:"mt-4",children:r("add_llm_card.alert.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(B,{children:r("add_llm_card.encrypted_fields.api_key")}),e.jsx(Y,{variant:"link",className:"px-1",children:e.jsxs("a",{href:_===J.OpenAI?pt:us,target:"_blank",rel:"noreferrer",children:["(",_===J.OpenAI?pt:us,")"]})}),e.jsx(pe,{type:"password",value:(f==null?void 0:f.key)||"",onChange:w=>g(k=>({...k,key:w.target.value}))})]})]});case J.GoogleGenerativeAI:return e.jsxs(e.Fragment,{children:[e.jsx(ve,{variant:"destructive",className:"mt-4",children:r("add_llm_card.alert.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(B,{children:r("add_llm_card.encrypted_fields.api_key")}),e.jsx(Y,{variant:"link",className:"px-1",children:e.jsxs("a",{href:mt,target:"_blank",rel:"noreferrer",children:["(",mt,")"]})}),e.jsx(pe,{type:"password",value:(f==null?void 0:f.key)||"",onChange:w=>g(k=>({...k,key:w.target.value}))})]}),e.jsxs("div",{className:"mt-4 flex items-center",children:[e.jsx(B,{children:r("add_llm_card.encrypted_fields.enabled_google_search_retreival")}),e.jsx(qt,{checked:!!(f!=null&&f.enabled_google_search_retreival),className:"ml-2",onCheckedChange:w=>{g(k=>({...k,enabled_google_search_retreival:w?"true":""}))}})]})]})}},[I,_,r,f]);return e.jsxs(te,{className:"max-w-lg",children:[e.jsx(oe,{children:e.jsx(ue,{children:r("add_llm_card.title")})}),e.jsxs(de,{children:[e.jsxs("div",{className:"grid w-full gap-1.5",children:[e.jsx(B,{children:r("add_llm_card.provider")}),e.jsxs(Ee,{value:_,onValueChange:K,children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:r("add_llm_card.provider_select_placeholder")})}),e.jsx(Le,{children:Object.values(hi).map(w=>e.jsx(me,{value:w,children:r(`add_llm_card.providers.${w.toLowerCase()}`)},w))})]}),e.jsx(B,{children:r("add_llm_card.model_name")}),e.jsxs(Qn,{open:p,onOpenChange:m,children:[e.jsx(sl,{asChild:!0,children:e.jsxs(Y,{variant:"outline",role:"combobox","aria-expanded":p,className:"w-full justify-between",children:[c?C==null?void 0:C.model_id:r("add_llm_card.select_model_placeholder"),e.jsx($,{name:"chevrons-up-down",className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(er,{className:"w-full p-0",children:e.jsxs(is,{children:[e.jsx(os,{onValueChange:Z,placeholder:r("add_llm_card.search_placeholder")}),e.jsxs(ds,{children:[e.jsx(ls,{children:r("add_llm_card.no_model")}),e.jsx(cs,{children:He})]})]})})]})]}),C?e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"mt-4 text-sm text-muted-foreground center flex max-w-full flex-wrap gap-1",children:[e.jsx(Re,{name:C.model_id,className:"mr-2"}),e.jsx(vt,{model:C,isFunctionCalling:((S=b==null?void 0:b.functionCallingModelIds)==null?void 0:S.includes(C.model_id))||!1,name:C.model_id,isCached:O.some(w=>w.includes(C.model_id))||!1,cloud:_!==J.WebLLM})]}),e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.model_url")}),C.model]}),C.model_lib?e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground center flex",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.model_lib_url")}),C.model_lib]}):void 0,C.overrides&&((P=Object.keys(C.overrides))!=null&&P.length)?e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground center flex",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.metadata")}),JSON.stringify(C.overrides)]}):void 0]}):null,ye]}),e.jsx(Ae,{className:"flex justify-between",children:e.jsx(Ie,{loading:U||i,disabled:!(c!=null&&c.length),onClick:Q,className:"w-full",children:r(M?"add_llm_card.button_add":"add_llm_card.button_download_and_add")})})]})}const ps=()=>{const t=ee(o=>{var i;return(i=o.currentSession)==null?void 0:i.id}),[n,a]=d.useState(!1),r=A(o=>o.createOrUpdateFlowNode),s=d.useCallback(async(o,i)=>{var l,c,u;try{if(!o||!t)throw new Error("Source or Session not found");a(!0);const p=((l=o.position)==null?void 0:l.x)||0,m=(((c=o.position)==null?void 0:c.y)||0)+(((u=o.measured)==null?void 0:u.height)||0),h=await T("Prompt").save({content:i.content,prefix:i.prefix,role:i.role||he.System,status:_e.Started,session_id:t,type:i.type||fe.Chat});if(!h)throw new Error("Failed to save prompt");if(!await r({source_id:h.id,source_type:"Prompt",node_type:j.Prompt,x:p,y:m+20}))throw new Error("Failed to save prompt node")}finally{a(!1)}},[t,r]);return{loading:n,createPrompt:s}},_i={[fe.Chat]:{label:"add_prompt_card.prompt_types.chat",value:fe.Chat},[fe.FewShotExample]:{label:"add_prompt_card.prompt_types.few_shot_example",value:fe.FewShotExample}},yi={[he.System]:{label:"add_prompt_card.prompt_roles.system",value:he.System},[he.Human]:{label:"add_prompt_card.prompt_roles.human",value:he.Human},[he.AI]:{label:"add_prompt_card.prompt_roles.ai",value:he.AI}},Gt=d.memo(({defaultPromptContent:t,defaultPromptRole:n,defaultPromptType:a,hidePromptRole:r,hidePromptType:s,loading:o,onSubmit:i})=>{const[l,c]=d.useState(t||""),[u,p]=d.useState(a||fe.Chat),[m,h]=d.useState(n),[x,f]=d.useState(""),{t:g}=H("components"),_=d.useCallback(E=>{c(E.target.value)},[]),y=d.useCallback(E=>{f(E.target.value)},[]),M=d.useCallback(E=>{E===fe.FewShotExample&&c(`Question: {input}
Answer: {output}`),p(E)},[]),D=d.useCallback(E=>{h(E)},[]),b=async()=>{await i({content:l,role:m,prefix:x,type:u})&&(c(""),h(void 0),p("chat"),f(""))};return e.jsxs("div",{children:[e.jsxs("div",{className:"grid w-full gap-1.5",children:[s?void 0:e.jsxs(e.Fragment,{children:[e.jsx(B,{children:g("add_prompt_card.prompt_type")}),e.jsxs(Ee,{value:u,onValueChange:M,children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:g("add_prompt_card.type_select_placeholder")})}),e.jsx(Le,{children:Object.values(_i).map(E=>e.jsx(me,{value:E.value,children:g(E.label)},E.value))})]})]}),r?void 0:e.jsxs(e.Fragment,{children:[e.jsx(B,{children:g("add_prompt_card.prompt_role")}),e.jsxs(Ee,{value:m,onValueChange:D,children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:g("add_prompt_card.role_select_placeholder")})}),e.jsx(Le,{children:Object.values(yi).map(E=>e.jsx(me,{value:E.value,children:g(E.label)},E.value))})]})]}),u===fe.FewShotExample&&e.jsxs(e.Fragment,{children:[e.jsx(B,{children:g("add_prompt_card.prompt_prefix")}),e.jsx(dt,{value:x,onChange:y,disabled:!1,className:"h-20",placeholder:g("add_prompt_card.placeholder"),id:"message"}),e.jsx(B,{children:g("add_prompt_card.prompt_content")}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm justify-end items-center",children:[e.jsx($,{name:"info",className:"mr-2",size:14}),g("add_prompt_card.few_shot_example_note")]})]}),e.jsx(dt,{value:l,onChange:_,disabled:!1,placeholder:g("add_prompt_card.placeholder"),id:"message"})]}),e.jsx("div",{children:e.jsx(Ie,{loading:o,disabled:!(l!=null&&l.length),onClick:b,className:"w-full mt-4",children:g("add_prompt_card.button")})})]})}),vi=d.memo(t=>{const{id:n,thread:a,setDialog:r}=t,{t:s}=H("components"),{toast:o}=ge(),i=ie(n),{createPrompt:l,loading:c}=ps(),u=async p=>{if(i)try{if(!(p!=null&&p.content))throw new Error("Prompt data is missing");await l(i,{...p,content:p.content,thread:a}),r==null||r(!1)}catch(m){o({variant:"destructive",title:`${m}`})}};return e.jsxs(te,{className:"mw-full",children:[e.jsx(oe,{children:e.jsx(ue,{children:s("add_prompt_card.title")})}),e.jsx(de,{children:e.jsx(Gt,{onSubmit:u,loading:c,defaultPromptRole:"system",defaultPromptType:"chat"})})]})}),wi=()=>{const t=ee(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=A(i=>i.createOrUpdateFlowNode),s=d.useCallback((i,l,c,u)=>{var p;if(t){for(const m of l)(p=m.data)!=null&&p.length?s(i,m.data,c,m.id):c.push({name:m.name,type:m.type,enum:m.enum?JSON.stringify(m.enum):"",required:m.required,description:m.description,id:m.id||ra(),parent_id:u,schema_id:i,session_id:t});return c}},[t]),o=d.useCallback(async(i,l)=>{var c,u,p;try{if(!i||!t)throw new Error("Source or Session not found");a(!0);const m=((c=i.position)==null?void 0:c.x)||0,h=(((u=i.position)==null?void 0:u.y)||0)+(((p=i.measured)==null?void 0:p.height)||0),x=await T("Schema").save({name:"Untitled Schema",session_id:t});if(!x)throw new Error("Failed to save schema");const f=s(x.id,l,[],void 0);if(!(f!=null&&f.length))throw new Error("Failed to convert schema items");if(await T("SchemaItem").save(f),!await r({source_id:x.id,source_type:"Schema",node_type:j.Schema,x:m,y:h+20}))throw new Error("Failed to save schema node")}finally{a(!1)}},[t,s,r]);return{loading:n,createSchema:o}},hs=d.memo(({setData:t,data:n,id:a})=>{const{t:r}=H("components"),[s,o]=d.useState({name:"",description:"",type:"string",required:!1,data:[]}),i=d.useMemo(()=>a&&n.find(g=>g.id===a)||s,[n,s,a]),l=d.useCallback(g=>{g.target.value&&!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(g.target.value)||(a?t(_=>[..._.map(y=>y.id===a?{...y,name:g.target.value||""}:y)]):o(_=>({..._,name:g.target.value||""})))},[a,t]),c=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,description:g.target.value||""}:y)]):o(_=>({..._,description:g.target.value||""}))},[a,t]),u=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,type:g||""}:y)]):o(_=>({..._,type:g||"string"}))},[a,t]),p=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,required:!!g||!1}:y)]):o(_=>({..._,required:!!g||!1}))},[a,t]),m=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,enum:g.target.value||""}:y)]):o(_=>({..._,enum:g.target.value||""}))},[a,t]),h=d.useCallback(()=>{if(n.find(g=>g.name===s.name))return qe({variant:"destructive",content:"Name already exists"});s.id=ra(),t(g=>[...g,{...s}]),o({name:"",description:"",type:"string",required:!1,id:ra(),parent:a||void 0,data:[]})},[n,s,t,a]),x=d.useCallback(g=>{t(_=>[..._.map(y=>y.id===a?{...y,data:g(y.data||[])}:y)])},[a,t]),f=["object","array"].includes(i.type);return e.jsxs("div",{className:"w-full p-1",children:[e.jsxs("div",{children:[e.jsx(B,{children:r("add_schema_card.field.name")}),e.jsx(pe,{id:"name",onChange:l,placeholder:r("add_schema_card.field.name_placeholder"),value:(i==null?void 0:i.name)||""})]}),e.jsxs("div",{children:[e.jsx(B,{children:r("add_schema_card.field.description")}),e.jsx(pe,{id:"description",placeholder:r("add_schema_card.field.description_placeholder"),onChange:c,value:(i==null?void 0:i.description)||""})]}),e.jsxs("div",{children:[e.jsx(B,{children:r("add_schema_card.field.type")}),e.jsxs(Ee,{onValueChange:u,value:(i==null?void 0:i.type)||"",children:[e.jsx(ke,{children:e.jsx(Me,{placeholder:r("add_schema_card.field.type_placeholder")})}),e.jsxs(Le,{children:[e.jsx(me,{value:"string",children:r("add_schema_card.types.string")}),e.jsx(me,{value:"boolean",children:r("add_schema_card.types.boolean")}),e.jsx(me,{value:"number",children:r("add_schema_card.types.number")}),e.jsx(me,{value:"object",children:r("add_schema_card.types.object")}),e.jsx(me,{value:"array",children:r("add_schema_card.types.array")})]})]})]}),e.jsxs("div",{className:"flex items-center h-10",children:[e.jsx(B,{children:r("add_schema_card.field.required")}),e.jsx(qt,{className:"ml-2","aria-label":"Select row",onCheckedChange:p,checked:i==null?void 0:i.required})]}),f?e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx(B,{children:r("add_schema_card.children")}),e.jsx(fs,{data:(i==null?void 0:i.data)||[],setData:x})]}):null,(i==null?void 0:i.type)==="enum"?e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx(B,{children:r("add_schema_card.field.enum")}),e.jsx(pe,{id:"enum",onChange:m,placeholder:"Enum"})]}):null,a?null:e.jsx("div",{className:"w-full flex justify-end mt-2",children:e.jsx(Y,{variant:"secondary",disabled:!i.name||!i.description||!i.type,onClick:h,className:"w-full",children:r("add_schema_card.field.add_field")})})]})}),fs=d.memo(({data:t,setData:n})=>e.jsxs(Po,{type:"single",collapsible:!0,children:[t.map(a=>e.jsxs($o,{value:`${a.id}`,children:[e.jsx(Vo,{children:a.name}),e.jsx(Ho,{children:e.jsx(hs,{setData:n,data:t,id:a.id})})]},a.id||"new")),e.jsx(te,{className:"p-2 mt-4",children:e.jsx(hs,{setData:n,data:t})})]})),bi=d.memo(t=>{const{t:n}=H("components"),{id:a}=t,r=ie(a),[s,o]=d.useState([]),{createSchema:i,loading:l}=wi(),c=async()=>{if(r&&(s!=null&&s.length))try{await i(r,s),o([])}catch(u){qe({variant:"destructive",title:`${u}`})}};return e.jsxs(te,{className:"max-w-lg",children:[e.jsx(oe,{children:e.jsx(ue,{children:n("add_schema_card.title")})}),e.jsx(de,{className:"min-w-96",children:e.jsx(fs,{setData:o,data:s})}),e.jsx(Ae,{className:"flex justify-between",children:e.jsx(Ie,{loading:l,disabled:!(s!=null&&s.length),onClick:c,className:"w-full",children:n("add_schema_card.create")})})]})}),gs=()=>{const t=ee(o=>{var i;return(i=o.currentSession)==null?void 0:i.id}),[n,a]=d.useState(!1),r=A(o=>o.createOrUpdateFlowNode),s=d.useCallback(async(o,i,l)=>{var c,u,p;try{if(!o||!t)throw new Error("Source or Session not found");a(!0);const m=((c=o.position)==null?void 0:c.x)||0,h=(((u=o.position)==null?void 0:u.y)||0)+(((p=o.measured)==null?void 0:p.height)||0),x=Fd(i,l),f=await T("CSVData").save({headers:x.headers,csv:x.data,session_id:t});if(!f)throw new Error("Failed to save");if(!await r({source_id:f.id,source_type:"CSVData",node_type:j.CSVData,x:m,y:h+20}))throw new Error("Failed to save node")}finally{a(!1)}},[t,r]);return{loading:n,createCSVData:s}};function ji({data:t}){const{t:n}=H("components");return e.jsxs(In,{className:"w-full",children:[e.jsx(Tn,{children:e.jsxs(wt,{children:[e.jsx(ea,{children:n("add_few_shot_example_card.input")}),e.jsx(ea,{children:n("add_few_shot_example_card.output")})]})}),e.jsx(An,{children:t==null?void 0:t.map((a,r)=>e.jsxs(wt,{children:[e.jsx(ta,{className:"p-4",children:a.input}),e.jsx(ta,{className:"p-4",children:a.output})]},`${a.input}_${a.output}_${r}`))})]})}const Ni=d.memo(t=>{const{id:n}=t,{t:a}=H("components"),[r,s]=d.useState([]),[o,i]=d.useState(""),[l,c]=d.useState(""),u=ie(n),{createCSVData:p,loading:m}=gs(),h=()=>{s(f=>[...f,{input:o,output:l}]),i(""),c("")},x=async()=>{u&&await p(u,["input","output"],r.map(f=>[f.input,f.output]))};return e.jsxs(te,{className:"mw-full",children:[e.jsx(oe,{children:e.jsx(ue,{children:a("add_few_shot_example_card.title")})}),e.jsxs(de,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(B,{htmlFor:"name",children:a("add_few_shot_example_card.input")}),e.jsx(pe,{value:o,onChange:f=>i(f.target.value||""),id:"name",placeholder:a("add_few_shot_example_card.input_placeholder")})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(B,{htmlFor:"name",children:a("add_few_shot_example_card.output")}),e.jsx(dt,{value:l,onChange:f=>c(f.target.value||""),placeholder:a("add_few_shot_example_card.output_placeholder")})]}),e.jsx("div",{className:"w-full flex mt-4 justify-end",children:e.jsx(Y,{disabled:!o||!l,onClick:h,className:"w-40",children:a("add_few_shot_example_card.add")})}),e.jsx(ji,{data:r||[]})]}),e.jsx(Ae,{className:"flex justify-between",children:e.jsx(Ie,{loading:m,disabled:!(r!=null&&r.length),onClick:x,className:"w-full",children:a("add_few_shot_example_card.create")})})]})}),Ci=()=>{const t=ee(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=A(i=>i.createOrUpdateFlowNode),s=A(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async(i,l,c)=>{var u,p,m;try{if(!i||!t)throw new Error("Source or Session not found");if(!l.name||!l.description)throw new Error("Name is required");a(!0);const h=((u=i.position)==null?void 0:u.x)||0,x=(((p=i.position)==null?void 0:p.y)||0)+(((m=i.measured)==null?void 0:m.height)||0),f=await T("ToolDefinition").save({...l,name:`${l.name}`,description:`${l.description}`,session_id:t});if(!f)throw new Error("Failed create tool.");const g=await r({source_id:f.id,source_type:"ToolDefinition",node_type:j.ToolDefinition,x:h,y:x+20});if(!g)throw new Error("Failed to save node");c!=null&&c.schemaNode&&await s({source:c.schemaNode.id,target:g.id})}finally{a(!1)}},[t,r,s]);return{loading:n,createTool:o}},Si=d.memo(t=>{const{t:n}=H("components"),{toast:a}=ge(),{id:r}=t,s=ie(r),[o,i]=d.useState(""),[l,c]=d.useState(""),{createTool:u,loading:p}=Ci(),m=f=>{i(f.target.value)},h=f=>{c(f.target.value)},x=async()=>{if(s&&o&&l)try{await u(s,{name:o,description:l}),i(""),c("")}catch(f){Eo("Create Tool",f),a({variant:"destructive",title:n("add_tool_card.errors.create_tool_failed")})}};return e.jsxs(te,{className:"mw-full",children:[e.jsx(oe,{children:e.jsx(ue,{children:n("add_tool_card.title")})}),e.jsxs(de,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(B,{htmlFor:"name",children:n("add_tool_card.tool_name")}),e.jsx(pe,{onChange:m,id:"name",placeholder:n("add_tool_card.name_placeholder")})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(B,{htmlFor:"name",children:n("add_tool_card.tool_description")}),e.jsx(dt,{onChange:h,placeholder:n("add_tool_card.description_placeholder")})]})]}),e.jsx(Ae,{className:"flex justify-between",children:e.jsx(Ie,{loading:p,onClick:x,className:"w-full",children:n("add_tool_card.create")})})]})}),Ei=()=>{const t=ee(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=A(i=>i.createOrUpdateFlowNode),s=A(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async(i,l,c)=>{var u,p,m;try{if(!(l!=null&&l.name)||!i||!t)throw new Error("Source or Session not found");a(!0);const h=((u=i.position)==null?void 0:u.x)||0,x=(((p=i.position)==null?void 0:p.y)||0)+(((m=i.measured)==null?void 0:m.height)||0),f=await T("VectorDatabase").save({...l,name:`${l.name}`,type:l.type||Rd.Local,storage:l.storage||Fe.DatabaseNode,raw:"",provider:l.provider||qn.Memory,session_id:t,metadata:c?JSON.stringify({textSplitter:c}):void 0});if(!f)throw new Error("Failed to save vectorDatabase");const g=await r({source_id:f.id,source_type:"VectorDatabase",node_type:j.VectorDatabase,x:h,y:x+30});if(!g)throw new Error("Failed to save vectorDatabase node");if(l.storage===Fe.DataNode){const _=await T("JSONLData").save({headers:Pd(["content","embedding","metadata"]),jsonl:"",session_id:t});if(!_)throw new Error("Failed to save databaseSource");const y=await r({source_id:_.id,source_type:"JSONLData",node_type:j.JSONLData,x:h+80,y:x+30});if(!y)throw new Error("Failed to save databaseSource node");await s({source:y.id,target:g.id})}return{vectorDatabase:f,vectorDatabaseNode:g}}finally{a(!1)}},[t,r,s]);return{loading:n,createVectorDatabase:o}},et=[qn.Memory],tt=[Fe.DatabaseNode],ki=["TokenTextSplitter","CharacterTextSplitter","RecursiveCharacterTextSplitter"],Mi=d.memo(t=>{const{t:n}=H("components"),{id:a}=t,r=ie(a),{toast:s}=ge(),[o,i]=d.useState(""),[l,c]=d.useState(et[0]),[u,p]=d.useState(tt[0]),[m,h]=d.useState({}),{loading:x,createVectorDatabase:f}=Ei(),g=d.useCallback(v=>{c(v)},[]),_=d.useCallback(v=>{p(v)},[]),y=d.useCallback(v=>{h(N=>({...N,type:v,chunkSize:500,chunkOverlap:40}))},[]),M=d.useCallback(v=>{i(v.target.value||"")},[]),D=d.useCallback(v=>{h(N=>({...N,chunkSize:Number(v.target.value)}))},[]),b=d.useCallback(v=>{h(N=>({...N,chunkOverlap:Number(v.target.value)}))},[]),E=async()=>{try{if(!r)return;await f(r,{name:o,provider:l,storage:u},m!=null&&m.type?{type:m.type,chunkSize:m.chunkSize||500,chunkOverlap:m.chunkOverlap||0}:void 0),i(""),h({})}catch{s({variant:"destructive",description:n("create_vector_database_card.errors.create_failed")})}};return e.jsxs(te,{className:"mw-full",children:[e.jsx(oe,{children:e.jsx(ue,{children:n("create_vector_database_card.title")})}),e.jsx(de,{children:e.jsxs("div",{className:"grid w-full gap-1.5",children:[e.jsx(B,{children:n("create_vector_database_card.name")}),e.jsx(pe,{className:"mb-4",value:o,onChange:M}),(tt==null?void 0:tt.length)>1?e.jsxs(e.Fragment,{children:[e.jsx(B,{children:n("create_vector_database_card.storage_type")}),e.jsxs(Ee,{value:u,onValueChange:_,children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:n("create_vector_database_card.provider_select_placeholder")})}),e.jsx(Le,{children:Object.values(tt).map(v=>e.jsx(me,{value:v,children:n(`create_vector_database_card.storage_types.${v.toLowerCase()}`)},v))})]})]}):void 0,(et==null?void 0:et.length)>1?e.jsxs(e.Fragment,{children:[e.jsx(B,{children:n("create_vector_database_card.provider")}),e.jsxs(Ee,{value:l,onValueChange:g,children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:n("create_vector_database_card.provider_select_placeholder")})}),e.jsx(Le,{children:Object.values(et).map(v=>e.jsx(me,{value:v,children:n(`create_vector_database_card.providers.${v.toLowerCase()}`)},v))})]})]}):void 0,e.jsx(B,{children:n("create_vector_database_card.text_splitter")}),e.jsxs(Ee,{value:m.type,onValueChange:y,children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:n("create_vector_database_card.text_splitter_select_placeholder")})}),e.jsx(Le,{children:Object.values(ki).map(v=>e.jsx(me,{value:v,children:n(`create_vector_database_card.text_splitters.${v.toLowerCase()}`)},v))})]}),m.type?e.jsxs(te,{children:[e.jsx(oe,{children:e.jsx(ue,{children:n("create_vector_database_card.text_splitter_configuration")})}),e.jsxs(de,{children:[e.jsx(B,{children:n("create_vector_database_card.text_splitter_chunksize")}),e.jsx(pe,{value:m.chunkSize,onChange:D,placeholder:n("create_vector_database_card.text_splitter_chunksize_placeholder")}),e.jsx(B,{children:n("create_vector_database_card.text_splitter_chunkoverlap")}),e.jsx(pe,{value:m.chunkOverlap,onChange:b,placeholder:n("create_vector_database_card.text_splitter_chunkoverlap_placeholder")})]})]}):void 0]})}),e.jsx(Ae,{className:"flex justify-between",children:e.jsx(Ie,{disabled:!m.type||!o,loading:x,onClick:E,className:"w-full",children:n("create_vector_database_card.create")})})]})});function Li({data:t}){const{t:n}=H("components");return e.jsxs(In,{className:"w-full",children:[e.jsx(Tn,{children:e.jsx(wt,{children:e.jsx(ea,{children:n("add_text_data.text")})})}),e.jsx(An,{children:t==null?void 0:t.map((a,r)=>e.jsx(wt,{children:e.jsx(ta,{className:"p-4",children:a.text})},`${a.text}_${r}`))})]})}const Di=d.memo(t=>{const{id:n}=t,{t:a}=H("components"),[r,s]=d.useState([]),[o,i]=d.useState(""),l=ie(n),{createCSVData:c,loading:u}=gs(),p=()=>{s(h=>[...h,{text:o}]),i("")},m=async()=>{l&&await c(l,["text"],r.map(h=>[h.text]))};return e.jsxs(te,{className:"mw-full",children:[e.jsx(oe,{children:e.jsx(ue,{children:a("add_text_data.title")})}),e.jsxs(de,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(B,{htmlFor:"name",children:a("add_text_data.text")}),e.jsx(dt,{value:o,onChange:h=>i(h.target.value||""),placeholder:a("add_text_data.text_placeholder")})]}),e.jsx("div",{className:"w-full flex mt-4 justify-end",children:e.jsx(Y,{disabled:!o,onClick:p,className:"w-40",children:a("add_text_data.add")})}),e.jsx(Li,{data:r||[]})]}),e.jsx(Ae,{className:"flex justify-between",children:e.jsx(Ie,{loading:u,disabled:!(r!=null&&r.length),onClick:m,className:"w-full",children:a("add_text_data.create")})})]})});var Ce=(t=>(t.ADD_LLM="ADD_LLM",t.ADD_PROMPT="ADD_PROMPT",t.ADD_TOOL_DEFINITION="ADD_TOOL_DEFINITION",t.ADD_SCHEMA="ADD_SCHEMA",t.ADD_FEW_SHOT_EXAMPLE="ADD_FEW_SHOT_EXAMPLE",t.ADD_VECTOR_DATABASE="ADD_VECTOR_DATABASE",t.ADD_TEXT_DATA="ADD_TEXT_DATA",t))(Ce||{});const Ii=["ADD_LLM","ADD_PROMPT","ADD_SCHEMA","ADD_VECTOR_DATABASE",{key:"more",label:"more",icon:"ellipsis",children:["ADD_TOOL_DEFINITION","ADD_FEW_SHOT_EXAMPLE"]}],Ti=()=>{const t="_coolMode_effect",n=document.getElementById(t);if(n)return n;const a=document.createElement("div");return a.setAttribute("id",t),a.setAttribute("style","overflow:hidden; position:fixed; height:100%; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:2147483647"),document.body.appendChild(a),a};let xs=0,_s,ys,vs,ws,bs,js,ae,G,Ns,Cs,Ss,Es,ht,Wt,Jt,Kt,ks,Ms,ft,Xt,Ls,Ds,Is;_s=(t,n)=>{xs++;const a=(n==null?void 0:n.particle)||"circle",r=[15,20,25,35,45],s=45;let o=[],i=!1,l=0,c=0;const u=Ti();function p(){const N=(n==null?void 0:n.size)||r[Math.floor(Math.random()*r.length)],O=(n==null?void 0:n.speedHorz)||Math.random()*10,U=(n==null?void 0:n.speedUp)||Math.random()*25,V=Math.random()*360,L=Math.random()*35*(Math.random()<=.5?-1:1),I=c-N/2,F=l-N/2,C=Math.random()<=.5?-1:1,R=document.createElement("div");if(a==="circle"){const Z="http://www.w3.org/2000/svg",K=document.createElementNS(Z,"svg"),Q=document.createElementNS(Z,"circle");Q.setAttributeNS(null,"cx",(N/2).toString()),Q.setAttributeNS(null,"cy",(N/2).toString()),Q.setAttributeNS(null,"r",(N/2).toString()),Q.setAttributeNS(null,"fill",`hsl(${Math.random()*360}, 70%, 50%)`),K.appendChild(Q),K.setAttribute("width",N.toString()),K.setAttribute("height",N.toString()),R.appendChild(K)}else R.innerHTML=`<img src="${a}" width="${N}" height="${N}" style="border-radius: 50%">`;R.style.position="absolute",R.style.transform=`translate3d(${F}px, ${I}px, 0px) rotate(${V}deg)`,u.appendChild(R),o.push({direction:C,element:R,left:F,size:N,speedHorz:O,speedUp:U,spinSpeed:L,spinVal:V,top:I})}function m(){o.forEach(N=>{N.left=N.left-N.speedHorz*N.direction,N.top=N.top-N.speedUp,N.speedUp=Math.min(N.size,N.speedUp-1),N.spinVal=N.spinVal+N.spinSpeed,N.top>=Math.max(window.innerHeight,document.body.clientHeight)+N.size&&(o=o.filter(O=>O!==N),N.element.remove()),N.element.setAttribute("style",["position:absolute","will-change:transform",`top:${N.top}px`,`left:${N.left}px`,`transform:rotate(${N.spinVal}deg)`].join(";"))})}let h,x=0;const f=30;function g(){const N=performance.now();i&&o.length<s&&N-x>f&&(p(),x=N),m(),h=requestAnimationFrame(g)}g();const _="ontouchstart"in window,y=_?"touchstart":"mousedown",M=_?"touchend":"mouseup",D=_?"touchmove":"mousemove",b=N=>{var O,U;"touches"in N?(l=(O=N.touches)==null?void 0:O[0].clientX,c=(U=N.touches)==null?void 0:U[0].clientY):(l=N.clientX,c=N.clientY)},E=N=>{b(N),i=!0},v=()=>{i=!1};return t.addEventListener(D,b,{passive:!0}),t.addEventListener(y,E,{passive:!0}),t.addEventListener(M,v,{passive:!0}),t.addEventListener("mouseleave",v,{passive:!0}),()=>{t.removeEventListener(D,b),t.removeEventListener(y,E),t.removeEventListener(M,v),t.removeEventListener("mouseleave",v);const N=setInterval(()=>{h&&o.length===0&&(cancelAnimationFrame(h),clearInterval(N),--xs===0&&u.remove())},500)}},ys=({children:t,options:n})=>{const a=d.useRef(null);return d.useEffect(()=>{if(a.current)return _s(a.current,n)},[n]),nt.cloneElement(t,{ref:a})},vs=d.memo(t=>{const{t:n}=H("flows"),a=En(l=>l.theme),[r,s]=d.useState(`${Ce.ADD_LLM}`),o=d.useMemo(()=>e.jsxs(Ga,{children:[e.jsx(Ft,{children:e.jsx(ys,{children:e.jsx(Y,{variant:"link",className:"!p-0 !pl-3",children:e.jsx(ko,{width:32,height:32,className:q(a==="dark"?"fill-white":"fill-black")})})})}),Ii.map(l=>typeof l=="object"?e.jsxs(Ft,{children:[e.jsx(Rt,{children:l.icon?e.jsx($,{name:l.icon}):n(`supported_nodes.${l.label}`)}),e.jsx(Wa,{children:l.children.map(c=>e.jsx(Ja,{onClick:()=>s(c),children:n(`supported_nodes.${c.toLowerCase()}`)},c))})]},l.key):e.jsx(Ft,{children:e.jsx(Rt,{value:l,onClick:()=>s(l),children:n(`supported_nodes.${l.toLowerCase()}`)})},l))]}),[n,a]),i=d.useMemo(()=>{switch(r){case Ce.ADD_LLM:return e.jsx(xi,{...t});case Ce.ADD_PROMPT:return e.jsx(vi,{...t});case Ce.ADD_SCHEMA:return e.jsx(bi,{...t});case Ce.ADD_FEW_SHOT_EXAMPLE:return e.jsx(Ni,{...t});case Ce.ADD_TOOL_DEFINITION:return e.jsx(Si,{...t});case Ce.ADD_VECTOR_DATABASE:return e.jsx(Mi,{...t});case Ce.ADD_TEXT_DATA:return e.jsx(Di,{...t})}},[t,r]);return e.jsxs(e.Fragment,{children:[o,e.jsx("div",{className:"mt-4",children:i})]})}),ws=()=>{const[t,n]=d.useState(!1),a=$d(),r=ee(l=>l.currentSession),s=ee(l=>l.getLatestApplications),o=d.useCallback(async(l,c,u,p)=>{var x;const m=(x=c.data)==null?void 0:x.entity;let h=c.type?Mo[c.type]:void 0;if(h&&m&&c&&typeof m=="object"&&"id"in m&&!u.has(`${m.id}`)&&!p.has(`${c.id}`)){h=h;const f=await T(h).save({...m,...m&&typeof m=="object"&&"session_id"in m?{session_id:l.id}:{}});u.set(`${m.id}`,f.id);const g=await T("FlowNode").findOne({where:{id:c.data.flowNode.id}}),_=await T("FlowNode").save({...g||c.data.flowNode,session_id:l.id,id:void 0,source_type:h,source_id:f.id});return p.set(`${c.id}`,_.id),{entityName:h,entity:f,node:_}}else if(!p.has(`${c.id}`)){const f=await T("FlowNode").findOne({where:{id:c.data.flowNode.id}}),g=await T("FlowNode").save({...f||c.data.flowNode,node_type:c.type,session_id:l.id,id:void 0});return p.set(`${c.id}`,g.id),{node:g}}},[]),i=d.useCallback(async(l,c)=>{try{if(!r)throw new Error("No current session");n(!0);const u=await T("Session").save({type:Lo.StandaloneApp,name:c.name||(r!=null&&r.name?`${r.name}`:"Standalone"),status:Do.Started,passphrase:r.passphrase});if(!u)throw new Error("Failed create standalone session");const p=new Map,m=new Map,h=await o(u,l,p,m);if(!h)throw new Error("Failed to clone main node");await T("Session").update(u.id,{main_node_id:h.node.id,main_source_id:h!=null&&h.entity?h.entity.id:void 0,main_source_type:h.entityName?h.entityName:void 0});for(const{node:x,connectedNodes:f}of c.connections)if(await o(u,x,p,m),f)for(const g of f)await o(u,g,p,m);for(const{connections:x}of c.connections)for(const f of x){const g=m.get(`${f.source}`),_=m.get(`${f.target}`);if(!g||!_)throw new Error("Failed to get connected flow node id");await T("FlowEdge").save({source:g,target:_,sourceHandle:f.sourceHandle,targetHandle:f.targetHandle,session_id:u.id})}return s(),a(Vd("application",{applicationId:u.id})),!0}finally{n(!1)}},[o,r,s,a]);return{loading:t,createStandaloneSession:i}},bs=()=>{const[t,n]=d.useState(!1),a=A(o=>o.updateNodes),r=A(o=>o.updateEdges),s=d.useCallback(async o=>{try{n(!0),await T("FlowNode").delete(o);const i=await T("FlowEdge").find({where:[{source:o},{target:o}]});return await Promise.all(i.map(l=>T("FlowEdge").delete(l.id))),await a([{id:o,type:"remove"}]),await r(i.map(l=>({id:l.id,type:"remove"}))),!0}catch{return!1}finally{n(!1)}},[r,a]);return{loading:t,deleteNodeFlow:s}},js=xt(({cloneStandaloneSession:t})=>{const n=Te(),{t:a}=H("dialogs"),[r,s]=d.useState(""),{toast:o}=ge(),i=c=>{s(c.target.value)},l=async()=>{try{n.hide(),await t(r),s("")}catch{o({variant:"destructive",description:a("create_standalone_application.errors.create_failed")})}};return e.jsx(Nt,{open:n.visible,onOpenChange:n.hide,children:e.jsxs(Ct,{className:"sm:max-w-[425px]",children:[e.jsxs(St,{children:[e.jsx(Et,{children:a("create_session.title")}),e.jsx(Bn,{children:a("create_standalone_application.description")})]}),e.jsx("div",{className:"grid gap-4 py-4",children:e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(B,{className:"mb-2",htmlFor:"name",children:a("create_standalone_application.name")}),e.jsx(pe,{onChange:i,id:"name",value:r,placeholder:a("create_standalone_application.name_placeholder")})]})}),e.jsx(Un,{children:e.jsx(Y,{onClick:l,disabled:!r,type:"submit",children:a("create_standalone_application.create")})})]})})}),ae=d.memo(({id:t,className:n,enableToStandalone:a,getLinkedConnections:r})=>{const{t:s}=H("common"),{getNode:o}=we(),{loading:i,deleteNodeFlow:l}=bs(),{createStandaloneSession:c}=ws(),{toast:u}=ge(),p=Te(js),m=d.useCallback(async()=>{try{await l(t),u({description:s("deleted")})}catch{u({description:s("errors.delete_failed"),variant:"destructive"})}},[l,t,u,s]),h=d.useCallback(async f=>{try{const g=o(t);if(!g)throw new Error("No current node");const _=(r==null?void 0:r(t))||[];await c(g,{name:f,connections:_}),u({description:s("standalone_session_created")})}catch(g){yt("Clone Standalone Session",g),u({description:s("errors.create_standalone_session_failed"),variant:"destructive"})}},[o,t,r,c,u,s]),x=d.useCallback(()=>{p.show({cloneStandaloneSession:h})},[h,p]);return e.jsxs("div",{className:q("flex absolute z-[51] right-0 top-0 h-10",n),children:[a?e.jsx(Y,{className:"!rounded-none !px-2",onClick:x,variant:"ghost",children:e.jsx($,{name:"package-plus",size:16})}):void 0,e.jsx(Ie,{loading:i,className:"!rounded-none !px-2",onClick:m,variant:"ghost",children:e.jsx($,{name:"trash-2",size:16})})]})}),G=d.memo(t=>{const{className:n,...a}=t;return e.jsx(zo,{className:q("!w-2 !h-2 !border-none !rounded-full !bg-slate-700",t.position===W.Top?"!top-[-2px]":"",n),...a})}),Ns=()=>{const t=ee(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=A(i=>i.createOrUpdateFlowNode),s=A(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async i=>{var l,c;a(!0);try{const u=(l=i.data)==null?void 0:l.entity;if(!u||!t)throw new Error("LLM or Session not found");const p=i.position.x,m=i.position.y+(((c=i.measured)==null?void 0:c.height)||0),h=await T("Thread").save({initial_llm_id:u.id,title:`New thread with ${u.name}`,status:lt.Started,messages:[],session_id:t}),x=await r({source_id:h.id,source_type:"Thread",node_type:j.Thread,x:p,y:m+60});if(!x)throw new Error("Failed to create thread node");const f=await s({source:i.id,target:x.id});return{thread:h,flowNode:x,flowEdge:f}}finally{a(!1)}},[s,r,t]);return{loading:n,createThread:o}},Cs=(t,n)=>{var D;const{t:a}=H("flows"),{toast:r}=ge(),[s,o]=d.useState(!1),[i,l]=d.useState(!1),c=ie(t),{loadModel:u}=Kd(),{createThread:p,loading:m}=Ns(),h=A(b=>b.updateNodes),x=A(b=>b.pushSyncNodeQueue),{getNodes:f}=we(),g=d.useCallback(async()=>{try{if(l(!0),n.entity.id){const b=await T("Thread").find({where:{initial_llm_id:n.entity.id}});x("Thread",{where:{source_type:"Thread",source_id:ma(b.map(E=>E.id))}})}}finally{l(!1)}},[(D=n==null?void 0:n.entity)==null?void 0:D.id,x]),_=d.useCallback(async()=>{try{if(o(!0),n.entity&&c){await(u==null?void 0:u(n.entity.provider,`${n.entity.name}`,E=>{c.data.status=E.progress===100?le.Loaded:le.Loading,c.data.label=E.text,h([{id:t,type:"replace",item:c}])}));const b=f().filter(E=>E.type===j.LLM?E.data.entity.provider===J.WebLLM:!1).map(E=>(E.data.status=le.Started,{id:E.id,type:"replace",item:E}));c.data.label="",c.data.status=le.Loaded,b.push({id:t,type:"replace",item:c}),h(b),await g()}}catch(b){yt("Load Model",b),r({variant:"destructive",description:a("llm_node.errors.loading_model")})}finally{o(!1)}},[n.entity,f,t,u,c,g,a,r,h]),y=d.useCallback(async()=>{n.entity&&c&&await(p==null?void 0:p(c))},[n.entity,c,p]),M=d.useCallback(async b=>{n.entity&&c&&(c.data.entity.options=b,await T("LLM").update(n.entity.id,{options:b}),h([{id:t,type:"replace",item:c}]))},[n.entity,t,c,h]);return d.useEffect(()=>{n.entity&&c&&n.entity.status!==n.status&&(c.data.status=n.entity.status,h([{id:t,type:"replace",item:c}]))},[]),{loadingModel:s,creatingThread:m,queringThreads:i,changeLLMOptions:M,loadModel:_,createThread:y,queryThreads:g}},se=(t,n)=>{const[a,r]=d.useState(!1),[s,o]=d.useState([]),{deleteElements:i,getNode:l}=we();bt({type:"target",nodeId:t,onConnect:u=>{u!=null&&u.length&&o(p=>[...p,...Bo(u)])}});const c=d.useCallback(async(u,p,m,h)=>{try{return await n({id:t,edgeId:u,source:p,target:m,connection:h})}catch{return{deleteEdgeId:u}}},[n,t]);d.useEffect(()=>{!(s!=null&&s.length)||a||(async()=>{try{r(!0);const u=[...s];o([]);const p=[],m=l(t);await Promise.all(u.map(async h=>{const x="edgeId"in h?h.edgeId:void 0,f=l(h.source);if(!f||!m)return;const g=await c(`${x}`,f,m,h);g!=null&&g.deleteEdgeId&&p.push(...Array.isArray(g.deleteEdgeId)?g.deleteEdgeId:[g.deleteEdgeId])})),p!=null&&p.length&&await i({edges:p.map(h=>({id:h}))})}finally{r(!1)}})()},[i,l,t,a,c,s])},Ss=t=>{const n=d.useCallback(async()=>{},[]);se(t,n)},Es=d.memo(t=>{var y,M,D,b,E,v;const{id:n,data:a,isConnectable:r}=t,[s,o]=d.useState(),{t:i}=H("flows"),{createThread:l,loadModel:c,queringThreads:u,queryThreads:p,loadingModel:m,changeLLMOptions:h}=Cs(n,a);Ss(n);const x=[le.Loading,le.Downloading].includes(a.status);d.useEffect(()=>{var N,O,U,V,L;if(!(s||!((N=a==null?void 0:a.entity)!=null&&N.name))){if(((O=a==null?void 0:a.entity)==null?void 0:O.provider)!==J.WebLLM){o({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:(U=a==null?void 0:a.entity)==null?void 0:U.name,model:(V=a==null?void 0:a.entity)==null?void 0:V.name,model_lib:(L=a==null?void 0:a.entity)==null?void 0:L.provider,model_type:2}});return}xe(()=>import("./index-CTcNp3aO.js").then(async I=>(await I.__tla,I)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:I,functionCallingModelIds:F,prebuiltAppConfig:C})=>{var Z,K;const R=await I((Z=a==null?void 0:a.entity)==null?void 0:Z.name);o({hasCache:R,isFunctionCalling:F.includes((K=a==null?void 0:a.entity)==null?void 0:K.name),info:C.model_list.find(Q=>{var be;return Q.model_id===((be=a==null?void 0:a.entity)==null?void 0:be.name)})})})}},[(y=a==null?void 0:a.entity)==null?void 0:y.name,(M=a==null?void 0:a.entity)==null?void 0:M.provider,s]);const f=d.useCallback(async N=>{await h(N)},[h]),g=d.useMemo(()=>{var N,O;switch(a.status){case le.Downloading:return e.jsx($,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case le.Loaded:return e.jsx(Re,{name:((N=a.entity)==null?void 0:N.name)||"brain",className:"w-7 h-7"});case le.Loading:return e.jsx($,{className:"animate-spin w-7 h-7",name:"loader-circle"});default:return e.jsx(Re,{name:((O=a.entity)==null?void 0:O.name)||"brain",className:"w-7 h-7"})}},[(D=a.entity)==null?void 0:D.name,a.status]),_=d.useMemo(()=>x?null:m?e.jsx(Y,{disabled:!0,className:"w-full mt-4",children:e.jsx($,{className:"animate-spin",size:24,name:"loader-circle"})}):a.status===le.Loaded?e.jsx(Y,{onClick:l,className:"mt-4 w-full",children:i("llm_node.create_thread_button")}):e.jsxs("div",{className:"flex gap-2 mt-4",children:[s!=null&&s.hasCache?e.jsx(Ie,{loading:u,onClick:p,children:e.jsx($,{size:24,name:"message-square-more"})}):null,e.jsx(Y,{disabled:m,onClick:c,className:"w-full",children:i(s!=null&&s.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")})]}),[x,m,a.status,s==null?void 0:s.hasCache,u,p,c,i,l]);return e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(ae,{id:n}),e.jsxs(ve,{className:"flex justify-center",children:[g,e.jsxs("div",{className:"ml-2 pt-1 max-w-lg",children:[e.jsx(Oe,{className:"flex gap-2 items-center pr-6",children:`${((b=a==null?void 0:a.entity)==null?void 0:b.name)||""}`}),e.jsx(rt,{className:"max-w-full",children:`${a.label||""}`}),e.jsx("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:e.jsx(vt,{model:s==null?void 0:s.info,isFunctionCalling:(s==null?void 0:s.isFunctionCalling)||!1,name:(E=a==null?void 0:a.entity)==null?void 0:E.name,isCached:(s==null?void 0:s.hasCache)||!1,cloud:(s==null?void 0:s.cloud)||!1})}),e.jsx(Uo,{options:(v=a==null?void 0:a.entity)==null?void 0:v.options,onChangeOptions:f,className:"mt-2"}),_]})]}),x?e.jsx(On,{className:"rounded-lg"}):void 0]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),ht=d.memo(({tags:t,disabled:n,loading:a,onSubmit:r})=>{const{t:s}=H("components"),o=async i=>{try{return await r(i),!0}catch{return!1}};return e.jsxs(te,{className:"min-w-80",children:[e.jsx(oe,{children:e.jsx(ue,{children:s("add_message_card.title")})}),e.jsxs(de,{children:[e.jsx("div",{className:"grid w-full gap-1.5",children:e.jsx(el,{onSubmit:o,disabled:n||a,placeholder:s("add_message_card.placeholder")})}),t?e.jsx("div",{className:"mt-2 gap-1 flex flex-wrap",children:t}):null]})]})}),Wt=(t,n,a,r=[],s)=>{const o=t.map(i=>s.getNode(i));for(const i of o){if(!i)continue;const l=s.getHandleConnections({type:"target",nodeId:i.id});if(a.push(...l),i.type===j.Thread){r.push(i.id),n.push(i);continue}else if(i.type!==j.Message){r.push(i.id);continue}else if(r.includes(i.id))continue;r.push(i.id),n.push(i),l.length&&Wt(l.map(c=>c.source),n,a,r,s)}return{nodes:n,connections:a}},Jt=(t,n)=>{const a=n.getHandleConnections({nodeId:t.id,type:"target"}),r=a.map(m=>{const h=n.getNode(m.source);return h?{connections:n.getHandleConnections({nodeId:h.id,type:"target"}),node:h}:void 0}),s=r.filter(m=>{var h;return((h=m.node)==null?void 0:h.type)===j.Prompt}),o=[];s!=null&&s.length&&s.forEach(m=>{var x;const h=(x=m.connections)==null?void 0:x.map(f=>n.getNode(f.source)).filter(Boolean);o.push({node:m.node,connections:m.connections,connectedNodes:h})});const i=r.filter(m=>{var h;return((h=m.node)==null?void 0:h.type)===j.ToolDefinition}),l=[];i!=null&&i.length&&i.forEach(m=>{var x;const h=(x=m.connections)==null?void 0:x.map(f=>n.getNode(f.source)).filter(Boolean);h!=null&&h.find(f=>f.type===j.Schema)&&l.push({node:m.node,connections:m.connections,connectedNodes:h})});const c=r.filter(m=>{var h;return((h=m.node)==null?void 0:h.type)===j.PlaceHolder}),u=[];c!=null&&c.length&&c.forEach(m=>{var x;const h=(x=m.connections)==null?void 0:x.map(f=>n.getNode(f.source)).filter(Boolean);h&&u.push({node:m.node,connections:m.connections,connectedNodes:h})});const p=r.find(m=>{var h;return((h=m.node)==null?void 0:h.type)===j.Schema});return{thread:{node:t,connections:a},llm:r.find(m=>{var h;return((h=m.node)==null?void 0:h.type)===j.LLM}),schemas:p?[p]:[],prompts:o,tools:l,placeholders:u}},Kt=t=>{const n=[];return t.forEach(a=>{var o,i,l;const{node:r,connectedNodes:s}=a;if((o=r.data)!=null&&o.entity){if(r.type===j.Message){const c=r.data.entity;switch(c.role){case"human":n.push(new Je(c.content));break;case"ai":n.push(new kt(c.content));break}}else if(r.type===j.Prompt){const c=r.data.entity;let u=`${c.prefix?`${c.prefix}
`:""}`;if(c.type===fe.FewShotExample){const p=(l=(i=s.find(m=>m.type===j.CSVData))==null?void 0:i.data)==null?void 0:l.entity;if(p){const{rows:m}=Gn(p.headers,p.csv);m.forEach(h=>{u+=`${c.content.replace(/{([^{}]*)}/g,(x,f)=>`${h[f]}`)}
`})}}else u+=c.content;switch(c.suffix&&(u+=`
${c.suffix}`),c.role){case"human":n.push(new Je(u));break;case"system":n.push(new Wn(u));break;default:n.push(new kt(u));break}}}}),n},ks=(t,n)=>{const a=(t==null?void 0:t.filter(s=>s.type===j.Message).map(s=>({node:s,connectedNodes:[]})).reverse())||[],r=[];return n.forEach(async s=>{r.unshift({node:s.node,connectedNodes:s.connectedNodes||[]})}),{history:Kt(a),systems:Kt(r)}},Ms=t=>t?t.reduce((n,a)=>{var o,i,l,c,u;const r=(o=a.node.data)==null?void 0:o.entity,s=(c=(l=(i=a==null?void 0:a.connectedNodes)==null?void 0:i.find(p=>p.type===j.Schema))==null?void 0:l.data)==null?void 0:c.entity;return r&&((u=s==null?void 0:s.schema_items)!=null&&u.length)&&n.push({name:r.name,description:r.description,schemaItems:s.schema_items}),n},[]):[],ft=()=>{const{getNodes:t}=we(),n=d.useCallback(()=>t().find(r=>r.type===j.DefaultEmbeddingModel),[t]),a=d.useCallback(()=>{var r,s;return(s=(r=n())==null?void 0:r.data)==null?void 0:s.entity},[n]);return{getFlowEmbeddingNode:n,getFlowEmbeddingEntity:a}},Xt=({getNode:t,getHandleConnections:n})=>{const{t:a}=H("create_new_message"),[r,s]=d.useState(!1),o=ee(g=>g.currentSession),i=A(g=>g.createOrUpdateFlowNode),l=A(g=>g.createOrUpdateFlowEdge),{similaritySearchWithScore:c}=aa(),{getFlowEmbeddingEntity:u}=ft(),{stream:p}=pa(),m=d.useCallback(async({content:g,threadId:_,sourceId:y,initialX:M,initialY:D,initialLLMId:b})=>{if(!o)throw new Error("Session is not found");const E=await T("Message").save({thread_id:_,content:g,role:he.Human,status:_e.Started,llm_id:b,session_id:o.id});if(!E)throw new Error("Failed to save message");const v=await i({source_id:E.id,source_type:"Message",node_type:j.Message,x:M,y:D+80});if(!v)throw new Error("Failed to save human message node");await l({source:y,target:v.id});const N=await T("Message").save({thread_id:_,content:a("initial_ai_message"),role:he.AI,status:_e.Inprogress,llm_id:b,parent_message_id:E.id,session_id:o.id});if(!N)throw new Error("Failed to save message");const O=await i({source_id:N.id,source_type:"Message",node_type:j.Message,x:M,y:D+250});if(!O)throw new Error("Failed to save ai message node");return await l({source:v.id,target:O.id}),{aiMessage:N,humanMessage:E,aiMessageNode:O,humanMessageNode:v}},[l,i,o,a]),h=d.useCallback(async(g,_)=>{const{placeholders:y}=_;if(!(y!=null&&y.length))return[];const M=[];return await Promise.all(y.map(async D=>{var E,v,N,O,U,V,L,I,F,C,R,Z;const b=(E=D.node.data)==null?void 0:E.entity;if(b)switch(b.placeholder_type){case it.VECTOR_DATABASE_RETREIVER:{const K=(v=D.connectedNodes)==null?void 0:v.find(w=>w.type===j.VectorDatabase),Q=(N=K==null?void 0:K.data)==null?void 0:N.entity,be=(V=(U=(O=D.connectedNodes)==null?void 0:O.find(w=>w.type===j.Prompt))==null?void 0:U.data)==null?void 0:V.entity;if(!be||!Q||!K)return;const He=(L=b.metadata)!=null&&L.k?+((I=b.metadata)==null?void 0:I.k):1;let ye=(F=b.metadata)!=null&&F.minimalScore?+((C=b.metadata)==null?void 0:C.minimalScore):void 0;ye&&ye>1&&(ye=ye/100);const S=[];if(Q.storage===Fe.DataNode){const w=(Z=(R=n({nodeId:K.id,type:"target"}).map(k=>t(k.source)).find(k=>(k==null?void 0:k.type)&&[j.JSONLData,j.CSVData].includes(k==null?void 0:k.type)))==null?void 0:R.data)==null?void 0:Z.entity;if(!w)return;S.push(...await c(u(),{database:{databaseId:Q.id,dataSourceId:w.id,dataSourceType:ia(w)}},g.humanMessage.content,He)||[])}else S.push(...await c(u(),{database:{databaseId:Q.id}},g.humanMessage.content,He)||[]);if(!S)return[];const P=new qo({template:be.content,inputVariables:["context"]});M.push(new kt(await P.format({context:ye?S.filter(([,w])=>w>=ye).map(([w])=>w.pageContent).join(`
`):S.map(([w])=>w.pageContent).join(`
`)})))}}})),M},[u,n,t,c]),x=d.useCallback(async(g,_,y,{onMessageUpdate:M})=>{var Z;const{prompts:D,tools:b,schemas:E,placeholders:v,llm:N}=_,O=(Z=N==null?void 0:N.node.data)==null?void 0:Z.entity;if(!O)throw new Error("LLM is not found");const U=[];v!=null&&v.length&&U.push(...await h(g,_));const{history:V,systems:L}=ks(y,D),I=[...L,...U,...V,new Je(g.humanMessage.content)],F=E.map(K=>{var Q;return(Q=K.node.data)==null?void 0:Q.entity}).filter(Boolean),{lastChunk:C,content:R}=await p(O.provider,I,{tools:Ms(b),schemas:F,llm:O,onMessageUpdate:({content:K})=>{M==null||M({id:g.aiMessageNode.id,nodeData:{loading:!0,content:K}})}});return g.aiMessage.content=R,g.aiMessage.metadata=JSON.stringify({message:C}),M==null||M({id:g.aiMessageNode.id,nodeData:{content:R,loading:!1,entity:g.aiMessage}}),g.aiMessage.id&&await T("Message").update(g.aiMessage.id,{content:R,metadata:JSON.stringify({message:C})}),R},[h,p]),f=d.useCallback(async(g,_,y)=>{var N,O,U;const{nodes:M}=Wt([g.id],[],[],[],{getNode:t,getHandleConnections:n}),D=M.find(V=>V.type===j.Thread),b=D==null?void 0:D.data.entity;if(!g||!b||!D)throw new Error("Source or thread is not found");const E=Jt(D,{getNode:t,getHandleConnections:n});if(!(E!=null&&E.thread))throw new Error("Thread node is not found");let v;try{s(!0);const V=((N=g.position)==null?void 0:N.x)||0,L=(((O=g.position)==null?void 0:O.y)||0)+(((U=g.measured)==null?void 0:U.height)||0);return v=await m({content:_,initialX:V,initialY:L,sourceId:g.id,threadId:b.id,initialLLMId:b.initial_llm_id}),await x(v,E,M,y),await T("Message").update(`${v.aiMessage.id}`,{status:_e.Success}),v.aiMessage.status=_e.Success,y.onMessageUpdate({id:v.aiMessageNode.id,nodeData:{entity:v.aiMessage,loading:!1}}),!0}catch(V){yt("Create Message",V),v!=null&&v.aiMessage&&await T("Message").update(`${v.aiMessage.id}`,{status:_e.Failed,content:a("errors.ai_message_content_failed")}),v!=null&&v.aiMessageNode.id&&(y==null||y.onMessageUpdate({id:v.aiMessageNode.id,nodeData:{content:a("errors.ai_message_content_failed"),entity:{...v.aiMessage,status:_e.Failed,content:a("errors.ai_message_content_failed")},loading:!1}}))}finally{s(!1)}},[n,t,m,x,a]);return{loading:r,createMessage:f}},Ls=(t,n)=>{const a=ie(t),{t:r}=H("flows"),{getNode:s,getHandleConnections:o}=we(),i=A(h=>h.updateNodes),{createMessage:l,loading:c}=Xt({getNode:s,getHandleConnections:o}),u=d.useCallback(h=>{if(!h.id)return;const x=s(h.id);!x||!h.nodeData||i([{id:x.id,type:"replace",item:{...x,data:{...x.data,...Fn(h.nodeData,Rn)}}}])},[s,i]),p=d.useCallback(async h=>{if(a&&n.entity)try{await l(a,h,{onMessageUpdate:u})}catch(x){if(x instanceof Error&&x.message.includes("LLM_NOT_LOADED_YET"))return qe({variant:"destructive",title:r("thread_node.errors.llm_not_loaded_yet")});qe({variant:"destructive",title:`${x}`})}},[a,n.entity,l,u,r]),m=d.useCallback(h=>{const x=s(h);if(!x)return[];const f=[],g=Jt(x,{getNode:s,getHandleConnections:o});return g.thread&&f.push({node:g.thread.node,connectedNodes:[],connections:g.thread.connections}),g.prompts&&f.push(...g.prompts.map(_=>({node:_.node,connectedNodes:_.connectedNodes,connections:_.connections}))),g.schemas&&f.push(...g.schemas.map(_=>({node:_.node,connectedNodes:[],connections:_.connections}))),g.placeholders&&g.placeholders.forEach(_=>{const y=_.connections.map(M=>s(M.source)).filter(Boolean);f.push({node:_.node,connectedNodes:y||[],connections:_.connections})}),g.llm&&f.push(g.llm),f},[o,s]);return{loading:c,createMessage:p,getLinkedConnections:m}},Ds=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===j.Prompt&&(o==null?void 0:o.type)===j.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===j.LLM&&(o==null?void 0:o.type)===j.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===j.Schema&&(o==null?void 0:o.type)===j.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===j.ToolDefinition&&(o==null?void 0:o.type)===j.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===j.VectorDatabase&&(o==null?void 0:o.type)===j.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===j.PlaceHolder&&(o==null?void 0:o.type)===j.Thread&&s.data.entity.placeholder_type===it.VECTOR_DATABASE_RETREIVER){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Is=d.memo(t=>{const{id:n,data:a,isConnectable:r}=t,{t:s}=H("flows"),[o,i]=d.useState(!1),l=bt({type:"source"}),c=bt({type:"target"}),{getNode:u}=we(),{loading:p,createMessage:m,getLinkedConnections:h}=Ls(n,a);Ds(n);const x=d.useCallback(async(...y)=>(i(!1),await m(...y)),[m]),f=d.useMemo(()=>l.length>0,[l]),g=d.useCallback(()=>{i(y=>!y)},[]),_=d.useMemo(()=>{var M,D;const y=c.map((b,E)=>{var N;const v=u(b.source);if((v==null?void 0:v.type)===j.Schema)return e.jsx(Be,{children:s("thread_node.structured_output")},`${E}`);if((v==null?void 0:v.type)===j.Prompt){const O=v.data.entity;return e.jsx(Be,{children:s(O.type===fe.FewShotExample?"thread_node.prompts.few_shot_example":`thread_node.prompts.${O.role.toLowerCase()}`)},`${E}`)}else if((v==null?void 0:v.type)===j.PlaceHolder&&((N=v.data.entity)==null?void 0:N.placeholder_type)===it.VECTOR_DATABASE_RETREIVER)return e.jsx(Be,{children:s("thread_node.vector_database_retriever")},`${E}`)}).filter(Boolean);return t.data.entity&&!((D=(M=t.data.entity)==null?void 0:M.messages)!=null&&D.length)&&!f?e.jsx(ht,{disabled:p,loading:p,onSubmit:x,tags:y}):y!=null&&y.length?e.jsxs(te,{className:"p-4 pt-2",children:[e.jsx(ue,{className:"mb-2",children:s("thread_node.title")}),e.jsx("div",{className:"flex gap-1.5",children:y}),e.jsx("div",{className:"mt-4 w-full flex justify-end",children:e.jsxs(Y,{onClick:g,variant:"outline",children:[e.jsx($,{name:o?"copy-minus":"copy-plus"}),s(o?"thread_node.hide":"thread_node.clone")]})})]}):e.jsx("div",{className:"w-12 h-10"})},[f,u,x,g,p,t.data.entity,o,s,c]);return e.jsxs("div",{children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(ae,{id:n,enableToStandalone:!0,getLinkedConnections:h}),_,o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-[1px] absolute ml-[50%] h-[30px] bg-gray-500"}),e.jsx("div",{className:"absolute mt-[30px] w-full",children:e.jsx("div",{className:"ml-[10%] w-80 animate-in slide-in-from-bottom-5",children:e.jsx(ht,{disabled:p,loading:p,onSubmit:x})})})]}):void 0]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})});function Ai({data:t,onNewThread:n,loading:a,showThread:r}){var o;const{t:s}=H("flows");return e.jsxs(ve,{className:"flex min-w-52",children:[e.jsx($,{size:24,name:"user"}),e.jsxs("div",{className:"ml-2 max-w-full w-full",children:[e.jsx(Oe,{children:"Human"}),e.jsx(rt,{children:`${t.content||((o=t.entity)==null?void 0:o.content)||""}`}),n?e.jsx("div",{className:"w-full mt-2 flex items-center justify-end",children:e.jsxs(Y,{onClick:n,disabled:a,variant:"outline",children:[e.jsx($,{name:r?"minus":"plus",size:16}),s(r?"message_node.hide_thread":"message_node.new_thread")]})}):void 0]})]})}function Oi({data:t,onNewThread:n,loading:a,showThread:r}){var c,u,p,m,h,x,f,g,_;const{t:s}=H("flows"),o=d.useMemo(()=>{var y;try{return JSON.parse(((y=t==null?void 0:t.entity)==null?void 0:y.metadata)||"{}")}catch{return{}}},[(c=t==null?void 0:t.entity)==null?void 0:c.metadata]),i=t.entity.status===_e.Failed,l=d.useMemo(()=>{var y;return e.jsx(Go,{source:`${t.content||((y=t.entity)==null?void 0:y.content)||""}`})},[t.content,(u=t.entity)==null?void 0:u.content]);return e.jsxs(ve,{className:q("flex min-w-52",i?"bg-background":""),variant:i?"destructive":"default",children:[e.jsx($,{className:q(t.loading?"animate-spin":void 0),size:24,name:t.loading?"loader-circle":"bot"}),e.jsx($,{name:r?"minus":"plus",size:24}),e.jsxs("div",{className:"ml-2 w-full max-w-full",children:[e.jsx(Oe,{children:s(`message_node.message_roles.${(m=(p=t.entity)==null?void 0:p.role)==null?void 0:m.toLowerCase()}`)}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-ful rounded-lg flex justify-center items-center",children:e.jsx($,{name:"loader-circle",className:"animate-spin"})}),children:i?t.content||((h=t.entity)==null?void 0:h.content)||"":l}),Array.isArray((x=o==null?void 0:o.message)==null?void 0:x.tool_calls)&&((g=(f=o==null?void 0:o.message)==null?void 0:f.tool_calls)!=null&&g.length)?(_=o==null?void 0:o.message)==null?void 0:_.tool_calls.map((y,M)=>e.jsx(Be,{children:s("message_node.tool_call",{name:y.name,args:Object.entries(y.args).map(([D,b])=>`"${D}": "${b}"`).join(", ")})},`${y.name}_${M}`)):null,n?e.jsx("div",{className:"w-full mt-2 flex items-center justify-end",children:e.jsxs(Y,{onClick:n,disabled:a,variant:"outline",children:[e.jsx($,{name:r?"minus":"plus",size:16}),s(r?"message_node.hide_thread":"message_node.new_thread")]})}):void 0]}),t.loading?e.jsx(On,{size:350,duration:10}):void 0]})}const Fi=t=>{const{t:n}=H("flows"),a=ie(t),r=A(p=>p.updateNodes),{getNode:s,getHandleConnections:o}=we(),{createMessage:i,loading:l}=Xt({getNode:s,getHandleConnections:o}),c=d.useCallback(p=>{if(!p.id)return;const m=s(p.id);!m||!p.nodeData||r([{id:m.id,type:"replace",item:{...m,data:{...m.data,...Fn(p.nodeData,Rn)}}}])},[s,r]),u=d.useCallback(async p=>{if(a)try{await i(a,p,{onMessageUpdate:c})}catch(m){if(m instanceof Error&&m.message.includes("LLM_NOT_LOADED_YET"))return qe({variant:"destructive",title:n("message_node.errors.llm_not_loaded_yet")});qe({variant:"destructive",title:n("message_node.errors.create_message")})}},[a,n,i,c]);return{loading:l,createMessage:u}},Ts=()=>{const t=ee(r=>r.currentSession),n=A(r=>r.createOrUpdateFlowNode),a=A(r=>r.createOrUpdateFlowEdge);return{createIdieMessage:d.useCallback(async(r,s,o,i)=>{var f,g,_,y,M;if(!r||!s||!t)return;const l=(g=(f=i==null?void 0:i.promptNode)==null?void 0:f.data)==null?void 0:g.entity,c=((_=r.position)==null?void 0:_.x)||0,u=(((y=r.position)==null?void 0:y.y)||0)+(((M=r.measured)==null?void 0:M.height)||0),p=await T("Message").save({thread_id:s.id,content:o,role:(l==null?void 0:l.role)||he.Human,status:_e.Started,llm_id:s.initial_llm_id,session_id:t.id});if(!p)throw new Error("Failed to save message");const m=await n({source_id:p.id,source_type:"Message",node_type:j.Message,x:c,y:u});if(!m)throw new Error("Failed to save message node");const h=await a({source:r.id,target:m.id});let x;return i!=null&&i.promptNode&&(x=await a({source:i==null?void 0:i.promptNode.id,target:m.id})),{message:p,edgeToPrompt:x,messageNode:m,messageEdge:h}},[n,a])}},Ri=t=>{const{createIdieMessage:n}=Ts(),a=d.useCallback(async({edgeId:r,source:s,target:o})=>{var i,l;try{if((s==null?void 0:s.type)===j.Prompt&&(o==null?void 0:o.type)===j.Message){const c=(i=o==null?void 0:o.data)==null?void 0:i.entity,u=(l=s==null?void 0:s.data)==null?void 0:l.entity;if(!u||!c||!o)return{deleteEdgeId:r};await n(o,{id:c==null?void 0:c.thread_id,title:"",status:lt.Started,initial_llm_id:c.llm_id,session_id:u.session_id},u.content,{promptNode:s});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Pi=d.memo(t=>{var D,b,E;const{id:n,data:a,isConnectable:r}=t,[s,o]=d.useState(!1),[i,l]=d.useState(!1),{t:c}=H("common"),u=bt({type:"source"}),{loading:p,createMessage:m}=Fi(n),{toast:h}=ge();Ri(n);const x=d.useCallback(async(...v)=>{const N=await m(...v);return o(!1),N},[m]),f=d.useMemo(()=>u.length===0,[u]),g=d.useCallback(()=>{var v;(v=a.entity)!=null&&v.content&&(navigator.clipboard.writeText(a.entity.content),h({description:c("copied")}))},[h,a,c]),_=d.useCallback(async()=>{var v;try{if(i)return await kn.stop(),l(!1);l(!0),await kn.speak(((v=a.entity)==null?void 0:v.content)||"")}catch{h({variant:"destructive",description:c("errors.speech_is_not_supported")})}finally{l(!1)}},[(D=a.entity)==null?void 0:D.content,i,c,h]),y=d.useCallback(()=>{o(v=>!v)},[]),M=d.useMemo(()=>{var v;if(!(!f&&!s||a.loading||p||((v=a==null?void 0:a.entity)==null?void 0:v.status)==="inprogress"))return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-[1px] absolute ml-[50%] h-[30px] bg-gray-500"}),e.jsx("div",{className:"absolute mt-[30px] w-full",children:e.jsx("div",{className:"ml-[10%] w-80 animate-in slide-in-from-bottom-5",children:e.jsx(ht,{disabled:p,loading:p,onSubmit:x})})})]})},[(b=a==null?void 0:a.entity)==null?void 0:b.status,a.loading,x,f,p,s]);return e.jsxs("div",{children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsxs("div",{className:"max-w-sm min-w-64",children:[e.jsxs("div",{className:"w-auto",children:[e.jsx(ae,{id:n}),e.jsx("div",{children:((E=a.entity)==null?void 0:E.role)===he.Human?e.jsx(Ai,{data:a,showThread:s,onNewThread:f?void 0:y}):e.jsx(Oi,{data:a,showThread:s,loading:p,onNewThread:f?void 0:y})}),e.jsx(Y,{onClick:_,className:"absolute top-0 right-[68px] !px-2 !rounded-none",variant:"ghost",children:e.jsx($,{name:i?"circle-stop":"speech",size:16})}),e.jsx(Y,{onClick:g,className:"absolute top-0 right-[36px] !px-2 !rounded-none",variant:"ghost",children:e.jsx($,{name:"copy",size:16})})]}),M]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),$i=t=>{const n=A(s=>s.createOrUpdateFlowEdge),{createIdieMessage:a}=Ts(),r=d.useCallback(async({edgeId:s,source:o,target:i})=>{var l,c,u,p;try{const m=(l=i==null?void 0:i.data)==null?void 0:l.entity,h=(c=o==null?void 0:o.data)==null?void 0:c.entity;if((o==null?void 0:o.type)===j.Message&&(i==null?void 0:i.type)===j.Prompt){const x=(u=o==null?void 0:o.data)==null?void 0:u.entity,f=(p=i==null?void 0:i.data)==null?void 0:p.entity;if(!f||!x||!i)return{deleteEdgeId:s};await a(o,{id:x==null?void 0:x.thread_id,title:"",status:lt.Started,initial_llm_id:x.llm_id,session_id:f.session_id},f.content,{promptNode:i});return}else if((o==null?void 0:o.type)===j.CSVData&&(i==null?void 0:i.type)===j.Prompt&&(m==null?void 0:m.type)===fe.FewShotExample&&(h!=null&&h.headers.includes("input"))&&(h!=null&&h.headers.includes("output"))){await n({source:o.id,target:i.id});return}return{deleteEdgeId:s}}catch{return{deleteEdgeId:s}}},[a,n]);se(t,r)},Vi=d.memo(t=>{var u,p,m;const{id:n,data:a,isConnectable:r}=t;$i(n);const s=Te(Wo),o=d.useMemo(()=>{var h,x,f;return`${(h=a.entity)!=null&&h.prefix?`${(x=a.entity)==null?void 0:x.prefix}
`:""}${((f=a.entity)==null?void 0:f.content)||""}`},[(u=a.entity)==null?void 0:u.prefix,(p=a.entity)==null?void 0:p.content]),i=d.useMemo(()=>{var x;const h=/{(.*?)}/g;return((x=o.match(h))==null?void 0:x.map(f=>f.replace("{","").replace("}","")))||[]},[o]),l=o.length>990,c=()=>{s.show({title:"Prompt",content:o})};return e.jsxs("div",{className:"min-w-56",children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(ae,{id:n}),e.jsxs(ve,{className:"flex justify-center max-w-72",variant:"default",children:[e.jsx($,{size:24,name:"notepad-text"}),e.jsxs("div",{className:"ml-2 max-w-full break-words break-all",children:[e.jsx(Oe,{children:`${((m=a.entity)==null?void 0:m.role)||""}`}),e.jsxs(rt,{onClick:l?c:void 0,children:[l?`${o.slice(0,990)}...`:o,l?e.jsx("span",{className:"float-right",children:e.jsx($,{name:"chevron-right"})}):void 0]}),i!=null&&i.length?i.map((h,x)=>e.jsx(Be,{className:"mt-2 mr-1",variant:"default",children:h},x)):void 0]})]})]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),As=t=>{const n=["Bytes","KB","MB","GB","TB"];if(t===void 0)return"Unknown size";if(t===0)return"0 Byte";const a=Math.floor(Math.log(t)/Math.log(1024));return`${Math.round(t/Math.pow(1024,a))} ${n[a]}`},Hi=d.memo(()=>{const{t}=H("flows"),[n,a]=d.useState(),r=ot(h=>h.cachedLLMURLs),s=ee(h=>h.currentSession),[o,i]=d.useState(),[l,c]=d.useState(""),[,u]=d.useState();d.useEffect(()=>{xe(async()=>{const{functionCallingModelIds:h,prebuiltAppConfig:x}=await import("./index-CTcNp3aO.js").then(async f=>(await f.__tla,f));return{functionCallingModelIds:h,prebuiltAppConfig:x}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({functionCallingModelIds:h,prebuiltAppConfig:x})=>{a(r==null?void 0:r.map(f=>{const g=x.model_list.find(_=>f.includes(_.model));if(g)return{model_id:(g==null?void 0:g.model_id)||"",info:g,isFunctionCalling:h.includes((g==null?void 0:g.model_id)||"")}}))})},[r,s==null?void 0:s.id]);const p=d.useCallback(async()=>{navigator.storage.estimate().then(h=>{h&&c(t("session_info_node.used_bytes",{used:As(h.usage),total:As(h==null?void 0:h.quota)}))}),s!=null&&s.id&&(Promise.all([T("FlowNode").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("FlowEdge").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("Thread").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("Prompt").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("LLM").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("Schema").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("ToolDefinition").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("VectorDatabase").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("JSONLData").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),T("CSVData").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}})]).then(h=>{const x=h.reduce((f,g)=>g!=null&&g.updated_at&&(!f||new Date(g.updated_at)>f)?new Date(g.updated_at):f,s.updated_at?new Date(s.updated_at):void 0);i(x)}),Promise.all([T("FlowNode").count({where:{session_id:s==null?void 0:s.id}}),T("FlowEdge").count({where:{session_id:s==null?void 0:s.id}}),T("Thread").count({where:{session_id:s==null?void 0:s.id}}),T("Prompt").count({where:{session_id:s==null?void 0:s.id}}),T("LLM").count({where:{session_id:s==null?void 0:s.id}}),T("ToolDefinition").count({where:{session_id:s==null?void 0:s.id}}),T("Schema").count({where:{session_id:s==null?void 0:s.id}}),T("VectorDatabase").count({where:{session_id:s==null?void 0:s.id}}),T("JSONLData").count({where:{session_id:s==null?void 0:s.id}}),T("CSVData").count({where:{session_id:s==null?void 0:s.id}})]).then(([h,x,f,g,_,y,M,D,b,E])=>{u([{name:t("session_info_node.count_info.title"),nodes:h||0,edges:x||0,threads:f||0,prompts:g||0,llms:_||0,tools:y||0,schemas:M||0,vectorDatabases:D||0,jsonlDatas:b||0,csvDatas:E||0}])}))},[s==null?void 0:s.id,s==null?void 0:s.updated_at,t]),m=d.useCallback(()=>{p()},[p]);return d.useEffect(()=>{p()},[p]),e.jsxs(te,{className:"w-96",children:[e.jsxs(oe,{children:[e.jsx(ue,{children:t("session_info_node.title")}),e.jsx(Jo,{children:o||s!=null&&s.updated_at?Io(o||(s==null?void 0:s.updated_at)).fromNow():""})]}),e.jsxs(de,{className:"grid gap-4",children:[e.jsx("div",{className:"flex items-center space-x-4 rounded-md border p-4",children:e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:t("session_info_node.disk_size")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l})]})}),e.jsx("div",{className:"flex items-center space-x-4 rounded-md border p-4",children:e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"text-sm font-medium leading-none",children:[t("session_info_node.cached_llms"),e.jsx(Be,{className:"ml-2",children:(n==null?void 0:n.length)||0})]}),n==null?void 0:n.map(h=>e.jsxs("div",{className:"text-sm text-muted-foreground gap-1",children:[h==null?void 0:h.model_id,e.jsx("div",{className:"max-w-full gap-1 flex flex-wrap mt-1",children:e.jsx(vt,{model:h==null?void 0:h.info,isFunctionCalling:(h==null?void 0:h.isFunctionCalling)||!1,isCached:!0,cloud:!1})})]},h==null?void 0:h.model_id))]})}),e.jsx("div",{})]}),e.jsx(Ae,{children:e.jsxs(Y,{className:"w-full",onClick:m,children:[e.jsx($,{size:24,name:"refresh-ccw"}),t("session_info_node.reload")]})})]})}),zi=t=>{const n=d.useCallback(async({edgeId:a})=>{try{return{deleteEdgeId:a}}catch{return{deleteEdgeId:a}}},[]);se(t,n)},Bi=d.memo(t=>{var c,u;const{t:n}=H("flows"),{id:a,data:r,isConnectable:s}=t,o=d.useRef(!1),i=ie(a),l=A(p=>p.updateNodes);return zi(a),d.useEffect(()=>{var m;const p=r==null?void 0:r.entity;!p||!i||o.current||(m=p==null?void 0:p.schema_items)!=null&&m.length||r.loaded||(o.current=!0,T("SchemaItem").find({where:{schema_id:p.id}}).then(h=>{l([{id:i.id,type:"replace",item:{...i,data:{...(i==null?void 0:i.data)||{},loaded:!0,entity:{...r.entity,schema_items:h}}}}])}).finally(()=>{o.current=!1}))},[r.entity,r.loaded,i,l]),e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(ae,{id:a}),e.jsxs(Pn,{defaultValue:"account",className:"w-[400px]",children:[e.jsxs($n,{className:"grid w-full grid-cols-2",children:[e.jsx(Ge,{value:"account",children:n("schema_node.typescript")}),e.jsx(Ge,{value:"password",children:n("schema_node.zod")})]}),e.jsx(We,{value:"account",children:e.jsx(te,{className:"p-4",children:e.jsx("pre",{className:"overflow-hidden break-words whitespace-pre-wrap",children:Xd(((c=r==null?void 0:r.entity)==null?void 0:c.schema_items)||[])})})}),e.jsx(We,{value:"password",children:e.jsx(te,{className:"p-4 max-w-full",children:e.jsx("pre",{className:"overflow-hidden break-words whitespace-pre-wrap",children:Zd(((u=r==null?void 0:r.entity)==null?void 0:u.schema_items)||[])})})})]})]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:s})]})}),Ui=d.memo(t=>{var o,i;const{id:n,data:a,isConnectable:r}=t,s=d.useMemo(()=>{if(!(a!=null&&a.entity))return{headers:[],rows:[]};const l=oa(a.entity.csv);return{headers:da(a.entity.headers),rows:l.map(c=>da(c))}},[a==null?void 0:a.entity]);return e.jsxs("div",{children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(ae,{id:n}),e.jsxs(te,{className:"min-w-32 min-h-16 p-4",children:[e.jsx(oe,{className:"!p-0",children:e.jsxs("div",{className:"pt-2 flex !flex-row",children:[e.jsx($,{name:"file-spreadsheet",className:"mr-2"}),e.jsxs(B,{className:"!font-medium leading-none tracking-tight pr-8",children:[j.CSVData," ",(o=s==null?void 0:s.rows)!=null&&o.length?`(${((i=s==null?void 0:s.rows)==null?void 0:i.length)||0})`:""]})]})}),e.jsx(de,{className:"pb-0",children:e.jsx(sa,{data:s.rows,headers:s.headers})})]})]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),qi=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===j.Schema&&(o==null?void 0:o.type)===j.ToolDefinition){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Gi=d.memo(({id:t,data:n,isConnectable:a})=>{var r,s;return qi(t),e.jsxs("div",{children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:a}),e.jsx("div",{children:e.jsxs(ve,{className:"flex justify-center",children:[e.jsx($,{size:24,name:"wrench"}),e.jsxs("div",{className:"ml-2",children:[e.jsx(Oe,{children:`${((r=n.entity)==null?void 0:r.name)||""}`}),e.jsx(rt,{children:`${((s=n.entity)==null?void 0:s.description)||""}`})]})]})}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:a})]})}),Wi=d.memo(t=>{var m,h;const[n,a]=d.useState(!1),[r,s]=d.useState({}),[o,i]=d.useState({}),{confirmPassphrase:l}=Yn(),{t:c}=H("atoms"),u=async()=>{var x;if(n)s({}),i({});else{if((x=Object.keys(t.encrypted||{}))!=null&&x.length){await l();const f={},g=await _t.get("passphrase");if(!g)throw new Error("Passphrase is not found");await Promise.all(Object.keys(t.encrypted||{}).map(async _=>{var y,M;(y=t.encrypted)!=null&&y[_]&&(f[_]=await Yd((M=t.encrypted)==null?void 0:M[_],g))})),i(f||{})}s({...t.options})}a(!n)},p=()=>{var x;(x=t.onChangeOptions)==null||x.call(t,r||{},o||{}),a(!1)};return e.jsx("div",{className:q("min-w-20 flex justify-end",t.className),children:e.jsxs(Qn,{open:n,onOpenChange:a,children:[e.jsx(tl,{children:e.jsx("div",{className:"flex justify-end gap-2 !cursor-pointer",children:e.jsxs(Y,{onClick:u,variant:"link",className:"flex items-center px-0 !cursor-pointer",children:[e.jsx($,{name:"settings"}),e.jsx(B,{children:c("embedding_setting.title")})]})})}),e.jsx(er,{className:"w-full p-0",children:n?e.jsxs(te,{className:"!border-none max-w-96 min-w-56",children:[e.jsx(oe,{children:e.jsx(ue,{children:c("embedding_setting.title")})}),e.jsxs(de,{children:[e.jsxs(B,{children:[c("embedding_setting.provider"),":"]}),e.jsxs(Ee,{value:r!=null&&r.provider?`${r==null?void 0:r.provider}`:"local_transformers",onValueChange:x=>s({provider:x}),children:[e.jsx(ke,{className:"",children:e.jsx(Me,{placeholder:c("embedding_setting.provider_placeholder")})}),e.jsxs(Le,{children:[e.jsx(me,{value:"local_transformers",children:c("embedding_setting.providers.local_transformers")},"local_transformers"),(m=t.supportedProviders)==null?void 0:m.map(x=>e.jsx(me,{value:x,children:c(`embedding_setting.providers.${x.toLowerCase()}`)},x))]})]}),(h=t.supportedProviders)!=null&&h.length?void 0:e.jsx(B,{className:"text-red-500 !pt-2",children:c("embedding_setting.alerts.no_provider")}),e.jsx(e.Fragment,{children:r.provider&&r.provider!=="local_transformers"?e.jsxs(e.Fragment,{children:[e.jsx(ve,{variant:"destructive",className:"mt-4",children:c("embedding_setting.alerts.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(B,{children:c("embedding_setting.encrypted_fields.api_key")}),e.jsx(Y,{variant:"link",className:"px-1",children:e.jsxs("a",{href:r.provider===J.OpenAI?pt:mt,target:"_blank",rel:"noreferrer",children:["(",r.provider===J.OpenAI?pt:mt,")"]})}),e.jsx(pe,{type:"password",value:o!=null&&o.key?`${o==null?void 0:o.key}`:"",onChange:x=>i(f=>({...f,key:x.target.value}))})]})]}):void 0})]}),e.jsx(Ae,{className:"flex justify-end",children:e.jsx(Y,{variant:"secondary",onClick:p,children:c("embedding_setting.save")})})]}):void 0})]})})}),Ji=t=>{const n=d.useCallback(async({edgeId:a})=>({deleteEdgeId:a}),[]);se(t,n)},Ki=t=>{const n=ee(l=>{var c;return(c=l.currentSession)==null?void 0:c.id}),a=ie(t),r=Vn(),s=A(l=>l.updateNodes),{confirmOrCreatePassphrase:o}=ms(),i=d.useCallback(async(l,c)=>{var u;if(a&&n){let p=t!==jt.DEFAULT_EMBEDDING_MODEL?await T("FlowNode").findOne({where:{id:t}}):void 0;const m={};if((u=Object.keys(c||{}))!=null&&u.length){await o();const f=await _t.get("passphrase");if(!f)throw new Error("Passphrase is not found");await Promise.all(Object.keys(c||{}).map(async g=>{c!=null&&c[g]&&(m[g]=await Zn(c[g],f))}))}let h;const x=[];p?(await T("FlowNodePlaceholder").update(p.source_id,{encrypted:m,data:l}),h=await T("FlowNodePlaceholder").findOne({where:{id:p.source_id}}),x.push({id:p.id,type:"replace",item:a})):(x.push({id:t,type:"remove"}),h=await T("FlowNodePlaceholder").save({placeholder_type:it.DEFAULT_EMBEDDING_MODEL,encrypted:m,data:l,session_id:n}),p=await T("FlowNode").save({node_type:j.DefaultEmbeddingModel,session_id:n,source_type:"FlowNodePlaceholder",source_id:h.id,x:a.position.x,y:a.position.y}),x.push({type:"add",item:a})),a.data.entity=h,a.data.flowNode=p,s(x)}},[o,n,t,a,s]);return d.useEffect(()=>{t===jt.DEFAULT_EMBEDDING_MODEL&&r.find(l=>l.type===j.DefaultEmbeddingModel&&l.id!==jt.DEFAULT_EMBEDDING_MODEL)&&s([{id:t,type:"remove"}])},[t,r,s]),{changeLLMOptions:i}},Xi=d.memo(t=>{var l,c,u,p;const{id:n,data:a,isConnectable:r}=t,{changeLLMOptions:s}=Ki(n);Ji(n);let o="brain",i=Hd;switch(`${(c=(l=a==null?void 0:a.entity)==null?void 0:l.data)==null?void 0:c.provider}`){case J.OpenAI:o="gpt",i="text-embedding-3-small";break;case J.GoogleGenerativeAI:o="gemma",i="text-embedding-004";break}return e.jsxs("div",{children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsx("div",{children:e.jsxs(ve,{className:"flex justify-center max-w-auto",variant:"default",children:[e.jsx(Re,{name:o,className:"w-7 h-7"}),e.jsxs("div",{className:"ml-2 pr-4 flex justify-center gap-1 flex-col",children:[e.jsx("div",{className:"min-h-8 flex items-center",children:e.jsx(Oe,{children:`${i||""}`})}),e.jsx(Wi,{supportedProviders:[J.OpenAI,J.GoogleGenerativeAI],onChangeOptions:s,encrypted:(u=a.entity)==null?void 0:u.encrypted,options:(p=a.entity)==null?void 0:p.data})]})]})}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),Zi=`Use the following pieces of context to answer the question at the end.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
Use three sentences maximum and keep the answer as concise as possible.

{context}
`,Yi=xt(t=>{const{source:n,documents:a}=t,r=Te(),{toast:s}=ge(),{t:o}=H("dialogs"),{loading:i,createPrompt:l}=ps(),c=async u=>{try{if(!u.content||!u.content.includes("{context}")){s({title:o("create_vector_database_prompt.errors.fill_context"),variant:"destructive"});return}const p=u.content.replace("{context}",a.map(m=>`<document>${m.pageContent}</document>`).join(`
`));return await l(n,{...u,content:p}),r.hide(),!0}catch{s({title:o("create_vector_database_prompt.errors.create_failed"),variant:"destructive"})}};return e.jsx(Nt,{open:r.visible,onOpenChange:r.hide,children:e.jsxs(Ct,{className:"sm:max-w-[425px]",children:[e.jsx(St,{children:e.jsxs("div",{className:"flex",children:[e.jsx($,{name:"file",className:"mr-2 h-4 w-4"}),e.jsx(Et,{children:o("create_vector_database_prompt.title")})]})}),e.jsxs("div",{className:"flex gap-4 py-4 flex-col",children:[e.jsx(Gt,{onSubmit:c,loading:i,hidePromptType:!0,defaultPromptRole:"system",defaultPromptContent:Zi}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm items-center",children:[e.jsx($,{name:"info",className:"mr-2",size:14}),o("create_vector_database_prompt.fill_content_note")]})]})]})})}),Qi=()=>{const t=ee(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=A(i=>i.createOrUpdateFlowNode),s=A(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async({prompt:i,source:l,metadata:c})=>{var u,p,m,h;try{const x=(u=l==null?void 0:l.data)==null?void 0:u.entity;if(!x||!t)throw new Error("Source or Session not found");a(!0);const f=((p=l.position)==null?void 0:p.x)||0,g=(((m=l.position)==null?void 0:m.y)||0)+(((h=l.measured)==null?void 0:h.height)||0),_=await T("Prompt").save({...i,status:(i==null?void 0:i.status)||_e.Started,role:(i==null?void 0:i.role)||he.System,type:(i==null?void 0:i.type)||fe.Chat,content:(i==null?void 0:i.content)||"{context}",session_id:t});if(!_)throw new Error("Failed to save prompt");const y=await r({source_id:_.id,source_type:"Prompt",node_type:j.Prompt,x:f,y:g+20});if(!y)throw new Error("Failed to save prompt node");const M=await T("FlowNodePlaceholder").save({placeholder:`Retriever for ${x.name}`,placeholder_type:it.VECTOR_DATABASE_RETREIVER,session_id:t,metadata:c});if(!M)throw new Error("Failed to save node placeholder");const D=await r({source_id:M.id,source_type:"FlowNodePlaceholder",node_type:j.PlaceHolder,x:f,y:g+40});if(!D)throw new Error("Failed to save node placeholder node");await s({source:y.id,target:D.id}),await s({source:l.id,target:D.id})}finally{a(!1)}},[t,r,s]);return{loading:n,createVectorDatabaseRetriever:o}},eo=`Use the following pieces of context to answer the question at the end.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}
`,to=xt(t=>{const{source:n}=t,a=Te(),{toast:r}=ge(),{t:s}=H("dialogs"),[o,i]=d.useState(1),[l,c]=d.useState(void 0),{loading:u,createVectorDatabaseRetriever:p}=Qi(),m=async f=>{try{const g=f.content;if(!g||!g.includes("{context}")){r({title:s("create_vector_database_retriever.errors.fill_context"),variant:"destructive"});return}return await p({source:n,prompt:{content:g},metadata:{k:o,minimalScore:l}}),i(1),c(void 0),a.hide(),!0}catch{r({title:s("create_vector_database_retriever.errors.create_failed"),variant:"destructive"})}},h=f=>{i(f.target.value?Number(f.target.value):void 0)},x=f=>{c(f.target.value?Number(f.target.value):void 0)};return e.jsx(Nt,{open:a.visible,onOpenChange:a.hide,children:e.jsxs(Ct,{className:"sm:max-w-[425px]",children:[e.jsx(St,{children:e.jsxs("div",{className:"flex",children:[e.jsx($,{name:"file",className:"mr-2 h-4 w-4"}),e.jsx(Et,{children:s("create_vector_database_retriever.title")})]})}),e.jsxs("div",{className:"flex gap-4 py-4 flex-col",children:[e.jsx(Gt,{onSubmit:m,loading:u,hidePromptType:!0,defaultPromptRole:"system",defaultPromptContent:eo}),e.jsxs(te,{children:[e.jsx(oe,{children:e.jsx(ue,{children:s("create_vector_database_retriever.retriever_settings")})}),e.jsxs(de,{children:[e.jsx(B,{children:s("create_vector_database_retriever.retriever_k")}),e.jsx(pe,{value:o||"",type:"number",onChange:h,placeholder:s("create_vector_database_retriever.retriever_k_placeholder")}),e.jsx(B,{children:s("create_vector_database_retriever.retriever_minimum_score")}),e.jsx(pe,{value:l||"",type:"number",onChange:x,placeholder:s("create_vector_database_retriever.retriever_minimum_score_placeholder")})]})]}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm items-center",children:[e.jsx($,{name:"info",className:"mr-2",size:14}),s("create_vector_database_retriever.fill_content_note")]})]})]})})}),ao=t=>{const n=A(o=>o.createOrUpdateFlowEdge),{getFlowEmbeddingEntity:a}=ft(),{index:r}=aa(),s=d.useCallback(async({edgeId:o,target:i,source:l})=>{var c,u;try{const p=(c=i==null?void 0:i.data)==null?void 0:c.entity;if((l==null?void 0:l.type)===j.CSVData&&(i==null?void 0:i.type)===j.VectorDatabase){const m=(u=l==null?void 0:l.data)==null?void 0:u.entity;if(!m||!p)return{deleteEdgeId:o};const{rows:h}=Gn(m.headers,m.csv),x=h.map(f=>new Jn({pageContent:`${f.text}`}));await r(a(),{database:{databaseId:p.id,dataSourceId:m.id,dataSourceType:"CSVData"}},x),await n({source:l.id,target:i.id});return}return{deleteEdgeId:o}}catch{return{deleteEdgeId:o}}},[n,a,r]);se(t,s)},so=t=>{const[n,a]=d.useState(!1),{t:r}=H("flows"),{toast:s}=ge(),{getNode:o,getHandleConnections:i}=we(),l=A(x=>x.updateNodes),{getFlowEmbeddingEntity:c}=ft(),{index:u,similaritySearchWithScore:p}=aa(),m=d.useCallback(async(x,f)=>{var g,_,y;try{const M=o(t);if(!M)return;const D=(g=M.data)==null?void 0:g.entity;if(!D){s({variant:"destructive",title:r("vector_database_node.errors.vector_database_not_found")});return}const b=c();if(D.storage===Fe.DataNode){const E=(y=(_=i({nodeId:t,type:"target"}).map(v=>o(v.source)).find(v=>(v==null?void 0:v.type)&&[j.JSONLData,j.CSVData].includes(v==null?void 0:v.type)))==null?void 0:_.data)==null?void 0:y.entity;if(!E){s({variant:"destructive",title:r("vector_database_node.errors.data_node_not_found")});return}return a(!0),await p(b,{database:{databaseId:D.id,dataSourceId:E.id,dataSourceType:ia(E)}},x,f==null?void 0:f.k)}else return a(!0),await p(b,{database:{databaseId:D.id}},x,f==null?void 0:f.k)}catch{s({variant:"destructive",title:r("vector_database_node.errors.similarity_search_failed")})}finally{a(!1)}},[o,t,c,s,r,i,p]),h=d.useCallback(async(x,f)=>{var g,_,y,M;try{const D=o(t);if(!D)return;a(!0);const b=x.content?[new Jn({pageContent:x.content,id:x.id,metadata:{id:x.id}})]:x.documents;if(!(b!=null&&b.length)){s({variant:"destructive",title:r("vector_database_node.errors.content_not_found")});return}const E=(g=D.data)==null?void 0:g.entity;if(!E||!D){s({variant:"destructive",title:r("vector_database_node.errors.vector_database_not_found")});return}const v=c();if(E.storage===Fe.DataNode){const N=i({nodeId:t,type:"target"}).map(I=>o(I.source)).find(I=>(I==null?void 0:I.type)&&[j.JSONLData,j.CSVData].includes(I==null?void 0:I.type)),O=(_=N==null?void 0:N.data)==null?void 0:_.entity;if(!O){s({variant:"destructive",title:r("vector_database_node.errors.data_node_not_found")});return}const U=ia(O),V=Hn(b,10);let L=0;for(const I of V){if((y=f==null?void 0:f.onProgressReport)==null||y.call(f,{handling:I.length,handled:L,total:b.length}),await u(v,{database:{databaseId:E.id,dataSourceId:O.id,dataSourceType:U}},I),U&&N){const F=await T(U).findOne({where:{id:O.id}});l([{type:"replace",id:N.id,item:{...N,data:{...N.data,entity:F}}}])}L+=I.length}}else{const N=Hn(b,10);let O=0;for(const U of N){(M=f==null?void 0:f.onProgressReport)==null||M.call(f,{handling:U.length,handled:O,total:b.length}),await u(v,{database:{databaseId:E.id}},U);const V=await T("VectorDatabase").findOne({where:{id:`${E.id}`}});l([{type:"replace",id:D.id,item:{...D,data:{...D.data,entity:V}}}]),O+=U.length}}}catch{s({variant:"destructive",title:r("vector_database_node.errors.similarity_search_failed")})}finally{a(!1)}},[o,t,c,s,r,i,u,l]);return{loading:n,indexData:h,similaritySearchWithScore:m}},no=d.memo(t=>{var v,N,O,U;const{t:n}=H("flows"),[a,r]=d.useState(0),[s,o]=d.useState("search"),i=ie(t.id),{id:l,data:c,isConnectable:u}=t,{loading:p,similaritySearchWithScore:m,indexData:h}=so(l),x=Te(Yi),f=Te(to);ao(l);const g=d.useCallback(async(...V)=>{i&&await h(...V)},[h,i]),_=d.useCallback(async(V,L)=>{const I=V.trim(),F=await m(I,{k:L});if(F!=null&&F.length)return F},[m]),y=d.useCallback(V=>{x.show({source:i,documents:V.map(([L])=>L)})},[x,i]),M=d.useCallback(async()=>{f.show({source:i})},[f,i]),D=d.useCallback(async V=>{if(V.type.includes("text")||V.type.includes("txt")){const L=new FileReader;L.onload=async I=>{var C;const F=(C=I.target)==null?void 0:C.result;await g({content:F})},L.readAsText(V)}else if(V.type.endsWith("pdf")){const L=new Blob([V],{type:"application/pdf"}),I=await new Ko(L,{pdfjs:async()=>{const F=await xe(()=>import("./pdf.min-C2SM6UYQ.js").then(async C=>(await C.__tla,C)),__vite__mapDeps([7,2,3,1,4,5,6]));return await xe(()=>import("./pdf.worker.min-BeMNPJVi.js").then(async C=>(await C.__tla,C)),__vite__mapDeps([8,1,2,3,4,5,6])),F.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),F},parsedItemSeparator:" "}).load();await g({documents:I},{onProgressReport:F=>{r((F.handled+F.handling)/F.total)}})}},[g]),b=d.useMemo(()=>{var I,F;if(!((I=c==null?void 0:c.entity)!=null&&I.raw))return{headers:[],rows:[]};const V=["content","embedding","metadata"],L=oa((F=c==null?void 0:c.entity)==null?void 0:F.raw);return{headers:V,rows:L.map(C=>{try{return JSON.parse(C)}catch{return[]}})}},[(v=c==null?void 0:c.entity)==null?void 0:v.raw]),E=d.useMemo(()=>{switch(s){case"search":return e.jsx(We,{value:"search",children:e.jsx(Yo,{loading:p,onSimilaritySearch:_,onCreatePrompt:y,onCreateRetriever:M})});case"new":return e.jsx(We,{className:"min-w-80",value:"new",children:e.jsx(Zo,{loading:p,onCreateData:g})});case"file":return e.jsx(We,{value:"file",children:e.jsx(Xo,{loading:p,progress:a,onFileSubmit:D,fileOptions:{accept:".pdf,.txt,.text",maxSize:15}})});case"view":return e.jsx(We,{value:"view",children:e.jsx(sa,{data:b.rows,headers:b.headers,limitLengthByColumns:{embedding:32}})})}},[g,y,M,D,_,p,s,a,b]);return e.jsxs("div",{className:"min-w-72",children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:u}),e.jsxs("div",{className:"max-w-full",children:[e.jsx(ae,{id:l}),e.jsxs(ve,{className:"flex justify-center",variant:"default",children:[e.jsx($,{size:24,name:"database-zap"}),e.jsxs("div",{className:"ml-2 max-w-full",children:[e.jsx(Oe,{children:`${((N=c.entity)==null?void 0:N.name)||""}`}),e.jsxs(Pn,{value:s,onValueChange:o,defaultValue:"search",className:q("w-full mt-4"),children:[e.jsxs($n,{className:q("grid w-full grid-cols-3",((O=c.entity)==null?void 0:O.storage)===Fe.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[e.jsx(Ge,{value:"search",children:n("vector_database_node.search")}),e.jsx(Ge,{value:"new",children:n("vector_database_node.text")}),e.jsx(Ge,{value:"file",children:n("vector_database_node.file")}),((U=c.entity)==null?void 0:U.storage)===Fe.DatabaseNode?e.jsx(Ge,{value:"view",children:n("vector_database_node.view")}):void 0]}),E]})]})]})]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:u})]})}),ro={embedding:32},io=d.memo(t=>{var o,i,l;const{id:n,data:a,isConnectable:r}=t,s=d.useMemo(()=>{var p;if(!((p=a==null?void 0:a.entity)!=null&&p.jsonl))return{headers:[],rows:[]};const c=da(a.entity.headers||""),u=oa(a.entity.jsonl);return{headers:c,rows:u.map(m=>{try{return JSON.parse(m)}catch{return[]}})}},[(o=a==null?void 0:a.entity)==null?void 0:o.jsonl,a.entity.headers]);return e.jsxs("div",{className:"min-w-80",children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(ae,{id:n}),e.jsxs(te,{className:"min-w-32 min-h-16 p-4",children:[e.jsx(oe,{className:"!p-0",children:e.jsxs("div",{className:"pt-2 flex !flex-row",children:[e.jsx($,{name:"file-json",className:"mr-2"}),e.jsxs(B,{className:"!font-medium leading-none tracking-tight pr-8",children:[j.JSONLData," ",(i=s==null?void 0:s.rows)!=null&&i.length?`(${((l=s==null?void 0:s.rows)==null?void 0:l.length)||0})`:""]})]})}),e.jsx(de,{className:"pb-0",children:e.jsx(sa,{data:s.rows,headers:s.headers,limitLengthByColumns:ro})})]})]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),Os=60,Fs=140,oo=Ln("supports-backdrop-blur:bg-white/10 supports-backdrop-blur:dark:bg-black/10 mx-auto flex h-[58px] w-max gap-2 rounded-lg border p-2 backdrop-blur-md"),Rs=nt.forwardRef(({className:t,children:n,magnification:a=Os,distance:r=Fs,direction:s="bottom",...o},i)=>{const l=Lt(1/0),c=()=>nt.Children.map(n,u=>nt.isValidElement(u)&&u.type===at?nt.cloneElement(u,{...u.props,mouseX:l,magnification:a,distance:r}):u);return e.jsx(Mn.div,{ref:i,onMouseMove:u=>l.set(u.pageX),onMouseLeave:()=>l.set(1/0),...o,className:q(oo({className:t}),{"items-start":s==="top","items-center":s==="middle","items-end":s==="bottom"}),children:c()})});Rs.displayName="Dock";const at=({magnification:t=Os,distance:n=Fs,mouseX:a,className:r,children:s,...o})=>{const i=d.useRef(null),l=ga(a||new To,p=>{var h;const m=((h=i.current)==null?void 0:h.getBoundingClientRect())??{x:0,width:0};return p-m.x-m.width/2}),c=ga(l,[-n,0,n],[40,t,40]),u=cr(c,{mass:.1,stiffness:150,damping:12});return e.jsx(Mn.div,{ref:i,style:{width:u},className:q("flex aspect-square cursor-pointer items-center justify-center rounded-full",r),...o,children:s})};at.displayName="DockIcon";let Ps,$s,Vs,Hs,gt,zs,st,Bs,Us,qs,Gs,Ws,Js,Ks,Xs,Zs,Ys,Qs,en,tn,an,sn,nn,rn,on,dn,ln,cn,Zt,un;Ps=t=>d.createElement("svg",{viewBox:"0 0 256 254",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",width:256,height:254,preserveAspectRatio:"xMidYMid",...t},d.createElement("defs",null,d.createElement("linearGradient",{id:"c",x1:"50%",x2:"50%",y1:"0%",y2:"100%"},d.createElement("stop",{offset:"0%",stopColor:"#FFF"}),d.createElement("stop",{offset:"100%",stopColor:"#FFF",stopOpacity:0})),d.createElement("path",{id:"a",d:"M180.828 252.605a15.872 15.872 0 0 0 12.65-.486l52.501-25.262a15.94 15.94 0 0 0 9.025-14.364V41.197a15.939 15.939 0 0 0-9.025-14.363l-52.5-25.263a15.877 15.877 0 0 0-18.115 3.084L74.857 96.35l-43.78-33.232a10.614 10.614 0 0 0-13.56.603L3.476 76.494c-4.63 4.211-4.635 11.495-.012 15.713l37.967 34.638-37.967 34.637c-4.623 4.219-4.618 11.502.012 15.714l14.041 12.772a10.614 10.614 0 0 0 13.56.604l43.78-33.233 100.507 91.695a15.853 15.853 0 0 0 5.464 3.571Zm10.464-183.649-76.262 57.889 76.262 57.888V68.956Z"})),d.createElement("mask",{id:"b",fill:"#fff"},d.createElement("use",{xlinkHref:"#a"})),d.createElement("path",{fill:"#0065A9",d:"M246.135 26.873 193.593 1.575a15.885 15.885 0 0 0-18.123 3.08L3.466 161.482c-4.626 4.219-4.62 11.502.012 15.714l14.05 12.772a10.625 10.625 0 0 0 13.569.604L238.229 33.436c6.949-5.271 16.93-.315 16.93 8.407v-.61a15.938 15.938 0 0 0-9.024-14.36Z"}),d.createElement("path",{fill:"#007ACC",d:"m246.135 226.816-52.542 25.298a15.887 15.887 0 0 1-18.123-3.08L3.466 92.207c-4.626-4.218-4.62-11.502.012-15.713l14.05-12.773a10.625 10.625 0 0 1 13.569-.603l207.132 157.135c6.949 5.271 16.93.315 16.93-8.408v.611a15.939 15.939 0 0 1-9.024 14.36Z"}),d.createElement("path",{fill:"#1F9CF0",d:"M193.428 252.134a15.892 15.892 0 0 1-18.125-3.083c5.881 5.88 15.938 1.715 15.938-6.603V11.273c0-8.318-10.057-12.483-15.938-6.602a15.892 15.892 0 0 1 18.125-3.084l52.533 25.263a15.937 15.937 0 0 1 9.03 14.363V212.51c0 6.125-3.51 11.709-9.03 14.363l-52.533 25.262Z"}),d.createElement("path",{fill:"url(#c)",fillOpacity:.25,d:"M180.828 252.605a15.874 15.874 0 0 0 12.65-.486l52.5-25.263a15.938 15.938 0 0 0 9.026-14.363V41.197a15.939 15.939 0 0 0-9.025-14.363L193.477 1.57a15.877 15.877 0 0 0-18.114 3.084L74.857 96.35l-43.78-33.232a10.614 10.614 0 0 0-13.56.603L3.476 76.494c-4.63 4.211-4.635 11.495-.012 15.713l37.967 34.638-37.967 34.637c-4.623 4.219-4.618 11.502.012 15.714l14.041 12.772a10.614 10.614 0 0 0 13.56.604l43.78-33.233 100.506 91.695a15.857 15.857 0 0 0 5.465 3.571Zm10.464-183.65-76.262 57.89 76.262 57.888V68.956Z"})),$s="/NoLLMChat/assets/plate-editor-C1jTW62C.png",Vs={[j.Shape]:{width:100,height:100},[j.CircleShape]:{width:100,height:100},[j.TriangleShape]:{width:100,height:100},[j.EditorApp]:{width:1240,height:400}},Hs=t=>{const n=ie(t),a=ee(l=>l.currentSession),[r,s]=d.useState(!1),o=A(l=>l.createOrUpdateFlowNode),i=d.useCallback(async l=>{var c,u,p;try{if(s(!0),n&&(a==null?void 0:a.id)){const m=((c=n.position)==null?void 0:c.x)||0,h=(((u=n.position)==null?void 0:u.y)||0)+(((p=n.measured)==null?void 0:p.height)||0),x=await T("FlowNodeData").save({data:{},session_id:a.id});if(!x)throw new Error("Failed to save node data");if(!await o({node_type:l,data:{},source_id:x.id,source_type:"FlowNodeData",x:m,y:h+20,...Vs[l]||{}}))throw new Error("Failed to save node")}}finally{s(!1)}},[o,a==null?void 0:a.id,n]);return{loading:r,createNode:i}},gt={applications:[{key:j.EditorApp,image:$s,label:"application_bar.editor"},{key:j.VSLiteApp,icon:Ps,label:"application_bar.vslite"}],shapes:[{key:j.Shape,icon:"square",label:"application_bar.square"},{key:j.CircleShape,icon:"circle",label:"application_bar.circle"},{key:j.TriangleShape,icon:"triangle",label:"application_bar.triangle"}],old:[{key:j.CodeContainerApp,icon:"file-code-2",label:"application_bar.code_editor"}]},zs=d.memo(t=>{const{t:n}=H("flows"),{toast:a}=ge(),{loading:r,createNode:s}=Hs(t.id),o=async i=>{try{if(r)return;await s(i)}catch{a({description:n("application_bar.errors.add_node_failed"),variant:"destructive"})}};return e.jsx(zd,{children:e.jsxs(Rs,{direction:"middle",children:[gt.applications.map(i=>{const l=i.icon;return e.jsx(at,{children:e.jsxs(la,{children:[e.jsxs(ca,{children:[l?e.jsx(l,{width:20,height:20,onClick:()=>o(i.key)}):void 0,i.image?e.jsx("img",{src:i.image,alt:n(i.label),className:"w-8 h-8 rounded-md",onClick:()=>o(i.key)}):void 0]}),e.jsx(ua,{children:e.jsx("p",{children:n(i.label)})})]})},i.label)}),e.jsx(Kn,{orientation:"vertical",className:"h-full"}),gt.shapes.map(i=>e.jsx(at,{children:e.jsxs(la,{children:[e.jsx(ca,{children:e.jsx($,{onClick:()=>o(i.key),name:i.icon})}),e.jsx(ua,{children:e.jsx("p",{children:n(i.label)})})]})},i.label)),e.jsx(Kn,{orientation:"vertical",className:"h-full"}),gt.old.map(i=>e.jsx(at,{children:e.jsxs(la,{children:[e.jsx(ca,{children:e.jsx($,{onClick:()=>o(i.key),name:i.icon})}),e.jsx(ua,{children:e.jsx("p",{children:n(i.label)})})]})},i.label))]})})}),st=d.memo(t=>{const{lineClassName:n,handleClassName:a,...r}=t;return e.jsx(Qo,{lineClassName:q("!border-1.5",n),handleClassName:q("!w-2 !h-2 !border-2 !rounded-full",a),...r})}),Bs=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([j.CircleShape,j.TriangleShape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===j.Shape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Us=d.memo(t=>{const{id:n,selected:a,isConnectable:r}=t;return Bs(n),e.jsxs(e.Fragment,{children:[e.jsx(st,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsx("div",{className:"min-w-10 min-h-10 w-full h-full bg-border border",children:e.jsx(ae,{id:n})}),e.jsx(G,{type:"source",position:W.Bottom,isConnectable:r})]})}),qs=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([j.Shape,j.TriangleShape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===j.CircleShape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Gs=d.memo(t=>{const{id:n,selected:a,isConnectable:r}=t;return qs(n),e.jsxs(e.Fragment,{children:[e.jsx(st,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsx("div",{className:"min-w-10 min-h-10 w-full h-full bg-border rounded-full border",children:e.jsx(ae,{id:n})}),e.jsx(G,{type:"source",position:W.Bottom,isConnectable:r})]})}),Ws=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([j.CircleShape,j.Shape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===j.TriangleShape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Js=d.memo(t=>{const{id:n,selected:a,width:r,height:s,isConnectable:o}=t;return Ws(n),e.jsxs(e.Fragment,{children:[e.jsx(st,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(G,{type:"target",position:W.Top,isConnectable:o}),e.jsx("div",{className:"w-0 h-0 border-l-transparent border-r-transparent border-b-border",style:{borderLeftWidth:(r||0)/2,borderRightWidth:(r||0)/2,borderBottomWidth:s||0}}),e.jsx(ae,{id:n,className:"absolute top-0 right-0"}),e.jsx(G,{type:"source",position:W.Bottom,isConnectable:o})]})}),Ks=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===j.LLM&&(o==null?void 0:o.type)===j.EditorApp){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},Xs=t=>{const n=ie(t),{t:a}=H("flows"),r=d.useRef(null),{toast:s}=ge(),{getNode:o,getHandleConnections:i}=we(),{stream:l}=pa(),c=d.useCallback(async m=>{n&&(clearTimeout(r.current),r.current=setTimeout(async()=>{await T("FlowNode").update(n.id,{data:m})},150))},[n]),u=d.useCallback(async(m,h)=>{var x;if(n){const f=i({nodeId:t,type:"target"}).find(y=>{var M;return((M=o(y.source))==null?void 0:M.type)===j.LLM}),g=f?o(f==null?void 0:f.source):void 0,_=(x=g==null?void 0:g.data)==null?void 0:x.entity;if(!g||!_)return s({variant:"destructive",description:a("editor_node.errors.llm_not_found")});if(g.data.status!==le.Loaded)return s({variant:"destructive",description:a("editor_node.errors.llm_not_loaded_yet")});try{return(await l(_.provider,typeof m=="string"?[new Je(m)]:m,{onMessageUpdate:y=>{h==null||h(y.content)},llm:_})).content}catch(y){if(y instanceof Error&&y.message.includes("LLM_NOT_LOADED_YET"))return s({title:a("editor_node.errors.llm_not_loaded_yet")});s({variant:"destructive",title:a("editor_node.errors.stream_message_failed")})}}},[n,i,t,o,s,a,l]),p=d.useCallback(m=>{if(!o(m))return[];const h=[];return i({nodeId:m,type:"target"}).forEach(x=>{const f=o(x.source);!f||f.type!==j.LLM||h.push({node:f,connections:[x]})}),h},[i,o]);return{createMessage:u,updateEditorContent:c,getLinkedConnections:p}},Zs=d.lazy(()=>xe(()=>import("./index-C7yn_S32.js").then(async t=>(await t.__tla,t)),__vite__mapDeps([9,2,3,10,4,11,12,13,14,15,6,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,1,5,57]))),Ys=d.memo(t=>{var u;const{id:n,data:a,selected:r,isConnectable:s}=t;Ks(n);const{createMessage:o,updateEditorContent:i,getLinkedConnections:l}=Xs(n),c=d.useCallback(p=>{i(p)},[i]);return e.jsxs("div",{className:"w-full min-w-[1240px] h-full",children:[e.jsx(st,{isVisible:!!r,minWidth:1240,minHeight:400}),e.jsx(G,{type:"target",position:W.Top,isConnectable:s}),e.jsxs("div",{className:"min-w-10 min-h-10 w-full h-full rounded-lg border bg-background",children:[e.jsx(ae,{className:"!z-[100]",id:n,enableToStandalone:!0,getLinkedConnections:l}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-ful rounded-lg flex justify-center items-center",children:e.jsx($,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx("div",{className:"h-full w-ful rounded-lg","data-registry":"plate",children:e.jsx(Zs,{defaultValue:(u=a==null?void 0:a.flowNode)==null?void 0:u.data,onValueChange:c,copilotStream:o})})})]}),e.jsx(G,{type:"source",position:W.Bottom,isConnectable:s})]})}),Qs=t=>{const n=d.useCallback(async({edgeId:a})=>{try{return{deleteEdgeId:a}}catch{return{deleteEdgeId:a}}},[]);se(t,n)},en=d.memo(t=>{var i,l;const{id:n,data:a,isConnectable:r}=t,{t:s}=H("flows");Qs(n);let o="";switch((i=a.entity)==null?void 0:i.placeholder_type){case"VECTOR_DATABASE_RETREIVER":o=s("placeholder_node.vector_database_retriever");break}return e.jsxs("div",{children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:r}),e.jsxs(ve,{className:"flex justify-center max-w-80",variant:"default",children:[e.jsx(ae,{id:n}),e.jsx($,{name:"land-plot",className:"w-7 h-7"}),e.jsxs("div",{className:"ml-2 pr-4",children:[e.jsx(Oe,{children:`${((l=a.entity)==null?void 0:l.placeholder)||""}`}),e.jsx(rt,{children:o?e.jsx(Be,{children:o}):void 0})]})]}),e.jsx(G,{type:"source",position:W.Bottom,id:"a",isConnectable:r})]})}),tn=d.lazy(()=>xe(()=>import("./CodeContainerApp-CJLJkU9g.js").then(async t=>(await t.__tla,t)).then(t=>t.C),__vite__mapDeps([58,2,3,59,60,10,1,4,5,6,61,14,11,62,63]))),an=d.memo(t=>{const{id:n,isConnectable:a}=t;return e.jsxs("div",{className:"w-[1380px] h-[600px] rounded-lg border overflow-hidden shadow-sm",children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:a}),e.jsxs("div",{className:"w-full h-full rounded-lg border bg-card overflow-hidden",children:[e.jsx(ae,{id:n}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex justify-center items-center",children:e.jsx($,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx(tn,{...t})})]}),e.jsx(G,{type:"source",position:W.Bottom,isConnectable:a})]})}),sn=["empty-source","vite-vue","shadcn-react-vite","todo-app-react-vite","porfolio-nextjs"],nn=async t=>{switch(t){case"empty-source":return xe(()=>import("./empty-source-Dw1dvL8s.js"),[]).then(n=>n.BASE);case"vite-vue":return xe(()=>import("./vite-vue-Bmz2z3Fo.js"),[]).then(n=>n.BASE);case"shadcn-react-vite":return xe(()=>import("./shadcn-react-vite-CDJ9BaE9.js"),[]).then(n=>n.BASE);case"todo-app-react-vite":return xe(()=>import("./todo-app-react-vite-BBWBkRjR.js"),[]).then(n=>n.BASE);case"porfolio-nextjs":return xe(()=>import("./porfolio-nextjs-DCkli5iW.js"),[]).then(n=>n.BASE);default:throw new Error(`Unknown source base: ${t}`)}},ha=d.memo(({className:t,onUpdateSourceBase:n})=>{const{t:a}=H("components"),[r,s]=d.useState();return e.jsxs(te,{className:q("mw-full",t),children:[e.jsx(oe,{className:"p-4",children:e.jsx(ue,{children:a("add_source_base.title")})}),e.jsx(de,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-center w-full h-full flex-col",children:[e.jsxs(Ee,{onValueChange:o=>s(o),children:[e.jsx(ke,{className:"w-full mb-4",children:e.jsx(Me,{placeholder:a("add_source_base.source_base_select_placeholder")})}),e.jsx(Le,{children:sn.map(o=>e.jsx(me,{value:`${o}`,children:a(`add_source_base.sourcebases.${o.toLowerCase()}`)},`${o}`))})]}),e.jsx(Y,{className:"w-full",onClick:async()=>r&&n(await nn(r)),children:a("add_source_base.update_source")})]})})]})}),rn=()=>{const{getNode:t,getHandleConnections:n}=we(),{stream:a}=pa(),r=d.useCallback(async(o,i)=>{await T("FlowNode").update(o,{raw:dl(i)})},[]),s=d.useCallback(o=>{if(!t(o))return[];const i=[];return n({nodeId:o,type:"target"}).forEach(l=>{const c=t(l.source);!c||c.type!==j.LLM||i.push({node:c,connections:[l]})}),i},[n,t]);return{sendMessage:d.useCallback(async(o,i,{onMessageUpdate:l,onResponseMessageCreate:c}={})=>{const u=i.map(m=>m.role==="system"?new Wn(m.content):m.role==="user"?new Je(m.content):new kt(m.content));c==null||c();const{content:p}=await a(J.WebLLM,[...u,new Je(o)],{onMessageUpdate:({content:m})=>{l==null||l({nodeData:{loading:!0,content:m}})},llm:void 0});return l==null||l({nodeData:{loading:!1,content:p}}),p},[a]),getLinkedConnections:s,updateCodeContainerData:r}},on=t=>{const n=A(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===j.LLM&&(o==null?void 0:o.type)===j.VSLiteApp){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);se(t,a)},dn=d.lazy(()=>xe(()=>import("./index-HBk6v5Fv.js").then(async t=>(await t.__tla,t)),__vite__mapDeps([64,2,3,4,11,22,36,6,65,66,61,14,62,67]))),ln=d.memo(t=>{var h,x,f,g;const{id:n,isConnectable:a,data:r}=t,[s,o]=d.useState((h=r==null?void 0:r.flowNode)!=null&&h.raw?ll(r.flowNode.raw):void 0),{updateCodeContainerData:i,getLinkedConnections:l,sendMessage:c}=rn();on(n);const u=d.useCallback(async _=>{var y,M;(y=r==null?void 0:r.flowNode)!=null&&y.id&&(await i((M=r==null?void 0:r.flowNode)==null?void 0:M.id,_),o(_))},[(x=r==null?void 0:r.flowNode)==null?void 0:x.id,i]),p=d.useCallback(async(_,y)=>{var M;return(M=r==null?void 0:r.flowNode)!=null&&M.id?await c(_,y):void 0},[(f=r==null?void 0:r.flowNode)==null?void 0:f.id,c]),m=d.useCallback(async _=>{o(y=>{var D;const M=cl(y||{},_);return i((D=r==null?void 0:r.flowNode)==null?void 0:D.id,M),M})},[(g=r==null?void 0:r.flowNode)==null?void 0:g.id,i]);return s?e.jsxs("div",{className:"w-[1380px] h-[600px] rounded-lg border overflow-hidden shadow-sm",children:[e.jsx(G,{type:"target",position:W.Top,isConnectable:a}),e.jsxs("div",{className:"w-full h-full rounded-lg border bg-card overflow-hidden",children:[e.jsx(ae,{id:n,className:"z-50",enableToStandalone:!0,getLinkedConnections:l}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex justify-center items-center",children:e.jsx($,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx(dn,{fileSystemTree:s,onUpdateFileContent:m,sendMessage:p})})]}),e.jsx(G,{type:"source",position:W.Bottom,isConnectable:a})]}):e.jsx("div",{className:"h-full flex justify-center items-center",children:e.jsx(ha,{className:"w-64",onUpdateSourceBase:u})})}),cn={[j.LLM]:Es,[j.Toolbox]:vs,[j.Thread]:Is,[j.Message]:Pi,[j.Prompt]:Vi,[j.SessionInfo]:Hi,[j.Schema]:Bi,[j.CSVData]:Ui,[j.ToolDefinition]:Gi,[j.DefaultEmbeddingModel]:Xi,[j.VectorDatabase]:no,[j.JSONLData]:io,[j.ApplicationBar]:zs,[j.Shape]:Us,[j.CircleShape]:Gs,[j.TriangleShape]:Js,[j.EditorApp]:Ys,[j.PlaceHolder]:en,[j.CodeContainerApp]:an,[j.VSLiteApp]:ln},Zt=Ln("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3 min-w-10",sm:"h-9 px-2.5 min-w-9",lg:"h-11 px-5 min-w-11"}},defaultVariants:{variant:"default",size:"default"}}),un=d.forwardRef(({className:t,variant:n,size:a,...r},s)=>e.jsx(ar,{ref:s,className:q(Zt({variant:n,size:a,className:t})),...r})),un.displayName=ar.displayName;const mn=d.createContext({size:"default",variant:"default"}),pn=d.forwardRef(({className:t,variant:n,size:a,children:r,...s},o)=>e.jsx(sr,{ref:o,className:q("flex items-center justify-center gap-1",t),...s,children:e.jsx(mn.Provider,{value:{variant:n,size:a},children:r})}));pn.displayName=sr.displayName;const hn=d.forwardRef(({className:t,children:n,variant:a,size:r,...s},o)=>{const i=d.useContext(mn);return e.jsx(nr,{ref:o,className:q(Zt({variant:i.variant||a,size:i.size||r}),t),...s,children:n})});hn.displayName=nr.displayName;function lo(){const t=ed(n=>`x: ${n.transform[0].toFixed(2)}, y: ${n.transform[1].toFixed(2)}, zoom: ${n.transform[2].toFixed(2)}`);return e.jsx("div",{children:t})}function co({change:t}){var r,s,o,i;const n="id"in t?t.id:"-",{type:a}=t;return e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{children:["node id: ",n]}),e.jsxs("div",{children:[a==="add"?JSON.stringify(t.item,null,2):null,a==="dimensions"?`dimensions: ${(r=t.dimensions)==null?void 0:r.width} \xD7 ${(s=t.dimensions)==null?void 0:s.height}`:null,a==="position"?`position: ${(o=t.position)==null?void 0:o.x.toFixed(1)}, ${(i=t.position)==null?void 0:i.y.toFixed(1)}`:null,a==="remove"?"remove":null,a==="select"?t.selected?"select":"unselect":null]})]})}function uo({limit:t=20}){const[n,a]=d.useState([]),r=td(),s=d.useCallback(i=>{a(l=>[...i,...l].slice(0,t))},[t]);d.useEffect(()=>(r.setState({onNodesChange:s}),()=>r.setState({onNodesChange:void 0})),[s,r]);const o=()=>e.jsx("div",{children:"No Changes Triggered"});return e.jsx(e.Fragment,{children:n.length===0?e.jsx(o,{}):n.map((i,l)=>e.jsx(co,{change:i},l))})}function mo(){const{getInternalNode:t}=we(),n=Vn();return e.jsx(ad,{children:e.jsx("div",{className:"text-secondary-foreground",children:n.map(a=>{var o,i;const r=t(a.id);if(!r)return null;const s=r==null?void 0:r.internals.positionAbsolute;return e.jsx(po,{id:a.id,selected:!!a.selected,type:a.type||"default",position:a.position,absPosition:s,width:((o=a.measured)==null?void 0:o.width)??0,height:((i=a.measured)==null?void 0:i.height)??0,data:a.data},a.id)})})})}function po({id:t,type:n,selected:a,position:r,absPosition:s,width:o,height:i,data:l}){if(!o||!i)return null;const c=`translate(${s.x}px, ${s.y+i}px)`,u=`${r.x.toFixed(1)}, ${r.y.toFixed(1)}`,p=`${o} \xD7 ${i}`,m=a?"Selected":"Not Selected";return e.jsxs("div",{style:{position:"absolute",transform:c,width:o*2},className:"text-xs",children:[e.jsxs("div",{children:["id: ",t]}),e.jsxs("div",{children:["type: ",n]}),e.jsxs("div",{children:["selected: ",m]}),e.jsxs("div",{children:["position: ",u]}),e.jsxs("div",{children:["dimensions: ",p]}),e.jsxs("div",{children:["data: ",JSON.stringify(l,null,2)]})]})}function ho({tools:t}){return e.jsx(na,{position:"top-left",className:"bg-card p-1 border rounded shadow-sm",children:e.jsx(pn,{type:"multiple",children:t.map(({active:n,setActive:a,label:r,value:s})=>e.jsx(hn,{value:s,onClick:()=>a(o=>!o),"aria-pressed":n,className:"bg-card text-card-foreground transition-colors duration-300 hover:bg-secondary hover:text-secondary-foreground",children:r},s))})})}function fn(){const[t,n]=d.useState(!1),[a,r]=d.useState(!1),[s,o]=d.useState(!1),i=[{active:t,setActive:n,label:"Node Inspector",value:"node-inspector"},{active:a,setActive:r,label:"Change Logger",value:"change-logger"},{active:s,setActive:o,label:"Viewport Logger",value:"viewport-logger"}];return e.jsxs(e.Fragment,{children:[e.jsx(ho,{tools:i}),a&&e.jsx(na,{className:"text-xs p-5 bg-white rounded shadow-md overflow-y-auto max-h-[50%] mt-20",position:"bottom-right",children:e.jsx(uo,{})}),t&&e.jsx(mo,{}),s&&e.jsx(na,{position:"bottom-left",className:"text-secondary-foreground",children:e.jsx(lo,{})})]})}fn.displayName="DevTools";let gn,xn,_n,yn,vn;gn=()=>{const t=d.useRef({}),n=d.useRef({}),a=d.useRef([]),r=A(L=>L.flowEdges),s=ee(L=>L.currentSession),o=A(L=>L.setNodes),i=A(L=>L.updateNodes),l=A(L=>L.updateEdges),c=A(L=>L.addConnectionToEdges),u=A(L=>L.reset),p=A(L=>L.findFlowEdges),m=A(L=>L.deleteFlowNode),h=A(L=>L.deleteFlowEdge),x=A(L=>L.updateFlowNode),f=A(L=>L.getNodes),g=A(L=>L.findFlowNodesWithSource),_=d.useRef(r),y=d.useRef(),[M,D]=d.useState({loading:!1});_.current=r;const b=d.useCallback(async(L,I)=>{try{y.current=L,u(),await(I==null?void 0:I())}catch{y.current=void 0}},[u]),E=d.useCallback(async L=>{try{if(!(s!=null&&s.id))return;D(C=>({...C,loading:!0}));const I=await g({...L,where:{...L.where,session_id:s.id}}),F=await p({where:[{source:ma(I.map(C=>C.id))},{target:ma(I.map(C=>C.id))}]});return{flowNodes:I,flowEdges:F}}finally{D(I=>({...I,loading:!1}))}},[g,p,s==null?void 0:s.id]),v=d.useCallback(async L=>{var I,F;for(const C of a.current){const R=await C(L);if(typeof R=="boolean"&&!R)return}for(const C of L)if("id"in C&&Object.values(jt).includes(C.id)&&C.type!=="remove")i([C]);else if(C.type==="position"&&C.position&&!isNaN(C.position.x)&&!isNaN(C.position.y)){i([C]);const R=C.position.x,Z=C.position.y;clearTimeout(t.current[C.id]),t.current[C.id]=setTimeout(async()=>{t.current[C.id]=void 0,await x({id:C.id,x:R,y:Z},{silent:!0})},200)}else if(C.type==="remove"){const R=(I=f([C.id]))==null?void 0:I[0];if(!(R!=null&&R.type)||sd.includes(R.type))return;await m({id:C.id})}else if(C.type==="dimensions"&&C.dimensions&&!isNaN(C.dimensions.width)&&!isNaN(C.dimensions.height)){const R=(F=f([C.id]))==null?void 0:F[0];if(!(R!=null&&R.width)&&!(R!=null&&R.height))return;i([C]),clearTimeout(n.current[C.id]);const Z=C.dimensions.width,K=C.dimensions.height;n.current[C.id]=setTimeout(async()=>{await x({id:C.id,width:Z,height:K},{silent:!0})},200)}else C.type==="select"&&i([C])},[i,x,f,m]),N=d.useCallback(L=>{Promise.all(L.map(async I=>{if(I.type==="remove")return h({id:I.id})})),l(L)},[h,l]),O=d.useCallback(L=>{c(L)},[c]),U=d.useCallback(L=>{o(I=>{var Z,K;let F;if(typeof L=="function"?F=L(I):F=L,!F)return I;const C=I==null?void 0:I.find(Q=>Q.id===F.id),R={id:F.id,item:C?nd(C,F):{...F,position:{x:((Z=F.position)==null?void 0:Z.x)||0,y:((K=F.position)==null?void 0:K.y)||0}},type:C?"replace":"add"};return rd([R],I)})},[o]),V=d.useCallback(L=>(a.current.push(L),()=>{a.current=a.current.filter(I=>I!==L)}),[]);return{initFlow:b,loadingState:M,prepareFlowInfo:E,updateNodeChanges:v,updateEdgeChanges:N,updateOrCreateNode:U,currentSessionIdRef:y,updateEdgeConnection:O,addOnNodeChangeHandler:V}},xn=t=>{const n=ee(m=>{var h;return(h=m.currentSession)==null?void 0:h.id}),{loadingState:a,prepareFlowInfo:r,initFlow:s,currentSessionIdRef:o}=t,i=A(m=>m.ready),l=A(m=>m.nodes),c=d.useRef(l),u=A(m=>m.removeSyncNodeQueue),p=A(m=>m.removeSyncEdgeQueue);c.current=l,d.useEffect(()=>{a.loading||!i||!n||o.current===n||s(n,async()=>{await r({where:{session_id:n}})})},[s,r,a.loading,o,i,n]),d.useEffect(()=>{const m=A.subscribe(x=>x.syncNodeQueue,async(x,f)=>{const g=f.map(y=>y.timestamp),_=x.filter(y=>!g.includes(y.timestamp));_.length&&u(_.map(y=>y.timestamp))}),h=A.subscribe(x=>x.syncEdgeQueue,async(x,f)=>{const g=f.map(y=>y.timestamp),_=x.filter(y=>!g.includes(y.timestamp));_.length&&p(_.map(y=>y.timestamp))});return()=>{m(),h()}},[r,p,u])},_n=()=>{const[t,n]=d.useState(!0),a=gn(),r=ot(p=>p.selectedModel),s=d.useRef(r),o=ot(p=>p.setInitProgressCallback),{updateOrCreateNode:i,updateNodeChanges:l,updateEdgeChanges:c,updateEdgeConnection:u}=a;return xn(a),s.current=r,d.useEffect(()=>{const p=o==null?void 0:o(m=>{if(!s.current)return;const h=`${s.current}`;i(x=>{const f=x==null?void 0:x.find(g=>{var _;return(_=g.data)!=null&&_.entity&&typeof g.data.entity=="object"&&"name"in g.data.entity?g.data.entity.name===h:!1});if(f)return f.data.label=m.text,f.data.status=le.Loading,m.progress===100&&(f.data.label="",f.data.status=le.Loaded),f})});return()=>{p==null||p()}},[o,i]),d.useMemo(()=>({updateNodeChanges:l,updateEdgeChanges:c,initializing:t,setInitializing:n,updateEdgeConnection:u}),[l,c,t,n,u])},yn=()=>{const t=En(u=>u.theme),n=A(u=>u.nodes),a=A(u=>u.edges),{updateNodeChanges:r,updateEdgeChanges:s,updateEdgeConnection:o}=_n(),i=d.useCallback(u=>{r(u)},[r]),l=d.useCallback(u=>{s(u)},[s]),c=d.useCallback(u=>{o(u)},[o]);return e.jsxs(id,{nodes:n,edges:a,nodeTypes:cn,onNodesChange:i,onEdgesChange:l,onConnect:c,panOnScroll:!0,panOnScrollMode:od.Free,colorMode:t,fitView:!0,children:[e.jsx(dd,{variant:ld.Dots,gap:24,size:1}),e.jsx(cd,{}),e.jsx(ud,{}),Ao?e.jsx(fn,{}):void 0]})},vn=d.memo(yn),rr=Object.freeze(Object.defineProperty({__proto__:null,default:vn},Symbol.toStringTag,{value:"Module"}))});export{ha as C,rr as H,ul as __tla,se as a,A as u};
