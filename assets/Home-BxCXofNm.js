const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CFeuNoUh.js","assets/LLMIcon-CZS-ODRN.js","assets/index-D8zyPWIn.js","assets/index-CKMZ0OYe.css","assets/routes-DU39yQk1.js","assets/dot-HIRY-eDy.js","assets/createLucideIcon-BBHVmnqG.js","assets/file-tree-91g8yP8x.js","assets/pdf.min-DG-tGUe3.js","assets/pdf.worker.min-DXTiFl-L.js","assets/index-CwgDbPdT.js","assets/toNumber-Cd5am1kN.js","assets/index-Cwp7WKVy.js","assets/index-ZOfE6A8M.js","assets/index-D0U0KJ7E.js","assets/index-B7BQPxIA.js","assets/link-Czuq6KNN.js","assets/trash-2-i52ZbY4l.js","assets/index-C0fBlnBF.js","assets/index-DyZ8EEJz.js","assets/text-DTx0S_hY.js","assets/external-link-aTHmx6cY.js","assets/unlink-DESiUJrX.js","assets/list-CmVV4MEU.js","assets/list-ordered-_af4uz1u.js","assets/list-todo-BkdS-x5v.js","assets/indent-increase-DTGJFJnv.js","assets/pilcrow-hDg6CpgH.js","assets/heading-1-C8TDuk0o.js","assets/heading-2-CdEQE3Gl.js","assets/heading-3-Cy7iPl-M.js","assets/table-SmrEf_rO.js","assets/file-code-l5Li8F1-.js","assets/quote-Qf8P1Jxy.js","assets/minus-DNWuFSO1.js","assets/square-BQJ4YPPQ.js","assets/chevron-right-DpbVThdi.js","assets/image-DyaxASuV.js","assets/table-of-contents-B8dve6EJ.js","assets/columns-3-DgwI4YYZ.js","assets/link-2-BYI5or3U.js","assets/calendar-C6QMrq8I.js","assets/plus-DQop8I2b.js","assets/wrap-text-4-hXKgTZ.js","assets/pen-CUsiUAPZ.js","assets/eye-CBp2mt35.js","assets/indent-decrease-DIWUqvlR.js","assets/pointer-DF88LLbz.js","assets/wand-sparkles-DZFIsZdW.js","assets/bold-FvDFhK7x.js","assets/italic-XFfwy3py.js","assets/underline-0r7f3L7v.js","assets/strikethrough-CtiiDt8C.js","assets/code-xml-BkyEY-bU.js","assets/baseline-DWF3Vapf.js","assets/paint-bucket-CjnSOP9h.js","assets/arrow-up-to-line-6rr-mVZn.js","assets/index-BCYu3EnN.css","assets/index-YeeCzbmu.js","assets/check-DQs_V5tF.js","assets/circle-BLc_8hy5.js","assets/popover-CNDhZaXq.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{i as Ds,r as d,M as Is,E as ho,l as As,F as fo,G as Os,H as go,I as Qa,J as Fs,K as xo,N as _o,O as yo,b as vo,e as wo,j as e,P as Ee,d as jo,f as Me,c as J,L as H,Q as bo,S as No,T as Co,o as fa,p as Te,u as G,a as ye,U as ga,_ as ve,V as qe,W as So,R as sa,x as Ts,X as Eo,v as Rs,Y as ko,n as Ps,t as $s,Z as Mo,$ as Lo,__tla as Do}from"./index-D8zyPWIn.js";import{j as Io,k as Ao,l as oe,R as Vs,L as xa,A as je,C as se,m as de,n as he,o as le,S as Le,p as De,q as Ie,s as Ae,t as fe,v as Re,w as Oo,x as Fo,y as To,z as Ro,E as Hs,G as zs,H as _a,J as et,K as Bs,N as at,O as Ne,Q as Po,U as K,X as ya,Y as $o,Z as Pe,_ as na,h as Vo,$ as Us,u as tt,F as ra,P as Ho,a0 as Ws,a1 as qs,i as Ue,M as zo,a2 as Bo,a3 as Uo,d as Gs,e as Js,g as Ge,T as Je,D as st,a4 as Ks,a5 as va,a as Xs,W as Wo,I as qo,b as Go,V as Jo,a6 as Ko,a7 as nt,a8 as Xo,a9 as Zo,aa as Yo,ab as Qo,ac as ed,ad,ae as td,af as sd,ag as nd,ah as rd,ai as id,aj as od,__tla as dd}from"./chunk-kPJu7z3i.js";import{aa as ld,e as Zs,f as cd,R as ud,I as md,ab as pd,ac as hd,ad as fd,ae as gd,af as xd,ag as _d,ah as yd,ai as vd,aj as wd,ak as jd,al as bd,am as Nd,an as Cd,a7 as Oe,ao as Sd,ap as Ed,u as ae,g as I,F as b,aq as kd,ar as Md,as as Ld,at as Dd,r as wa,s as ja,t as ba,v as Na,au as Ys,av as Qs,B as Q,aw as Ca,ax as ia,ay as q,az as re,L as Fe,aA as rt,aB as Id,aC as Ad,V as $e,aD as en,aE as Od,aF as Fd,aG as Td,aH as Rd,aI as Pd,aJ as $d,A as Sa,H as Ke,aK as an,S as tn,aL as it,q as ot,aM as dt,aN as Vd,D as sn,T as Hd,a as nn,b as rn,c as on,aO as zd,__tla as Bd}from"./routes-DU39yQk1.js";import{e as z,L as ce,f as Ea,h as Ud,i as dn,j as Xe,k as Wd,l as qd,m as ln,b as Gd,n as cn,c as Ve,o as Jd,a as Kd,I as lt,u as ct,q as Xd,d as Zd,r as Yd,__tla as Qd}from"./LLMIcon-CZS-ODRN.js";import{P as ut,a as mt,T as oa,A as el,b as al,__tla as tl}from"./popover-CNDhZaXq.js";import{a as un,__tla as sl}from"./index-B7BQPxIA.js";import{s as nl}from"./toNumber-Cd5am1kN.js";import{R as mn,I as rl,a as pn,b as hn,c as fn,__tla as il}from"./index-DyZ8EEJz.js";import{p as ol,a as dl,u as ll,__tla as cl}from"./file-tree-91g8yP8x.js";import"./dot-HIRY-eDy.js";import"./createLucideIcon-BBHVmnqG.js";let gn,ul=Promise.all([(()=>{try{return Do}catch{}})(),(()=>{try{return dd}catch{}})(),(()=>{try{return Bd}catch{}})(),(()=>{try{return Qd}catch{}})(),(()=>{try{return tl}catch{}})(),(()=>{try{return sl}catch{}})(),(()=>{try{return il}catch{}})(),(()=>{try{return cl}catch{}})()]).then(async()=>{function ka(t){const n=Ds(()=>ho(t)),{isStatic:a}=d.useContext(Is);if(a){const[,r]=d.useState(t);d.useEffect(()=>n.on("change",r),[])}return n}function pt(t,n){const a=ka(n()),r=()=>a.set(n());return r(),As(()=>{const s=()=>Os.preRender(r,!1,!0),o=t.map(i=>i.on("change",s));return()=>{o.forEach(i=>i()),fo(r)}}),a}const xn=t=>t&&typeof t=="object"&&t.mix,_n=t=>xn(t)?t.mix:void 0;function yn(...t){const n=!Array.isArray(t[0]),a=n?0:-1,r=t[0+a],s=t[1+a],o=t[2+a],i=t[3+a],l=go(s,o,{mixer:_n(o[0]),...i});return n?l(r):l}function vn(t){Qa.current=[],t();const n=pt(Qa.current,t);return Qa.current=void 0,n}function ht(t,n,a,r){if(typeof t=="function")return vn(t);const s=typeof n=="function"?n:yn(n,a,r);return Array.isArray(t)?ft(t,s):ft([t],([o])=>s(o))}function ft(t,n){const a=Ds(()=>[]);return pt(t,()=>{a.length=0;const r=t.length;for(let s=0;s<r;s++)a[s]=t[s].get();return n(a)})}function gt(t){return typeof t=="number"?t:parseFloat(t)}function wn(t,n={}){const{isStatic:a}=d.useContext(Is),r=d.useRef(null),s=ka(Fs(t)?gt(t.get()):t),o=d.useRef(s.get()),i=d.useRef(()=>{}),l=()=>{const u=r.current;u&&u.time===0&&u.sample(xo.delta),c(),r.current=_o({keyframes:[s.get(),o.current],velocity:s.getVelocity(),type:"spring",restDelta:.001,restSpeed:.01,...n,onUpdate:i.current})},c=()=>{r.current&&r.current.stop()};return d.useInsertionEffect(()=>s.attach((u,m)=>a?m(u):(o.current=u,i.current=m,Os.update(l),s.get()),c),[JSON.stringify(n)]),As(()=>{if(Fs(t))return t.on("change",u=>s.set(gt(u)))},[s]),s}var be=(t=>(t.Started="started",t.Inprogress="inprogress",t.Success="success",t.Failed="failed",t))(be||{}),ge=(t=>(t.Human="human",t.User="user",t.AI="ai",t.System="system",t.Assistant="assistant",t.Tool="tool",t.FewShotExample="few_shot_example",t))(ge||{}),da=(t=>(t.Started="started",t.Inprogress="inprogress",t.Done="done",t))(da||{}),xe=(t=>(t.Chat="chat",t.FewShotExample="few_shot_example",t))(xe||{}),la="Menubar",[Ma,jn,bn]=yo(la),[xt,ml]=vo(la,[bn,Zs]),ie=ld(),_t=Zs(),[Nn,La]=xt(la),yt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,value:r,onValueChange:s,defaultValue:o,loop:i=!0,dir:l,...c}=t,u=cd(l),m=_t(a),[p="",h]=wo({prop:r,onChange:s,defaultProp:o}),[x,f]=d.useState(null);return e.jsx(Nn,{scope:a,value:p,onMenuOpen:d.useCallback(g=>{h(g),f(g)},[h]),onMenuClose:d.useCallback(()=>h(""),[h]),onMenuToggle:d.useCallback(g=>{h(_=>_?"":g),f(g)},[h]),dir:u,loop:i,children:e.jsx(Ma.Provider,{scope:a,children:e.jsx(Ma.Slot,{scope:a,children:e.jsx(ud,{asChild:!0,...m,orientation:"horizontal",loop:i,dir:u,currentTabStopId:x,onCurrentTabStopIdChange:f,children:e.jsx(Ee.div,{role:"menubar",...c,ref:n})})})})})});yt.displayName=la;var Da="MenubarMenu",[Cn,vt]=xt(Da),wt=t=>{const{__scopeMenubar:n,value:a,...r}=t,s=Oe(),o=a||s||"LEGACY_REACT_AUTO_VALUE",i=La(Da,n),l=ie(n),c=d.useRef(null),u=d.useRef(!1),m=i.value===o;return d.useEffect(()=>{m||(u.current=!1)},[m]),e.jsx(Cn,{scope:n,value:o,triggerId:Oe(),triggerRef:c,contentId:Oe(),wasKeyboardTriggerOpenRef:u,children:e.jsx(Sd,{...l,open:m,onOpenChange:p=>{p||i.onMenuClose()},modal:!1,dir:i.dir,...r})})};wt.displayName=Da;var Ia="MenubarTrigger",jt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,disabled:r=!1,...s}=t,o=_t(a),i=ie(a),l=La(Ia,a),c=vt(Ia,a),u=d.useRef(null),m=jo(n,u,c.triggerRef),[p,h]=d.useState(!1),x=l.value===c.value;return e.jsx(Ma.ItemSlot,{scope:a,value:c.value,disabled:r,children:e.jsx(md,{asChild:!0,...o,focusable:!r,tabStopId:c.value,children:e.jsx(pd,{asChild:!0,...i,children:e.jsx(Ee.button,{type:"button",role:"menuitem",id:c.triggerId,"aria-haspopup":"menu","aria-expanded":x,"aria-controls":x?c.contentId:void 0,"data-highlighted":p?"":void 0,"data-state":x?"open":"closed","data-disabled":r?"":void 0,disabled:r,...s,ref:m,onPointerDown:Me(t.onPointerDown,f=>{!r&&f.button===0&&f.ctrlKey===!1&&(l.onMenuOpen(c.value),x||f.preventDefault())}),onPointerEnter:Me(t.onPointerEnter,()=>{var f;l.value&&!x&&(l.onMenuOpen(c.value),(f=u.current)==null||f.focus())}),onKeyDown:Me(t.onKeyDown,f=>{r||(["Enter"," "].includes(f.key)&&l.onMenuToggle(c.value),f.key==="ArrowDown"&&l.onMenuOpen(c.value),["Enter"," ","ArrowDown"].includes(f.key)&&(c.wasKeyboardTriggerOpenRef.current=!0,f.preventDefault()))}),onFocus:Me(t.onFocus,()=>h(!0)),onBlur:Me(t.onBlur,()=>h(!1))})})})})});jt.displayName=Ia;var Sn="MenubarPortal",bt=t=>{const{__scopeMenubar:n,...a}=t,r=ie(n);return e.jsx(Ed,{...r,...a})};bt.displayName=Sn;var Aa="MenubarContent",Nt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,align:r="start",...s}=t,o=ie(a),i=La(Aa,a),l=vt(Aa,a),c=jn(a),u=d.useRef(!1);return e.jsx(hd,{id:l.contentId,"aria-labelledby":l.triggerId,"data-radix-menubar-content":"",...o,...s,ref:n,align:r,onCloseAutoFocus:Me(t.onCloseAutoFocus,m=>{var p;!i.value&&!u.current&&((p=l.triggerRef.current)==null||p.focus()),u.current=!1,m.preventDefault()}),onFocusOutside:Me(t.onFocusOutside,m=>{const p=m.target;c().some(h=>{var x;return(x=h.ref.current)==null?void 0:x.contains(p)})&&m.preventDefault()}),onInteractOutside:Me(t.onInteractOutside,()=>{u.current=!0}),onEntryFocus:m=>{l.wasKeyboardTriggerOpenRef.current||m.preventDefault()},onKeyDown:Me(t.onKeyDown,m=>{if(["ArrowRight","ArrowLeft"].includes(m.key)){const p=m.target,h=p.hasAttribute("data-radix-menubar-subtrigger"),x=p.closest("[data-radix-menubar-content]")!==m.currentTarget,f=(i.dir==="rtl"?"ArrowRight":"ArrowLeft")===m.key;if(!f&&h||x&&f)return;let g=c().filter(k=>!k.disabled).map(k=>k.value);f&&g.reverse();const _=g.indexOf(l.value);g=i.loop?Hn(g,_+1):g.slice(_+1);const[y]=g;y&&i.onMenuOpen(y)}},{checkForDefaultPrevented:!1}),style:{...t.style,"--radix-menubar-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-menubar-content-available-width":"var(--radix-popper-available-width)","--radix-menubar-content-available-height":"var(--radix-popper-available-height)","--radix-menubar-trigger-width":"var(--radix-popper-anchor-width)","--radix-menubar-trigger-height":"var(--radix-popper-anchor-height)"}})});Nt.displayName=Aa;var En="MenubarGroup",kn=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(fd,{...s,...r,ref:n})});kn.displayName=En;var Mn="MenubarLabel",Ct=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(gd,{...s,...r,ref:n})});Ct.displayName=Mn;var Ln="MenubarItem",St=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(xd,{...s,...r,ref:n})});St.displayName=Ln;var Dn="MenubarCheckboxItem",Et=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(_d,{...s,...r,ref:n})});Et.displayName=Dn;var In="MenubarRadioGroup",An=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(yd,{...s,...r,ref:n})});An.displayName=In;var On="MenubarRadioItem",kt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(vd,{...s,...r,ref:n})});kt.displayName=On;var Fn="MenubarItemIndicator",Mt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(wd,{...s,...r,ref:n})});Mt.displayName=Fn;var Tn="MenubarSeparator",Lt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(jd,{...s,...r,ref:n})});Lt.displayName=Tn;var Rn="MenubarArrow",Pn=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(bd,{...s,...r,ref:n})});Pn.displayName=Rn;var $n="MenubarSubTrigger",Dt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(Nd,{"data-radix-menubar-subtrigger":"",...s,...r,ref:n})});Dt.displayName=$n;var Vn="MenubarSubContent",It=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(Cd,{...s,"data-radix-menubar-content":"",...r,ref:n,style:{...t.style,"--radix-menubar-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-menubar-content-available-width":"var(--radix-popper-available-width)","--radix-menubar-content-available-height":"var(--radix-popper-available-height)","--radix-menubar-trigger-width":"var(--radix-popper-anchor-width)","--radix-menubar-trigger-height":"var(--radix-popper-anchor-height)"}})});It.displayName=Vn;function Hn(t,n){return t.map((a,r)=>t[(n+r)%t.length])}var At=yt,zn=wt,Ot=jt,Bn=bt,Ft=Nt,Tt=Ct,Rt=St,Pt=Et,$t=kt,Vt=Mt,Ht=Lt,zt=Dt,Bt=It;const Oa=zn,Ut=d.forwardRef(({className:t,...n},a)=>e.jsx(At,{ref:a,className:J("flex h-10 items-center space-x-1 rounded-md border bg-background p-1",t),...n}));Ut.displayName=At.displayName;const Fa=d.forwardRef(({className:t,...n},a)=>e.jsx(Ot,{ref:a,className:J("flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",t),...n}));Fa.displayName=Ot.displayName;const Un=d.forwardRef(({className:t,inset:n,children:a,...r},s)=>e.jsxs(zt,{ref:s,className:J("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",n&&"pl-8",t),...r,children:[a,e.jsx(H,{name:"chevron-right",className:"ml-auto h-4 w-4"})]}));Un.displayName=zt.displayName;const Wn=d.forwardRef(({className:t,...n},a)=>e.jsx(Bt,{ref:a,className:J("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...n}));Wn.displayName=Bt.displayName;const Wt=d.forwardRef(({className:t,align:n="start",alignOffset:a=-4,sideOffset:r=8,...s},o)=>e.jsx(Bn,{children:e.jsx(Ft,{ref:o,align:n,alignOffset:a,sideOffset:r,className:J("z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s})}));Wt.displayName=Ft.displayName;const qt=d.forwardRef(({className:t,inset:n,...a},r)=>e.jsx(Rt,{ref:r,className:J("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n&&"pl-8",t),...a}));qt.displayName=Rt.displayName;const qn=d.forwardRef(({className:t,children:n,checked:a,...r},s)=>e.jsxs(Pt,{ref:s,className:J("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),checked:a,...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Vt,{children:e.jsx(H,{name:"check",className:"h-4 w-4"})})}),n]}));qn.displayName=Pt.displayName;const Gn=d.forwardRef(({className:t,children:n,...a},r)=>e.jsxs($t,{ref:r,className:J("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Vt,{children:e.jsx(H,{name:"circle",className:"h-2 w-2 fill-current"})})}),n]}));Gn.displayName=$t.displayName;const Jn=d.forwardRef(({className:t,inset:n,...a},r)=>e.jsx(Tt,{ref:r,className:J("px-2 py-1.5 text-sm font-semibold",n&&"pl-8",t),...a}));Jn.displayName=Tt.displayName;const Kn=d.forwardRef(({className:t,...n},a)=>e.jsx(Ht,{ref:a,className:J("-mx-1 my-1 h-px bg-muted",t),...n}));Kn.displayName=Ht.displayName;const T=bo()(No(Co((t,n)=>({...Io,...Ao(t,n)})))),Xn=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.pushSyncNodeQueue),s=T(i=>i.createOrUpdateFlowNode),o=d.useCallback(async(i,l)=>{try{if(!t)throw new Error("Session not found");if(!l.provider||!l.name)throw new Error("Provider and name are required");a(!0);const c=await I("LLM").findOne({where:{name:l.name,session_id:t}});return c?(r("LLM",{where:{source_type:"LLM",source_id:c.id}}),c):I("LLM").save({name:`${l.name}`,status:[z.WebLLM,z.Wllama].includes(l.provider)?ce.Started:ce.Loaded,session_id:t,provider:l.provider,metadata:JSON.stringify(l.metadata||{}),model_type:l.model_type||Ea.LLM,parameters:l.parameters||void 0,encrypted:l.encrypted||void 0,...l}).then(async u=>{var m,p,h;return await s({source_id:u.id,source_type:"LLM",node_type:b.LLM,x:(m=i.position)==null?void 0:m.x,y:((p=i.position)==null?void 0:p.y)+(((h=i.measured)==null?void 0:h.height)||0)+30}),u})}finally{a(!1)}},[s,r,t]);return{loading:n,createLLM:o}};var Gt=1,Zn=.9,Yn=.8,Qn=.17,Ta=.1,Ra=.999,er=.9999,ar=.99,tr=/[\\\/_+.#"@\[\(\{&]/,sr=/[\\\/_+.#"@\[\(\{&]/g,nr=/[\s-]/,Jt=/[\s-]/g;function Pa(t,n,a,r,s,o,i){if(o===n.length)return s===t.length?Gt:ar;var l=`${s},${o}`;if(i[l]!==void 0)return i[l];for(var c=r.charAt(o),u=a.indexOf(c,s),m=0,p,h,x,f;u>=0;)p=Pa(t,n,a,r,u+1,o+1,i),p>m&&(u===s?p*=Gt:tr.test(t.charAt(u-1))?(p*=Yn,x=t.slice(s,u-1).match(sr),x&&s>0&&(p*=Math.pow(Ra,x.length))):nr.test(t.charAt(u-1))?(p*=Zn,f=t.slice(s,u-1).match(Jt),f&&s>0&&(p*=Math.pow(Ra,f.length))):(p*=Qn,s>0&&(p*=Math.pow(Ra,u-s))),t.charAt(u)!==n.charAt(o)&&(p*=er)),(p<Ta&&a.charAt(u-1)===r.charAt(o+1)||r.charAt(o+1)===r.charAt(o)&&a.charAt(u-1)!==r.charAt(o))&&(h=Pa(t,n,a,r,u+1,o+2,i),h*Ta>p&&(p=h*Ta)),p>m&&(m=p),u=a.indexOf(c,u+1);return i[l]=m,m}function Kt(t){return t.toLowerCase().replace(Jt," ")}function rr(t,n,a){return t=a&&a.length>0?`${t+" "+a.join(" ")}`:t,Pa(t,n,Kt(t),Kt(n),0,0,{})}var Ze='[cmdk-group=""]',$a='[cmdk-group-items=""]',ir='[cmdk-group-heading=""]',Va='[cmdk-item=""]',Xt=`${Va}:not([aria-disabled="true"])`,Ha="cmdk-item-select",He="data-value",or=(t,n,a)=>rr(t,n,a),Zt=d.createContext(void 0),Ye=()=>d.useContext(Zt),Yt=d.createContext(void 0),za=()=>d.useContext(Yt),Qt=d.createContext(void 0),es=d.forwardRef((t,n)=>{let a=We(()=>{var C,V;return{search:"",value:(V=(C=t.value)!=null?C:t.defaultValue)!=null?V:"",filtered:{count:0,items:new Map,groups:new Set}}}),r=We(()=>new Set),s=We(()=>new Map),o=We(()=>new Map),i=We(()=>new Set),l=as(t),{label:c,children:u,value:m,onValueChange:p,filter:h,shouldFilter:x,loop:f,disablePointerSelection:g=!1,vimBindings:_=!0,...y}=t,k=Oe(),D=Oe(),w=Oe(),E=d.useRef(null),v=_r();ze(()=>{if(m!==void 0){let C=m.trim();a.current.value=C,j.emit()}},[m]),ze(()=>{v(6,P)},[]);let j=d.useMemo(()=>({subscribe:C=>(i.current.add(C),()=>i.current.delete(C)),snapshot:()=>a.current,setState:(C,V,R)=>{var O,N,F;if(!Object.is(a.current[C],V)){if(a.current[C]=V,C==="search")A(),U(),v(1,M);else if(C==="value"&&(R||v(5,P),((O=l.current)==null?void 0:O.value)!==void 0)){let Y=V??"";(F=(N=l.current).onValueChange)==null||F.call(N,Y);return}j.emit()}},emit:()=>{i.current.forEach(C=>C())}}),[]),$=d.useMemo(()=>({value:(C,V,R)=>{var O;V!==((O=o.current.get(C))==null?void 0:O.value)&&(o.current.set(C,{value:V,keywords:R}),a.current.filtered.items.set(C,B(V,R)),v(2,()=>{U(),j.emit()}))},item:(C,V)=>(r.current.add(C),V&&(s.current.has(V)?s.current.get(V).add(C):s.current.set(V,new Set([C]))),v(3,()=>{A(),U(),a.current.value||M(),j.emit()}),()=>{o.current.delete(C),r.current.delete(C),a.current.filtered.items.delete(C);let R=S();v(4,()=>{A(),(R==null?void 0:R.getAttribute("id"))===C&&M(),j.emit()})}),group:C=>(s.current.has(C)||s.current.set(C,new Set),()=>{o.current.delete(C),s.current.delete(C)}),filter:()=>l.current.shouldFilter,label:c||t["aria-label"],getDisablePointerSelection:()=>l.current.disablePointerSelection,listId:k,inputId:w,labelId:D,listInnerRef:E}),[]);function B(C,V){var R,O;let N=(O=(R=l.current)==null?void 0:R.filter)!=null?O:or;return C?N(C,a.current.search,V):0}function U(){if(!a.current.search||l.current.shouldFilter===!1)return;let C=a.current.filtered.items,V=[];a.current.filtered.groups.forEach(O=>{let N=s.current.get(O),F=0;N.forEach(Y=>{let te=C.get(Y);F=Math.max(te,F)}),V.push([O,F])});let R=E.current;L().sort((O,N)=>{var F,Y;let te=O.getAttribute("id"),Ce=N.getAttribute("id");return((F=C.get(Ce))!=null?F:0)-((Y=C.get(te))!=null?Y:0)}).forEach(O=>{let N=O.closest($a);N?N.appendChild(O.parentElement===N?O:O.closest(`${$a} > *`)):R.appendChild(O.parentElement===R?O:O.closest(`${$a} > *`))}),V.sort((O,N)=>N[1]-O[1]).forEach(O=>{var N;let F=(N=E.current)==null?void 0:N.querySelector(`${Ze}[${He}="${encodeURIComponent(O[0])}"]`);F==null||F.parentElement.appendChild(F)})}function M(){let C=L().find(R=>R.getAttribute("aria-disabled")!=="true"),V=C==null?void 0:C.getAttribute(He);j.setState("value",V||void 0)}function A(){var C,V,R,O;if(!a.current.search||l.current.shouldFilter===!1){a.current.filtered.count=r.current.size;return}a.current.filtered.groups=new Set;let N=0;for(let F of r.current){let Y=(V=(C=o.current.get(F))==null?void 0:C.value)!=null?V:"",te=(O=(R=o.current.get(F))==null?void 0:R.keywords)!=null?O:[],Ce=B(Y,te);a.current.filtered.items.set(F,Ce),Ce>0&&N++}for(let[F,Y]of s.current)for(let te of Y)if(a.current.filtered.items.get(te)>0){a.current.filtered.groups.add(F);break}a.current.filtered.count=N}function P(){var C,V,R;let O=S();O&&(((C=O.parentElement)==null?void 0:C.firstChild)===O&&((R=(V=O.closest(Ze))==null?void 0:V.querySelector(ir))==null||R.scrollIntoView({block:"nearest"})),O.scrollIntoView({block:"nearest"}))}function S(){var C;return(C=E.current)==null?void 0:C.querySelector(`${Va}[aria-selected="true"]`)}function L(){var C;return Array.from(((C=E.current)==null?void 0:C.querySelectorAll(Xt))||[])}function W(C){let V=L()[C];V&&j.setState("value",V.getAttribute(He))}function Z(C){var V;let R=S(),O=L(),N=O.findIndex(Y=>Y===R),F=O[N+C];(V=l.current)!=null&&V.loop&&(F=N+C<0?O[O.length-1]:N+C===O.length?O[0]:O[N+C]),F&&j.setState("value",F.getAttribute(He))}function ee(C){let V=S(),R=V==null?void 0:V.closest(Ze),O;for(;R&&!O;)R=C>0?gr(R,Ze):xr(R,Ze),O=R==null?void 0:R.querySelector(Xt);O?j.setState("value",O.getAttribute(He)):Z(C)}let we=()=>W(L().length-1),_e=C=>{C.preventDefault(),C.metaKey?we():C.altKey?ee(1):Z(1)},ne=C=>{C.preventDefault(),C.metaKey?W(0):C.altKey?ee(-1):Z(-1)};return d.createElement(Ee.div,{ref:n,tabIndex:-1,...y,"cmdk-root":"",onKeyDown:C=>{var V;if((V=y.onKeyDown)==null||V.call(y,C),!C.defaultPrevented)switch(C.key){case"n":case"j":{_&&C.ctrlKey&&_e(C);break}case"ArrowDown":{_e(C);break}case"p":case"k":{_&&C.ctrlKey&&ne(C);break}case"ArrowUp":{ne(C);break}case"Home":{C.preventDefault(),W(0);break}case"End":{C.preventDefault(),we();break}case"Enter":if(!C.nativeEvent.isComposing&&C.keyCode!==229){C.preventDefault();let R=S();if(R){let O=new Event(Ha);R.dispatchEvent(O)}}}}},d.createElement("label",{"cmdk-label":"",htmlFor:$.inputId,id:$.labelId,style:vr},c),ca(t,C=>d.createElement(Yt.Provider,{value:j},d.createElement(Zt.Provider,{value:$},C))))}),dr=d.forwardRef((t,n)=>{var a,r;let s=Oe(),o=d.useRef(null),i=d.useContext(Qt),l=Ye(),c=as(t),u=(r=(a=c.current)==null?void 0:a.forceMount)!=null?r:i==null?void 0:i.forceMount;ze(()=>{if(!u)return l.item(s,i==null?void 0:i.id)},[u]);let m=ts(s,o,[t.value,t.children,o],t.keywords),p=za(),h=Be(v=>v.value&&v.value===m.current),x=Be(v=>u||l.filter()===!1?!0:v.search?v.filtered.items.get(s)>0:!0);d.useEffect(()=>{let v=o.current;if(!(!v||t.disabled))return v.addEventListener(Ha,f),()=>v.removeEventListener(Ha,f)},[x,t.onSelect,t.disabled]);function f(){var v,j;g(),(j=(v=c.current).onSelect)==null||j.call(v,m.current)}function g(){p.setState("value",m.current,!0)}if(!x)return null;let{disabled:_,value:y,onSelect:k,forceMount:D,keywords:w,...E}=t;return d.createElement(Ee.div,{ref:Qe([o,n]),...E,id:s,"cmdk-item":"",role:"option","aria-disabled":!!_,"aria-selected":!!h,"data-disabled":!!_,"data-selected":!!h,onPointerMove:_||l.getDisablePointerSelection()?void 0:g,onClick:_?void 0:f},t.children)}),lr=d.forwardRef((t,n)=>{let{heading:a,children:r,forceMount:s,...o}=t,i=Oe(),l=d.useRef(null),c=d.useRef(null),u=Oe(),m=Ye(),p=Be(x=>s||m.filter()===!1?!0:x.search?x.filtered.groups.has(i):!0);ze(()=>m.group(i),[]),ts(i,l,[t.value,t.heading,c]);let h=d.useMemo(()=>({id:i,forceMount:s}),[s]);return d.createElement(Ee.div,{ref:Qe([l,n]),...o,"cmdk-group":"",role:"presentation",hidden:p?void 0:!0},a&&d.createElement("div",{ref:c,"cmdk-group-heading":"","aria-hidden":!0,id:u},a),ca(t,x=>d.createElement("div",{"cmdk-group-items":"",role:"group","aria-labelledby":a?u:void 0},d.createElement(Qt.Provider,{value:h},x))))}),cr=d.forwardRef((t,n)=>{let{alwaysRender:a,...r}=t,s=d.useRef(null),o=Be(i=>!i.search);return!a&&!o?null:d.createElement(Ee.div,{ref:Qe([s,n]),...r,"cmdk-separator":"",role:"separator"})}),ur=d.forwardRef((t,n)=>{let{onValueChange:a,...r}=t,s=t.value!=null,o=za(),i=Be(m=>m.search),l=Be(m=>m.value),c=Ye(),u=d.useMemo(()=>{var m;let p=(m=c.listInnerRef.current)==null?void 0:m.querySelector(`${Va}[${He}="${encodeURIComponent(l)}"]`);return p==null?void 0:p.getAttribute("id")},[]);return d.useEffect(()=>{t.value!=null&&o.setState("search",t.value)},[t.value]),d.createElement(Ee.input,{ref:n,...r,"cmdk-input":"",autoComplete:"off",autoCorrect:"off",spellCheck:!1,"aria-autocomplete":"list",role:"combobox","aria-expanded":!0,"aria-controls":c.listId,"aria-labelledby":c.labelId,"aria-activedescendant":u,id:c.inputId,type:"text",value:s?t.value:i,onChange:m=>{s||o.setState("search",m.target.value),a==null||a(m.target.value)}})}),mr=d.forwardRef((t,n)=>{let{children:a,label:r="Suggestions",...s}=t,o=d.useRef(null),i=d.useRef(null),l=Ye();return d.useEffect(()=>{if(i.current&&o.current){let c=i.current,u=o.current,m,p=new ResizeObserver(()=>{m=requestAnimationFrame(()=>{let h=c.offsetHeight;u.style.setProperty("--cmdk-list-height",h.toFixed(1)+"px")})});return p.observe(c),()=>{cancelAnimationFrame(m),p.unobserve(c)}}},[]),d.createElement(Ee.div,{ref:Qe([o,n]),...s,"cmdk-list":"",role:"listbox","aria-label":r,id:l.listId},ca(t,c=>d.createElement("div",{ref:Qe([i,l.listInnerRef]),"cmdk-list-sizer":""},c)))}),pr=d.forwardRef((t,n)=>{let{open:a,onOpenChange:r,overlayClassName:s,contentClassName:o,container:i,...l}=t;return d.createElement(kd,{open:a,onOpenChange:r},d.createElement(Md,{container:i},d.createElement(Ld,{"cmdk-overlay":"",className:s}),d.createElement(Dd,{"aria-label":t.label,"cmdk-dialog":"",className:o},d.createElement(es,{ref:n,...l}))))}),hr=d.forwardRef((t,n)=>Be(a=>a.filtered.count===0)?d.createElement(Ee.div,{ref:n,...t,"cmdk-empty":"",role:"presentation"}):null),fr=d.forwardRef((t,n)=>{let{progress:a,children:r,label:s="Loading...",...o}=t;return d.createElement(Ee.div,{ref:n,...o,"cmdk-loading":"",role:"progressbar","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":100,"aria-label":s},ca(t,i=>d.createElement("div",{"aria-hidden":!0},i)))}),ue=Object.assign(es,{List:mr,Item:dr,Input:ur,Group:lr,Separator:cr,Dialog:pr,Empty:hr,Loading:fr});function gr(t,n){let a=t.nextElementSibling;for(;a;){if(a.matches(n))return a;a=a.nextElementSibling}}function xr(t,n){let a=t.previousElementSibling;for(;a;){if(a.matches(n))return a;a=a.previousElementSibling}}function as(t){let n=d.useRef(t);return ze(()=>{n.current=t}),n}var ze=typeof window>"u"?d.useEffect:d.useLayoutEffect;function We(t){let n=d.useRef();return n.current===void 0&&(n.current=t()),n}function Qe(t){return n=>{t.forEach(a=>{typeof a=="function"?a(n):a!=null&&(a.current=n)})}}function Be(t){let n=za(),a=()=>t(n.snapshot());return nl.useSyncExternalStore(n.subscribe,a,a)}function ts(t,n,a,r=[]){let s=d.useRef(),o=Ye();return ze(()=>{var i;let l=(()=>{var u;for(let m of a){if(typeof m=="string")return m.trim();if(typeof m=="object"&&"current"in m)return m.current?(u=m.current.textContent)==null?void 0:u.trim():s.current}})(),c=r.map(u=>u.trim());o.value(t,l,c),(i=n.current)==null||i.setAttribute(He,l),s.current=l}),s}var _r=()=>{let[t,n]=d.useState(),a=We(()=>new Map);return ze(()=>{a.current.forEach(r=>r()),a.current=new Map},[t]),(r,s)=>{a.current.set(r,s),n({})}};function yr(t){let n=t.type;return typeof n=="function"?n(t.props):"render"in n?n.render(t.props):t}function ca({asChild:t,children:n},a){return t&&d.isValidElement(n)?d.cloneElement(yr(n),{ref:n.ref},a(n.props.children)):a(n)}var vr={position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"};const Ba=d.forwardRef(({className:t,...n},a)=>e.jsx(ue,{ref:a,className:J("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...n}));Ba.displayName=ue.displayName;const Ua=d.forwardRef(({className:t,...n},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(H,{name:"search",className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(ue.Input,{ref:a,className:J("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...n})]}));Ua.displayName=ue.Input.displayName;const Wa=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.List,{ref:a,className:J("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...n}));Wa.displayName=ue.List.displayName;const qa=d.forwardRef((t,n)=>e.jsx(ue.Empty,{ref:n,className:"py-6 text-center text-sm",...t}));qa.displayName=ue.Empty.displayName;const Ga=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.Group,{ref:a,className:J("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...n}));Ga.displayName=ue.Group.displayName;const wr=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.Separator,{ref:a,className:J("-mx-1 h-px bg-border",t),...n}));wr.displayName=ue.Separator.displayName;const ea=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.Item,{ref:a,className:J("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",t),...n}));ea.displayName=ue.Item.displayName;const Ja=d.forwardRef(({className:t,...n},a)=>e.jsx(mn,{ref:a,className:J("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...n,children:e.jsx(rl,{className:J("flex items-center justify-center text-current"),children:e.jsx(H,{name:"check",className:"h-4 w-4"})})}));Ja.displayName=mn.displayName;const jr=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo"],br=["deepseek-r1-distill-llama-70b","llama-3.2-90b-vision-preview","llama-3.3-70b-versatile","llama-3.3-70b-specdec","llama3-70b-8192","gemma2-9b-it","llama3-8b-8192","mixtral-8x7b-32768"],Nr=["llama-3.2-90b-vision-preview"],Cr=["gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"],ua="https://aistudio.google.com/app/apikey",ma="https://platform.openai.com/api-keys",ss="https://console.groq.com/keys",Sr=[z.WebLLM,z.Wllama,z.OpenAI,z.GoogleGenerativeAI,z.Groq],Er=fa(({onConfirm:t,onCancel:n})=>{const a=Te(),{t:r}=G("dialogs"),[s,o]=d.useState(""),i=u=>{o(u)},l=async()=>{try{if((s==null?void 0:s.length)!==6)return;await(t==null?void 0:t(s)),o(""),a.resolve(!0),a.hide()}catch(u){a.reject(u)}},c=()=>{n==null||n(),o(""),a.resolve(!1),a.hide()};return e.jsx(wa,{open:a.visible,onOpenChange:c,children:e.jsxs(ja,{className:"w-[330px]",children:[e.jsxs(ba,{children:[e.jsx(Na,{children:r("create_session_passkey.title")}),e.jsx(Ys,{children:r("create_session_passkey.description")})]}),e.jsx("div",{className:"py-4",children:e.jsxs(Ud,{onChange:i,maxLength:6,children:[e.jsxs(dn,{children:[e.jsx(Xe,{index:0,hidden:!0}),e.jsx(Xe,{index:1,hidden:!0}),e.jsx(Xe,{index:2,hidden:!0})]}),e.jsx(Wd,{}),e.jsxs(dn,{children:[e.jsx(Xe,{index:3,hidden:!0}),e.jsx(Xe,{index:4,hidden:!0}),e.jsx(Xe,{index:5,hidden:!0})]})]})}),e.jsx(Qs,{children:e.jsx(Q,{disabled:(s==null?void 0:s.length)!==6,onClick:l,type:"submit",children:r("create_session_passkey.confirm")})})]})})}),kr=()=>{const[t,n]=d.useState(!1),a=ae(o=>o.currentSession),r=ae(o=>o.setCurrentSession),s=d.useCallback(async o=>{if(!(!a||!o))try{n(!0);const i=await qd(),l=await ln(i,o);await I("Session").update(a.id,{passphrase:l});const c=await I("Session").findOne({where:{id:a.id}});return c&&r(c),{passphrase:i,encrypted:l}}finally{n(!1)}},[a,r]);return{loading:t,updateSessionPassphrase:s}},ns=()=>{const t=ae(s=>s.currentSession),{modalRef:n}=Gd(Er),{updateSessionPassphrase:a}=kr(),{confirmPassphrase:r}=cn();return{confirmOrCreatePassphrase:d.useCallback(async()=>{if(t!=null&&t.passphrase)await r();else{let s="";if(await n.current.show({onConfirm:async i=>{s=i}}),!s)throw new Error("Passphrase is required");const o=await a(s);if(!o)throw new Error("Failed to update session passphrase");await Ca.set("passphrase",o.passphrase)}return Ca.get("passphrase")},[r,n,t==null?void 0:t.passphrase,a])}};function Mr(t){var R,O;const{id:n,setDialog:a}=t,{t:r}=G("components"),{toast:s}=ye(),o=oe(n),[i,l]=d.useState(!1),[c,u]=d.useState(""),[m,p]=d.useState(!1),[h,x]=d.useState(""),[f,g]=d.useState(),[_,y]=d.useState(z.WebLLM),[k,D]=d.useState(!1),[w,E]=d.useState(),v=d.useRef(),j=ae(N=>N.currentSession),$=ia(N=>N.syncCachedLLMURLs),B=ia(N=>N.cachedLLMURLs),{loading:U,createLLM:M}=Xn();v.current=w;const{confirmOrCreatePassphrase:A}=ns();d.useEffect(()=>{$()},[$]);const P=d.useMemo(()=>c?![z.WebLLM,z.Wllama].includes(_):!1,[c,_]),S=d.useMemo(()=>!(w!=null&&w.functionCallingModelIds)||!(w!=null&&w.modelList)?[]:((h?w==null?void 0:w.modelList.filter(N=>N.model_id.toLowerCase().includes(h.toLowerCase())):w==null?void 0:w.modelList)||[]).sort((N,F)=>{const Y=B.some(Ya=>Ya.includes(N.model_id)),te=B.some(Ya=>Ya.includes(F.model_id));if(Y&&!te)return-1;if(!Y&&te)return 1;const Ce=Vs.includes(N.model_id),Se=Vs.includes(F.model_id);if(Ce&&!Se)return-1;if(!Ce&&Se)return 1;const Ms=w==null?void 0:w.functionCallingModelIds.includes(N.model_id),Ls=w==null?void 0:w.functionCallingModelIds.includes(F.model_id);return Ms&&!Ls?-1:!Ms&&Ls?1:N.vram_required_MB&&F.vram_required_MB&&N.vram_required_MB!==F.vram_required_MB?N.vram_required_MB-F.vram_required_MB:N.model_id.localeCompare(F.model_id)}),[w==null?void 0:w.modelList,w==null?void 0:w.functionCallingModelIds,h,B]),L=d.useMemo(()=>{if(c)switch(_){case z.Wllama:return w==null?void 0:w.modelList.find(N=>N.model_id===c);case z.WebLLM:return(w==null?void 0:w.modelList)&&S.find(N=>N.model_id===c);case z.Groq:return g({}),{model:c,model_id:c,model_type:Nr.includes(c)?2:0,overrides:{}};case z.OpenAI:return g({}),{model:c,model_id:c,model_type:2,overrides:{}};case z.GoogleGenerativeAI:return g({}),{model:c,model_id:c,model_type:2,overrides:{}}}},[c,w==null?void 0:w.modelList,S,_]);d.useEffect(()=>{!(L!=null&&L.model_id)||!B||D(B.some(N=>N.includes(L.model_id)))},[B,L==null?void 0:L.model_id]),d.useEffect(()=>{j!=null&&j.id&&(y(z.WebLLM),u(""),x(""),g({}))},[j==null?void 0:j.id]);const W=d.useCallback(N=>{u(N),p(!1)},[]),Z=d.useCallback(N=>{x(N)},[]),ee=d.useCallback(N=>{y(N),u(""),x(""),g({})},[]),we=async()=>{var N;if(!(!o||!j))try{l(!0);let F;if(P){const Y=await A();if(!Y)throw new Error("Passphrase is not found");F=await Jd(f||{},Y)}await M(o,{name:c,model_type:_e(L==null?void 0:L.model_type),function_calling:L!=null&&L.model_id?(N=w==null?void 0:w.functionCallingModelIds)==null?void 0:N.includes(L==null?void 0:L.model_id):!1,encrypted:F,provider:_}),a==null||a(!1)}catch(F){ga("Create LLM",F),s({variant:"destructive",description:r("add_llm_card.errors.failed_to_create")})}finally{l(!1),y(z.WebLLM),g({}),u(""),x("")}};d.useLayoutEffect(()=>{(async()=>{var N;try{if(_===z.Wllama){const[F,Y]=(c==null?void 0:c.split("/"))||[],te=`${F}/${Y}`;if(!c||!F||!Y){E({modelList:[],functionCallingModelIds:[]});return}else if(((N=v.current)==null?void 0:N.input)===te)return;const Ce=await(await fetch(`https://huggingface.co/api/models/${te}`)).json();Ce.siblings?E({input:te,modelList:Ce.siblings.map(Se=>Se.rfilename).filter(Se=>Se.endsWith(".gguf")).map(Se=>({model_id:`${te}/${Se}`,model:`${te}/${Se}`,model_lib:`${te}/${Se}`,model_type:0,overrides:{}})),functionCallingModelIds:[]}):E({modelList:[],functionCallingModelIds:[]})}else _===z.WebLLM&&ve(()=>import("./index-CFeuNoUh.js").then(async F=>(await F.__tla,F)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({functionCallingModelIds:F,prebuiltAppConfig:Y})=>{const te=Y.model_list;E({modelList:te,functionCallingModelIds:F})})}catch{}})()},[_,c]);const _e=d.useCallback(N=>N===1?Ea.embedding:N===2?Ea.VLM:Ea.LLM,[]),ne=d.useMemo(()=>{switch(_){case z.Wllama:case z.WebLLM:return S.map(N=>{var F;return e.jsxs(ea,{value:N.model_id,onSelect:W,children:[c===N.model_id?e.jsx(H,{name:"check",className:"mr-2 h-4 w-4"}):e.jsx("div",{className:"mr-2 h-4 w-4"}),e.jsxs("span",{className:"max-w-md",children:[e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx(Ve,{name:N.model_id}),N.model_id]}),e.jsx("div",{className:"flex max-w-full flex-wrap gap-1",children:e.jsx(xa,{model:N,isFunctionCalling:((F=w==null?void 0:w.functionCallingModelIds)==null?void 0:F.includes(N.model_id))||!1,name:N.model_id,isCached:B.some(Y=>Y.includes(N.model_id))||!1,cloud:_!==z.WebLLM})})]})]},N.model_id)});case z.OpenAI:return jr.map(N=>e.jsxs(ea,{value:N,onSelect:W,children:[c===N?e.jsx(H,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ve,{name:N}),N]})})]},N));case z.GoogleGenerativeAI:return Cr.map(N=>e.jsxs(ea,{value:N,onSelect:W,children:[c===N?e.jsx(H,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ve,{name:N}),N]})})]},N));case z.Groq:return br.map(N=>e.jsxs(ea,{value:N,onSelect:W,children:[c===N?e.jsx(H,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ve,{name:N}),N]})})]},N))}},[B,W,c,w==null?void 0:w.functionCallingModelIds,S,_]),C=d.useMemo(()=>{if(_===z.Wllama){const[N,F]=(c==null?void 0:c.split("/"))||[];return e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"default",className:"mb-4",children:r("add_llm_card.wllama_description")}),e.jsx(q,{children:r("add_llm_card.hugging_face_repo")}),N&&F?e.jsxs("div",{className:"relative",children:[e.jsx(re,{value:`${N}/${F}`,disabled:!0,placeholder:r("add_llm_card.hugging_face_repo_placeholder")}),e.jsx(H,{onClick:()=>u(""),name:"x",className:"h-4 w-4 absolute right-3 top-3 cursor-pointer"})]}):e.jsx(re,{value:N?`${N}/${F}`:"",onChange:Y=>u(Y.target.value),placeholder:r("add_llm_card.hugging_face_repo_placeholder")}),e.jsx(q,{children:r("add_llm_card.model_name")}),e.jsxs(ut,{open:m,onOpenChange:p,children:[e.jsx(un,{asChild:!0,children:e.jsxs(Q,{variant:"outline",role:"combobox","aria-expanded":m,disabled:!N||!F,className:"w-full justify-between max-w-full overflow-hidden",children:[c&&L?L==null?void 0:L.model_id:r("add_llm_card.select_model_placeholder"),e.jsx(H,{name:"chevrons-up-down",className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(mt,{className:"w-full p-0",children:e.jsxs(Ba,{children:[e.jsx(Ua,{onValueChange:Z,placeholder:r("add_llm_card.search_placeholder")}),e.jsxs(Wa,{children:[e.jsx(qa,{children:r("add_llm_card.no_model")}),e.jsx(Ga,{children:ne})]})]})})]})]})}return e.jsxs(e.Fragment,{children:[e.jsx(q,{children:r("add_llm_card.model_name")}),e.jsxs(ut,{open:m,onOpenChange:p,children:[e.jsx(un,{asChild:!0,children:e.jsxs(Q,{variant:"outline",role:"combobox","aria-expanded":m,className:"w-full justify-between",children:[c?L==null?void 0:L.model_id:r("add_llm_card.select_model_placeholder"),e.jsx(H,{name:"chevrons-up-down",className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(mt,{className:"w-full p-0",children:e.jsxs(Ba,{children:[e.jsx(Ua,{onValueChange:Z,placeholder:r("add_llm_card.search_placeholder")}),e.jsxs(Wa,{children:[e.jsx(qa,{children:r("add_llm_card.no_model")}),e.jsx(Ga,{children:ne})]})]})})]})]})},[c,_,ne,m,p,Z]),V=d.useMemo(()=>{if(P)switch(_){case z.Groq:case z.OpenAI:return e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"destructive",className:"mt-4",children:r("add_llm_card.alert.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(q,{children:r("add_llm_card.encrypted_fields.api_key")}),e.jsx(Q,{variant:"link",className:"px-1",children:e.jsxs("a",{href:_===z.OpenAI?ma:ss,target:"_blank",rel:"noreferrer",children:["(",_===z.OpenAI?ma:ss,")"]})}),e.jsx(re,{type:"password",value:(f==null?void 0:f.key)||"",onChange:N=>g(F=>({...F,key:N.target.value}))})]})]});case z.GoogleGenerativeAI:return e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"destructive",className:"mt-4",children:r("add_llm_card.alert.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(q,{children:r("add_llm_card.encrypted_fields.api_key")}),e.jsx(Q,{variant:"link",className:"px-1",children:e.jsxs("a",{href:ua,target:"_blank",rel:"noreferrer",children:["(",ua,")"]})}),e.jsx(re,{type:"password",value:(f==null?void 0:f.key)||"",onChange:N=>g(F=>({...F,key:N.target.value}))})]}),e.jsxs("div",{className:"mt-4 flex items-center",children:[e.jsx(q,{children:r("add_llm_card.encrypted_fields.enabled_google_search_retreival")}),e.jsx(Ja,{checked:!!(f!=null&&f.enabled_google_search_retreival),className:"ml-2",onCheckedChange:N=>{g(F=>({...F,enabled_google_search_retreival:N?"true":""}))}})]})]})}},[P,_,r,f]);return e.jsxs(se,{className:"max-w-lg",children:[e.jsx(de,{children:e.jsx(he,{children:r("add_llm_card.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"grid w-full gap-1.5",children:[e.jsx(q,{children:r("add_llm_card.provider")}),e.jsxs(Le,{value:_,onValueChange:ee,children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:r("add_llm_card.provider_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Sr).map(N=>e.jsx(fe,{value:N,children:r(`add_llm_card.providers.${N.toLowerCase()}`)},N))})]}),C]}),L?e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"mt-4 text-sm text-muted-foreground center flex max-w-full flex-wrap gap-1",children:[e.jsx(Ve,{name:L.model_id,className:"mr-2"}),e.jsx(xa,{model:L,isFunctionCalling:((R=w==null?void 0:w.functionCallingModelIds)==null?void 0:R.includes(L.model_id))||!1,name:L.model_id,isCached:B.some(N=>N.includes(L.model_id))||!1,cloud:![z.WebLLM,z.Wllama].includes(_)})]}),e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.model_url")}),L.model]}),L.model_lib?e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground center flex",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.model_lib_url")}),L.model_lib]}):void 0,L.overrides&&((O=Object.keys(L.overrides))!=null&&O.length)?e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground center flex",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.metadata")}),JSON.stringify(L.overrides)]}):void 0]}):null,V]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:U||i,disabled:!(c!=null&&c.length),onClick:we,className:"w-full",children:r(k?"add_llm_card.button_add":"add_llm_card.button_download_and_add")})})]})}const rs=()=>{const t=ae(o=>{var i;return(i=o.currentSession)==null?void 0:i.id}),[n,a]=d.useState(!1),r=T(o=>o.createOrUpdateFlowNode),s=d.useCallback(async(o,i)=>{var l,c,u;try{if(!o||!t)throw new Error("Source or Session not found");a(!0);const m=((l=o.position)==null?void 0:l.x)||0,p=(((c=o.position)==null?void 0:c.y)||0)+(((u=o.measured)==null?void 0:u.height)||0),h=await I("Prompt").save({content:i.content,prefix:i.prefix,role:i.role||ge.System,status:be.Started,session_id:t,type:i.type||xe.Chat});if(!h)throw new Error("Failed to save prompt");if(!await r({source_id:h.id,source_type:"Prompt",node_type:b.Prompt,x:m,y:p+20}))throw new Error("Failed to save prompt node")}finally{a(!1)}},[t,r]);return{loading:n,createPrompt:s}},Lr={[xe.Chat]:{label:"add_prompt_card.prompt_types.chat",value:xe.Chat},[xe.FewShotExample]:{label:"add_prompt_card.prompt_types.few_shot_example",value:xe.FewShotExample}},Dr={[ge.System]:{label:"add_prompt_card.prompt_roles.system",value:ge.System},[ge.Human]:{label:"add_prompt_card.prompt_roles.human",value:ge.Human},[ge.AI]:{label:"add_prompt_card.prompt_roles.ai",value:ge.AI}},Ka=d.memo(({defaultPromptContent:t,defaultPromptRole:n,defaultPromptType:a,hidePromptRole:r,hidePromptType:s,loading:o,onSubmit:i})=>{const[l,c]=d.useState(t||""),[u,m]=d.useState(a||xe.Chat),[p,h]=d.useState(n),[x,f]=d.useState(""),{t:g}=G("components"),_=d.useCallback(E=>{c(E.target.value)},[]),y=d.useCallback(E=>{f(E.target.value)},[]),k=d.useCallback(E=>{E===xe.FewShotExample&&c(`Question: {input}
Answer: {output}`),m(E)},[]),D=d.useCallback(E=>{h(E)},[]),w=async()=>{await i({content:l,role:p,prefix:x,type:u})&&(c(""),h(void 0),m("chat"),f(""))};return e.jsxs("div",{children:[e.jsxs("div",{className:"grid w-full gap-1.5",children:[s?void 0:e.jsxs(e.Fragment,{children:[e.jsx(q,{children:g("add_prompt_card.prompt_type")}),e.jsxs(Le,{value:u,onValueChange:k,children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:g("add_prompt_card.type_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Lr).map(E=>e.jsx(fe,{value:E.value,children:g(E.label)},E.value))})]})]}),r?void 0:e.jsxs(e.Fragment,{children:[e.jsx(q,{children:g("add_prompt_card.prompt_role")}),e.jsxs(Le,{value:p,onValueChange:D,children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:g("add_prompt_card.role_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Dr).map(E=>e.jsx(fe,{value:E.value,children:g(E.label)},E.value))})]})]}),u===xe.FewShotExample&&e.jsxs(e.Fragment,{children:[e.jsx(q,{children:g("add_prompt_card.prompt_prefix")}),e.jsx(oa,{value:x,onChange:y,disabled:!1,className:"h-20",placeholder:g("add_prompt_card.placeholder"),id:"message"}),e.jsx(q,{children:g("add_prompt_card.prompt_content")}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm justify-end items-center",children:[e.jsx(H,{name:"info",className:"mr-2",size:14}),g("add_prompt_card.few_shot_example_note")]})]}),e.jsx(oa,{value:l,onChange:_,disabled:!1,placeholder:g("add_prompt_card.placeholder"),id:"message"})]}),e.jsx("div",{children:e.jsx(Fe,{loading:o,disabled:!(l!=null&&l.length),onClick:w,className:"w-full mt-4",children:g("add_prompt_card.button")})})]})}),Ir=d.memo(t=>{const{id:n,thread:a,setDialog:r}=t,{t:s}=G("components"),{toast:o}=ye(),i=oe(n),{createPrompt:l,loading:c}=rs(),u=async m=>{if(i)try{if(!(m!=null&&m.content))throw new Error("Prompt data is missing");await l(i,{...m,content:m.content,thread:a}),r==null||r(!1)}catch(p){o({variant:"destructive",title:`${p}`})}};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:s("add_prompt_card.title")})}),e.jsx(le,{children:e.jsx(Ka,{onSubmit:u,loading:c,defaultPromptRole:"system",defaultPromptType:"chat"})})]})}),Ar=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=d.useCallback((i,l,c,u)=>{var m;if(t){for(const p of l)(m=p.data)!=null&&m.length?s(i,p.data,c,p.id):c.push({name:p.name,type:p.type,enum:p.enum?JSON.stringify(p.enum):"",required:p.required,description:p.description,id:p.id||rt(),parent_id:u,schema_id:i,session_id:t});return c}},[t]),o=d.useCallback(async(i,l)=>{var c,u,m;try{if(!i||!t)throw new Error("Source or Session not found");a(!0);const p=((c=i.position)==null?void 0:c.x)||0,h=(((u=i.position)==null?void 0:u.y)||0)+(((m=i.measured)==null?void 0:m.height)||0),x=await I("Schema").save({name:"Untitled Schema",session_id:t});if(!x)throw new Error("Failed to save schema");const f=s(x.id,l,[],void 0);if(!(f!=null&&f.length))throw new Error("Failed to convert schema items");if(await I("SchemaItem").save(f),!await r({source_id:x.id,source_type:"Schema",node_type:b.Schema,x:p,y:h+20}))throw new Error("Failed to save schema node")}finally{a(!1)}},[t,s,r]);return{loading:n,createSchema:o}},is=d.memo(({setData:t,data:n,id:a})=>{const{t:r}=G("components"),[s,o]=d.useState({name:"",description:"",type:"string",required:!1,data:[]}),i=d.useMemo(()=>a&&n.find(g=>g.id===a)||s,[n,s,a]),l=d.useCallback(g=>{g.target.value&&!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(g.target.value)||(a?t(_=>[..._.map(y=>y.id===a?{...y,name:g.target.value||""}:y)]):o(_=>({..._,name:g.target.value||""})))},[a,t]),c=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,description:g.target.value||""}:y)]):o(_=>({..._,description:g.target.value||""}))},[a,t]),u=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,type:g||""}:y)]):o(_=>({..._,type:g||"string"}))},[a,t]),m=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,required:!!g||!1}:y)]):o(_=>({..._,required:!!g||!1}))},[a,t]),p=d.useCallback(g=>{a?t(_=>[..._.map(y=>y.id===a?{...y,enum:g.target.value||""}:y)]):o(_=>({..._,enum:g.target.value||""}))},[a,t]),h=d.useCallback(()=>{if(n.find(g=>g.name===s.name))return qe({variant:"destructive",content:"Name already exists"});s.id=rt(),t(g=>[...g,{...s}]),o({name:"",description:"",type:"string",required:!1,id:rt(),parent:a||void 0,data:[]})},[n,s,t,a]),x=d.useCallback(g=>{t(_=>[..._.map(y=>y.id===a?{...y,data:g(y.data||[])}:y)])},[a,t]),f=["object","array"].includes(i.type);return e.jsxs("div",{className:"w-full p-1",children:[e.jsxs("div",{children:[e.jsx(q,{children:r("add_schema_card.field.name")}),e.jsx(re,{id:"name",onChange:l,placeholder:r("add_schema_card.field.name_placeholder"),value:(i==null?void 0:i.name)||""})]}),e.jsxs("div",{children:[e.jsx(q,{children:r("add_schema_card.field.description")}),e.jsx(re,{id:"description",placeholder:r("add_schema_card.field.description_placeholder"),onChange:c,value:(i==null?void 0:i.description)||""})]}),e.jsxs("div",{children:[e.jsx(q,{children:r("add_schema_card.field.type")}),e.jsxs(Le,{onValueChange:u,value:(i==null?void 0:i.type)||"",children:[e.jsx(De,{children:e.jsx(Ie,{placeholder:r("add_schema_card.field.type_placeholder")})}),e.jsxs(Ae,{children:[e.jsx(fe,{value:"string",children:r("add_schema_card.types.string")}),e.jsx(fe,{value:"boolean",children:r("add_schema_card.types.boolean")}),e.jsx(fe,{value:"number",children:r("add_schema_card.types.number")}),e.jsx(fe,{value:"object",children:r("add_schema_card.types.object")}),e.jsx(fe,{value:"array",children:r("add_schema_card.types.array")})]})]})]}),e.jsxs("div",{className:"flex items-center h-10",children:[e.jsx(q,{children:r("add_schema_card.field.required")}),e.jsx(Ja,{className:"ml-2","aria-label":"Select row",onCheckedChange:m,checked:i==null?void 0:i.required})]}),f?e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx(q,{children:r("add_schema_card.children")}),e.jsx(os,{data:(i==null?void 0:i.data)||[],setData:x})]}):null,(i==null?void 0:i.type)==="enum"?e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx(q,{children:r("add_schema_card.field.enum")}),e.jsx(re,{id:"enum",onChange:p,placeholder:"Enum"})]}):null,a?null:e.jsx("div",{className:"w-full flex justify-end mt-2",children:e.jsx(Q,{variant:"secondary",disabled:!i.name||!i.description||!i.type,onClick:h,className:"w-full",children:r("add_schema_card.field.add_field")})})]})}),os=d.memo(({data:t,setData:n})=>e.jsxs(Oo,{type:"single",collapsible:!0,children:[t.map(a=>e.jsxs(Fo,{value:`${a.id}`,children:[e.jsx(To,{children:a.name}),e.jsx(Ro,{children:e.jsx(is,{setData:n,data:t,id:a.id})})]},a.id||"new")),e.jsx(se,{className:"p-2 mt-4",children:e.jsx(is,{setData:n,data:t})})]})),Or=d.memo(t=>{const{t:n}=G("components"),{id:a}=t,r=oe(a),[s,o]=d.useState([]),{createSchema:i,loading:l}=Ar(),c=async()=>{if(r&&(s!=null&&s.length))try{await i(r,s),o([])}catch(u){qe({variant:"destructive",title:`${u}`})}};return e.jsxs(se,{className:"max-w-lg",children:[e.jsx(de,{children:e.jsx(he,{children:n("add_schema_card.title")})}),e.jsx(le,{className:"min-w-96",children:e.jsx(os,{setData:o,data:s})}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:l,disabled:!(s!=null&&s.length),onClick:c,className:"w-full",children:n("add_schema_card.create")})})]})}),ds=()=>{const t=ae(o=>{var i;return(i=o.currentSession)==null?void 0:i.id}),[n,a]=d.useState(!1),r=T(o=>o.createOrUpdateFlowNode),s=d.useCallback(async(o,i,l)=>{var c,u,m;try{if(!o||!t)throw new Error("Source or Session not found");a(!0);const p=((c=o.position)==null?void 0:c.x)||0,h=(((u=o.position)==null?void 0:u.y)||0)+(((m=o.measured)==null?void 0:m.height)||0),x=Id(i,l),f=await I("CSVData").save({headers:x.headers,csv:x.data,session_id:t});if(!f)throw new Error("Failed to save");if(!await r({source_id:f.id,source_type:"CSVData",node_type:b.CSVData,x:p,y:h+20}))throw new Error("Failed to save node")}finally{a(!1)}},[t,r]);return{loading:n,createCSVData:s}};function Fr({data:t}){const{t:n}=G("components");return e.jsxs(Hs,{className:"w-full",children:[e.jsx(zs,{children:e.jsxs(_a,{children:[e.jsx(et,{children:n("add_few_shot_example_card.input")}),e.jsx(et,{children:n("add_few_shot_example_card.output")})]})}),e.jsx(Bs,{children:t==null?void 0:t.map((a,r)=>e.jsxs(_a,{children:[e.jsx(at,{className:"p-4",children:a.input}),e.jsx(at,{className:"p-4",children:a.output})]},`${a.input}_${a.output}_${r}`))})]})}const Tr=d.memo(t=>{const{id:n}=t,{t:a}=G("components"),[r,s]=d.useState([]),[o,i]=d.useState(""),[l,c]=d.useState(""),u=oe(n),{createCSVData:m,loading:p}=ds(),h=()=>{s(f=>[...f,{input:o,output:l}]),i(""),c("")},x=async()=>{u&&await m(u,["input","output"],r.map(f=>[f.input,f.output]))};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:a("add_few_shot_example_card.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(q,{htmlFor:"name",children:a("add_few_shot_example_card.input")}),e.jsx(re,{value:o,onChange:f=>i(f.target.value||""),id:"name",placeholder:a("add_few_shot_example_card.input_placeholder")})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(q,{htmlFor:"name",children:a("add_few_shot_example_card.output")}),e.jsx(oa,{value:l,onChange:f=>c(f.target.value||""),placeholder:a("add_few_shot_example_card.output_placeholder")})]}),e.jsx("div",{className:"w-full flex mt-4 justify-end",children:e.jsx(Q,{disabled:!o||!l,onClick:h,className:"w-40",children:a("add_few_shot_example_card.add")})}),e.jsx(Fr,{data:r||[]})]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:p,disabled:!(r!=null&&r.length),onClick:x,className:"w-full",children:a("add_few_shot_example_card.create")})})]})}),Rr=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async(i,l,c)=>{var u,m,p;try{if(!i||!t)throw new Error("Source or Session not found");if(!l.name||!l.description)throw new Error("Name is required");a(!0);const h=((u=i.position)==null?void 0:u.x)||0,x=(((m=i.position)==null?void 0:m.y)||0)+(((p=i.measured)==null?void 0:p.height)||0),f=await I("ToolDefinition").save({...l,name:`${l.name}`,description:`${l.description}`,session_id:t});if(!f)throw new Error("Failed create tool.");const g=await r({source_id:f.id,source_type:"ToolDefinition",node_type:b.ToolDefinition,x:h,y:x+20});if(!g)throw new Error("Failed to save node");c!=null&&c.schemaNode&&await s({source:c.schemaNode.id,target:g.id})}finally{a(!1)}},[t,r,s]);return{loading:n,createTool:o}},Pr=d.memo(t=>{const{t:n}=G("components"),{toast:a}=ye(),{id:r}=t,s=oe(r),[o,i]=d.useState(""),[l,c]=d.useState(""),{createTool:u,loading:m}=Rr(),p=f=>{i(f.target.value)},h=f=>{c(f.target.value)},x=async()=>{if(s&&o&&l)try{await u(s,{name:o,description:l}),i(""),c("")}catch(f){So("Create Tool",f),a({variant:"destructive",title:n("add_tool_card.errors.create_tool_failed")})}};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:n("add_tool_card.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(q,{htmlFor:"name",children:n("add_tool_card.tool_name")}),e.jsx(re,{onChange:p,id:"name",placeholder:n("add_tool_card.name_placeholder")})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(q,{htmlFor:"name",children:n("add_tool_card.tool_description")}),e.jsx(oa,{onChange:h,placeholder:n("add_tool_card.description_placeholder")})]})]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:m,onClick:x,className:"w-full",children:n("add_tool_card.create")})})]})}),$r=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async(i,l,c)=>{var u,m,p;try{if(!(l!=null&&l.name)||!i||!t)throw new Error("Source or Session not found");a(!0);const h=((u=i.position)==null?void 0:u.x)||0,x=(((m=i.position)==null?void 0:m.y)||0)+(((p=i.measured)==null?void 0:p.height)||0),f=await I("VectorDatabase").save({...l,name:`${l.name}`,type:l.type||Ad.Local,storage:l.storage||$e.DatabaseNode,raw:"",provider:l.provider||en.Memory,session_id:t,metadata:c?JSON.stringify({textSplitter:c}):void 0});if(!f)throw new Error("Failed to save vectorDatabase");const g=await r({source_id:f.id,source_type:"VectorDatabase",node_type:b.VectorDatabase,x:h,y:x+30});if(!g)throw new Error("Failed to save vectorDatabase node");if(l.storage===$e.DataNode){const _=await I("JSONLData").save({headers:Od(["content","embedding","metadata"]),jsonl:"",session_id:t});if(!_)throw new Error("Failed to save databaseSource");const y=await r({source_id:_.id,source_type:"JSONLData",node_type:b.JSONLData,x:h+80,y:x+30});if(!y)throw new Error("Failed to save databaseSource node");await s({source:y.id,target:g.id})}return{vectorDatabase:f,vectorDatabaseNode:g}}finally{a(!1)}},[t,r,s]);return{loading:n,createVectorDatabase:o}},aa=[en.Memory],ta=[$e.DatabaseNode],Vr=["TokenTextSplitter","CharacterTextSplitter","RecursiveCharacterTextSplitter"],Hr=d.memo(t=>{const{t:n}=G("components"),{id:a}=t,r=oe(a),{toast:s}=ye(),[o,i]=d.useState(""),[l,c]=d.useState(aa[0]),[u,m]=d.useState(ta[0]),[p,h]=d.useState({}),{loading:x,createVectorDatabase:f}=$r(),g=d.useCallback(v=>{c(v)},[]),_=d.useCallback(v=>{m(v)},[]),y=d.useCallback(v=>{h(j=>({...j,type:v,chunkSize:500,chunkOverlap:40}))},[]),k=d.useCallback(v=>{i(v.target.value||"")},[]),D=d.useCallback(v=>{h(j=>({...j,chunkSize:Number(v.target.value)}))},[]),w=d.useCallback(v=>{h(j=>({...j,chunkOverlap:Number(v.target.value)}))},[]),E=async()=>{try{if(!r)return;await f(r,{name:o,provider:l,storage:u},p!=null&&p.type?{type:p.type,chunkSize:p.chunkSize||500,chunkOverlap:p.chunkOverlap||0}:void 0),i(""),h({})}catch{s({variant:"destructive",description:n("create_vector_database_card.errors.create_failed")})}};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:n("create_vector_database_card.title")})}),e.jsx(le,{children:e.jsxs("div",{className:"grid w-full gap-1.5",children:[e.jsx(q,{children:n("create_vector_database_card.name")}),e.jsx(re,{className:"mb-4",value:o,onChange:k}),(ta==null?void 0:ta.length)>1?e.jsxs(e.Fragment,{children:[e.jsx(q,{children:n("create_vector_database_card.storage_type")}),e.jsxs(Le,{value:u,onValueChange:_,children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:n("create_vector_database_card.provider_select_placeholder")})}),e.jsx(Ae,{children:Object.values(ta).map(v=>e.jsx(fe,{value:v,children:n(`create_vector_database_card.storage_types.${v.toLowerCase()}`)},v))})]})]}):void 0,(aa==null?void 0:aa.length)>1?e.jsxs(e.Fragment,{children:[e.jsx(q,{children:n("create_vector_database_card.provider")}),e.jsxs(Le,{value:l,onValueChange:g,children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:n("create_vector_database_card.provider_select_placeholder")})}),e.jsx(Ae,{children:Object.values(aa).map(v=>e.jsx(fe,{value:v,children:n(`create_vector_database_card.providers.${v.toLowerCase()}`)},v))})]})]}):void 0,e.jsx(q,{children:n("create_vector_database_card.text_splitter")}),e.jsxs(Le,{value:p.type,onValueChange:y,children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:n("create_vector_database_card.text_splitter_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Vr).map(v=>e.jsx(fe,{value:v,children:n(`create_vector_database_card.text_splitters.${v.toLowerCase()}`)},v))})]}),p.type?e.jsxs(se,{children:[e.jsx(de,{children:e.jsx(he,{children:n("create_vector_database_card.text_splitter_configuration")})}),e.jsxs(le,{children:[e.jsx(q,{children:n("create_vector_database_card.text_splitter_chunksize")}),e.jsx(re,{value:p.chunkSize,onChange:D,placeholder:n("create_vector_database_card.text_splitter_chunksize_placeholder")}),e.jsx(q,{children:n("create_vector_database_card.text_splitter_chunkoverlap")}),e.jsx(re,{value:p.chunkOverlap,onChange:w,placeholder:n("create_vector_database_card.text_splitter_chunkoverlap_placeholder")})]})]}):void 0]})}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{disabled:!p.type||!o,loading:x,onClick:E,className:"w-full",children:n("create_vector_database_card.create")})})]})});function zr({data:t}){const{t:n}=G("components");return e.jsxs(Hs,{className:"w-full",children:[e.jsx(zs,{children:e.jsx(_a,{children:e.jsx(et,{children:n("add_text_data.text")})})}),e.jsx(Bs,{children:t==null?void 0:t.map((a,r)=>e.jsx(_a,{children:e.jsx(at,{className:"p-4",children:a.text})},`${a.text}_${r}`))})]})}const Br=d.memo(t=>{const{id:n}=t,{t:a}=G("components"),[r,s]=d.useState([]),[o,i]=d.useState(""),l=oe(n),{createCSVData:c,loading:u}=ds(),m=()=>{s(h=>[...h,{text:o}]),i("")},p=async()=>{l&&await c(l,["text"],r.map(h=>[h.text]))};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:a("add_text_data.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(q,{htmlFor:"name",children:a("add_text_data.text")}),e.jsx(oa,{value:o,onChange:h=>i(h.target.value||""),placeholder:a("add_text_data.text_placeholder")})]}),e.jsx("div",{className:"w-full flex mt-4 justify-end",children:e.jsx(Q,{disabled:!o,onClick:m,className:"w-40",children:a("add_text_data.add")})}),e.jsx(zr,{data:r||[]})]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:u,disabled:!(r!=null&&r.length),onClick:p,className:"w-full",children:a("add_text_data.create")})})]})});var ke=(t=>(t.ADD_LLM="ADD_LLM",t.ADD_PROMPT="ADD_PROMPT",t.ADD_TOOL_DEFINITION="ADD_TOOL_DEFINITION",t.ADD_SCHEMA="ADD_SCHEMA",t.ADD_FEW_SHOT_EXAMPLE="ADD_FEW_SHOT_EXAMPLE",t.ADD_VECTOR_DATABASE="ADD_VECTOR_DATABASE",t.ADD_TEXT_DATA="ADD_TEXT_DATA",t))(ke||{});const Ur=["ADD_LLM","ADD_PROMPT","ADD_SCHEMA","ADD_VECTOR_DATABASE",{key:"more",label:"more",icon:"ellipsis",children:["ADD_TOOL_DEFINITION","ADD_FEW_SHOT_EXAMPLE"]}],Wr=()=>{const t="_coolMode_effect",n=document.getElementById(t);if(n)return n;const a=document.createElement("div");return a.setAttribute("id",t),a.setAttribute("style","overflow:hidden; position:fixed; height:100%; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:2147483647"),document.body.appendChild(a),a};let ls=0;const qr=(t,n)=>{ls++;const a=(n==null?void 0:n.particle)||"circle",r=[15,20,25,35,45],s=45;let o=[],i=!1,l=0,c=0;const u=Wr();function m(){const j=(n==null?void 0:n.size)||r[Math.floor(Math.random()*r.length)],$=(n==null?void 0:n.speedHorz)||Math.random()*10,B=(n==null?void 0:n.speedUp)||Math.random()*25,U=Math.random()*360,M=Math.random()*35*(Math.random()<=.5?-1:1),A=c-j/2,P=l-j/2,S=Math.random()<=.5?-1:1,L=document.createElement("div");if(a==="circle"){const W="http://www.w3.org/2000/svg",Z=document.createElementNS(W,"svg"),ee=document.createElementNS(W,"circle");ee.setAttributeNS(null,"cx",(j/2).toString()),ee.setAttributeNS(null,"cy",(j/2).toString()),ee.setAttributeNS(null,"r",(j/2).toString()),ee.setAttributeNS(null,"fill",`hsl(${Math.random()*360}, 70%, 50%)`),Z.appendChild(ee),Z.setAttribute("width",j.toString()),Z.setAttribute("height",j.toString()),L.appendChild(Z)}else L.innerHTML=`<img src="${a}" width="${j}" height="${j}" style="border-radius: 50%">`;L.style.position="absolute",L.style.transform=`translate3d(${P}px, ${A}px, 0px) rotate(${U}deg)`,u.appendChild(L),o.push({direction:S,element:L,left:P,size:j,speedHorz:$,speedUp:B,spinSpeed:M,spinVal:U,top:A})}function p(){o.forEach(j=>{j.left=j.left-j.speedHorz*j.direction,j.top=j.top-j.speedUp,j.speedUp=Math.min(j.size,j.speedUp-1),j.spinVal=j.spinVal+j.spinSpeed,j.top>=Math.max(window.innerHeight,document.body.clientHeight)+j.size&&(o=o.filter($=>$!==j),j.element.remove()),j.element.setAttribute("style",["position:absolute","will-change:transform",`top:${j.top}px`,`left:${j.left}px`,`transform:rotate(${j.spinVal}deg)`].join(";"))})}let h,x=0;const f=30;function g(){const j=performance.now();i&&o.length<s&&j-x>f&&(m(),x=j),p(),h=requestAnimationFrame(g)}g();const _="ontouchstart"in window,y=_?"touchstart":"mousedown",k=_?"touchend":"mouseup",D=_?"touchmove":"mousemove",w=j=>{var $,B;"touches"in j?(l=($=j.touches)==null?void 0:$[0].clientX,c=(B=j.touches)==null?void 0:B[0].clientY):(l=j.clientX,c=j.clientY)},E=j=>{w(j),i=!0},v=()=>{i=!1};return t.addEventListener(D,w,{passive:!0}),t.addEventListener(y,E,{passive:!0}),t.addEventListener(k,v,{passive:!0}),t.addEventListener("mouseleave",v,{passive:!0}),()=>{t.removeEventListener(D,w),t.removeEventListener(y,E),t.removeEventListener(k,v),t.removeEventListener("mouseleave",v);const j=setInterval(()=>{h&&o.length===0&&(cancelAnimationFrame(h),clearInterval(j),--ls===0&&u.remove())},500)}},Gr=({children:t,options:n})=>{const a=d.useRef(null);return d.useEffect(()=>{if(a.current)return qr(a.current,n)},[n]),sa.cloneElement(t,{ref:a})},Jr=d.memo(t=>{const{t:n}=G("flows"),a=Ts(l=>l.theme),[r,s]=d.useState(`${ke.ADD_LLM}`),o=d.useMemo(()=>e.jsxs(Ut,{children:[e.jsx(Oa,{children:e.jsx(Gr,{children:e.jsx(Q,{variant:"link",className:"!p-0 !pl-3",children:e.jsx(Eo,{width:32,height:32,className:J(a==="dark"?"fill-white":"fill-black")})})})}),Ur.map(l=>typeof l=="object"?e.jsxs(Oa,{children:[e.jsx(Fa,{children:l.icon?e.jsx(H,{name:l.icon}):n(`supported_nodes.${l.label}`)}),e.jsx(Wt,{children:l.children.map(c=>e.jsx(qt,{onClick:()=>s(c),children:n(`supported_nodes.${c.toLowerCase()}`)},c))})]},l.key):e.jsx(Oa,{children:e.jsx(Fa,{value:l,onClick:()=>s(l),children:n(`supported_nodes.${l.toLowerCase()}`)})},l))]}),[n,a]),i=d.useMemo(()=>{switch(r){case ke.ADD_LLM:return e.jsx(Mr,{...t});case ke.ADD_PROMPT:return e.jsx(Ir,{...t});case ke.ADD_SCHEMA:return e.jsx(Or,{...t});case ke.ADD_FEW_SHOT_EXAMPLE:return e.jsx(Tr,{...t});case ke.ADD_TOOL_DEFINITION:return e.jsx(Pr,{...t});case ke.ADD_VECTOR_DATABASE:return e.jsx(Hr,{...t});case ke.ADD_TEXT_DATA:return e.jsx(Br,{...t})}},[t,r]);return e.jsxs(e.Fragment,{children:[o,e.jsx("div",{className:"mt-4",children:i})]})}),Kr=()=>{const[t,n]=d.useState(!1),a=Fd(),r=ae(l=>l.currentSession),s=ae(l=>l.getLatestApplications),o=d.useCallback(async(l,c,u,m)=>{var x;const p=(x=c.data)==null?void 0:x.entity;let h=c.type?Td[c.type]:void 0;if(h&&p&&c&&typeof p=="object"&&"id"in p&&!u.has(`${p.id}`)&&!m.has(`${c.id}`)){h=h;const f=await I(h).save({...p,...p&&typeof p=="object"&&"session_id"in p?{session_id:l.id}:{}});u.set(`${p.id}`,f.id);const g=await I("FlowNode").findOne({where:{id:c.data.flowNode.id}}),_=await I("FlowNode").save({...g||c.data.flowNode,session_id:l.id,id:void 0,source_type:h,source_id:f.id});return m.set(`${c.id}`,_.id),{entityName:h,entity:f,node:_}}else if(!m.has(`${c.id}`)){const f=await I("FlowNode").findOne({where:{id:c.data.flowNode.id}}),g=await I("FlowNode").save({...f||c.data.flowNode,node_type:c.type,session_id:l.id,id:void 0});return m.set(`${c.id}`,g.id),{node:g}}},[]),i=d.useCallback(async(l,c)=>{try{if(!r)throw new Error("No current session");n(!0);const u=await I("Session").save({type:Rd.StandaloneApp,name:c.name||(r!=null&&r.name?`${r.name}`:"Standalone"),status:Pd.Started,passphrase:r.passphrase});if(!u)throw new Error("Failed create standalone session");const m=new Map,p=new Map,h=await o(u,l,m,p);if(!h)throw new Error("Failed to clone main node");await I("Session").update(u.id,{main_node_id:h.node.id,main_source_id:h!=null&&h.entity?h.entity.id:void 0,main_source_type:h.entityName?h.entityName:void 0});for(const{node:x,connectedNodes:f}of c.connections)if(await o(u,x,m,p),f)for(const g of f)await o(u,g,m,p);for(const{connections:x}of c.connections)for(const f of x){const g=p.get(`${f.source}`),_=p.get(`${f.target}`);if(!g||!_)throw new Error("Failed to get connected flow node id");await I("FlowEdge").save({source:g,target:_,sourceHandle:f.sourceHandle,targetHandle:f.targetHandle,session_id:u.id})}return s(),a($d("application",{applicationId:u.id})),!0}finally{n(!1)}},[o,r,s,a]);return{loading:t,createStandaloneSession:i}},Xr=()=>{const[t,n]=d.useState(!1),a=T(o=>o.updateNodes),r=T(o=>o.updateEdges),s=d.useCallback(async o=>{try{n(!0),await I("FlowNode").delete(o);const i=await I("FlowEdge").find({where:[{source:o},{target:o}]});return await Promise.all(i.map(l=>I("FlowEdge").delete(l.id))),await a([{id:o,type:"remove"}]),await r(i.map(l=>({id:l.id,type:"remove"}))),!0}catch{return!1}finally{n(!1)}},[r,a]);return{loading:t,deleteNodeFlow:s}},Zr=fa(({cloneStandaloneSession:t})=>{const n=Te(),{t:a}=G("dialogs"),[r,s]=d.useState(""),{toast:o}=ye(),i=c=>{s(c.target.value)},l=async()=>{try{n.hide(),await t(r),s("")}catch{o({variant:"destructive",description:a("create_standalone_application.errors.create_failed")})}};return e.jsx(wa,{open:n.visible,onOpenChange:n.hide,children:e.jsxs(ja,{className:"sm:max-w-[425px]",children:[e.jsxs(ba,{children:[e.jsx(Na,{children:a("create_session.title")}),e.jsx(Ys,{children:a("create_standalone_application.description")})]}),e.jsx("div",{className:"grid gap-4 py-4",children:e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(q,{className:"mb-2",htmlFor:"name",children:a("create_standalone_application.name")}),e.jsx(re,{onChange:i,id:"name",value:r,placeholder:a("create_standalone_application.name_placeholder")})]})}),e.jsx(Qs,{children:e.jsx(Q,{onClick:l,disabled:!r,type:"submit",children:a("create_standalone_application.create")})})]})})}),me=d.memo(({id:t,className:n,enableToStandalone:a,getLinkedConnections:r})=>{const{t:s}=G("common"),{getNode:o}=Ne(),{loading:i,deleteNodeFlow:l}=Xr(),{createStandaloneSession:c}=Kr(),{toast:u}=ye(),m=Te(Zr),p=d.useCallback(async()=>{try{await l(t),u({description:s("deleted")})}catch{u({description:s("errors.delete_failed"),variant:"destructive"})}},[l,t,u,s]),h=d.useCallback(async f=>{try{const g=o(t);if(!g)throw new Error("No current node");const _=(r==null?void 0:r(t))||[];await c(g,{name:f,connections:_}),u({description:s("standalone_session_created")})}catch(g){ga("Clone Standalone Session",g),u({description:s("errors.create_standalone_session_failed"),variant:"destructive"})}},[o,t,r,c,u,s]),x=d.useCallback(()=>{m.show({cloneStandaloneSession:h})},[h,m]);return e.jsxs("div",{className:J("flex absolute z-[51] right-0 top-0 h-10",n),children:[a?e.jsx(Q,{className:"!rounded-none !px-2",onClick:x,variant:"ghost",children:e.jsx(H,{name:"package-plus",size:16})}):void 0,e.jsx(Fe,{loading:i,className:"!rounded-none !px-2",onClick:p,variant:"ghost",children:e.jsx(H,{name:"trash-2",size:16})})]})}),X=d.memo(t=>{const{className:n,...a}=t;return e.jsx(Po,{className:J("!w-2 !h-2 !border-none !rounded-full !bg-slate-700",t.position===K.Top?"!top-[-2px]":"",n),...a})}),Yr=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async i=>{var l,c;a(!0);try{const u=(l=i.data)==null?void 0:l.entity;if(!u||!t)throw new Error("LLM or Session not found");const m=i.position.x,p=i.position.y+(((c=i.measured)==null?void 0:c.height)||0),h=await I("Thread").save({initial_llm_id:u.id,title:`New thread with ${u.name}`,status:da.Started,messages:[],session_id:t}),x=await r({source_id:h.id,source_type:"Thread",node_type:b.Thread,x:m,y:p+60});if(!x)throw new Error("Failed to create thread node");const f=await s({source:i.id,target:x.id});return{thread:h,flowNode:x,flowEdge:f}}finally{a(!1)}},[s,r,t]);return{loading:n,createThread:o}},Qr=(t,n)=>{var D;const{t:a}=G("flows"),{toast:r}=ye(),[s,o]=d.useState(!1),[i,l]=d.useState(!1),c=oe(t),{loadModel:u}=Kd(),{createThread:m,loading:p}=Yr(),h=T(w=>w.updateNodes),x=T(w=>w.pushSyncNodeQueue),{getNodes:f}=Ne(),g=d.useCallback(async()=>{try{if(l(!0),n.entity.id){const w=await I("Thread").find({where:{initial_llm_id:n.entity.id}});x("Thread",{where:{source_type:"Thread",source_id:lt(w.map(E=>E.id))}})}}finally{l(!1)}},[(D=n==null?void 0:n.entity)==null?void 0:D.id,x]),_=d.useCallback(async()=>{try{if(o(!0),n.entity&&c){await(u==null?void 0:u(n.entity.provider,`${n.entity.name}`,{provider:n.entity.provider,callback:E=>{c.data.status=E.progress===100?ce.Loaded:ce.Loading,c.data.label=E.text,h([{id:t,type:"replace",item:c}])}}));const w=f().filter(E=>E.type===b.LLM?E.data.entity.provider===z.WebLLM:!1).map(E=>(E.data.status=ce.Started,{id:E.id,type:"replace",item:E}));c.data.label="",c.data.status=ce.Loaded,w.push({id:t,type:"replace",item:c}),h(w),await g()}}catch(w){ga("Load Model",w),r({variant:"destructive",description:a("llm_node.errors.loading_model")})}finally{o(!1)}},[n.entity,f,t,u,c,g,a,r,h]),y=d.useCallback(async()=>{n.entity&&c&&await(m==null?void 0:m(c))},[n.entity,c,m]),k=d.useCallback(async w=>{n.entity&&c&&(c.data.entity.options=w,await I("LLM").update(n.entity.id,{options:w}),h([{id:t,type:"replace",item:c}]))},[n.entity,t,c,h]);return d.useEffect(()=>{n.entity&&c&&n.entity.status!==n.status&&(c.data.status=n.entity.status,h([{id:t,type:"replace",item:c}]))},[]),{loadingModel:s,creatingThread:p,queringThreads:i,changeLLMOptions:k,loadModel:_,createThread:y,queryThreads:g}},pe=(t,n)=>{const[a,r]=d.useState(!1),[s,o]=d.useState([]),{deleteElements:i,getNode:l}=Ne();ya({type:"target",nodeId:t,onConnect:u=>{u!=null&&u.length&&o(m=>[...m,...$o(u)])}});const c=d.useCallback(async(u,m,p,h)=>{try{return await n({id:t,edgeId:u,source:m,target:p,connection:h})}catch{return{deleteEdgeId:u}}},[n,t]);d.useEffect(()=>{!(s!=null&&s.length)||a||(async()=>{try{r(!0);const u=[...s];o([]);const m=[],p=l(t);await Promise.all(u.map(async h=>{const x="edgeId"in h?h.edgeId:void 0,f=l(h.source);if(!f||!p)return;const g=await c(`${x}`,f,p,h);g!=null&&g.deleteEdgeId&&m.push(...Array.isArray(g.deleteEdgeId)?g.deleteEdgeId:[g.deleteEdgeId])})),m!=null&&m.length&&await i({edges:m.map(h=>({id:h}))})}finally{r(!1)}})()},[i,l,t,a,c,s])},ei=t=>{const n=d.useCallback(async()=>{},[]);pe(t,n)},ai=d.memo(t=>{var y,k,D,w,E,v;const{id:n,data:a,isConnectable:r}=t,[s,o]=d.useState(),{t:i}=G("flows"),{createThread:l,loadModel:c,queringThreads:u,queryThreads:m,loadingModel:p,changeLLMOptions:h}=Qr(n,a);ei(n);const x=[ce.Loading,ce.Downloading].includes(a.status);d.useEffect(()=>{var j,$,B,U,M,A,P,S,L;if(!(s||!((j=a==null?void 0:a.entity)!=null&&j.name))){if([z.WebLLM,z.Wllama].includes(($=a==null?void 0:a.entity)==null?void 0:$.provider)){if(z.Wllama===((B=a==null?void 0:a.entity)==null?void 0:B.provider)){ve(()=>import("./file-tree-91g8yP8x.js").then(async W=>(await W.__tla,W)).then(W=>W.i),__vite__mapDeps([7,4,2,3])).then(async({ModelManager:W})=>{var ee,we,_e;const Z=await new W().getModels();o({hasCache:!!Z.find(ne=>{var C;return ne.url.includes((C=a==null?void 0:a.entity)==null?void 0:C.name)}),cloud:!1,isFunctionCalling:!1,info:{model_id:(ee=a==null?void 0:a.entity)==null?void 0:ee.name,model:(we=a==null?void 0:a.entity)==null?void 0:we.name,model_lib:(_e=a==null?void 0:a.entity)==null?void 0:_e.provider,model_type:2}})}),o({hasCache:!1,cloud:!1,isFunctionCalling:!0,info:{model_id:(U=a==null?void 0:a.entity)==null?void 0:U.name,model:(M=a==null?void 0:a.entity)==null?void 0:M.name,model_lib:(A=a==null?void 0:a.entity)==null?void 0:A.provider,model_type:2}});return}}else{o({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:(P=a==null?void 0:a.entity)==null?void 0:P.name,model:(S=a==null?void 0:a.entity)==null?void 0:S.name,model_lib:(L=a==null?void 0:a.entity)==null?void 0:L.provider,model_type:2}});return}ve(()=>import("./index-CFeuNoUh.js").then(async W=>(await W.__tla,W)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:W,functionCallingModelIds:Z,prebuiltAppConfig:ee})=>{var _e,ne;const we=await W((_e=a==null?void 0:a.entity)==null?void 0:_e.name);o({hasCache:we,isFunctionCalling:Z.includes((ne=a==null?void 0:a.entity)==null?void 0:ne.name),info:ee.model_list.find(C=>{var V;return C.model_id===((V=a==null?void 0:a.entity)==null?void 0:V.name)})})})}},[(y=a==null?void 0:a.entity)==null?void 0:y.name,(k=a==null?void 0:a.entity)==null?void 0:k.provider,s]);const f=d.useCallback(async j=>{await h(j)},[h]),g=d.useMemo(()=>{var j,$;switch(a.status){case ce.Downloading:return e.jsx(H,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case ce.Loaded:return e.jsx(Ve,{name:((j=a.entity)==null?void 0:j.name)||"brain",className:"w-7 h-7"});case ce.Loading:return e.jsx(H,{className:"animate-spin w-7 h-7",name:"loader-circle"});default:return e.jsx(Ve,{name:(($=a.entity)==null?void 0:$.name)||"brain",className:"w-7 h-7"})}},[(D=a.entity)==null?void 0:D.name,a.status]),_=d.useMemo(()=>x?null:p?e.jsx(Q,{disabled:!0,className:"w-full mt-4",children:e.jsx(H,{className:"animate-spin",size:24,name:"loader-circle"})}):a.status===ce.Loaded?e.jsx(Q,{onClick:l,className:"mt-4 w-full",children:i("llm_node.create_thread_button")}):e.jsxs("div",{className:"flex gap-2 mt-4",children:[s!=null&&s.hasCache?e.jsx(Fe,{loading:u,onClick:m,children:e.jsx(H,{size:24,name:"message-square-more"})}):null,e.jsx(Q,{disabled:p,onClick:c,className:"w-full",children:i(s!=null&&s.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")})]}),[x,p,a.status,s==null?void 0:s.hasCache,u,m,c,i,l]);return e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(je,{className:"flex justify-center",children:[g,e.jsxs("div",{className:"ml-2 pt-1 max-w-lg",children:[e.jsx(Pe,{className:"flex gap-2 items-center pr-6",children:`${((w=a==null?void 0:a.entity)==null?void 0:w.name)||""}`}),e.jsx(na,{className:"max-w-full",children:`${a.label||""}`}),e.jsx("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:e.jsx(xa,{model:s==null?void 0:s.info,isFunctionCalling:(s==null?void 0:s.isFunctionCalling)||!1,name:(E=a==null?void 0:a.entity)==null?void 0:E.name,isCached:(s==null?void 0:s.hasCache)||!1,cloud:(s==null?void 0:s.cloud)||!1})}),e.jsx(Vo,{options:(v=a==null?void 0:a.entity)==null?void 0:v.options,onChangeOptions:f,className:"mt-2"}),_]})]}),x?e.jsx(Us,{className:"rounded-lg"}):void 0]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),Xa=d.memo(({tags:t,disabled:n,loading:a,onSubmit:r})=>{const{t:s}=G("components"),o=async i=>{try{return await r(i),!0}catch{return!1}};return e.jsxs(se,{className:"min-w-80",children:[e.jsx(de,{children:e.jsx(he,{children:s("add_message_card.title")})}),e.jsxs(le,{children:[e.jsx("div",{className:"grid w-full gap-1.5",children:e.jsx(el,{onSubmit:o,disabled:n||a,placeholder:s("add_message_card.placeholder")})}),t?e.jsx("div",{className:"mt-2 gap-1 flex flex-wrap",children:t}):null]})]})}),cs=(t,n,a,r=[],s)=>{const o=t.map(i=>s.getNode(i));for(const i of o){if(!i)continue;const l=s.getHandleConnections({type:"target",nodeId:i.id});if(a.push(...l),i.type===b.Thread){r.push(i.id),n.push(i);continue}else if(i.type!==b.Message){r.push(i.id);continue}else if(r.includes(i.id))continue;r.push(i.id),n.push(i),l.length&&cs(l.map(c=>c.source),n,a,r,s)}return{nodes:n,connections:a}},us=(t,n)=>{const a=n.getHandleConnections({nodeId:t.id,type:"target"}),r=a.map(p=>{const h=n.getNode(p.source);return h?{connections:n.getHandleConnections({nodeId:h.id,type:"target"}),node:h}:void 0}),s=r.filter(p=>{var h;return((h=p.node)==null?void 0:h.type)===b.Prompt}),o=[];s!=null&&s.length&&s.forEach(p=>{var x;const h=(x=p.connections)==null?void 0:x.map(f=>n.getNode(f.source)).filter(Boolean);o.push({node:p.node,connections:p.connections,connectedNodes:h})});const i=r.filter(p=>{var h;return((h=p.node)==null?void 0:h.type)===b.ToolDefinition}),l=[];i!=null&&i.length&&i.forEach(p=>{var x;const h=(x=p.connections)==null?void 0:x.map(f=>n.getNode(f.source)).filter(Boolean);h!=null&&h.find(f=>f.type===b.Schema)&&l.push({node:p.node,connections:p.connections,connectedNodes:h})});const c=r.filter(p=>{var h;return((h=p.node)==null?void 0:h.type)===b.PlaceHolder}),u=[];c!=null&&c.length&&c.forEach(p=>{var x;const h=(x=p.connections)==null?void 0:x.map(f=>n.getNode(f.source)).filter(Boolean);h&&u.push({node:p.node,connections:p.connections,connectedNodes:h})});const m=r.find(p=>{var h;return((h=p.node)==null?void 0:h.type)===b.Schema});return{thread:{node:t,connections:a},llm:r.find(p=>{var h;return((h=p.node)==null?void 0:h.type)===b.LLM}),schemas:m?[m]:[],prompts:o,tools:l,placeholders:u}},ms=t=>{const n=[];return t.forEach(a=>{var o,i,l;const{node:r,connectedNodes:s}=a;if((o=r.data)!=null&&o.entity){if(r.type===b.Message){const c=r.data.entity;switch(c.role){case"human":n.push(new Ke(c.content));break;case"ai":n.push(new Sa(c.content));break}}else if(r.type===b.Prompt){const c=r.data.entity;let u=`${c.prefix?`${c.prefix}
`:""}`;if(c.type===xe.FewShotExample){const m=(l=(i=s.find(p=>p.type===b.CSVData))==null?void 0:i.data)==null?void 0:l.entity;if(m){const{rows:p}=an(m.headers,m.csv);p.forEach(h=>{u+=`${c.content.replace(/{([^{}]*)}/g,(x,f)=>`${h[f]}`)}
`})}}else u+=c.content;switch(c.suffix&&(u+=`
${c.suffix}`),c.role){case"human":n.push(new Ke(u));break;case"system":n.push(new tn(u));break;default:n.push(new Sa(u));break}}}}),n},ti=(t,n)=>{const a=(t==null?void 0:t.filter(s=>s.type===b.Message).map(s=>({node:s,connectedNodes:[]})).reverse())||[],r=[];return n.forEach(async s=>{r.unshift({node:s.node,connectedNodes:s.connectedNodes||[]})}),{history:ms(a),systems:ms(r)}},si=t=>t?t.reduce((n,a)=>{var o,i,l,c,u;const r=(o=a.node.data)==null?void 0:o.entity,s=(c=(l=(i=a==null?void 0:a.connectedNodes)==null?void 0:i.find(m=>m.type===b.Schema))==null?void 0:l.data)==null?void 0:c.entity;return r&&((u=s==null?void 0:s.schema_items)!=null&&u.length)&&n.push({name:r.name,description:r.description,schemaItems:s.schema_items}),n},[]):[],Za=()=>{const{getNodes:t}=Ne(),n=d.useCallback(()=>t().find(r=>r.type===b.DefaultEmbeddingModel),[t]),a=d.useCallback(()=>{var r,s;return(s=(r=n())==null?void 0:r.data)==null?void 0:s.entity},[n]);return{getFlowEmbeddingNode:n,getFlowEmbeddingEntity:a}},ps=({getNode:t,getHandleConnections:n})=>{const{t:a}=G("create_new_message"),[r,s]=d.useState(!1),o=ae(g=>g.currentSession),i=T(g=>g.createOrUpdateFlowNode),l=T(g=>g.createOrUpdateFlowEdge),{similaritySearchWithScore:c}=tt(),{getFlowEmbeddingEntity:u}=Za(),{stream:m}=ct(),p=d.useCallback(async({content:g,threadId:_,sourceId:y,initialX:k,initialY:D,initialLLMId:w})=>{if(!o)throw new Error("Session is not found");const E=await I("Message").save({thread_id:_,content:g,role:ge.Human,status:be.Started,llm_id:w,session_id:o.id});if(!E)throw new Error("Failed to save message");const v=await i({source_id:E.id,source_type:"Message",node_type:b.Message,x:k,y:D+80});if(!v)throw new Error("Failed to save human message node");await l({source:y,target:v.id});const j=await I("Message").save({thread_id:_,content:a("initial_ai_message"),role:ge.AI,status:be.Inprogress,llm_id:w,parent_message_id:E.id,session_id:o.id});if(!j)throw new Error("Failed to save message");const $=await i({source_id:j.id,source_type:"Message",node_type:b.Message,x:k,y:D+250});if(!$)throw new Error("Failed to save ai message node");return await l({source:v.id,target:$.id}),{aiMessage:j,humanMessage:E,aiMessageNode:$,humanMessageNode:v}},[l,i,o,a]),h=d.useCallback(async(g,_)=>{const{placeholders:y}=_;if(!(y!=null&&y.length))return[];const k=[];return await Promise.all(y.map(async D=>{var E,v,j,$,B,U,M,A,P,S,L,W;const w=(E=D.node.data)==null?void 0:E.entity;if(w)switch(w.placeholder_type){case ra.VECTOR_DATABASE_RETREIVER:{const Z=(v=D.connectedNodes)==null?void 0:v.find(R=>R.type===b.VectorDatabase),ee=(j=Z==null?void 0:Z.data)==null?void 0:j.entity,we=(U=(B=($=D.connectedNodes)==null?void 0:$.find(R=>R.type===b.Prompt))==null?void 0:B.data)==null?void 0:U.entity;if(!we||!ee||!Z)return;const _e=(M=w.metadata)!=null&&M.k?+((A=w.metadata)==null?void 0:A.k):1;let ne=(P=w.metadata)!=null&&P.minimalScore?+((S=w.metadata)==null?void 0:S.minimalScore):void 0;ne&&ne>1&&(ne=ne/100);const C=[];if(ee.storage===$e.DataNode){const R=(W=(L=n({nodeId:Z.id,type:"target"}).map(O=>t(O.source)).find(O=>(O==null?void 0:O.type)&&[b.JSONLData,b.CSVData].includes(O==null?void 0:O.type)))==null?void 0:L.data)==null?void 0:W.entity;if(!R)return;C.push(...await c(u(),{database:{databaseId:ee.id,dataSourceId:R.id,dataSourceType:it(R)}},g.humanMessage.content,_e)||[])}else C.push(...await c(u(),{database:{databaseId:ee.id}},g.humanMessage.content,_e)||[]);if(!C)return[];const V=new Ho({template:we.content,inputVariables:["context"]});k.push(new Sa(await V.format({context:ne?C.filter(([,R])=>R>=ne).map(([R])=>R.pageContent).join(`
`):C.map(([R])=>R.pageContent).join(`
`)})))}}})),k},[u,n,t,c]),x=d.useCallback(async(g,_,y,{onMessageUpdate:k})=>{var L;const{prompts:D,tools:w,schemas:E,placeholders:v,llm:j}=_,$=(L=j==null?void 0:j.node.data)==null?void 0:L.entity;if(!$)throw new Error("LLM is not found");const B=[];v!=null&&v.length&&B.push(...await h(g,_));const{history:U,systems:M}=ti(y,D),A=[...M,...B,...U,new Ke(g.humanMessage.content)],P=E.map(W=>{var Z;return(Z=W.node.data)==null?void 0:Z.entity}).filter(Boolean),S=await m($.provider,A,{tools:si(w),schemas:P,llm:$,onMessageUpdate:({content:W})=>{k==null||k({id:g.aiMessageNode.id,nodeData:{loading:!0,content:W}})}});return g.aiMessage.content=(S==null?void 0:S.content)||"",g.aiMessage.metadata=JSON.stringify({message:S==null?void 0:S.lastChunk}),k==null||k({id:g.aiMessageNode.id,nodeData:{content:S==null?void 0:S.content,loading:!1,entity:g.aiMessage}}),g.aiMessage.id&&await I("Message").update(g.aiMessage.id,{content:S==null?void 0:S.content,metadata:JSON.stringify({message:S==null?void 0:S.lastChunk})}),S==null?void 0:S.content},[h,m]),f=d.useCallback(async(g,_,y)=>{var j,$,B;const{nodes:k}=cs([g.id],[],[],[],{getNode:t,getHandleConnections:n}),D=k.find(U=>U.type===b.Thread),w=D==null?void 0:D.data.entity;if(!g||!w||!D)throw new Error("Source or thread is not found");const E=us(D,{getNode:t,getHandleConnections:n});if(!(E!=null&&E.thread))throw new Error("Thread node is not found");let v;try{s(!0);const U=((j=g.position)==null?void 0:j.x)||0,M=((($=g.position)==null?void 0:$.y)||0)+(((B=g.measured)==null?void 0:B.height)||0);return v=await p({content:_,initialX:U,initialY:M,sourceId:g.id,threadId:w.id,initialLLMId:w.initial_llm_id}),await x(v,E,k,y),await I("Message").update(`${v.aiMessage.id}`,{status:be.Success}),v.aiMessage.status=be.Success,y.onMessageUpdate({id:v.aiMessageNode.id,nodeData:{entity:v.aiMessage,loading:!1}}),!0}catch(U){ga("Create Message",U),v!=null&&v.aiMessage&&await I("Message").update(`${v.aiMessage.id}`,{status:be.Failed,content:a("errors.ai_message_content_failed")}),v!=null&&v.aiMessageNode.id&&(y==null||y.onMessageUpdate({id:v.aiMessageNode.id,nodeData:{content:a("errors.ai_message_content_failed"),entity:{...v.aiMessage,status:be.Failed,content:a("errors.ai_message_content_failed")},loading:!1}}))}finally{s(!1)}},[n,t,p,x,a]);return{loading:r,createMessage:f}},ni=(t,n)=>{const a=oe(t),{t:r}=G("flows"),{getNode:s,getHandleConnections:o}=Ne(),i=T(h=>h.updateNodes),{createMessage:l,loading:c}=ps({getNode:s,getHandleConnections:o}),u=d.useCallback(h=>{if(!h.id)return;const x=s(h.id);!x||!h.nodeData||i([{id:x.id,type:"replace",item:{...x,data:{...x.data,...Ws(h.nodeData,qs)}}}])},[s,i]),m=d.useCallback(async h=>{if(a&&n.entity)try{await l(a,h,{onMessageUpdate:u})}catch(x){if(x instanceof Error&&x.message.includes("LLM_NOT_LOADED_YET"))return qe({variant:"destructive",title:r("thread_node.errors.llm_not_loaded_yet")});qe({variant:"destructive",title:`${x}`})}},[a,n.entity,l,u,r]),p=d.useCallback(h=>{const x=s(h);if(!x)return[];const f=[],g=us(x,{getNode:s,getHandleConnections:o});return g.thread&&f.push({node:g.thread.node,connectedNodes:[],connections:g.thread.connections}),g.prompts&&f.push(...g.prompts.map(_=>({node:_.node,connectedNodes:_.connectedNodes,connections:_.connections}))),g.schemas&&f.push(...g.schemas.map(_=>({node:_.node,connectedNodes:[],connections:_.connections}))),g.placeholders&&g.placeholders.forEach(_=>{const y=_.connections.map(k=>s(k.source)).filter(Boolean);f.push({node:_.node,connectedNodes:y||[],connections:_.connections})}),g.llm&&f.push(g.llm),f},[o,s]);return{loading:c,createMessage:m,getLinkedConnections:p}},ri=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.Prompt&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.LLM&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.Schema&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.ToolDefinition&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.VectorDatabase&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.PlaceHolder&&(o==null?void 0:o.type)===b.Thread&&s.data.entity.placeholder_type===ra.VECTOR_DATABASE_RETREIVER){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},ii=d.memo(t=>{const{id:n,data:a,isConnectable:r}=t,{t:s}=G("flows"),[o,i]=d.useState(!1),l=ya({type:"source"}),c=ya({type:"target"}),{getNode:u}=Ne(),{loading:m,createMessage:p,getLinkedConnections:h}=ni(n,a);ri(n);const x=d.useCallback(async(...y)=>(i(!1),await p(...y)),[p]),f=d.useMemo(()=>l.length>0,[l]),g=d.useCallback(()=>{i(y=>!y)},[]),_=d.useMemo(()=>{var k,D;const y=c.map((w,E)=>{var j;const v=u(w.source);if((v==null?void 0:v.type)===b.Schema)return e.jsx(Ue,{children:s("thread_node.structured_output")},`${E}`);if((v==null?void 0:v.type)===b.Prompt){const $=v.data.entity;return e.jsx(Ue,{children:s($.type===xe.FewShotExample?"thread_node.prompts.few_shot_example":`thread_node.prompts.${$.role.toLowerCase()}`)},`${E}`)}else if((v==null?void 0:v.type)===b.PlaceHolder&&((j=v.data.entity)==null?void 0:j.placeholder_type)===ra.VECTOR_DATABASE_RETREIVER)return e.jsx(Ue,{children:s("thread_node.vector_database_retriever")},`${E}`)}).filter(Boolean);return t.data.entity&&!((D=(k=t.data.entity)==null?void 0:k.messages)!=null&&D.length)&&!f?e.jsx(Xa,{disabled:m,loading:m,onSubmit:x,tags:y}):y!=null&&y.length?e.jsxs(se,{className:"p-4 pt-2",children:[e.jsx(he,{className:"mb-2",children:s("thread_node.title")}),e.jsx("div",{className:"flex gap-1.5",children:y}),e.jsx("div",{className:"mt-4 w-full flex justify-end",children:e.jsxs(Q,{onClick:g,variant:"outline",children:[e.jsx(H,{name:o?"copy-minus":"copy-plus"}),s(o?"thread_node.hide":"thread_node.clone")]})})]}):e.jsx("div",{className:"w-12 h-10"})},[f,u,x,g,m,t.data.entity,o,s,c]);return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n,enableToStandalone:!0,getLinkedConnections:h}),_,o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-[1px] absolute ml-[50%] h-[30px] bg-gray-500"}),e.jsx("div",{className:"absolute mt-[30px] w-full",children:e.jsx("div",{className:"ml-[10%] w-80 animate-in slide-in-from-bottom-5",children:e.jsx(Xa,{disabled:m,loading:m,onSubmit:x})})})]}):void 0]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})});function oi({data:t,onNewThread:n,loading:a,showThread:r}){var o;const{t:s}=G("flows");return e.jsxs(je,{className:"flex min-w-52",children:[e.jsx(H,{size:24,name:"user"}),e.jsxs("div",{className:"ml-2 max-w-full w-full",children:[e.jsx(Pe,{children:"Human"}),e.jsx(na,{children:`${t.content||((o=t.entity)==null?void 0:o.content)||""}`}),n?e.jsx("div",{className:"w-full mt-2 flex items-center justify-end",children:e.jsxs(Q,{onClick:n,disabled:a,variant:"outline",children:[e.jsx(H,{name:r?"minus":"plus",size:16}),s(r?"message_node.hide_thread":"message_node.new_thread")]})}):void 0]})]})}function di({data:t,onNewThread:n,loading:a,showThread:r}){var c,u,m,p,h,x,f,g,_;const{t:s}=G("flows"),o=d.useMemo(()=>{var y;try{return JSON.parse(((y=t==null?void 0:t.entity)==null?void 0:y.metadata)||"{}")}catch{return{}}},[(c=t==null?void 0:t.entity)==null?void 0:c.metadata]),i=t.entity.status===be.Failed,l=d.useMemo(()=>{var y;return e.jsx(zo,{source:`${t.content||((y=t.entity)==null?void 0:y.content)||""}`})},[t.content,(u=t.entity)==null?void 0:u.content]);return e.jsxs(je,{className:J("flex min-w-52",i?"bg-background":""),variant:i?"destructive":"default",children:[e.jsx(H,{className:J(t.loading?"animate-spin":void 0),size:24,name:t.loading?"loader-circle":"bot"}),e.jsx(H,{name:r?"minus":"plus",size:24}),e.jsxs("div",{className:"ml-2 w-full max-w-full",children:[e.jsx(Pe,{children:s(`message_node.message_roles.${(p=(m=t.entity)==null?void 0:m.role)==null?void 0:p.toLowerCase()}`)}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-ful rounded-lg flex justify-center items-center",children:e.jsx(H,{name:"loader-circle",className:"animate-spin"})}),children:i?t.content||((h=t.entity)==null?void 0:h.content)||"":l}),Array.isArray((x=o==null?void 0:o.message)==null?void 0:x.tool_calls)&&((g=(f=o==null?void 0:o.message)==null?void 0:f.tool_calls)!=null&&g.length)?(_=o==null?void 0:o.message)==null?void 0:_.tool_calls.map((y,k)=>e.jsx(Ue,{children:s("message_node.tool_call",{name:y.name,args:Object.entries(y.args).map(([D,w])=>`"${D}": "${w}"`).join(", ")})},`${y.name}_${k}`)):null,n?e.jsx("div",{className:"w-full mt-2 flex items-center justify-end",children:e.jsxs(Q,{onClick:n,disabled:a,variant:"outline",children:[e.jsx(H,{name:r?"minus":"plus",size:16}),s(r?"message_node.hide_thread":"message_node.new_thread")]})}):void 0]}),t.loading?e.jsx(Us,{size:350,duration:10}):void 0]})}const li=t=>{const{t:n}=G("flows"),a=oe(t),r=T(m=>m.updateNodes),{getNode:s,getHandleConnections:o}=Ne(),{createMessage:i,loading:l}=ps({getNode:s,getHandleConnections:o}),c=d.useCallback(m=>{if(!m.id)return;const p=s(m.id);!p||!m.nodeData||r([{id:p.id,type:"replace",item:{...p,data:{...p.data,...Ws(m.nodeData,qs)}}}])},[s,r]),u=d.useCallback(async m=>{if(a)try{await i(a,m,{onMessageUpdate:c})}catch(p){if(p instanceof Error&&p.message.includes("LLM_NOT_LOADED_YET"))return qe({variant:"destructive",title:n("message_node.errors.llm_not_loaded_yet")});qe({variant:"destructive",title:n("message_node.errors.create_message")})}},[a,n,i,c]);return{loading:l,createMessage:u}},hs=()=>{const t=ae(r=>r.currentSession),n=T(r=>r.createOrUpdateFlowNode),a=T(r=>r.createOrUpdateFlowEdge);return{createIdieMessage:d.useCallback(async(r,s,o,i)=>{var f,g,_,y,k;if(!r||!s||!t)return;const l=(g=(f=i==null?void 0:i.promptNode)==null?void 0:f.data)==null?void 0:g.entity,c=((_=r.position)==null?void 0:_.x)||0,u=(((y=r.position)==null?void 0:y.y)||0)+(((k=r.measured)==null?void 0:k.height)||0),m=await I("Message").save({thread_id:s.id,content:o,role:(l==null?void 0:l.role)||ge.Human,status:be.Started,llm_id:s.initial_llm_id,session_id:t.id});if(!m)throw new Error("Failed to save message");const p=await n({source_id:m.id,source_type:"Message",node_type:b.Message,x:c,y:u});if(!p)throw new Error("Failed to save message node");const h=await a({source:r.id,target:p.id});let x;return i!=null&&i.promptNode&&(x=await a({source:i==null?void 0:i.promptNode.id,target:p.id})),{message:m,edgeToPrompt:x,messageNode:p,messageEdge:h}},[n,a])}},ci=t=>{const{createIdieMessage:n}=hs(),a=d.useCallback(async({edgeId:r,source:s,target:o})=>{var i,l;try{if((s==null?void 0:s.type)===b.Prompt&&(o==null?void 0:o.type)===b.Message){const c=(i=o==null?void 0:o.data)==null?void 0:i.entity,u=(l=s==null?void 0:s.data)==null?void 0:l.entity;if(!u||!c||!o)return{deleteEdgeId:r};await n(o,{id:c==null?void 0:c.thread_id,title:"",status:da.Started,initial_llm_id:c.llm_id,session_id:u.session_id},u.content,{promptNode:s});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},ui=d.memo(t=>{var D,w,E;const{id:n,data:a,isConnectable:r}=t,[s,o]=d.useState(!1),[i,l]=d.useState(!1),{t:c}=G("common"),u=ya({type:"source"}),{loading:m,createMessage:p}=li(n),{toast:h}=ye();ci(n);const x=d.useCallback(async(...v)=>{const j=await p(...v);return o(!1),j},[p]),f=d.useMemo(()=>u.length===0,[u]),g=d.useCallback(()=>{var v;(v=a.entity)!=null&&v.content&&(navigator.clipboard.writeText(a.entity.content),h({description:c("copied")}))},[h,a,c]),_=d.useCallback(async()=>{var v;try{if(i)return await Rs.stop(),l(!1);l(!0),await Rs.speak(((v=a.entity)==null?void 0:v.content)||"")}catch{h({variant:"destructive",description:c("errors.speech_is_not_supported")})}finally{l(!1)}},[(D=a.entity)==null?void 0:D.content,i,c,h]),y=d.useCallback(()=>{o(v=>!v)},[]),k=d.useMemo(()=>{var v;if(!(!f&&!s||a.loading||m||((v=a==null?void 0:a.entity)==null?void 0:v.status)==="inprogress"))return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-[1px] absolute ml-[50%] h-[30px] bg-gray-500"}),e.jsx("div",{className:"absolute mt-[30px] w-full",children:e.jsx("div",{className:"ml-[10%] w-80 animate-in slide-in-from-bottom-5",children:e.jsx(Xa,{disabled:m,loading:m,onSubmit:x})})})]})},[(w=a==null?void 0:a.entity)==null?void 0:w.status,a.loading,x,f,m,s]);return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{className:"max-w-sm min-w-64",children:[e.jsxs("div",{className:"w-auto",children:[e.jsx(me,{id:n}),e.jsx("div",{children:((E=a.entity)==null?void 0:E.role)===ge.Human?e.jsx(oi,{data:a,showThread:s,onNewThread:f?void 0:y}):e.jsx(di,{data:a,showThread:s,loading:m,onNewThread:f?void 0:y})}),e.jsx(Q,{onClick:_,className:"absolute top-0 right-[68px] !px-2 !rounded-none",variant:"ghost",children:e.jsx(H,{name:i?"circle-stop":"speech",size:16})}),e.jsx(Q,{onClick:g,className:"absolute top-0 right-[36px] !px-2 !rounded-none",variant:"ghost",children:e.jsx(H,{name:"copy",size:16})})]}),k]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),mi=t=>{const n=T(s=>s.createOrUpdateFlowEdge),{createIdieMessage:a}=hs(),r=d.useCallback(async({edgeId:s,source:o,target:i})=>{var l,c,u,m;try{const p=(l=i==null?void 0:i.data)==null?void 0:l.entity,h=(c=o==null?void 0:o.data)==null?void 0:c.entity;if((o==null?void 0:o.type)===b.Message&&(i==null?void 0:i.type)===b.Prompt){const x=(u=o==null?void 0:o.data)==null?void 0:u.entity,f=(m=i==null?void 0:i.data)==null?void 0:m.entity;if(!f||!x||!i)return{deleteEdgeId:s};await a(o,{id:x==null?void 0:x.thread_id,title:"",status:da.Started,initial_llm_id:x.llm_id,session_id:f.session_id},f.content,{promptNode:i});return}else if((o==null?void 0:o.type)===b.CSVData&&(i==null?void 0:i.type)===b.Prompt&&(p==null?void 0:p.type)===xe.FewShotExample&&(h!=null&&h.headers.includes("input"))&&(h!=null&&h.headers.includes("output"))){await n({source:o.id,target:i.id});return}return{deleteEdgeId:s}}catch{return{deleteEdgeId:s}}},[a,n]);pe(t,r)},pi=d.memo(t=>{var u,m,p;const{id:n,data:a,isConnectable:r}=t;mi(n);const s=Te(Bo),o=d.useMemo(()=>{var h,x,f;return`${(h=a.entity)!=null&&h.prefix?`${(x=a.entity)==null?void 0:x.prefix}
`:""}${((f=a.entity)==null?void 0:f.content)||""}`},[(u=a.entity)==null?void 0:u.prefix,(m=a.entity)==null?void 0:m.content]),i=d.useMemo(()=>{var x;const h=/{(.*?)}/g;return((x=o.match(h))==null?void 0:x.map(f=>f.replace("{","").replace("}","")))||[]},[o]),l=o.length>990,c=()=>{s.show({title:"Prompt",content:o})};return e.jsxs("div",{className:"min-w-56",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(je,{className:"flex justify-center max-w-72",variant:"default",children:[e.jsx(H,{size:24,name:"notepad-text"}),e.jsxs("div",{className:"ml-2 max-w-full break-words break-all",children:[e.jsx(Pe,{children:`${((p=a.entity)==null?void 0:p.role)||""}`}),e.jsxs(na,{onClick:l?c:void 0,children:[l?`${o.slice(0,990)}...`:o,l?e.jsx("span",{className:"float-right",children:e.jsx(H,{name:"chevron-right"})}):void 0]}),i!=null&&i.length?i.map((h,x)=>e.jsx(Ue,{className:"mt-2 mr-1",variant:"default",children:h},x)):void 0]})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),fs=t=>{const n=["Bytes","KB","MB","GB","TB"];if(t===void 0)return"Unknown size";if(t===0)return"0 Byte";const a=Math.floor(Math.log(t)/Math.log(1024));return`${Math.round(t/Math.pow(1024,a))} ${n[a]}`},hi=d.memo(()=>{const{t}=G("flows"),[n,a]=d.useState(),r=ia(h=>h.cachedLLMURLs),s=ae(h=>h.currentSession),[o,i]=d.useState(),[l,c]=d.useState(""),[,u]=d.useState();d.useEffect(()=>{ve(async()=>{const{functionCallingModelIds:h,prebuiltAppConfig:x}=await import("./index-CFeuNoUh.js").then(async f=>(await f.__tla,f));return{functionCallingModelIds:h,prebuiltAppConfig:x}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({functionCallingModelIds:h,prebuiltAppConfig:x})=>{a(r==null?void 0:r.map(f=>{const g=x.model_list.find(_=>f.includes(_.model));if(g)return{model_id:(g==null?void 0:g.model_id)||"",info:g,isFunctionCalling:h.includes((g==null?void 0:g.model_id)||"")}}))})},[r,s==null?void 0:s.id]);const m=d.useCallback(async()=>{navigator.storage.estimate().then(h=>{h&&c(t("session_info_node.used_bytes",{used:fs(h.usage),total:fs(h==null?void 0:h.quota)}))}),s!=null&&s.id&&(Promise.all([I("FlowNode").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("FlowEdge").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("Thread").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("Prompt").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("LLM").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("Schema").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("ToolDefinition").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("VectorDatabase").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("JSONLData").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("CSVData").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}})]).then(h=>{const x=h.reduce((f,g)=>g!=null&&g.updated_at&&(!f||new Date(g.updated_at)>f)?new Date(g.updated_at):f,s.updated_at?new Date(s.updated_at):void 0);i(x)}),Promise.all([I("FlowNode").count({where:{session_id:s==null?void 0:s.id}}),I("FlowEdge").count({where:{session_id:s==null?void 0:s.id}}),I("Thread").count({where:{session_id:s==null?void 0:s.id}}),I("Prompt").count({where:{session_id:s==null?void 0:s.id}}),I("LLM").count({where:{session_id:s==null?void 0:s.id}}),I("ToolDefinition").count({where:{session_id:s==null?void 0:s.id}}),I("Schema").count({where:{session_id:s==null?void 0:s.id}}),I("VectorDatabase").count({where:{session_id:s==null?void 0:s.id}}),I("JSONLData").count({where:{session_id:s==null?void 0:s.id}}),I("CSVData").count({where:{session_id:s==null?void 0:s.id}})]).then(([h,x,f,g,_,y,k,D,w,E])=>{u([{name:t("session_info_node.count_info.title"),nodes:h||0,edges:x||0,threads:f||0,prompts:g||0,llms:_||0,tools:y||0,schemas:k||0,vectorDatabases:D||0,jsonlDatas:w||0,csvDatas:E||0}])}))},[s==null?void 0:s.id,s==null?void 0:s.updated_at,t]),p=d.useCallback(()=>{m()},[m]);return d.useEffect(()=>{m()},[m]),e.jsxs(se,{className:"w-96",children:[e.jsxs(de,{children:[e.jsx(he,{children:t("session_info_node.title")}),e.jsx(Uo,{children:o||s!=null&&s.updated_at?ko(o||(s==null?void 0:s.updated_at)).fromNow():""})]}),e.jsxs(le,{className:"grid gap-4",children:[e.jsx("div",{className:"flex items-center space-x-4 rounded-md border p-4",children:e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:t("session_info_node.disk_size")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l})]})}),e.jsx("div",{className:"flex items-center space-x-4 rounded-md border p-4",children:e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"text-sm font-medium leading-none",children:[t("session_info_node.cached_llms"),e.jsx(Ue,{className:"ml-2",children:(n==null?void 0:n.length)||0})]}),n==null?void 0:n.map(h=>e.jsxs("div",{className:"text-sm text-muted-foreground gap-1",children:[h==null?void 0:h.model_id,e.jsx("div",{className:"max-w-full gap-1 flex flex-wrap mt-1",children:e.jsx(xa,{model:h==null?void 0:h.info,isFunctionCalling:(h==null?void 0:h.isFunctionCalling)||!1,isCached:!0,cloud:!1})})]},h==null?void 0:h.model_id))]})}),e.jsx("div",{})]}),e.jsx(Re,{children:e.jsxs(Q,{className:"w-full",onClick:p,children:[e.jsx(H,{size:24,name:"refresh-ccw"}),t("session_info_node.reload")]})})]})}),fi=t=>{const n=d.useCallback(async({edgeId:a})=>{try{return{deleteEdgeId:a}}catch{return{deleteEdgeId:a}}},[]);pe(t,n)},gi=d.memo(t=>{var c,u;const{t:n}=G("flows"),{id:a,data:r,isConnectable:s}=t,o=d.useRef(!1),i=oe(a),l=T(m=>m.updateNodes);return fi(a),d.useEffect(()=>{var p;const m=r==null?void 0:r.entity;!m||!i||o.current||(p=m==null?void 0:m.schema_items)!=null&&p.length||r.loaded||(o.current=!0,I("SchemaItem").find({where:{schema_id:m.id}}).then(h=>{l([{id:i.id,type:"replace",item:{...i,data:{...(i==null?void 0:i.data)||{},loaded:!0,entity:{...r.entity,schema_items:h}}}}])}).finally(()=>{o.current=!1}))},[r.entity,r.loaded,i,l]),e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(me,{id:a}),e.jsxs(Gs,{defaultValue:"account",className:"w-[400px]",children:[e.jsxs(Js,{className:"grid w-full grid-cols-2",children:[e.jsx(Ge,{value:"account",children:n("schema_node.typescript")}),e.jsx(Ge,{value:"password",children:n("schema_node.zod")})]}),e.jsx(Je,{value:"account",children:e.jsx(se,{className:"p-4",children:e.jsx("pre",{className:"overflow-hidden break-words whitespace-pre-wrap",children:Xd(((c=r==null?void 0:r.entity)==null?void 0:c.schema_items)||[])})})}),e.jsx(Je,{value:"password",children:e.jsx(se,{className:"p-4 max-w-full",children:e.jsx("pre",{className:"overflow-hidden break-words whitespace-pre-wrap",children:Zd(((u=r==null?void 0:r.entity)==null?void 0:u.schema_items)||[])})})})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:s})]})}),xi=d.memo(t=>{var o,i;const{id:n,data:a,isConnectable:r}=t,s=d.useMemo(()=>{if(!(a!=null&&a.entity))return{headers:[],rows:[]};const l=ot(a.entity.csv);return{headers:dt(a.entity.headers),rows:l.map(c=>dt(c))}},[a==null?void 0:a.entity]);return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(se,{className:"min-w-32 min-h-16 p-4",children:[e.jsx(de,{className:"!p-0",children:e.jsxs("div",{className:"pt-2 flex !flex-row",children:[e.jsx(H,{name:"file-spreadsheet",className:"mr-2"}),e.jsxs(q,{className:"!font-medium leading-none tracking-tight pr-8",children:[b.CSVData," ",(o=s==null?void 0:s.rows)!=null&&o.length?`(${((i=s==null?void 0:s.rows)==null?void 0:i.length)||0})`:""]})]})}),e.jsx(le,{className:"pb-0",children:e.jsx(st,{data:s.rows,headers:s.headers})})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),_i=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.Schema&&(o==null?void 0:o.type)===b.ToolDefinition){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},yi=d.memo(({id:t,data:n,isConnectable:a})=>{var r,s;return _i(t),e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:a}),e.jsx("div",{children:e.jsxs(je,{className:"flex justify-center",children:[e.jsx(H,{size:24,name:"wrench"}),e.jsxs("div",{className:"ml-2",children:[e.jsx(Pe,{children:`${((r=n.entity)==null?void 0:r.name)||""}`}),e.jsx(na,{children:`${((s=n.entity)==null?void 0:s.description)||""}`})]})]})}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:a})]})}),vi=d.memo(t=>{var p,h;const[n,a]=d.useState(!1),[r,s]=d.useState({}),[o,i]=d.useState({}),{confirmPassphrase:l}=cn(),{t:c}=G("atoms"),u=async()=>{var x;if(n)s({}),i({});else{if((x=Object.keys(t.encrypted||{}))!=null&&x.length){await l();const f={},g=await Ca.get("passphrase");if(!g)throw new Error("Passphrase is not found");await Promise.all(Object.keys(t.encrypted||{}).map(async _=>{var y,k;(y=t.encrypted)!=null&&y[_]&&(f[_]=await Yd((k=t.encrypted)==null?void 0:k[_],g))})),i(f||{})}s({...t.options})}a(!n)},m=()=>{var x;(x=t.onChangeOptions)==null||x.call(t,r||{},o||{}),a(!1)};return e.jsx("div",{className:J("min-w-20 flex justify-end",t.className),children:e.jsxs(ut,{open:n,onOpenChange:a,children:[e.jsx(al,{children:e.jsx("div",{className:"flex justify-end gap-2 !cursor-pointer",children:e.jsxs(Q,{onClick:u,variant:"link",className:"flex items-center px-0 !cursor-pointer",children:[e.jsx(H,{name:"settings"}),e.jsx(q,{children:c("embedding_setting.title")})]})})}),e.jsx(mt,{className:"w-full p-0",children:n?e.jsxs(se,{className:"!border-none max-w-96 min-w-56",children:[e.jsx(de,{children:e.jsx(he,{children:c("embedding_setting.title")})}),e.jsxs(le,{children:[e.jsxs(q,{children:[c("embedding_setting.provider"),":"]}),e.jsxs(Le,{value:r!=null&&r.provider?`${r==null?void 0:r.provider}`:"local_transformers",onValueChange:x=>s({provider:x}),children:[e.jsx(De,{className:"",children:e.jsx(Ie,{placeholder:c("embedding_setting.provider_placeholder")})}),e.jsxs(Ae,{children:[e.jsx(fe,{value:"local_transformers",children:c("embedding_setting.providers.local_transformers")},"local_transformers"),(p=t.supportedProviders)==null?void 0:p.map(x=>e.jsx(fe,{value:x,children:c(`embedding_setting.providers.${x.toLowerCase()}`)},x))]})]}),(h=t.supportedProviders)!=null&&h.length?void 0:e.jsx(q,{className:"text-red-500 !pt-2",children:c("embedding_setting.alerts.no_provider")}),e.jsx(e.Fragment,{children:r.provider&&r.provider!=="local_transformers"?e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"destructive",className:"mt-4",children:c("embedding_setting.alerts.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(q,{children:c("embedding_setting.encrypted_fields.api_key")}),e.jsx(Q,{variant:"link",className:"px-1",children:e.jsxs("a",{href:r.provider===z.OpenAI?ma:ua,target:"_blank",rel:"noreferrer",children:["(",r.provider===z.OpenAI?ma:ua,")"]})}),e.jsx(re,{type:"password",value:o!=null&&o.key?`${o==null?void 0:o.key}`:"",onChange:x=>i(f=>({...f,key:x.target.value}))})]})]}):void 0})]}),e.jsx(Re,{className:"flex justify-end",children:e.jsx(Q,{variant:"secondary",onClick:m,children:c("embedding_setting.save")})})]}):void 0})]})})}),wi=t=>{const n=d.useCallback(async({edgeId:a})=>({deleteEdgeId:a}),[]);pe(t,n)},ji=t=>{const n=ae(l=>{var c;return(c=l.currentSession)==null?void 0:c.id}),a=oe(t),r=Ks(),s=T(l=>l.updateNodes),{confirmOrCreatePassphrase:o}=ns(),i=d.useCallback(async(l,c)=>{var u;if(a&&n){let m=t!==va.DEFAULT_EMBEDDING_MODEL?await I("FlowNode").findOne({where:{id:t}}):void 0;const p={};if((u=Object.keys(c||{}))!=null&&u.length){await o();const f=await Ca.get("passphrase");if(!f)throw new Error("Passphrase is not found");await Promise.all(Object.keys(c||{}).map(async g=>{c!=null&&c[g]&&(p[g]=await ln(c[g],f))}))}let h;const x=[];m?(await I("FlowNodePlaceholder").update(m.source_id,{encrypted:p,data:l}),h=await I("FlowNodePlaceholder").findOne({where:{id:m.source_id}}),x.push({id:m.id,type:"replace",item:a})):(x.push({id:t,type:"remove"}),h=await I("FlowNodePlaceholder").save({placeholder_type:ra.DEFAULT_EMBEDDING_MODEL,encrypted:p,data:l,session_id:n}),m=await I("FlowNode").save({node_type:b.DefaultEmbeddingModel,session_id:n,source_type:"FlowNodePlaceholder",source_id:h.id,x:a.position.x,y:a.position.y}),x.push({type:"add",item:a})),a.data.entity=h,a.data.flowNode=m,s(x)}},[o,n,t,a,s]);return d.useEffect(()=>{t===va.DEFAULT_EMBEDDING_MODEL&&r.find(l=>l.type===b.DefaultEmbeddingModel&&l.id!==va.DEFAULT_EMBEDDING_MODEL)&&s([{id:t,type:"remove"}])},[t,r,s]),{changeLLMOptions:i}},bi=d.memo(t=>{var l,c,u,m;const{id:n,data:a,isConnectable:r}=t,{changeLLMOptions:s}=ji(n);wi(n);let o="brain",i=Vd;switch(`${(c=(l=a==null?void 0:a.entity)==null?void 0:l.data)==null?void 0:c.provider}`){case z.OpenAI:o="gpt",i="text-embedding-3-small";break;case z.GoogleGenerativeAI:o="gemma",i="text-embedding-004";break}return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsx("div",{children:e.jsxs(je,{className:"flex justify-center max-w-auto",variant:"default",children:[e.jsx(Ve,{name:o,className:"w-7 h-7"}),e.jsxs("div",{className:"ml-2 pr-4 flex justify-center gap-1 flex-col",children:[e.jsx("div",{className:"min-h-8 flex items-center",children:e.jsx(Pe,{children:`${i||""}`})}),e.jsx(vi,{supportedProviders:[z.OpenAI,z.GoogleGenerativeAI],onChangeOptions:s,encrypted:(u=a.entity)==null?void 0:u.encrypted,options:(m=a.entity)==null?void 0:m.data})]})]})}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),Ni=`Use the following pieces of context to answer the question at the end.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
Use three sentences maximum and keep the answer as concise as possible.

{context}
`,Ci=fa(t=>{const{source:n,documents:a}=t,r=Te(),{toast:s}=ye(),{t:o}=G("dialogs"),{loading:i,createPrompt:l}=rs(),c=async u=>{try{if(!u.content||!u.content.includes("{context}")){s({title:o("create_vector_database_prompt.errors.fill_context"),variant:"destructive"});return}const m=u.content.replace("{context}",a.map(p=>`<document>${p.pageContent}</document>`).join(`
`));return await l(n,{...u,content:m}),r.hide(),!0}catch{s({title:o("create_vector_database_prompt.errors.create_failed"),variant:"destructive"})}};return e.jsx(wa,{open:r.visible,onOpenChange:r.hide,children:e.jsxs(ja,{className:"sm:max-w-[425px]",children:[e.jsx(ba,{children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"file",className:"mr-2 h-4 w-4"}),e.jsx(Na,{children:o("create_vector_database_prompt.title")})]})}),e.jsxs("div",{className:"flex gap-4 py-4 flex-col",children:[e.jsx(Ka,{onSubmit:c,loading:i,hidePromptType:!0,defaultPromptRole:"system",defaultPromptContent:Ni}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm items-center",children:[e.jsx(H,{name:"info",className:"mr-2",size:14}),o("create_vector_database_prompt.fill_content_note")]})]})]})})}),Si=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async({prompt:i,source:l,metadata:c})=>{var u,m,p,h;try{const x=(u=l==null?void 0:l.data)==null?void 0:u.entity;if(!x||!t)throw new Error("Source or Session not found");a(!0);const f=((m=l.position)==null?void 0:m.x)||0,g=(((p=l.position)==null?void 0:p.y)||0)+(((h=l.measured)==null?void 0:h.height)||0),_=await I("Prompt").save({...i,status:(i==null?void 0:i.status)||be.Started,role:(i==null?void 0:i.role)||ge.System,type:(i==null?void 0:i.type)||xe.Chat,content:(i==null?void 0:i.content)||"{context}",session_id:t});if(!_)throw new Error("Failed to save prompt");const y=await r({source_id:_.id,source_type:"Prompt",node_type:b.Prompt,x:f,y:g+20});if(!y)throw new Error("Failed to save prompt node");const k=await I("FlowNodePlaceholder").save({placeholder:`Retriever for ${x.name}`,placeholder_type:ra.VECTOR_DATABASE_RETREIVER,session_id:t,metadata:c});if(!k)throw new Error("Failed to save node placeholder");const D=await r({source_id:k.id,source_type:"FlowNodePlaceholder",node_type:b.PlaceHolder,x:f,y:g+40});if(!D)throw new Error("Failed to save node placeholder node");await s({source:y.id,target:D.id}),await s({source:l.id,target:D.id})}finally{a(!1)}},[t,r,s]);return{loading:n,createVectorDatabaseRetriever:o}},Ei=`Use the following pieces of context to answer the question at the end.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}
`,ki=fa(t=>{const{source:n}=t,a=Te(),{toast:r}=ye(),{t:s}=G("dialogs"),[o,i]=d.useState(1),[l,c]=d.useState(void 0),{loading:u,createVectorDatabaseRetriever:m}=Si(),p=async f=>{try{const g=f.content;if(!g||!g.includes("{context}")){r({title:s("create_vector_database_retriever.errors.fill_context"),variant:"destructive"});return}return await m({source:n,prompt:{content:g},metadata:{k:o,minimalScore:l}}),i(1),c(void 0),a.hide(),!0}catch{r({title:s("create_vector_database_retriever.errors.create_failed"),variant:"destructive"})}},h=f=>{i(f.target.value?Number(f.target.value):void 0)},x=f=>{c(f.target.value?Number(f.target.value):void 0)};return e.jsx(wa,{open:a.visible,onOpenChange:a.hide,children:e.jsxs(ja,{className:"sm:max-w-[425px]",children:[e.jsx(ba,{children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"file",className:"mr-2 h-4 w-4"}),e.jsx(Na,{children:s("create_vector_database_retriever.title")})]})}),e.jsxs("div",{className:"flex gap-4 py-4 flex-col",children:[e.jsx(Ka,{onSubmit:p,loading:u,hidePromptType:!0,defaultPromptRole:"system",defaultPromptContent:Ei}),e.jsxs(se,{children:[e.jsx(de,{children:e.jsx(he,{children:s("create_vector_database_retriever.retriever_settings")})}),e.jsxs(le,{children:[e.jsx(q,{children:s("create_vector_database_retriever.retriever_k")}),e.jsx(re,{value:o||"",type:"number",onChange:h,placeholder:s("create_vector_database_retriever.retriever_k_placeholder")}),e.jsx(q,{children:s("create_vector_database_retriever.retriever_minimum_score")}),e.jsx(re,{value:l||"",type:"number",onChange:x,placeholder:s("create_vector_database_retriever.retriever_minimum_score_placeholder")})]})]}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm items-center",children:[e.jsx(H,{name:"info",className:"mr-2",size:14}),s("create_vector_database_retriever.fill_content_note")]})]})]})})}),Mi=t=>{const n=T(o=>o.createOrUpdateFlowEdge),{getFlowEmbeddingEntity:a}=Za(),{index:r}=tt(),s=d.useCallback(async({edgeId:o,target:i,source:l})=>{var c,u;try{const m=(c=i==null?void 0:i.data)==null?void 0:c.entity;if((l==null?void 0:l.type)===b.CSVData&&(i==null?void 0:i.type)===b.VectorDatabase){const p=(u=l==null?void 0:l.data)==null?void 0:u.entity;if(!p||!m)return{deleteEdgeId:o};const{rows:h}=an(p.headers,p.csv),x=h.map(f=>new sn({pageContent:`${f.text}`}));await r(a(),{database:{databaseId:m.id,dataSourceId:p.id,dataSourceType:"CSVData"}},x),await n({source:l.id,target:i.id});return}return{deleteEdgeId:o}}catch{return{deleteEdgeId:o}}},[n,a,r]);pe(t,s)},Li=t=>{const[n,a]=d.useState(!1),{t:r}=G("flows"),{toast:s}=ye(),{getNode:o,getHandleConnections:i}=Ne(),l=T(x=>x.updateNodes),{getFlowEmbeddingEntity:c}=Za(),{index:u,similaritySearchWithScore:m}=tt(),p=d.useCallback(async(x,f)=>{var g,_,y;try{const k=o(t);if(!k)return;const D=(g=k.data)==null?void 0:g.entity;if(!D){s({variant:"destructive",title:r("vector_database_node.errors.vector_database_not_found")});return}const w=c();if(D.storage===$e.DataNode){const E=(y=(_=i({nodeId:t,type:"target"}).map(v=>o(v.source)).find(v=>(v==null?void 0:v.type)&&[b.JSONLData,b.CSVData].includes(v==null?void 0:v.type)))==null?void 0:_.data)==null?void 0:y.entity;if(!E){s({variant:"destructive",title:r("vector_database_node.errors.data_node_not_found")});return}return a(!0),await m(w,{database:{databaseId:D.id,dataSourceId:E.id,dataSourceType:it(E)}},x,f==null?void 0:f.k)}else return a(!0),await m(w,{database:{databaseId:D.id}},x,f==null?void 0:f.k)}catch{s({variant:"destructive",title:r("vector_database_node.errors.similarity_search_failed")})}finally{a(!1)}},[o,t,c,s,r,i,m]),h=d.useCallback(async(x,f)=>{var g,_,y,k;try{const D=o(t);if(!D)return;a(!0);const w=x.content?[new sn({pageContent:x.content,id:x.id,metadata:{id:x.id}})]:x.documents;if(!(w!=null&&w.length)){s({variant:"destructive",title:r("vector_database_node.errors.content_not_found")});return}const E=(g=D.data)==null?void 0:g.entity;if(!E||!D){s({variant:"destructive",title:r("vector_database_node.errors.vector_database_not_found")});return}const v=c();if(E.storage===$e.DataNode){const j=i({nodeId:t,type:"target"}).map(A=>o(A.source)).find(A=>(A==null?void 0:A.type)&&[b.JSONLData,b.CSVData].includes(A==null?void 0:A.type)),$=(_=j==null?void 0:j.data)==null?void 0:_.entity;if(!$){s({variant:"destructive",title:r("vector_database_node.errors.data_node_not_found")});return}const B=it($),U=Xs(w,10);let M=0;for(const A of U){if((y=f==null?void 0:f.onProgressReport)==null||y.call(f,{handling:A.length,handled:M,total:w.length}),await u(v,{database:{databaseId:E.id,dataSourceId:$.id,dataSourceType:B}},A),B&&j){const P=await I(B).findOne({where:{id:$.id}});l([{type:"replace",id:j.id,item:{...j,data:{...j.data,entity:P}}}])}M+=A.length}}else{const j=Xs(w,10);let $=0;for(const B of j){(k=f==null?void 0:f.onProgressReport)==null||k.call(f,{handling:B.length,handled:$,total:w.length}),await u(v,{database:{databaseId:E.id}},B);const U=await I("VectorDatabase").findOne({where:{id:`${E.id}`}});l([{type:"replace",id:D.id,item:{...D,data:{...D.data,entity:U}}}]),$+=B.length}}}catch{s({variant:"destructive",title:r("vector_database_node.errors.similarity_search_failed")})}finally{a(!1)}},[o,t,c,s,r,i,u,l]);return{loading:n,indexData:h,similaritySearchWithScore:p}},Di=d.memo(t=>{var v,j,$,B;const{t:n}=G("flows"),[a,r]=d.useState(0),[s,o]=d.useState("search"),i=oe(t.id),{id:l,data:c,isConnectable:u}=t,{loading:m,similaritySearchWithScore:p,indexData:h}=Li(l),x=Te(Ci),f=Te(ki);Mi(l);const g=d.useCallback(async(...U)=>{i&&await h(...U)},[h,i]),_=d.useCallback(async(U,M)=>{const A=U.trim(),P=await p(A,{k:M});if(P!=null&&P.length)return P},[p]),y=d.useCallback(U=>{x.show({source:i,documents:U.map(([M])=>M)})},[x,i]),k=d.useCallback(async()=>{f.show({source:i})},[f,i]),D=d.useCallback(async U=>{if(U.type.includes("text")||U.type.includes("txt")){const M=new FileReader;M.onload=async A=>{var S;const P=(S=A.target)==null?void 0:S.result;await g({content:P})},M.readAsText(U)}else if(U.type.endsWith("pdf")){const M=new Blob([U],{type:"application/pdf"}),A=await new Wo(M,{pdfjs:async()=>{const P=await ve(()=>import("./pdf.min-DG-tGUe3.js").then(async S=>(await S.__tla,S)),__vite__mapDeps([8,2,3,1,4,5,6]));return await ve(()=>import("./pdf.worker.min-DXTiFl-L.js").then(async S=>(await S.__tla,S)),__vite__mapDeps([9,1,2,3,4,5,6])),P.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),P},parsedItemSeparator:" "}).load();await g({documents:A},{onProgressReport:P=>{r((P.handled+P.handling)/P.total)}})}},[g]),w=d.useMemo(()=>{var A,P;if(!((A=c==null?void 0:c.entity)!=null&&A.raw))return{headers:[],rows:[]};const U=["content","embedding","metadata"],M=ot((P=c==null?void 0:c.entity)==null?void 0:P.raw);return{headers:U,rows:M.map(S=>{try{return JSON.parse(S)}catch{return[]}})}},[(v=c==null?void 0:c.entity)==null?void 0:v.raw]),E=d.useMemo(()=>{switch(s){case"search":return e.jsx(Je,{value:"search",children:e.jsx(Jo,{loading:m,onSimilaritySearch:_,onCreatePrompt:y,onCreateRetriever:k})});case"new":return e.jsx(Je,{className:"min-w-80",value:"new",children:e.jsx(Go,{loading:m,onCreateData:g})});case"file":return e.jsx(Je,{value:"file",children:e.jsx(qo,{loading:m,progress:a,onFileSubmit:D,fileOptions:{accept:".pdf,.txt,.text",maxSize:15}})});case"view":return e.jsx(Je,{value:"view",children:e.jsx(st,{data:w.rows,headers:w.headers,limitLengthByColumns:{embedding:32}})})}},[g,y,k,D,_,m,s,a,w]);return e.jsxs("div",{className:"min-w-72",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:u}),e.jsxs("div",{className:"max-w-full",children:[e.jsx(me,{id:l}),e.jsxs(je,{className:"flex justify-center",variant:"default",children:[e.jsx(H,{size:24,name:"database-zap"}),e.jsxs("div",{className:"ml-2 max-w-full",children:[e.jsx(Pe,{children:`${((j=c.entity)==null?void 0:j.name)||""}`}),e.jsxs(Gs,{value:s,onValueChange:o,defaultValue:"search",className:J("w-full mt-4"),children:[e.jsxs(Js,{className:J("grid w-full grid-cols-3",(($=c.entity)==null?void 0:$.storage)===$e.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[e.jsx(Ge,{value:"search",children:n("vector_database_node.search")}),e.jsx(Ge,{value:"new",children:n("vector_database_node.text")}),e.jsx(Ge,{value:"file",children:n("vector_database_node.file")}),((B=c.entity)==null?void 0:B.storage)===$e.DatabaseNode?e.jsx(Ge,{value:"view",children:n("vector_database_node.view")}):void 0]}),E]})]})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:u})]})}),Ii={embedding:32},Ai=d.memo(t=>{var o,i,l;const{id:n,data:a,isConnectable:r}=t,s=d.useMemo(()=>{var m;if(!((m=a==null?void 0:a.entity)!=null&&m.jsonl))return{headers:[],rows:[]};const c=dt(a.entity.headers||""),u=ot(a.entity.jsonl);return{headers:c,rows:u.map(p=>{try{return JSON.parse(p)}catch{return[]}})}},[(o=a==null?void 0:a.entity)==null?void 0:o.jsonl,a.entity.headers]);return e.jsxs("div",{className:"min-w-80",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(se,{className:"min-w-32 min-h-16 p-4",children:[e.jsx(de,{className:"!p-0",children:e.jsxs("div",{className:"pt-2 flex !flex-row",children:[e.jsx(H,{name:"file-json",className:"mr-2"}),e.jsxs(q,{className:"!font-medium leading-none tracking-tight pr-8",children:[b.JSONLData," ",(i=s==null?void 0:s.rows)!=null&&i.length?`(${((l=s==null?void 0:s.rows)==null?void 0:l.length)||0})`:""]})]})}),e.jsx(le,{className:"pb-0",children:e.jsx(st,{data:s.rows,headers:s.headers,limitLengthByColumns:Ii})})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),gs=60,xs=140,Oi=$s("supports-backdrop-blur:bg-white/10 supports-backdrop-blur:dark:bg-black/10 mx-auto flex h-[58px] w-max gap-2 rounded-lg border p-2 backdrop-blur-md"),_s=sa.forwardRef(({className:t,children:n,magnification:a=gs,distance:r=xs,direction:s="bottom",...o},i)=>{const l=ka(1/0),c=()=>sa.Children.map(n,u=>sa.isValidElement(u)&&u.type===pa?sa.cloneElement(u,{...u.props,mouseX:l,magnification:a,distance:r}):u);return e.jsx(Ps.div,{ref:i,onMouseMove:u=>l.set(u.pageX),onMouseLeave:()=>l.set(1/0),...o,className:J(Oi({className:t}),{"items-start":s==="top","items-center":s==="middle","items-end":s==="bottom"}),children:c()})});_s.displayName="Dock";const pa=({magnification:t=gs,distance:n=xs,mouseX:a,className:r,children:s,...o})=>{const i=d.useRef(null),l=ht(a||new Mo,m=>{var h;const p=((h=i.current)==null?void 0:h.getBoundingClientRect())??{x:0,width:0};return m-p.x-p.width/2}),c=ht(l,[-n,0,n],[40,t,40]),u=wn(c,{mass:.1,stiffness:150,damping:12});return e.jsx(Ps.div,{ref:i,style:{width:u},className:J("flex aspect-square cursor-pointer items-center justify-center rounded-full",r),...o,children:s})};pa.displayName="DockIcon";const Fi=t=>d.createElement("svg",{viewBox:"0 0 256 254",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",width:256,height:254,preserveAspectRatio:"xMidYMid",...t},d.createElement("defs",null,d.createElement("linearGradient",{id:"c",x1:"50%",x2:"50%",y1:"0%",y2:"100%"},d.createElement("stop",{offset:"0%",stopColor:"#FFF"}),d.createElement("stop",{offset:"100%",stopColor:"#FFF",stopOpacity:0})),d.createElement("path",{id:"a",d:"M180.828 252.605a15.872 15.872 0 0 0 12.65-.486l52.501-25.262a15.94 15.94 0 0 0 9.025-14.364V41.197a15.939 15.939 0 0 0-9.025-14.363l-52.5-25.263a15.877 15.877 0 0 0-18.115 3.084L74.857 96.35l-43.78-33.232a10.614 10.614 0 0 0-13.56.603L3.476 76.494c-4.63 4.211-4.635 11.495-.012 15.713l37.967 34.638-37.967 34.637c-4.623 4.219-4.618 11.502.012 15.714l14.041 12.772a10.614 10.614 0 0 0 13.56.604l43.78-33.233 100.507 91.695a15.853 15.853 0 0 0 5.464 3.571Zm10.464-183.649-76.262 57.889 76.262 57.888V68.956Z"})),d.createElement("mask",{id:"b",fill:"#fff"},d.createElement("use",{xlinkHref:"#a"})),d.createElement("path",{fill:"#0065A9",d:"M246.135 26.873 193.593 1.575a15.885 15.885 0 0 0-18.123 3.08L3.466 161.482c-4.626 4.219-4.62 11.502.012 15.714l14.05 12.772a10.625 10.625 0 0 0 13.569.604L238.229 33.436c6.949-5.271 16.93-.315 16.93 8.407v-.61a15.938 15.938 0 0 0-9.024-14.36Z"}),d.createElement("path",{fill:"#007ACC",d:"m246.135 226.816-52.542 25.298a15.887 15.887 0 0 1-18.123-3.08L3.466 92.207c-4.626-4.218-4.62-11.502.012-15.713l14.05-12.773a10.625 10.625 0 0 1 13.569-.603l207.132 157.135c6.949 5.271 16.93.315 16.93-8.408v.611a15.939 15.939 0 0 1-9.024 14.36Z"}),d.createElement("path",{fill:"#1F9CF0",d:"M193.428 252.134a15.892 15.892 0 0 1-18.125-3.083c5.881 5.88 15.938 1.715 15.938-6.603V11.273c0-8.318-10.057-12.483-15.938-6.602a15.892 15.892 0 0 1 18.125-3.084l52.533 25.263a15.937 15.937 0 0 1 9.03 14.363V212.51c0 6.125-3.51 11.709-9.03 14.363l-52.533 25.262Z"}),d.createElement("path",{fill:"url(#c)",fillOpacity:.25,d:"M180.828 252.605a15.874 15.874 0 0 0 12.65-.486l52.5-25.263a15.938 15.938 0 0 0 9.026-14.363V41.197a15.939 15.939 0 0 0-9.025-14.363L193.477 1.57a15.877 15.877 0 0 0-18.114 3.084L74.857 96.35l-43.78-33.232a10.614 10.614 0 0 0-13.56.603L3.476 76.494c-4.63 4.211-4.635 11.495-.012 15.713l37.967 34.638-37.967 34.637c-4.623 4.219-4.618 11.502.012 15.714l14.041 12.772a10.614 10.614 0 0 0 13.56.604l43.78-33.233 100.506 91.695a15.857 15.857 0 0 0 5.465 3.571Zm10.464-183.65-76.262 57.89 76.262 57.888V68.956Z"})),Ti="/NoLLMChat/assets/plate-editor-C1jTW62C.png",Ri={[b.Shape]:{width:100,height:100},[b.CircleShape]:{width:100,height:100},[b.TriangleShape]:{width:100,height:100},[b.EditorApp]:{width:1240,height:400}},Pi=t=>{const n=oe(t),a=ae(l=>l.currentSession),[r,s]=d.useState(!1),o=T(l=>l.createOrUpdateFlowNode),i=d.useCallback(async l=>{var c,u,m;try{if(s(!0),n&&(a==null?void 0:a.id)){const p=((c=n.position)==null?void 0:c.x)||0,h=(((u=n.position)==null?void 0:u.y)||0)+(((m=n.measured)==null?void 0:m.height)||0),x=await I("FlowNodeData").save({data:{},session_id:a.id});if(!x)throw new Error("Failed to save node data");if(!await o({node_type:l,data:{},source_id:x.id,source_type:"FlowNodeData",x:p,y:h+20,...Ri[l]||{}}))throw new Error("Failed to save node")}}finally{s(!1)}},[o,a==null?void 0:a.id,n]);return{loading:r,createNode:i}},ys={applications:[{key:b.EditorApp,image:Ti,label:"application_bar.editor"},{key:b.VSLiteApp,icon:Fi,label:"application_bar.vslite"}],shapes:[{key:b.Shape,icon:"square",label:"application_bar.square"},{key:b.CircleShape,icon:"circle",label:"application_bar.circle"},{key:b.TriangleShape,icon:"triangle",label:"application_bar.triangle"}]},$i=d.memo(t=>{const{t:n}=G("flows"),{toast:a}=ye(),{loading:r,createNode:s}=Pi(t.id),o=async i=>{try{if(r)return;await s(i)}catch{a({description:n("application_bar.errors.add_node_failed"),variant:"destructive"})}};return e.jsx(Hd,{children:e.jsxs(_s,{direction:"middle",children:[ys.applications.map(i=>{const l=i.icon;return e.jsx(pa,{children:e.jsxs(nn,{children:[e.jsxs(rn,{children:[l?e.jsx(l,{width:20,height:20,onClick:()=>o(i.key)}):void 0,i.image?e.jsx("img",{src:i.image,alt:n(i.label),className:"w-8 h-8 rounded-md",onClick:()=>o(i.key)}):void 0]}),e.jsx(on,{children:e.jsx("p",{children:n(i.label)})})]})},i.label)}),e.jsx(zd,{orientation:"vertical",className:"h-full"}),ys.shapes.map(i=>e.jsx(pa,{children:e.jsxs(nn,{children:[e.jsx(rn,{children:e.jsx(H,{onClick:()=>o(i.key),name:i.icon})}),e.jsx(on,{children:e.jsx("p",{children:n(i.label)})})]})},i.label))]})})}),ha=d.memo(t=>{const{lineClassName:n,handleClassName:a,...r}=t;return e.jsx(Ko,{lineClassName:J("!border-1.5",n),handleClassName:J("!w-2 !h-2 !border-2 !rounded-full",a),...r})}),Vi=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([b.CircleShape,b.TriangleShape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===b.Shape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Hi=d.memo(t=>{const{id:n,selected:a,isConnectable:r}=t;return Vi(n),e.jsxs(e.Fragment,{children:[e.jsx(ha,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsx("div",{className:"min-w-10 min-h-10 w-full h-full bg-border border",children:e.jsx(me,{id:n})}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:r})]})}),zi=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([b.Shape,b.TriangleShape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===b.CircleShape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Bi=d.memo(t=>{const{id:n,selected:a,isConnectable:r}=t;return zi(n),e.jsxs(e.Fragment,{children:[e.jsx(ha,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsx("div",{className:"min-w-10 min-h-10 w-full h-full bg-border rounded-full border",children:e.jsx(me,{id:n})}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:r})]})}),Ui=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([b.CircleShape,b.Shape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===b.TriangleShape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Wi=d.memo(t=>{const{id:n,selected:a,width:r,height:s,isConnectable:o}=t;return Ui(n),e.jsxs(e.Fragment,{children:[e.jsx(ha,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(X,{type:"target",position:K.Top,isConnectable:o}),e.jsx("div",{className:"w-0 h-0 border-l-transparent border-r-transparent border-b-border",style:{borderLeftWidth:(r||0)/2,borderRightWidth:(r||0)/2,borderBottomWidth:s||0}}),e.jsx(me,{id:n,className:"absolute top-0 right-0"}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:o})]})}),qi=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.LLM&&(o==null?void 0:o.type)===b.EditorApp){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Gi=t=>{const n=oe(t),{t:a}=G("flows"),r=d.useRef(null),{toast:s}=ye(),{getNode:o,getHandleConnections:i}=Ne(),{stream:l}=ct(),c=d.useCallback(async p=>{n&&(clearTimeout(r.current),r.current=setTimeout(async()=>{await I("FlowNode").update(n.id,{data:p})},150))},[n]),u=d.useCallback(async(p,h)=>{var x,f;if(n){const g=i({nodeId:t,type:"target"}).find(k=>{var D;return((D=o(k.source))==null?void 0:D.type)===b.LLM}),_=g?o(g==null?void 0:g.source):void 0,y=(x=_==null?void 0:_.data)==null?void 0:x.entity;if(!_||!y)return s({variant:"destructive",description:a("editor_node.errors.llm_not_found")});if(_.data.status!==ce.Loaded)return s({variant:"destructive",description:a("editor_node.errors.llm_not_loaded_yet")});try{return(f=await l(y.provider,typeof p=="string"?[new Ke(p)]:p,{onMessageUpdate:k=>{h==null||h(k.content)},llm:y}))==null?void 0:f.content}catch(k){if(k instanceof Error&&k.message.includes("LLM_NOT_LOADED_YET"))return s({title:a("editor_node.errors.llm_not_loaded_yet")});s({variant:"destructive",title:a("editor_node.errors.stream_message_failed")})}}},[n,i,t,o,s,a,l]),m=d.useCallback(p=>{if(!o(p))return[];const h=[];return i({nodeId:p,type:"target"}).forEach(x=>{const f=o(x.source);!f||f.type!==b.LLM||h.push({node:f,connections:[x]})}),h},[i,o]);return{createMessage:u,updateEditorContent:c,getLinkedConnections:m}},Ji=d.lazy(()=>ve(()=>import("./index-CwgDbPdT.js").then(async t=>(await t.__tla,t)),__vite__mapDeps([10,2,3,11,4,12,13,14,15,16,6,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,1,5,57]))),Ki=d.memo(t=>{var u;const{id:n,data:a,selected:r,isConnectable:s}=t;qi(n);const{createMessage:o,updateEditorContent:i,getLinkedConnections:l}=Gi(n),c=d.useCallback(m=>{i(m)},[i]);return e.jsxs("div",{className:"w-full min-w-[1240px] h-full",children:[e.jsx(ha,{isVisible:!!r,minWidth:1240,minHeight:400}),e.jsx(X,{type:"target",position:K.Top,isConnectable:s}),e.jsxs("div",{className:"min-w-10 min-h-10 w-full h-full rounded-lg border bg-background",children:[e.jsx(me,{className:"!z-[100]",id:n,enableToStandalone:!0,getLinkedConnections:l}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-ful rounded-lg flex justify-center items-center",children:e.jsx(H,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx("div",{className:"h-full w-ful rounded-lg","data-registry":"plate",children:e.jsx(Ji,{defaultValue:(u=a==null?void 0:a.flowNode)==null?void 0:u.data,onValueChange:c,copilotStream:o})})})]}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:s})]})}),Xi=t=>{const n=d.useCallback(async({edgeId:a})=>{try{return{deleteEdgeId:a}}catch{return{deleteEdgeId:a}}},[]);pe(t,n)},Zi=d.memo(t=>{var i,l;const{id:n,data:a,isConnectable:r}=t,{t:s}=G("flows");Xi(n);let o="";switch((i=a.entity)==null?void 0:i.placeholder_type){case"VECTOR_DATABASE_RETREIVER":o=s("placeholder_node.vector_database_retriever");break}return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs(je,{className:"flex justify-center max-w-80",variant:"default",children:[e.jsx(me,{id:n}),e.jsx(H,{name:"land-plot",className:"w-7 h-7"}),e.jsxs("div",{className:"ml-2 pr-4",children:[e.jsx(Pe,{children:`${((l=a.entity)==null?void 0:l.placeholder)||""}`}),e.jsx(na,{children:o?e.jsx(Ue,{children:o}):void 0})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),Yi=["empty-source","vite-vue","shadcn-react-vite","todo-app-react-vite","porfolio-nextjs"],Qi=async t=>{switch(t){case"empty-source":return ve(()=>import("./empty-source-Dw1dvL8s.js"),[]).then(n=>n.BASE);case"vite-vue":return ve(()=>import("./vite-vue-Bmz2z3Fo.js"),[]).then(n=>n.BASE);case"shadcn-react-vite":return ve(()=>import("./shadcn-react-vite-CDJ9BaE9.js"),[]).then(n=>n.BASE);case"todo-app-react-vite":return ve(()=>import("./todo-app-react-vite-BBWBkRjR.js"),[]).then(n=>n.BASE);case"porfolio-nextjs":return ve(()=>import("./porfolio-nextjs-DCkli5iW.js"),[]).then(n=>n.BASE);default:throw new Error(`Unknown source base: ${t}`)}},eo=d.memo(({className:t,onUpdateSourceBase:n})=>{const{t:a}=G("components"),[r,s]=d.useState();return e.jsxs(se,{className:J("mw-full",t),children:[e.jsx(de,{className:"p-4",children:e.jsx(he,{children:a("add_source_base.title")})}),e.jsx(le,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-center w-full h-full flex-col",children:[e.jsxs(Le,{onValueChange:o=>s(o),children:[e.jsx(De,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:a("add_source_base.source_base_select_placeholder")})}),e.jsx(Ae,{children:Yi.map(o=>e.jsx(fe,{value:`${o}`,children:a(`add_source_base.sourcebases.${o.toLowerCase()}`)},`${o}`))})]}),e.jsx(Q,{className:"w-full",onClick:async()=>r&&n(await Qi(r)),children:a("add_source_base.update_source")})]})})]})}),ao=()=>{const{getNode:t,getHandleConnections:n}=Ne(),{stream:a}=ct(),r=d.useCallback(async(o,i)=>{await I("FlowNode").update(o,{raw:ol(i)})},[]),s=d.useCallback(o=>{if(!t(o))return[];const i=[];return n({nodeId:o,type:"target"}).forEach(l=>{const c=t(l.source);!c||c.type!==b.LLM||i.push({node:c,connections:[l]})}),i},[n,t]);return{sendMessage:d.useCallback(async(o,i,{onMessageUpdate:l,onResponseMessageCreate:c}={})=>{const u=i.map(p=>p.role==="system"?new tn(p.content):p.role==="user"?new Ke(p.content):new Sa(p.content));c==null||c();const m=await a(z.WebLLM,[...u,new Ke(o)],{onMessageUpdate:({content:p})=>{l==null||l({nodeData:{loading:!0,content:p}})},llm:void 0});return l==null||l({nodeData:{loading:!1,content:m==null?void 0:m.content}}),m==null?void 0:m.content},[a]),getLinkedConnections:s,updateCodeContainerData:r}},to=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.LLM&&(o==null?void 0:o.type)===b.VSLiteApp){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},so=d.lazy(()=>ve(()=>import("./index-YeeCzbmu.js").then(async t=>(await t.__tla,t)),__vite__mapDeps([58,2,3,4,12,36,6,59,60,61,15,62]))),no=d.memo(t=>{var h,x,f,g;const{id:n,isConnectable:a,data:r}=t,[s,o]=d.useState((h=r==null?void 0:r.flowNode)!=null&&h.raw?dl(r.flowNode.raw):void 0),{updateCodeContainerData:i,getLinkedConnections:l,sendMessage:c}=ao();to(n);const u=d.useCallback(async _=>{var y,k;(y=r==null?void 0:r.flowNode)!=null&&y.id&&(await i((k=r==null?void 0:r.flowNode)==null?void 0:k.id,_),o(_))},[(x=r==null?void 0:r.flowNode)==null?void 0:x.id,i]),m=d.useCallback(async(_,y)=>{var k;return(k=r==null?void 0:r.flowNode)!=null&&k.id?await c(_,y):void 0},[(f=r==null?void 0:r.flowNode)==null?void 0:f.id,c]),p=d.useCallback(async _=>{o(y=>{var D;const k=ll(y||{},_);return i((D=r==null?void 0:r.flowNode)==null?void 0:D.id,k),k})},[(g=r==null?void 0:r.flowNode)==null?void 0:g.id,i]);return s?e.jsxs("div",{className:"w-[1380px] h-[600px] rounded-lg border overflow-hidden shadow-sm",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:a}),e.jsxs("div",{className:"w-full h-full rounded-lg border bg-card overflow-hidden",children:[e.jsx(me,{id:n,className:"z-50",enableToStandalone:!0,getLinkedConnections:l}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex justify-center items-center",children:e.jsx(H,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx(so,{fileSystemTree:s,onUpdateFileContent:p,sendMessage:m})})]}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:a})]}):e.jsx("div",{className:"h-full flex justify-center items-center",children:e.jsx(eo,{className:"w-64",onUpdateSourceBase:u})})}),ro={[b.LLM]:ai,[b.Toolbox]:Jr,[b.Thread]:ii,[b.Message]:ui,[b.Prompt]:pi,[b.SessionInfo]:hi,[b.Schema]:gi,[b.CSVData]:xi,[b.ToolDefinition]:yi,[b.DefaultEmbeddingModel]:bi,[b.VectorDatabase]:Di,[b.JSONLData]:Ai,[b.ApplicationBar]:$i,[b.Shape]:Hi,[b.CircleShape]:Bi,[b.TriangleShape]:Wi,[b.EditorApp]:Ki,[b.PlaceHolder]:Zi,[b.VSLiteApp]:no},vs=$s("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3 min-w-10",sm:"h-9 px-2.5 min-w-9",lg:"h-11 px-5 min-w-11"}},defaultVariants:{variant:"default",size:"default"}}),io=d.forwardRef(({className:t,variant:n,size:a,...r},s)=>e.jsx(pn,{ref:s,className:J(vs({variant:n,size:a,className:t})),...r}));io.displayName=pn.displayName;const ws=d.createContext({size:"default",variant:"default"}),js=d.forwardRef(({className:t,variant:n,size:a,children:r,...s},o)=>e.jsx(hn,{ref:o,className:J("flex items-center justify-center gap-1",t),...s,children:e.jsx(ws.Provider,{value:{variant:n,size:a},children:r})}));js.displayName=hn.displayName;const bs=d.forwardRef(({className:t,children:n,variant:a,size:r,...s},o)=>{const i=d.useContext(ws);return e.jsx(fn,{ref:o,className:J(vs({variant:i.variant||a,size:i.size||r}),t),...s,children:n})});bs.displayName=fn.displayName;function oo(){const t=Xo(n=>`x: ${n.transform[0].toFixed(2)}, y: ${n.transform[1].toFixed(2)}, zoom: ${n.transform[2].toFixed(2)}`);return e.jsx("div",{children:t})}function lo({change:t}){var r,s,o,i;const n="id"in t?t.id:"-",{type:a}=t;return e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{children:["node id: ",n]}),e.jsxs("div",{children:[a==="add"?JSON.stringify(t.item,null,2):null,a==="dimensions"?`dimensions: ${(r=t.dimensions)==null?void 0:r.width} \xD7 ${(s=t.dimensions)==null?void 0:s.height}`:null,a==="position"?`position: ${(o=t.position)==null?void 0:o.x.toFixed(1)}, ${(i=t.position)==null?void 0:i.y.toFixed(1)}`:null,a==="remove"?"remove":null,a==="select"?t.selected?"select":"unselect":null]})]})}function co({limit:t=20}){const[n,a]=d.useState([]),r=Zo(),s=d.useCallback(i=>{a(l=>[...i,...l].slice(0,t))},[t]);d.useEffect(()=>(r.setState({onNodesChange:s}),()=>r.setState({onNodesChange:void 0})),[s,r]);const o=()=>e.jsx("div",{children:"No Changes Triggered"});return e.jsx(e.Fragment,{children:n.length===0?e.jsx(o,{}):n.map((i,l)=>e.jsx(lo,{change:i},l))})}function uo(){const{getInternalNode:t}=Ne(),n=Ks();return e.jsx(Yo,{children:e.jsx("div",{className:"text-secondary-foreground",children:n.map(a=>{var o,i;const r=t(a.id);if(!r)return null;const s=r==null?void 0:r.internals.positionAbsolute;return e.jsx(mo,{id:a.id,selected:!!a.selected,type:a.type||"default",position:a.position,absPosition:s,width:((o=a.measured)==null?void 0:o.width)??0,height:((i=a.measured)==null?void 0:i.height)??0,data:a.data},a.id)})})})}function mo({id:t,type:n,selected:a,position:r,absPosition:s,width:o,height:i,data:l}){if(!o||!i)return null;const c=`translate(${s.x}px, ${s.y+i}px)`,u=`${r.x.toFixed(1)}, ${r.y.toFixed(1)}`,m=`${o} \xD7 ${i}`,p=a?"Selected":"Not Selected";return e.jsxs("div",{style:{position:"absolute",transform:c,width:o*2},className:"text-xs",children:[e.jsxs("div",{children:["id: ",t]}),e.jsxs("div",{children:["type: ",n]}),e.jsxs("div",{children:["selected: ",p]}),e.jsxs("div",{children:["position: ",u]}),e.jsxs("div",{children:["dimensions: ",m]}),e.jsxs("div",{children:["data: ",JSON.stringify(l,null,2)]})]})}function po({tools:t}){return e.jsx(nt,{position:"top-left",className:"bg-card p-1 border rounded shadow-sm",children:e.jsx(js,{type:"multiple",children:t.map(({active:n,setActive:a,label:r,value:s})=>e.jsx(bs,{value:s,onClick:()=>a(o=>!o),"aria-pressed":n,className:"bg-card text-card-foreground transition-colors duration-300 hover:bg-secondary hover:text-secondary-foreground",children:r},s))})})}function Ns(){const[t,n]=d.useState(!1),[a,r]=d.useState(!1),[s,o]=d.useState(!1),i=[{active:t,setActive:n,label:"Node Inspector",value:"node-inspector"},{active:a,setActive:r,label:"Change Logger",value:"change-logger"},{active:s,setActive:o,label:"Viewport Logger",value:"viewport-logger"}];return e.jsxs(e.Fragment,{children:[e.jsx(po,{tools:i}),a&&e.jsx(nt,{className:"text-xs p-5 bg-white rounded shadow-md overflow-y-auto max-h-[50%] mt-20",position:"bottom-right",children:e.jsx(co,{})}),t&&e.jsx(uo,{}),s&&e.jsx(nt,{position:"bottom-left",className:"text-secondary-foreground",children:e.jsx(oo,{})})]})}Ns.displayName="DevTools";let Cs,Ss,Es,ks;Cs=()=>{const t=d.useRef({}),n=d.useRef({}),a=d.useRef([]),r=T(M=>M.flowEdges),s=ae(M=>M.currentSession),o=T(M=>M.setNodes),i=T(M=>M.updateNodes),l=T(M=>M.updateEdges),c=T(M=>M.addConnectionToEdges),u=T(M=>M.reset),m=T(M=>M.findFlowEdges),p=T(M=>M.deleteFlowNode),h=T(M=>M.deleteFlowEdge),x=T(M=>M.updateFlowNode),f=T(M=>M.getNodes),g=T(M=>M.findFlowNodesWithSource),_=d.useRef(r),y=d.useRef(),[k,D]=d.useState({loading:!1});_.current=r;const w=d.useCallback(async(M,A)=>{try{y.current=M,u(),await(A==null?void 0:A())}catch{y.current=void 0}},[u]),E=d.useCallback(async M=>{try{if(!(s!=null&&s.id))return;D(S=>({...S,loading:!0}));const A=await g({...M,where:{...M.where,session_id:s.id}}),P=await m({where:[{source:lt(A.map(S=>S.id))},{target:lt(A.map(S=>S.id))}]});return{flowNodes:A,flowEdges:P}}finally{D(A=>({...A,loading:!1}))}},[g,m,s==null?void 0:s.id]),v=d.useCallback(async M=>{var A,P;for(const S of a.current){const L=await S(M);if(typeof L=="boolean"&&!L)return}for(const S of M)if("id"in S&&Object.values(va).includes(S.id)&&S.type!=="remove")i([S]);else if(S.type==="position"&&S.position&&!isNaN(S.position.x)&&!isNaN(S.position.y)){i([S]);const L=S.position.x,W=S.position.y;clearTimeout(t.current[S.id]),t.current[S.id]=setTimeout(async()=>{t.current[S.id]=void 0,await x({id:S.id,x:L,y:W},{silent:!0})},200)}else if(S.type==="remove"){const L=(A=f([S.id]))==null?void 0:A[0];if(!(L!=null&&L.type)||Qo.includes(L.type))return;await p({id:S.id})}else if(S.type==="dimensions"&&S.dimensions&&!isNaN(S.dimensions.width)&&!isNaN(S.dimensions.height)){const L=(P=f([S.id]))==null?void 0:P[0];if(!(L!=null&&L.width)&&!(L!=null&&L.height))return;i([S]),clearTimeout(n.current[S.id]);const W=S.dimensions.width,Z=S.dimensions.height;n.current[S.id]=setTimeout(async()=>{await x({id:S.id,width:W,height:Z},{silent:!0})},200)}else S.type==="select"&&i([S])},[i,x,f,p]),j=d.useCallback(M=>{Promise.all(M.map(async A=>{if(A.type==="remove")return h({id:A.id})})),l(M)},[h,l]),$=d.useCallback(M=>{c(M)},[c]),B=d.useCallback(M=>{o(A=>{var W,Z;let P;if(typeof M=="function"?P=M(A):P=M,!P)return A;const S=A==null?void 0:A.find(ee=>ee.id===P.id),L={id:P.id,item:S?ed(S,P):{...P,position:{x:((W=P.position)==null?void 0:W.x)||0,y:((Z=P.position)==null?void 0:Z.y)||0}},type:S?"replace":"add"};return ad([L],A)})},[o]),U=d.useCallback(M=>(a.current.push(M),()=>{a.current=a.current.filter(A=>A!==M)}),[]);return{initFlow:w,loadingState:k,prepareFlowInfo:E,updateNodeChanges:v,updateEdgeChanges:j,updateOrCreateNode:B,currentSessionIdRef:y,updateEdgeConnection:$,addOnNodeChangeHandler:U}},Ss=t=>{const n=ae(p=>{var h;return(h=p.currentSession)==null?void 0:h.id}),{loadingState:a,prepareFlowInfo:r,initFlow:s,currentSessionIdRef:o}=t,i=T(p=>p.ready),l=T(p=>p.nodes),c=d.useRef(l),u=T(p=>p.removeSyncNodeQueue),m=T(p=>p.removeSyncEdgeQueue);c.current=l,d.useEffect(()=>{a.loading||!i||!n||o.current===n||s(n,async()=>{await r({where:{session_id:n}})})},[s,r,a.loading,o,i,n]),d.useEffect(()=>{const p=T.subscribe(x=>x.syncNodeQueue,async(x,f)=>{const g=f.map(y=>y.timestamp),_=x.filter(y=>!g.includes(y.timestamp));_.length&&u(_.map(y=>y.timestamp))}),h=T.subscribe(x=>x.syncEdgeQueue,async(x,f)=>{const g=f.map(y=>y.timestamp),_=x.filter(y=>!g.includes(y.timestamp));_.length&&m(_.map(y=>y.timestamp))});return()=>{p(),h()}},[r,m,u])},Es=()=>{const[t,n]=d.useState(!0),a=Cs(),r=ia(m=>m.selectedModel),s=d.useRef(r),o=ia(m=>m.setInitProgressCallback),{updateOrCreateNode:i,updateNodeChanges:l,updateEdgeChanges:c,updateEdgeConnection:u}=a;return Ss(a),s.current=r,d.useEffect(()=>{const m=o==null?void 0:o(p=>{if(!s.current)return;const h=`${s.current}`;i(x=>{const f=x==null?void 0:x.find(g=>{var _;return(_=g.data)!=null&&_.entity&&typeof g.data.entity=="object"&&"name"in g.data.entity?g.data.entity.name===h:!1});if(f)return f.data.label=p.text,f.data.status=ce.Loading,p.progress===100&&(f.data.label="",f.data.status=ce.Loaded),f})});return()=>{m==null||m()}},[o,i]),d.useMemo(()=>({updateNodeChanges:l,updateEdgeChanges:c,initializing:t,setInitializing:n,updateEdgeConnection:u}),[l,c,t,n,u])},ks=()=>{const t=Ts(u=>u.theme),n=T(u=>u.nodes),a=T(u=>u.edges),{updateNodeChanges:r,updateEdgeChanges:s,updateEdgeConnection:o}=Es(),i=d.useCallback(u=>{r(u)},[r]),l=d.useCallback(u=>{s(u)},[s]),c=d.useCallback(u=>{o(u)},[o]);return e.jsxs(td,{nodes:n,edges:a,nodeTypes:ro,onNodesChange:i,onEdgesChange:l,onConnect:c,panOnScroll:!0,panOnScrollMode:sd.Free,colorMode:t,fitView:!0,children:[e.jsx(nd,{variant:rd.Dots,gap:24,size:1}),e.jsx(id,{}),e.jsx(od,{}),Lo?e.jsx(Ns,{}):void 0]})},gn=d.memo(ks)});export{ul as __tla,gn as default};
