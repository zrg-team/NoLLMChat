const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BFbnGzju.js","assets/LLMIcon-Cgp-myVh.js","assets/index-DtEubEwZ.js","assets/index-Cw9j2N9-.css","assets/routes-B-PH-_IA.js","assets/dot-CjJRbLGS.js","assets/createLucideIcon-DuPqHR91.js","assets/file-tree-Bge6cgXj.js","assets/pdf.min-D22LfYNT.js","assets/pdf.worker.min-DKozKsPM.js","assets/index-uHG90FFb.js","assets/toNumber-Dl0-IZOl.js","assets/index-DzU9ekqw.js","assets/index-D62sh1fQ.js","assets/index-BdL5k4-6.js","assets/index-B-RPFZha.js","assets/link-DIFqFO0H.js","assets/trash-2-DOe3-Oeu.js","assets/index-61jd53bU.js","assets/index-D5bZnNu3.js","assets/text-DxYFH_We.js","assets/external-link-Cut8lh0o.js","assets/unlink-DfUkXOry.js","assets/list-CqHKSuHZ.js","assets/list-ordered-Csb0R-d3.js","assets/list-todo-BOq9MPYV.js","assets/indent-increase-CGzBTIMO.js","assets/pilcrow-B4zDilL1.js","assets/heading-1-DQA95ttR.js","assets/heading-2-BWBEr2ub.js","assets/heading-3-DxK6WMHG.js","assets/table-CeSezppU.js","assets/file-code-BIVVP1EQ.js","assets/quote-CHTGyBFM.js","assets/minus-CdcL98Kv.js","assets/square-CMYJpRfC.js","assets/chevron-right-Ch9V8aNj.js","assets/image-BCLltXas.js","assets/table-of-contents-Zo-2GScM.js","assets/columns-3-DFZSfJcL.js","assets/link-2-DIWc4Mua.js","assets/calendar-DgPifrlg.js","assets/plus-Cm76dydq.js","assets/wrap-text-De7a6NKX.js","assets/index-C20BDnVz.js","assets/pen-Bi4LJA1P.js","assets/eye-D3wPd39l.js","assets/indent-decrease-23Mg53ZX.js","assets/pointer-NEE6p447.js","assets/wand-sparkles-5aB4k4tj.js","assets/bold-C7WcMb-g.js","assets/italic-B16RN7Vn.js","assets/underline-BkXYRIuI.js","assets/strikethrough-awK73sPW.js","assets/code-xml-DRDjZ1kz.js","assets/baseline-DJ0mSyZM.js","assets/paint-bucket-CEiMyazZ.js","assets/arrow-up-to-line-aiSETPKu.js","assets/index-BCYu3EnN.css","assets/index-TU_g0_YJ.js","assets/check-CL8wQGK-.js","assets/circle-DqC_YmqE.js","assets/popover-CIexJCax.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{i as fa,r as d,M as As,F as po,m as Os,G as ho,H as Fs,I as Ts,J as fo,K as go,N as xo,O as et,Q as _o,a as yo,f as vo,j as e,P as Ee,u as wo,b as Me,c as J,L as H,T as jo,U as bo,V as No,p as ga,q as Te,d as G,e as ye,W as xa,_ as ve,X as We,Y as Co,R as sa,y as Rs,Z as So,w as Ps,$ as Eo,o as $s,v as Vs,a0 as ko,a1 as Mo,__tla as Do}from"./index-DtEubEwZ.js";import{j as Lo,k as Io,l as oe,R as Hs,L as _a,A as je,C as se,m as de,n as he,o as le,S as De,p as Le,q as Ie,s as Ae,t as fe,v as Re,w as Ao,x as Oo,y as Fo,z as To,E as zs,G as Us,H as ya,J as at,K as Bs,N as tt,O as Ne,Q as Ro,U as K,X as va,Y as Po,Z as Pe,_ as na,h as $o,$ as qs,u as st,F as ra,P as Vo,a0 as Ws,a1 as Gs,i as Be,M as Ho,a2 as zo,a3 as Uo,d as Js,e as Ks,g as Ge,T as Je,D as nt,a4 as Xs,a5 as wa,a as Ys,W as Bo,I as qo,b as Wo,V as Go,a6 as Jo,a7 as rt,a8 as Ko,a9 as Xo,aa as Yo,ab as Qo,ac as Zo,ad as ed,ae as ad,af as td,ag as sd,ah as nd,ai as rd,aj as id,__tla as od}from"./chunk-CWaDIpLw.js";import{ad as dd,k as Qs,l as ld,m as cd,I as ud,ae as md,af as pd,ag as hd,ah as fd,ai as gd,aj as xd,ak as _d,al as yd,am as vd,an as wd,ao as jd,ap as bd,aq as Nd,aa as Oe,ar as Cd,as as Sd,u as ae,g as I,F as b,R as Ed,P as kd,O as Md,C as Dd,q as ja,r as ba,s as Na,t as Ca,at as Zs,au as en,B as Z,av as Sa,aw as ia,ax as W,ay as re,L as Fe,az as it,aA as Ld,aB as Id,V as $e,aC as an,aD as Ad,aE as Od,aF as Fd,aG as Td,aH as Rd,aI as Pd,A as Ea,H as Ke,aJ as tn,S as sn,aK as ot,o as dt,aL as lt,aM as $d,n as nn,e as Vd,f as rn,h as on,i as dn,aN as Hd,__tla as zd}from"./routes-B-PH-_IA.js";import{e as z,L as ce,f as ka,h as Ud,i as ln,j as Xe,k as Bd,l as qd,m as cn,b as Wd,n as un,c as Ve,o as Gd,a as Jd,I as ct,u as ut,q as Kd,d as Xd,r as Yd,__tla as Qd}from"./LLMIcon-Cgp-myVh.js";import{P as mt,a as pt,T as oa,A as Zd,b as el,__tla as al}from"./popover-CIexJCax.js";import{a as mn,__tla as tl}from"./index-B-RPFZha.js";import{s as sl}from"./toNumber-Dl0-IZOl.js";import{R as pn,I as nl,a as hn,b as fn,c as gn,__tla as rl}from"./index-D5bZnNu3.js";import{p as il,S as ol}from"./plate-editor-DO3op6-8.js";import{p as dl,a as ll,u as cl,__tla as ul}from"./file-tree-Bge6cgXj.js";import"./dot-CjJRbLGS.js";import"./createLucideIcon-DuPqHR91.js";let xn,ml=Promise.all([(()=>{try{return Do}catch{}})(),(()=>{try{return od}catch{}})(),(()=>{try{return zd}catch{}})(),(()=>{try{return Qd}catch{}})(),(()=>{try{return al}catch{}})(),(()=>{try{return tl}catch{}})(),(()=>{try{return rl}catch{}})(),(()=>{try{return ul}catch{}})()]).then(async()=>{function Ma(t){const n=fa(()=>po(t)),{isStatic:a}=d.useContext(As);if(a){const[,r]=d.useState(t);d.useEffect(()=>n.on("change",r),[])}return n}function ht(t,n){const a=Ma(n()),r=()=>a.set(n());return r(),Os(()=>{const s=()=>Fs.preRender(r,!1,!0),o=t.map(i=>i.on("change",s));return()=>{o.forEach(i=>i()),ho(r)}}),a}function _n(t,n={}){const{isStatic:a}=d.useContext(As),r=d.useRef(null),s=fa(()=>Ts(t)?t.get():t),o=fa(()=>typeof s=="string"?s.replace(/[\d.-]/g,""):void 0),i=Ma(s),l=d.useRef(s),c=d.useRef(fo),p=()=>{u(),r.current=go({keyframes:[gt(i.get()),gt(l.current)],velocity:i.getVelocity(),type:"spring",restDelta:.001,restSpeed:.01,...n,onUpdate:c.current})},u=()=>{r.current&&r.current.stop()};return d.useInsertionEffect(()=>i.attach((m,h)=>a?h(m):(l.current=m,c.current=g=>h(ft(g,o)),Fs.postRender(p),i.get()),u),[JSON.stringify(n)]),Os(()=>{if(Ts(t))return t.on("change",m=>i.set(ft(m,o)))},[i,o]),i}function ft(t,n){return n?t+n:t}function gt(t){return typeof t=="number"?t:parseFloat(t)}const yn=t=>t&&typeof t=="object"&&t.mix,vn=t=>yn(t)?t.mix:void 0;function wn(...t){const n=!Array.isArray(t[0]),a=n?0:-1,r=t[0+a],s=t[1+a],o=t[2+a],i=t[3+a],l=xo(s,o,{mixer:vn(o[0]),...i});return n?l(r):l}function jn(t){et.current=[],t();const n=ht(et.current,t);return et.current=void 0,n}function xt(t,n,a,r){if(typeof t=="function")return jn(t);const s=typeof n=="function"?n:wn(n,a,r);return Array.isArray(t)?_t(t,s):_t([t],([o])=>s(o))}function _t(t,n){const a=fa(()=>[]);return ht(t,()=>{a.length=0;const r=t.length;for(let s=0;s<r;s++)a[s]=t[s].get();return n(a)})}var be=(t=>(t.Started="started",t.Inprogress="inprogress",t.Success="success",t.Failed="failed",t))(be||{}),ge=(t=>(t.Human="human",t.User="user",t.AI="ai",t.System="system",t.Assistant="assistant",t.Tool="tool",t.FewShotExample="few_shot_example",t))(ge||{}),da=(t=>(t.Started="started",t.Inprogress="inprogress",t.Done="done",t))(da||{}),xe=(t=>(t.Chat="chat",t.FewShotExample="few_shot_example",t))(xe||{}),la="Menubar",[Da,bn,Nn]=_o(la),[yt,pl]=yo(la,[Nn,Qs]),ie=dd(),vt=Qs(),[Cn,La]=yt(la),wt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,value:r,onValueChange:s,defaultValue:o,loop:i=!0,dir:l,...c}=t,p=ld(l),u=vt(a),[m="",h]=vo({prop:r,onChange:s,defaultProp:o}),[g,f]=d.useState(null);return e.jsx(Cn,{scope:a,value:m,onMenuOpen:d.useCallback(x=>{h(x),f(x)},[h]),onMenuClose:d.useCallback(()=>h(""),[h]),onMenuToggle:d.useCallback(x=>{h(_=>_?"":x),f(x)},[h]),dir:p,loop:i,children:e.jsx(Da.Provider,{scope:a,children:e.jsx(Da.Slot,{scope:a,children:e.jsx(cd,{asChild:!0,...u,orientation:"horizontal",loop:i,dir:p,currentTabStopId:g,onCurrentTabStopIdChange:f,children:e.jsx(Ee.div,{role:"menubar",...c,ref:n})})})})})});wt.displayName=la;var Ia="MenubarMenu",[Sn,jt]=yt(Ia),bt=t=>{const{__scopeMenubar:n,value:a,...r}=t,s=Oe(),o=a||s||"LEGACY_REACT_AUTO_VALUE",i=La(Ia,n),l=ie(n),c=d.useRef(null),p=d.useRef(!1),u=i.value===o;return d.useEffect(()=>{u||(p.current=!1)},[u]),e.jsx(Sn,{scope:n,value:o,triggerId:Oe(),triggerRef:c,contentId:Oe(),wasKeyboardTriggerOpenRef:p,children:e.jsx(Cd,{...l,open:u,onOpenChange:m=>{m||i.onMenuClose()},modal:!1,dir:i.dir,...r})})};bt.displayName=Ia;var Aa="MenubarTrigger",Nt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,disabled:r=!1,...s}=t,o=vt(a),i=ie(a),l=La(Aa,a),c=jt(Aa,a),p=d.useRef(null),u=wo(n,p,c.triggerRef),[m,h]=d.useState(!1),g=l.value===c.value;return e.jsx(Da.ItemSlot,{scope:a,value:c.value,disabled:r,children:e.jsx(ud,{asChild:!0,...o,focusable:!r,tabStopId:c.value,children:e.jsx(md,{asChild:!0,...i,children:e.jsx(Ee.button,{type:"button",role:"menuitem",id:c.triggerId,"aria-haspopup":"menu","aria-expanded":g,"aria-controls":g?c.contentId:void 0,"data-highlighted":m?"":void 0,"data-state":g?"open":"closed","data-disabled":r?"":void 0,disabled:r,...s,ref:u,onPointerDown:Me(t.onPointerDown,f=>{!r&&f.button===0&&f.ctrlKey===!1&&(l.onMenuOpen(c.value),g||f.preventDefault())}),onPointerEnter:Me(t.onPointerEnter,()=>{var f;l.value&&!g&&(l.onMenuOpen(c.value),(f=p.current)==null||f.focus())}),onKeyDown:Me(t.onKeyDown,f=>{r||(["Enter"," "].includes(f.key)&&l.onMenuToggle(c.value),f.key==="ArrowDown"&&l.onMenuOpen(c.value),["Enter"," ","ArrowDown"].includes(f.key)&&(c.wasKeyboardTriggerOpenRef.current=!0,f.preventDefault()))}),onFocus:Me(t.onFocus,()=>h(!0)),onBlur:Me(t.onBlur,()=>h(!1))})})})})});Nt.displayName=Aa;var En="MenubarPortal",Ct=t=>{const{__scopeMenubar:n,...a}=t,r=ie(n);return e.jsx(Sd,{...r,...a})};Ct.displayName=En;var Oa="MenubarContent",St=d.forwardRef((t,n)=>{const{__scopeMenubar:a,align:r="start",...s}=t,o=ie(a),i=La(Oa,a),l=jt(Oa,a),c=bn(a),p=d.useRef(!1);return e.jsx(pd,{id:l.contentId,"aria-labelledby":l.triggerId,"data-radix-menubar-content":"",...o,...s,ref:n,align:r,onCloseAutoFocus:Me(t.onCloseAutoFocus,u=>{var m;!i.value&&!p.current&&((m=l.triggerRef.current)==null||m.focus()),p.current=!1,u.preventDefault()}),onFocusOutside:Me(t.onFocusOutside,u=>{const m=u.target;c().some(h=>{var g;return(g=h.ref.current)==null?void 0:g.contains(m)})&&u.preventDefault()}),onInteractOutside:Me(t.onInteractOutside,()=>{p.current=!0}),onEntryFocus:u=>{l.wasKeyboardTriggerOpenRef.current||u.preventDefault()},onKeyDown:Me(t.onKeyDown,u=>{if(["ArrowRight","ArrowLeft"].includes(u.key)){const m=u.target,h=m.hasAttribute("data-radix-menubar-subtrigger"),g=m.closest("[data-radix-menubar-content]")!==u.currentTarget,f=(i.dir==="rtl"?"ArrowRight":"ArrowLeft")===u.key;if(!f&&h||g&&f)return;let x=c().filter(k=>!k.disabled).map(k=>k.value);f&&x.reverse();const _=x.indexOf(l.value);x=i.loop?zn(x,_+1):x.slice(_+1);const[y]=x;y&&i.onMenuOpen(y)}},{checkForDefaultPrevented:!1}),style:{...t.style,"--radix-menubar-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-menubar-content-available-width":"var(--radix-popper-available-width)","--radix-menubar-content-available-height":"var(--radix-popper-available-height)","--radix-menubar-trigger-width":"var(--radix-popper-anchor-width)","--radix-menubar-trigger-height":"var(--radix-popper-anchor-height)"}})});St.displayName=Oa;var kn="MenubarGroup",Mn=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(hd,{...s,...r,ref:n})});Mn.displayName=kn;var Dn="MenubarLabel",Et=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(fd,{...s,...r,ref:n})});Et.displayName=Dn;var Ln="MenubarItem",kt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(gd,{...s,...r,ref:n})});kt.displayName=Ln;var In="MenubarCheckboxItem",Mt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(xd,{...s,...r,ref:n})});Mt.displayName=In;var An="MenubarRadioGroup",On=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(_d,{...s,...r,ref:n})});On.displayName=An;var Fn="MenubarRadioItem",Dt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(yd,{...s,...r,ref:n})});Dt.displayName=Fn;var Tn="MenubarItemIndicator",Lt=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(vd,{...s,...r,ref:n})});Lt.displayName=Tn;var Rn="MenubarSeparator",It=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(wd,{...s,...r,ref:n})});It.displayName=Rn;var Pn="MenubarArrow",$n=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(jd,{...s,...r,ref:n})});$n.displayName=Pn;var Vn="MenubarSubTrigger",At=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(bd,{"data-radix-menubar-subtrigger":"",...s,...r,ref:n})});At.displayName=Vn;var Hn="MenubarSubContent",Ot=d.forwardRef((t,n)=>{const{__scopeMenubar:a,...r}=t,s=ie(a);return e.jsx(Nd,{...s,"data-radix-menubar-content":"",...r,ref:n,style:{...t.style,"--radix-menubar-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-menubar-content-available-width":"var(--radix-popper-available-width)","--radix-menubar-content-available-height":"var(--radix-popper-available-height)","--radix-menubar-trigger-width":"var(--radix-popper-anchor-width)","--radix-menubar-trigger-height":"var(--radix-popper-anchor-height)"}})});Ot.displayName=Hn;function zn(t,n){return t.map((a,r)=>t[(n+r)%t.length])}var Ft=wt,Un=bt,Tt=Nt,Bn=Ct,Rt=St,Pt=Et,$t=kt,Vt=Mt,Ht=Dt,zt=Lt,Ut=It,Bt=At,qt=Ot;const Fa=Un,Wt=d.forwardRef(({className:t,...n},a)=>e.jsx(Ft,{ref:a,className:J("flex h-10 items-center space-x-1 rounded-md border bg-background p-1",t),...n}));Wt.displayName=Ft.displayName;const Ta=d.forwardRef(({className:t,...n},a)=>e.jsx(Tt,{ref:a,className:J("flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",t),...n}));Ta.displayName=Tt.displayName;const qn=d.forwardRef(({className:t,inset:n,children:a,...r},s)=>e.jsxs(Bt,{ref:s,className:J("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",n&&"pl-8",t),...r,children:[a,e.jsx(H,{name:"chevron-right",className:"ml-auto h-4 w-4"})]}));qn.displayName=Bt.displayName;const Wn=d.forwardRef(({className:t,...n},a)=>e.jsx(qt,{ref:a,className:J("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...n}));Wn.displayName=qt.displayName;const Gt=d.forwardRef(({className:t,align:n="start",alignOffset:a=-4,sideOffset:r=8,...s},o)=>e.jsx(Bn,{children:e.jsx(Rt,{ref:o,align:n,alignOffset:a,sideOffset:r,className:J("z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s})}));Gt.displayName=Rt.displayName;const Jt=d.forwardRef(({className:t,inset:n,...a},r)=>e.jsx($t,{ref:r,className:J("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",n&&"pl-8",t),...a}));Jt.displayName=$t.displayName;const Gn=d.forwardRef(({className:t,children:n,checked:a,...r},s)=>e.jsxs(Vt,{ref:s,className:J("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),checked:a,...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(zt,{children:e.jsx(H,{name:"check",className:"h-4 w-4"})})}),n]}));Gn.displayName=Vt.displayName;const Jn=d.forwardRef(({className:t,children:n,...a},r)=>e.jsxs(Ht,{ref:r,className:J("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(zt,{children:e.jsx(H,{name:"circle",className:"h-2 w-2 fill-current"})})}),n]}));Jn.displayName=Ht.displayName;const Kn=d.forwardRef(({className:t,inset:n,...a},r)=>e.jsx(Pt,{ref:r,className:J("px-2 py-1.5 text-sm font-semibold",n&&"pl-8",t),...a}));Kn.displayName=Pt.displayName;const Xn=d.forwardRef(({className:t,...n},a)=>e.jsx(Ut,{ref:a,className:J("-mx-1 my-1 h-px bg-muted",t),...n}));Xn.displayName=Ut.displayName;const T=jo()(bo(No((t,n)=>({...Lo,...Io(t,n)})))),Yn=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.pushSyncNodeQueue),s=T(i=>i.createOrUpdateFlowNode),o=d.useCallback(async(i,l)=>{try{if(!t)throw new Error("Session not found");if(!l.provider||!l.name)throw new Error("Provider and name are required");a(!0);const c=await I("LLM").findOne({where:{name:l.name,session_id:t}});return c?(r("LLM",{where:{source_type:"LLM",source_id:c.id}}),c):I("LLM").save({name:`${l.name}`,status:[z.WebLLM,z.Wllama].includes(l.provider)?ce.Started:ce.Loaded,session_id:t,provider:l.provider,metadata:JSON.stringify(l.metadata||{}),model_type:l.model_type||ka.LLM,parameters:l.parameters||void 0,encrypted:l.encrypted||void 0,...l}).then(async p=>{var u,m,h;return await s({source_id:p.id,source_type:"LLM",node_type:b.LLM,x:(u=i.position)==null?void 0:u.x,y:((m=i.position)==null?void 0:m.y)+(((h=i.measured)==null?void 0:h.height)||0)+30}),p})}finally{a(!1)}},[s,r,t]);return{loading:n,createLLM:o}};var Kt=1,Qn=.9,Zn=.8,er=.17,Ra=.1,Pa=.999,ar=.9999,tr=.99,sr=/[\\\/_+.#"@\[\(\{&]/,nr=/[\\\/_+.#"@\[\(\{&]/g,rr=/[\s-]/,Xt=/[\s-]/g;function $a(t,n,a,r,s,o,i){if(o===n.length)return s===t.length?Kt:tr;var l=`${s},${o}`;if(i[l]!==void 0)return i[l];for(var c=r.charAt(o),p=a.indexOf(c,s),u=0,m,h,g,f;p>=0;)m=$a(t,n,a,r,p+1,o+1,i),m>u&&(p===s?m*=Kt:sr.test(t.charAt(p-1))?(m*=Zn,g=t.slice(s,p-1).match(nr),g&&s>0&&(m*=Math.pow(Pa,g.length))):rr.test(t.charAt(p-1))?(m*=Qn,f=t.slice(s,p-1).match(Xt),f&&s>0&&(m*=Math.pow(Pa,f.length))):(m*=er,s>0&&(m*=Math.pow(Pa,p-s))),t.charAt(p)!==n.charAt(o)&&(m*=ar)),(m<Ra&&a.charAt(p-1)===r.charAt(o+1)||r.charAt(o+1)===r.charAt(o)&&a.charAt(p-1)!==r.charAt(o))&&(h=$a(t,n,a,r,p+1,o+2,i),h*Ra>m&&(m=h*Ra)),m>u&&(u=m),p=a.indexOf(c,p+1);return i[l]=u,u}function Yt(t){return t.toLowerCase().replace(Xt," ")}function ir(t,n,a){return t=a&&a.length>0?`${t+" "+a.join(" ")}`:t,$a(t,n,Yt(t),Yt(n),0,0,{})}var Ye='[cmdk-group=""]',Va='[cmdk-group-items=""]',or='[cmdk-group-heading=""]',Ha='[cmdk-item=""]',Qt=`${Ha}:not([aria-disabled="true"])`,za="cmdk-item-select",He="data-value",dr=(t,n,a)=>ir(t,n,a),Zt=d.createContext(void 0),Qe=()=>d.useContext(Zt),es=d.createContext(void 0),Ua=()=>d.useContext(es),as=d.createContext(void 0),ts=d.forwardRef((t,n)=>{let a=qe(()=>{var C,V;return{search:"",value:(V=(C=t.value)!=null?C:t.defaultValue)!=null?V:"",filtered:{count:0,items:new Map,groups:new Set}}}),r=qe(()=>new Set),s=qe(()=>new Map),o=qe(()=>new Map),i=qe(()=>new Set),l=ss(t),{label:c,children:p,value:u,onValueChange:m,filter:h,shouldFilter:g,loop:f,disablePointerSelection:x=!1,vimBindings:_=!0,...y}=t,k=Oe(),L=Oe(),w=Oe(),E=d.useRef(null),v=yr();ze(()=>{if(u!==void 0){let C=u.trim();a.current.value=C,j.emit()}},[u]),ze(()=>{v(6,P)},[]);let j=d.useMemo(()=>({subscribe:C=>(i.current.add(C),()=>i.current.delete(C)),snapshot:()=>a.current,setState:(C,V,R)=>{var O,N,F;if(!Object.is(a.current[C],V)){if(a.current[C]=V,C==="search")A(),B(),v(1,M);else if(C==="value"&&(R||v(5,P),((O=l.current)==null?void 0:O.value)!==void 0)){let Q=V??"";(F=(N=l.current).onValueChange)==null||F.call(N,Q);return}j.emit()}},emit:()=>{i.current.forEach(C=>C())}}),[]),$=d.useMemo(()=>({value:(C,V,R)=>{var O;V!==((O=o.current.get(C))==null?void 0:O.value)&&(o.current.set(C,{value:V,keywords:R}),a.current.filtered.items.set(C,U(V,R)),v(2,()=>{B(),j.emit()}))},item:(C,V)=>(r.current.add(C),V&&(s.current.has(V)?s.current.get(V).add(C):s.current.set(V,new Set([C]))),v(3,()=>{A(),B(),a.current.value||M(),j.emit()}),()=>{o.current.delete(C),r.current.delete(C),a.current.filtered.items.delete(C);let R=S();v(4,()=>{A(),(R==null?void 0:R.getAttribute("id"))===C&&M(),j.emit()})}),group:C=>(s.current.has(C)||s.current.set(C,new Set),()=>{o.current.delete(C),s.current.delete(C)}),filter:()=>l.current.shouldFilter,label:c||t["aria-label"],getDisablePointerSelection:()=>l.current.disablePointerSelection,listId:k,inputId:w,labelId:L,listInnerRef:E}),[]);function U(C,V){var R,O;let N=(O=(R=l.current)==null?void 0:R.filter)!=null?O:dr;return C?N(C,a.current.search,V):0}function B(){if(!a.current.search||l.current.shouldFilter===!1)return;let C=a.current.filtered.items,V=[];a.current.filtered.groups.forEach(O=>{let N=s.current.get(O),F=0;N.forEach(Q=>{let te=C.get(Q);F=Math.max(te,F)}),V.push([O,F])});let R=E.current;D().sort((O,N)=>{var F,Q;let te=O.getAttribute("id"),Ce=N.getAttribute("id");return((F=C.get(Ce))!=null?F:0)-((Q=C.get(te))!=null?Q:0)}).forEach(O=>{let N=O.closest(Va);N?N.appendChild(O.parentElement===N?O:O.closest(`${Va} > *`)):R.appendChild(O.parentElement===R?O:O.closest(`${Va} > *`))}),V.sort((O,N)=>N[1]-O[1]).forEach(O=>{var N;let F=(N=E.current)==null?void 0:N.querySelector(`${Ye}[${He}="${encodeURIComponent(O[0])}"]`);F==null||F.parentElement.appendChild(F)})}function M(){let C=D().find(R=>R.getAttribute("aria-disabled")!=="true"),V=C==null?void 0:C.getAttribute(He);j.setState("value",V||void 0)}function A(){var C,V,R,O;if(!a.current.search||l.current.shouldFilter===!1){a.current.filtered.count=r.current.size;return}a.current.filtered.groups=new Set;let N=0;for(let F of r.current){let Q=(V=(C=o.current.get(F))==null?void 0:C.value)!=null?V:"",te=(O=(R=o.current.get(F))==null?void 0:R.keywords)!=null?O:[],Ce=U(Q,te);a.current.filtered.items.set(F,Ce),Ce>0&&N++}for(let[F,Q]of s.current)for(let te of Q)if(a.current.filtered.items.get(te)>0){a.current.filtered.groups.add(F);break}a.current.filtered.count=N}function P(){var C,V,R;let O=S();O&&(((C=O.parentElement)==null?void 0:C.firstChild)===O&&((R=(V=O.closest(Ye))==null?void 0:V.querySelector(or))==null||R.scrollIntoView({block:"nearest"})),O.scrollIntoView({block:"nearest"}))}function S(){var C;return(C=E.current)==null?void 0:C.querySelector(`${Ha}[aria-selected="true"]`)}function D(){var C;return Array.from(((C=E.current)==null?void 0:C.querySelectorAll(Qt))||[])}function q(C){let V=D()[C];V&&j.setState("value",V.getAttribute(He))}function Y(C){var V;let R=S(),O=D(),N=O.findIndex(Q=>Q===R),F=O[N+C];(V=l.current)!=null&&V.loop&&(F=N+C<0?O[O.length-1]:N+C===O.length?O[0]:O[N+C]),F&&j.setState("value",F.getAttribute(He))}function ee(C){let V=S(),R=V==null?void 0:V.closest(Ye),O;for(;R&&!O;)R=C>0?xr(R,Ye):_r(R,Ye),O=R==null?void 0:R.querySelector(Qt);O?j.setState("value",O.getAttribute(He)):Y(C)}let we=()=>q(D().length-1),_e=C=>{C.preventDefault(),C.metaKey?we():C.altKey?ee(1):Y(1)},ne=C=>{C.preventDefault(),C.metaKey?q(0):C.altKey?ee(-1):Y(-1)};return d.createElement(Ee.div,{ref:n,tabIndex:-1,...y,"cmdk-root":"",onKeyDown:C=>{var V;if((V=y.onKeyDown)==null||V.call(y,C),!C.defaultPrevented)switch(C.key){case"n":case"j":{_&&C.ctrlKey&&_e(C);break}case"ArrowDown":{_e(C);break}case"p":case"k":{_&&C.ctrlKey&&ne(C);break}case"ArrowUp":{ne(C);break}case"Home":{C.preventDefault(),q(0);break}case"End":{C.preventDefault(),we();break}case"Enter":if(!C.nativeEvent.isComposing&&C.keyCode!==229){C.preventDefault();let R=S();if(R){let O=new Event(za);R.dispatchEvent(O)}}}}},d.createElement("label",{"cmdk-label":"",htmlFor:$.inputId,id:$.labelId,style:wr},c),ca(t,C=>d.createElement(es.Provider,{value:j},d.createElement(Zt.Provider,{value:$},C))))}),lr=d.forwardRef((t,n)=>{var a,r;let s=Oe(),o=d.useRef(null),i=d.useContext(as),l=Qe(),c=ss(t),p=(r=(a=c.current)==null?void 0:a.forceMount)!=null?r:i==null?void 0:i.forceMount;ze(()=>{if(!p)return l.item(s,i==null?void 0:i.id)},[p]);let u=ns(s,o,[t.value,t.children,o],t.keywords),m=Ua(),h=Ue(v=>v.value&&v.value===u.current),g=Ue(v=>p||l.filter()===!1?!0:v.search?v.filtered.items.get(s)>0:!0);d.useEffect(()=>{let v=o.current;if(!(!v||t.disabled))return v.addEventListener(za,f),()=>v.removeEventListener(za,f)},[g,t.onSelect,t.disabled]);function f(){var v,j;x(),(j=(v=c.current).onSelect)==null||j.call(v,u.current)}function x(){m.setState("value",u.current,!0)}if(!g)return null;let{disabled:_,value:y,onSelect:k,forceMount:L,keywords:w,...E}=t;return d.createElement(Ee.div,{ref:Ze([o,n]),...E,id:s,"cmdk-item":"",role:"option","aria-disabled":!!_,"aria-selected":!!h,"data-disabled":!!_,"data-selected":!!h,onPointerMove:_||l.getDisablePointerSelection()?void 0:x,onClick:_?void 0:f},t.children)}),cr=d.forwardRef((t,n)=>{let{heading:a,children:r,forceMount:s,...o}=t,i=Oe(),l=d.useRef(null),c=d.useRef(null),p=Oe(),u=Qe(),m=Ue(g=>s||u.filter()===!1?!0:g.search?g.filtered.groups.has(i):!0);ze(()=>u.group(i),[]),ns(i,l,[t.value,t.heading,c]);let h=d.useMemo(()=>({id:i,forceMount:s}),[s]);return d.createElement(Ee.div,{ref:Ze([l,n]),...o,"cmdk-group":"",role:"presentation",hidden:m?void 0:!0},a&&d.createElement("div",{ref:c,"cmdk-group-heading":"","aria-hidden":!0,id:p},a),ca(t,g=>d.createElement("div",{"cmdk-group-items":"",role:"group","aria-labelledby":a?p:void 0},d.createElement(as.Provider,{value:h},g))))}),ur=d.forwardRef((t,n)=>{let{alwaysRender:a,...r}=t,s=d.useRef(null),o=Ue(i=>!i.search);return!a&&!o?null:d.createElement(Ee.div,{ref:Ze([s,n]),...r,"cmdk-separator":"",role:"separator"})}),mr=d.forwardRef((t,n)=>{let{onValueChange:a,...r}=t,s=t.value!=null,o=Ua(),i=Ue(u=>u.search),l=Ue(u=>u.value),c=Qe(),p=d.useMemo(()=>{var u;let m=(u=c.listInnerRef.current)==null?void 0:u.querySelector(`${Ha}[${He}="${encodeURIComponent(l)}"]`);return m==null?void 0:m.getAttribute("id")},[]);return d.useEffect(()=>{t.value!=null&&o.setState("search",t.value)},[t.value]),d.createElement(Ee.input,{ref:n,...r,"cmdk-input":"",autoComplete:"off",autoCorrect:"off",spellCheck:!1,"aria-autocomplete":"list",role:"combobox","aria-expanded":!0,"aria-controls":c.listId,"aria-labelledby":c.labelId,"aria-activedescendant":p,id:c.inputId,type:"text",value:s?t.value:i,onChange:u=>{s||o.setState("search",u.target.value),a==null||a(u.target.value)}})}),pr=d.forwardRef((t,n)=>{let{children:a,label:r="Suggestions",...s}=t,o=d.useRef(null),i=d.useRef(null),l=Qe();return d.useEffect(()=>{if(i.current&&o.current){let c=i.current,p=o.current,u,m=new ResizeObserver(()=>{u=requestAnimationFrame(()=>{let h=c.offsetHeight;p.style.setProperty("--cmdk-list-height",h.toFixed(1)+"px")})});return m.observe(c),()=>{cancelAnimationFrame(u),m.unobserve(c)}}},[]),d.createElement(Ee.div,{ref:Ze([o,n]),...s,"cmdk-list":"",role:"listbox","aria-label":r,id:l.listId},ca(t,c=>d.createElement("div",{ref:Ze([i,l.listInnerRef]),"cmdk-list-sizer":""},c)))}),hr=d.forwardRef((t,n)=>{let{open:a,onOpenChange:r,overlayClassName:s,contentClassName:o,container:i,...l}=t;return d.createElement(Ed,{open:a,onOpenChange:r},d.createElement(kd,{container:i},d.createElement(Md,{"cmdk-overlay":"",className:s}),d.createElement(Dd,{"aria-label":t.label,"cmdk-dialog":"",className:o},d.createElement(ts,{ref:n,...l}))))}),fr=d.forwardRef((t,n)=>Ue(a=>a.filtered.count===0)?d.createElement(Ee.div,{ref:n,...t,"cmdk-empty":"",role:"presentation"}):null),gr=d.forwardRef((t,n)=>{let{progress:a,children:r,label:s="Loading...",...o}=t;return d.createElement(Ee.div,{ref:n,...o,"cmdk-loading":"",role:"progressbar","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":100,"aria-label":s},ca(t,i=>d.createElement("div",{"aria-hidden":!0},i)))}),ue=Object.assign(ts,{List:pr,Item:lr,Input:mr,Group:cr,Separator:ur,Dialog:hr,Empty:fr,Loading:gr});function xr(t,n){let a=t.nextElementSibling;for(;a;){if(a.matches(n))return a;a=a.nextElementSibling}}function _r(t,n){let a=t.previousElementSibling;for(;a;){if(a.matches(n))return a;a=a.previousElementSibling}}function ss(t){let n=d.useRef(t);return ze(()=>{n.current=t}),n}var ze=typeof window>"u"?d.useEffect:d.useLayoutEffect;function qe(t){let n=d.useRef();return n.current===void 0&&(n.current=t()),n}function Ze(t){return n=>{t.forEach(a=>{typeof a=="function"?a(n):a!=null&&(a.current=n)})}}function Ue(t){let n=Ua(),a=()=>t(n.snapshot());return sl.useSyncExternalStore(n.subscribe,a,a)}function ns(t,n,a,r=[]){let s=d.useRef(),o=Qe();return ze(()=>{var i;let l=(()=>{var p;for(let u of a){if(typeof u=="string")return u.trim();if(typeof u=="object"&&"current"in u)return u.current?(p=u.current.textContent)==null?void 0:p.trim():s.current}})(),c=r.map(p=>p.trim());o.value(t,l,c),(i=n.current)==null||i.setAttribute(He,l),s.current=l}),s}var yr=()=>{let[t,n]=d.useState(),a=qe(()=>new Map);return ze(()=>{a.current.forEach(r=>r()),a.current=new Map},[t]),(r,s)=>{a.current.set(r,s),n({})}};function vr(t){let n=t.type;return typeof n=="function"?n(t.props):"render"in n?n.render(t.props):t}function ca({asChild:t,children:n},a){return t&&d.isValidElement(n)?d.cloneElement(vr(n),{ref:n.ref},a(n.props.children)):a(n)}var wr={position:"absolute",width:"1px",height:"1px",padding:"0",margin:"-1px",overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",borderWidth:"0"};const Ba=d.forwardRef(({className:t,...n},a)=>e.jsx(ue,{ref:a,className:J("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...n}));Ba.displayName=ue.displayName;const qa=d.forwardRef(({className:t,...n},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(H,{name:"search",className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(ue.Input,{ref:a,className:J("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...n})]}));qa.displayName=ue.Input.displayName;const Wa=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.List,{ref:a,className:J("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...n}));Wa.displayName=ue.List.displayName;const Ga=d.forwardRef((t,n)=>e.jsx(ue.Empty,{ref:n,className:"py-6 text-center text-sm",...t}));Ga.displayName=ue.Empty.displayName;const Ja=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.Group,{ref:a,className:J("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...n}));Ja.displayName=ue.Group.displayName;const jr=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.Separator,{ref:a,className:J("-mx-1 h-px bg-border",t),...n}));jr.displayName=ue.Separator.displayName;const ea=d.forwardRef(({className:t,...n},a)=>e.jsx(ue.Item,{ref:a,className:J("relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",t),...n}));ea.displayName=ue.Item.displayName;const Ka=d.forwardRef(({className:t,...n},a)=>e.jsx(pn,{ref:a,className:J("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...n,children:e.jsx(nl,{className:J("flex items-center justify-center text-current"),children:e.jsx(H,{name:"check",className:"h-4 w-4"})})}));Ka.displayName=pn.displayName;const br=["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo"],Nr=["deepseek-r1-distill-llama-70b","llama-3.2-90b-vision-preview","llama-3.3-70b-versatile","llama-3.3-70b-specdec","llama3-70b-8192","gemma2-9b-it","llama3-8b-8192","mixtral-8x7b-32768"],Cr=["llama-3.2-90b-vision-preview"],Sr=["gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-1.5-flash-8b"],ua="https://aistudio.google.com/app/apikey",ma="https://platform.openai.com/api-keys",rs="https://console.groq.com/keys",Er=[z.WebLLM,z.Wllama,z.OpenAI,z.GoogleGenerativeAI,z.Groq],kr=ga(({onConfirm:t,onCancel:n})=>{const a=Te(),{t:r}=G("dialogs"),[s,o]=d.useState(""),i=p=>{o(p)},l=async()=>{try{if((s==null?void 0:s.length)!==6)return;await(t==null?void 0:t(s)),o(""),a.resolve(!0),a.hide()}catch(p){a.reject(p)}},c=()=>{n==null||n(),o(""),a.resolve(!1),a.hide()};return e.jsx(ja,{open:a.visible,onOpenChange:c,children:e.jsxs(ba,{className:"w-[330px]",children:[e.jsxs(Na,{children:[e.jsx(Ca,{children:r("create_session_passkey.title")}),e.jsx(Zs,{children:r("create_session_passkey.description")})]}),e.jsx("div",{className:"py-4",children:e.jsxs(Ud,{onChange:i,maxLength:6,children:[e.jsxs(ln,{children:[e.jsx(Xe,{index:0,hidden:!0}),e.jsx(Xe,{index:1,hidden:!0}),e.jsx(Xe,{index:2,hidden:!0})]}),e.jsx(Bd,{}),e.jsxs(ln,{children:[e.jsx(Xe,{index:3,hidden:!0}),e.jsx(Xe,{index:4,hidden:!0}),e.jsx(Xe,{index:5,hidden:!0})]})]})}),e.jsx(en,{children:e.jsx(Z,{disabled:(s==null?void 0:s.length)!==6,onClick:l,type:"submit",children:r("create_session_passkey.confirm")})})]})})}),Mr=()=>{const[t,n]=d.useState(!1),a=ae(o=>o.currentSession),r=ae(o=>o.setCurrentSession),s=d.useCallback(async o=>{if(!(!a||!o))try{n(!0);const i=await qd(),l=await cn(i,o);await I("Session").update(a.id,{passphrase:l});const c=await I("Session").findOne({where:{id:a.id}});return c&&r(c),{passphrase:i,encrypted:l}}finally{n(!1)}},[a,r]);return{loading:t,updateSessionPassphrase:s}},is=()=>{const t=ae(s=>s.currentSession),{modalRef:n}=Wd(kr),{updateSessionPassphrase:a}=Mr(),{confirmPassphrase:r}=un();return{confirmOrCreatePassphrase:d.useCallback(async()=>{if(t!=null&&t.passphrase)await r();else{let s="";if(await n.current.show({onConfirm:async i=>{s=i}}),!s)throw new Error("Passphrase is required");const o=await a(s);if(!o)throw new Error("Failed to update session passphrase");await Sa.set("passphrase",o.passphrase)}return Sa.get("passphrase")},[r,n,t==null?void 0:t.passphrase,a])}};function Dr(t){var R,O;const{id:n,setDialog:a}=t,{t:r}=G("components"),{toast:s}=ye(),o=oe(n),[i,l]=d.useState(!1),[c,p]=d.useState(""),[u,m]=d.useState(!1),[h,g]=d.useState(""),[f,x]=d.useState(),[_,y]=d.useState(z.WebLLM),[k,L]=d.useState(!1),[w,E]=d.useState(),v=d.useRef(),j=ae(N=>N.currentSession),$=ia(N=>N.syncCachedLLMURLs),U=ia(N=>N.cachedLLMURLs),{loading:B,createLLM:M}=Yn();v.current=w;const{confirmOrCreatePassphrase:A}=is();d.useEffect(()=>{$()},[$]);const P=d.useMemo(()=>c?![z.WebLLM,z.Wllama].includes(_):!1,[c,_]),S=d.useMemo(()=>!(w!=null&&w.functionCallingModelIds)||!(w!=null&&w.modelList)?[]:((h?w==null?void 0:w.modelList.filter(N=>N.model_id.toLowerCase().includes(h.toLowerCase())):w==null?void 0:w.modelList)||[]).sort((N,F)=>{const Q=U.some(Za=>Za.includes(N.model_id)),te=U.some(Za=>Za.includes(F.model_id));if(Q&&!te)return-1;if(!Q&&te)return 1;const Ce=Hs.includes(N.model_id),Se=Hs.includes(F.model_id);if(Ce&&!Se)return-1;if(!Ce&&Se)return 1;const Ls=w==null?void 0:w.functionCallingModelIds.includes(N.model_id),Is=w==null?void 0:w.functionCallingModelIds.includes(F.model_id);return Ls&&!Is?-1:!Ls&&Is?1:N.vram_required_MB&&F.vram_required_MB&&N.vram_required_MB!==F.vram_required_MB?N.vram_required_MB-F.vram_required_MB:N.model_id.localeCompare(F.model_id)}),[w==null?void 0:w.modelList,w==null?void 0:w.functionCallingModelIds,h,U]),D=d.useMemo(()=>{if(c)switch(_){case z.Wllama:return w==null?void 0:w.modelList.find(N=>N.model_id===c);case z.WebLLM:return(w==null?void 0:w.modelList)&&S.find(N=>N.model_id===c);case z.Groq:return x({}),{model:c,model_id:c,model_type:Cr.includes(c)?2:0,overrides:{}};case z.OpenAI:return x({}),{model:c,model_id:c,model_type:2,overrides:{}};case z.GoogleGenerativeAI:return x({}),{model:c,model_id:c,model_type:2,overrides:{}}}},[c,w==null?void 0:w.modelList,S,_]);d.useEffect(()=>{!(D!=null&&D.model_id)||!U||L(U.some(N=>N.includes(D.model_id)))},[U,D==null?void 0:D.model_id]),d.useEffect(()=>{j!=null&&j.id&&(y(z.WebLLM),p(""),g(""),x({}))},[j==null?void 0:j.id]);const q=d.useCallback(N=>{p(N),m(!1)},[]),Y=d.useCallback(N=>{g(N)},[]),ee=d.useCallback(N=>{y(N),p(""),g(""),x({})},[]),we=async()=>{var N;if(!(!o||!j))try{l(!0);let F;if(P){const Q=await A();if(!Q)throw new Error("Passphrase is not found");F=await Gd(f||{},Q)}await M(o,{name:c,model_type:_e(D==null?void 0:D.model_type),function_calling:D!=null&&D.model_id?(N=w==null?void 0:w.functionCallingModelIds)==null?void 0:N.includes(D==null?void 0:D.model_id):!1,encrypted:F,provider:_}),a==null||a(!1)}catch(F){xa("Create LLM",F),s({variant:"destructive",description:r("add_llm_card.errors.failed_to_create")})}finally{l(!1),y(z.WebLLM),x({}),p(""),g("")}};d.useLayoutEffect(()=>{(async()=>{var N;try{if(_===z.Wllama){const[F,Q]=(c==null?void 0:c.split("/"))||[],te=`${F}/${Q}`;if(!c||!F||!Q){E({modelList:[],functionCallingModelIds:[]});return}else if(((N=v.current)==null?void 0:N.input)===te)return;const Ce=await(await fetch(`https://huggingface.co/api/models/${te}`)).json();Ce.siblings?E({input:te,modelList:Ce.siblings.map(Se=>Se.rfilename).filter(Se=>Se.endsWith(".gguf")).map(Se=>({model_id:`${te}/${Se}`,model:`${te}/${Se}`,model_lib:`${te}/${Se}`,model_type:0,overrides:{}})),functionCallingModelIds:[]}):E({modelList:[],functionCallingModelIds:[]})}else _===z.WebLLM&&ve(()=>import("./index-BFbnGzju.js").then(async F=>(await F.__tla,F)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({functionCallingModelIds:F,prebuiltAppConfig:Q})=>{const te=Q.model_list;E({modelList:te,functionCallingModelIds:F})})}catch{}})()},[_,c]);const _e=d.useCallback(N=>N===1?ka.embedding:N===2?ka.VLM:ka.LLM,[]),ne=d.useMemo(()=>{switch(_){case z.Wllama:case z.WebLLM:return S.map(N=>{var F;return e.jsxs(ea,{value:N.model_id,onSelect:q,children:[c===N.model_id?e.jsx(H,{name:"check",className:"mr-2 h-4 w-4"}):e.jsx("div",{className:"mr-2 h-4 w-4"}),e.jsxs("span",{className:"max-w-md",children:[e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx(Ve,{name:N.model_id}),N.model_id]}),e.jsx("div",{className:"flex max-w-full flex-wrap gap-1",children:e.jsx(_a,{model:N,isFunctionCalling:((F=w==null?void 0:w.functionCallingModelIds)==null?void 0:F.includes(N.model_id))||!1,name:N.model_id,isCached:U.some(Q=>Q.includes(N.model_id))||!1,cloud:_!==z.WebLLM})})]})]},N.model_id)});case z.OpenAI:return br.map(N=>e.jsxs(ea,{value:N,onSelect:q,children:[c===N?e.jsx(H,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ve,{name:N}),N]})})]},N));case z.GoogleGenerativeAI:return Sr.map(N=>e.jsxs(ea,{value:N,onSelect:q,children:[c===N?e.jsx(H,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ve,{name:N}),N]})})]},N));case z.Groq:return Nr.map(N=>e.jsxs(ea,{value:N,onSelect:q,children:[c===N?e.jsx(H,{name:"check",className:"h-4 w-4"}):e.jsx("div",{className:"w-4"}),e.jsx("span",{className:"max-w-md",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(Ve,{name:N}),N]})})]},N))}},[U,q,c,w==null?void 0:w.functionCallingModelIds,S,_]),C=d.useMemo(()=>{if(_===z.Wllama){const[N,F]=(c==null?void 0:c.split("/"))||[];return e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"default",className:"mb-4",children:r("add_llm_card.wllama_description")}),e.jsx(W,{children:r("add_llm_card.hugging_face_repo")}),N&&F?e.jsxs("div",{className:"relative",children:[e.jsx(re,{value:`${N}/${F}`,disabled:!0,placeholder:r("add_llm_card.hugging_face_repo_placeholder")}),e.jsx(H,{onClick:()=>p(""),name:"x",className:"h-4 w-4 absolute right-3 top-3 cursor-pointer"})]}):e.jsx(re,{value:N?`${N}/${F}`:"",onChange:Q=>p(Q.target.value),placeholder:r("add_llm_card.hugging_face_repo_placeholder")}),e.jsx(W,{children:r("add_llm_card.model_name")}),e.jsxs(mt,{open:u,onOpenChange:m,children:[e.jsx(mn,{asChild:!0,children:e.jsxs(Z,{variant:"outline",role:"combobox","aria-expanded":u,disabled:!N||!F,className:"w-full justify-between max-w-full overflow-hidden",children:[c&&D?D==null?void 0:D.model_id:r("add_llm_card.select_model_placeholder"),e.jsx(H,{name:"chevrons-up-down",className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(pt,{className:"w-full p-0",children:e.jsxs(Ba,{children:[e.jsx(qa,{onValueChange:Y,placeholder:r("add_llm_card.search_placeholder")}),e.jsxs(Wa,{children:[e.jsx(Ga,{children:r("add_llm_card.no_model")}),e.jsx(Ja,{children:ne})]})]})})]})]})}return e.jsxs(e.Fragment,{children:[e.jsx(W,{children:r("add_llm_card.model_name")}),e.jsxs(mt,{open:u,onOpenChange:m,children:[e.jsx(mn,{asChild:!0,children:e.jsxs(Z,{variant:"outline",role:"combobox","aria-expanded":u,className:"w-full justify-between",children:[c?D==null?void 0:D.model_id:r("add_llm_card.select_model_placeholder"),e.jsx(H,{name:"chevrons-up-down",className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(pt,{className:"w-full p-0",children:e.jsxs(Ba,{children:[e.jsx(qa,{onValueChange:Y,placeholder:r("add_llm_card.search_placeholder")}),e.jsxs(Wa,{children:[e.jsx(Ga,{children:r("add_llm_card.no_model")}),e.jsx(Ja,{children:ne})]})]})})]})]})},[c,_,ne,u,m,Y]),V=d.useMemo(()=>{if(P)switch(_){case z.Groq:case z.OpenAI:return e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"destructive",className:"mt-4",children:r("add_llm_card.alert.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(W,{children:r("add_llm_card.encrypted_fields.api_key")}),e.jsx(Z,{variant:"link",className:"px-1",children:e.jsxs("a",{href:_===z.OpenAI?ma:rs,target:"_blank",rel:"noreferrer",children:["(",_===z.OpenAI?ma:rs,")"]})}),e.jsx(re,{type:"password",value:(f==null?void 0:f.key)||"",onChange:N=>x(F=>({...F,key:N.target.value}))})]})]});case z.GoogleGenerativeAI:return e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"destructive",className:"mt-4",children:r("add_llm_card.alert.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(W,{children:r("add_llm_card.encrypted_fields.api_key")}),e.jsx(Z,{variant:"link",className:"px-1",children:e.jsxs("a",{href:ua,target:"_blank",rel:"noreferrer",children:["(",ua,")"]})}),e.jsx(re,{type:"password",value:(f==null?void 0:f.key)||"",onChange:N=>x(F=>({...F,key:N.target.value}))})]}),e.jsxs("div",{className:"mt-4 flex items-center",children:[e.jsx(W,{children:r("add_llm_card.encrypted_fields.enabled_google_search_retreival")}),e.jsx(Ka,{checked:!!(f!=null&&f.enabled_google_search_retreival),className:"ml-2",onCheckedChange:N=>{x(F=>({...F,enabled_google_search_retreival:N?"true":""}))}})]})]})}},[P,_,r,f]);return e.jsxs(se,{className:"max-w-lg",children:[e.jsx(de,{children:e.jsx(he,{children:r("add_llm_card.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"grid w-full gap-1.5",children:[e.jsx(W,{children:r("add_llm_card.provider")}),e.jsxs(De,{value:_,onValueChange:ee,children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:r("add_llm_card.provider_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Er).map(N=>e.jsx(fe,{value:N,children:r(`add_llm_card.providers.${N.toLowerCase()}`)},N))})]}),C]}),D?e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"mt-4 text-sm text-muted-foreground center flex max-w-full flex-wrap gap-1",children:[e.jsx(Ve,{name:D.model_id,className:"mr-2"}),e.jsx(_a,{model:D,isFunctionCalling:((R=w==null?void 0:w.functionCallingModelIds)==null?void 0:R.includes(D.model_id))||!1,name:D.model_id,isCached:U.some(N=>N.includes(D.model_id))||!1,cloud:![z.WebLLM,z.Wllama].includes(_)})]}),e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.model_url")}),D.model]}),D.model_lib?e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground center flex",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.model_lib_url")}),D.model_lib]}):void 0,D.overrides&&((O=Object.keys(D.overrides))!=null&&O.length)?e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground center flex",children:[e.jsx("span",{className:"font-bold mr-2",children:r("add_llm_card.metadata")}),JSON.stringify(D.overrides)]}):void 0]}):null,V]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:B||i,disabled:!(c!=null&&c.length),onClick:we,className:"w-full",children:r(k?"add_llm_card.button_add":"add_llm_card.button_download_and_add")})})]})}const os=()=>{const t=ae(o=>{var i;return(i=o.currentSession)==null?void 0:i.id}),[n,a]=d.useState(!1),r=T(o=>o.createOrUpdateFlowNode),s=d.useCallback(async(o,i)=>{var l,c,p;try{if(!o||!t)throw new Error("Source or Session not found");a(!0);const u=((l=o.position)==null?void 0:l.x)||0,m=(((c=o.position)==null?void 0:c.y)||0)+(((p=o.measured)==null?void 0:p.height)||0),h=await I("Prompt").save({content:i.content,prefix:i.prefix,role:i.role||ge.System,status:be.Started,session_id:t,type:i.type||xe.Chat});if(!h)throw new Error("Failed to save prompt");if(!await r({source_id:h.id,source_type:"Prompt",node_type:b.Prompt,x:u,y:m+20}))throw new Error("Failed to save prompt node")}finally{a(!1)}},[t,r]);return{loading:n,createPrompt:s}},Lr={[xe.Chat]:{label:"add_prompt_card.prompt_types.chat",value:xe.Chat},[xe.FewShotExample]:{label:"add_prompt_card.prompt_types.few_shot_example",value:xe.FewShotExample}},Ir={[ge.System]:{label:"add_prompt_card.prompt_roles.system",value:ge.System},[ge.Human]:{label:"add_prompt_card.prompt_roles.human",value:ge.Human},[ge.AI]:{label:"add_prompt_card.prompt_roles.ai",value:ge.AI}},Xa=d.memo(({defaultPromptContent:t,defaultPromptRole:n,defaultPromptType:a,hidePromptRole:r,hidePromptType:s,loading:o,onSubmit:i})=>{const[l,c]=d.useState(t||""),[p,u]=d.useState(a||xe.Chat),[m,h]=d.useState(n),[g,f]=d.useState(""),{t:x}=G("components"),_=d.useCallback(E=>{c(E.target.value)},[]),y=d.useCallback(E=>{f(E.target.value)},[]),k=d.useCallback(E=>{E===xe.FewShotExample&&c(`Question: {input}
Answer: {output}`),u(E)},[]),L=d.useCallback(E=>{h(E)},[]),w=async()=>{await i({content:l,role:m,prefix:g,type:p})&&(c(""),h(void 0),u("chat"),f(""))};return e.jsxs("div",{children:[e.jsxs("div",{className:"grid w-full gap-1.5",children:[s?void 0:e.jsxs(e.Fragment,{children:[e.jsx(W,{children:x("add_prompt_card.prompt_type")}),e.jsxs(De,{value:p,onValueChange:k,children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:x("add_prompt_card.type_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Lr).map(E=>e.jsx(fe,{value:E.value,children:x(E.label)},E.value))})]})]}),r?void 0:e.jsxs(e.Fragment,{children:[e.jsx(W,{children:x("add_prompt_card.prompt_role")}),e.jsxs(De,{value:m,onValueChange:L,children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:x("add_prompt_card.role_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Ir).map(E=>e.jsx(fe,{value:E.value,children:x(E.label)},E.value))})]})]}),p===xe.FewShotExample&&e.jsxs(e.Fragment,{children:[e.jsx(W,{children:x("add_prompt_card.prompt_prefix")}),e.jsx(oa,{value:g,onChange:y,disabled:!1,className:"h-20",placeholder:x("add_prompt_card.placeholder"),id:"message"}),e.jsx(W,{children:x("add_prompt_card.prompt_content")}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm justify-end items-center",children:[e.jsx(H,{name:"info",className:"mr-2",size:14}),x("add_prompt_card.few_shot_example_note")]})]}),e.jsx(oa,{value:l,onChange:_,disabled:!1,placeholder:x("add_prompt_card.placeholder"),id:"message"})]}),e.jsx("div",{children:e.jsx(Fe,{loading:o,disabled:!(l!=null&&l.length),onClick:w,className:"w-full mt-4",children:x("add_prompt_card.button")})})]})}),Ar=d.memo(t=>{const{id:n,thread:a,setDialog:r}=t,{t:s}=G("components"),{toast:o}=ye(),i=oe(n),{createPrompt:l,loading:c}=os(),p=async u=>{if(i)try{if(!(u!=null&&u.content))throw new Error("Prompt data is missing");await l(i,{...u,content:u.content,thread:a}),r==null||r(!1)}catch(m){o({variant:"destructive",title:`${m}`})}};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:s("add_prompt_card.title")})}),e.jsx(le,{children:e.jsx(Xa,{onSubmit:p,loading:c,defaultPromptRole:"system",defaultPromptType:"chat"})})]})}),Or=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=d.useCallback((i,l,c,p)=>{var u;if(t){for(const m of l)(u=m.data)!=null&&u.length?s(i,m.data,c,m.id):c.push({name:m.name,type:m.type,enum:m.enum?JSON.stringify(m.enum):"",required:m.required,description:m.description,id:m.id||it(),parent_id:p,schema_id:i,session_id:t});return c}},[t]),o=d.useCallback(async(i,l)=>{var c,p,u;try{if(!i||!t)throw new Error("Source or Session not found");a(!0);const m=((c=i.position)==null?void 0:c.x)||0,h=(((p=i.position)==null?void 0:p.y)||0)+(((u=i.measured)==null?void 0:u.height)||0),g=await I("Schema").save({name:"Untitled Schema",session_id:t});if(!g)throw new Error("Failed to save schema");const f=s(g.id,l,[],void 0);if(!(f!=null&&f.length))throw new Error("Failed to convert schema items");if(await I("SchemaItem").save(f),!await r({source_id:g.id,source_type:"Schema",node_type:b.Schema,x:m,y:h+20}))throw new Error("Failed to save schema node")}finally{a(!1)}},[t,s,r]);return{loading:n,createSchema:o}},ds=d.memo(({setData:t,data:n,id:a})=>{const{t:r}=G("components"),[s,o]=d.useState({name:"",description:"",type:"string",required:!1,data:[]}),i=d.useMemo(()=>a&&n.find(x=>x.id===a)||s,[n,s,a]),l=d.useCallback(x=>{x.target.value&&!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(x.target.value)||(a?t(_=>[..._.map(y=>y.id===a?{...y,name:x.target.value||""}:y)]):o(_=>({..._,name:x.target.value||""})))},[a,t]),c=d.useCallback(x=>{a?t(_=>[..._.map(y=>y.id===a?{...y,description:x.target.value||""}:y)]):o(_=>({..._,description:x.target.value||""}))},[a,t]),p=d.useCallback(x=>{a?t(_=>[..._.map(y=>y.id===a?{...y,type:x||""}:y)]):o(_=>({..._,type:x||"string"}))},[a,t]),u=d.useCallback(x=>{a?t(_=>[..._.map(y=>y.id===a?{...y,required:!!x||!1}:y)]):o(_=>({..._,required:!!x||!1}))},[a,t]),m=d.useCallback(x=>{a?t(_=>[..._.map(y=>y.id===a?{...y,enum:x.target.value||""}:y)]):o(_=>({..._,enum:x.target.value||""}))},[a,t]),h=d.useCallback(()=>{if(n.find(x=>x.name===s.name))return We({variant:"destructive",content:"Name already exists"});s.id=it(),t(x=>[...x,{...s}]),o({name:"",description:"",type:"string",required:!1,id:it(),parent:a||void 0,data:[]})},[n,s,t,a]),g=d.useCallback(x=>{t(_=>[..._.map(y=>y.id===a?{...y,data:x(y.data||[])}:y)])},[a,t]),f=["object","array"].includes(i.type);return e.jsxs("div",{className:"w-full p-1",children:[e.jsxs("div",{children:[e.jsx(W,{children:r("add_schema_card.field.name")}),e.jsx(re,{id:"name",onChange:l,placeholder:r("add_schema_card.field.name_placeholder"),value:(i==null?void 0:i.name)||""})]}),e.jsxs("div",{children:[e.jsx(W,{children:r("add_schema_card.field.description")}),e.jsx(re,{id:"description",placeholder:r("add_schema_card.field.description_placeholder"),onChange:c,value:(i==null?void 0:i.description)||""})]}),e.jsxs("div",{children:[e.jsx(W,{children:r("add_schema_card.field.type")}),e.jsxs(De,{onValueChange:p,value:(i==null?void 0:i.type)||"",children:[e.jsx(Le,{children:e.jsx(Ie,{placeholder:r("add_schema_card.field.type_placeholder")})}),e.jsxs(Ae,{children:[e.jsx(fe,{value:"string",children:r("add_schema_card.types.string")}),e.jsx(fe,{value:"boolean",children:r("add_schema_card.types.boolean")}),e.jsx(fe,{value:"number",children:r("add_schema_card.types.number")}),e.jsx(fe,{value:"object",children:r("add_schema_card.types.object")}),e.jsx(fe,{value:"array",children:r("add_schema_card.types.array")})]})]})]}),e.jsxs("div",{className:"flex items-center h-10",children:[e.jsx(W,{children:r("add_schema_card.field.required")}),e.jsx(Ka,{className:"ml-2","aria-label":"Select row",onCheckedChange:u,checked:i==null?void 0:i.required})]}),f?e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx(W,{children:r("add_schema_card.children")}),e.jsx(ls,{data:(i==null?void 0:i.data)||[],setData:g})]}):null,(i==null?void 0:i.type)==="enum"?e.jsxs("div",{className:"mt-2 flex flex-col gap-2",children:[e.jsx(W,{children:r("add_schema_card.field.enum")}),e.jsx(re,{id:"enum",onChange:m,placeholder:"Enum"})]}):null,a?null:e.jsx("div",{className:"w-full flex justify-end mt-2",children:e.jsx(Z,{variant:"secondary",disabled:!i.name||!i.description||!i.type,onClick:h,className:"w-full",children:r("add_schema_card.field.add_field")})})]})}),ls=d.memo(({data:t,setData:n})=>e.jsxs(Ao,{type:"single",collapsible:!0,children:[t.map(a=>e.jsxs(Oo,{value:`${a.id}`,children:[e.jsx(Fo,{children:a.name}),e.jsx(To,{children:e.jsx(ds,{setData:n,data:t,id:a.id})})]},a.id||"new")),e.jsx(se,{className:"p-2 mt-4",children:e.jsx(ds,{setData:n,data:t})})]})),Fr=d.memo(t=>{const{t:n}=G("components"),{id:a}=t,r=oe(a),[s,o]=d.useState([]),{createSchema:i,loading:l}=Or(),c=async()=>{if(r&&(s!=null&&s.length))try{await i(r,s),o([])}catch(p){We({variant:"destructive",title:`${p}`})}};return e.jsxs(se,{className:"max-w-lg",children:[e.jsx(de,{children:e.jsx(he,{children:n("add_schema_card.title")})}),e.jsx(le,{className:"min-w-96",children:e.jsx(ls,{setData:o,data:s})}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:l,disabled:!(s!=null&&s.length),onClick:c,className:"w-full",children:n("add_schema_card.create")})})]})}),cs=()=>{const t=ae(o=>{var i;return(i=o.currentSession)==null?void 0:i.id}),[n,a]=d.useState(!1),r=T(o=>o.createOrUpdateFlowNode),s=d.useCallback(async(o,i,l)=>{var c,p,u;try{if(!o||!t)throw new Error("Source or Session not found");a(!0);const m=((c=o.position)==null?void 0:c.x)||0,h=(((p=o.position)==null?void 0:p.y)||0)+(((u=o.measured)==null?void 0:u.height)||0),g=Ld(i,l),f=await I("CSVData").save({headers:g.headers,csv:g.data,session_id:t});if(!f)throw new Error("Failed to save");if(!await r({source_id:f.id,source_type:"CSVData",node_type:b.CSVData,x:m,y:h+20}))throw new Error("Failed to save node")}finally{a(!1)}},[t,r]);return{loading:n,createCSVData:s}};function Tr({data:t}){const{t:n}=G("components");return e.jsxs(zs,{className:"w-full",children:[e.jsx(Us,{children:e.jsxs(ya,{children:[e.jsx(at,{children:n("add_few_shot_example_card.input")}),e.jsx(at,{children:n("add_few_shot_example_card.output")})]})}),e.jsx(Bs,{children:t==null?void 0:t.map((a,r)=>e.jsxs(ya,{children:[e.jsx(tt,{className:"p-4",children:a.input}),e.jsx(tt,{className:"p-4",children:a.output})]},`${a.input}_${a.output}_${r}`))})]})}const Rr=d.memo(t=>{const{id:n}=t,{t:a}=G("components"),[r,s]=d.useState([]),[o,i]=d.useState(""),[l,c]=d.useState(""),p=oe(n),{createCSVData:u,loading:m}=cs(),h=()=>{s(f=>[...f,{input:o,output:l}]),i(""),c("")},g=async()=>{p&&await u(p,["input","output"],r.map(f=>[f.input,f.output]))};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:a("add_few_shot_example_card.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(W,{htmlFor:"name",children:a("add_few_shot_example_card.input")}),e.jsx(re,{value:o,onChange:f=>i(f.target.value||""),id:"name",placeholder:a("add_few_shot_example_card.input_placeholder")})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(W,{htmlFor:"name",children:a("add_few_shot_example_card.output")}),e.jsx(oa,{value:l,onChange:f=>c(f.target.value||""),placeholder:a("add_few_shot_example_card.output_placeholder")})]}),e.jsx("div",{className:"w-full flex mt-4 justify-end",children:e.jsx(Z,{disabled:!o||!l,onClick:h,className:"w-40",children:a("add_few_shot_example_card.add")})}),e.jsx(Tr,{data:r||[]})]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:m,disabled:!(r!=null&&r.length),onClick:g,className:"w-full",children:a("add_few_shot_example_card.create")})})]})}),Pr=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async(i,l,c)=>{var p,u,m;try{if(!i||!t)throw new Error("Source or Session not found");if(!l.name||!l.description)throw new Error("Name is required");a(!0);const h=((p=i.position)==null?void 0:p.x)||0,g=(((u=i.position)==null?void 0:u.y)||0)+(((m=i.measured)==null?void 0:m.height)||0),f=await I("ToolDefinition").save({...l,name:`${l.name}`,description:`${l.description}`,session_id:t});if(!f)throw new Error("Failed create tool.");const x=await r({source_id:f.id,source_type:"ToolDefinition",node_type:b.ToolDefinition,x:h,y:g+20});if(!x)throw new Error("Failed to save node");c!=null&&c.schemaNode&&await s({source:c.schemaNode.id,target:x.id})}finally{a(!1)}},[t,r,s]);return{loading:n,createTool:o}},$r=d.memo(t=>{const{t:n}=G("components"),{toast:a}=ye(),{id:r}=t,s=oe(r),[o,i]=d.useState(""),[l,c]=d.useState(""),{createTool:p,loading:u}=Pr(),m=f=>{i(f.target.value)},h=f=>{c(f.target.value)},g=async()=>{if(s&&o&&l)try{await p(s,{name:o,description:l}),i(""),c("")}catch(f){Co("Create Tool",f),a({variant:"destructive",title:n("add_tool_card.errors.create_tool_failed")})}};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:n("add_tool_card.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(W,{htmlFor:"name",children:n("add_tool_card.tool_name")}),e.jsx(re,{onChange:m,id:"name",placeholder:n("add_tool_card.name_placeholder")})]}),e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(W,{htmlFor:"name",children:n("add_tool_card.tool_description")}),e.jsx(oa,{onChange:h,placeholder:n("add_tool_card.description_placeholder")})]})]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:u,onClick:g,className:"w-full",children:n("add_tool_card.create")})})]})}),Vr=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async(i,l,c)=>{var p,u,m;try{if(!(l!=null&&l.name)||!i||!t)throw new Error("Source or Session not found");a(!0);const h=((p=i.position)==null?void 0:p.x)||0,g=(((u=i.position)==null?void 0:u.y)||0)+(((m=i.measured)==null?void 0:m.height)||0),f=await I("VectorDatabase").save({...l,name:`${l.name}`,type:l.type||Id.Local,storage:l.storage||$e.DatabaseNode,raw:"",provider:l.provider||an.Memory,session_id:t,metadata:c?JSON.stringify({textSplitter:c}):void 0});if(!f)throw new Error("Failed to save vectorDatabase");const x=await r({source_id:f.id,source_type:"VectorDatabase",node_type:b.VectorDatabase,x:h,y:g+30});if(!x)throw new Error("Failed to save vectorDatabase node");if(l.storage===$e.DataNode){const _=await I("JSONLData").save({headers:Ad(["content","embedding","metadata"]),jsonl:"",session_id:t});if(!_)throw new Error("Failed to save databaseSource");const y=await r({source_id:_.id,source_type:"JSONLData",node_type:b.JSONLData,x:h+80,y:g+30});if(!y)throw new Error("Failed to save databaseSource node");await s({source:y.id,target:x.id})}return{vectorDatabase:f,vectorDatabaseNode:x}}finally{a(!1)}},[t,r,s]);return{loading:n,createVectorDatabase:o}},aa=[an.Memory],ta=[$e.DatabaseNode],Hr=["TokenTextSplitter","CharacterTextSplitter","RecursiveCharacterTextSplitter"],zr=d.memo(t=>{const{t:n}=G("components"),{id:a}=t,r=oe(a),{toast:s}=ye(),[o,i]=d.useState(""),[l,c]=d.useState(aa[0]),[p,u]=d.useState(ta[0]),[m,h]=d.useState({}),{loading:g,createVectorDatabase:f}=Vr(),x=d.useCallback(v=>{c(v)},[]),_=d.useCallback(v=>{u(v)},[]),y=d.useCallback(v=>{h(j=>({...j,type:v,chunkSize:500,chunkOverlap:40}))},[]),k=d.useCallback(v=>{i(v.target.value||"")},[]),L=d.useCallback(v=>{h(j=>({...j,chunkSize:Number(v.target.value)}))},[]),w=d.useCallback(v=>{h(j=>({...j,chunkOverlap:Number(v.target.value)}))},[]),E=async()=>{try{if(!r)return;await f(r,{name:o,provider:l,storage:p},m!=null&&m.type?{type:m.type,chunkSize:m.chunkSize||500,chunkOverlap:m.chunkOverlap||0}:void 0),i(""),h({})}catch{s({variant:"destructive",description:n("create_vector_database_card.errors.create_failed")})}};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:n("create_vector_database_card.title")})}),e.jsx(le,{children:e.jsxs("div",{className:"grid w-full gap-1.5",children:[e.jsx(W,{children:n("create_vector_database_card.name")}),e.jsx(re,{className:"mb-4",value:o,onChange:k}),(ta==null?void 0:ta.length)>1?e.jsxs(e.Fragment,{children:[e.jsx(W,{children:n("create_vector_database_card.storage_type")}),e.jsxs(De,{value:p,onValueChange:_,children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:n("create_vector_database_card.provider_select_placeholder")})}),e.jsx(Ae,{children:Object.values(ta).map(v=>e.jsx(fe,{value:v,children:n(`create_vector_database_card.storage_types.${v.toLowerCase()}`)},v))})]})]}):void 0,(aa==null?void 0:aa.length)>1?e.jsxs(e.Fragment,{children:[e.jsx(W,{children:n("create_vector_database_card.provider")}),e.jsxs(De,{value:l,onValueChange:x,children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:n("create_vector_database_card.provider_select_placeholder")})}),e.jsx(Ae,{children:Object.values(aa).map(v=>e.jsx(fe,{value:v,children:n(`create_vector_database_card.providers.${v.toLowerCase()}`)},v))})]})]}):void 0,e.jsx(W,{children:n("create_vector_database_card.text_splitter")}),e.jsxs(De,{value:m.type,onValueChange:y,children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:n("create_vector_database_card.text_splitter_select_placeholder")})}),e.jsx(Ae,{children:Object.values(Hr).map(v=>e.jsx(fe,{value:v,children:n(`create_vector_database_card.text_splitters.${v.toLowerCase()}`)},v))})]}),m.type?e.jsxs(se,{children:[e.jsx(de,{children:e.jsx(he,{children:n("create_vector_database_card.text_splitter_configuration")})}),e.jsxs(le,{children:[e.jsx(W,{children:n("create_vector_database_card.text_splitter_chunksize")}),e.jsx(re,{value:m.chunkSize,onChange:L,placeholder:n("create_vector_database_card.text_splitter_chunksize_placeholder")}),e.jsx(W,{children:n("create_vector_database_card.text_splitter_chunkoverlap")}),e.jsx(re,{value:m.chunkOverlap,onChange:w,placeholder:n("create_vector_database_card.text_splitter_chunkoverlap_placeholder")})]})]}):void 0]})}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{disabled:!m.type||!o,loading:g,onClick:E,className:"w-full",children:n("create_vector_database_card.create")})})]})});function Ur({data:t}){const{t:n}=G("components");return e.jsxs(zs,{className:"w-full",children:[e.jsx(Us,{children:e.jsx(ya,{children:e.jsx(at,{children:n("add_text_data.text")})})}),e.jsx(Bs,{children:t==null?void 0:t.map((a,r)=>e.jsx(ya,{children:e.jsx(tt,{className:"p-4",children:a.text})},`${a.text}_${r}`))})]})}const Br=d.memo(t=>{const{id:n}=t,{t:a}=G("components"),[r,s]=d.useState([]),[o,i]=d.useState(""),l=oe(n),{createCSVData:c,loading:p}=cs(),u=()=>{s(h=>[...h,{text:o}]),i("")},m=async()=>{l&&await c(l,["text"],r.map(h=>[h.text]))};return e.jsxs(se,{className:"mw-full",children:[e.jsx(de,{children:e.jsx(he,{children:a("add_text_data.title")})}),e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col space-y-1.5 mt-3",children:[e.jsx(W,{htmlFor:"name",children:a("add_text_data.text")}),e.jsx(oa,{value:o,onChange:h=>i(h.target.value||""),placeholder:a("add_text_data.text_placeholder")})]}),e.jsx("div",{className:"w-full flex mt-4 justify-end",children:e.jsx(Z,{disabled:!o,onClick:u,className:"w-40",children:a("add_text_data.add")})}),e.jsx(Ur,{data:r||[]})]}),e.jsx(Re,{className:"flex justify-between",children:e.jsx(Fe,{loading:p,disabled:!(r!=null&&r.length),onClick:m,className:"w-full",children:a("add_text_data.create")})})]})});var ke=(t=>(t.ADD_LLM="ADD_LLM",t.ADD_PROMPT="ADD_PROMPT",t.ADD_TOOL_DEFINITION="ADD_TOOL_DEFINITION",t.ADD_SCHEMA="ADD_SCHEMA",t.ADD_FEW_SHOT_EXAMPLE="ADD_FEW_SHOT_EXAMPLE",t.ADD_VECTOR_DATABASE="ADD_VECTOR_DATABASE",t.ADD_TEXT_DATA="ADD_TEXT_DATA",t))(ke||{});const qr=["ADD_LLM","ADD_PROMPT","ADD_SCHEMA","ADD_VECTOR_DATABASE",{key:"more",label:"more",icon:"ellipsis",children:["ADD_TOOL_DEFINITION","ADD_FEW_SHOT_EXAMPLE"]}],Wr=()=>{const t="_coolMode_effect",n=document.getElementById(t);if(n)return n;const a=document.createElement("div");return a.setAttribute("id",t),a.setAttribute("style","overflow:hidden; position:fixed; height:100%; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:2147483647"),document.body.appendChild(a),a};let us=0;const Gr=(t,n)=>{us++;const a=(n==null?void 0:n.particle)||"circle",r=[15,20,25,35,45],s=45;let o=[],i=!1,l=0,c=0;const p=Wr();function u(){const j=(n==null?void 0:n.size)||r[Math.floor(Math.random()*r.length)],$=(n==null?void 0:n.speedHorz)||Math.random()*10,U=(n==null?void 0:n.speedUp)||Math.random()*25,B=Math.random()*360,M=Math.random()*35*(Math.random()<=.5?-1:1),A=c-j/2,P=l-j/2,S=Math.random()<=.5?-1:1,D=document.createElement("div");if(a==="circle"){const q="http://www.w3.org/2000/svg",Y=document.createElementNS(q,"svg"),ee=document.createElementNS(q,"circle");ee.setAttributeNS(null,"cx",(j/2).toString()),ee.setAttributeNS(null,"cy",(j/2).toString()),ee.setAttributeNS(null,"r",(j/2).toString()),ee.setAttributeNS(null,"fill",`hsl(${Math.random()*360}, 70%, 50%)`),Y.appendChild(ee),Y.setAttribute("width",j.toString()),Y.setAttribute("height",j.toString()),D.appendChild(Y)}else D.innerHTML=`<img src="${a}" width="${j}" height="${j}" style="border-radius: 50%">`;D.style.position="absolute",D.style.transform=`translate3d(${P}px, ${A}px, 0px) rotate(${B}deg)`,p.appendChild(D),o.push({direction:S,element:D,left:P,size:j,speedHorz:$,speedUp:U,spinSpeed:M,spinVal:B,top:A})}function m(){o.forEach(j=>{j.left=j.left-j.speedHorz*j.direction,j.top=j.top-j.speedUp,j.speedUp=Math.min(j.size,j.speedUp-1),j.spinVal=j.spinVal+j.spinSpeed,j.top>=Math.max(window.innerHeight,document.body.clientHeight)+j.size&&(o=o.filter($=>$!==j),j.element.remove()),j.element.setAttribute("style",["position:absolute","will-change:transform",`top:${j.top}px`,`left:${j.left}px`,`transform:rotate(${j.spinVal}deg)`].join(";"))})}let h,g=0;const f=30;function x(){const j=performance.now();i&&o.length<s&&j-g>f&&(u(),g=j),m(),h=requestAnimationFrame(x)}x();const _="ontouchstart"in window,y=_?"touchstart":"mousedown",k=_?"touchend":"mouseup",L=_?"touchmove":"mousemove",w=j=>{var $,U;"touches"in j?(l=($=j.touches)==null?void 0:$[0].clientX,c=(U=j.touches)==null?void 0:U[0].clientY):(l=j.clientX,c=j.clientY)},E=j=>{w(j),i=!0},v=()=>{i=!1};return t.addEventListener(L,w,{passive:!0}),t.addEventListener(y,E,{passive:!0}),t.addEventListener(k,v,{passive:!0}),t.addEventListener("mouseleave",v,{passive:!0}),()=>{t.removeEventListener(L,w),t.removeEventListener(y,E),t.removeEventListener(k,v),t.removeEventListener("mouseleave",v);const j=setInterval(()=>{h&&o.length===0&&(cancelAnimationFrame(h),clearInterval(j),--us===0&&p.remove())},500)}},Jr=({children:t,options:n})=>{const a=d.useRef(null);return d.useEffect(()=>{if(a.current)return Gr(a.current,n)},[n]),sa.cloneElement(t,{ref:a})},Kr=d.memo(t=>{const{t:n}=G("flows"),a=Rs(l=>l.theme),[r,s]=d.useState(`${ke.ADD_LLM}`),o=d.useMemo(()=>e.jsxs(Wt,{children:[e.jsx(Fa,{children:e.jsx(Jr,{children:e.jsx(Z,{variant:"link",className:"!p-0 !pl-3",children:e.jsx(So,{width:32,height:32,className:J(a==="dark"?"fill-white":"fill-black")})})})}),qr.map(l=>typeof l=="object"?e.jsxs(Fa,{children:[e.jsx(Ta,{children:l.icon?e.jsx(H,{name:l.icon}):n(`supported_nodes.${l.label}`)}),e.jsx(Gt,{children:l.children.map(c=>e.jsx(Jt,{onClick:()=>s(c),children:n(`supported_nodes.${c.toLowerCase()}`)},c))})]},l.key):e.jsx(Fa,{children:e.jsx(Ta,{value:l,onClick:()=>s(l),children:n(`supported_nodes.${l.toLowerCase()}`)})},l))]}),[n,a]),i=d.useMemo(()=>{switch(r){case ke.ADD_LLM:return e.jsx(Dr,{...t});case ke.ADD_PROMPT:return e.jsx(Ar,{...t});case ke.ADD_SCHEMA:return e.jsx(Fr,{...t});case ke.ADD_FEW_SHOT_EXAMPLE:return e.jsx(Rr,{...t});case ke.ADD_TOOL_DEFINITION:return e.jsx($r,{...t});case ke.ADD_VECTOR_DATABASE:return e.jsx(zr,{...t});case ke.ADD_TEXT_DATA:return e.jsx(Br,{...t})}},[t,r]);return e.jsxs(e.Fragment,{children:[o,e.jsx("div",{className:"mt-4",children:i})]})}),Xr=()=>{const[t,n]=d.useState(!1),a=Od(),r=ae(i=>i.currentSession),s=d.useCallback(async(i,l,c,p)=>{var h;const u=(h=l.data)==null?void 0:h.entity;let m=l.type?Fd[l.type]:void 0;if(m&&u&&l&&typeof u=="object"&&"id"in u&&!c.has(`${u.id}`)&&!p.has(`${l.id}`)){m=m;const g=await I(m).save({...u,...u&&typeof u=="object"&&"session_id"in u?{session_id:i.id}:{}});c.set(`${u.id}`,g.id);const f=await I("FlowNode").findOne({where:{id:l.data.flowNode.id}}),x=await I("FlowNode").save({...f||l.data.flowNode,session_id:i.id,id:void 0,source_type:m,source_id:g.id});return p.set(`${l.id}`,x.id),{entityName:m,entity:g,node:x}}else if(!p.has(`${l.id}`)){const g=await I("FlowNode").findOne({where:{id:l.data.flowNode.id}}),f=await I("FlowNode").save({...g||l.data.flowNode,node_type:l.type,session_id:i.id,id:void 0});return p.set(`${l.id}`,f.id),{node:f}}},[]),o=d.useCallback(async(i,l)=>{try{if(!r)throw new Error("No current session");n(!0);const c=await I("Session").save({type:Td.StandaloneApp,name:l.name||(r!=null&&r.name?`${r.name}`:"Standalone"),status:Rd.Started,passphrase:r.passphrase});if(!c)throw new Error("Failed create standalone session");const p=new Map,u=new Map,m=await s(c,i,p,u);if(!m)throw new Error("Failed to clone main node");await I("Session").update(c.id,{main_node_id:m.node.id,main_source_id:m!=null&&m.entity?m.entity.id:void 0,main_source_type:m.entityName?m.entityName:void 0});for(const{node:h,connectedNodes:g}of l.connections)if(await s(c,h,p,u),g)for(const f of g)await s(c,f,p,u);for(const{connections:h}of l.connections)for(const g of h){const f=u.get(`${g.source}`),x=u.get(`${g.target}`);if(!f||!x)throw new Error("Failed to get connected flow node id");await I("FlowEdge").save({source:f,target:x,sourceHandle:g.sourceHandle,targetHandle:g.targetHandle,session_id:c.id})}return a(Pd("application",{applicationId:c.id})),!0}finally{n(!1)}},[s,r,a]);return{loading:t,createStandaloneSession:o}},Yr=()=>{const[t,n]=d.useState(!1),a=T(o=>o.updateNodes),r=T(o=>o.updateEdges),s=d.useCallback(async o=>{try{n(!0),await I("FlowNode").delete(o);const i=await I("FlowEdge").find({where:[{source:o},{target:o}]});return await Promise.all(i.map(l=>I("FlowEdge").delete(l.id))),await a([{id:o,type:"remove"}]),await r(i.map(l=>({id:l.id,type:"remove"}))),!0}catch{return!1}finally{n(!1)}},[r,a]);return{loading:t,deleteNodeFlow:s}},Qr=ga(({cloneStandaloneSession:t})=>{const n=Te(),{t:a}=G("dialogs"),[r,s]=d.useState(""),{toast:o}=ye(),i=c=>{s(c.target.value)},l=async()=>{try{n.hide(),await t(r),s("")}catch{o({variant:"destructive",description:a("create_standalone_application.errors.create_failed")})}};return e.jsx(ja,{open:n.visible,onOpenChange:n.hide,children:e.jsxs(ba,{className:"sm:max-w-[425px]",children:[e.jsxs(Na,{children:[e.jsx(Ca,{children:a("create_session.title")}),e.jsx(Zs,{children:a("create_standalone_application.description")})]}),e.jsx("div",{className:"grid gap-4 py-4",children:e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[e.jsx(W,{className:"mb-2",htmlFor:"name",children:a("create_standalone_application.name")}),e.jsx(re,{onChange:i,id:"name",value:r,placeholder:a("create_standalone_application.name_placeholder")})]})}),e.jsx(en,{children:e.jsx(Z,{onClick:l,disabled:!r,type:"submit",children:a("create_standalone_application.create")})})]})})}),me=d.memo(({id:t,className:n,enableToStandalone:a,getLinkedConnections:r})=>{const{t:s}=G("common"),{getNode:o}=Ne(),{loading:i,deleteNodeFlow:l}=Yr(),{createStandaloneSession:c}=Xr(),{toast:p}=ye(),u=Te(Qr),m=d.useCallback(async()=>{try{await l(t),p({description:s("deleted")})}catch{p({description:s("errors.delete_failed"),variant:"destructive"})}},[l,t,p,s]),h=d.useCallback(async f=>{try{const x=o(t);if(!x)throw new Error("No current node");const _=(r==null?void 0:r(t))||[];await c(x,{name:f,connections:_}),p({description:s("standalone_session_created")})}catch(x){xa("Clone Standalone Session",x),p({description:s("errors.create_standalone_session_failed"),variant:"destructive"})}},[o,t,r,c,p,s]),g=d.useCallback(()=>{u.show({cloneStandaloneSession:h})},[h,u]);return e.jsxs("div",{className:J("flex absolute z-[51] right-0 top-0 h-10",n),children:[a?e.jsx(Z,{className:"!rounded-none !px-2",onClick:g,variant:"ghost",children:e.jsx(H,{name:"package-plus",size:16})}):void 0,e.jsx(Fe,{loading:i,className:"!rounded-none !px-2",onClick:m,variant:"ghost",children:e.jsx(H,{name:"trash-2",size:16})})]})}),X=d.memo(t=>{const{className:n,...a}=t;return e.jsx(Ro,{className:J("!w-2 !h-2 !border-none !rounded-full !bg-slate-700",t.position===K.Top?"!top-[-2px]":"",n),...a})}),Zr=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async i=>{var l,c;a(!0);try{const p=(l=i.data)==null?void 0:l.entity;if(!p||!t)throw new Error("LLM or Session not found");const u=i.position.x,m=i.position.y+(((c=i.measured)==null?void 0:c.height)||0),h=await I("Thread").save({initial_llm_id:p.id,title:`New thread with ${p.name}`,status:da.Started,messages:[],session_id:t}),g=await r({source_id:h.id,source_type:"Thread",node_type:b.Thread,x:u,y:m+60});if(!g)throw new Error("Failed to create thread node");const f=await s({source:i.id,target:g.id});return{thread:h,flowNode:g,flowEdge:f}}finally{a(!1)}},[s,r,t]);return{loading:n,createThread:o}},ei=(t,n)=>{var L;const{t:a}=G("flows"),{toast:r}=ye(),[s,o]=d.useState(!1),[i,l]=d.useState(!1),c=oe(t),{loadModel:p}=Jd(),{createThread:u,loading:m}=Zr(),h=T(w=>w.updateNodes),g=T(w=>w.pushSyncNodeQueue),{getNodes:f}=Ne(),x=d.useCallback(async()=>{try{if(l(!0),n.entity.id){const w=await I("Thread").find({where:{initial_llm_id:n.entity.id}});g("Thread",{where:{source_type:"Thread",source_id:ct(w.map(E=>E.id))}})}}finally{l(!1)}},[(L=n==null?void 0:n.entity)==null?void 0:L.id,g]),_=d.useCallback(async()=>{try{if(o(!0),n.entity&&c){await(p==null?void 0:p(n.entity.provider,`${n.entity.name}`,{provider:n.entity.provider,callback:E=>{c.data.status=E.progress===100?ce.Loaded:ce.Loading,c.data.label=E.text,h([{id:t,type:"replace",item:c}])}}));const w=f().filter(E=>E.type===b.LLM?E.data.entity.provider===z.WebLLM:!1).map(E=>(E.data.status=ce.Started,{id:E.id,type:"replace",item:E}));c.data.label="",c.data.status=ce.Loaded,w.push({id:t,type:"replace",item:c}),h(w),await x()}}catch(w){xa("Load Model",w),r({variant:"destructive",description:a("llm_node.errors.loading_model")})}finally{o(!1)}},[n.entity,f,t,p,c,x,a,r,h]),y=d.useCallback(async()=>{n.entity&&c&&await(u==null?void 0:u(c))},[n.entity,c,u]),k=d.useCallback(async w=>{n.entity&&c&&(c.data.entity.options=w,await I("LLM").update(n.entity.id,{options:w}),h([{id:t,type:"replace",item:c}]))},[n.entity,t,c,h]);return d.useEffect(()=>{n.entity&&c&&n.entity.status!==n.status&&(c.data.status=n.entity.status,h([{id:t,type:"replace",item:c}]))},[]),{loadingModel:s,creatingThread:m,queringThreads:i,changeLLMOptions:k,loadModel:_,createThread:y,queryThreads:x}},pe=(t,n)=>{const[a,r]=d.useState(!1),[s,o]=d.useState([]),{deleteElements:i,getNode:l}=Ne();va({type:"target",nodeId:t,onConnect:p=>{p!=null&&p.length&&o(u=>[...u,...Po(p)])}});const c=d.useCallback(async(p,u,m,h)=>{try{return await n({id:t,edgeId:p,source:u,target:m,connection:h})}catch{return{deleteEdgeId:p}}},[n,t]);d.useEffect(()=>{!(s!=null&&s.length)||a||(async()=>{try{r(!0);const p=[...s];o([]);const u=[],m=l(t);await Promise.all(p.map(async h=>{const g="edgeId"in h?h.edgeId:void 0,f=l(h.source);if(!f||!m)return;const x=await c(`${g}`,f,m,h);x!=null&&x.deleteEdgeId&&u.push(...Array.isArray(x.deleteEdgeId)?x.deleteEdgeId:[x.deleteEdgeId])})),u!=null&&u.length&&await i({edges:u.map(h=>({id:h}))})}finally{r(!1)}})()},[i,l,t,a,c,s])},ai=t=>{const n=d.useCallback(async()=>{},[]);pe(t,n)},ti=d.memo(t=>{var y,k,L,w,E,v;const{id:n,data:a,isConnectable:r}=t,[s,o]=d.useState(),{t:i}=G("flows"),{createThread:l,loadModel:c,queringThreads:p,queryThreads:u,loadingModel:m,changeLLMOptions:h}=ei(n,a);ai(n);const g=[ce.Loading,ce.Downloading].includes(a.status);d.useEffect(()=>{var j,$,U,B,M,A,P,S,D;if(!(s||!((j=a==null?void 0:a.entity)!=null&&j.name))){if([z.WebLLM,z.Wllama].includes(($=a==null?void 0:a.entity)==null?void 0:$.provider)){if(z.Wllama===((U=a==null?void 0:a.entity)==null?void 0:U.provider)){ve(()=>import("./file-tree-Bge6cgXj.js").then(async q=>(await q.__tla,q)).then(q=>q.i),__vite__mapDeps([7,4,2,3])).then(async({ModelManager:q})=>{var ee,we,_e;const Y=await new q().getModels();o({hasCache:!!Y.find(ne=>{var C;return ne.url.includes((C=a==null?void 0:a.entity)==null?void 0:C.name)}),cloud:!1,isFunctionCalling:!1,info:{model_id:(ee=a==null?void 0:a.entity)==null?void 0:ee.name,model:(we=a==null?void 0:a.entity)==null?void 0:we.name,model_lib:(_e=a==null?void 0:a.entity)==null?void 0:_e.provider,model_type:2}})}),o({hasCache:!1,cloud:!1,isFunctionCalling:!0,info:{model_id:(B=a==null?void 0:a.entity)==null?void 0:B.name,model:(M=a==null?void 0:a.entity)==null?void 0:M.name,model_lib:(A=a==null?void 0:a.entity)==null?void 0:A.provider,model_type:2}});return}}else{o({hasCache:!1,cloud:!0,isFunctionCalling:!0,info:{model_id:(P=a==null?void 0:a.entity)==null?void 0:P.name,model:(S=a==null?void 0:a.entity)==null?void 0:S.name,model_lib:(D=a==null?void 0:a.entity)==null?void 0:D.provider,model_type:2}});return}ve(()=>import("./index-BFbnGzju.js").then(async q=>(await q.__tla,q)),__vite__mapDeps([0,1,2,3,4,5,6])).then(async({hasModelInCache:q,functionCallingModelIds:Y,prebuiltAppConfig:ee})=>{var _e,ne;const we=await q((_e=a==null?void 0:a.entity)==null?void 0:_e.name);o({hasCache:we,isFunctionCalling:Y.includes((ne=a==null?void 0:a.entity)==null?void 0:ne.name),info:ee.model_list.find(C=>{var V;return C.model_id===((V=a==null?void 0:a.entity)==null?void 0:V.name)})})})}},[(y=a==null?void 0:a.entity)==null?void 0:y.name,(k=a==null?void 0:a.entity)==null?void 0:k.provider,s]);const f=d.useCallback(async j=>{await h(j)},[h]),x=d.useMemo(()=>{var j,$;switch(a.status){case ce.Downloading:return e.jsx(H,{className:"animate-spin w-7 h-7",name:"arrow-big-down-dash"});case ce.Loaded:return e.jsx(Ve,{name:((j=a.entity)==null?void 0:j.name)||"brain",className:"w-7 h-7"});case ce.Loading:return e.jsx(H,{className:"animate-spin w-7 h-7",name:"loader-circle"});default:return e.jsx(Ve,{name:(($=a.entity)==null?void 0:$.name)||"brain",className:"w-7 h-7"})}},[(L=a.entity)==null?void 0:L.name,a.status]),_=d.useMemo(()=>g?null:m?e.jsx(Z,{disabled:!0,className:"w-full mt-4",children:e.jsx(H,{className:"animate-spin",size:24,name:"loader-circle"})}):a.status===ce.Loaded?e.jsx(Z,{onClick:l,className:"mt-4 w-full",children:i("llm_node.create_thread_button")}):e.jsxs("div",{className:"flex gap-2 mt-4",children:[s!=null&&s.hasCache?e.jsx(Fe,{loading:p,onClick:u,children:e.jsx(H,{size:24,name:"message-square-more"})}):null,e.jsx(Z,{disabled:m,onClick:c,className:"w-full",children:i(s!=null&&s.hasCache?"llm_node.load_model_button":"llm_node.download_model_button")})]}),[g,m,a.status,s==null?void 0:s.hasCache,p,u,c,i,l]);return e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(je,{className:"flex justify-center",children:[x,e.jsxs("div",{className:"ml-2 pt-1 max-w-lg",children:[e.jsx(Pe,{className:"flex gap-2 items-center pr-6",children:`${((w=a==null?void 0:a.entity)==null?void 0:w.name)||""}`}),e.jsx(na,{className:"max-w-full",children:`${a.label||""}`}),e.jsx("div",{className:"max-w-full mt-2 flex-wrap flex gap-1",children:e.jsx(_a,{model:s==null?void 0:s.info,isFunctionCalling:(s==null?void 0:s.isFunctionCalling)||!1,name:(E=a==null?void 0:a.entity)==null?void 0:E.name,isCached:(s==null?void 0:s.hasCache)||!1,cloud:(s==null?void 0:s.cloud)||!1})}),e.jsx($o,{options:(v=a==null?void 0:a.entity)==null?void 0:v.options,onChangeOptions:f,className:"mt-2"}),_]})]}),g?e.jsx(qs,{className:"rounded-lg"}):void 0]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),Ya=d.memo(({tags:t,disabled:n,loading:a,onSubmit:r})=>{const{t:s}=G("components"),o=async i=>{try{return await r(i),!0}catch{return!1}};return e.jsxs(se,{className:"min-w-80",children:[e.jsx(de,{children:e.jsx(he,{children:s("add_message_card.title")})}),e.jsxs(le,{children:[e.jsx("div",{className:"grid w-full gap-1.5",children:e.jsx(Zd,{onSubmit:o,disabled:n||a,placeholder:s("add_message_card.placeholder")})}),t?e.jsx("div",{className:"mt-2 gap-1 flex flex-wrap",children:t}):null]})]})}),ms=(t,n,a,r=[],s)=>{const o=t.map(i=>s.getNode(i));for(const i of o){if(!i)continue;const l=s.getHandleConnections({type:"target",nodeId:i.id});if(a.push(...l),i.type===b.Thread){r.push(i.id),n.push(i);continue}else if(i.type!==b.Message){r.push(i.id);continue}else if(r.includes(i.id))continue;r.push(i.id),n.push(i),l.length&&ms(l.map(c=>c.source),n,a,r,s)}return{nodes:n,connections:a}},ps=(t,n)=>{const a=n.getHandleConnections({nodeId:t.id,type:"target"}),r=a.map(m=>{const h=n.getNode(m.source);return h?{connections:n.getHandleConnections({nodeId:h.id,type:"target"}),node:h}:void 0}),s=r.filter(m=>{var h;return((h=m.node)==null?void 0:h.type)===b.Prompt}),o=[];s!=null&&s.length&&s.forEach(m=>{var g;const h=(g=m.connections)==null?void 0:g.map(f=>n.getNode(f.source)).filter(Boolean);o.push({node:m.node,connections:m.connections,connectedNodes:h})});const i=r.filter(m=>{var h;return((h=m.node)==null?void 0:h.type)===b.ToolDefinition}),l=[];i!=null&&i.length&&i.forEach(m=>{var g;const h=(g=m.connections)==null?void 0:g.map(f=>n.getNode(f.source)).filter(Boolean);h!=null&&h.find(f=>f.type===b.Schema)&&l.push({node:m.node,connections:m.connections,connectedNodes:h})});const c=r.filter(m=>{var h;return((h=m.node)==null?void 0:h.type)===b.PlaceHolder}),p=[];c!=null&&c.length&&c.forEach(m=>{var g;const h=(g=m.connections)==null?void 0:g.map(f=>n.getNode(f.source)).filter(Boolean);h&&p.push({node:m.node,connections:m.connections,connectedNodes:h})});const u=r.find(m=>{var h;return((h=m.node)==null?void 0:h.type)===b.Schema});return{thread:{node:t,connections:a},llm:r.find(m=>{var h;return((h=m.node)==null?void 0:h.type)===b.LLM}),schemas:u?[u]:[],prompts:o,tools:l,placeholders:p}},hs=t=>{const n=[];return t.forEach(a=>{var o,i,l;const{node:r,connectedNodes:s}=a;if((o=r.data)!=null&&o.entity){if(r.type===b.Message){const c=r.data.entity;switch(c.role){case"human":n.push(new Ke(c.content));break;case"ai":n.push(new Ea(c.content));break}}else if(r.type===b.Prompt){const c=r.data.entity;let p=`${c.prefix?`${c.prefix}
`:""}`;if(c.type===xe.FewShotExample){const u=(l=(i=s.find(m=>m.type===b.CSVData))==null?void 0:i.data)==null?void 0:l.entity;if(u){const{rows:m}=tn(u.headers,u.csv);m.forEach(h=>{p+=`${c.content.replace(/{([^{}]*)}/g,(g,f)=>`${h[f]}`)}
`})}}else p+=c.content;switch(c.suffix&&(p+=`
${c.suffix}`),c.role){case"human":n.push(new Ke(p));break;case"system":n.push(new sn(p));break;default:n.push(new Ea(p));break}}}}),n},si=(t,n)=>{const a=(t==null?void 0:t.filter(s=>s.type===b.Message).map(s=>({node:s,connectedNodes:[]})).reverse())||[],r=[];return n.forEach(async s=>{r.unshift({node:s.node,connectedNodes:s.connectedNodes||[]})}),{history:hs(a),systems:hs(r)}},ni=t=>t?t.reduce((n,a)=>{var o,i,l,c,p;const r=(o=a.node.data)==null?void 0:o.entity,s=(c=(l=(i=a==null?void 0:a.connectedNodes)==null?void 0:i.find(u=>u.type===b.Schema))==null?void 0:l.data)==null?void 0:c.entity;return r&&((p=s==null?void 0:s.schema_items)!=null&&p.length)&&n.push({name:r.name,description:r.description,schemaItems:s.schema_items}),n},[]):[],Qa=()=>{const{getNodes:t}=Ne(),n=d.useCallback(()=>t().find(r=>r.type===b.DefaultEmbeddingModel),[t]),a=d.useCallback(()=>{var r,s;return(s=(r=n())==null?void 0:r.data)==null?void 0:s.entity},[n]);return{getFlowEmbeddingNode:n,getFlowEmbeddingEntity:a}},fs=({getNode:t,getHandleConnections:n})=>{const{t:a}=G("create_new_message"),[r,s]=d.useState(!1),o=ae(x=>x.currentSession),i=T(x=>x.createOrUpdateFlowNode),l=T(x=>x.createOrUpdateFlowEdge),{similaritySearchWithScore:c}=st(),{getFlowEmbeddingEntity:p}=Qa(),{stream:u}=ut(),m=d.useCallback(async({content:x,threadId:_,sourceId:y,initialX:k,initialY:L,initialLLMId:w})=>{if(!o)throw new Error("Session is not found");const E=await I("Message").save({thread_id:_,content:x,role:ge.Human,status:be.Started,llm_id:w,session_id:o.id});if(!E)throw new Error("Failed to save message");const v=await i({source_id:E.id,source_type:"Message",node_type:b.Message,x:k,y:L+80});if(!v)throw new Error("Failed to save human message node");await l({source:y,target:v.id});const j=await I("Message").save({thread_id:_,content:a("initial_ai_message"),role:ge.AI,status:be.Inprogress,llm_id:w,parent_message_id:E.id,session_id:o.id});if(!j)throw new Error("Failed to save message");const $=await i({source_id:j.id,source_type:"Message",node_type:b.Message,x:k,y:L+250});if(!$)throw new Error("Failed to save ai message node");return await l({source:v.id,target:$.id}),{aiMessage:j,humanMessage:E,aiMessageNode:$,humanMessageNode:v}},[l,i,o,a]),h=d.useCallback(async(x,_)=>{const{placeholders:y}=_;if(!(y!=null&&y.length))return[];const k=[];return await Promise.all(y.map(async L=>{var E,v,j,$,U,B,M,A,P,S,D,q;const w=(E=L.node.data)==null?void 0:E.entity;if(w)switch(w.placeholder_type){case ra.VECTOR_DATABASE_RETREIVER:{const Y=(v=L.connectedNodes)==null?void 0:v.find(R=>R.type===b.VectorDatabase),ee=(j=Y==null?void 0:Y.data)==null?void 0:j.entity,we=(B=(U=($=L.connectedNodes)==null?void 0:$.find(R=>R.type===b.Prompt))==null?void 0:U.data)==null?void 0:B.entity;if(!we||!ee||!Y)return;const _e=(M=w.metadata)!=null&&M.k?+((A=w.metadata)==null?void 0:A.k):1;let ne=(P=w.metadata)!=null&&P.minimalScore?+((S=w.metadata)==null?void 0:S.minimalScore):void 0;ne&&ne>1&&(ne=ne/100);const C=[];if(ee.storage===$e.DataNode){const R=(q=(D=n({nodeId:Y.id,type:"target"}).map(O=>t(O.source)).find(O=>(O==null?void 0:O.type)&&[b.JSONLData,b.CSVData].includes(O==null?void 0:O.type)))==null?void 0:D.data)==null?void 0:q.entity;if(!R)return;C.push(...await c(p(),{database:{databaseId:ee.id,dataSourceId:R.id,dataSourceType:ot(R)}},x.humanMessage.content,_e)||[])}else C.push(...await c(p(),{database:{databaseId:ee.id}},x.humanMessage.content,_e)||[]);if(!C)return[];const V=new Vo({template:we.content,inputVariables:["context"]});k.push(new Ea(await V.format({context:ne?C.filter(([,R])=>R>=ne).map(([R])=>R.pageContent).join(`
`):C.map(([R])=>R.pageContent).join(`
`)})))}}})),k},[p,n,t,c]),g=d.useCallback(async(x,_,y,{onMessageUpdate:k})=>{var D;const{prompts:L,tools:w,schemas:E,placeholders:v,llm:j}=_,$=(D=j==null?void 0:j.node.data)==null?void 0:D.entity;if(!$)throw new Error("LLM is not found");const U=[];v!=null&&v.length&&U.push(...await h(x,_));const{history:B,systems:M}=si(y,L),A=[...M,...U,...B,new Ke(x.humanMessage.content)],P=E.map(q=>{var Y;return(Y=q.node.data)==null?void 0:Y.entity}).filter(Boolean),S=await u($.provider,A,{tools:ni(w),schemas:P,llm:$,onMessageUpdate:({content:q})=>{k==null||k({id:x.aiMessageNode.id,nodeData:{loading:!0,content:q}})}});return x.aiMessage.content=(S==null?void 0:S.content)||"",x.aiMessage.metadata=JSON.stringify({message:S==null?void 0:S.lastChunk}),k==null||k({id:x.aiMessageNode.id,nodeData:{content:S==null?void 0:S.content,loading:!1,entity:x.aiMessage}}),x.aiMessage.id&&await I("Message").update(x.aiMessage.id,{content:S==null?void 0:S.content,metadata:JSON.stringify({message:S==null?void 0:S.lastChunk})}),S==null?void 0:S.content},[h,u]),f=d.useCallback(async(x,_,y)=>{var j,$,U;const{nodes:k}=ms([x.id],[],[],[],{getNode:t,getHandleConnections:n}),L=k.find(B=>B.type===b.Thread),w=L==null?void 0:L.data.entity;if(!x||!w||!L)throw new Error("Source or thread is not found");const E=ps(L,{getNode:t,getHandleConnections:n});if(!(E!=null&&E.thread))throw new Error("Thread node is not found");let v;try{s(!0);const B=((j=x.position)==null?void 0:j.x)||0,M=((($=x.position)==null?void 0:$.y)||0)+(((U=x.measured)==null?void 0:U.height)||0);return v=await m({content:_,initialX:B,initialY:M,sourceId:x.id,threadId:w.id,initialLLMId:w.initial_llm_id}),await g(v,E,k,y),await I("Message").update(`${v.aiMessage.id}`,{status:be.Success}),v.aiMessage.status=be.Success,y.onMessageUpdate({id:v.aiMessageNode.id,nodeData:{entity:v.aiMessage,loading:!1}}),!0}catch(B){xa("Create Message",B),v!=null&&v.aiMessage&&await I("Message").update(`${v.aiMessage.id}`,{status:be.Failed,content:a("errors.ai_message_content_failed")}),v!=null&&v.aiMessageNode.id&&(y==null||y.onMessageUpdate({id:v.aiMessageNode.id,nodeData:{content:a("errors.ai_message_content_failed"),entity:{...v.aiMessage,status:be.Failed,content:a("errors.ai_message_content_failed")},loading:!1}}))}finally{s(!1)}},[n,t,m,g,a]);return{loading:r,createMessage:f}},ri=(t,n)=>{const a=oe(t),{t:r}=G("flows"),{getNode:s,getHandleConnections:o}=Ne(),i=T(h=>h.updateNodes),{createMessage:l,loading:c}=fs({getNode:s,getHandleConnections:o}),p=d.useCallback(h=>{if(!h.id)return;const g=s(h.id);!g||!h.nodeData||i([{id:g.id,type:"replace",item:{...g,data:{...g.data,...Ws(h.nodeData,Gs)}}}])},[s,i]),u=d.useCallback(async h=>{if(a&&n.entity)try{await l(a,h,{onMessageUpdate:p})}catch(g){if(g instanceof Error&&g.message.includes("LLM_NOT_LOADED_YET"))return We({variant:"destructive",title:r("thread_node.errors.llm_not_loaded_yet")});We({variant:"destructive",title:`${g}`})}},[a,n.entity,l,p,r]),m=d.useCallback(h=>{const g=s(h);if(!g)return[];const f=[],x=ps(g,{getNode:s,getHandleConnections:o});return x.thread&&f.push({node:x.thread.node,connectedNodes:[],connections:x.thread.connections}),x.prompts&&f.push(...x.prompts.map(_=>({node:_.node,connectedNodes:_.connectedNodes,connections:_.connections}))),x.schemas&&f.push(...x.schemas.map(_=>({node:_.node,connectedNodes:[],connections:_.connections}))),x.placeholders&&x.placeholders.forEach(_=>{const y=_.connections.map(k=>s(k.source)).filter(Boolean);f.push({node:_.node,connectedNodes:y||[],connections:_.connections})}),x.llm&&f.push(x.llm),f},[o,s]);return{loading:c,createMessage:u,getLinkedConnections:m}},ii=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.Prompt&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.LLM&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.Schema&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.ToolDefinition&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.VectorDatabase&&(o==null?void 0:o.type)===b.Thread){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}else if((s==null?void 0:s.type)===b.PlaceHolder&&(o==null?void 0:o.type)===b.Thread&&s.data.entity.placeholder_type===ra.VECTOR_DATABASE_RETREIVER){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},oi=d.memo(t=>{const{id:n,data:a,isConnectable:r}=t,{t:s}=G("flows"),[o,i]=d.useState(!1),l=va({type:"source"}),c=va({type:"target"}),{getNode:p}=Ne(),{loading:u,createMessage:m,getLinkedConnections:h}=ri(n,a);ii(n);const g=d.useCallback(async(...y)=>(i(!1),await m(...y)),[m]),f=d.useMemo(()=>l.length>0,[l]),x=d.useCallback(()=>{i(y=>!y)},[]),_=d.useMemo(()=>{var k,L;const y=c.map((w,E)=>{var j;const v=p(w.source);if((v==null?void 0:v.type)===b.Schema)return e.jsx(Be,{children:s("thread_node.structured_output")},`${E}`);if((v==null?void 0:v.type)===b.Prompt){const $=v.data.entity;return e.jsx(Be,{children:s($.type===xe.FewShotExample?"thread_node.prompts.few_shot_example":`thread_node.prompts.${$.role.toLowerCase()}`)},`${E}`)}else if((v==null?void 0:v.type)===b.PlaceHolder&&((j=v.data.entity)==null?void 0:j.placeholder_type)===ra.VECTOR_DATABASE_RETREIVER)return e.jsx(Be,{children:s("thread_node.vector_database_retriever")},`${E}`)}).filter(Boolean);return t.data.entity&&!((L=(k=t.data.entity)==null?void 0:k.messages)!=null&&L.length)&&!f?e.jsx(Ya,{disabled:u,loading:u,onSubmit:g,tags:y}):y!=null&&y.length?e.jsxs(se,{className:"p-4 pt-2",children:[e.jsx(he,{className:"mb-2",children:s("thread_node.title")}),e.jsx("div",{className:"flex gap-1.5",children:y}),e.jsx("div",{className:"mt-4 w-full flex justify-end",children:e.jsxs(Z,{onClick:x,variant:"outline",children:[e.jsx(H,{name:o?"copy-minus":"copy-plus"}),s(o?"thread_node.hide":"thread_node.clone")]})})]}):e.jsx("div",{className:"w-12 h-10"})},[f,p,g,x,u,t.data.entity,o,s,c]);return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n,enableToStandalone:!0,getLinkedConnections:h}),_,o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-[1px] absolute ml-[50%] h-[30px] bg-gray-500"}),e.jsx("div",{className:"absolute mt-[30px] w-full",children:e.jsx("div",{className:"ml-[10%] w-80 animate-in slide-in-from-bottom-5",children:e.jsx(Ya,{disabled:u,loading:u,onSubmit:g})})})]}):void 0]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})});function di({data:t,onNewThread:n,loading:a,showThread:r}){var o;const{t:s}=G("flows");return e.jsxs(je,{className:"flex min-w-52",children:[e.jsx(H,{size:24,name:"user"}),e.jsxs("div",{className:"ml-2 max-w-full w-full",children:[e.jsx(Pe,{children:"Human"}),e.jsx(na,{children:`${t.content||((o=t.entity)==null?void 0:o.content)||""}`}),n?e.jsx("div",{className:"w-full mt-2 flex items-center justify-end",children:e.jsxs(Z,{onClick:n,disabled:a,variant:"outline",children:[e.jsx(H,{name:r?"minus":"plus",size:16}),s(r?"message_node.hide_thread":"message_node.new_thread")]})}):void 0]})]})}function li({data:t,onNewThread:n,loading:a,showThread:r}){var c,p,u,m,h,g,f,x,_;const{t:s}=G("flows"),o=d.useMemo(()=>{var y;try{return JSON.parse(((y=t==null?void 0:t.entity)==null?void 0:y.metadata)||"{}")}catch{return{}}},[(c=t==null?void 0:t.entity)==null?void 0:c.metadata]),i=t.entity.status===be.Failed,l=d.useMemo(()=>{var y;return e.jsx(Ho,{source:`${t.content||((y=t.entity)==null?void 0:y.content)||""}`})},[t.content,(p=t.entity)==null?void 0:p.content]);return e.jsxs(je,{className:J("flex min-w-52",i?"bg-background":""),variant:i?"destructive":"default",children:[e.jsx(H,{className:J(t.loading?"animate-spin":void 0),size:24,name:t.loading?"loader-circle":"bot"}),e.jsx(H,{name:r?"minus":"plus",size:24}),e.jsxs("div",{className:"ml-2 w-full max-w-full",children:[e.jsx(Pe,{children:s(`message_node.message_roles.${(m=(u=t.entity)==null?void 0:u.role)==null?void 0:m.toLowerCase()}`)}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-ful rounded-lg flex justify-center items-center",children:e.jsx(H,{name:"loader-circle",className:"animate-spin"})}),children:i?t.content||((h=t.entity)==null?void 0:h.content)||"":l}),Array.isArray((g=o==null?void 0:o.message)==null?void 0:g.tool_calls)&&((x=(f=o==null?void 0:o.message)==null?void 0:f.tool_calls)!=null&&x.length)?(_=o==null?void 0:o.message)==null?void 0:_.tool_calls.map((y,k)=>e.jsx(Be,{children:s("message_node.tool_call",{name:y.name,args:Object.entries(y.args).map(([L,w])=>`"${L}": "${w}"`).join(", ")})},`${y.name}_${k}`)):null,n?e.jsx("div",{className:"w-full mt-2 flex items-center justify-end",children:e.jsxs(Z,{onClick:n,disabled:a,variant:"outline",children:[e.jsx(H,{name:r?"minus":"plus",size:16}),s(r?"message_node.hide_thread":"message_node.new_thread")]})}):void 0]}),t.loading?e.jsx(qs,{size:350,duration:10}):void 0]})}const ci=t=>{const{t:n}=G("flows"),a=oe(t),r=T(u=>u.updateNodes),{getNode:s,getHandleConnections:o}=Ne(),{createMessage:i,loading:l}=fs({getNode:s,getHandleConnections:o}),c=d.useCallback(u=>{if(!u.id)return;const m=s(u.id);!m||!u.nodeData||r([{id:m.id,type:"replace",item:{...m,data:{...m.data,...Ws(u.nodeData,Gs)}}}])},[s,r]),p=d.useCallback(async u=>{if(a)try{await i(a,u,{onMessageUpdate:c})}catch(m){if(m instanceof Error&&m.message.includes("LLM_NOT_LOADED_YET"))return We({variant:"destructive",title:n("message_node.errors.llm_not_loaded_yet")});We({variant:"destructive",title:n("message_node.errors.create_message")})}},[a,n,i,c]);return{loading:l,createMessage:p}},gs=()=>{const t=ae(r=>r.currentSession),n=T(r=>r.createOrUpdateFlowNode),a=T(r=>r.createOrUpdateFlowEdge);return{createIdieMessage:d.useCallback(async(r,s,o,i)=>{var f,x,_,y,k;if(!r||!s||!t)return;const l=(x=(f=i==null?void 0:i.promptNode)==null?void 0:f.data)==null?void 0:x.entity,c=((_=r.position)==null?void 0:_.x)||0,p=(((y=r.position)==null?void 0:y.y)||0)+(((k=r.measured)==null?void 0:k.height)||0),u=await I("Message").save({thread_id:s.id,content:o,role:(l==null?void 0:l.role)||ge.Human,status:be.Started,llm_id:s.initial_llm_id,session_id:t.id});if(!u)throw new Error("Failed to save message");const m=await n({source_id:u.id,source_type:"Message",node_type:b.Message,x:c,y:p});if(!m)throw new Error("Failed to save message node");const h=await a({source:r.id,target:m.id});let g;return i!=null&&i.promptNode&&(g=await a({source:i==null?void 0:i.promptNode.id,target:m.id})),{message:u,edgeToPrompt:g,messageNode:m,messageEdge:h}},[n,a])}},ui=t=>{const{createIdieMessage:n}=gs(),a=d.useCallback(async({edgeId:r,source:s,target:o})=>{var i,l;try{if((s==null?void 0:s.type)===b.Prompt&&(o==null?void 0:o.type)===b.Message){const c=(i=o==null?void 0:o.data)==null?void 0:i.entity,p=(l=s==null?void 0:s.data)==null?void 0:l.entity;if(!p||!c||!o)return{deleteEdgeId:r};await n(o,{id:c==null?void 0:c.thread_id,title:"",status:da.Started,initial_llm_id:c.llm_id,session_id:p.session_id},p.content,{promptNode:s});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},mi=d.memo(t=>{var L,w,E;const{id:n,data:a,isConnectable:r}=t,[s,o]=d.useState(!1),[i,l]=d.useState(!1),{t:c}=G("common"),p=va({type:"source"}),{loading:u,createMessage:m}=ci(n),{toast:h}=ye();ui(n);const g=d.useCallback(async(...v)=>{const j=await m(...v);return o(!1),j},[m]),f=d.useMemo(()=>p.length===0,[p]),x=d.useCallback(()=>{var v;(v=a.entity)!=null&&v.content&&(navigator.clipboard.writeText(a.entity.content),h({description:c("copied")}))},[h,a,c]),_=d.useCallback(async()=>{var v;try{if(i)return await Ps.stop(),l(!1);l(!0),await Ps.speak(((v=a.entity)==null?void 0:v.content)||"")}catch{h({variant:"destructive",description:c("errors.speech_is_not_supported")})}finally{l(!1)}},[(L=a.entity)==null?void 0:L.content,i,c,h]),y=d.useCallback(()=>{o(v=>!v)},[]),k=d.useMemo(()=>{var v;if(!(!f&&!s||a.loading||u||((v=a==null?void 0:a.entity)==null?void 0:v.status)==="inprogress"))return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-[1px] absolute ml-[50%] h-[30px] bg-gray-500"}),e.jsx("div",{className:"absolute mt-[30px] w-full",children:e.jsx("div",{className:"ml-[10%] w-80 animate-in slide-in-from-bottom-5",children:e.jsx(Ya,{disabled:u,loading:u,onSubmit:g})})})]})},[(w=a==null?void 0:a.entity)==null?void 0:w.status,a.loading,g,f,u,s]);return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{className:"max-w-sm min-w-64",children:[e.jsxs("div",{className:"w-auto",children:[e.jsx(me,{id:n}),e.jsx("div",{children:((E=a.entity)==null?void 0:E.role)===ge.Human?e.jsx(di,{data:a,showThread:s,onNewThread:f?void 0:y}):e.jsx(li,{data:a,showThread:s,loading:u,onNewThread:f?void 0:y})}),e.jsx(Z,{onClick:_,className:"absolute top-0 right-[68px] !px-2 !rounded-none",variant:"ghost",children:e.jsx(H,{name:i?"circle-stop":"speech",size:16})}),e.jsx(Z,{onClick:x,className:"absolute top-0 right-[36px] !px-2 !rounded-none",variant:"ghost",children:e.jsx(H,{name:"copy",size:16})})]}),k]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),pi=t=>{const n=T(s=>s.createOrUpdateFlowEdge),{createIdieMessage:a}=gs(),r=d.useCallback(async({edgeId:s,source:o,target:i})=>{var l,c,p,u;try{const m=(l=i==null?void 0:i.data)==null?void 0:l.entity,h=(c=o==null?void 0:o.data)==null?void 0:c.entity;if((o==null?void 0:o.type)===b.Message&&(i==null?void 0:i.type)===b.Prompt){const g=(p=o==null?void 0:o.data)==null?void 0:p.entity,f=(u=i==null?void 0:i.data)==null?void 0:u.entity;if(!f||!g||!i)return{deleteEdgeId:s};await a(o,{id:g==null?void 0:g.thread_id,title:"",status:da.Started,initial_llm_id:g.llm_id,session_id:f.session_id},f.content,{promptNode:i});return}else if((o==null?void 0:o.type)===b.CSVData&&(i==null?void 0:i.type)===b.Prompt&&(m==null?void 0:m.type)===xe.FewShotExample&&(h!=null&&h.headers.includes("input"))&&(h!=null&&h.headers.includes("output"))){await n({source:o.id,target:i.id});return}return{deleteEdgeId:s}}catch{return{deleteEdgeId:s}}},[a,n]);pe(t,r)},hi=d.memo(t=>{var p,u,m;const{id:n,data:a,isConnectable:r}=t;pi(n);const s=Te(zo),o=d.useMemo(()=>{var h,g,f;return`${(h=a.entity)!=null&&h.prefix?`${(g=a.entity)==null?void 0:g.prefix}
`:""}${((f=a.entity)==null?void 0:f.content)||""}`},[(p=a.entity)==null?void 0:p.prefix,(u=a.entity)==null?void 0:u.content]),i=d.useMemo(()=>{var g;const h=/{(.*?)}/g;return((g=o.match(h))==null?void 0:g.map(f=>f.replace("{","").replace("}","")))||[]},[o]),l=o.length>990,c=()=>{s.show({title:"Prompt",content:o})};return e.jsxs("div",{className:"min-w-56",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(je,{className:"flex justify-center max-w-72",variant:"default",children:[e.jsx(H,{size:24,name:"notepad-text"}),e.jsxs("div",{className:"ml-2 max-w-full break-words break-all",children:[e.jsx(Pe,{children:`${((m=a.entity)==null?void 0:m.role)||""}`}),e.jsxs(na,{onClick:l?c:void 0,children:[l?`${o.slice(0,990)}...`:o,l?e.jsx("span",{className:"float-right",children:e.jsx(H,{name:"chevron-right"})}):void 0]}),i!=null&&i.length?i.map((h,g)=>e.jsx(Be,{className:"mt-2 mr-1",variant:"default",children:h},g)):void 0]})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),xs=t=>{const n=["Bytes","KB","MB","GB","TB"];if(t===void 0)return"Unknown size";if(t===0)return"0 Byte";const a=Math.floor(Math.log(t)/Math.log(1024));return`${Math.round(t/Math.pow(1024,a))} ${n[a]}`},fi=d.memo(()=>{const{t}=G("flows"),[n,a]=d.useState(),r=ia(h=>h.cachedLLMURLs),s=ae(h=>h.currentSession),[o,i]=d.useState(),[l,c]=d.useState(""),[,p]=d.useState();d.useEffect(()=>{ve(async()=>{const{functionCallingModelIds:h,prebuiltAppConfig:g}=await import("./index-BFbnGzju.js").then(async f=>(await f.__tla,f));return{functionCallingModelIds:h,prebuiltAppConfig:g}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({functionCallingModelIds:h,prebuiltAppConfig:g})=>{a(r==null?void 0:r.map(f=>{const x=g.model_list.find(_=>f.includes(_.model));if(x)return{model_id:(x==null?void 0:x.model_id)||"",info:x,isFunctionCalling:h.includes((x==null?void 0:x.model_id)||"")}}))})},[r,s==null?void 0:s.id]);const u=d.useCallback(async()=>{navigator.storage.estimate().then(h=>{h&&c(t("session_info_node.used_bytes",{used:xs(h.usage),total:xs(h==null?void 0:h.quota)}))}),s!=null&&s.id&&(Promise.all([I("FlowNode").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("FlowEdge").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("Thread").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("Prompt").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("LLM").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("Schema").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("ToolDefinition").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("VectorDatabase").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("JSONLData").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}}),I("CSVData").findOne({where:{session_id:s==null?void 0:s.id},order:{updated_at:"DESC"}})]).then(h=>{const g=h.reduce((f,x)=>x!=null&&x.updated_at&&(!f||new Date(x.updated_at)>f)?new Date(x.updated_at):f,s.updated_at?new Date(s.updated_at):void 0);i(g)}),Promise.all([I("FlowNode").count({where:{session_id:s==null?void 0:s.id}}),I("FlowEdge").count({where:{session_id:s==null?void 0:s.id}}),I("Thread").count({where:{session_id:s==null?void 0:s.id}}),I("Prompt").count({where:{session_id:s==null?void 0:s.id}}),I("LLM").count({where:{session_id:s==null?void 0:s.id}}),I("ToolDefinition").count({where:{session_id:s==null?void 0:s.id}}),I("Schema").count({where:{session_id:s==null?void 0:s.id}}),I("VectorDatabase").count({where:{session_id:s==null?void 0:s.id}}),I("JSONLData").count({where:{session_id:s==null?void 0:s.id}}),I("CSVData").count({where:{session_id:s==null?void 0:s.id}})]).then(([h,g,f,x,_,y,k,L,w,E])=>{p([{name:t("session_info_node.count_info.title"),nodes:h||0,edges:g||0,threads:f||0,prompts:x||0,llms:_||0,tools:y||0,schemas:k||0,vectorDatabases:L||0,jsonlDatas:w||0,csvDatas:E||0}])}))},[s==null?void 0:s.id,s==null?void 0:s.updated_at,t]),m=d.useCallback(()=>{u()},[u]);return d.useEffect(()=>{u()},[u]),e.jsxs(se,{className:"w-96",children:[e.jsxs(de,{children:[e.jsx(he,{children:t("session_info_node.title")}),e.jsx(Uo,{children:o||s!=null&&s.updated_at?Eo(o||(s==null?void 0:s.updated_at)).fromNow():""})]}),e.jsxs(le,{className:"grid gap-4",children:[e.jsx("div",{className:"flex items-center space-x-4 rounded-md border p-4",children:e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-sm font-medium leading-none",children:t("session_info_node.disk_size")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l})]})}),e.jsx("div",{className:"flex items-center space-x-4 rounded-md border p-4",children:e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"text-sm font-medium leading-none",children:[t("session_info_node.cached_llms"),e.jsx(Be,{className:"ml-2",children:(n==null?void 0:n.length)||0})]}),n==null?void 0:n.map(h=>e.jsxs("div",{className:"text-sm text-muted-foreground gap-1",children:[h==null?void 0:h.model_id,e.jsx("div",{className:"max-w-full gap-1 flex flex-wrap mt-1",children:e.jsx(_a,{model:h==null?void 0:h.info,isFunctionCalling:(h==null?void 0:h.isFunctionCalling)||!1,isCached:!0,cloud:!1})})]},h==null?void 0:h.model_id))]})}),e.jsx("div",{})]}),e.jsx(Re,{children:e.jsxs(Z,{className:"w-full",onClick:m,children:[e.jsx(H,{size:24,name:"refresh-ccw"}),t("session_info_node.reload")]})})]})}),gi=t=>{const n=d.useCallback(async({edgeId:a})=>{try{return{deleteEdgeId:a}}catch{return{deleteEdgeId:a}}},[]);pe(t,n)},xi=d.memo(t=>{var c,p;const{t:n}=G("flows"),{id:a,data:r,isConnectable:s}=t,o=d.useRef(!1),i=oe(a),l=T(u=>u.updateNodes);return gi(a),d.useEffect(()=>{var m;const u=r==null?void 0:r.entity;!u||!i||o.current||(m=u==null?void 0:u.schema_items)!=null&&m.length||r.loaded||(o.current=!0,I("SchemaItem").find({where:{schema_id:u.id}}).then(h=>{l([{id:i.id,type:"replace",item:{...i,data:{...(i==null?void 0:i.data)||{},loaded:!0,entity:{...r.entity,schema_items:h}}}}])}).finally(()=>{o.current=!1}))},[r.entity,r.loaded,i,l]),e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(me,{id:a}),e.jsxs(Js,{defaultValue:"account",className:"w-[400px]",children:[e.jsxs(Ks,{className:"grid w-full grid-cols-2",children:[e.jsx(Ge,{value:"account",children:n("schema_node.typescript")}),e.jsx(Ge,{value:"password",children:n("schema_node.zod")})]}),e.jsx(Je,{value:"account",children:e.jsx(se,{className:"p-4",children:e.jsx("pre",{className:"overflow-hidden break-words whitespace-pre-wrap",children:Kd(((c=r==null?void 0:r.entity)==null?void 0:c.schema_items)||[])})})}),e.jsx(Je,{value:"password",children:e.jsx(se,{className:"p-4 max-w-full",children:e.jsx("pre",{className:"overflow-hidden break-words whitespace-pre-wrap",children:Xd(((p=r==null?void 0:r.entity)==null?void 0:p.schema_items)||[])})})})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:s})]})}),_i=d.memo(t=>{var o,i;const{id:n,data:a,isConnectable:r}=t,s=d.useMemo(()=>{if(!(a!=null&&a.entity))return{headers:[],rows:[]};const l=dt(a.entity.csv);return{headers:lt(a.entity.headers),rows:l.map(c=>lt(c))}},[a==null?void 0:a.entity]);return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(se,{className:"min-w-32 min-h-16 p-4",children:[e.jsx(de,{className:"!p-0",children:e.jsxs("div",{className:"pt-2 flex !flex-row",children:[e.jsx(H,{name:"file-spreadsheet",className:"mr-2"}),e.jsxs(W,{className:"!font-medium leading-none tracking-tight pr-8",children:[b.CSVData," ",(o=s==null?void 0:s.rows)!=null&&o.length?`(${((i=s==null?void 0:s.rows)==null?void 0:i.length)||0})`:""]})]})}),e.jsx(le,{className:"pb-0",children:e.jsx(nt,{data:s.rows,headers:s.headers})})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),yi=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.Schema&&(o==null?void 0:o.type)===b.ToolDefinition){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},vi=d.memo(({id:t,data:n,isConnectable:a})=>{var r,s;return yi(t),e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:a}),e.jsx("div",{children:e.jsxs(je,{className:"flex justify-center",children:[e.jsx(H,{size:24,name:"wrench"}),e.jsxs("div",{className:"ml-2",children:[e.jsx(Pe,{children:`${((r=n.entity)==null?void 0:r.name)||""}`}),e.jsx(na,{children:`${((s=n.entity)==null?void 0:s.description)||""}`})]})]})}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:a})]})}),wi=d.memo(t=>{var m,h;const[n,a]=d.useState(!1),[r,s]=d.useState({}),[o,i]=d.useState({}),{confirmPassphrase:l}=un(),{t:c}=G("atoms"),p=async()=>{var g;if(n)s({}),i({});else{if((g=Object.keys(t.encrypted||{}))!=null&&g.length){await l();const f={},x=await Sa.get("passphrase");if(!x)throw new Error("Passphrase is not found");await Promise.all(Object.keys(t.encrypted||{}).map(async _=>{var y,k;(y=t.encrypted)!=null&&y[_]&&(f[_]=await Yd((k=t.encrypted)==null?void 0:k[_],x))})),i(f||{})}s({...t.options})}a(!n)},u=()=>{var g;(g=t.onChangeOptions)==null||g.call(t,r||{},o||{}),a(!1)};return e.jsx("div",{className:J("min-w-20 flex justify-end",t.className),children:e.jsxs(mt,{open:n,onOpenChange:a,children:[e.jsx(el,{children:e.jsx("div",{className:"flex justify-end gap-2 !cursor-pointer",children:e.jsxs(Z,{onClick:p,variant:"link",className:"flex items-center px-0 !cursor-pointer",children:[e.jsx(H,{name:"settings"}),e.jsx(W,{children:c("embedding_setting.title")})]})})}),e.jsx(pt,{className:"w-full p-0",children:n?e.jsxs(se,{className:"!border-none max-w-96 min-w-56",children:[e.jsx(de,{children:e.jsx(he,{children:c("embedding_setting.title")})}),e.jsxs(le,{children:[e.jsxs(W,{children:[c("embedding_setting.provider"),":"]}),e.jsxs(De,{value:r!=null&&r.provider?`${r==null?void 0:r.provider}`:"local_transformers",onValueChange:g=>s({provider:g}),children:[e.jsx(Le,{className:"",children:e.jsx(Ie,{placeholder:c("embedding_setting.provider_placeholder")})}),e.jsxs(Ae,{children:[e.jsx(fe,{value:"local_transformers",children:c("embedding_setting.providers.local_transformers")},"local_transformers"),(m=t.supportedProviders)==null?void 0:m.map(g=>e.jsx(fe,{value:g,children:c(`embedding_setting.providers.${g.toLowerCase()}`)},g))]})]}),(h=t.supportedProviders)!=null&&h.length?void 0:e.jsx(W,{className:"text-red-500 !pt-2",children:c("embedding_setting.alerts.no_provider")}),e.jsx(e.Fragment,{children:r.provider&&r.provider!=="local_transformers"?e.jsxs(e.Fragment,{children:[e.jsx(je,{variant:"destructive",className:"mt-4",children:c("embedding_setting.alerts.session_passkey")}),e.jsxs("div",{className:"mt-4",children:[e.jsx(W,{children:c("embedding_setting.encrypted_fields.api_key")}),e.jsx(Z,{variant:"link",className:"px-1",children:e.jsxs("a",{href:r.provider===z.OpenAI?ma:ua,target:"_blank",rel:"noreferrer",children:["(",r.provider===z.OpenAI?ma:ua,")"]})}),e.jsx(re,{type:"password",value:o!=null&&o.key?`${o==null?void 0:o.key}`:"",onChange:g=>i(f=>({...f,key:g.target.value}))})]})]}):void 0})]}),e.jsx(Re,{className:"flex justify-end",children:e.jsx(Z,{variant:"secondary",onClick:u,children:c("embedding_setting.save")})})]}):void 0})]})})}),ji=t=>{const n=d.useCallback(async({edgeId:a})=>({deleteEdgeId:a}),[]);pe(t,n)},bi=t=>{const n=ae(l=>{var c;return(c=l.currentSession)==null?void 0:c.id}),a=oe(t),r=Xs(),s=T(l=>l.updateNodes),{confirmOrCreatePassphrase:o}=is(),i=d.useCallback(async(l,c)=>{var p;if(a&&n){let u=t!==wa.DEFAULT_EMBEDDING_MODEL?await I("FlowNode").findOne({where:{id:t}}):void 0;const m={};if((p=Object.keys(c||{}))!=null&&p.length){await o();const f=await Sa.get("passphrase");if(!f)throw new Error("Passphrase is not found");await Promise.all(Object.keys(c||{}).map(async x=>{c!=null&&c[x]&&(m[x]=await cn(c[x],f))}))}let h;const g=[];u?(await I("FlowNodePlaceholder").update(u.source_id,{encrypted:m,data:l}),h=await I("FlowNodePlaceholder").findOne({where:{id:u.source_id}}),g.push({id:u.id,type:"replace",item:a})):(g.push({id:t,type:"remove"}),h=await I("FlowNodePlaceholder").save({placeholder_type:ra.DEFAULT_EMBEDDING_MODEL,encrypted:m,data:l,session_id:n}),u=await I("FlowNode").save({node_type:b.DefaultEmbeddingModel,session_id:n,source_type:"FlowNodePlaceholder",source_id:h.id,x:a.position.x,y:a.position.y}),g.push({type:"add",item:a})),a.data.entity=h,a.data.flowNode=u,s(g)}},[o,n,t,a,s]);return d.useEffect(()=>{t===wa.DEFAULT_EMBEDDING_MODEL&&r.find(l=>l.type===b.DefaultEmbeddingModel&&l.id!==wa.DEFAULT_EMBEDDING_MODEL)&&s([{id:t,type:"remove"}])},[t,r,s]),{changeLLMOptions:i}},Ni=d.memo(t=>{var l,c,p,u;const{id:n,data:a,isConnectable:r}=t,{changeLLMOptions:s}=bi(n);ji(n);let o="brain",i=$d;switch(`${(c=(l=a==null?void 0:a.entity)==null?void 0:l.data)==null?void 0:c.provider}`){case z.OpenAI:o="gpt",i="text-embedding-3-small";break;case z.GoogleGenerativeAI:o="gemma",i="text-embedding-004";break}return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsx("div",{children:e.jsxs(je,{className:"flex justify-center max-w-auto",variant:"default",children:[e.jsx(Ve,{name:o,className:"w-7 h-7"}),e.jsxs("div",{className:"ml-2 pr-4 flex justify-center gap-1 flex-col",children:[e.jsx("div",{className:"min-h-8 flex items-center",children:e.jsx(Pe,{children:`${i||""}`})}),e.jsx(wi,{supportedProviders:[z.OpenAI,z.GoogleGenerativeAI],onChangeOptions:s,encrypted:(p=a.entity)==null?void 0:p.encrypted,options:(u=a.entity)==null?void 0:u.data})]})]})}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),Ci=`Use the following pieces of context to answer the question at the end.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
Use three sentences maximum and keep the answer as concise as possible.

{context}
`,Si=ga(t=>{const{source:n,documents:a}=t,r=Te(),{toast:s}=ye(),{t:o}=G("dialogs"),{loading:i,createPrompt:l}=os(),c=async p=>{try{if(!p.content||!p.content.includes("{context}")){s({title:o("create_vector_database_prompt.errors.fill_context"),variant:"destructive"});return}const u=p.content.replace("{context}",a.map(m=>`<document>${m.pageContent}</document>`).join(`
`));return await l(n,{...p,content:u}),r.hide(),!0}catch{s({title:o("create_vector_database_prompt.errors.create_failed"),variant:"destructive"})}};return e.jsx(ja,{open:r.visible,onOpenChange:r.hide,children:e.jsxs(ba,{className:"sm:max-w-[425px]",children:[e.jsx(Na,{children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"file",className:"mr-2 h-4 w-4"}),e.jsx(Ca,{children:o("create_vector_database_prompt.title")})]})}),e.jsxs("div",{className:"flex gap-4 py-4 flex-col",children:[e.jsx(Xa,{onSubmit:c,loading:i,hidePromptType:!0,defaultPromptRole:"system",defaultPromptContent:Ci}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm items-center",children:[e.jsx(H,{name:"info",className:"mr-2",size:14}),o("create_vector_database_prompt.fill_content_note")]})]})]})})}),Ei=()=>{const t=ae(i=>{var l;return(l=i.currentSession)==null?void 0:l.id}),[n,a]=d.useState(!1),r=T(i=>i.createOrUpdateFlowNode),s=T(i=>i.createOrUpdateFlowEdge),o=d.useCallback(async({prompt:i,source:l,metadata:c})=>{var p,u,m,h;try{const g=(p=l==null?void 0:l.data)==null?void 0:p.entity;if(!g||!t)throw new Error("Source or Session not found");a(!0);const f=((u=l.position)==null?void 0:u.x)||0,x=(((m=l.position)==null?void 0:m.y)||0)+(((h=l.measured)==null?void 0:h.height)||0),_=await I("Prompt").save({...i,status:(i==null?void 0:i.status)||be.Started,role:(i==null?void 0:i.role)||ge.System,type:(i==null?void 0:i.type)||xe.Chat,content:(i==null?void 0:i.content)||"{context}",session_id:t});if(!_)throw new Error("Failed to save prompt");const y=await r({source_id:_.id,source_type:"Prompt",node_type:b.Prompt,x:f,y:x+20});if(!y)throw new Error("Failed to save prompt node");const k=await I("FlowNodePlaceholder").save({placeholder:`Retriever for ${g.name}`,placeholder_type:ra.VECTOR_DATABASE_RETREIVER,session_id:t,metadata:c});if(!k)throw new Error("Failed to save node placeholder");const L=await r({source_id:k.id,source_type:"FlowNodePlaceholder",node_type:b.PlaceHolder,x:f,y:x+40});if(!L)throw new Error("Failed to save node placeholder node");await s({source:y.id,target:L.id}),await s({source:l.id,target:L.id})}finally{a(!1)}},[t,r,s]);return{loading:n,createVectorDatabaseRetriever:o}},ki=`Use the following pieces of context to answer the question at the end.
If you don't know the answer, just say that you don't know, don't try to make up an answer.
----------------
{context}
`,Mi=ga(t=>{const{source:n}=t,a=Te(),{toast:r}=ye(),{t:s}=G("dialogs"),[o,i]=d.useState(1),[l,c]=d.useState(void 0),{loading:p,createVectorDatabaseRetriever:u}=Ei(),m=async f=>{try{const x=f.content;if(!x||!x.includes("{context}")){r({title:s("create_vector_database_retriever.errors.fill_context"),variant:"destructive"});return}return await u({source:n,prompt:{content:x},metadata:{k:o,minimalScore:l}}),i(1),c(void 0),a.hide(),!0}catch{r({title:s("create_vector_database_retriever.errors.create_failed"),variant:"destructive"})}},h=f=>{i(f.target.value?Number(f.target.value):void 0)},g=f=>{c(f.target.value?Number(f.target.value):void 0)};return e.jsx(ja,{open:a.visible,onOpenChange:a.hide,children:e.jsxs(ba,{className:"sm:max-w-[425px]",children:[e.jsx(Na,{children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{name:"file",className:"mr-2 h-4 w-4"}),e.jsx(Ca,{children:s("create_vector_database_retriever.title")})]})}),e.jsxs("div",{className:"flex gap-4 py-4 flex-col",children:[e.jsx(Xa,{onSubmit:m,loading:p,hidePromptType:!0,defaultPromptRole:"system",defaultPromptContent:ki}),e.jsxs(se,{children:[e.jsx(de,{children:e.jsx(he,{children:s("create_vector_database_retriever.retriever_settings")})}),e.jsxs(le,{children:[e.jsx(W,{children:s("create_vector_database_retriever.retriever_k")}),e.jsx(re,{value:o||"",type:"number",onChange:h,placeholder:s("create_vector_database_retriever.retriever_k_placeholder")}),e.jsx(W,{children:s("create_vector_database_retriever.retriever_minimum_score")}),e.jsx(re,{value:l||"",type:"number",onChange:g,placeholder:s("create_vector_database_retriever.retriever_minimum_score_placeholder")})]})]}),e.jsxs("div",{className:"w-full border-0 text-gray-700 flex text-sm items-center",children:[e.jsx(H,{name:"info",className:"mr-2",size:14}),s("create_vector_database_retriever.fill_content_note")]})]})]})})}),Di=t=>{const n=T(o=>o.createOrUpdateFlowEdge),{getFlowEmbeddingEntity:a}=Qa(),{index:r}=st(),s=d.useCallback(async({edgeId:o,target:i,source:l})=>{var c,p;try{const u=(c=i==null?void 0:i.data)==null?void 0:c.entity;if((l==null?void 0:l.type)===b.CSVData&&(i==null?void 0:i.type)===b.VectorDatabase){const m=(p=l==null?void 0:l.data)==null?void 0:p.entity;if(!m||!u)return{deleteEdgeId:o};const{rows:h}=tn(m.headers,m.csv),g=h.map(f=>new nn({pageContent:`${f.text}`}));await r(a(),{database:{databaseId:u.id,dataSourceId:m.id,dataSourceType:"CSVData"}},g),await n({source:l.id,target:i.id});return}return{deleteEdgeId:o}}catch{return{deleteEdgeId:o}}},[n,a,r]);pe(t,s)},Li=t=>{const[n,a]=d.useState(!1),{t:r}=G("flows"),{toast:s}=ye(),{getNode:o,getHandleConnections:i}=Ne(),l=T(g=>g.updateNodes),{getFlowEmbeddingEntity:c}=Qa(),{index:p,similaritySearchWithScore:u}=st(),m=d.useCallback(async(g,f)=>{var x,_,y;try{const k=o(t);if(!k)return;const L=(x=k.data)==null?void 0:x.entity;if(!L){s({variant:"destructive",title:r("vector_database_node.errors.vector_database_not_found")});return}const w=c();if(L.storage===$e.DataNode){const E=(y=(_=i({nodeId:t,type:"target"}).map(v=>o(v.source)).find(v=>(v==null?void 0:v.type)&&[b.JSONLData,b.CSVData].includes(v==null?void 0:v.type)))==null?void 0:_.data)==null?void 0:y.entity;if(!E){s({variant:"destructive",title:r("vector_database_node.errors.data_node_not_found")});return}return a(!0),await u(w,{database:{databaseId:L.id,dataSourceId:E.id,dataSourceType:ot(E)}},g,f==null?void 0:f.k)}else return a(!0),await u(w,{database:{databaseId:L.id}},g,f==null?void 0:f.k)}catch{s({variant:"destructive",title:r("vector_database_node.errors.similarity_search_failed")})}finally{a(!1)}},[o,t,c,s,r,i,u]),h=d.useCallback(async(g,f)=>{var x,_,y,k;try{const L=o(t);if(!L)return;a(!0);const w=g.content?[new nn({pageContent:g.content,id:g.id,metadata:{id:g.id}})]:g.documents;if(!(w!=null&&w.length)){s({variant:"destructive",title:r("vector_database_node.errors.content_not_found")});return}const E=(x=L.data)==null?void 0:x.entity;if(!E||!L){s({variant:"destructive",title:r("vector_database_node.errors.vector_database_not_found")});return}const v=c();if(E.storage===$e.DataNode){const j=i({nodeId:t,type:"target"}).map(A=>o(A.source)).find(A=>(A==null?void 0:A.type)&&[b.JSONLData,b.CSVData].includes(A==null?void 0:A.type)),$=(_=j==null?void 0:j.data)==null?void 0:_.entity;if(!$){s({variant:"destructive",title:r("vector_database_node.errors.data_node_not_found")});return}const U=ot($),B=Ys(w,10);let M=0;for(const A of B){if((y=f==null?void 0:f.onProgressReport)==null||y.call(f,{handling:A.length,handled:M,total:w.length}),await p(v,{database:{databaseId:E.id,dataSourceId:$.id,dataSourceType:U}},A),U&&j){const P=await I(U).findOne({where:{id:$.id}});l([{type:"replace",id:j.id,item:{...j,data:{...j.data,entity:P}}}])}M+=A.length}}else{const j=Ys(w,10);let $=0;for(const U of j){(k=f==null?void 0:f.onProgressReport)==null||k.call(f,{handling:U.length,handled:$,total:w.length}),await p(v,{database:{databaseId:E.id}},U);const B=await I("VectorDatabase").findOne({where:{id:`${E.id}`}});l([{type:"replace",id:L.id,item:{...L,data:{...L.data,entity:B}}}]),$+=U.length}}}catch{s({variant:"destructive",title:r("vector_database_node.errors.similarity_search_failed")})}finally{a(!1)}},[o,t,c,s,r,i,p,l]);return{loading:n,indexData:h,similaritySearchWithScore:m}},Ii=d.memo(t=>{var v,j,$,U;const{t:n}=G("flows"),[a,r]=d.useState(0),[s,o]=d.useState("search"),i=oe(t.id),{id:l,data:c,isConnectable:p}=t,{loading:u,similaritySearchWithScore:m,indexData:h}=Li(l),g=Te(Si),f=Te(Mi);Di(l);const x=d.useCallback(async(...B)=>{i&&await h(...B)},[h,i]),_=d.useCallback(async(B,M)=>{const A=B.trim(),P=await m(A,{k:M});if(P!=null&&P.length)return P},[m]),y=d.useCallback(B=>{g.show({source:i,documents:B.map(([M])=>M)})},[g,i]),k=d.useCallback(async()=>{f.show({source:i})},[f,i]),L=d.useCallback(async B=>{if(B.type.includes("text")||B.type.includes("txt")){const M=new FileReader;M.onload=async A=>{var S;const P=(S=A.target)==null?void 0:S.result;await x({content:P})},M.readAsText(B)}else if(B.type.endsWith("pdf")){const M=new Blob([B],{type:"application/pdf"}),A=await new Bo(M,{pdfjs:async()=>{const P=await ve(()=>import("./pdf.min-D22LfYNT.js").then(async S=>(await S.__tla,S)),__vite__mapDeps([8,2,3,1,4,5,6]));return await ve(()=>import("./pdf.worker.min-DKozKsPM.js").then(async S=>(await S.__tla,S)),__vite__mapDeps([9,1,2,3,4,5,6])),P.GlobalWorkerOptions.workerSrc=new URL("pdfjs-dist/build/pdf.worker.min.js",import.meta.url).toString(),P},parsedItemSeparator:" "}).load();await x({documents:A},{onProgressReport:P=>{r((P.handled+P.handling)/P.total)}})}},[x]),w=d.useMemo(()=>{var A,P;if(!((A=c==null?void 0:c.entity)!=null&&A.raw))return{headers:[],rows:[]};const B=["content","embedding","metadata"],M=dt((P=c==null?void 0:c.entity)==null?void 0:P.raw);return{headers:B,rows:M.map(S=>{try{return JSON.parse(S)}catch{return[]}})}},[(v=c==null?void 0:c.entity)==null?void 0:v.raw]),E=d.useMemo(()=>{switch(s){case"search":return e.jsx(Je,{value:"search",children:e.jsx(Go,{loading:u,onSimilaritySearch:_,onCreatePrompt:y,onCreateRetriever:k})});case"new":return e.jsx(Je,{className:"min-w-80",value:"new",children:e.jsx(Wo,{loading:u,onCreateData:x})});case"file":return e.jsx(Je,{value:"file",children:e.jsx(qo,{loading:u,progress:a,onFileSubmit:L,fileOptions:{accept:".pdf,.txt,.text",maxSize:15}})});case"view":return e.jsx(Je,{value:"view",children:e.jsx(nt,{data:w.rows,headers:w.headers,limitLengthByColumns:{embedding:32}})})}},[x,y,k,L,_,u,s,a,w]);return e.jsxs("div",{className:"min-w-72",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:p}),e.jsxs("div",{className:"max-w-full",children:[e.jsx(me,{id:l}),e.jsxs(je,{className:"flex justify-center",variant:"default",children:[e.jsx(H,{size:24,name:"database-zap"}),e.jsxs("div",{className:"ml-2 max-w-full",children:[e.jsx(Pe,{children:`${((j=c.entity)==null?void 0:j.name)||""}`}),e.jsxs(Js,{value:s,onValueChange:o,defaultValue:"search",className:J("w-full mt-4"),children:[e.jsxs(Ks,{className:J("grid w-full grid-cols-3",(($=c.entity)==null?void 0:$.storage)===$e.DatabaseNode?"grid-cols-4":"grid-cols-3"),children:[e.jsx(Ge,{value:"search",children:n("vector_database_node.search")}),e.jsx(Ge,{value:"new",children:n("vector_database_node.text")}),e.jsx(Ge,{value:"file",children:n("vector_database_node.file")}),((U=c.entity)==null?void 0:U.storage)===$e.DatabaseNode?e.jsx(Ge,{value:"view",children:n("vector_database_node.view")}):void 0]}),E]})]})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:p})]})}),Ai={embedding:32},Oi=d.memo(t=>{var o,i,l;const{id:n,data:a,isConnectable:r}=t,s=d.useMemo(()=>{var u;if(!((u=a==null?void 0:a.entity)!=null&&u.jsonl))return{headers:[],rows:[]};const c=lt(a.entity.headers||""),p=dt(a.entity.jsonl);return{headers:c,rows:p.map(m=>{try{return JSON.parse(m)}catch{return[]}})}},[(o=a==null?void 0:a.entity)==null?void 0:o.jsonl,a.entity.headers]);return e.jsxs("div",{className:"min-w-80",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs("div",{children:[e.jsx(me,{id:n}),e.jsxs(se,{className:"min-w-32 min-h-16 p-4",children:[e.jsx(de,{className:"!p-0",children:e.jsxs("div",{className:"pt-2 flex !flex-row",children:[e.jsx(H,{name:"file-json",className:"mr-2"}),e.jsxs(W,{className:"!font-medium leading-none tracking-tight pr-8",children:[b.JSONLData," ",(i=s==null?void 0:s.rows)!=null&&i.length?`(${((l=s==null?void 0:s.rows)==null?void 0:l.length)||0})`:""]})]})}),e.jsx(le,{className:"pb-0",children:e.jsx(nt,{data:s.rows,headers:s.headers,limitLengthByColumns:Ai})})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),_s=60,ys=140,Fi=Vs("supports-backdrop-blur:bg-white/10 supports-backdrop-blur:dark:bg-black/10 mx-auto flex h-[58px] w-max gap-2 rounded-lg border p-2 backdrop-blur-md"),vs=sa.forwardRef(({className:t,children:n,magnification:a=_s,distance:r=ys,direction:s="bottom",...o},i)=>{const l=Ma(1/0),c=()=>sa.Children.map(n,p=>sa.isValidElement(p)&&p.type===pa?sa.cloneElement(p,{...p.props,mouseX:l,magnification:a,distance:r}):p);return e.jsx($s.div,{ref:i,onMouseMove:p=>l.set(p.pageX),onMouseLeave:()=>l.set(1/0),...o,className:J(Fi({className:t}),{"items-start":s==="top","items-center":s==="middle","items-end":s==="bottom"}),children:c()})});vs.displayName="Dock";const pa=({magnification:t=_s,distance:n=ys,mouseX:a,className:r,children:s,...o})=>{const i=d.useRef(null),l=xt(a||new ko(0),u=>{var h;const m=((h=i.current)==null?void 0:h.getBoundingClientRect())??{x:0,width:0};return u-m.x-m.width/2}),c=xt(l,[-n,0,n],[40,t,40]),p=_n(c,{mass:.1,stiffness:150,damping:12});return e.jsx($s.div,{ref:i,style:{width:p},className:J("flex aspect-square cursor-pointer items-center justify-center rounded-full",r),...o,children:s})};pa.displayName="DockIcon";const Ti={[b.Shape]:{width:100,height:100},[b.CircleShape]:{width:100,height:100},[b.TriangleShape]:{width:100,height:100},[b.EditorApp]:{width:1240,height:400}},Ri=t=>{const n=oe(t),a=ae(l=>l.currentSession),[r,s]=d.useState(!1),o=T(l=>l.createOrUpdateFlowNode),i=d.useCallback(async l=>{var c,p,u;try{if(s(!0),n&&(a==null?void 0:a.id)){const m=((c=n.position)==null?void 0:c.x)||0,h=(((p=n.position)==null?void 0:p.y)||0)+(((u=n.measured)==null?void 0:u.height)||0),g=await I("FlowNodeData").save({data:{},session_id:a.id});if(!g)throw new Error("Failed to save node data");if(!await o({node_type:l,data:{},source_id:g.id,source_type:"FlowNodeData",x:m,y:h+20,...Ti[l]||{}}))throw new Error("Failed to save node")}}finally{s(!1)}},[o,a==null?void 0:a.id,n]);return{loading:r,createNode:i}},ws={applications:[{key:b.EditorApp,image:il,label:"application_bar.editor"},{key:b.VSLiteApp,icon:ol,label:"application_bar.vslite"}],shapes:[{key:b.Shape,icon:"square",label:"application_bar.square"},{key:b.CircleShape,icon:"circle",label:"application_bar.circle"},{key:b.TriangleShape,icon:"triangle",label:"application_bar.triangle"}]},Pi=d.memo(t=>{const{t:n}=G("flows"),{toast:a}=ye(),{loading:r,createNode:s}=Ri(t.id),o=async i=>{try{if(r)return;await s(i)}catch{a({description:n("application_bar.errors.add_node_failed"),variant:"destructive"})}};return e.jsx(Vd,{children:e.jsxs(vs,{direction:"middle",children:[ws.applications.map(i=>{const l=i.icon;return e.jsx(pa,{children:e.jsxs(rn,{children:[e.jsxs(on,{children:[l?e.jsx(l,{width:20,height:20,onClick:()=>o(i.key)}):void 0,i.image?e.jsx("img",{src:i.image,alt:n(i.label),className:"w-8 h-8 rounded-md",onClick:()=>o(i.key)}):void 0]}),e.jsx(dn,{children:e.jsx("p",{children:n(i.label)})})]})},i.label)}),e.jsx(Hd,{orientation:"vertical",className:"h-full"}),ws.shapes.map(i=>e.jsx(pa,{children:e.jsxs(rn,{children:[e.jsx(on,{children:e.jsx(H,{onClick:()=>o(i.key),name:i.icon})}),e.jsx(dn,{children:e.jsx("p",{children:n(i.label)})})]})},i.label))]})})}),ha=d.memo(t=>{const{lineClassName:n,handleClassName:a,...r}=t;return e.jsx(Jo,{lineClassName:J("!border-1.5",n),handleClassName:J("!w-2 !h-2 !border-2 !rounded-full",a),...r})}),$i=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([b.CircleShape,b.TriangleShape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===b.Shape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Vi=d.memo(t=>{const{id:n,selected:a,isConnectable:r}=t;return $i(n),e.jsxs(e.Fragment,{children:[e.jsx(ha,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsx("div",{className:"min-w-10 min-h-10 w-full h-full bg-border border",children:e.jsx(me,{id:n})}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:r})]})}),Hi=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([b.Shape,b.TriangleShape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===b.CircleShape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},zi=d.memo(t=>{const{id:n,selected:a,isConnectable:r}=t;return Hi(n),e.jsxs(e.Fragment,{children:[e.jsx(ha,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsx("div",{className:"min-w-10 min-h-10 w-full h-full bg-border rounded-full border",children:e.jsx(me,{id:n})}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:r})]})}),Ui=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if([b.CircleShape,b.Shape].includes(s==null?void 0:s.type)&&(o==null?void 0:o.type)===b.TriangleShape){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Bi=d.memo(t=>{const{id:n,selected:a,width:r,height:s,isConnectable:o}=t;return Ui(n),e.jsxs(e.Fragment,{children:[e.jsx(ha,{isVisible:!!a,minWidth:40,minHeight:40}),e.jsx(X,{type:"target",position:K.Top,isConnectable:o}),e.jsx("div",{className:"w-0 h-0 border-l-transparent border-r-transparent border-b-border",style:{borderLeftWidth:(r||0)/2,borderRightWidth:(r||0)/2,borderBottomWidth:s||0}}),e.jsx(me,{id:n,className:"absolute top-0 right-0"}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:o})]})}),qi=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.LLM&&(o==null?void 0:o.type)===b.EditorApp){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},Wi=t=>{const n=oe(t),{t:a}=G("flows"),r=d.useRef(null),{toast:s}=ye(),{getNode:o,getHandleConnections:i}=Ne(),{stream:l}=ut(),c=d.useCallback(async m=>{n&&(clearTimeout(r.current),r.current=setTimeout(async()=>{await I("FlowNode").update(n.id,{data:m})},150))},[n]),p=d.useCallback(async(m,h)=>{var g,f;if(n){const x=i({nodeId:t,type:"target"}).find(k=>{var L;return((L=o(k.source))==null?void 0:L.type)===b.LLM}),_=x?o(x==null?void 0:x.source):void 0,y=(g=_==null?void 0:_.data)==null?void 0:g.entity;if(!_||!y)return s({variant:"destructive",description:a("editor_node.errors.llm_not_found")});if(_.data.status!==ce.Loaded)return s({variant:"destructive",description:a("editor_node.errors.llm_not_loaded_yet")});try{return(f=await l(y.provider,typeof m=="string"?[new Ke(m)]:m,{onMessageUpdate:k=>{h==null||h(k.content)},llm:y}))==null?void 0:f.content}catch(k){if(k instanceof Error&&k.message.includes("LLM_NOT_LOADED_YET"))return s({title:a("editor_node.errors.llm_not_loaded_yet")});s({variant:"destructive",title:a("editor_node.errors.stream_message_failed")})}}},[n,i,t,o,s,a,l]),u=d.useCallback(m=>{if(!o(m))return[];const h=[];return i({nodeId:m,type:"target"}).forEach(g=>{const f=o(g.source);!f||f.type!==b.LLM||h.push({node:f,connections:[g]})}),h},[i,o]);return{createMessage:p,updateEditorContent:c,getLinkedConnections:u}},Gi=d.lazy(()=>ve(()=>import("./index-uHG90FFb.js").then(async t=>(await t.__tla,t)),__vite__mapDeps([10,2,3,11,4,12,13,14,15,16,6,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,1,5,58]))),Ji=d.memo(t=>{var p;const{id:n,data:a,selected:r,isConnectable:s}=t;qi(n);const{createMessage:o,updateEditorContent:i,getLinkedConnections:l}=Wi(n),c=d.useCallback(u=>{i(u)},[i]);return e.jsxs("div",{className:"w-full min-w-[1240px] h-full",children:[e.jsx(ha,{isVisible:!!r,minWidth:1240,minHeight:400}),e.jsx(X,{type:"target",position:K.Top,isConnectable:s}),e.jsxs("div",{className:"min-w-10 min-h-10 w-full h-full rounded-lg border bg-background",children:[e.jsx(me,{className:"!z-[100]",id:n,enableToStandalone:!0,getLinkedConnections:l}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-ful rounded-lg flex justify-center items-center",children:e.jsx(H,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx("div",{className:"h-full w-ful rounded-lg","data-registry":"plate",children:e.jsx(Gi,{defaultValue:(p=a==null?void 0:a.flowNode)==null?void 0:p.data,onValueChange:c,copilotStream:o})})})]}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:s})]})}),Ki=t=>{const n=d.useCallback(async({edgeId:a})=>{try{return{deleteEdgeId:a}}catch{return{deleteEdgeId:a}}},[]);pe(t,n)},Xi=d.memo(t=>{var i,l;const{id:n,data:a,isConnectable:r}=t,{t:s}=G("flows");Ki(n);let o="";switch((i=a.entity)==null?void 0:i.placeholder_type){case"VECTOR_DATABASE_RETREIVER":o=s("placeholder_node.vector_database_retriever");break}return e.jsxs("div",{children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:r}),e.jsxs(je,{className:"flex justify-center max-w-80",variant:"default",children:[e.jsx(me,{id:n}),e.jsx(H,{name:"land-plot",className:"w-7 h-7"}),e.jsxs("div",{className:"ml-2 pr-4",children:[e.jsx(Pe,{children:`${((l=a.entity)==null?void 0:l.placeholder)||""}`}),e.jsx(na,{children:o?e.jsx(Be,{children:o}):void 0})]})]}),e.jsx(X,{type:"source",position:K.Bottom,id:"a",isConnectable:r})]})}),Yi=["empty-source","vite-vue","shadcn-react-vite","todo-app-react-vite","porfolio-nextjs"],Qi=async t=>{switch(t){case"empty-source":return ve(()=>import("./empty-source-Dw1dvL8s.js"),[]).then(n=>n.BASE);case"vite-vue":return ve(()=>import("./vite-vue-Bmz2z3Fo.js"),[]).then(n=>n.BASE);case"shadcn-react-vite":return ve(()=>import("./shadcn-react-vite-CDJ9BaE9.js"),[]).then(n=>n.BASE);case"todo-app-react-vite":return ve(()=>import("./todo-app-react-vite-BBWBkRjR.js"),[]).then(n=>n.BASE);case"porfolio-nextjs":return ve(()=>import("./porfolio-nextjs-DCkli5iW.js"),[]).then(n=>n.BASE);default:throw new Error(`Unknown source base: ${t}`)}},Zi=d.memo(({className:t,onUpdateSourceBase:n})=>{const{t:a}=G("components"),[r,s]=d.useState();return e.jsxs(se,{className:J("mw-full",t),children:[e.jsx(de,{className:"p-4",children:e.jsx(he,{children:a("add_source_base.title")})}),e.jsx(le,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-center w-full h-full flex-col",children:[e.jsxs(De,{onValueChange:o=>s(o),children:[e.jsx(Le,{className:"w-full mb-4",children:e.jsx(Ie,{placeholder:a("add_source_base.source_base_select_placeholder")})}),e.jsx(Ae,{children:Yi.map(o=>e.jsx(fe,{value:`${o}`,children:a(`add_source_base.sourcebases.${o.toLowerCase()}`)},`${o}`))})]}),e.jsx(Z,{className:"w-full",onClick:async()=>r&&n(await Qi(r)),children:a("add_source_base.update_source")})]})})]})}),eo=()=>{const{getNode:t,getHandleConnections:n}=Ne(),{stream:a}=ut(),r=d.useCallback(async(o,i)=>{await I("FlowNode").update(o,{raw:dl(i)})},[]),s=d.useCallback(o=>{if(!t(o))return[];const i=[];return n({nodeId:o,type:"target"}).forEach(l=>{const c=t(l.source);!c||c.type!==b.LLM||i.push({node:c,connections:[l]})}),i},[n,t]);return{sendMessage:d.useCallback(async(o,i,{onMessageUpdate:l,onResponseMessageCreate:c}={})=>{const p=i.map(m=>m.role==="system"?new sn(m.content):m.role==="user"?new Ke(m.content):new Ea(m.content));c==null||c();const u=await a(z.WebLLM,[...p,new Ke(o)],{onMessageUpdate:({content:m})=>{l==null||l({nodeData:{loading:!0,content:m}})},llm:void 0});return l==null||l({nodeData:{loading:!1,content:u==null?void 0:u.content}}),u==null?void 0:u.content},[a]),getLinkedConnections:s,updateCodeContainerData:r}},ao=t=>{const n=T(r=>r.createOrUpdateFlowEdge),a=d.useCallback(async({edgeId:r,source:s,target:o,connection:i})=>{try{if((s==null?void 0:s.type)===b.LLM&&(o==null?void 0:o.type)===b.VSLiteApp){await n({source:i.source,target:i.target,sourceHandle:i.sourceHandle,targetHandle:i.targetHandle});return}return{deleteEdgeId:r}}catch{return{deleteEdgeId:r}}},[n]);pe(t,a)},to=d.lazy(()=>ve(()=>import("./index-TU_g0_YJ.js").then(async t=>(await t.__tla,t)),__vite__mapDeps([59,2,3,4,12,36,6,60,61,62,15,63]))),so=d.memo(t=>{var h,g,f,x;const{id:n,isConnectable:a,data:r}=t,[s,o]=d.useState((h=r==null?void 0:r.flowNode)!=null&&h.raw?ll(r.flowNode.raw):void 0),{updateCodeContainerData:i,getLinkedConnections:l,sendMessage:c}=eo();ao(n);const p=d.useCallback(async _=>{var y,k;(y=r==null?void 0:r.flowNode)!=null&&y.id&&(await i((k=r==null?void 0:r.flowNode)==null?void 0:k.id,_),o(_))},[(g=r==null?void 0:r.flowNode)==null?void 0:g.id,i]),u=d.useCallback(async(_,y)=>{var k;return(k=r==null?void 0:r.flowNode)!=null&&k.id?await c(_,y):void 0},[(f=r==null?void 0:r.flowNode)==null?void 0:f.id,c]),m=d.useCallback(async _=>{o(y=>{var L;const k=cl(y||{},_);return i((L=r==null?void 0:r.flowNode)==null?void 0:L.id,k),k})},[(x=r==null?void 0:r.flowNode)==null?void 0:x.id,i]);return s?e.jsxs("div",{className:"w-[1380px] h-[600px] rounded-lg border overflow-hidden shadow-sm",children:[e.jsx(X,{type:"target",position:K.Top,isConnectable:a}),e.jsxs("div",{className:"w-full h-full rounded-lg border bg-card overflow-hidden",children:[e.jsx(me,{id:n,className:"z-50",enableToStandalone:!0,getLinkedConnections:l}),e.jsx(d.Suspense,{fallback:e.jsx("div",{className:"h-full w-full flex justify-center items-center",children:e.jsx(H,{name:"loader-circle",className:"animate-spin"})}),children:e.jsx(to,{fileSystemTree:s,onUpdateFileContent:m,sendMessage:u})})]}),e.jsx(X,{type:"source",position:K.Bottom,isConnectable:a})]}):e.jsx("div",{className:"h-full flex justify-center items-center",children:e.jsx(Zi,{className:"w-64",onUpdateSourceBase:p})})}),no={[b.LLM]:ti,[b.Toolbox]:Kr,[b.Thread]:oi,[b.Message]:mi,[b.Prompt]:hi,[b.SessionInfo]:fi,[b.Schema]:xi,[b.CSVData]:_i,[b.ToolDefinition]:vi,[b.DefaultEmbeddingModel]:Ni,[b.VectorDatabase]:Ii,[b.JSONLData]:Oi,[b.ApplicationBar]:Pi,[b.Shape]:Vi,[b.CircleShape]:zi,[b.TriangleShape]:Bi,[b.EditorApp]:Ji,[b.PlaceHolder]:Xi,[b.VSLiteApp]:so},js=Vs("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3 min-w-10",sm:"h-9 px-2.5 min-w-9",lg:"h-11 px-5 min-w-11"}},defaultVariants:{variant:"default",size:"default"}}),ro=d.forwardRef(({className:t,variant:n,size:a,...r},s)=>e.jsx(hn,{ref:s,className:J(js({variant:n,size:a,className:t})),...r}));ro.displayName=hn.displayName;const bs=d.createContext({size:"default",variant:"default"}),Ns=d.forwardRef(({className:t,variant:n,size:a,children:r,...s},o)=>e.jsx(fn,{ref:o,className:J("flex items-center justify-center gap-1",t),...s,children:e.jsx(bs.Provider,{value:{variant:n,size:a},children:r})}));Ns.displayName=fn.displayName;const Cs=d.forwardRef(({className:t,children:n,variant:a,size:r,...s},o)=>{const i=d.useContext(bs);return e.jsx(gn,{ref:o,className:J(js({variant:i.variant||a,size:i.size||r}),t),...s,children:n})});Cs.displayName=gn.displayName;function io(){const t=Ko(n=>`x: ${n.transform[0].toFixed(2)}, y: ${n.transform[1].toFixed(2)}, zoom: ${n.transform[2].toFixed(2)}`);return e.jsx("div",{children:t})}function oo({change:t}){var r,s,o,i;const n="id"in t?t.id:"-",{type:a}=t;return e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{children:["node id: ",n]}),e.jsxs("div",{children:[a==="add"?JSON.stringify(t.item,null,2):null,a==="dimensions"?`dimensions: ${(r=t.dimensions)==null?void 0:r.width} \xD7 ${(s=t.dimensions)==null?void 0:s.height}`:null,a==="position"?`position: ${(o=t.position)==null?void 0:o.x.toFixed(1)}, ${(i=t.position)==null?void 0:i.y.toFixed(1)}`:null,a==="remove"?"remove":null,a==="select"?t.selected?"select":"unselect":null]})]})}function lo({limit:t=20}){const[n,a]=d.useState([]),r=Xo(),s=d.useCallback(i=>{a(l=>[...i,...l].slice(0,t))},[t]);d.useEffect(()=>(r.setState({onNodesChange:s}),()=>r.setState({onNodesChange:void 0})),[s,r]);const o=()=>e.jsx("div",{children:"No Changes Triggered"});return e.jsx(e.Fragment,{children:n.length===0?e.jsx(o,{}):n.map((i,l)=>e.jsx(oo,{change:i},l))})}function co(){const{getInternalNode:t}=Ne(),n=Xs();return e.jsx(Yo,{children:e.jsx("div",{className:"text-secondary-foreground",children:n.map(a=>{var o,i;const r=t(a.id);if(!r)return null;const s=r==null?void 0:r.internals.positionAbsolute;return e.jsx(uo,{id:a.id,selected:!!a.selected,type:a.type||"default",position:a.position,absPosition:s,width:((o=a.measured)==null?void 0:o.width)??0,height:((i=a.measured)==null?void 0:i.height)??0,data:a.data},a.id)})})})}function uo({id:t,type:n,selected:a,position:r,absPosition:s,width:o,height:i,data:l}){if(!o||!i)return null;const c=`translate(${s.x}px, ${s.y+i}px)`,p=`${r.x.toFixed(1)}, ${r.y.toFixed(1)}`,u=`${o} \xD7 ${i}`,m=a?"Selected":"Not Selected";return e.jsxs("div",{style:{position:"absolute",transform:c,width:o*2},className:"text-xs",children:[e.jsxs("div",{children:["id: ",t]}),e.jsxs("div",{children:["type: ",n]}),e.jsxs("div",{children:["selected: ",m]}),e.jsxs("div",{children:["position: ",p]}),e.jsxs("div",{children:["dimensions: ",u]}),e.jsxs("div",{children:["data: ",JSON.stringify(l,null,2)]})]})}function mo({tools:t}){return e.jsx(rt,{position:"top-left",className:"bg-card p-1 border rounded shadow-sm",children:e.jsx(Ns,{type:"multiple",children:t.map(({active:n,setActive:a,label:r,value:s})=>e.jsx(Cs,{value:s,onClick:()=>a(o=>!o),"aria-pressed":n,className:"bg-card text-card-foreground transition-colors duration-300 hover:bg-secondary hover:text-secondary-foreground",children:r},s))})})}function Ss(){const[t,n]=d.useState(!1),[a,r]=d.useState(!1),[s,o]=d.useState(!1),i=[{active:t,setActive:n,label:"Node Inspector",value:"node-inspector"},{active:a,setActive:r,label:"Change Logger",value:"change-logger"},{active:s,setActive:o,label:"Viewport Logger",value:"viewport-logger"}];return e.jsxs(e.Fragment,{children:[e.jsx(mo,{tools:i}),a&&e.jsx(rt,{className:"text-xs p-5 bg-white rounded shadow-md overflow-y-auto max-h-[50%] mt-20",position:"bottom-right",children:e.jsx(lo,{})}),t&&e.jsx(co,{}),s&&e.jsx(rt,{position:"bottom-left",className:"text-secondary-foreground",children:e.jsx(io,{})})]})}Ss.displayName="DevTools";let Es,ks,Ms,Ds;Es=()=>{const t=d.useRef({}),n=d.useRef({}),a=d.useRef([]),r=T(M=>M.flowEdges),s=ae(M=>M.currentSession),o=T(M=>M.setNodes),i=T(M=>M.updateNodes),l=T(M=>M.updateEdges),c=T(M=>M.addConnectionToEdges),p=T(M=>M.reset),u=T(M=>M.findFlowEdges),m=T(M=>M.deleteFlowNode),h=T(M=>M.deleteFlowEdge),g=T(M=>M.updateFlowNode),f=T(M=>M.getNodes),x=T(M=>M.findFlowNodesWithSource),_=d.useRef(r),y=d.useRef(),[k,L]=d.useState({loading:!1});_.current=r;const w=d.useCallback(async(M,A)=>{try{y.current=M,p(),await(A==null?void 0:A())}catch{y.current=void 0}},[p]),E=d.useCallback(async M=>{try{if(!(s!=null&&s.id))return;L(S=>({...S,loading:!0}));const A=await x({...M,where:{...M.where,session_id:s.id}}),P=await u({where:[{source:ct(A.map(S=>S.id))},{target:ct(A.map(S=>S.id))}]});return{flowNodes:A,flowEdges:P}}finally{L(A=>({...A,loading:!1}))}},[x,u,s==null?void 0:s.id]),v=d.useCallback(async M=>{var A,P;for(const S of a.current){const D=await S(M);if(typeof D=="boolean"&&!D)return}for(const S of M)if("id"in S&&Object.values(wa).includes(S.id)&&S.type!=="remove")i([S]);else if(S.type==="position"&&S.position&&!isNaN(S.position.x)&&!isNaN(S.position.y)){i([S]);const D=S.position.x,q=S.position.y;clearTimeout(t.current[S.id]),t.current[S.id]=setTimeout(async()=>{t.current[S.id]=void 0,await g({id:S.id,x:D,y:q},{silent:!0})},200)}else if(S.type==="remove"){const D=(A=f([S.id]))==null?void 0:A[0];if(!(D!=null&&D.type)||Qo.includes(D.type))return;await m({id:S.id})}else if(S.type==="dimensions"&&S.dimensions&&!isNaN(S.dimensions.width)&&!isNaN(S.dimensions.height)){const D=(P=f([S.id]))==null?void 0:P[0];if(!(D!=null&&D.width)&&!(D!=null&&D.height))return;i([S]),clearTimeout(n.current[S.id]);const q=S.dimensions.width,Y=S.dimensions.height;n.current[S.id]=setTimeout(async()=>{await g({id:S.id,width:q,height:Y},{silent:!0})},200)}else S.type==="select"&&i([S])},[i,g,f,m]),j=d.useCallback(M=>{Promise.all(M.map(async A=>{if(A.type==="remove")return h({id:A.id})})),l(M)},[h,l]),$=d.useCallback(M=>{c(M)},[c]),U=d.useCallback(M=>{o(A=>{var q,Y;let P;if(typeof M=="function"?P=M(A):P=M,!P)return A;const S=A==null?void 0:A.find(ee=>ee.id===P.id),D={id:P.id,item:S?Zo(S,P):{...P,position:{x:((q=P.position)==null?void 0:q.x)||0,y:((Y=P.position)==null?void 0:Y.y)||0}},type:S?"replace":"add"};return ed([D],A)})},[o]),B=d.useCallback(M=>(a.current.push(M),()=>{a.current=a.current.filter(A=>A!==M)}),[]);return{initFlow:w,loadingState:k,prepareFlowInfo:E,updateNodeChanges:v,updateEdgeChanges:j,updateOrCreateNode:U,currentSessionIdRef:y,updateEdgeConnection:$,addOnNodeChangeHandler:B}},ks=t=>{const n=ae(m=>{var h;return(h=m.currentSession)==null?void 0:h.id}),{loadingState:a,prepareFlowInfo:r,initFlow:s,currentSessionIdRef:o}=t,i=T(m=>m.ready),l=T(m=>m.nodes),c=d.useRef(l),p=T(m=>m.removeSyncNodeQueue),u=T(m=>m.removeSyncEdgeQueue);c.current=l,d.useEffect(()=>{a.loading||!i||!n||o.current===n||s(n,async()=>{await r({where:{session_id:n}})})},[s,r,a.loading,o,i,n]),d.useEffect(()=>{const m=T.subscribe(g=>g.syncNodeQueue,async(g,f)=>{const x=f.map(y=>y.timestamp),_=g.filter(y=>!x.includes(y.timestamp));_.length&&p(_.map(y=>y.timestamp))}),h=T.subscribe(g=>g.syncEdgeQueue,async(g,f)=>{const x=f.map(y=>y.timestamp),_=g.filter(y=>!x.includes(y.timestamp));_.length&&u(_.map(y=>y.timestamp))});return()=>{m(),h()}},[r,u,p])},Ms=()=>{const[t,n]=d.useState(!0),a=Es(),r=ia(u=>u.selectedModel),s=d.useRef(r),o=ia(u=>u.setInitProgressCallback),{updateOrCreateNode:i,updateNodeChanges:l,updateEdgeChanges:c,updateEdgeConnection:p}=a;return ks(a),s.current=r,d.useEffect(()=>{const u=o==null?void 0:o(m=>{if(!s.current)return;const h=`${s.current}`;i(g=>{const f=g==null?void 0:g.find(x=>{var _;return(_=x.data)!=null&&_.entity&&typeof x.data.entity=="object"&&"name"in x.data.entity?x.data.entity.name===h:!1});if(f)return f.data.label=m.text,f.data.status=ce.Loading,m.progress===100&&(f.data.label="",f.data.status=ce.Loaded),f})});return()=>{u==null||u()}},[o,i]),d.useMemo(()=>({updateNodeChanges:l,updateEdgeChanges:c,initializing:t,setInitializing:n,updateEdgeConnection:p}),[l,c,t,n,p])},Ds=()=>{const t=Rs(p=>p.theme),n=T(p=>p.nodes),a=T(p=>p.edges),{updateNodeChanges:r,updateEdgeChanges:s,updateEdgeConnection:o}=Ms(),i=d.useCallback(p=>{r(p)},[r]),l=d.useCallback(p=>{s(p)},[s]),c=d.useCallback(p=>{o(p)},[o]);return e.jsxs(ad,{nodes:n,edges:a,nodeTypes:no,onNodesChange:i,onEdgesChange:l,onConnect:c,panOnScroll:!0,panOnScrollMode:td.Free,colorMode:t,fitView:!0,children:[e.jsx(sd,{variant:nd.Dots,gap:24,size:1}),e.jsx(rd,{}),e.jsx(id,{}),Mo?e.jsx(Ss,{}):void 0]})},xn=d.memo(Ds)});export{ml as __tla,xn as default};
