var g_=Object.defineProperty;var b_=(es,Qt,js)=>Qt in es?g_(es,Qt,{enumerable:!0,configurable:!0,writable:!0,value:js}):es[Qt]=js;var $p=(es,Qt,js)=>b_(es,typeof Qt!="symbol"?Qt+"":Qt,js);import{G as Lp,ae as __,af as Ns,g as v_,B as at,r as M,j as se,c as Ie,v as w_,w as Bp,e as qp,I as Dp,f as x_,d as O_,L as E_,__tla as M_}from"./index-RiB-44Db.js";import{bk as Up,bl as Fp,bm as nn,bn as ba,b5 as Zp,bo as Wp,bp as k_,bq as zp,A as an,p as Vt,r as C_,s as A_,t as P_,v as S_,b3 as T_,b4 as N_,B as j_,al as _a,H as Vp,br as R_,bs as I_,af as va,bt as $_,bu as L_,bv as Yn,aF as Kp,bw as B_,bx as q_,by as Qp,aK as go,bz as Hp,bA as D_,bB as Jp,bC as bo,bD as fs,bE as Gp,aH as Kt,bF as Xt,bG as Xp,bH as wa,bI as U_,bJ as F_,bK as Z_,ag as W_,bL as z_,bM as ys,bN as V_,bO as K_,bP as Q_,bQ as H_,aI as J_,bR as Yp,bS as G_,bT as eh,ai as xa,bU as Oa,bV as th,bW as rn,bX as Ea,bY as sh,bZ as nh,b_ as ih,b$ as X_,c0 as Y_,c1 as _o,c2 as vo,c3 as ei,c4 as ah,c5 as ev,u as tv,__tla as sv}from"./routes-lkvfg71l.js";import rh from"./dot-C2v_uavk.js";let wo,Ma,xo,Oo,ae,Eo,oh,Mo,ch,lh,ko,Co,ka,ti,si,ht,Ao,uh,Ca,ni,Yt,dh,Aa,ph,Po,hh,mh,fh,ii,gs,Pa,jt,nv=Promise.all([(()=>{try{return M_}catch{}})(),(()=>{try{return sv}catch{}})()]).then(async()=>{ka=globalThis||void 0||self,Oo=(s=>(s.Started="started",s.Downloading="downloading",s.Downloaded="downloaded",s.Loading="loading",s.Loaded="loaded",s))(Oo||{}),Ao=(s=>(s.LLM="LLM",s.embedding="embedding",s.VLM="VLM",s))(Ao||{}),ht=(s=>(s.WebLLM="WebLLM",s.Wllama="Wllama",s.OpenAI="OpenAI",s.Groq="Groq",s.GoogleGenerativeAI="GoogleGenerativeAI",s))(ht||{});function es(s,e,t,n,i){if(e!==s){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=Up(e),r=Up(s),o=!1,c=r.length-1;c>=0;c--){var l=r[c],u=s[l];if(Fp(e,l)&&!(e[l]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var d=e[l];typeof u=="object"&&u!=null&&typeof d=="object"&&d!=null&&Array.isArray(u)===Array.isArray(d)?es(u,d,t,n+"/"+nn(l),i):u!==d&&(i&&t.push({op:"test",path:n+"/"+nn(l),value:ba(u)}),t.push({op:"replace",path:n+"/"+nn(l),value:ba(d)}))}else Array.isArray(s)===Array.isArray(e)?(i&&t.push({op:"test",path:n+"/"+nn(l),value:ba(u)}),t.push({op:"remove",path:n+"/"+nn(l)}),o=!0):(i&&t.push({op:"test",path:n,value:s}),t.push({op:"replace",path:n,value:e}))}if(!(!o&&a.length==r.length))for(var c=0;c<a.length;c++){var l=a[c];!Fp(s,l)&&e[l]!==void 0&&t.push({op:"add",path:n+"/"+nn(l),value:ba(e[l])})}}}function Qt(s,e,t=!1){var n=[];return es(s,e,n,"",t),n}si=function(s,e){const t=typeof s;if(t!==typeof e)return!1;if(Array.isArray(s)){if(!Array.isArray(e))return!1;const n=s.length;if(n!==e.length)return!1;for(let i=0;i<n;i++)if(!si(s[i],e[i]))return!1;return!0}if(t==="object"){if(!s||!e)return s===e;const n=Object.keys(s),i=Object.keys(e);if(n.length!==i.length)return!1;for(const a of n)if(!si(s[a],e[a]))return!1;return!0}return s===e};class js{getState(){return Zp.getState()}async loadModel(e){await this.getState().loadModel(e,{provider:"WebLLM"})}async unloadModel(){this.getState().unLoadModel()}async getCurrentModel(){var e;return(e=await this.getState().getCurrentModelInfo())==null?void 0:e.model}chatCompletion(e,t={}){const n=this.getState(),{stream:i=!0,response_format:a,tools:r,...o}=t,c={provider:"WebLLM",stream:i,...o};if((a==null?void 0:a.type)==="json_object"&&(c.response_format=a),r!=null&&r.length&&(c.tools=r),i){const l=n.chatCompletion(e,c);return this.streamResponse(l)}else return this.nonStreamResponse(n,e,c)}async nonStreamResponse(e,t,n){var i;return{content:((i=await e.chatCompletion(t,{...n,stream:!1}))==null?void 0:i.content)||"",usage:{}}}async*streamResponse(e){for await(const t of e)yield{content:(t==null?void 0:t.content)||"",chunk:t}}}const bh=new js;class _h{constructor(){$p(this,"currentModel")}async loadModel(e){await Wp(e,{provider:"Wllama"}),this.currentModel=e}async unloadModel(){await k_(),this.currentModel=void 0}getCurrentModel(){return this.currentModel}chatCompletion(e,t={}){const{stream:n=!0,response_format:i,tools:a}=t;if((i==null?void 0:i.type)==="json_object")throw new Error("Structured output not supported in Wllama yet");if(a!=null&&a.length)throw new Error("Function calling not supported in Wllama yet");return n?this.streamResponse(e):this.nonStreamResponse(e)}async nonStreamResponse(e){let t="";return await zp(e,{onNewToken:(n,i,a)=>{t+=a}}),{content:t,usage:{}}}async*streamResponse(e){let t="";await zp(e,{onNewToken:async(n,i,a)=>{t+=a}}),yield{content:t,chunk:new an(t)}}}const vh=new _h,Sa=bh,Ta=vh,wh=Symbol("Let zodToJsonSchema decide on which parser to use"),To={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},xh=s=>typeof s=="string"?{...To,name:s}:{...To,...s},Oh=s=>{const e=xh(s),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,i])=>[i._def,{def:i._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function No(s,e,t,n){n!=null&&n.errorMessages&&t&&(s.errorMessage={...s.errorMessage,[e]:t})}function pe(s,e,t,n,i){s[e]=t,No(s,e,n,i)}var ce;(function(s){s.assertEqual=i=>i;function e(i){}s.assertIs=e;function t(i){throw new Error}s.assertNever=t,s.arrayToEnum=i=>{const a={};for(const r of i)a[r]=r;return a},s.getValidEnumValues=i=>{const a=s.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),r={};for(const o of a)r[o]=i[o];return s.objectValues(r)},s.objectValues=i=>s.objectKeys(i).map(function(a){return i[a]}),s.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const a=[];for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&a.push(r);return a},s.find=(i,a)=>{for(const r of i)if(a(r))return r},s.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&isFinite(i)&&Math.floor(i)===i;function n(i,a=" | "){return i.map(r=>typeof r=="string"?`'${r}'`:r).join(a)}s.joinValues=n,s.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(ce||(ce={}));var Na;(function(s){s.mergeShapes=(e,t)=>({...e,...t})})(Na||(Na={}));const $=ce.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ts=s=>{switch(typeof s){case"undefined":return $.undefined;case"string":return $.string;case"number":return isNaN(s)?$.nan:$.number;case"boolean":return $.boolean;case"function":return $.function;case"bigint":return $.bigint;case"symbol":return $.symbol;case"object":return Array.isArray(s)?$.array:s===null?$.null:s.then&&typeof s.then=="function"&&s.catch&&typeof s.catch=="function"?$.promise:typeof Map<"u"&&s instanceof Map?$.map:typeof Set<"u"&&s instanceof Set?$.set:typeof Date<"u"&&s instanceof Date?$.date:$.object;default:return $.unknown}},k=ce.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Eh=s=>JSON.stringify(s,null,2).replace(/"([^"]+)":/g,"$1:");let gt=class yh extends Error{constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(a){return a.message},n={_errors:[]},i=a=>{for(const r of a.issues)if(r.code==="invalid_union")r.unionErrors.map(i);else if(r.code==="invalid_return_type")i(r.returnTypeError);else if(r.code==="invalid_arguments")i(r.argumentsError);else if(r.path.length===0)n._errors.push(t(r));else{let o=n,c=0;for(;c<r.path.length;){const l=r.path[c];c===r.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(r))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return i(this),n}static assert(e){if(!(e instanceof yh))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ce.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const i of this.issues)i.path.length>0?(t[i.path[0]]=t[i.path[0]]||[],t[i.path[0]].push(e(i))):n.push(e(i));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}};gt.create=s=>new gt(s);const Rs=(s,e)=>{let t;switch(s.code){case k.invalid_type:s.received===$.undefined?t="Required":t=`Expected ${s.expected}, received ${s.received}`;break;case k.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(s.expected,ce.jsonStringifyReplacer)}`;break;case k.unrecognized_keys:t=`Unrecognized key(s) in object: ${ce.joinValues(s.keys,", ")}`;break;case k.invalid_union:t="Invalid input";break;case k.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ce.joinValues(s.options)}`;break;case k.invalid_enum_value:t=`Invalid enum value. Expected ${ce.joinValues(s.options)}, received '${s.received}'`;break;case k.invalid_arguments:t="Invalid function arguments";break;case k.invalid_return_type:t="Invalid function return type";break;case k.invalid_date:t="Invalid date";break;case k.invalid_string:typeof s.validation=="object"?"includes"in s.validation?(t=`Invalid input: must include "${s.validation.includes}"`,typeof s.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${s.validation.position}`)):"startsWith"in s.validation?t=`Invalid input: must start with "${s.validation.startsWith}"`:"endsWith"in s.validation?t=`Invalid input: must end with "${s.validation.endsWith}"`:ce.assertNever(s.validation):s.validation!=="regex"?t=`Invalid ${s.validation}`:t="Invalid";break;case k.too_small:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at least":"more than"} ${s.minimum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at least":"over"} ${s.minimum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${s.minimum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(s.minimum))}`:t="Invalid input";break;case k.too_big:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at most":"less than"} ${s.maximum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at most":"under"} ${s.maximum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="bigint"?t=`BigInt must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly":s.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(s.maximum))}`:t="Invalid input";break;case k.custom:t="Invalid input";break;case k.invalid_intersection_types:t="Intersection results could not be merged";break;case k.not_multiple_of:t=`Number must be a multiple of ${s.multipleOf}`;break;case k.not_finite:t="Number must be finite";break;default:t=e.defaultError,ce.assertNever(s)}return{message:t}};let jo=Rs;function Mh(s){jo=s}function ri(){return jo}const oi=s=>{const{data:e,path:t,errorMaps:n,issueData:i}=s,a=[...t,...i.path||[]],r={...i,path:a};if(i.message!==void 0)return{...i,path:a,message:i.message};let o="";const c=n.filter(l=>!!l).slice().reverse();for(const l of c)o=l(r,{data:e,defaultError:o}).message;return{...i,path:a,message:o}},kh=[];function j(s,e){const t=ri(),n=oi({issueData:e,data:s.data,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,t,t===Rs?void 0:Rs].filter(i=>!!i)});s.common.issues.push(n)}class ze{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const i of t){if(i.status==="aborted")return J;i.status==="dirty"&&e.dirty(),n.push(i.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const i of t){const a=await i.key,r=await i.value;n.push({key:a,value:r})}return ze.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const i of t){const{key:a,value:r}=i;if(a.status==="aborted"||r.status==="aborted")return J;a.status==="dirty"&&e.dirty(),r.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof r.value<"u"||i.alwaysSet)&&(n[a.value]=r.value)}return{status:e.value,value:n}}}const J=Object.freeze({status:"aborted"}),ci=s=>({status:"dirty",value:s}),Je=s=>({status:"valid",value:s}),ja=s=>s.status==="aborted",Ra=s=>s.status==="dirty",on=s=>s.status==="valid",cn=s=>typeof Promise<"u"&&s instanceof Promise;function li(s,e,t,n){if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(s)}function Ro(s,e,t,n,i){if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(s,t),t}var D;(function(s){s.errToObj=e=>typeof e=="string"?{message:e}:e||{},s.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(D||(D={}));var ln,un;class Rt{constructor(e,t,n,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=i}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Io=(s,e)=>{if(on(e))return{success:!0,data:e.value};if(!s.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new gt(s.common.issues);return this._error=t,this._error}}};function ee(s){if(!s)return{};const{errorMap:e,invalid_type_error:t,required_error:n,description:i}=s;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:i}:{errorMap:(a,r)=>{var o,c;const{message:l}=s;return a.code==="invalid_enum_value"?{message:l??r.defaultError}:typeof r.data>"u"?{message:(o=l??n)!==null&&o!==void 0?o:r.defaultError}:a.code!=="invalid_type"?{message:r.defaultError}:{message:(c=l??t)!==null&&c!==void 0?c:r.defaultError}},description:i}}class ne{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return ts(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:ts(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ze,ctx:{common:e.parent.common,data:e.data,parsedType:ts(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(cn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const i={common:{issues:[],async:(n=t==null?void 0:t.async)!==null&&n!==void 0?n:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ts(e)},a=this._parseSync({data:e,path:i.path,parent:i});return Io(i,a)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ts(e)},i=this._parse({data:e,path:n.path,parent:n}),a=await(cn(i)?i:Promise.resolve(i));return Io(n,a)}refine(e,t){const n=i=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(i):t;return this._refinement((i,a)=>{const r=e(i),o=()=>a.addIssue({code:k.custom,...n(i)});return typeof Promise<"u"&&r instanceof Promise?r.then(c=>c?!0:(o(),!1)):r?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,i)=>e(n)?!0:(i.addIssue(typeof t=="function"?t(n,i):t),!1))}_refinement(e){return new vt({schema:this,typeName:C.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return $t.create(this,this._def)}nullable(){return rs.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return _t.create(this,this._def)}promise(){return Bs.create(this,this._def)}or(e){return mn.create([this,e],this._def)}and(e){return fn.create(this,e,this._def)}transform(e){return new vt({...ee(this._def),schema:this,typeName:C.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new vn({...ee(this._def),innerType:this,defaultValue:t,typeName:C.ZodDefault})}brand(){return new La({typeName:C.ZodBranded,type:this,...ee(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new wn({...ee(this._def),innerType:this,catchValue:t,typeName:C.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return xn.create(this,e)}readonly(){return On.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Ch=/^c[^\s-]{8,}$/i,Ah=/^[0-9a-z]+$/,Ph=/^[0-9A-HJKMNP-TV-Z]{26}$/,Sh=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Th=/^[a-z0-9_-]{21}$/i,Nh=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,jh=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Rh="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Ia;const Ih=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,$h=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Lh=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,$o="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Bh=new RegExp(`^${$o}$`);function Lo(s){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return s.precision?e=`${e}\\.\\d{${s.precision}}`:s.precision==null&&(e=`${e}(\\.\\d+)?`),e}function qh(s){return new RegExp(`^${Lo(s)}$`)}function Bo(s){let e=`${$o}T${Lo(s)}`;const t=[];return t.push(s.local?"Z?":"Z"),s.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Dh(s,e){return!!((e==="v4"||!e)&&Ih.test(s)||(e==="v6"||!e)&&$h.test(s))}class bt extends ne{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==$.string){const i=this._getOrReturnCtx(e);return j(i,{code:k.invalid_type,expected:$.string,received:i.parsedType}),J}const t=new ze;let n;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if(i.kind==="max")e.data.length>i.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,r=e.data.length<i.value;(a||r)&&(n=this._getOrReturnCtx(e,n),a?j(n,{code:k.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):r&&j(n,{code:k.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),t.dirty())}else if(i.kind==="email")jh.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"email",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="emoji")Ia||(Ia=new RegExp(Rh,"u")),Ia.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"emoji",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="uuid")Sh.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"uuid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="nanoid")Th.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"nanoid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="cuid")Ch.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"cuid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="cuid2")Ah.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"cuid2",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="ulid")Ph.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"ulid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),j(n,{validation:"url",code:k.invalid_string,message:i.message}),t.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"regex",code:k.invalid_string,message:i.message}),t.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),t.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_string,validation:{startsWith:i.value},message:i.message}),t.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_string,validation:{endsWith:i.value},message:i.message}),t.dirty()):i.kind==="datetime"?Bo(i).test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_string,validation:"datetime",message:i.message}),t.dirty()):i.kind==="date"?Bh.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_string,validation:"date",message:i.message}),t.dirty()):i.kind==="time"?qh(i).test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:k.invalid_string,validation:"time",message:i.message}),t.dirty()):i.kind==="duration"?Nh.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"duration",code:k.invalid_string,message:i.message}),t.dirty()):i.kind==="ip"?Dh(e.data,i.version)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"ip",code:k.invalid_string,message:i.message}),t.dirty()):i.kind==="base64"?Lh.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"base64",code:k.invalid_string,message:i.message}),t.dirty()):ce.assertNever(i);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(i=>e.test(i),{validation:t,code:k.invalid_string,...D.errToObj(n)})}_addCheck(e){return new bt({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...D.errToObj(e)})}url(e){return this._addCheck({kind:"url",...D.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...D.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...D.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...D.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...D.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...D.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...D.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...D.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...D.errToObj(e)})}datetime(e){var t,n;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(n=e==null?void 0:e.local)!==null&&n!==void 0?n:!1,...D.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...D.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...D.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...D.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...D.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...D.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...D.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...D.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...D.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...D.errToObj(t)})}nonempty(e){return this.min(1,D.errToObj(e))}trim(){return new bt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new bt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new bt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}bt.create=s=>{var e;return new bt({checks:[],typeName:C.ZodString,coerce:(e=s==null?void 0:s.coerce)!==null&&e!==void 0?e:!1,...ee(s)})};function Uh(s,e){const t=(s.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,i=t>n?t:n,a=parseInt(s.toFixed(i).replace(".","")),r=parseInt(e.toFixed(i).replace(".",""));return a%r/Math.pow(10,i)}class ss extends ne{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==$.number){const i=this._getOrReturnCtx(e);return j(i,{code:k.invalid_type,expected:$.number,received:i.parsedType}),J}let t;const n=new ze;for(const i of this._def.checks)i.kind==="int"?ce.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),j(t,{code:k.invalid_type,expected:"integer",received:"float",message:i.message}),n.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(t=this._getOrReturnCtx(e,t),j(t,{code:k.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),n.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(t=this._getOrReturnCtx(e,t),j(t,{code:k.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),n.dirty()):i.kind==="multipleOf"?Uh(e.data,i.value)!==0&&(t=this._getOrReturnCtx(e,t),j(t,{code:k.not_multiple_of,multipleOf:i.value,message:i.message}),n.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),j(t,{code:k.not_finite,message:i.message}),n.dirty()):ce.assertNever(i);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,D.toString(t))}gt(e,t){return this.setLimit("min",e,!1,D.toString(t))}lte(e,t){return this.setLimit("max",e,!0,D.toString(t))}lt(e,t){return this.setLimit("max",e,!1,D.toString(t))}setLimit(e,t,n,i){return new ss({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:D.toString(i)}]})}_addCheck(e){return new ss({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:D.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:D.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:D.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:D.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:D.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ce.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ss.create=s=>new ss({checks:[],typeName:C.ZodNumber,coerce:(s==null?void 0:s.coerce)||!1,...ee(s)});class ns extends ne{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==$.bigint){const i=this._getOrReturnCtx(e);return j(i,{code:k.invalid_type,expected:$.bigint,received:i.parsedType}),J}let t;const n=new ze;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(t=this._getOrReturnCtx(e,t),j(t,{code:k.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),n.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(t=this._getOrReturnCtx(e,t),j(t,{code:k.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),n.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),j(t,{code:k.not_multiple_of,multipleOf:i.value,message:i.message}),n.dirty()):ce.assertNever(i);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,D.toString(t))}gt(e,t){return this.setLimit("min",e,!1,D.toString(t))}lte(e,t){return this.setLimit("max",e,!0,D.toString(t))}lt(e,t){return this.setLimit("max",e,!1,D.toString(t))}setLimit(e,t,n,i){return new ns({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:D.toString(i)}]})}_addCheck(e){return new ns({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:D.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}ns.create=s=>{var e;return new ns({checks:[],typeName:C.ZodBigInt,coerce:(e=s==null?void 0:s.coerce)!==null&&e!==void 0?e:!1,...ee(s)})};class dn extends ne{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==$.boolean){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.boolean,received:t.parsedType}),J}return Je(e.data)}}dn.create=s=>new dn({typeName:C.ZodBoolean,coerce:(s==null?void 0:s.coerce)||!1,...ee(s)});class bs extends ne{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==$.date){const i=this._getOrReturnCtx(e);return j(i,{code:k.invalid_type,expected:$.date,received:i.parsedType}),J}if(isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return j(i,{code:k.invalid_date}),J}const t=new ze;let n;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),t.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:k.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),t.dirty()):ce.assertNever(i);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new bs({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:D.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:D.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}bs.create=s=>new bs({checks:[],coerce:(s==null?void 0:s.coerce)||!1,typeName:C.ZodDate,...ee(s)});class ui extends ne{_parse(e){if(this._getType(e)!==$.symbol){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.symbol,received:t.parsedType}),J}return Je(e.data)}}ui.create=s=>new ui({typeName:C.ZodSymbol,...ee(s)});class pn extends ne{_parse(e){if(this._getType(e)!==$.undefined){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.undefined,received:t.parsedType}),J}return Je(e.data)}}pn.create=s=>new pn({typeName:C.ZodUndefined,...ee(s)});class hn extends ne{_parse(e){if(this._getType(e)!==$.null){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.null,received:t.parsedType}),J}return Je(e.data)}}hn.create=s=>new hn({typeName:C.ZodNull,...ee(s)});class Is extends ne{constructor(){super(...arguments),this._any=!0}_parse(e){return Je(e.data)}}Is.create=s=>new Is({typeName:C.ZodAny,...ee(s)});class _s extends ne{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Je(e.data)}}_s.create=s=>new _s({typeName:C.ZodUnknown,...ee(s)});class Ht extends ne{_parse(e){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.never,received:t.parsedType}),J}}Ht.create=s=>new Ht({typeName:C.ZodNever,...ee(s)});class di extends ne{_parse(e){if(this._getType(e)!==$.undefined){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.void,received:t.parsedType}),J}return Je(e.data)}}di.create=s=>new di({typeName:C.ZodVoid,...ee(s)});class _t extends ne{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),i=this._def;if(t.parsedType!==$.array)return j(t,{code:k.invalid_type,expected:$.array,received:t.parsedType}),J;if(i.exactLength!==null){const r=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(r||o)&&(j(t,{code:r?k.too_big:k.too_small,minimum:o?i.exactLength.value:void 0,maximum:r?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),n.dirty())}if(i.minLength!==null&&t.data.length<i.minLength.value&&(j(t,{code:k.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),n.dirty()),i.maxLength!==null&&t.data.length>i.maxLength.value&&(j(t,{code:k.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((r,o)=>i.type._parseAsync(new Rt(t,r,t.path,o)))).then(r=>ze.mergeArray(n,r));const a=[...t.data].map((r,o)=>i.type._parseSync(new Rt(t,r,t.path,o)));return ze.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new _t({...this._def,minLength:{value:e,message:D.toString(t)}})}max(e,t){return new _t({...this._def,maxLength:{value:e,message:D.toString(t)}})}length(e,t){return new _t({...this._def,exactLength:{value:e,message:D.toString(t)}})}nonempty(e){return this.min(1,e)}}_t.create=(s,e)=>new _t({type:s,minLength:null,maxLength:null,exactLength:null,typeName:C.ZodArray,...ee(e)});function $s(s){if(s instanceof xe){const e={};for(const t in s.shape){const n=s.shape[t];e[t]=$t.create($s(n))}return new xe({...s._def,shape:()=>e})}else return s instanceof _t?new _t({...s._def,type:$s(s.element)}):s instanceof $t?$t.create($s(s.unwrap())):s instanceof rs?rs.create($s(s.unwrap())):s instanceof It?It.create(s.items.map(e=>$s(e))):s}class xe extends ne{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=ce.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==$.object){const c=this._getOrReturnCtx(e);return j(c,{code:k.invalid_type,expected:$.object,received:c.parsedType}),J}const{status:t,ctx:n}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),r=[];if(!(this._def.catchall instanceof Ht&&this._def.unknownKeys==="strip"))for(const c in n.data)a.includes(c)||r.push(c);const o=[];for(const c of a){const l=i[c],u=n.data[c];o.push({key:{status:"valid",value:c},value:l._parse(new Rt(n,u,n.path,c)),alwaysSet:c in n.data})}if(this._def.catchall instanceof Ht){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of r)o.push({key:{status:"valid",value:l},value:{status:"valid",value:n.data[l]}});else if(c==="strict")r.length>0&&(j(n,{code:k.unrecognized_keys,keys:r}),t.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of r){const u=n.data[l];o.push({key:{status:"valid",value:l},value:c._parse(new Rt(n,u,n.path,l)),alwaysSet:l in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of o){const u=await l.key,d=await l.value;c.push({key:u,value:d,alwaysSet:l.alwaysSet})}return c}).then(c=>ze.mergeObjectSync(t,c)):ze.mergeObjectSync(t,o)}get shape(){return this._def.shape()}strict(e){return D.errToObj,new xe({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{var i,a,r,o;const c=(r=(a=(i=this._def).errorMap)===null||a===void 0?void 0:a.call(i,t,n).message)!==null&&r!==void 0?r:n.defaultError;return t.code==="unrecognized_keys"?{message:(o=D.errToObj(e).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new xe({...this._def,unknownKeys:"strip"})}passthrough(){return new xe({...this._def,unknownKeys:"passthrough"})}extend(e){return new xe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new xe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:C.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new xe({...this._def,catchall:e})}pick(e){const t={};return ce.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])}),new xe({...this._def,shape:()=>t})}omit(e){const t={};return ce.objectKeys(this.shape).forEach(n=>{e[n]||(t[n]=this.shape[n])}),new xe({...this._def,shape:()=>t})}deepPartial(){return $s(this)}partial(e){const t={};return ce.objectKeys(this.shape).forEach(n=>{const i=this.shape[n];e&&!e[n]?t[n]=i:t[n]=i.optional()}),new xe({...this._def,shape:()=>t})}required(e){const t={};return ce.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])t[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof $t;)i=i._def.innerType;t[n]=i}}),new xe({...this._def,shape:()=>t})}keyof(){return qo(ce.objectKeys(this.shape))}}xe.create=(s,e)=>new xe({shape:()=>s,unknownKeys:"strip",catchall:Ht.create(),typeName:C.ZodObject,...ee(e)}),xe.strictCreate=(s,e)=>new xe({shape:()=>s,unknownKeys:"strict",catchall:Ht.create(),typeName:C.ZodObject,...ee(e)}),xe.lazycreate=(s,e)=>new xe({shape:s,unknownKeys:"strip",catchall:Ht.create(),typeName:C.ZodObject,...ee(e)});class mn extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;function i(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const r=a.map(o=>new gt(o.ctx.common.issues));return j(t,{code:k.invalid_union,unionErrors:r}),J}if(t.common.async)return Promise.all(n.map(async a=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(i);{let a;const r=[];for(const c of n){const l={...t,common:{...t.common,issues:[]},parent:null},u=c._parseSync({data:t.data,path:t.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!a&&(a={result:u,ctx:l}),l.common.issues.length&&r.push(l.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=r.map(c=>new gt(c));return j(t,{code:k.invalid_union,unionErrors:o}),J}}get options(){return this._def.options}}mn.create=(s,e)=>new mn({options:s,typeName:C.ZodUnion,...ee(e)});const is=s=>s instanceof gn?is(s.schema):s instanceof vt?is(s.innerType()):s instanceof bn?[s.value]:s instanceof as?s.options:s instanceof _n?ce.objectValues(s.enum):s instanceof vn?is(s._def.innerType):s instanceof pn?[void 0]:s instanceof hn?[null]:s instanceof $t?[void 0,...is(s.unwrap())]:s instanceof rs?[null,...is(s.unwrap())]:s instanceof La||s instanceof On?is(s.unwrap()):s instanceof wn?is(s._def.innerType):[];class pi extends ne{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==$.object)return j(t,{code:k.invalid_type,expected:$.object,received:t.parsedType}),J;const n=this.discriminator,i=t.data[n],a=this.optionsMap.get(i);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(j(t,{code:k.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),J)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const i=new Map;for(const a of t){const r=is(a.shape[e]);if(!r.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of r){if(i.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);i.set(o,a)}}return new pi({typeName:C.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:i,...ee(n)})}}function $a(s,e){const t=ts(s),n=ts(e);if(s===e)return{valid:!0,data:s};if(t===$.object&&n===$.object){const i=ce.objectKeys(e),a=ce.objectKeys(s).filter(o=>i.indexOf(o)!==-1),r={...s,...e};for(const o of a){const c=$a(s[o],e[o]);if(!c.valid)return{valid:!1};r[o]=c.data}return{valid:!0,data:r}}else if(t===$.array&&n===$.array){if(s.length!==e.length)return{valid:!1};const i=[];for(let a=0;a<s.length;a++){const r=s[a],o=e[a],c=$a(r,o);if(!c.valid)return{valid:!1};i.push(c.data)}return{valid:!0,data:i}}else return t===$.date&&n===$.date&&+s==+e?{valid:!0,data:s}:{valid:!1}}class fn extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),i=(a,r)=>{if(ja(a)||ja(r))return J;const o=$a(a.value,r.value);return o.valid?((Ra(a)||Ra(r))&&t.dirty(),{status:t.value,value:o.data}):(j(n,{code:k.invalid_intersection_types}),J)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,r])=>i(a,r)):i(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}fn.create=(s,e,t)=>new fn({left:s,right:e,typeName:C.ZodIntersection,...ee(t)});class It extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==$.array)return j(n,{code:k.invalid_type,expected:$.array,received:n.parsedType}),J;if(n.data.length<this._def.items.length)return j(n,{code:k.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),J;!this._def.rest&&n.data.length>this._def.items.length&&(j(n,{code:k.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const i=[...n.data].map((a,r)=>{const o=this._def.items[r]||this._def.rest;return o?o._parse(new Rt(n,a,n.path,r)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>ze.mergeArray(t,a)):ze.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new It({...this._def,rest:e})}}It.create=(s,e)=>{if(!Array.isArray(s))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new It({items:s,typeName:C.ZodTuple,rest:null,...ee(e)})};class yn extends ne{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==$.object)return j(n,{code:k.invalid_type,expected:$.object,received:n.parsedType}),J;const i=[],a=this._def.keyType,r=this._def.valueType;for(const o in n.data)i.push({key:a._parse(new Rt(n,o,n.path,o)),value:r._parse(new Rt(n,n.data[o],n.path,o)),alwaysSet:o in n.data});return n.common.async?ze.mergeObjectAsync(t,i):ze.mergeObjectSync(t,i)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof ne?new yn({keyType:e,valueType:t,typeName:C.ZodRecord,...ee(n)}):new yn({keyType:bt.create(),valueType:e,typeName:C.ZodRecord,...ee(t)})}}class hi extends ne{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==$.map)return j(n,{code:k.invalid_type,expected:$.map,received:n.parsedType}),J;const i=this._def.keyType,a=this._def.valueType,r=[...n.data.entries()].map(([o,c],l)=>({key:i._parse(new Rt(n,o,n.path,[l,"key"])),value:a._parse(new Rt(n,c,n.path,[l,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of r){const l=await c.key,u=await c.value;if(l.status==="aborted"||u.status==="aborted")return J;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(l.value,u.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const c of r){const l=c.key,u=c.value;if(l.status==="aborted"||u.status==="aborted")return J;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(l.value,u.value)}return{status:t.value,value:o}}}}hi.create=(s,e,t)=>new hi({valueType:e,keyType:s,typeName:C.ZodMap,...ee(t)});class vs extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==$.set)return j(n,{code:k.invalid_type,expected:$.set,received:n.parsedType}),J;const i=this._def;i.minSize!==null&&n.data.size<i.minSize.value&&(j(n,{code:k.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),i.maxSize!==null&&n.data.size>i.maxSize.value&&(j(n,{code:k.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());const a=this._def.valueType;function r(c){const l=new Set;for(const u of c){if(u.status==="aborted")return J;u.status==="dirty"&&t.dirty(),l.add(u.value)}return{status:t.value,value:l}}const o=[...n.data.values()].map((c,l)=>a._parse(new Rt(n,c,n.path,l)));return n.common.async?Promise.all(o).then(c=>r(c)):r(o)}min(e,t){return new vs({...this._def,minSize:{value:e,message:D.toString(t)}})}max(e,t){return new vs({...this._def,maxSize:{value:e,message:D.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}vs.create=(s,e)=>new vs({valueType:s,minSize:null,maxSize:null,typeName:C.ZodSet,...ee(e)});class Ls extends ne{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==$.function)return j(t,{code:k.invalid_type,expected:$.function,received:t.parsedType}),J;function n(o,c){return oi({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,ri(),Rs].filter(l=>!!l),issueData:{code:k.invalid_arguments,argumentsError:c}})}function i(o,c){return oi({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,ri(),Rs].filter(l=>!!l),issueData:{code:k.invalid_return_type,returnTypeError:c}})}const a={errorMap:t.common.contextualErrorMap},r=t.data;if(this._def.returns instanceof Bs){const o=this;return Je(async function(...c){const l=new gt([]),u=await o._def.args.parseAsync(c,a).catch(p=>{throw l.addIssue(n(c,p)),l}),d=await Reflect.apply(r,this,u);return await o._def.returns._def.type.parseAsync(d,a).catch(p=>{throw l.addIssue(i(d,p)),l})})}else{const o=this;return Je(function(...c){const l=o._def.args.safeParse(c,a);if(!l.success)throw new gt([n(c,l.error)]);const u=Reflect.apply(r,this,l.data),d=o._def.returns.safeParse(u,a);if(!d.success)throw new gt([i(u,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Ls({...this._def,args:It.create(e).rest(_s.create())})}returns(e){return new Ls({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new Ls({args:e||It.create([]).rest(_s.create()),returns:t||_s.create(),typeName:C.ZodFunction,...ee(n)})}}class gn extends ne{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}gn.create=(s,e)=>new gn({getter:s,typeName:C.ZodLazy,...ee(e)});class bn extends ne{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return j(t,{received:t.data,code:k.invalid_literal,expected:this._def.value}),J}return{status:"valid",value:e.data}}get value(){return this._def.value}}bn.create=(s,e)=>new bn({value:s,typeName:C.ZodLiteral,...ee(e)});function qo(s,e){return new as({values:s,typeName:C.ZodEnum,...ee(e)})}class as extends ne{constructor(){super(...arguments),ln.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return j(t,{expected:ce.joinValues(n),received:t.parsedType,code:k.invalid_type}),J}if(li(this,ln)||Ro(this,ln,new Set(this._def.values)),!li(this,ln).has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return j(t,{received:t.data,code:k.invalid_enum_value,options:n}),J}return Je(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return as.create(e,{...this._def,...t})}exclude(e,t=this._def){return as.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}}ln=new WeakMap,as.create=qo;class _n extends ne{constructor(){super(...arguments),un.set(this,void 0)}_parse(e){const t=ce.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==$.string&&n.parsedType!==$.number){const i=ce.objectValues(t);return j(n,{expected:ce.joinValues(i),received:n.parsedType,code:k.invalid_type}),J}if(li(this,un)||Ro(this,un,new Set(ce.getValidEnumValues(this._def.values))),!li(this,un).has(e.data)){const i=ce.objectValues(t);return j(n,{received:n.data,code:k.invalid_enum_value,options:i}),J}return Je(e.data)}get enum(){return this._def.values}}un=new WeakMap,_n.create=(s,e)=>new _n({values:s,typeName:C.ZodNativeEnum,...ee(e)});class Bs extends ne{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==$.promise&&t.common.async===!1)return j(t,{code:k.invalid_type,expected:$.promise,received:t.parsedType}),J;const n=t.parsedType===$.promise?t.data:Promise.resolve(t.data);return Je(n.then(i=>this._def.type.parseAsync(i,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Bs.create=(s,e)=>new Bs({type:s,typeName:C.ZodPromise,...ee(e)});class vt extends ne{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===C.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),i=this._def.effect||null,a={addIssue:r=>{j(n,r),r.fatal?t.abort():t.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),i.type==="preprocess"){const r=i.transform(n.data,a);if(n.common.async)return Promise.resolve(r).then(async o=>{if(t.value==="aborted")return J;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?J:c.status==="dirty"||t.value==="dirty"?ci(c.value):c});{if(t.value==="aborted")return J;const o=this._def.schema._parseSync({data:r,path:n.path,parent:n});return o.status==="aborted"?J:o.status==="dirty"||t.value==="dirty"?ci(o.value):o}}if(i.type==="refinement"){const r=o=>{const c=i.refinement(o,a);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?J:(o.status==="dirty"&&t.dirty(),r(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?J:(o.status==="dirty"&&t.dirty(),r(o.value).then(()=>({status:t.value,value:o.value}))))}if(i.type==="transform")if(n.common.async===!1){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!on(r))return r;const o=i.transform(r.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(r=>on(r)?Promise.resolve(i.transform(r.value,a)).then(o=>({status:t.value,value:o})):r);ce.assertNever(i)}}vt.create=(s,e,t)=>new vt({schema:s,typeName:C.ZodEffects,effect:e,...ee(t)}),vt.createWithPreprocess=(s,e,t)=>new vt({schema:e,effect:{type:"preprocess",transform:s},typeName:C.ZodEffects,...ee(t)});class $t extends ne{_parse(e){return this._getType(e)===$.undefined?Je(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}$t.create=(s,e)=>new $t({innerType:s,typeName:C.ZodOptional,...ee(e)});class rs extends ne{_parse(e){return this._getType(e)===$.null?Je(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}rs.create=(s,e)=>new rs({innerType:s,typeName:C.ZodNullable,...ee(e)});class vn extends ne{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===$.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}vn.create=(s,e)=>new vn({innerType:s,typeName:C.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...ee(e)});class wn extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return cn(i)?i.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new gt(n.common.issues)},input:n.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new gt(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}wn.create=(s,e)=>new wn({innerType:s,typeName:C.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...ee(e)});class mi extends ne{_parse(e){if(this._getType(e)!==$.nan){const t=this._getOrReturnCtx(e);return j(t,{code:k.invalid_type,expected:$.nan,received:t.parsedType}),J}return{status:"valid",value:e.data}}}mi.create=s=>new mi({typeName:C.ZodNaN,...ee(s)});const Fh=Symbol("zod_brand");class La extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class xn extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?J:i.status==="dirty"?(t.dirty(),ci(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const i=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?J:i.status==="dirty"?(t.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:n.path,parent:n})}}static create(e,t){return new xn({in:e,out:t,typeName:C.ZodPipeline})}}class On extends ne{_parse(e){const t=this._def.innerType._parse(e),n=i=>(on(i)&&(i.value=Object.freeze(i.value)),i);return cn(t)?t.then(i=>n(i)):n(t)}unwrap(){return this._def.innerType}}On.create=(s,e)=>new On({innerType:s,typeName:C.ZodReadonly,...ee(e)});function Do(s,e={},t){return s?Is.create().superRefine((n,i)=>{var a,r;if(!s(n)){const o=typeof e=="function"?e(n):typeof e=="string"?{message:e}:e,c=(r=(a=o.fatal)!==null&&a!==void 0?a:t)!==null&&r!==void 0?r:!0,l=typeof o=="string"?{message:o}:o;i.addIssue({code:"custom",...l,fatal:c})}}):Is.create()}const Zh={object:xe.lazycreate};var C;(function(s){s.ZodString="ZodString",s.ZodNumber="ZodNumber",s.ZodNaN="ZodNaN",s.ZodBigInt="ZodBigInt",s.ZodBoolean="ZodBoolean",s.ZodDate="ZodDate",s.ZodSymbol="ZodSymbol",s.ZodUndefined="ZodUndefined",s.ZodNull="ZodNull",s.ZodAny="ZodAny",s.ZodUnknown="ZodUnknown",s.ZodNever="ZodNever",s.ZodVoid="ZodVoid",s.ZodArray="ZodArray",s.ZodObject="ZodObject",s.ZodUnion="ZodUnion",s.ZodDiscriminatedUnion="ZodDiscriminatedUnion",s.ZodIntersection="ZodIntersection",s.ZodTuple="ZodTuple",s.ZodRecord="ZodRecord",s.ZodMap="ZodMap",s.ZodSet="ZodSet",s.ZodFunction="ZodFunction",s.ZodLazy="ZodLazy",s.ZodLiteral="ZodLiteral",s.ZodEnum="ZodEnum",s.ZodEffects="ZodEffects",s.ZodNativeEnum="ZodNativeEnum",s.ZodOptional="ZodOptional",s.ZodNullable="ZodNullable",s.ZodDefault="ZodDefault",s.ZodCatch="ZodCatch",s.ZodPromise="ZodPromise",s.ZodBranded="ZodBranded",s.ZodPipeline="ZodPipeline",s.ZodReadonly="ZodReadonly"})(C||(C={}));const Wh=(s,e={message:`Input not instance of ${s.name}`})=>Do(t=>t instanceof s,e),Uo=bt.create,Fo=ss.create,zh=mi.create,Vh=ns.create,Zo=dn.create,Kh=bs.create,Qh=ui.create,Hh=pn.create,Jh=hn.create,Gh=Is.create,Xh=_s.create,Yh=Ht.create,em=di.create,tm=_t.create,sm=xe.create,nm=xe.strictCreate,im=mn.create,am=pi.create,rm=fn.create,om=It.create,cm=yn.create,lm=hi.create,um=vs.create,dm=Ls.create,pm=gn.create,hm=bn.create,mm=as.create,fm=_n.create,ym=Bs.create,Wo=vt.create,gm=$t.create,bm=rs.create,_m=vt.createWithPreprocess,vm=xn.create;jt=Object.freeze({__proto__:null,defaultErrorMap:Rs,setErrorMap:Mh,getErrorMap:ri,makeIssue:oi,EMPTY_PATH:kh,addIssueToContext:j,ParseStatus:ze,INVALID:J,DIRTY:ci,OK:Je,isAborted:ja,isDirty:Ra,isValid:on,isAsync:cn,get util(){return ce},get objectUtil(){return Na},ZodParsedType:$,getParsedType:ts,ZodType:ne,datetimeRegex:Bo,ZodString:bt,ZodNumber:ss,ZodBigInt:ns,ZodBoolean:dn,ZodDate:bs,ZodSymbol:ui,ZodUndefined:pn,ZodNull:hn,ZodAny:Is,ZodUnknown:_s,ZodNever:Ht,ZodVoid:di,ZodArray:_t,ZodObject:xe,ZodUnion:mn,ZodDiscriminatedUnion:pi,ZodIntersection:fn,ZodTuple:It,ZodRecord:yn,ZodMap:hi,ZodSet:vs,ZodFunction:Ls,ZodLazy:gn,ZodLiteral:bn,ZodEnum:as,ZodNativeEnum:_n,ZodPromise:Bs,ZodEffects:vt,ZodTransformer:vt,ZodOptional:$t,ZodNullable:rs,ZodDefault:vn,ZodCatch:wn,ZodNaN:mi,BRAND:Fh,ZodBranded:La,ZodPipeline:xn,ZodReadonly:On,custom:Do,Schema:ne,ZodSchema:ne,late:Zh,get ZodFirstPartyTypeKind(){return C},coerce:{string:s=>bt.create({...s,coerce:!0}),number:s=>ss.create({...s,coerce:!0}),boolean:s=>dn.create({...s,coerce:!0}),bigint:s=>ns.create({...s,coerce:!0}),date:s=>bs.create({...s,coerce:!0})},any:Gh,array:tm,bigint:Vh,boolean:Zo,date:Kh,discriminatedUnion:am,effect:Wo,enum:mm,function:dm,instanceof:Wh,intersection:rm,lazy:pm,literal:hm,map:lm,nan:zh,nativeEnum:fm,never:Yh,null:Jh,nullable:bm,number:Fo,object:sm,oboolean:()=>Zo().optional(),onumber:()=>Fo().optional(),optional:gm,ostring:()=>Uo().optional(),pipeline:vm,preprocess:_m,promise:ym,record:cm,set:um,strictObject:nm,string:Uo,symbol:Qh,transformer:Wo,tuple:om,undefined:Hh,union:im,unknown:Xh,void:em,NEVER:J,ZodIssueCode:k,quotelessJson:Eh,ZodError:gt});function wm(){return{}}function xm(s,e){var n,i,a;const t={type:"array"};return(n=s.type)!=null&&n._def&&((a=(i=s.type)==null?void 0:i._def)==null?void 0:a.typeName)!==C.ZodAny&&(t.items=ue(s.type._def,{...e,currentPath:[...e.currentPath,"items"]})),s.minLength&&pe(t,"minItems",s.minLength.value,s.minLength.message,e),s.maxLength&&pe(t,"maxItems",s.maxLength.value,s.maxLength.message,e),s.exactLength&&(pe(t,"minItems",s.exactLength.value,s.exactLength.message,e),pe(t,"maxItems",s.exactLength.value,s.exactLength.message,e)),t}function Om(s,e){const t={type:"integer",format:"int64"};if(!s.checks)return t;for(const n of s.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?pe(t,"minimum",n.value,n.message,e):pe(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),pe(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?pe(t,"maximum",n.value,n.message,e):pe(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),pe(t,"maximum",n.value,n.message,e));break;case"multipleOf":pe(t,"multipleOf",n.value,n.message,e);break}return t}function Em(){return{type:"boolean"}}function zo(s,e){return ue(s.type._def,e)}const Mm=(s,e)=>ue(s.innerType._def,e);function Vo(s,e,t){const n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((i,a)=>Vo(s,e,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return km(s,e)}}const km=(s,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const n of s.checks)switch(n.kind){case"min":pe(t,"minimum",n.value,n.message,e);break;case"max":pe(t,"maximum",n.value,n.message,e);break}return t};function Cm(s,e){return{...ue(s.innerType._def,e),default:s.defaultValue()}}function Am(s,e){return e.effectStrategy==="input"?ue(s.schema._def,e):{}}function Pm(s){return{type:"string",enum:s.values}}const Sm=s=>"type"in s&&s.type==="string"?!1:"allOf"in s;function Tm(s,e){const t=[ue(s.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),ue(s.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const i=[];return t.forEach(a=>{if(Sm(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let r=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;r=c}else n=void 0;i.push(r)}}),i.length?{allOf:i,...n}:void 0}function Nm(s,e){const t=typeof s.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(s.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[s.value]}:{type:t==="bigint"?"integer":t,const:s.value}}let Ba;const ws={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ba===void 0&&(Ba=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ba),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Ko(s,e){const t={type:"string"};function n(i){return e.patternStrategy==="escape"?jm(i):i}if(s.checks)for(const i of s.checks)switch(i.kind){case"min":pe(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e);break;case"max":pe(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"email":switch(e.emailStrategy){case"format:email":wt(t,"email",i.message,e);break;case"format:idn-email":wt(t,"idn-email",i.message,e);break;case"pattern:zod":xt(t,ws.email,i.message,e);break}break;case"url":wt(t,"uri",i.message,e);break;case"uuid":wt(t,"uuid",i.message,e);break;case"regex":xt(t,i.regex,i.message,e);break;case"cuid":xt(t,ws.cuid,i.message,e);break;case"cuid2":xt(t,ws.cuid2,i.message,e);break;case"startsWith":xt(t,RegExp(`^${n(i.value)}`),i.message,e);break;case"endsWith":xt(t,RegExp(`${n(i.value)}$`),i.message,e);break;case"datetime":wt(t,"date-time",i.message,e);break;case"date":wt(t,"date",i.message,e);break;case"time":wt(t,"time",i.message,e);break;case"duration":wt(t,"duration",i.message,e);break;case"length":pe(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e),pe(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"includes":{xt(t,RegExp(n(i.value)),i.message,e);break}case"ip":{i.version!=="v6"&&wt(t,"ipv4",i.message,e),i.version!=="v4"&&wt(t,"ipv6",i.message,e);break}case"emoji":xt(t,ws.emoji,i.message,e);break;case"ulid":{xt(t,ws.ulid,i.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{wt(t,"binary",i.message,e);break}case"contentEncoding:base64":{pe(t,"contentEncoding","base64",i.message,e);break}case"pattern:zod":{xt(t,ws.base64,i.message,e);break}}break}case"nanoid":xt(t,ws.nanoid,i.message,e)}return t}const jm=s=>Array.from(s).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),wt=(s,e,t,n)=>{var i;s.format||(i=s.anyOf)!=null&&i.some(a=>a.format)?(s.anyOf||(s.anyOf=[]),s.format&&(s.anyOf.push({format:s.format,...s.errorMessage&&n.errorMessages&&{errorMessage:{format:s.errorMessage.format}}}),delete s.format,s.errorMessage&&(delete s.errorMessage.format,Object.keys(s.errorMessage).length===0&&delete s.errorMessage)),s.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):pe(s,"format",e,t,n)},xt=(s,e,t,n)=>{var i;s.pattern||(i=s.allOf)!=null&&i.some(a=>a.pattern)?(s.allOf||(s.allOf=[]),s.pattern&&(s.allOf.push({pattern:s.pattern,...s.errorMessage&&n.errorMessages&&{errorMessage:{pattern:s.errorMessage.pattern}}}),delete s.pattern,s.errorMessage&&(delete s.errorMessage.pattern,Object.keys(s.errorMessage).length===0&&delete s.errorMessage)),s.allOf.push({pattern:Qo(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):pe(s,"pattern",Qo(e,n),t,n)},Qo=(s,e)=>{var l;const t=typeof s=="function"?s():s;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},i=n.i?t.source.toLowerCase():t.source;let a="",r=!1,o=!1,c=!1;for(let u=0;u<i.length;u++){if(r){a+=i[u],r=!1;continue}if(n.i){if(o){if(i[u].match(/[a-z]/)){c?(a+=i[u],a+=`${i[u-2]}-${i[u]}`.toUpperCase(),c=!1):i[u+1]==="-"&&((l=i[u+2])!=null&&l.match(/[a-z]/))?(a+=i[u],c=!0):a+=`${i[u]}${i[u].toUpperCase()}`;continue}}else if(i[u].match(/[a-z]/)){a+=`[${i[u]}${i[u].toUpperCase()}]`;continue}}if(n.m){if(i[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(i[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(n.s&&i[u]==="."){a+=o?`${i[u]}\r
`:`[${i[u]}\r
]`;continue}a+=i[u],i[u]==="\\"?r=!0:o&&i[u]==="]"?o=!1:!o&&i[u]==="["&&(o=!0)}try{const u=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return a};function Ho(s,e){var n,i,a,r,o,c;if(e.target==="openApi3"&&((n=s.keyType)==null?void 0:n._def.typeName)===C.ZodEnum)return{type:"object",required:s.keyType._def.values,properties:s.keyType._def.values.reduce((l,u)=>({...l,[u]:ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((i=s.keyType)==null?void 0:i._def.typeName)===C.ZodString&&((a=s.keyType._def.checks)!=null&&a.length)){const{type:l,...u}=Ko(s.keyType._def,e);return{...t,propertyNames:u}}else{if(((r=s.keyType)==null?void 0:r._def.typeName)===C.ZodEnum)return{...t,propertyNames:{enum:s.keyType._def.values}};if(((o=s.keyType)==null?void 0:o._def.typeName)===C.ZodBranded&&s.keyType._def.type._def.typeName===C.ZodString&&((c=s.keyType._def.type._def.checks)!=null&&c.length)){const{type:l,...u}=zo(s.keyType._def,e);return{...t,propertyNames:u}}}return t}function Rm(s,e){if(e.mapStrategy==="record")return Ho(s,e);const t=ue(s.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function Im(s){const e=s.values,t=Object.keys(s.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),n=Array.from(new Set(t.map(i=>typeof i)));return{type:n.length===1?n[0]==="string"?"string":"number":["string","number"],enum:t}}function $m(){return{not:{}}}function Lm(s){return s.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const fi={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Bm(s,e){if(e.target==="openApi3")return Jo(s,e);const t=s.options instanceof Map?Array.from(s.options.values()):s.options;if(t.every(n=>n._def.typeName in fi&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((i,a)=>{const r=fi[a._def.typeName];return r&&!i.includes(r)?[...i,r]:i},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((i,a)=>{const r=typeof a._def.value;switch(r){case"string":case"number":case"boolean":return[...i,r];case"bigint":return[...i,"integer"];case"object":if(a._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(n.length===t.length){const i=n.filter((a,r,o)=>o.indexOf(a)===r);return{type:i.length>1?i:i[0],enum:t.reduce((a,r)=>a.includes(r._def.value)?a:[...a,r._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return Jo(s,e)}const Jo=(s,e)=>{const t=(s.options instanceof Map?Array.from(s.options.values()):s.options).map((n,i)=>ue(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function qm(s,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(s.innerType._def.typeName)&&(!s.innerType._def.checks||!s.innerType._def.checks.length))return e.target==="openApi3"?{type:fi[s.innerType._def.typeName],nullable:!0}:{type:[fi[s.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=ue(s.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=ue(s.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Dm(s,e){const t={type:"number"};if(!s.checks)return t;for(const n of s.checks)switch(n.kind){case"int":t.type="integer",No(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?pe(t,"minimum",n.value,n.message,e):pe(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),pe(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?pe(t,"maximum",n.value,n.message,e):pe(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),pe(t,"maximum",n.value,n.message,e));break;case"multipleOf":pe(t,"multipleOf",n.value,n.message,e);break}return t}function Um(s,e){return e.removeAdditionalStrategy==="strict"?s.catchall._def.typeName==="ZodNever"?s.unknownKeys!=="strict":ue(s.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:s.catchall._def.typeName==="ZodNever"?s.unknownKeys==="passthrough":ue(s.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Fm(s,e){const t={type:"object",...Object.entries(s.shape()).reduce((n,[i,a])=>{if(a===void 0||a._def===void 0)return n;const r=ue(a._def,{...e,currentPath:[...e.currentPath,"properties",i],propertyPath:[...e.currentPath,"properties",i]});return r===void 0?n:{properties:{...n.properties,[i]:r},required:a.isOptional()?n.required:[...n.required,i]}},{properties:{},required:[]}),additionalProperties:Um(s,e)};return t.required.length||delete t.required,t}const Zm=(s,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return ue(s.innerType._def,e);const t=ue(s.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Wm=(s,e)=>{if(e.pipeStrategy==="input")return ue(s.in._def,e);if(e.pipeStrategy==="output")return ue(s.out._def,e);const t=ue(s.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=ue(s.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(i=>i!==void 0)}};function zm(s,e){return ue(s.type._def,e)}function Vm(s,e){const t={type:"array",uniqueItems:!0,items:ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return s.minSize&&pe(t,"minItems",s.minSize.value,s.minSize.message,e),s.maxSize&&pe(t,"maxItems",s.maxSize.value,s.maxSize.message,e),t}function Km(s,e){return s.rest?{type:"array",minItems:s.items.length,items:s.items.map((t,n)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:ue(s.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:s.items.length,maxItems:s.items.length,items:s.items.map((t,n)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function Qm(){return{not:{}}}function Hm(){return{}}const Jm=(s,e)=>ue(s.innerType._def,e);function ue(s,e,t=!1){var r;const n=e.seen.get(s);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,s,e,n,t);if(o!==wh)return o}if(n&&!t){const o=Go(n,e);if(o!==void 0)return o}const i={def:s,path:e.currentPath,jsonSchema:void 0};e.seen.set(s,i);const a=Yo(s,s.typeName,e);return a&&ec(s,e,a),i.jsonSchema=a,a}let Go,Xo,Yo,ec;Go=(s,e)=>{switch(e.$refStrategy){case"root":return{$ref:s.path.join("/")};case"relative":return{$ref:Xo(e.currentPath,s.path)};case"none":case"seen":return s.path.length<e.currentPath.length&&s.path.every((t,n)=>e.currentPath[n]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Xo=(s,e)=>{let t=0;for(;t<s.length&&t<e.length&&s[t]===e[t];t++);return[(s.length-t).toString(),...e.slice(t)].join("/")},Yo=(s,e,t)=>{switch(e){case C.ZodString:return Ko(s,t);case C.ZodNumber:return Dm(s,t);case C.ZodObject:return Fm(s,t);case C.ZodBigInt:return Om(s,t);case C.ZodBoolean:return Em();case C.ZodDate:return Vo(s,t);case C.ZodUndefined:return Qm();case C.ZodNull:return Lm(t);case C.ZodArray:return xm(s,t);case C.ZodUnion:case C.ZodDiscriminatedUnion:return Bm(s,t);case C.ZodIntersection:return Tm(s,t);case C.ZodTuple:return Km(s,t);case C.ZodRecord:return Ho(s,t);case C.ZodLiteral:return Nm(s,t);case C.ZodEnum:return Pm(s);case C.ZodNativeEnum:return Im(s);case C.ZodNullable:return qm(s,t);case C.ZodOptional:return Zm(s,t);case C.ZodMap:return Rm(s,t);case C.ZodSet:return Vm(s,t);case C.ZodLazy:return ue(s.getter()._def,t);case C.ZodPromise:return zm(s,t);case C.ZodNaN:case C.ZodNever:return $m();case C.ZodEffects:return Am(s,t);case C.ZodAny:return wm();case C.ZodUnknown:return Hm();case C.ZodDefault:return Cm(s,t);case C.ZodBranded:return zo(s,t);case C.ZodReadonly:return Jm(s,t);case C.ZodCatch:return Mm(s,t);case C.ZodPipeline:return Wm(s,t);case C.ZodFunction:case C.ZodVoid:case C.ZodSymbol:return;default:return(n=>{})()}},ec=(s,e,t)=>(s.description&&(t.description=s.description,e.markdownDescription&&(t.markdownDescription=s.description)),t),Pa=(s,e)=>{const t=Oh(e),n=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((c,[l,u])=>({...c,[l]:ue(u._def,{...t,currentPath:[...t.basePath,t.definitionPath,l]},!0)??{}}),{}):void 0,i=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,a=ue(s._def,i===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,i]},!1)??{},r=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;r!==void 0&&(a.title=r);const o=i===void 0?n?{...a,[t.definitionPath]:n}:a:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,i].join("/"),[t.definitionPath]:{...n,[i]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};var tc={},sc;function Gm(){if(sc)return tc;sc=1;var s;return function(e){(function(t){var n=typeof globalThis=="object"?globalThis:typeof Lp=="object"?Lp:typeof self=="object"?self:typeof this=="object"?this:c(),i=a(e);typeof n.Reflect<"u"&&(i=a(n.Reflect,i)),t(i,n),typeof n.Reflect>"u"&&(n.Reflect=e);function a(l,u){return function(d,p){Object.defineProperty(l,d,{configurable:!0,writable:!0,value:p}),u&&u(d,p)}}function r(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function c(){return r()||o()}})(function(t,n){var i=Object.prototype.hasOwnProperty,a=typeof Symbol=="function",r=a&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=a&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",c=typeof Object.create=="function",l={__proto__:[]}instanceof Array,u=!c&&!l,d={create:c?function(){return Xn(Object.create(null))}:l?function(){return Xn({__proto__:null})}:function(){return Xn({})},has:u?function(_,x){return i.call(_,x)}:function(_,x){return x in _},get:u?function(_,x){return i.call(_,x)?_[x]:void 0}:function(_,x){return _[x]}},p=Object.getPrototypeOf(Function),h=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:ya(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:ga(),y=typeof WeakMap=="function"?WeakMap:yo(),f=a?Symbol.for("@reflect-metadata:registry"):void 0,g=pt(),b=Wt(g);function v(_,x,O,P){if(F(O)){if(!hs(_))throw new TypeError;if(!V(x))throw new TypeError;return le(_,x)}else{if(!hs(_))throw new TypeError;if(!ve(x))throw new TypeError;if(!ve(P)&&!F(P)&&!nt(P))throw new TypeError;return nt(P)&&(P=void 0),O=it(O),ut(_,x,O,P)}}t("decorate",v);function E(_,x){function O(P,z){if(!ve(P))throw new TypeError;if(!F(z)&&!Y(z))throw new TypeError;st(_,x,P,z)}return O}t("metadata",E);function S(_,x,O,P){if(!ve(O))throw new TypeError;return F(P)||(P=it(P)),st(_,x,O,P)}t("defineMetadata",S);function A(_,x,O){if(!ve(x))throw new TypeError;return F(O)||(O=it(O)),Xe(_,x,O)}t("hasMetadata",A);function Q(_,x,O){if(!ve(x))throw new TypeError;return F(O)||(O=it(O)),tt(_,x,O)}t("hasOwnMetadata",Q);function H(_,x,O){if(!ve(x))throw new TypeError;return F(O)||(O=it(O)),_e(_,x,O)}t("getMetadata",H);function W(_,x,O){if(!ve(x))throw new TypeError;return F(O)||(O=it(O)),St(_,x,O)}t("getOwnMetadata",W);function U(_,x){if(!ve(_))throw new TypeError;return F(x)||(x=it(x)),ps(_,x)}t("getMetadataKeys",U);function me(_,x){if(!ve(_))throw new TypeError;return F(x)||(x=it(x)),dt(_,x)}t("getOwnMetadataKeys",me);function Oe(_,x,O){if(!ve(x))throw new TypeError;if(F(O)||(O=it(O)),!ve(x))throw new TypeError;F(O)||(O=it(O));var P=yt(x,O,!1);return F(P)?!1:P.OrdinaryDeleteMetadata(_,x,O)}t("deleteMetadata",Oe);function le(_,x){for(var O=_.length-1;O>=0;--O){var P=_[O],z=P(x);if(!F(z)&&!nt(z)){if(!V(z))throw new TypeError;x=z}}return x}function ut(_,x,O,P){for(var z=_.length-1;z>=0;--z){var qe=_[z],Re=qe(x,O,P);if(!F(Re)&&!nt(Re)){if(!ve(Re))throw new TypeError;P=Re}}return P}function Xe(_,x,O){var P=tt(_,x,O);if(P)return!0;var z=we(x);return nt(z)?!1:Xe(_,z,O)}function tt(_,x,O){var P=yt(x,O,!1);return F(P)?!1:mt(P.OrdinaryHasOwnMetadata(_,x,O))}function _e(_,x,O){var P=tt(_,x,O);if(P)return St(_,x,O);var z=we(x);if(!nt(z))return _e(_,z,O)}function St(_,x,O){var P=yt(x,O,!1);if(!F(P))return P.OrdinaryGetOwnMetadata(_,x,O)}function st(_,x,O,P){var z=yt(O,P,!0);z.OrdinaryDefineOwnMetadata(_,x,O,P)}function ps(_,x){var O=dt(_,x),P=we(_);if(P===null)return O;var z=ps(P,x);if(z.length<=0)return O;if(O.length<=0)return z;for(var qe=new m,Re=[],re=0,I=O;re<I.length;re++){var L=I[re],B=qe.has(L);B||(qe.add(L),Re.push(L))}for(var q=0,oe=z;q<oe.length;q++){var L=oe[q],B=qe.has(L);B||(qe.add(L),Re.push(L))}return Re}function dt(_,x){var O=yt(_,x,!1);return O?O.OrdinaryOwnMetadataKeys(_,x):[]}function Ft(_){if(_===null)return 1;switch(typeof _){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return _===null?1:6;default:return 6}}function F(_){return _===void 0}function nt(_){return _===null}function Zt(_){return typeof _=="symbol"}function ve(_){return typeof _=="object"?_!==null:typeof _=="function"}function Ts(_,x){switch(Ft(_)){case 0:return _;case 1:return _;case 2:return _;case 3:return _;case 4:return _;case 5:return _}var O="string",P=We(_,r);if(P!==void 0){var z=P.call(_,O);if(ve(z))throw new TypeError;return z}return He(_)}function He(_,x){var O,P;{var z=_.toString;if(ms(z)){var P=z.call(_);if(!ve(P))return P}var O=_.valueOf;if(ms(O)){var P=O.call(_);if(!ve(P))return P}}throw new TypeError}function mt(_){return!!_}function Tt(_){return""+_}function it(_){var x=Ts(_);return Zt(x)?x:Tt(x)}function hs(_){return Array.isArray?Array.isArray(_):_ instanceof Object?_ instanceof Array:Object.prototype.toString.call(_)==="[object Array]"}function ms(_){return typeof _=="function"}function V(_){return typeof _=="function"}function Y(_){switch(Ft(_)){case 3:return!0;case 4:return!0;default:return!1}}function Me(_,x){return _===x||_!==_&&x!==x}function We(_,x){var O=_[x];if(O!=null){if(!ms(O))throw new TypeError;return O}}function Be(_){var x=We(_,o);if(!ms(x))throw new TypeError;var O=x.call(_);if(!ve(O))throw new TypeError;return O}function fe(_){return _.value}function je(_){var x=_.next();return x.done?!1:x}function ke(_){var x=_.return;x&&x.call(_)}function we(_){var x=Object.getPrototypeOf(_);if(typeof _!="function"||_===p||x!==p)return x;var O=_.prototype,P=O&&Object.getPrototypeOf(O);if(P==null||P===Object.prototype)return x;var z=P.constructor;return typeof z!="function"||z===_?x:z}function ft(){var _;!F(f)&&typeof n.Reflect<"u"&&!(f in n.Reflect)&&typeof n.Reflect.defineMetadata=="function"&&(_=zt(n.Reflect));var x,O,P,z=new y,qe={registerProvider:Re,getProvider:I,setProvider:B};return qe;function Re(q){if(!Object.isExtensible(qe))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case _===q:break;case F(x):x=q;break;case x===q:break;case F(O):O=q;break;case O===q:break;default:P===void 0&&(P=new m),P.add(q);break}}function re(q,oe){if(!F(x)){if(x.isProviderFor(q,oe))return x;if(!F(O)){if(O.isProviderFor(q,oe))return x;if(!F(P))for(var be=Be(P);;){var Pe=je(be);if(!Pe)return;var Nt=fe(Pe);if(Nt.isProviderFor(q,oe))return ke(be),Nt}}}if(!F(_)&&_.isProviderFor(q,oe))return _}function I(q,oe){var be=z.get(q),Pe;return F(be)||(Pe=be.get(oe)),F(Pe)&&(Pe=re(q,oe),F(Pe)||(F(be)&&(be=new h,z.set(q,be)),be.set(oe,Pe))),Pe}function L(q){if(F(q))throw new TypeError;return x===q||O===q||!F(P)&&P.has(q)}function B(q,oe,be){if(!L(be))throw new Error("Metadata provider not registered.");var Pe=I(q,oe);if(Pe!==be){if(!F(Pe))return!1;var Nt=z.get(q);F(Nt)&&(Nt=new h,z.set(q,Nt)),Nt.set(oe,be)}return!0}}function pt(){var _;return!F(f)&&ve(n.Reflect)&&Object.isExtensible(n.Reflect)&&(_=n.Reflect[f]),F(_)&&(_=ft()),!F(f)&&ve(n.Reflect)&&Object.isExtensible(n.Reflect)&&Object.defineProperty(n.Reflect,f,{enumerable:!1,configurable:!1,writable:!1,value:_}),_}function Wt(_){var x=new y,O={isProviderFor:function(L,B){var q=x.get(L);return F(q)?!1:q.has(B)},OrdinaryDefineOwnMetadata:Re,OrdinaryHasOwnMetadata:z,OrdinaryGetOwnMetadata:qe,OrdinaryOwnMetadataKeys:re,OrdinaryDeleteMetadata:I};return g.registerProvider(O),O;function P(L,B,q){var oe=x.get(L),be=!1;if(F(oe)){if(!q)return;oe=new h,x.set(L,oe),be=!0}var Pe=oe.get(B);if(F(Pe)){if(!q)return;if(Pe=new h,oe.set(B,Pe),!_.setProvider(L,B,O))throw oe.delete(B),be&&x.delete(L),new Error("Wrong provider for target.")}return Pe}function z(L,B,q){var oe=P(B,q,!1);return F(oe)?!1:mt(oe.has(L))}function qe(L,B,q){var oe=P(B,q,!1);if(!F(oe))return oe.get(L)}function Re(L,B,q,oe){var be=P(q,oe,!0);be.set(L,B)}function re(L,B){var q=[],oe=P(L,B,!1);if(F(oe))return q;for(var be=oe.keys(),Pe=Be(be),Nt=0;;){var Ip=je(Pe);if(!Ip)return q.length=Nt,q;var f_=fe(Ip);try{q[Nt]=f_}catch(y_){try{ke(Pe)}finally{throw y_}}Nt++}}function I(L,B,q){var oe=P(B,q,!1);if(F(oe)||!oe.delete(L))return!1;if(oe.size===0){var be=x.get(B);F(be)||(be.delete(q),be.size===0&&x.delete(be))}return!0}}function zt(_){var x=_.defineMetadata,O=_.hasOwnMetadata,P=_.getOwnMetadata,z=_.getOwnMetadataKeys,qe=_.deleteMetadata,Re=new y,re={isProviderFor:function(I,L){var B=Re.get(I);return!F(B)&&B.has(L)?!0:z(I,L).length?(F(B)&&(B=new m,Re.set(I,B)),B.add(L),!0):!1},OrdinaryDefineOwnMetadata:x,OrdinaryHasOwnMetadata:O,OrdinaryGetOwnMetadata:P,OrdinaryOwnMetadataKeys:z,OrdinaryDeleteMetadata:qe};return re}function yt(_,x,O){var P=g.getProvider(_,x);if(!F(P))return P;if(O){if(g.setProvider(_,x,b))return b;throw new Error("Illegal state.")}}function ya(){var _={},x=[],O=function(){function re(I,L,B){this._index=0,this._keys=I,this._values=L,this._selector=B}return re.prototype["@@iterator"]=function(){return this},re.prototype[o]=function(){return this},re.prototype.next=function(){var I=this._index;if(I>=0&&I<this._keys.length){var L=this._selector(this._keys[I],this._values[I]);return I+1>=this._keys.length?(this._index=-1,this._keys=x,this._values=x):this._index++,{value:L,done:!1}}return{value:void 0,done:!0}},re.prototype.throw=function(I){throw this._index>=0&&(this._index=-1,this._keys=x,this._values=x),I},re.prototype.return=function(I){return this._index>=0&&(this._index=-1,this._keys=x,this._values=x),{value:I,done:!0}},re}(),P=function(){function re(){this._keys=[],this._values=[],this._cacheKey=_,this._cacheIndex=-2}return Object.defineProperty(re.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),re.prototype.has=function(I){return this._find(I,!1)>=0},re.prototype.get=function(I){var L=this._find(I,!1);return L>=0?this._values[L]:void 0},re.prototype.set=function(I,L){var B=this._find(I,!0);return this._values[B]=L,this},re.prototype.delete=function(I){var L=this._find(I,!1);if(L>=0){for(var B=this._keys.length,q=L+1;q<B;q++)this._keys[q-1]=this._keys[q],this._values[q-1]=this._values[q];return this._keys.length--,this._values.length--,Me(I,this._cacheKey)&&(this._cacheKey=_,this._cacheIndex=-2),!0}return!1},re.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=_,this._cacheIndex=-2},re.prototype.keys=function(){return new O(this._keys,this._values,z)},re.prototype.values=function(){return new O(this._keys,this._values,qe)},re.prototype.entries=function(){return new O(this._keys,this._values,Re)},re.prototype["@@iterator"]=function(){return this.entries()},re.prototype[o]=function(){return this.entries()},re.prototype._find=function(I,L){if(!Me(this._cacheKey,I)){this._cacheIndex=-1;for(var B=0;B<this._keys.length;B++)if(Me(this._keys[B],I)){this._cacheIndex=B;break}}return this._cacheIndex<0&&L&&(this._cacheIndex=this._keys.length,this._keys.push(I),this._values.push(void 0)),this._cacheIndex},re}();return P;function z(re,I){return re}function qe(re,I){return I}function Re(re,I){return[re,I]}}function ga(){var _=function(){function x(){this._map=new h}return Object.defineProperty(x.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),x.prototype.has=function(O){return this._map.has(O)},x.prototype.add=function(O){return this._map.set(O,O),this},x.prototype.delete=function(O){return this._map.delete(O)},x.prototype.clear=function(){this._map.clear()},x.prototype.keys=function(){return this._map.keys()},x.prototype.values=function(){return this._map.keys()},x.prototype.entries=function(){return this._map.entries()},x.prototype["@@iterator"]=function(){return this.keys()},x.prototype[o]=function(){return this.keys()},x}();return _}function yo(){var _=16,x=d.create(),O=P();return function(){function I(){this._key=P()}return I.prototype.has=function(L){var B=z(L,!1);return B!==void 0?d.has(B,this._key):!1},I.prototype.get=function(L){var B=z(L,!1);return B!==void 0?d.get(B,this._key):void 0},I.prototype.set=function(L,B){var q=z(L,!0);return q[this._key]=B,this},I.prototype.delete=function(L){var B=z(L,!1);return B!==void 0?delete B[this._key]:!1},I.prototype.clear=function(){this._key=P()},I}();function P(){var I;do I="@@WeakMap@@"+re();while(d.has(x,I));return x[I]=!0,I}function z(I,L){if(!i.call(I,O)){if(!L)return;Object.defineProperty(I,O,{value:d.create()})}return I[O]}function qe(I,L){for(var B=0;B<L;++B)I[B]=Math.random()*255|0;return I}function Re(I){if(typeof Uint8Array=="function"){var L=new Uint8Array(I);return typeof crypto<"u"?crypto.getRandomValues(L):typeof msCrypto<"u"?msCrypto.getRandomValues(L):qe(L,I),L}return qe(new Array(I),I)}function re(){var I=Re(_);I[6]=I[6]&79|64,I[8]=I[8]&191|128;for(var L="",B=0;B<_;++B){var q=I[B];(B===4||B===6||B===8)&&(L+="-"),q<16&&(L+="0"),L+=q.toString(16).toLowerCase()}return L}}function Xn(_){return _.__=void 0,delete _.__,_}})}(s||(s={})),tc}Gm(),typeof window<"u"&&(window.Buffer=__),typeof ka<"u"&&typeof require<"u"&&(ka.Buffer=require("buffer/").Buffer);class Ce{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const n of t)for(const i of Object.getOwnPropertyNames(n))e[i]=n[i]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class R extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class qs extends R{constructor(){super("Locking not supported on given driver.")}}class qa extends R{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class ye{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class Xm extends R{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return ye.isEntitySchema(e)?e.options.name:typeof e=="function"||Ce.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class nc extends R{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}}class ic extends R{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class Ym extends R{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class yi extends R{constructor(){super("OUTPUT or RETURNING clause only supported by Microsoft SQL Server or PostgreSQL or MariaDB databases.")}}class Lt extends R{constructor(e,t){super(e),Object.setPrototypeOf(this,Lt.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class ef extends R{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class tf extends R{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class En extends R{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class sf extends R{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class nf extends R{constructor(){super("An open transaction is required for pessimistic lock.")}}class af extends R{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class ac{constructor(e){Ce.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new R(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class Bt{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var Da={exports:{}},Ua={exports:{}},rc;gs=function(){return rc||(rc=1,typeof Object.create=="function"?Ua.exports=function(s,e){e&&(s.super_=e,s.prototype=Object.create(e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}))}:Ua.exports=function(s,e){if(e){s.super_=e;var t=function(){};t.prototype=e.prototype,s.prototype=new t,s.prototype.constructor=s}}),Ua.exports};var Fa,oc;function Ds(){if(oc)return Fa;oc=1;var s=Ns().Buffer;function e(t,n){this._block=s.alloc(t),this._finalSize=n,this._blockSize=t,this._len=0}return e.prototype.update=function(t,n){typeof t=="string"&&(n=n||"utf8",t=s.from(t,n));for(var i=this._block,a=this._blockSize,r=t.length,o=this._len,c=0;c<r;){for(var l=o%a,u=Math.min(r-c,a-l),d=0;d<u;d++)i[l+d]=t[c+d];o+=u,c+=u,o%a===0&&this._update(i)}return this._len+=r,this},e.prototype.digest=function(t){var n=this._len%this._blockSize;this._block[n]=128,this._block.fill(0,n+1),n>=this._finalSize&&(this._update(this._block),this._block.fill(0));var i=this._len*8;if(i<=4294967295)this._block.writeUInt32BE(i,this._blockSize-4);else{var a=(i&4294967295)>>>0,r=(i-a)/4294967296;this._block.writeUInt32BE(r,this._blockSize-8),this._block.writeUInt32BE(a,this._blockSize-4)}this._update(this._block);var o=this._hash();return t?o.toString(t):o},e.prototype._update=function(){throw new Error("_update must be implemented by subclass")},Fa=e,Fa}var Za,cc;function rf(){if(cc)return Za;cc=1;var s=gs(),e=Ds(),t=Ns().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],i=new Array(80);function a(){this.init(),this._w=i,e.call(this,64,56)}s(a,e),a.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function r(l){return l<<5|l>>>27}function o(l){return l<<30|l>>>2}function c(l,u,d,p){return l===0?u&d|~u&p:l===2?u&d|u&p|d&p:u^d^p}return a.prototype._update=function(l){for(var u=this._w,d=this._a|0,p=this._b|0,h=this._c|0,m=this._d|0,y=this._e|0,f=0;f<16;++f)u[f]=l.readInt32BE(f*4);for(;f<80;++f)u[f]=u[f-3]^u[f-8]^u[f-14]^u[f-16];for(var g=0;g<80;++g){var b=~~(g/20),v=r(d)+c(b,p,h,m)+y+u[g]+n[b]|0;y=m,m=h,h=o(p),p=d,d=v}this._a=d+this._a|0,this._b=p+this._b|0,this._c=h+this._c|0,this._d=m+this._d|0,this._e=y+this._e|0},a.prototype._hash=function(){var l=t.allocUnsafe(20);return l.writeInt32BE(this._a|0,0),l.writeInt32BE(this._b|0,4),l.writeInt32BE(this._c|0,8),l.writeInt32BE(this._d|0,12),l.writeInt32BE(this._e|0,16),l},Za=a,Za}var Wa,lc;function of(){if(lc)return Wa;lc=1;var s=gs(),e=Ds(),t=Ns().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],i=new Array(80);function a(){this.init(),this._w=i,e.call(this,64,56)}s(a,e),a.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function r(u){return u<<1|u>>>31}function o(u){return u<<5|u>>>27}function c(u){return u<<30|u>>>2}function l(u,d,p,h){return u===0?d&p|~d&h:u===2?d&p|d&h|p&h:d^p^h}return a.prototype._update=function(u){for(var d=this._w,p=this._a|0,h=this._b|0,m=this._c|0,y=this._d|0,f=this._e|0,g=0;g<16;++g)d[g]=u.readInt32BE(g*4);for(;g<80;++g)d[g]=r(d[g-3]^d[g-8]^d[g-14]^d[g-16]);for(var b=0;b<80;++b){var v=~~(b/20),E=o(p)+l(v,h,m,y)+f+d[b]+n[v]|0;f=y,y=m,m=c(h),h=p,p=E}this._a=p+this._a|0,this._b=h+this._b|0,this._c=m+this._c|0,this._d=y+this._d|0,this._e=f+this._e|0},a.prototype._hash=function(){var u=t.allocUnsafe(20);return u.writeInt32BE(this._a|0,0),u.writeInt32BE(this._b|0,4),u.writeInt32BE(this._c|0,8),u.writeInt32BE(this._d|0,12),u.writeInt32BE(this._e|0,16),u},Wa=a,Wa}var za,uc;function dc(){if(uc)return za;uc=1;var s=gs(),e=Ds(),t=Ns().Buffer,n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],i=new Array(64);function a(){this.init(),this._w=i,e.call(this,64,56)}s(a,e),a.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function r(p,h,m){return m^p&(h^m)}function o(p,h,m){return p&h|m&(p|h)}function c(p){return(p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10)}function l(p){return(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7)}function u(p){return(p>>>7|p<<25)^(p>>>18|p<<14)^p>>>3}function d(p){return(p>>>17|p<<15)^(p>>>19|p<<13)^p>>>10}return a.prototype._update=function(p){for(var h=this._w,m=this._a|0,y=this._b|0,f=this._c|0,g=this._d|0,b=this._e|0,v=this._f|0,E=this._g|0,S=this._h|0,A=0;A<16;++A)h[A]=p.readInt32BE(A*4);for(;A<64;++A)h[A]=d(h[A-2])+h[A-7]+u(h[A-15])+h[A-16]|0;for(var Q=0;Q<64;++Q){var H=S+l(b)+r(b,v,E)+n[Q]+h[Q]|0,W=c(m)+o(m,y,f)|0;S=E,E=v,v=b,b=g+H|0,g=f,f=y,y=m,m=H+W|0}this._a=m+this._a|0,this._b=y+this._b|0,this._c=f+this._c|0,this._d=g+this._d|0,this._e=b+this._e|0,this._f=v+this._f|0,this._g=E+this._g|0,this._h=S+this._h|0},a.prototype._hash=function(){var p=t.allocUnsafe(32);return p.writeInt32BE(this._a,0),p.writeInt32BE(this._b,4),p.writeInt32BE(this._c,8),p.writeInt32BE(this._d,12),p.writeInt32BE(this._e,16),p.writeInt32BE(this._f,20),p.writeInt32BE(this._g,24),p.writeInt32BE(this._h,28),p},za=a,za}var Va,pc;function cf(){if(pc)return Va;pc=1;var s=gs(),e=dc(),t=Ds(),n=Ns().Buffer,i=new Array(64);function a(){this.init(),this._w=i,t.call(this,64,56)}return s(a,e),a.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},a.prototype._hash=function(){var r=n.allocUnsafe(28);return r.writeInt32BE(this._a,0),r.writeInt32BE(this._b,4),r.writeInt32BE(this._c,8),r.writeInt32BE(this._d,12),r.writeInt32BE(this._e,16),r.writeInt32BE(this._f,20),r.writeInt32BE(this._g,24),r},Va=a,Va}var Ka,hc;function mc(){if(hc)return Ka;hc=1;var s=gs(),e=Ds(),t=Ns().Buffer,n=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],i=new Array(160);function a(){this.init(),this._w=i,e.call(this,128,112)}s(a,e),a.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function r(y,f,g){return g^y&(f^g)}function o(y,f,g){return y&f|g&(y|f)}function c(y,f){return(y>>>28|f<<4)^(f>>>2|y<<30)^(f>>>7|y<<25)}function l(y,f){return(y>>>14|f<<18)^(y>>>18|f<<14)^(f>>>9|y<<23)}function u(y,f){return(y>>>1|f<<31)^(y>>>8|f<<24)^y>>>7}function d(y,f){return(y>>>1|f<<31)^(y>>>8|f<<24)^(y>>>7|f<<25)}function p(y,f){return(y>>>19|f<<13)^(f>>>29|y<<3)^y>>>6}function h(y,f){return(y>>>19|f<<13)^(f>>>29|y<<3)^(y>>>6|f<<26)}function m(y,f){return y>>>0<f>>>0?1:0}return a.prototype._update=function(y){for(var f=this._w,g=this._ah|0,b=this._bh|0,v=this._ch|0,E=this._dh|0,S=this._eh|0,A=this._fh|0,Q=this._gh|0,H=this._hh|0,W=this._al|0,U=this._bl|0,me=this._cl|0,Oe=this._dl|0,le=this._el|0,ut=this._fl|0,Xe=this._gl|0,tt=this._hl|0,_e=0;_e<32;_e+=2)f[_e]=y.readInt32BE(_e*4),f[_e+1]=y.readInt32BE(_e*4+4);for(;_e<160;_e+=2){var St=f[_e-30],st=f[_e-15*2+1],ps=u(St,st),dt=d(st,St);St=f[_e-2*2],st=f[_e-2*2+1];var Ft=p(St,st),F=h(st,St),nt=f[_e-7*2],Zt=f[_e-7*2+1],ve=f[_e-16*2],Ts=f[_e-16*2+1],He=dt+Zt|0,mt=ps+nt+m(He,dt)|0;He=He+F|0,mt=mt+Ft+m(He,F)|0,He=He+Ts|0,mt=mt+ve+m(He,Ts)|0,f[_e]=mt,f[_e+1]=He}for(var Tt=0;Tt<160;Tt+=2){mt=f[Tt],He=f[Tt+1];var it=o(g,b,v),hs=o(W,U,me),ms=c(g,W),V=c(W,g),Y=l(S,le),Me=l(le,S),We=n[Tt],Be=n[Tt+1],fe=r(S,A,Q),je=r(le,ut,Xe),ke=tt+Me|0,we=H+Y+m(ke,tt)|0;ke=ke+je|0,we=we+fe+m(ke,je)|0,ke=ke+Be|0,we=we+We+m(ke,Be)|0,ke=ke+He|0,we=we+mt+m(ke,He)|0;var ft=V+hs|0,pt=ms+it+m(ft,V)|0;H=Q,tt=Xe,Q=A,Xe=ut,A=S,ut=le,le=Oe+ke|0,S=E+we+m(le,Oe)|0,E=v,Oe=me,v=b,me=U,b=g,U=W,W=ke+ft|0,g=we+pt+m(W,ke)|0}this._al=this._al+W|0,this._bl=this._bl+U|0,this._cl=this._cl+me|0,this._dl=this._dl+Oe|0,this._el=this._el+le|0,this._fl=this._fl+ut|0,this._gl=this._gl+Xe|0,this._hl=this._hl+tt|0,this._ah=this._ah+g+m(this._al,W)|0,this._bh=this._bh+b+m(this._bl,U)|0,this._ch=this._ch+v+m(this._cl,me)|0,this._dh=this._dh+E+m(this._dl,Oe)|0,this._eh=this._eh+S+m(this._el,le)|0,this._fh=this._fh+A+m(this._fl,ut)|0,this._gh=this._gh+Q+m(this._gl,Xe)|0,this._hh=this._hh+H+m(this._hl,tt)|0},a.prototype._hash=function(){var y=t.allocUnsafe(64);function f(g,b,v){y.writeInt32BE(g,v),y.writeInt32BE(b,v+4)}return f(this._ah,this._al,0),f(this._bh,this._bl,8),f(this._ch,this._cl,16),f(this._dh,this._dl,24),f(this._eh,this._el,32),f(this._fh,this._fl,40),f(this._gh,this._gl,48),f(this._hh,this._hl,56),y},Ka=a,Ka}var Qa,fc;function lf(){if(fc)return Qa;fc=1;var s=gs(),e=mc(),t=Ds(),n=Ns().Buffer,i=new Array(160);function a(){this.init(),this._w=i,t.call(this,128,112)}return s(a,e),a.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},a.prototype._hash=function(){var r=n.allocUnsafe(48);function o(c,l,u){r.writeInt32BE(c,u),r.writeInt32BE(l,u+4)}return o(this._ah,this._al,0),o(this._bh,this._bl,8),o(this._ch,this._cl,16),o(this._dh,this._dl,24),o(this._eh,this._el,32),o(this._fh,this._fl,40),r},Qa=a,Qa}var yc;function uf(){if(yc)return Da.exports;yc=1;var s=Da.exports=function(e){e=e.toLowerCase();var t=s[e];if(!t)throw new Error(e+" is not supported (we accept pull requests)");return new t};return s.sha=rf(),s.sha1=of(),s.sha224=cf(),s.sha256=dc(),s.sha384=lf(),s.sha512=mc(),Da.exports}var df=uf();const pf=v_(df);function hf(s,e={}){const{segmentLength:t=4,separator:n="__",termLength:i=2}=e;return s.split(n).reduce((a,r)=>{const o=r.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),c=o.length>1?i:t,l=o.map(u=>u.substr(0,c)).join("");return a.push(l),a},[]).join(n)}function mf(s,e={}){const t=pf("sha1");t.update(s,"utf8");const n=t.digest("hex");return e.length?n.slice(0,e.length):n}class ff{static isGreaterOrEqual(e,t){const n=gc(e),i=gc(t);return n[0]>i[0]||n[0]===i[0]&&n[1]>i[1]||n[0]===i[0]&&n[1]===i[1]&&n[2]>=i[2]}}function gc(s=""){const e=[0,0,0];return s.split(".").forEach((t,n)=>e[n]=parseInt(t,10)),e}class N{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return e.version!=null&&ff.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){const i=t&&t.joiner?t.joiner:"_";let a=n.length===1?n[0]:n.join(i);if(e&&e>0&&a.length>e){if(t&&t.shorten===!0){const r=hf(a);if(r.length<e)return r}return mf(a,{length:e})}return a}static buildColumnAlias({maxAliasLength:e},t,...n){return typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),a=i.indexOf("/"),r=a!==-1?i.substr(0,a):i;let o=a!==-1?i.substr(a+1):void 0;o&&o.indexOf("?")!==-1&&(o=o.substr(0,o.indexOf("?")));const c=r.lastIndexOf("@"),l=r.substr(0,c),u=r.substr(c+1);let d=l,p="";const h=l.indexOf(":");h!==-1&&(d=l.substr(0,h),p=l.substr(h+1));const[m,y]=u.split(":");return{type:t,host:m,username:decodeURIComponent(d),password:decodeURIComponent(p),port:y?parseInt(y):void 0,database:o||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),a=i.indexOf("/"),r=a!==-1?i.substr(0,a):i;let o=a!==-1?i.substr(a+1):void 0,c="",l,u,d,p,h={};if(o&&o.indexOf("?")!==-1){c=o.substr(o.indexOf("?")+1,o.length);const S=c.split("&");let A,Q;S.forEach(H=>{A=H.split("=")[0],Q=H.split("=")[1],h[A]=Q}),p=h.replicaSet,o=o.substr(0,o.indexOf("?"))}const m=r.lastIndexOf("@"),y=r.substr(0,m),f=r.substr(m+1);let g=y,b="";const v=y.indexOf(":");v!==-1&&(g=y.substr(0,v),b=y.substr(v+1)),p?d=f:[l,u]=f.split(":");let E={type:t,host:l,hostReplicaSet:d,username:decodeURIComponent(g),password:decodeURIComponent(b),port:u?parseInt(u):void 0,database:o||void 0};for(const[S,A]of Object.entries(h))E[S]=A;return E}}class bc{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,n&&Ce.assign(this,n)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(Bt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(Bt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!Bt.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new R(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new R("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new R("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?N.buildAlias(this.connection.driver,void 0,e,this.alias.name):N.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class Ha{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,Ce.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value must be a string representation of alias property");const e=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new R(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return e}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Ja{constructor(e,t){this.expressionMap=e,Ce.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),n=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!n)throw new R(`Relation with property path ${t} in entity was not found.`);return n}get metadata(){if(!Bt.isAliasProperty(this.relationName))throw new R("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class Ga{constructor(e){var t;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((t=e.options)==null?void 0:t.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const n=new ac;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){const t=this.aliases.find(n=>n.name===e);if(!t)throw new R(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new R("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new R(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new Ga(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new ac(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new bc(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Ha(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Ja(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class _c{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class Xa{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((n,i)=>i.from(n),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,i)=>i.to(n),t):e.to(t)}}class Mn{constructor(e,t,n=!0,i=!1,a,r){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=i,this._getSql=a,this._objectLiteralParameters=r}get useParameter(){return ye.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return ye.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return ye.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return ye.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(ye.isFindOperator(this._value))return this._value}get getSql(){return ye.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof Mn?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&Xa.transformTo(e,t)):Xa.transformTo(e,this._value)}}xo=function(s){return new Mn("in",s,!0,!0)};const yf=/[.*+\-?^${}()|[\]\\]/g,gf=s=>s.replace(yf,"\\$&");class Ee{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,ye.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Ga(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){Ee.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new R("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(n=>({selection:n})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),ye.isSelectQueryBuilder(this)?this:Ee.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",ye.isInsertQueryBuilder(this)?this:Ee.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const n=t||e;if(e=ye.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const i=this.createFromAlias(e);this.expressionMap.setMainAlias(i)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=n,ye.isUpdateQueryBuilder(this)?this:Ee.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",ye.isDeleteQueryBuilder(this)?this:Ee.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",ye.isSoftDeleteQueryBuilder(this)?this:Ee.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",ye.isSoftDeleteQueryBuilder(this)?this:Ee.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const n=arguments.length===2?e:void 0,i=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=i,n){const a=this.createFromAlias(n);this.expressionMap.setMainAlias(a)}return ye.isRelationQueryBuilder(this)?this:Ee.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!n.findRelationWithPropertyPath(i))}hasParameter(e){var t;return((t=this.parentQueryBuilder)==null?void 0:t.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new R(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new R("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const n=t.childEntityMetadatas.filter(i=>i.discriminatorColumn).map(i=>i.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new R('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){const a=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:a?void 0:e,subQuery:a?e:void 0})}const n=e(this.subQuery());this.setParameters(n.getParameters());const i=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:i})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const a of this.expressionMap.aliases){if(!a.hasMetadata)continue;const r=this.expressionMap.aliasNamePrefixingEnabled&&a.name?`${a.name}.`:"";t[r]||(t[r]={});for(const o of a.metadata.relations)o.joinColumns.length>0&&(t[r][o.propertyPath]=o.joinColumns[0].databaseName);for(const o of a.metadata.relations){const c=[...o.joinColumns,...o.inverseJoinColumns];for(const l of c){const u=`${o.propertyPath}.${l.referencedColumn.propertyPath}`;t[r][u]=l.databaseName}}for(const o of a.metadata.columns)t[r][o.databaseName]=o.databaseName;for(const o of a.metadata.columns)t[r][o.propertyName]=o.databaseName;for(const o of a.metadata.columns)t[r][o.propertyPath]=o.databaseName}const n=Object.keys(t),i=n.map(a=>gf(a)).join("|");return n.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${i?"("+i+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...a)=>{let r,o,c;if(i){if(r=a[0],o=a[1],c=a[3],t[a[2]][c])return`${o}${this.escape(a[2].substring(0,a[2].length-1))}.${this.escape(t[a[2]][c])}`}else if(r=a[0],o=a[1],c=a[2],t[""][c])return`${o}${this.escape(t[""][c])}`;return r})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const a=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName,r=`${this.replacePropertyNames(a)} IS NULL`;e.push(r)}if(i.discriminatorColumn&&i.parentEntityMetadata){const a=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName,r=`${this.replacePropertyNames(a)} IN (:...discriminatorColumnValues)`;e.push(r)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(i)}let n="";return n+=this.createTimeTravelQuery(),e.length?e.length===1?n+=` WHERE ${e[0]}`:n+=` WHERE ( ${e.join(" ) AND ( ")} )`:n+="",n}createReturningExpression(e){const t=this.getReturningColumns(),n=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(i=>t.indexOf(i)===-1)),t.length){let i=t.map(a=>{const r=this.escape(a.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+r:this.escape(this.getMainTableName())+"."+r:r}).join(", ");return n.options.type==="oracle"&&(i+=" INTO "+t.map(a=>this.createParameter({type:n.columnTypeToNativeParameter(a.type),dir:n.oracle.BIND_OUT})).join(", ")),n.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(i+=" INTO @OutputTable"),i}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{const i=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(n>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`}return i}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return n.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${Mn.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(t=>{const n=typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.getQuery();if(typeof t.queryBuilder!="string"){if(t.queryBuilder.hasCommonTableExpressions())throw new R(`Nested CTEs aren't supported (CTE: ${t.alias})`);if(!this.connection.driver.cteCapabilities.writable&&!ye.isSelectQueryBuilder(t.queryBuilder))throw new R(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${t.alias})`);this.setParameters(t.queryBuilder.getParameters())}let i=this.escape(t.alias);if(t.options.columnNames){const o=t.options.columnNames.map(c=>this.escape(c));if(ye.isSelectQueryBuilder(t.queryBuilder)&&t.queryBuilder.expressionMap.selects.length&&t.options.columnNames.length!==t.queryBuilder.expressionMap.selects.length)throw new R(`cte.options.columnNames length (${t.options.columnNames.length}) doesn't match subquery select list length ${t.queryBuilder.expressionMap.selects.length} (CTE: ${t.alias})`);i+=`(${o.join(", ")})`}const a=t.options.recursive&&e?"RECURSIVE":"";let r="";return this.connection.driver.cteCapabilities.materializedHint&&t.options.materialized!==void 0&&(r=t.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[a,i,"AS",r,`(${n})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(i=>t.ensureEntityIdMap(i));if(!t.hasMultiplePrimaryKeys){const i=t.primaryColumns[0];if(!i.transformer&&!i.relationMetadata&&!i.embeddedMetadata)return{[i.propertyName]:xo(n.map(a=>i.getEntityValue(a,!1)))}}return new _c(i=>{for(const a of n)i.orWhere(new _c(r=>r.where(a)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const n=[],i=e.split(".");for(;i.length>1;){const o=i[0];if(!(t!=null&&t.hasMetadata))break;if(t.metadata.hasEmbeddedWithPropertyPath(o)){i.unshift(`${i.shift()}.${i.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(o)){const c=this.expressionMap.joinAttributes.find(l=>l.relationPropertyPath===o);if(!(c!=null&&c.alias)){const l=n.length>0?`${n.join(".")}.${o}`:o;throw new Error(`Cannot find alias for relation at ${l}`)}t=c.alias,n.push(...o.split(".")),i.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const a=i.join("."),r=t.metadata.findColumnsWithPropertyPath(a);if(!r.length)throw new Lt(e,t.metadata);return[t,n,r]}createPropertyPath(e,t,n=""){const i=[];for(const a of Object.keys(t)){const r=n?`${n}.${a}`:a;if(t[a]===null||typeof t[a]!="object"||ye.isFindOperator(t[a])){i.push(r);continue}if(e.hasEmbeddedWithPropertyPath(r)){const o=this.createPropertyPath(e,t[a],r);i.push(...o);continue}if(e.hasRelationWithPropertyPath(r)){const o=e.findRelationWithPropertyPath(r);if(o.relationType==="one-to-one"||o.relationType==="many-to-one"){const u=o.joinColumns.map(d=>d.referencedColumn).filter(d=>!!d);if(u.length>0&&u.every(d=>d.getEntityValue(t[a],!1))){i.push(r);continue}}if(o.relationType==="one-to-many"||o.relationType==="many-to-many")throw new Error(`Cannot query across ${o.relationType} for property ${r}`);const c=o.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(u=>u.getEntityValue(t[a],!1))){const u=c.map(d=>`${r}.${d.propertyPath}`);i.push(...u);continue}const l=this.createPropertyPath(o.inverseEntityMetadata,t[a]).map(u=>`${r}.${u}`);i.push(...l);continue}i.push(r)}return i}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const n of t){const[i,a,r]=this.findColumnsForPropertyPath(n);for(const o of r){let c=e;for(const d of a){if(!c||!(d in c)){c={};break}c=c[d]}const l=this.expressionMap.aliasNamePrefixingEnabled?`${i.name}.${o.propertyPath}`:o.propertyPath,u=o.getEntityValue(c,!0);yield[l,u]}}}else for(const t of Object.keys(e)){const n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){if(ye.isFindOperator(t)){let n=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const i of t.value)n.push(this.createParameter(i));else n.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...n]};if(t.type==="and"){const i=t.value;return{operator:t.type,parameters:i.map(a=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,a)))}}else if(t.type==="or"){const i=t.value;return{operator:t.type,parameters:i.map(a=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,a)))}}else return{operator:t.type,parameters:[e,...n]}}else return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(ye.isBrackets(e)){const i=this.createQueryBuilder();return i.parentQueryBuilder=this,i.expressionMap.mainAlias=this.expressionMap.mainAlias,i.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,i.expressionMap.parameters=this.expressionMap.parameters,i.expressionMap.nativeParameters=this.expressionMap.nativeParameters,i.expressionMap.wheres=[],e.whereFactory(i),{operator:ye.isNotBrackets(e)?"not":"brackets",condition:i.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],n=[];for(const i of t){const a=[];for(const[r,o]of this.getPredicates(i))a.push({type:"and",condition:this.getWherePredicateCondition(r,o)});n.push({type:"or",condition:a})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}Ee.queryBuilderRegistry={};class bf{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class _f extends Ee{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const a=await n.query(e,t,!0),r=bf.from(a);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),i&&await n.commitTransaction(),r}catch(a){if(i)try{await n.rollbackTransaction()}catch{}throw a}finally{n!==this.queryRunner&&await n.release()}}from(e,t){e=ye.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new yi;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),n=this.createReturningExpression("delete");return n===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${n}${t}`:`DELETE FROM ${e}${t} RETURNING ${n}`}}let gi;const vf=new Uint8Array(16);function wf(){if(!gi&&(gi=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!gi))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return gi(vf)}const De=[];for(let s=0;s<256;++s)De.push((s+256).toString(16).slice(1));function xf(s,e=0){return De[s[e+0]]+De[s[e+1]]+De[s[e+2]]+De[s[e+3]]+"-"+De[s[e+4]]+De[s[e+5]]+"-"+De[s[e+6]]+De[s[e+7]]+"-"+De[s[e+8]]+De[s[e+9]]+"-"+De[s[e+10]]+De[s[e+11]]+De[s[e+12]]+De[s[e+13]]+De[s[e+14]]+De[s[e+15]]}const Of=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),vc={randomUUID:Of};function Ef(s,e,t){if(vc.randomUUID&&!e&&!s)return vc.randomUUID();s=s||{};const n=s.random||(s.rng||wf)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,xf(n)}class wc{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class xc{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Ya{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(i,a)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,l,u)=>(c[this.expressionMap.extraReturningColumns[u].databaseName]=l[0],c),{}));const r=Array.isArray(e.raw)?e.raw[a]:e.raw,o=this.queryRunner.connection.driver.createGeneratedMap(n,r);o&&(this.queryRunner.manager.merge(n.target,i,o),e.generatedMaps.push(o))}else{const r=this.expressionMap.extraReturningColumns;if(r.length>0){const o=this.expressionMap.mainAlias.metadata.getEntityIdMap(i);if(!o)throw new R("Cannot update entity because entity id is not set in the entity.");const c=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(l=>n.targetName+"."+l.propertyPath)).addSelect(r.map(l=>n.targetName+"."+l.propertyPath)).from(n.target,n.targetName).where(o).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(n.target,i,c),e.generatedMaps.push(c))}}}))}async insert(e,t){const n=this.expressionMap.mainAlias.metadata;let i=n.getInsertionReturningColumns();const a=this.queryRunner.connection.driver.isReturningSqlSupported("insert");i=i.filter(o=>o.isGenerated?a===!0:!0);const r=t.map((o,c)=>{this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((d,p,h)=>(d[this.expressionMap.extraReturningColumns[h].databaseName]=p[0],d),{}));const l=Array.isArray(e.raw)?e.raw[c]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(n,l,c,t.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,u,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(n.target,o,u),u});if(i.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const o=t.map(l=>{const u=n.getEntityIdMap(l);if(!u)throw new R("Cannot update entity because entity id is not set in the entity.");return u}),c=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(l=>n.targetName+"."+l.propertyPath)).addSelect(i.map(l=>n.targetName+"."+l.propertyPath)).from(n.target,n.targetName).where(o).setOption("create-pojo").getMany();t.forEach((l,u)=>{this.queryRunner.manager.merge(n.target,r[u],c[u]),this.queryRunner.manager.merge(n.target,l,c[u])})}t.forEach((o,c)=>{const l=n.getEntityIdMap(o);e.identifiers.push(l),e.generatedMaps.push(r[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class Mf extends Ee{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new xc;const t=this.obtainQueryRunner();let n=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const h=new wc;e.forEach(m=>{t.broadcaster.broadcastBeforeInsertEvent(h,this.expressionMap.mainAlias.metadata,m)}),await h.wait()}let i=null,a=null;const r=new Ya(t,this.expressionMap),o=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)o.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),o.push(...this.expressionMap.extraReturningColumns.filter(h=>!o.includes(h)))),o.length>0&&this.connection.driver.options.type==="mssql"&&(i=this.connection.driver.buildTableVariableDeclaration("@OutputTable",o),a="SELECT * FROM @OutputTable");const[c,l]=this.getQueryAndParameters(),u=[i,c,a].filter(h=>h!=null).join(`;

`),d=await t.query(u,l,!0),p=xc.from(d);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.insert(p,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const h=new wc;e.forEach(m=>{t.broadcaster.broadcastAfterInsertEvent(h,this.expressionMap.mainAlias.metadata,m)}),await h.wait()}return n&&await t.commitTransaction(),p}catch(i){if(n)try{await t.rollbackTransaction()}catch{}throw i}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=ye.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e);return this.expressionMap.setMainAlias(n),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new yi;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,n){return Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,indexPredicate:n==null?void 0:n.indexPredicate,upsertType:n==null?void 0:n.upsertType},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,upsertType:n==null?void 0:n.upsertType},this)}createInsertExpression(){var r,o;const e=this.getTableName(this.getMainTableName()),t=this.createValuesExpression(),n=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression();let a="INSERT ";if(((r=this.expressionMap.onUpdate)==null?void 0:r.upsertType)==="primary-key"&&(a="UPSERT "),(N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),a+=`INTO ${e}`,this.alias!==this.getMainTableName()&&N.isPostgresFamily(this.connection.driver)&&(a+=` AS "${this.alias}"`),i?a+=`(${i})`:!t&&(N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+="()"),n&&this.connection.driver.options.type==="mssql"&&(a+=` OUTPUT ${n}`),t?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?a+=` ${t}`:a+=` VALUES ${t}`:N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?a+=" VALUES ()":a+=" DEFAULT VALUES",((o=this.expressionMap.onUpdate)==null?void 0:o.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)a+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)a+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:c,columns:l,conflict:u,skipUpdateIfNoValuesChanged:d,indexPredicate:p}=this.expressionMap.onUpdate;let h="ON CONFLICT";if(Array.isArray(u)){if(h+=` ( ${u.map(y=>this.escape(y)).join(", ")} )`,p&&!N.isPostgresFamily(this.connection.driver))throw new R("indexPredicate option is not supported by the current database driver");p&&N.isPostgresFamily(this.connection.driver)&&(h+=` WHERE ( ${p} )`)}else u&&(h+=` ON CONSTRAINT ${this.escape(u)}`);const m=[];Array.isArray(c)?m.push(...c.map(y=>`${this.escape(y)} = EXCLUDED.${this.escape(y)}`)):l&&m.push(...l.map(y=>`${this.escape(y)} = :${y}`)),m.length>0&&(a+=` ${h} DO UPDATE SET `,m.push(...this.expressionMap.mainAlias.metadata.columns.filter(y=>y.isUpdateDate&&!(c!=null&&c.includes(y.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||N.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(y=>`${this.escape(y.databaseName)} = DEFAULT`)),a+=m.join(", "),a+=" "),Array.isArray(c)&&d&&N.isPostgresFamily(this.connection.driver)&&(a+=" WHERE (",a+=c.map(y=>`${e}.${this.escape(y)} IS DISTINCT FROM EXCLUDED.${this.escape(y)}`).join(" OR "),a+=") ")}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:c,columns:l}=this.expressionMap.onUpdate;Array.isArray(c)?(a+=" ON DUPLICATE KEY UPDATE ",a+=c.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),a+=" "):Array.isArray(l)&&(a+=" ON DUPLICATE KEY UPDATE ",a+=l.map(u=>`${this.escape(u)} = :${u}`).join(", "),a+=" ")}}else if(this.expressionMap.onUpdate)throw new R("onUpdate is not supported by the current database driver")}return n&&(N.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||N.isMySQLFamily(this.connection.driver))&&(a+=` RETURNING ${n}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(c=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(c.propertyPath)!==-1:c.isInsert).some(c=>this.isOverridingAutoIncrementBehavior(c))&&(a=`SET IDENTITY_INSERT ${e} ON; ${a}; SET IDENTITY_INSERT ${e} OFF`),a}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!N.isSQLiteFamily(this.connection.driver)&&!N.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(n=>this.escape(n)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let n="";return e.forEach((i,a)=>{t.forEach((r,o)=>{o===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?n+=" SELECT ":n+="(");let c=r.getEntityValue(i);if(typeof c!="function"&&(c=this.connection.driver.preparePersistentValue(c,r)),r.isVersion&&c===void 0)n+="1";else if(r.isDiscriminator)n+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(r.isGenerated&&r.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&c===void 0)c=Ef(),n+=this.createParameter(c),a in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[a]={}),r.setEntityValue(this.expressionMap.locallyGenerated[a],c);else if(c===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||N.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r.default!==void 0&&r.default!==null?n+=this.connection.driver.normalizeDefault(r):n+="NULL":n+="DEFAULT";else if(c===null&&this.connection.driver.options.type==="spanner")n+="NULL";else if(typeof c=="function")n+=c();else{this.connection.driver.options.type==="mssql"&&(c=this.connection.driver.parametrizeValue(r,c));const l=this.createParameter(c);if((N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1){const u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";r.srid!=null?n+=`${u}(${l}, ${r.srid})`:n+=`${u}(${l})`}else N.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1?r.srid!=null?n+=`ST_SetSRID(ST_GeomFromGeoJSON(${l}), ${r.srid})::${r.type}`:n+=`ST_GeomFromGeoJSON(${l})::${r.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1?n+=r.type+"::STGeomFromText("+l+", "+(r.srid||"0")+")":n+=l}o===t.length-1?a===e.length-1?this.connection.driver.options.type==="oracle"&&e.length>1?n+=" FROM DUAL ":this.connection.driver.options.type==="sap"&&e.length>1?n+=" FROM dummy ":n+=")":this.connection.driver.options.type==="oracle"&&e.length>1?n+=" FROM DUAL UNION ALL ":this.connection.driver.options.type==="sap"&&e.length>1?n+=" FROM dummy UNION ALL ":n+="), ":n+=", "})}),n==="()"?"":n}else{let n="";return e.forEach((i,a)=>{Object.keys(i).forEach((r,o)=>{o===0&&(n+="(");const c=i[r];typeof c=="function"?n+=c():c===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||N.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n+="NULL":n+="DEFAULT":c===null&&this.connection.driver.options.type==="spanner"||(n+=this.createParameter(c)),o===Object.keys(i).length-1?a===e.length-1?n+=")":n+="), ":n+=", "})}),n==="()"?"":n}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(Ce.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new tf}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}}class Oc{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const n=t.joinColumns.reduce((i,a)=>{const r=Ce.isObject(e)?a.referencedColumn.getEntityValue(e):e;return a.setEntityValue(i,r),i},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const n={};t.inverseRelation.joinColumns.forEach(c=>{n[c.propertyName]=null});const i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a={},r=[];i.forEach((c,l)=>{t.inverseRelation.joinColumns.map((u,d)=>{const p="joinColumn_"+l+"_"+d;a[p]=Ce.isObject(c)?u.referencedColumn.getEntityValue(c):c,r.push(`${u.propertyPath} = :${p}`)})});const o=r.map(c=>"("+c+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(o).setParameters(a).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new R("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const n=this.expressionMap.of,i=t.inverseRelation.joinColumns.reduce((a,r)=>{const o=Ce.isObject(n)?r.referencedColumn.getEntityValue(n):n;return r.setEntityValue(a,o),a},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).whereInIds(e).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?i:a,o=t.isManyToManyOwner?a:i,c=[];if(r.forEach(l=>{o.forEach(u=>{const d={};n.ownerColumns.forEach(p=>{d[p.databaseName]=Ce.isObject(l)?p.referencedColumn.getEntityValue(l):l}),n.inverseColumns.forEach(p=>{d[p.databaseName]=Ce.isObject(u)?p.referencedColumn.getEntityValue(u):u}),c.push(d)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(l=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(l).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(c).execute()}}}class kf{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],a={};t.inverseRelation.joinColumns.forEach(l=>{a[l.propertyName]=null});const r={},o=[];n.forEach((l,u)=>{o.push(...i.map((d,p)=>[...t.inverseRelation.joinColumns.map((h,m)=>{const y="joinColumn_"+u+"_"+p+"_"+m;return r[y]=Ce.isObject(l)?h.referencedColumn.getEntityValue(l):l,`${h.propertyPath} = :${y}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((h,m)=>{const y="primaryColumn_"+p+"_"+p+"_"+m;return r[y]=Ce.isObject(d)?h.getEntityValue(d):d,`${h.propertyPath} = :${y}`})].join(" AND ")))});const c=o.map(l=>"("+l+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(a).where(c).setParameters(r).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?i:a,o=t.isManyToManyOwner?a:i,c={},l=[];r.forEach((d,p)=>{l.push(...o.map((h,m)=>[...n.ownerColumns.map((y,f)=>{const g="firstValue_"+p+"_"+m+"_"+f;return c[g]=Ce.isObject(d)?y.referencedColumn.getEntityValue(d):d,`${y.databaseName} = :${g}`}),...n.inverseColumns.map((y,f)=>{const g="secondValue_"+p+"_"+m+"_"+f;return c[g]=Ce.isObject(h)?y.referencedColumn.getEntityValue(h):h,`${y.databaseName} = :${g}`})].join(" AND ")))});const u=l.map(d=>"("+d+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(u).setParameters(c).execute()}}}class Cf extends Ee{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new R("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new R(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Ce.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new R('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Oc(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new R("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new R(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Ce.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new R('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Oc(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new R("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new R(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new kf(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!Ce.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new R("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class Ue{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,i)=>e.slice(i*t,i*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,i)=>{const a=t(i);let r=n.find(o=>o.id===a);return r||(r={id:a,items:[]},n.push(r)),r.items.push(i),n},[])}static uniq(e,t){return e.reduce((n,i)=>{let a=!1;if(typeof t=="function"){const r=t(i);a=!!n.find(o=>t(o)===r)}else typeof t=="string"?a=!!n.find(r=>r[t]===i[t]):a=n.indexOf(i)!==-1;return a||n.push(i),n},[])}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,i){if(i.has(n)){e[t]=i.get(n);return}if(!(n instanceof Promise)){if(!this.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),i.set(n,e[t]),this.merge(e[t],n,i),i.delete(n)}}static mergeObjectKey(e,t,n,i){if(i.has(n)){Object.assign(e,{[t]:i.get(n)});return}if(!(n instanceof Promise)){if(!this.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),i.set(n,e[t]),this.merge(e[t],n,i),i.delete(n)}}static merge(e,t,n=new Map){if(this.isPlainObject(e)&&this.isPlainObject(t))for(const i of Object.keys(t))i!=="__proto__"&&this.mergeObjectKey(e,i,t[i],n);if(Array.isArray(e)&&Array.isArray(t))for(let i=0;i<t.length;i++)this.mergeArrayKey(e,i,t[i],n)}static mergeDeep(e,...t){if(!t.length)return e;for(const n of t)Ue.merge(e,n);return e}static deepCompare(...e){let t,n,i,a;if(arguments.length<1)return!0;for(t=1,n=arguments.length;t<n;t++)if(i=[],a=[],!this.compare2Objects(i,a,arguments[0],arguments[t]))return!1;return!0}static deepValue(e,t){const n=t.split(".");for(let i=0,a=n.length;i<a;i++)e=e[n[i]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:this.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let n of e){const i=n.split(".");if(!i.length)continue;(!t[i[0]]||t[i[0]]===!0)&&(t[i[0]]={});let a=t[i[0]];for(let[r,o]of i.entries())r!==0&&(a[o]?a=a[o]:r===i.length-1?(a[o]={},a=null):(a[o]={},a=a[o]))}return this.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:Ue.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static zipObject(e,t){return e.reduce((n,i,a)=>(n[i]=t[a],n),{})}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.indexOf(n)!==-1)}static areMutuallyExclusive(...e){return!e.some(t=>{const n=e.filter(i=>i!==t);return t.some(i=>n.some(a=>a.includes(i)))})}static parseSqlCheckExpression(e,t){const n=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(n&&n.index){const i=e.substring(n.index+n[0].length);let a="",r="";const o=[];for(let c=0;c<i.length;c++){const l=i[c];switch(l){case",":a==""?(o.push(r),r=""):r+=l;break;case"'":a==l?i[c+1]===l?(r+=l,c+=1):a="":a=l;break;case")":if(a=="")return o.push(r),o;r+=l;break;default:a!=""&&(r+=l)}}}}static compare2Objects(e,t,n,i){let a;if(Number.isNaN(n)&&Number.isNaN(i)||n===i)return!0;if(n===null||i===null||n===void 0||i===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(i))return!0;if(typeof n=="function"&&typeof i=="function"||n instanceof Date&&i instanceof Date||n instanceof RegExp&&i instanceof RegExp||typeof n=="string"&&typeof i=="string"||typeof n=="number"&&typeof i=="number")return n.toString()===i.toString();if(!(typeof n=="object"&&typeof i=="object")||Object.prototype.isPrototypeOf.call(n,i)||Object.prototype.isPrototypeOf.call(i,n)||n.constructor!==i.constructor||n.prototype!==i.prototype||e.indexOf(n)>-1||t.indexOf(i)>-1)return!1;for(a in i)if(i.hasOwnProperty(a)!==n.hasOwnProperty(a)||typeof i[a]!=typeof n[a])return!1;for(a in n){if(i.hasOwnProperty(a)!==n.hasOwnProperty(a)||typeof i[a]!=typeof n[a])return!1;switch(typeof n[a]){case"object":case"function":if(e.push(n),t.push(i),!this.compare2Objects(e,t,n[a],i[a]))return!1;e.pop(),t.pop();break;default:if(n[a]!==i[a])return!1;break}}return!0}}class Af{constructor(e,t,n,i,a){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=i,this.queryRunner=a}transform(e,t){const n=this.group(e,t),i=[];return n.forEach(a=>{const r=this.transformRawResultsGroup(a,t);r!==void 0&&!Object.values(r).every(o=>o===null)&&i.push(r)}),i}group(e,t){const n=new Map,i=[];return t.metadata.tableType==="view"?i.push(...t.metadata.columns.map(a=>N.buildAlias(this.driver,void 0,t.name,a.databaseName))):i.push(...t.metadata.primaryColumns.map(a=>N.buildAlias(this.driver,void 0,t.name,a.databaseName))),e.forEach(a=>{const r=i.map(c=>{const l=a[c];return at.isBuffer(l)?l.toString("hex"):Ce.isObject(l)?JSON.stringify(l):l}).join("_"),o=n.get(r);o?o.push(a):n.set(r,[a])}),n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){const l=e.map(d=>d[N.buildAlias(this.driver,void 0,t.name,t.metadata.discriminatorColumn.databaseName)]),u=n.childEntityMetadatas.find(d=>typeof l.find(p=>p===d.discriminatorValue)<"u");u&&(n=u)}let i=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.expressionMap.options.indexOf("create-pojo")!==-1});const a=this.transformColumns(e,t,i,n),r=this.transformJoins(e,i,t,n),o=this.transformRelationIds(e,t,i,n),c=this.transformRelationCounts(e,t,i);if(a||n.primaryColumns.filter(l=>l.isVirtual===!1).length===0&&(r||o||c))return i}transformColumns(e,t,n,i){let a=!1;return i.columns.forEach(r=>{if(i.childEntityMetadatas.length>0&&i.childEntityMetadatas.findIndex(c=>c.target===r.target)!==-1)return;const o=e[0][N.buildAlias(this.driver,void 0,t.name,r.databaseName)];o===void 0||r.isVirtual||this.expressionMap.selects.find(c=>c.selection===t.name||c.selection===t.name+"."+r.propertyPath)&&(r.setEntityValue(n,this.driver.prepareHydratedValue(o,r)),o!==null&&(a=!0))}),a}transformJoins(e,t,n,i){let a=!1;return this.expressionMap.joinAttributes.forEach(r=>{if(!r.metadata||!r.isSelected||r.relation&&!i.relations.find(c=>c===r.relation))return;if(r.mapToProperty){if(r.mapToPropertyParentAlias!==n.name)return}else if(!r.relation||r.parentAlias!==n.name||r.relationPropertyPath!==r.relation.propertyPath)return;let o=this.transform(e,r.alias);o=r.isMany?o:o[0],o=!r.isMany&&o===void 0?null:o,o!==void 0&&(r.mapToPropertyPropertyName?t[r.mapToPropertyPropertyName]=o:r.relation.setEntityValue(t,o),a=!0)}),a}transformRelationIds(e,t,n,i){let a=!1;return this.rawRelationIdResults.forEach((r,o)=>{if(r.relationIdAttribute.parentAlias!==t.name)return;const c=r.relationIdAttribute.relation,l=this.createValueMapFromJoinColumns(c,r.relationIdAttribute.parentAlias,e);if(l==null)return;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(c,l),d=this.relationIdMaps[o][u]||[],p=r.relationIdAttribute.mapToPropertyPropertyPath.split("."),h=(m,y,f)=>{const g=m.shift();if(g&&m.length===0)return y[g]=f,y;if(g&&m.length>0)h(m,y[g],f);else return y};c.isOneToOne||c.isManyToOne?d[0]!==void 0&&(h(p,n,d[0]),a=!0):(h(p,n,d),a=a||d.length>0)}),a}transformRelationCounts(e,t,n){let i=!1;return this.rawRelationCountResults.filter(a=>a.relationCountAttribute.parentAlias===t.name).forEach(a=>{const r=a.relationCountAttribute.relation;let o;r.isOneToMany?o=r.inverseRelation.joinColumns[0].referencedColumn.databaseName:o=r.isOwning?r.joinColumns[0].referencedColumn.databaseName:r.inverseRelation.joinColumns[0].referencedColumn.databaseName;const c=e[0][N.buildAlias(this.driver,void 0,t.name,o)];c!=null&&(n[a.relationCountAttribute.mapToPropertyPropertyName]=0,a.results.filter(l=>l.parentId===c).forEach(l=>{n[a.relationCountAttribute.mapToPropertyPropertyName]=parseInt(l.cnt),i=!0}))}),i}createValueMapFromJoinColumns(e,t,n){let i;return e.isManyToOne||e.isOneToOneOwner?i=e.entityMetadata.primaryColumns.map(a=>a):e.isOneToMany||e.isOneToOneNotOwner?i=e.inverseRelation.joinColumns.map(a=>a):e.isOwning?i=e.joinColumns.map(a=>a):i=e.inverseRelation.inverseJoinColumns.map(a=>a),i.reduce((a,r)=>(n.forEach(o=>{e.isManyToOne||e.isOneToOneOwner?a[r.databaseName]=this.driver.prepareHydratedValue(o[N.buildAlias(this.driver,void 0,t,r.databaseName)],r):a[r.databaseName]=this.driver.prepareHydratedValue(o[N.buildAlias(this.driver,void 0,t,r.referencedColumn.databaseName)],r.referencedColumn)}),a),{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?n=e.joinColumns.map(i=>i):n=e.inverseRelation.inverseJoinColumns.map(i=>i),n.reduce((i,a)=>(i[a.databaseName]=t[a.databaseName],i),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((i,a)=>{let r=n.reduce((o,c)=>{let l=a[c.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(l=c.referencedColumn.createValueMap(l)),Ue.mergeDeep(o,c.createValueMap(l))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(l=c.referencedColumn.referencedColumn.createValueMap(l)),Ue.mergeDeep(o,c.referencedColumn.createValueMap(l)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?r=n[0].getEntityValue(r):r=n[0].referencedColumn.getEntityValue(r)),r!==void 0){const o=this.hashEntityIds(t,a);i[o]?i[o].push(r):i[o]=[r]}return i},{})}))}hashEntityIds(e,t){const n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}}let Pf=class{constructor(s,e,t){this.connection=s,this.queryRunner=e,this.relationIdAttributes=t}async load(s){const e=this.relationIdAttributes.map(async t=>{if(t.relation.isManyToOne||t.relation.isOneToOneOwner){if(t.queryBuilderFactory)throw new R("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const n={},i=s.map(a=>{const r={},o=[];t.relation.joinColumns.forEach(l=>{r[l.databaseName]=this.connection.driver.prepareHydratedValue(a[N.buildAlias(this.connection.driver,void 0,t.parentAlias,l.databaseName)],l.referencedColumn);const u=`${l.databaseName}:${r[l.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),t.relation.entityMetadata.primaryColumns.forEach(l=>{r[l.databaseName]=this.connection.driver.prepareHydratedValue(a[N.buildAlias(this.connection.driver,void 0,t.parentAlias,l.databaseName)],l);const u=`${l.databaseName}:${r[l.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),o.sort();const c=o.join("::");return n[c]?null:(n[c]=!0,r)}).filter(a=>a);return{relationIdAttribute:t,results:i}}else if(t.relation.isOneToMany||t.relation.isOneToOneNotOwner){const n=t.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.joinColumns,a=n.inverseEntityMetadata.target,r=n.inverseEntityMetadata.tableName,o=t.alias||r,c={},l={},u=s.map((h,m)=>{const y=[],f={},g=i.map(v=>{const E=v.databaseName+m,S=h[N.buildAlias(this.connection.driver,void 0,t.parentAlias,v.referencedColumn.databaseName)],A=`${o}:${v.propertyPath}:${S}`;return y.indexOf(A)!==-1?"":(y.push(A),f[E]=S,o+"."+v.propertyPath+" = :"+E)}).filter(v=>v).join(" AND ");y.sort();const b=y.join("::");return c[b]?"":(c[b]=!0,Object.assign(l,f),g)}).filter(h=>h).map(h=>"("+h+")").join(" OR ");if(!u)return{relationIdAttribute:t,results:[]};const d=this.connection.createQueryBuilder(this.queryRunner);Ue.uniq([...i,...n.inverseRelation.entityMetadata.primaryColumns],h=>h.propertyPath).forEach(h=>{d.addSelect(o+"."+h.propertyPath,h.databaseName)}),d.from(a,o).where("("+u+")").setParameters(l),t.queryBuilderFactory&&t.queryBuilderFactory(d);const p=await d.getRawMany();return p.forEach(h=>{i.forEach(m=>{h[m.databaseName]=this.connection.driver.prepareHydratedValue(h[m.databaseName],m.referencedColumn)}),n.inverseRelation.entityMetadata.primaryColumns.forEach(m=>{h[m.databaseName]=this.connection.driver.prepareHydratedValue(h[m.databaseName],m)})}),{relationIdAttribute:t,results:p}}else{const n=t.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.inverseJoinColumns,a=n.isOwning?n.inverseJoinColumns:n.inverseRelation.joinColumns,r=t.junctionAlias,o=t.joinInverseSideMetadata.tableName,c=t.alias||o,l=n.isOwning?n.junctionEntityMetadata.tableName:n.inverseRelation.junctionEntityMetadata.tableName,u=s.map(b=>i.reduce((v,E)=>(v[E.propertyPath]=b[N.buildAlias(this.connection.driver,void 0,t.parentAlias,E.referencedColumn.databaseName)],v),{}));if(u.length===0)return{relationIdAttribute:t,results:[]};const d={},p={},h=u.map((b,v)=>{const E=[],S={},A=Object.keys(b).map(H=>{const W=H+v,U=b[H],me=`${r}:${H}:${U}`;return E.indexOf(me)!==-1?"":(E.push(me),S[W]=U,r+"."+H+" = :"+W)}).filter(H=>H).join(" AND ");E.sort();const Q=E.join("::");return p[Q]?"":(p[Q]=!0,Object.assign(d,S),A)}).filter(b=>b),m=a.map(b=>r+"."+b.propertyPath+" = "+c+"."+b.referencedColumn.propertyPath).join(" AND "),y=h.map(b=>"("+b+" AND "+m+")").join(" OR "),f=this.connection.createQueryBuilder(this.queryRunner);a.forEach(b=>{f.addSelect(r+"."+b.propertyPath,b.databaseName).addOrderBy(r+"."+b.propertyPath)}),i.forEach(b=>{f.addSelect(r+"."+b.propertyPath,b.databaseName).addOrderBy(r+"."+b.propertyPath)}),f.from(o,c).innerJoin(l,r,y).setParameters(d),t.queryBuilderFactory&&t.queryBuilderFactory(f);const g=await f.getRawMany();return g.forEach(b=>{[...i,...a].forEach(v=>{b[v.databaseName]=this.connection.driver.prepareHydratedValue(b[v.databaseName],v.referencedColumn)})}),{relationIdAttribute:t,results:g}}});return Promise.all(e)}};class Sf{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,n){const i=Array.isArray(t)?t:[t],a=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,i,a):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,i,a):this.loadForOneToManyAndOneToOneNotOwner(e,i,a)}async loadManyToManyRelationIdsAndGroup(e,t,n,i){const a=e.isManyToMany||e.isOneToMany,r=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,this.queryRunner,i),!n.length))return r.map(d=>({entity:d,related:a?[]:void 0}));const o=await this.load(e,t,n),c=Array.isArray(n)?n:[n];let l=[],u=[];return e.isManyToManyOwner?(l=e.junctionEntityMetadata.inverseColumns.map(d=>d.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(d=>d.referencedColumn)):e.isManyToManyNotOwner?(l=e.junctionEntityMetadata.ownerColumns.map(d=>d.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(d=>d.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(l=e.joinColumns.map(d=>d.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(l=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(d=>d.referencedColumn)),r.map(d=>{const p={entity:d,related:a?[]:void 0},h=o.filter(m=>u.every(y=>y.compareEntityValue(d,m[y.entityMetadata.name+"_"+y.propertyAliasName])));return h.length&&c.forEach(m=>{h.forEach(y=>{l.every(f=>f.compareEntityValue(m,y[N.buildAlias(this.connection.driver,void 0,f.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+f.propertyPath.replace(".","_"))]))&&(a?p.related.push(m):p.related=m)})}),p})}loadForManyToMany(e,t,n){const i=e.junctionEntityMetadata,a=i.name,r=e.isOwning?i.ownerColumns:i.inverseColumns,o=e.isOwning?i.inverseColumns:i.ownerColumns,c=this.connection.createQueryBuilder(this.queryRunner);r.forEach(p=>{const h=N.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(a+"."+p.propertyPath,h)}),o.forEach(p=>{const h=N.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(a+"."+p.propertyPath,h)});let l="";if(r.length===1){const p=t.map(h=>r[0].referencedColumn.getEntityValue(h));p.every(h=>typeof h=="number")?l=`${a}.${r[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values1",p),l=a+"."+r[0].propertyPath+" IN (:...values1)")}else l="("+t.map((p,h)=>r.map(m=>{const y="entity1_"+h+"_"+m.propertyName;return c.setParameter(y,m.referencedColumn.getEntityValue(p)),a+"."+m.propertyPath+" = :"+y}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";let u="";if(n)if(o.length===1){const p=n.map(h=>o[0].referencedColumn.getEntityValue(h));p.every(h=>typeof h=="number")?u=`${a}.${o[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values2",p),u=a+"."+o[0].propertyPath+" IN (:...values2)")}else u="("+n.map((p,h)=>o.map(m=>{const y="entity2_"+h+"_"+m.propertyName;return c.setParameter(y,m.referencedColumn.getEntityValue(p)),a+"."+m.propertyPath+" = :"+y}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";const d=[l,u].filter(p=>p.length>0).join(" AND ");return c.from(i.target,a).where(d).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){const i=e.entityMetadata.targetName,a=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(l=>l===c));if(n&&a){let c=[];if(t.forEach(l=>{let u={};e.entityMetadata.primaryColumns.forEach(d=>{const p=d.entityMetadata.name+"_"+d.propertyPath.replace(".","_");u[p]=d.getEntityValue(l)}),n.forEach(d=>{e.joinColumns.forEach(p=>{const h=p.getEntityValue(l),m=p.referencedColumn.getEntityValue(d);if(!(h===void 0||m===void 0)&&h===m){const y=p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_");u[y]=m}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(u)}),c.length===t.length)return Promise.resolve(c)}const r=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{const l=N.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));r.addSelect(i+"."+c.propertyPath,l)}),e.joinColumns.forEach(c=>{const l=N.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));r.addSelect(i+"."+c.propertyPath,l)});let o="";if(e.entityMetadata.primaryColumns.length===1){const c=t.map(l=>e.entityMetadata.primaryColumns[0].getEntityValue(l));c.every(l=>typeof l=="number")?o=`${i}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(r.setParameter("values",c),o=i+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else o=t.map((c,l)=>e.entityMetadata.primaryColumns.map((u,d)=>{const p="entity"+l+"_"+d;return r.setParameter(p,u.getEntityValue(c)),i+"."+u.propertyPath+" = :"+p}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return r.from(e.entityMetadata.target,i).where(o).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(o=>e.joinColumns.indexOf(o)!==-1))return Promise.resolve(t.map(o=>{const c={};return e.joinColumns.forEach(function(l){const u=l.referencedColumn.getEntityValue(o),d=l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"),p=l.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_");c[d]=u,c[p]=u}),c}));const i=e.entityMetadata.targetName,a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=N.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));a.addSelect(i+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=N.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));a.addSelect(i+"."+o.propertyPath,c)});let r="";if(e.joinColumns.length===1){const o=t.map(c=>e.joinColumns[0].referencedColumn.getEntityValue(c));o.every(c=>typeof c=="number")?r=`${i}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(a.setParameter("values",o),r=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else r=t.map((o,c)=>e.joinColumns.map((l,u)=>{const d="entity"+c+"_"+u;return a.setParameter(d,l.referencedColumn.getEntityValue(o)),i+"."+l.propertyPath+" = :"+d}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return a.from(e.entityMetadata.target,i).where(r).getRawMany()}}class Tf{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new Ha(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Nf{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){const t=(i,a,r)=>r.indexOf(i)===a,n=this.relationCountAttributes.map(async i=>{if(i.relation.isOneToMany){const a=i.relation,r=a.inverseRelation,o=r.joinColumns[0].referencedColumn.propertyName,c=a.inverseEntityMetadata.target,l=a.inverseEntityMetadata.tableName,u=i.alias||l,d=r.propertyName;let p=e.map(m=>m[i.parentAlias+"_"+o]).filter(m=>!!m);if(p=p.filter(t),p.length===0)return{relationCountAttribute:i,results:[]};const h=this.connection.createQueryBuilder(this.queryRunner);return h.select(u+"."+d,"parentId").addSelect("COUNT(*)","cnt").from(c,u).where(u+"."+d+" IN (:...ids)").addGroupBy(u+"."+d).setParameter("ids",p),i.queryBuilderFactory&&i.queryBuilderFactory(h),{relationCountAttribute:i,results:await h.getRawMany()}}else{let a,r,o,c;i.relation.isOwning?(a=i.relation.joinColumns[0].referencedColumn.databaseName,r=i.relation.inverseJoinColumns[0].referencedColumn.databaseName,o=i.relation.junctionEntityMetadata.columns[0],c=i.relation.junctionEntityMetadata.columns[1]):(a=i.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,r=i.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,o=i.relation.junctionEntityMetadata.columns[1],c=i.relation.junctionEntityMetadata.columns[0]);let l=e.map(f=>f[i.parentAlias+"_"+a]).filter(f=>!!f);if(l=l.filter(t),l.length===0)return{relationCountAttribute:i,results:[]};const u=i.junctionAlias,d=i.joinInverseSideMetadata.tableName,p=i.alias||d,h=i.relation.junctionEntityMetadata.tableName,m=u+"."+o.propertyName+" IN ("+l.map(f=>isNaN(f)?"'"+f+"'":f)+") AND "+u+"."+c.propertyName+" = "+p+"."+r,y=this.connection.createQueryBuilder(this.queryRunner);return y.select(u+"."+o.propertyName,"parentId").addSelect("COUNT("+y.escape(p)+"."+y.escape(r)+")","cnt").from(d,p).innerJoin(h,u,m).addGroupBy(u+"."+o.propertyName),i.queryBuilderFactory&&i.queryBuilderFactory(y),{relationCountAttribute:i,results:await y.getRawMany()}}});return Promise.all(n)}}class jf{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new Ja(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class er{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t!=null&&t.relations){const n=[...t.relations];if(er.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new sf(n)}return e}static applyRelationsRecursively(e,t,n,i,a){let r=[];if(a){const o=new RegExp("^"+a.replace(".","\\.")+"\\.");r=t.filter(c=>c.match(o)).map(c=>i.findRelationWithPropertyPath(c.replace(o,""))).filter(c=>c)}else r=t.map(o=>i.findRelationWithPropertyPath(o)).filter(o=>o);r.forEach(o=>{let c=N.buildAlias(e.connection.driver,{joiner:"__"},n,o.propertyPath);const l=n+"."+o.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(o):e.leftJoinAndSelect(l,c),t.splice(t.indexOf(a?a+"."+o.propertyPath:o.propertyPath),1);let u,d;if(e.expressionMap.relationLoadStrategy==="query")u=o.inverseEntityMetadata,d=c;else{const p=e.expressionMap.joinAttributes.find(h=>h.entityOrProperty===l);u=p.metadata,d=p.alias.name}if(!d||!u)throw new Lt(o.propertyPath,i);if(this.applyRelationsRecursively(e,t,d,u,a?a+"."+o.propertyPath:o.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const p=i.relations.find(h=>h.propertyName===o.propertyPath);p&&this.joinEagerRelations(e,c,p.inverseEntityMetadata)}})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(i=>{let a=N.buildAlias(e.connection.driver,{joiner:"__"},t,i.propertyName),r=!0;for(const l of e.expressionMap.joinAttributes)if(!(l.condition!==void 0||l.mapToProperty!==void 0||l.isMappingMany!==void 0||l.direction!=="LEFT"||l.entityOrProperty!==`${t}.${i.propertyPath}`)){r=!1,a=l.alias.name;break}const o=!!e.expressionMap.joinAttributes.find(l=>l.alias.name===a);r&&!o&&e.leftJoin(t+"."+i.propertyPath,a);let c=!0;for(const l of e.expressionMap.selects)if(!(l.aliasName!==void 0||l.virtual!==void 0||l.selection!==a)){c=!1;break}c&&e.addSelect(a),this.joinEagerRelations(e,a,i.inverseEntityMetadata)})}}class tr extends Ee{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,i){return this.join("INNER",e,t,n,i),this}leftJoin(e,t,n,i){return this.join("LEFT",e,t,n,i),this}innerJoinAndSelect(e,t,n,i){return this.addSelect(t),this.innerJoin(e,t,n,i),this}leftJoinAndSelect(e,t,n,i){return this.addSelect(t),this.leftJoin(e,t,n,i),this}innerJoinAndMapMany(e,t,n,i,a){return this.addSelect(n),this.join("INNER",t,n,i,a,e,!0),this}innerJoinAndMapOne(e,t,n,i,a,r){return this.addSelect(n),this.join("INNER",t,n,i,a,e,!1,r),this}leftJoinAndMapMany(e,t,n,i,a){return this.addSelect(n),this.join("LEFT",t,n,i,a,e,!0),this}leftJoinAndMapOne(e,t,n,i,a,r){return this.addSelect(n),this.join("LEFT",t,n,i,a,e,!1,r),this}loadRelationIdAndMap(e,t,n,i){const a=new Ha(this.expressionMap);return a.mapToProperty=e,a.relationName=t,typeof n=="string"&&(a.alias=n),typeof n=="object"&&n.disableMixedMap&&(a.disableMixedMap=!0),a.queryBuilderFactory=i,this.expressionMap.relationIdAttributes.push(a),a.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:a.junctionAlias,metadata:a.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,i){const a=new Ja(this.expressionMap);return a.mapToProperty=e,a.relationName=t,a.alias=n,a.queryBuilderFactory=i,this.expressionMap.relationCountAttributes.push(a),this.expressionMap.createAlias({type:"other",name:a.junctionAlias}),a.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:a.junctionAlias,metadata:a.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new R('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new R('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new R('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new R('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new R('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new R('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new R('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new R('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new En;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const e=(await this.getRawAndEntities()).entities[0];if(e&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const t=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const n=t.updateDateColumn.getEntityValue(e);if(n.getTime()!==this.expressionMap.lockVersion.getTime())throw new nc(t.name,this.expressionMap.lockVersion,n)}else{const n=t.versionColumn.getEntityValue(e);if(n!==this.expressionMap.lockVersion)throw new nc(t.name,this.expressionMap.lockVersion,n)}}return e===void 0?null:e}async getOneOrFail(){const e=await this.getOne();if(!e)throw new Xm(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new En;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new En;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new En;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new En;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;const i=this.expressionMap.cacheId;this.expressionMap.cacheId=i&&`${i}-count`;const a=await this.executeCountQuery(e),r=[n.entities,a];return t&&await e.commitTransaction(),r}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0);const a=()=>{if(n!==this.queryRunner)return n.release()},r=n.stream(e,t,a,a);return i&&await n.commitTransaction(),r}catch(a){if(i)try{await n.rollbackTransaction()}catch{}throw a}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,i,a,r,o,c){a&&this.setParameters(a);const l=new bc(this.connection,this.expressionMap);l.direction=e,l.mapAsEntity=c,l.mapToProperty=r,l.isMappingMany=o,l.entityOrProperty=t,l.condition=i,this.expressionMap.joinAttributes.push(l);const u=l.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const d=`${n}.${u.deleteDateColumn.propertyName} IS NULL`;l.condition=l.condition?` ${l.condition} AND ${d}`:`${d}`}l.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:u}),l.relation&&l.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:l.junctionAlias,metadata:l.relation.junctionEntityMetadata})}else{let d="";if(typeof t=="function"){const h=t(this.subQuery());this.setParameters(h.getParameters()),d=h.getQuery()}else d=t;const p=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";l.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:p===!1?t:void 0,subQuery:p===!0?d:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new R("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const o=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,o)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,o))}this.expressionMap.joinAttributes.forEach(o=>{if(o.metadata)e.push(...this.buildEscapedEntityColumnSelects(o.alias.name,o.metadata)),t.push(...this.findEntityColumnSelects(o.alias.name,o.metadata));else if(this.expressionMap.selects.some(c=>c.selection===o.alias.name)){e.push({selection:this.escape(o.alias.name)+".*"});const c=this.expressionMap.selects.find(l=>l.selection===o.alias.name);t.push(c)}}),this.expressionMap.selects.filter(o=>t.indexOf(o)===-1).forEach(o=>e.push({selection:this.replacePropertyNames(o.selection),aliasName:o.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&N.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);const i=this.expressionMap.aliases.filter(o=>o.type==="from"&&(o.tablePath||o.subQuery)).map(o=>o.subQuery?o.subQuery+" "+this.escape(o.name):this.getTableName(o.tablePath)+" "+this.escape(o.name)),a=this.createSelectDistinctExpression(),r=e.map(o=>o.selection+(o.aliasName?" AS "+this.escape(o.aliasName):"")).join(", ");return a+r+" FROM "+i.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:i}=this.connection;let a="SELECT ";return n>0&&N.isMySQLFamily(i)&&(a+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),N.isPostgresFamily(i)&&t.length>0?a=`SELECT DISTINCT ON (${t.map(r=>this.replacePropertyNames(r)).join(", ")}) `:e&&(a="SELECT DISTINCT "),a}createJoinExpression(){return this.expressionMap.joinAttributes.map(e=>{const t=e.relation,n=e.tablePath,i=e.alias.name;let a=e.condition?" AND ("+e.condition+")":"";const r=e.parentAlias;if(!r||!t){const o=e.alias.subQuery?e.alias.subQuery:this.getTableName(n);return" "+e.direction+" JOIN "+o+" "+this.escape(i)+this.createTableLockExpression()+(e.condition?" ON "+this.replacePropertyNames(e.condition):"")}if(t.isManyToOne||t.isOneToOneOwner){const o=t.joinColumns.map(c=>i+"."+c.referencedColumn.propertyPath+"="+r+"."+t.propertyPath+"."+c.referencedColumn.propertyPath).join(" AND ");return" "+e.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+a)}else if(t.isOneToMany||t.isOneToOneNotOwner){const o=t.inverseRelation.joinColumns.map(c=>(t.inverseEntityMetadata.tableType==="entity-child"&&t.inverseEntityMetadata.discriminatorColumn&&(a+=" AND "+i+"."+t.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+t.inverseEntityMetadata.discriminatorValue+"'"),i+"."+t.inverseRelation.propertyPath+"."+c.referencedColumn.propertyPath+"="+r+"."+c.referencedColumn.propertyPath)).join(" AND ");if(!o)throw new R(`Relation ${t.entityMetadata.name}.${t.propertyName} does not have join columns.`);return" "+e.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+a)}else{const o=t.junctionEntityMetadata.tablePath,c=e.junctionAlias;let l="",u="";return t.isOwning?(l=t.joinColumns.map(d=>c+"."+d.propertyPath+"="+r+"."+d.referencedColumn.propertyPath).join(" AND "),u=t.inverseJoinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+c+"."+d.propertyPath).join(" AND ")):(l=t.inverseRelation.inverseJoinColumns.map(d=>c+"."+d.propertyPath+"="+r+"."+d.referencedColumn.propertyPath).join(" AND "),u=t.inverseRelation.joinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+c+"."+d.propertyPath).join(" AND "))," "+e.direction+" JOIN "+this.getTableName(o)+" "+this.escape(c)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l)+" "+e.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u+a)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const n=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,i=this.expressionMap.selects.find(a=>a.selection===t);if(i&&!i.aliasName&&t.indexOf(".")!==-1){const a=t.split("."),r=a[0],o=a.slice(1).join("."),c=this.expressionMap.aliases.find(l=>l.name===r);if(c){const l=c.metadata.findColumnWithPropertyPath(o);if(l){const u=N.buildAlias(this.connection.driver,void 0,r,l.databaseName);return this.escape(u)+" "+n}}}return this.replacePropertyNames(t)+" "+n}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;if(!e&&!t&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take),this.connection.driver.options.type==="mssql"){let n="";if((t||e)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(n=" ORDER BY (SELECT NULL)"),t&&e)return n+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return n+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(e)return n+" OFFSET "+e+" ROWS"}else if(N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)throw new af}else if(N.isSQLiteFamily(this.connection.driver)){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(t&&e)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return" FETCH NEXT "+t+" ROWS ONLY";if(e)return" OFFSET "+e+" ROWS"}else{if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(N.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new R("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new R("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return N.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(N.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new qs;case"pessimistic_write":if(N.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(N.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new qs;case"pessimistic_partial_write":if(N.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(N.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new qs;case"pessimistic_write_or_fail":if(N.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(N.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new qs;case"for_no_key_update":if(N.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new qs;case"for_key_share":if(N.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new qs;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const n=this.expressionMap.selects.some(l=>l.selection===e),i=[];if(n&&i.push(...t.columns.filter(l=>l.isSelect===!0)),i.push(...t.columns.filter(l=>this.expressionMap.selects.some(u=>u.selection===e+"."+l.propertyPath))),i.length===0)return[];const a=this.expressionMap.queryEntity?t.primaryColumns.filter(l=>i.indexOf(l)===-1):[],r=[...i,...a],o=[],c=this.escape(e);return r.forEach(l=>{let u=c+"."+this.escape(l.databaseName);l.isVirtualProperty&&l.query&&(u=`(${l.query(c)})`),this.connection.driver.spatialTypes.indexOf(l.type)!==-1&&((N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),N.isPostgresFamily(this.connection.driver)&&(l.precision?u=`ST_AsGeoJSON(${u}, ${l.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const d=this.expressionMap.selects.filter(p=>p.selection===e+"."+l.propertyPath);if(d.length)d.forEach(p=>{o.push({selection:u,aliasName:p.aliasName?p.aliasName:N.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:p.virtual})});else{if(l.isVirtualProperty)return;o.push({selection:u,aliasName:N.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:n})}}),o}findEntityColumnSelects(e,t){const n=this.expressionMap.selects.find(i=>i.selection===e);return n?[n]:this.expressionMap.selects.filter(i=>t.columns.some(a=>i.selection===e+"."+a.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,t=this.expressionMap.mainAlias.metadata.primaryColumns,n=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||N.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+t.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+"))";if(N.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+t.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const i=t.map(a=>`${n}.${this.escape(a.databaseName)}`).join(", '|;|', ");return t.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?t.length===1?`COUNT(DISTINCT(${n}.${this.escape(t[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${t.map(i=>`CAST(${n}.${this.escape(i.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+t.map(i=>`${n}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?Ue.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?Ue.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const n=this.expressionMap.aliases.find(i=>i.metadata.tableNameWithoutPrefix===t);if(!n)throw new R(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&er.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new R('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new nf;if(this.expressionMap.lockMode==="optimistic"){const r=this.expressionMap.mainAlias.metadata;if(!r.versionColumn&&!r.updateDateColumn)throw new ef(r.name)}const t=new Pf(this.connection,e,this.expressionMap.relationIdAttributes),n=new Nf(this.connection,e,this.expressionMap.relationCountAttributes);new Tf(this.expressionMap).transform(),new jf(this.expressionMap).transform();let i=[],a=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[r,o]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),c=this.expressionMap.mainAlias.metadata,l=this.expressionMap.mainAlias.name,u=c.primaryColumns.map(h=>{const m=this.escape("distinctAlias"),y=this.escape(N.buildAlias(this.connection.driver,void 0,l,h.databaseName));o[y]||(o[y]="ASC");const f=N.buildAlias(this.connection.driver,void 0,"ids_"+l,h.databaseName);return`${m}.${y} AS ${this.escape(f)}`}),d=this.clone(),p=d.expressionMap.timeTravel;if(i=await new tr(this.connection,e).select(`DISTINCT ${u.join(", ")}`).addSelect(r).from(`(${d.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(p).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(o).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),i.length>0){let h="";const m={};if(c.hasMultiplePrimaryKeys)h=i.map((y,f)=>c.primaryColumns.map(g=>{const b=`orm_distinct_ids_${f}_${g.databaseName}`,v=N.buildAlias(this.connection.driver,void 0,"ids_"+l,g.databaseName);return m[b]=y[v],`${l}.${g.propertyPath}=:${b}`}).join(" AND ")).join(" OR ");else{const y=N.buildAlias(this.connection.driver,void 0,"ids_"+l,c.primaryColumns[0].databaseName),f=i.map(g=>g[y]);f.every(g=>typeof g=="number")?h=`${l}.${c.primaryColumns[0].propertyPath} IN (${f.join(", ")})`:(m.orm_distinct_ids=f,h=l+"."+c.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}i=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:h}).setParameters(m).loadRawResults(e)}}else i=await this.loadRawResults(e);if(i.length>0){const r=await t.load(i),o=await n.load(i);a=new Af(this.expressionMap,this.connection.driver,r,o,this.queryRunner).transform(i,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,a)}if(this.expressionMap.relationLoadStrategy==="query"){const r=new Sf(this.connection,e);await Promise.all(this.relationMetadatas.map(async o=>{const c=o.inverseEntityMetadata.target,l=o.inverseEntityMetadata.targetName,u=Array.isArray(this.findOptions.select)?Ue.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,d=Array.isArray(this.findOptions.relations)?Ue.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,p=this.createQueryBuilder(e).select(l).from(c,l).setFindOptions({select:u?Ue.deepValue(u,o.propertyPath):void 0,order:this.findOptions.order?Ue.deepValue(this.findOptions.order,o.propertyPath):void 0,relations:d?Ue.deepValue(d,o.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(a.length>0){const h=await r.loadManyToManyRelationIdsAndGroup(o,a,void 0,p);a.forEach(m=>{const y=h.find(f=>f.entity===m);if(y){const f=y.related===void 0?null:y.related;o.setEntityValue(m,f)}})}}))}return{raw:i,entities:a}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,n=Object.keys(t).map(a=>{if(a.indexOf(".")!==-1){const r=a.split("."),o=r[0],c=r.slice(1).join("."),l=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(N.buildAlias(this.connection.driver,void 0,o,l.databaseName))}else return this.expressionMap.selects.find(r=>r.selection===a||r.aliasName===a)?this.escape(e)+"."+this.escape(a):""}).join(", "),i={};return Object.keys(t).forEach(a=>{if(a.indexOf(".")!==-1){const r=a.split("."),o=r[0],c=r.slice(1).join("."),l=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);i[this.escape(e)+"."+this.escape(N.buildAlias(this.connection.driver,void 0,o,l.databaseName))]=t[a]}else this.expressionMap.selects.find(r=>r.selection===a||r.aliasName===a)?i[this.escape(e)+"."+this.escape(a)]=t[a]:i[a]=t[a]}),[n,i]}async loadRawResults(e){const[t,n]=this.getQueryAndParameters(),i=t+" -- PARAMETERS: "+JSON.stringify(n,(u,d)=>typeof d=="bigint"?d.toString():d),a=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let r;const o=a.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let c=!1;if(this.connection.queryResultCache&&o)try{if(r=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:i,duration:this.expressionMap.cacheDuration||a.duration||1e3},e),r&&!this.connection.queryResultCache.isExpired(r))return JSON.parse(r.result)}catch(u){if(!a.ignoreErrors)throw u;c=!0}const l=await e.query(t,n,!0);if(!c&&this.connection.queryResultCache&&o)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:i,time:new Date().getTime(),duration:this.expressionMap.cacheDuration||a.duration||1e3,result:JSON.stringify(l.records)},r,e)}catch(u){if(!a.ignoreErrors)throw u}return l.records}mergeExpressionMap(e){return Ce.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,n,i){for(let a in e){if(e[a]===void 0||e[a]===!1)continue;const r=i?i+"."+a:a,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new Lt(r,t);o?this.selects.push(n+"."+r):c&&this.buildSelect(e[a],t,n,r)}}buildRelations(e,t,n,i,a){e&&Object.keys(e).forEach(r=>{const o=e[r],c=a?a+"."+r:r,l=n.findEmbeddedWithPropertyPath(c),u=n.findRelationWithPropertyPath(c);if(!l&&!u)throw new Lt(c,n);if(l)this.buildRelations(o,typeof t=="object"?Ue.deepValue(t,l.propertyPath):void 0,n,i,c);else if(u){let d=i+"_"+c.replace(".","_");d=N.buildAlias(this.connection.driver,{joiner:"__"},i,d),(o===!0||typeof o=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[r]=="object"?t[r]:void 0,alias:d,parentAlias:i,relationMetadata:u}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,d))),typeof o=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(o,typeof t=="object"?Ue.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,d,void 0)}})}buildEagerRelations(e,t,n,i,a){e&&Object.keys(e).forEach(r=>{const o=e[r],c=a?a+"."+r:r,l=n.findEmbeddedWithPropertyPath(c),u=n.findRelationWithPropertyPath(c);if(!l&&!u)throw new Lt(c,n);if(l)this.buildEagerRelations(o,typeof t=="object"?Ue.deepValue(t,l.propertyPath):void 0,n,i,c);else if(u){let d=i+"_"+c.replace(".","_");d=N.buildAlias(this.connection.driver,{joiner:"__"},i,d),(o===!0||typeof o=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(p=>{let h=d+"_"+p.propertyPath.replace(".","_");h=N.buildAlias(this.connection.driver,{joiner:"__"},d,h),this.joins.find(m=>m.alias===h)||this.joins.push({type:"left",select:!0,alias:h,parentAlias:d,selection:void 0,relationMetadata:p}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,d)}),typeof o=="object"&&this.buildEagerRelations(o,typeof t=="object"?Ue.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,d,void 0)}})}buildOrder(e,t,n,i){for(let a in e){if(e[a]===void 0)continue;const r=i?i+"."+a:a,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new Lt(r,t);if(o){let u=typeof e[a]=="object"?e[a].direction:e[a];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let d=typeof e[a]=="object"?e[a].nulls:void 0;d=(d==null?void 0:d.toLowerCase())==="first"?"NULLS FIRST":(d==null?void 0:d.toLowerCase())==="last"?"NULLS LAST":void 0;let p=`${n}.${r}`;this.addOrderBy(p,u,d)}else if(c)this.buildOrder(e[a],t,n,r);else if(l){let u=n+"_"+r.replace(".","_");u=N.buildAlias(this.connection.driver,{joiner:"__"},n,u),this.joins.find(d=>d.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:n,selection:void 0,relationMetadata:l}),this.buildOrder(e[a],l.inverseEntityMetadata,u)}}}buildWhere(e,t,n,i){let a="";if(Array.isArray(e))e.length&&(a=e.map(r=>this.buildWhere(r,t,n,i)).filter(r=>!!r).map(r=>"("+r+")").join(" OR "));else{let r=[];for(let o in e){if(e[o]===void 0||e[o]===null)continue;const c=i?i+"."+o:o,l=t.findColumnWithPropertyPathStrict(c),u=t.findEmbeddedWithPropertyPath(c),d=t.findRelationWithPropertyPath(c);if(!u&&!l&&!d)throw new Lt(c,t);if(l){let p=`${n}.${c}`;l.isVirtualProperty&&l.query&&(p=`(${l.query(n)})`);let h=e[o];ye.isEqualOperator(e[o])&&(h=e[o].value),l.transformer&&(h instanceof Mn?h.transformValue(l.transformer):h=Xa.transformTo(l.transformer,h)),r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(p,h)))}else if(u){const p=this.buildWhere(e[o],t,n,c);p&&r.push(p)}else if(d){if(typeof e[o]=="object"&&Object.keys(e[o]).every(p=>e[o][p]===void 0))continue;if(ye.isFindOperator(e[o]))if(e[o].type==="moreThan"||e[o].type==="lessThan"||e[o].type==="moreThanOrEqual"||e[o].type==="lessThanOrEqual"){let p="";e[o].type==="moreThan"?p=">":e[o].type==="lessThan"?p="<":e[o].type==="moreThanOrEqual"?p=">=":e[o].type==="lessThanOrEqual"&&(p="<=");const h=this.subQuery();if(d.isManyToManyOwner)h.select("COUNT(*)").from(d.joinTableName,d.joinTableName).where(d.joinColumns.map(m=>`${d.joinTableName}.${m.propertyName} = ${n}.${m.referencedColumn.propertyName}`).join(" AND "));else if(d.isManyToManyNotOwner)h.select("COUNT(*)").from(d.inverseRelation.joinTableName,d.inverseRelation.joinTableName).where(d.inverseRelation.inverseJoinColumns.map(m=>`${d.inverseRelation.joinTableName}.${m.propertyName} = ${n}.${m.referencedColumn.propertyName}`).join(" AND "));else if(d.isOneToMany)h.select("COUNT(*)").from(d.inverseEntityMetadata.target,d.inverseEntityMetadata.tableName).where(d.inverseRelation.joinColumns.map(m=>`${d.inverseEntityMetadata.tableName}.${m.propertyName} = ${n}.${m.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(h.getSql()+" "+p+" "+parseInt(e[o].value))}else if(d.isManyToOne||d.isOneToOne&&d.isOneToOneOwner){const p=`${n}.${c}`;r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(p,e[o])))}else throw new Error("This relation isn't supported by given find operator");else{let p=n+"_"+d.propertyPath.replace(".","_");p=N.buildAlias(this.connection.driver,{joiner:"__"},n,p),this.joins.find(m=>m.alias===p)||this.joins.push({type:"left",select:!1,selection:void 0,alias:p,parentAlias:n,relationMetadata:d});const h=this.buildWhere(e[o],d.inverseEntityMetadata,p);h&&r.push(h)}}}a=r.length?"("+r.join(") AND (")+")":r.join(" AND ")}return a.length?"("+a+")":a}}class Ec{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class Rf extends Ee{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const n=new Ya(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=n.getSoftDeletionReturningColumns());const[i,a]=this.getQueryAndParameters(),r=await e.query(i,a,!0),o=Ec.from(r);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await n.update(o,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),o}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=ye.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new yi;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new R(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new R("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new R(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new Ym(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new R('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new qa;const n=this.createWhereExpression(),i=this.createReturningExpression("update");return i===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${i}${n}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n} RETURNING ${i}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(N.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new ic}return""}}class If extends Ee{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let n=null,i=null;const a=new Ya(e,this.expressionMap),r=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const p of this.expressionMap.returning)r.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(p));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=a.getUpdationReturningColumns(),r.push(...this.expressionMap.extraReturningColumns.filter(p=>!r.includes(p)))),r.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",r),i="SELECT * FROM @OutputTable");const[o,c]=this.getQueryAndParameters(),l=[n,o,i],u=await e.query(l.filter(p=>p!=null).join(`;

`),c,!0),d=Ec.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await a.update(d,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),d}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new yi;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new R(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new R("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,n={};for(let c in e)e[c]!==void 0&&(n[c]=e[c]);const i=[],a=[];if(t?(this.createPropertyPath(t,n).forEach(c=>{const l=t.findColumnsWithPropertyPath(c);if(l.length<=0)throw new Lt(c,t);l.forEach(u=>{if(!u.isUpdate||a.includes(u))return;a.push(u);let d=u.getEntityValue(n);if(u.referencedColumn&&typeof d=="object"&&!(d instanceof Date)&&d!==null&&!at.isBuffer(d)?d=u.referencedColumn.getEntityValue(d):typeof d!="function"&&(d=this.connection.driver.preparePersistentValue(d,u)),typeof d=="function")i.push(this.escape(u.databaseName)+" = "+d());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&d===null)i.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(d=this.connection.driver.parametrizeValue(u,d));const p=this.createParameter(d);let h=null;if((N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const m=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?h=`${m}(${p}, ${u.srid})`:h=`${m}(${p})`}else N.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?h=`ST_SetSRID(ST_GeomFromGeoJSON(${p}), ${u.srid})::${u.type}`:h=`ST_GeomFromGeoJSON(${p})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?h=u.type+"::STGeomFromText("+p+", "+(u.srid||"0")+")":h=p;i.push(this.escape(u.databaseName)+" = "+h)}})}),(i.length>0||Object.keys(n).length===0)&&(t.versionColumn&&a.indexOf(t.versionColumn)===-1&&i.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&a.indexOf(t.updateDateColumn)===-1&&i.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(n).map(c=>{let l=n[c];if(typeof l=="function")i.push(this.escape(c)+" = "+l());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&l===null)i.push(this.escape(c)+" = NULL");else{const u=this.createParameter(l);i.push(this.escape(c)+" = "+u)}}),i.length<=0)throw new qa;const r=this.createWhereExpression(),o=this.createReturningExpression("update");return o===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")} OUTPUT ${o}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${r} RETURNING ${o}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(N.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new ic}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new qa}}function $f(){Ee.registerQueryBuilderClass("DeleteQueryBuilder",s=>new _f(s)),Ee.registerQueryBuilderClass("InsertQueryBuilder",s=>new Mf(s)),Ee.registerQueryBuilderClass("RelationQueryBuilder",s=>new Cf(s)),Ee.registerQueryBuilderClass("SelectQueryBuilder",s=>new tr(s)),Ee.registerQueryBuilderClass("SoftDeleteQueryBuilder",s=>new Rf(s)),Ee.registerQueryBuilderClass("UpdateQueryBuilder",s=>new If(s))}var Mc;(function(s){s.VIEW="VIEW",s.MATERIALIZED_VIEW="MATERIALIZED_VIEW",s.GENERATED_COLUMN="GENERATED_COLUMN"})(Mc||(Mc={}));var sr={exports:{}},nr,kc;function Lf(){if(kc)return nr;kc=1;var s=1e3,e=s*60,t=e*60,n=t*24,i=n*7,a=n*365.25;nr=function(u,d){d=d||{};var p=typeof u;if(p==="string"&&u.length>0)return r(u);if(p==="number"&&isFinite(u))return d.long?c(u):o(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function r(u){if(u=String(u),!(u.length>100)){var d=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(d){var p=parseFloat(d[1]),h=(d[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return p*a;case"weeks":case"week":case"w":return p*i;case"days":case"day":case"d":return p*n;case"hours":case"hour":case"hrs":case"hr":case"h":return p*t;case"minutes":case"minute":case"mins":case"min":case"m":return p*e;case"seconds":case"second":case"secs":case"sec":case"s":return p*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function o(u){var d=Math.abs(u);return d>=n?Math.round(u/n)+"d":d>=t?Math.round(u/t)+"h":d>=e?Math.round(u/e)+"m":d>=s?Math.round(u/s)+"s":u+"ms"}function c(u){var d=Math.abs(u);return d>=n?l(u,d,n,"day"):d>=t?l(u,d,t,"hour"):d>=e?l(u,d,e,"minute"):d>=s?l(u,d,s,"second"):u+" ms"}function l(u,d,p,h){var m=d>=p*1.5;return Math.round(u/p)+" "+h+(m?"s":"")}return nr}var ir,Cc;function Bf(){if(Cc)return ir;Cc=1;function s(e){n.debug=n,n.default=n,n.coerce=l,n.disable=r,n.enable=a,n.enabled=o,n.humanize=Lf(),n.destroy=u,Object.keys(e).forEach(d=>{n[d]=e[d]}),n.names=[],n.skips=[],n.formatters={};function t(d){let p=0;for(let h=0;h<d.length;h++)p=(p<<5)-p+d.charCodeAt(h),p|=0;return n.colors[Math.abs(p)%n.colors.length]}n.selectColor=t;function n(d){let p,h=null,m,y;function f(...g){if(!f.enabled)return;const b=f,v=Number(new Date),E=v-(p||v);b.diff=E,b.prev=p,b.curr=v,p=v,g[0]=n.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let S=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(A,Q)=>{if(A==="%%")return"%";S++;const H=n.formatters[Q];if(typeof H=="function"){const W=g[S];A=H.call(b,W),g.splice(S,1),S--}return A}),n.formatArgs.call(b,g),(b.log||n.log).apply(b,g)}return f.namespace=d,f.useColors=n.useColors(),f.color=n.selectColor(d),f.extend=i,f.destroy=n.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(m!==n.namespaces&&(m=n.namespaces,y=n.enabled(d)),y),set:g=>{h=g}}),typeof n.init=="function"&&n.init(f),f}function i(d,p){const h=n(this.namespace+(typeof p>"u"?":":p)+d);return h.log=this.log,h}function a(d){n.save(d),n.namespaces=d,n.names=[],n.skips=[];let p;const h=(typeof d=="string"?d:"").split(/[\s,]+/),m=h.length;for(p=0;p<m;p++)h[p]&&(d=h[p].replace(/\*/g,".*?"),d[0]==="-"?n.skips.push(new RegExp("^"+d.slice(1)+"$")):n.names.push(new RegExp("^"+d+"$")))}function r(){const d=[...n.names.map(c),...n.skips.map(c).map(p=>"-"+p)].join(",");return n.enable(""),d}function o(d){if(d[d.length-1]==="*")return!0;let p,h;for(p=0,h=n.skips.length;p<h;p++)if(n.skips[p].test(d))return!1;for(p=0,h=n.names.length;p<h;p++)if(n.names[p].test(d))return!0;return!1}function c(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function l(d){return d instanceof Error?d.stack||d.message:d}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}return ir=s,ir}var Ac;function qf(){return Ac||(Ac=1,function(s,e){var t={};e.formatArgs=i,e.save=a,e.load=r,e.useColors=n,e.storage=o(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let l;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(l=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(l[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;l.splice(1,0,u,"color: inherit");let d=0,p=0;l[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(d++,h==="%c"&&(p=d))}),l.splice(p,0,u)}e.log=console.debug||console.log||(()=>{});function a(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}}function r(){let l;try{l=e.storage.getItem("debug")}catch{}return!l&&typeof Vt<"u"&&"env"in Vt&&(l=t.DEBUG),l}function o(){try{return localStorage}catch{}}s.exports=Bf()(e);const{formatters:c}=s.exports;c.j=function(l){try{return JSON.stringify(l)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}}(sr,sr.exports)),sr.exports}qf(),$f(),oh=()=>{const s=Zp(e=>e.loadModel);return{loadModel:M.useCallback(async(e,...t)=>{switch(e){case ht.Wllama:return Wp(...t);case ht.WebLLM:return s(...t);default:return}},[s])}};var Df=Object.defineProperty,Uf=Object.defineProperties,Ff=Object.getOwnPropertyDescriptors,bi=Object.getOwnPropertySymbols,Pc=Object.prototype.hasOwnProperty,Sc=Object.prototype.propertyIsEnumerable,Tc=(s,e,t)=>e in s?Df(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Zf=(s,e)=>{for(var t in e||(e={}))Pc.call(e,t)&&Tc(s,t,e[t]);if(bi)for(var t of bi(e))Sc.call(e,t)&&Tc(s,t,e[t]);return s},Wf=(s,e)=>Uf(s,Ff(e)),zf=(s,e)=>{var t={};for(var n in s)Pc.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&bi)for(var n of bi(s))e.indexOf(n)<0&&Sc.call(s,n)&&(t[n]=s[n]);return t};function Vf(s){let e=setTimeout(s,0),t=setTimeout(s,10),n=setTimeout(s,50);return[e,t,n]}function Kf(s){let e=M.useRef();return M.useEffect(()=>{e.current=s}),e.current}var Qf=18,Nc=40,Hf=`${Nc}px`,Jf=["[data-lastpass-icon-root]","com-1password-button","[data-dashlanecreated]",'[style$="2147483647 !important;"]'].join(",");function Gf({containerRef:s,inputRef:e,pushPasswordManagerStrategy:t,isFocused:n}){let[i,a]=M.useState(!1),[r,o]=M.useState(!1),[c,l]=M.useState(!1),u=M.useMemo(()=>t==="none"?!1:(t==="increase-width"||t==="experimental-no-flickering")&&i&&r,[i,r,t]),d=M.useCallback(()=>{let p=s.current,h=e.current;if(!p||!h||c||t==="none")return;let m=p,y=m.getBoundingClientRect().left+m.offsetWidth,f=m.getBoundingClientRect().top+m.offsetHeight/2,g=y-Qf,b=f;document.querySelectorAll(Jf).length===0&&document.elementFromPoint(g,b)===p||(a(!0),l(!0))},[s,e,c,t]);return M.useEffect(()=>{let p=s.current;if(!p||t==="none")return;function h(){let y=window.innerWidth-p.getBoundingClientRect().right;o(y>=Nc)}h();let m=setInterval(h,1e3);return()=>{clearInterval(m)}},[s,t]),M.useEffect(()=>{let p=n||document.activeElement===e.current;if(t==="none"||!p)return;let h=setTimeout(d,0),m=setTimeout(d,2e3),y=setTimeout(d,5e3),f=setTimeout(()=>{l(!0)},6e3);return()=>{clearTimeout(h),clearTimeout(m),clearTimeout(y),clearTimeout(f)}},[e,n,t,d]),{hasPWMBadge:i,willPushPWMBadge:u,PWM_BADGE_SPACE_WIDTH:Hf}}var jc=M.createContext({}),Rc=M.forwardRef((s,e)=>{var t=s,{value:n,onChange:i,maxLength:a,textAlign:r="left",pattern:o,placeholder:c,inputMode:l="numeric",onComplete:u,pushPasswordManagerStrategy:d="increase-width",pasteTransformer:p,containerClassName:h,noScriptCSSFallback:m=Xf,render:y,children:f}=t,g=zf(t,["value","onChange","maxLength","textAlign","pattern","placeholder","inputMode","onComplete","pushPasswordManagerStrategy","pasteTransformer","containerClassName","noScriptCSSFallback","render","children"]),b,v,E,S,A;let[Q,H]=M.useState(typeof g.defaultValue=="string"?g.defaultValue:""),W=n??Q,U=Kf(W),me=M.useCallback(V=>{i==null||i(V),H(V)},[i]),Oe=M.useMemo(()=>o?typeof o=="string"?new RegExp(o):o:null,[o]),le=M.useRef(null),ut=M.useRef(null),Xe=M.useRef({value:W,onChange:me,isIOS:typeof window<"u"&&((v=(b=window==null?void 0:window.CSS)==null?void 0:b.supports)==null?void 0:v.call(b,"-webkit-touch-callout","none"))}),tt=M.useRef({prev:[(E=le.current)==null?void 0:E.selectionStart,(S=le.current)==null?void 0:S.selectionEnd,(A=le.current)==null?void 0:A.selectionDirection]});M.useImperativeHandle(e,()=>le.current,[]),M.useEffect(()=>{let V=le.current,Y=ut.current;if(!V||!Y)return;Xe.current.value!==V.value&&Xe.current.onChange(V.value),tt.current.prev=[V.selectionStart,V.selectionEnd,V.selectionDirection];function Me(){if(document.activeElement!==V){Ft(null),nt(null);return}let fe=V.selectionStart,je=V.selectionEnd,ke=V.selectionDirection,we=V.maxLength,ft=V.value,pt=tt.current.prev,Wt=-1,zt=-1,yt;if(ft.length!==0&&fe!==null&&je!==null){let Xn=fe===je,_=fe===ft.length&&ft.length<we;if(Xn&&!_){let x=fe;if(x===0)Wt=0,zt=1,yt="forward";else if(x===we)Wt=x-1,zt=x,yt="backward";else if(we>1&&ft.length>1){let O=0;if(pt[0]!==null&&pt[1]!==null){yt=x<pt[1]?"backward":"forward";let P=pt[0]===pt[1]&&pt[0]<we;yt==="backward"&&!P&&(O=-1)}Wt=O+x,zt=O+x+1}}Wt!==-1&&zt!==-1&&Wt!==zt&&le.current.setSelectionRange(Wt,zt,yt)}let ya=Wt!==-1?Wt:fe,ga=zt!==-1?zt:je,yo=yt??ke;Ft(ya),nt(ga),tt.current.prev=[ya,ga,yo]}if(document.addEventListener("selectionchange",Me,{capture:!0}),Me(),document.activeElement===V&&ps(!0),!document.getElementById("input-otp-style")){let fe=document.createElement("style");if(fe.id="input-otp-style",document.head.appendChild(fe),fe.sheet){let je="background: transparent !important; color: transparent !important; border-color: transparent !important; opacity: 0 !important; box-shadow: none !important; -webkit-box-shadow: none !important; -webkit-text-fill-color: transparent !important;";kn(fe.sheet,"[data-input-otp]::selection { background: transparent !important; color: transparent !important; }"),kn(fe.sheet,`[data-input-otp]:autofill { ${je} }`),kn(fe.sheet,`[data-input-otp]:-webkit-autofill { ${je} }`),kn(fe.sheet,"@supports (-webkit-touch-callout: none) { [data-input-otp] { letter-spacing: -.6em !important; font-weight: 100 !important; font-stretch: ultra-condensed; font-optical-sizing: none !important; left: -1px !important; right: 1px !important; } }"),kn(fe.sheet,"[data-input-otp] + * { pointer-events: all !important; }")}}let We=()=>{Y&&Y.style.setProperty("--root-height",`${V.clientHeight}px`)};We();let Be=new ResizeObserver(We);return Be.observe(V),()=>{document.removeEventListener("selectionchange",Me,{capture:!0}),Be.disconnect()}},[]);let[_e,St]=M.useState(!1),[st,ps]=M.useState(!1),[dt,Ft]=M.useState(null),[F,nt]=M.useState(null);M.useEffect(()=>{Vf(()=>{var V,Y,Me,We;(V=le.current)==null||V.dispatchEvent(new Event("input"));let Be=(Y=le.current)==null?void 0:Y.selectionStart,fe=(Me=le.current)==null?void 0:Me.selectionEnd,je=(We=le.current)==null?void 0:We.selectionDirection;Be!==null&&fe!==null&&(Ft(Be),nt(fe),tt.current.prev=[Be,fe,je])})},[W,st]),M.useEffect(()=>{U!==void 0&&W!==U&&U.length<a&&W.length===a&&(u==null||u(W))},[a,u,U,W]);let Zt=Gf({containerRef:ut,inputRef:le,pushPasswordManagerStrategy:d,isFocused:st}),ve=M.useCallback(V=>{let Y=V.currentTarget.value.slice(0,a);if(Y.length>0&&Oe&&!Oe.test(Y)){V.preventDefault();return}typeof U=="string"&&Y.length<U.length&&document.dispatchEvent(new Event("selectionchange")),me(Y)},[a,me,U,Oe]),Ts=M.useCallback(()=>{var V;if(le.current){let Y=Math.min(le.current.value.length,a-1),Me=le.current.value.length;(V=le.current)==null||V.setSelectionRange(Y,Me),Ft(Y),nt(Me)}ps(!0)},[a]),He=M.useCallback(V=>{var Y,Me;let We=le.current;if(!p&&(!Xe.current.isIOS||!V.clipboardData||!We))return;let Be=V.clipboardData.getData("text/plain"),fe=p?p(Be):Be;V.preventDefault();let je=(Y=le.current)==null?void 0:Y.selectionStart,ke=(Me=le.current)==null?void 0:Me.selectionEnd,we=(je!==ke?W.slice(0,je)+fe+W.slice(ke):W.slice(0,je)+fe+W.slice(je)).slice(0,a);if(we.length>0&&Oe&&!Oe.test(we))return;We.value=we,me(we);let ft=Math.min(we.length,a-1),pt=we.length;We.setSelectionRange(ft,pt),Ft(ft),nt(pt)},[a,me,Oe,W]),mt=M.useMemo(()=>({position:"relative",cursor:g.disabled?"default":"text",userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"}),[g.disabled]),Tt=M.useMemo(()=>({position:"absolute",inset:0,width:Zt.willPushPWMBadge?`calc(100% + ${Zt.PWM_BADGE_SPACE_WIDTH})`:"100%",clipPath:Zt.willPushPWMBadge?`inset(0 ${Zt.PWM_BADGE_SPACE_WIDTH} 0 0)`:void 0,height:"100%",display:"flex",textAlign:r,opacity:"1",color:"transparent",pointerEvents:"all",background:"transparent",caretColor:"transparent",border:"0 solid transparent",outline:"0 solid transparent",boxShadow:"none",lineHeight:"1",letterSpacing:"-.5em",fontSize:"var(--root-height)",fontFamily:"monospace",fontVariantNumeric:"tabular-nums"}),[Zt.PWM_BADGE_SPACE_WIDTH,Zt.willPushPWMBadge,r]),it=M.useMemo(()=>M.createElement("input",Wf(Zf({autoComplete:g.autoComplete||"one-time-code"},g),{"data-input-otp":!0,"data-input-otp-placeholder-shown":W.length===0||void 0,"data-input-otp-mss":dt,"data-input-otp-mse":F,inputMode:l,pattern:Oe==null?void 0:Oe.source,"aria-placeholder":c,style:Tt,maxLength:a,value:W,ref:le,onPaste:V=>{var Y;He(V),(Y=g.onPaste)==null||Y.call(g,V)},onChange:ve,onMouseOver:V=>{var Y;St(!0),(Y=g.onMouseOver)==null||Y.call(g,V)},onMouseLeave:V=>{var Y;St(!1),(Y=g.onMouseLeave)==null||Y.call(g,V)},onFocus:V=>{var Y;Ts(),(Y=g.onFocus)==null||Y.call(g,V)},onBlur:V=>{var Y;ps(!1),(Y=g.onBlur)==null||Y.call(g,V)}})),[ve,Ts,He,l,Tt,a,F,dt,g,Oe==null?void 0:Oe.source,W]),hs=M.useMemo(()=>({slots:Array.from({length:a}).map((V,Y)=>{var Me;let We=st&&dt!==null&&F!==null&&(dt===F&&Y===dt||Y>=dt&&Y<F),Be=W[Y]!==void 0?W[Y]:null,fe=W[0]!==void 0?null:(Me=c==null?void 0:c[Y])!=null?Me:null;return{char:Be,placeholderChar:fe,isActive:We,hasFakeCaret:We&&Be===null}}),isFocused:st,isHovering:!g.disabled&&_e}),[st,_e,a,F,dt,g.disabled,W]),ms=M.useMemo(()=>y?y(hs):M.createElement(jc.Provider,{value:hs},f),[f,hs,y]);return M.createElement(M.Fragment,null,m!==null&&M.createElement("noscript",null,M.createElement("style",null,m)),M.createElement("div",{ref:ut,"data-input-otp-container":!0,style:mt,className:h},ms,M.createElement("div",{style:{position:"absolute",inset:0,pointerEvents:"none"}},it)))});Rc.displayName="Input";function kn(s,e){try{s.insertRule(e)}catch{console.error("input-otp could not insert CSS rule:",e)}}var Xf=`
[data-input-otp] {
  --nojs-bg: white !important;
  --nojs-fg: black !important;

  background-color: var(--nojs-bg) !important;
  color: var(--nojs-fg) !important;
  caret-color: var(--nojs-fg) !important;
  letter-spacing: .25em !important;
  text-align: center !important;
  border: 1px solid var(--nojs-fg) !important;
  border-radius: 4px !important;
  width: 100% !important;
}
@media (prefers-color-scheme: dark) {
  [data-input-otp] {
    --nojs-bg: black !important;
    --nojs-fg: white !important;
  }
}`;Ca=M.forwardRef(({className:s,containerClassName:e,...t},n)=>se.jsx(Rc,{ref:n,containerClassName:Ie("flex items-center gap-2 has-[:disabled]:opacity-50",e),className:Ie("disabled:cursor-not-allowed",s),...t})),Ca.displayName="InputOTP",ni=M.forwardRef(({className:s,...e},t)=>se.jsx("div",{ref:t,className:Ie("flex items-center",s),...e})),ni.displayName="InputOTPGroup",Yt=M.forwardRef(({index:s,className:e,hidden:t,...n},i)=>{const a=M.useContext(jc),{char:r,hasFakeCaret:o,isActive:c}=a.slots[s];return se.jsxs("div",{ref:i,className:Ie("relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",c&&"z-10 ring-2 ring-ring ring-offset-background",e),...n,children:[t&&r?se.jsx(rh,{}):r,o&&se.jsx("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-center",children:se.jsx("div",{className:"h-4 w-px animate-caret-blink bg-foreground duration-1000"})})]})}),Yt.displayName="InputOTPSlot",Aa=M.forwardRef(({...s},e)=>se.jsx("div",{ref:e,role:"separator",...s,children:se.jsx(rh,{})})),Aa.displayName="InputOTPSeparator";let Us,ar,Ic,_i,vi,rr,$c,Lc;Eo=w_(({onConfirm:s,onCancel:e})=>{const t=Bp(),{t:n}=qp("dialogs"),[i,a]=M.useState(""),r=l=>{a(l)},o=async()=>{(i==null?void 0:i.length)===6&&(await(s==null?void 0:s(i)),a(""),t.resolve(!0),t.hide())},c=async()=>{await(e==null?void 0:e()),a(""),t.resolve(!1),t.hide()};return se.jsx(C_,{open:t.visible,onOpenChange:c,children:se.jsxs(A_,{className:"w-[330px]",children:[se.jsxs(P_,{children:[se.jsx(S_,{children:n("session_passkey.title")}),se.jsx(T_,{children:n("session_passkey.description")})]}),se.jsx("div",{className:"py-4",children:se.jsxs(Ca,{onChange:r,maxLength:6,children:[se.jsxs(ni,{children:[se.jsx(Yt,{index:0,hidden:!0}),se.jsx(Yt,{index:1,hidden:!0}),se.jsx(Yt,{index:2,hidden:!0})]}),se.jsx(Aa,{}),se.jsxs(ni,{children:[se.jsx(Yt,{index:3,hidden:!0}),se.jsx(Yt,{index:4,hidden:!0}),se.jsx(Yt,{index:5,hidden:!0})]})]})}),se.jsx(N_,{children:se.jsx(j_,{disabled:(i==null?void 0:i.length)!==6,onClick:o,type:"submit",children:n("session_passkey.confirm")})})]})})}),Us=s=>{const e=s.match(/.{1,2}/g);if(!e)throw new Error("Invalid hexString");return Uint8Array.from(e.map(t=>parseInt(t,16))).buffer},ar=s=>new TextEncoder().encode(s).buffer,Ic=async s=>{const e=ar(s);return await crypto.subtle.digest("SHA-256",e)},_i=s=>[...new Uint8Array(s)].map(e=>e.toString(16).padStart(2,"0")).join(""),ph=async()=>{const s=crypto.getRandomValues(new Uint8Array(32));return _i(s)},vi=async s=>{const e=await Ic(s);return _i(e)},rr=async s=>(await vi(s)).substring(0,32),Po=async(s,e)=>{const t=await vi(e),n=await rr(e),i=ar(s),a=await $c(i,t,n);return _i(a)},ti=async(s,e)=>{const t=await vi(e),n=await rr(e),i=Us(s),a=await Lc(i,t,n);return new TextDecoder().decode(a)},$c=async(s,e,t)=>{const n=Us(t),i=Us(e),a=await crypto.subtle.importKey("raw",i,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.encrypt({name:"AES-CBC",iv:n},a,s)},Lc=async(s,e,t)=>{const n=Us(t),i=Us(e),a=await crypto.subtle.importKey("raw",i,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.decrypt({name:"AES-CBC",iv:n},a,s)},hh=async(s,e)=>{const t={};return await Promise.all(Object.entries(s||{}).map(async([n,i])=>{const a=await Po(i,e);t[n]=a})),t},dh=async(s,e)=>{let t;if(await new Promise((n,i)=>{e.show({onConfirm:async a=>{try{t=await ti(s,a),await _a.set("passphrase",t),n(!0)}catch(r){i(r)}finally{e.hide()}},onCancel:()=>{i()}})}),!t)throw new Error("Passphrase is required");return t},Mo=s=>{const e=Bp(s),t=M.useRef(e);return t.current=e,{modal:e,modalRef:t}};class Bc extends R_{}ko=class extends Bc{static lc_name(){return"StringPromptValue"}constructor(s){super({value:s}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=s}toString(){return this.value}toChatMessages(){return[new Vp(this.value)]}};class Yf extends Bc{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return I_(this.messages)}toChatMessages(){return this.messages}}let wi;fh=s=>{const e=(t,n=null)=>{let i=`{
`;return t.filter(a=>a.parent_id===n).forEach(a=>{if(a.type==="object"){const r=s.filter(c=>c.parent_id===a.id),o=e(r,a.id);i+=`  ${a.name}${a.required?"":"?"}: ${o}
`}else i+=`  // ${a.description||""}
  ${a.name}${a.required?"":"?"}: ${a.type};
`}),i+="}",i};return e(s)},lh=s=>{const e=(n,i=null)=>{let a="";return n.filter(r=>r.parent_id===i).forEach(r=>{if(r.type==="object"){const o=e(n,r.id);a+=`    ${r.name}: z.object({
${o}    })${r.required?"":".optional()"}.describe('${r.description||""}'),
`}else a+=`    ${r.name}: z.${r.type}()${r.required?"":".optional()"}.describe('${r.description||""}'),
`}),a};let t=`const schema = z.object({
`;return t+=e(s),t+="});",t},wi=s=>{const e={},t={string:jt.string,number:jt.number,boolean:jt.boolean,enum:()=>jt.enum([""])};return s.forEach(n=>{if(!n.parent_id)if(n.type==="object"){const i=s.filter(r=>r.parent_id===n.id),a={};i.forEach(r=>{r.type==="object"||r.type==="array"||(a[r.name]=t[r.type](),r.required||(a[r.name]=a[r.name].optional()))}),e[n.name]=jt.object(a),n.required||(e[n.name]=e[n.name].optional())}else n.type==="array"?(e[n.name]=jt.array(jt.string()),n.required||(e[n.name]=e[n.name].optional())):n.type==="enum"?(e[n.name]=jt.enum((n.enum||"").split(",")),n.required||(e[n.name]=e[n.name].optional())):(e[n.name]=t[n.type](),n.required||(e[n.name]=e[n.name].optional()))}),jt.object(e)};function qc(s){return s!=null&&typeof s=="object"&&Symbol.asyncIterator in s}const Dc=async s=>{switch(s){case"WebLLM":return await Sa.getCurrentModel();case"Wllama":return Ta.getCurrentModel();default:return}},ey=async s=>{switch(s){case"WebLLM":return await Sa.unloadModel();case"Wllama":return await Ta.unloadModel();default:return}},ty=async(s,e)=>{var u,d,p;const{tools:t,schemas:n,onMessageUpdate:i,onMessageFinish:a}=e||{};if(!(e!=null&&e.llm))throw new Error("LLM is not found");if(!await Dc((u=e==null?void 0:e.llm)==null?void 0:u.provider))throw new Error("Model is not found");const r={stream:!0};if(n!=null&&n.length){n&&(n==null?void 0:n.length)>1&&Dp("Multiple schemas are not supported. Only the first schema will be used.");const h=((d=n==null?void 0:n[0])==null?void 0:d.schema_items)||[],m=wi(h),y=((p=Pa(m,"my").definitions)==null?void 0:p.my)||{};r.response_format={type:"json_object",schema:y}}t!=null&&t.length&&(r.tools=t.map(h=>{var f;const m=wi(h.schemaItems),y=((f=Pa(m,"my").definitions)==null?void 0:f.my)||{};return{type:"function",function:{name:h.name,description:h.description,parameters:y}}}));const o=await Sa.chatCompletion(s,r);if(!o)throw new Error("Chat completion is not supported");let c="",l;if(o&&qc(o))for await(const h of o)c+=h.content||"",l=h.chunk||h,i==null||i({content:c,chunk:l});else{const h=o;c=h.content||"",l=h}return a==null||a({content:c,lastChunk:l}),{lastChunk:l,content:c}},sy=async(s,e)=>{var u,d;const{tools:t,schemas:n,onMessageUpdate:i,onMessageFinish:a}=e||{};if(!(e!=null&&e.llm))throw new Error("LLM is not found");await Dc((u=e==null?void 0:e.llm)==null?void 0:u.provider)&&await ey((d=e==null?void 0:e.llm)==null?void 0:d.provider);const r={stream:!0};if(n!=null&&n.length)throw n&&(n==null?void 0:n.length)>1&&Dp("Multiple schemas are not supported. Only the first schema will be used."),new Error("Structured output is not supported in Wllama yet");if(t!=null&&t.length)throw new Error("Function calling is not supported in Wllama yet");const o=await Ta.chatCompletion(s,r);if(!o)throw new Error("Chat completion is not supported");let c="",l;if(o&&qc(o))for await(const p of o)c+=p.content||"",l=p.chunk||p,i==null||i({content:c,chunk:l});else{const p=o;c=p.content||"",l=p}return a==null||a({content:c,lastChunk:l}),{lastChunk:l,content:c}},ny={async chatCompletion(s,e){var t;switch((t=e==null?void 0:e.llm)==null?void 0:t.provider){case"WebLLM":return ty(s,e);case"Wllama":return sy(s,e);default:throw new Error("Local LLM provider is not supported")}},async stream(s,e){return this.chatCompletion(s,e)}};function G(s,e,t,n,i){if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(s,t),t}function w(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)}let Uc=function(){const{crypto:s}=globalThis;if(s!=null&&s.randomUUID)return Uc=s.randomUUID.bind(s),s.randomUUID();const e=new Uint8Array(1),t=s?()=>s.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,n=>(+n^t()&15>>+n/4).toString(16))};function or(s){return typeof s=="object"&&s!==null&&("name"in s&&s.name==="AbortError"||"message"in s&&String(s.message).includes("FetchRequestCanceledException"))}const cr=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null){try{if(Object.prototype.toString.call(s)==="[object Error]"){const e=new Error(s.message,s.cause?{cause:s.cause}:{});return s.stack&&(e.stack=s.stack),s.cause&&!e.cause&&(e.cause=s.cause),s.name&&(e.name=s.name),e}}catch{}try{return new Error(JSON.stringify(s))}catch{}}return new Error(s)};class K extends Error{}let Ye=class So extends K{constructor(e,t,n,i){super(`${So.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.requestID=i==null?void 0:i.get("x-request-id"),this.error=t;const a=t;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,t,n){const i=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new xi({message:n,cause:cr(t)});const a=t==null?void 0:t.error;return e===400?new Fc(e,a,n,i):e===401?new Zc(e,a,n,i):e===403?new Wc(e,a,n,i):e===404?new zc(e,a,n,i):e===409?new Vc(e,a,n,i):e===422?new Kc(e,a,n,i):e===429?new Qc(e,a,n,i):e>=500?new Hc(e,a,n,i):new So(e,a,n,i)}},rt=class extends Ye{constructor({message:s}={}){super(void 0,void 0,s||"Request was aborted.",void 0)}},xi=class extends Ye{constructor({message:s,cause:e}){super(void 0,void 0,s||"Connection error.",void 0),e&&(this.cause=e)}},Oi=class extends xi{constructor({message:s}={}){super({message:s??"Request timed out."})}},Fc=class extends Ye{},Zc=class extends Ye{},Wc=class extends Ye{},zc=class extends Ye{},Vc=class extends Ye{},Kc=class extends Ye{},Qc=class extends Ye{},Hc=class extends Ye{};class Jc extends K{constructor(){super("Could not parse response content as the length limit was reached")}}class Gc extends K{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Cn extends Error{constructor(e){super(e)}}const iy=/^[a-z][a-z0-9+.-]*:/i,ay=s=>iy.test(s);let et=s=>(et=Array.isArray,et(s)),Xc=et;function ry(s){return typeof s!="object"?{}:s??{}}function oy(s){if(!s)return!0;for(const e in s)return!1;return!0}function cy(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function lr(s){return s!=null&&typeof s=="object"&&!Array.isArray(s)}const ly=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new K(`${s} must be an integer`);if(e<0)throw new K(`${s} must be a positive integer`);return e},uy=s=>{try{return JSON.parse(s)}catch{return}},An=s=>new Promise(e=>setTimeout(e,s)),Fs="5.8.2",dy=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function py(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const hy=()=>{var t;const s=py();if(s==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fs,"X-Stainless-OS":el(Deno.build.os),"X-Stainless-Arch":Yc(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((t=Deno.version)==null?void 0:t.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(s==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fs,"X-Stainless-OS":el(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Yc(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=my();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function my(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const i=n[1]||0,a=n[2]||0,r=n[3]||0;return{browser:e,version:`${i}.${a}.${r}`}}}return null}const Yc=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",el=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let tl;const fy=()=>tl??(tl=hy());function yy(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function sl(...s){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...s)}function nl(s){let e=Symbol.asyncIterator in s?s[Symbol.asyncIterator]():s[Symbol.iterator]();return sl({start(){},async pull(t){const{done:n,value:i}=await e.next();n?t.close():t.enqueue(i)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function il(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function gy(s){var n,i;if(s===null||typeof s!="object")return;if(s[Symbol.asyncIterator]){await((i=(n=s[Symbol.asyncIterator]()).return)==null?void 0:i.call(n));return}const e=s.getReader(),t=e.cancel();e.releaseLock(),await t}const by=({headers:s,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),al="RFC3986",rl=s=>String(s),ol={RFC1738:s=>String(s).replace(/%20/g,"+"),RFC3986:rl},_y="RFC1738";let ur=(s,e)=>(ur=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),ur(s,e));const qt=(()=>{const s=[];for(let e=0;e<256;++e)s.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return s})(),dr=1024,vy=(s,e,t,n,i)=>{if(s.length===0)return s;let a=s;if(typeof s=="symbol"?a=Symbol.prototype.toString.call(s):typeof s!="string"&&(a=String(s)),t==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let r="";for(let o=0;o<a.length;o+=dr){const c=a.length>=dr?a.slice(o,o+dr):a,l=[];for(let u=0;u<c.length;++u){let d=c.charCodeAt(u);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||i===_y&&(d===40||d===41)){l[l.length]=c.charAt(u);continue}if(d<128){l[l.length]=qt[d];continue}if(d<2048){l[l.length]=qt[192|d>>6]+qt[128|d&63];continue}if(d<55296||d>=57344){l[l.length]=qt[224|d>>12]+qt[128|d>>6&63]+qt[128|d&63];continue}u+=1,d=65536+((d&1023)<<10|c.charCodeAt(u)&1023),l[l.length]=qt[240|d>>18]+qt[128|d>>12&63]+qt[128|d>>6&63]+qt[128|d&63]}r+=l.join("")}return r};function wy(s){return!s||typeof s!="object"?!1:!!(s.constructor&&s.constructor.isBuffer&&s.constructor.isBuffer(s))}function cl(s,e){if(et(s)){const t=[];for(let n=0;n<s.length;n+=1)t.push(e(s[n]));return t}return e(s)}const ll={brackets(s){return String(s)+"[]"},comma:"comma",indices(s,e){return String(s)+"["+e+"]"},repeat(s){return String(s)}},ul=function(s,e){Array.prototype.push.apply(s,et(e)?e:[e])};let dl;const Se={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:vy,encodeValuesOnly:!1,format:al,formatter:rl,indices:!1,serializeDate(s){return(dl??(dl=Function.prototype.call.bind(Date.prototype.toISOString)))(s)},skipNulls:!1,strictNullHandling:!1};function xy(s){return typeof s=="string"||typeof s=="number"||typeof s=="boolean"||typeof s=="symbol"||typeof s=="bigint"}const pr={};function pl(s,e,t,n,i,a,r,o,c,l,u,d,p,h,m,y,f,g){let b=s,v=g,E=0,S=!1;for(;(v=v.get(pr))!==void 0&&!S;){const U=v.get(s);if(E+=1,typeof U<"u"){if(U===E)throw new RangeError("Cyclic object value");S=!0}typeof v.get(pr)>"u"&&(E=0)}if(typeof l=="function"?b=l(e,b):b instanceof Date?b=p==null?void 0:p(b):t==="comma"&&et(b)&&(b=cl(b,function(U){return U instanceof Date?p==null?void 0:p(U):U})),b===null){if(a)return c&&!y?c(e,Se.encoder,f,"key",h):e;b=""}if(xy(b)||wy(b)){if(c){const U=y?e:c(e,Se.encoder,f,"key",h);return[(m==null?void 0:m(U))+"="+(m==null?void 0:m(c(b,Se.encoder,f,"value",h)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(b)))]}const A=[];if(typeof b>"u")return A;let Q;if(t==="comma"&&et(b))y&&c&&(b=cl(b,c)),Q=[{value:b.length>0?b.join(",")||null:void 0}];else if(et(l))Q=l;else{const U=Object.keys(b);Q=u?U.sort(u):U}const H=o?String(e).replace(/\./g,"%2E"):String(e),W=n&&et(b)&&b.length===1?H+"[]":H;if(i&&et(b)&&b.length===0)return W+"[]";for(let U=0;U<Q.length;++U){const me=Q[U],Oe=typeof me=="object"&&typeof me.value<"u"?me.value:b[me];if(r&&Oe===null)continue;const le=d&&o?me.replace(/\./g,"%2E"):me,ut=et(b)?typeof t=="function"?t(W,le):W:W+(d?"."+le:"["+le+"]");g.set(s,E);const Xe=new WeakMap;Xe.set(pr,g),ul(A,pl(Oe,ut,t,n,i,a,r,o,t==="comma"&&y&&et(b)?null:c,l,u,d,p,h,m,y,f,Xe))}return A}function Oy(s=Se){if(typeof s.allowEmptyArrays<"u"&&typeof s.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof s.encodeDotInKeys<"u"&&typeof s.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(s.encoder!==null&&typeof s.encoder<"u"&&typeof s.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=s.charset||Se.charset;if(typeof s.charset<"u"&&s.charset!=="utf-8"&&s.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=al;if(typeof s.format<"u"){if(!ur(ol,s.format))throw new TypeError("Unknown format option provided.");t=s.format}const n=ol[t];let i=Se.filter;(typeof s.filter=="function"||et(s.filter))&&(i=s.filter);let a;if(s.arrayFormat&&s.arrayFormat in ll?a=s.arrayFormat:"indices"in s?a=s.indices?"indices":"repeat":a=Se.arrayFormat,"commaRoundTrip"in s&&typeof s.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const r=typeof s.allowDots>"u"?s.encodeDotInKeys?!0:Se.allowDots:!!s.allowDots;return{addQueryPrefix:typeof s.addQueryPrefix=="boolean"?s.addQueryPrefix:Se.addQueryPrefix,allowDots:r,allowEmptyArrays:typeof s.allowEmptyArrays=="boolean"?!!s.allowEmptyArrays:Se.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof s.charsetSentinel=="boolean"?s.charsetSentinel:Se.charsetSentinel,commaRoundTrip:!!s.commaRoundTrip,delimiter:typeof s.delimiter>"u"?Se.delimiter:s.delimiter,encode:typeof s.encode=="boolean"?s.encode:Se.encode,encodeDotInKeys:typeof s.encodeDotInKeys=="boolean"?s.encodeDotInKeys:Se.encodeDotInKeys,encoder:typeof s.encoder=="function"?s.encoder:Se.encoder,encodeValuesOnly:typeof s.encodeValuesOnly=="boolean"?s.encodeValuesOnly:Se.encodeValuesOnly,filter:i,format:t,formatter:n,serializeDate:typeof s.serializeDate=="function"?s.serializeDate:Se.serializeDate,skipNulls:typeof s.skipNulls=="boolean"?s.skipNulls:Se.skipNulls,sort:typeof s.sort=="function"?s.sort:null,strictNullHandling:typeof s.strictNullHandling=="boolean"?s.strictNullHandling:Se.strictNullHandling}}function Ey(s,e={}){let t=s;const n=Oy(e);let i,a;typeof n.filter=="function"?(a=n.filter,t=a("",t)):et(n.filter)&&(a=n.filter,i=a);const r=[];if(typeof t!="object"||t===null)return"";const o=ll[n.arrayFormat],c=o==="comma"&&n.commaRoundTrip;i||(i=Object.keys(t)),n.sort&&i.sort(n.sort);const l=new WeakMap;for(let p=0;p<i.length;++p){const h=i[p];n.skipNulls&&t[h]===null||ul(r,pl(t[h],h,o,c,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,l))}const u=r.join(n.delimiter);let d=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}function My(s){let e=0;for(const i of s)e+=i.length;const t=new Uint8Array(e);let n=0;for(const i of s)t.set(i,n),n+=i.length;return t}let hl;function hr(s){let e;return(hl??(e=new globalThis.TextEncoder,hl=e.encode.bind(e)))(s)}let ml;function fl(s){let e;return(ml??(e=new globalThis.TextDecoder,ml=e.decode.bind(e)))(s)}var ot,ct;let Ei=class{constructor(){ot.set(this,void 0),ct.set(this,void 0),G(this,ot,new Uint8Array),G(this,ct,null)}decode(s){if(s==null)return[];const e=s instanceof ArrayBuffer?new Uint8Array(s):typeof s=="string"?hr(s):s;G(this,ot,My([w(this,ot,"f"),e]));const t=[];let n;for(;(n=ky(w(this,ot,"f"),w(this,ct,"f")))!=null;){if(n.carriage&&w(this,ct,"f")==null){G(this,ct,n.index);continue}if(w(this,ct,"f")!=null&&(n.index!==w(this,ct,"f")+1||n.carriage)){t.push(fl(w(this,ot,"f").subarray(0,w(this,ct,"f")-1))),G(this,ot,w(this,ot,"f").subarray(w(this,ct,"f"))),G(this,ct,null);continue}const i=w(this,ct,"f")!==null?n.preceding-1:n.preceding,a=fl(w(this,ot,"f").subarray(0,i));t.push(a),G(this,ot,w(this,ot,"f").subarray(n.index)),G(this,ct,null)}return t}flush(){return w(this,ot,"f").length?this.decode(`
`):[]}};ot=new WeakMap,ct=new WeakMap,Ei.NEWLINE_CHARS=new Set([`
`,"\r"]),Ei.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function ky(s,e){for(let t=e??0;t<s.length;t++){if(s[t]===10)return{preceding:t,index:t+1,carriage:!1};if(s[t]===13)return{preceding:t,index:t+1,carriage:!0}}return null}function Cy(s){for(let e=0;e<s.length-1;e++){if(s[e]===10&&s[e+1]===10||s[e]===13&&s[e+1]===13)return e+2;if(s[e]===13&&s[e+1]===10&&e+3<s.length&&s[e+2]===13&&s[e+3]===10)return e+4}return-1}let Pn=class ai{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*i(){if(n)throw new K("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const r of Ay(e,t))if(!a){if(r.data.startsWith("[DONE]")){a=!0;continue}if(r.event===null||r.event.startsWith("response.")||r.event.startsWith("transcript.")){let o;try{o=JSON.parse(r.data)}catch(c){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),c}if(o&&o.error)throw new Ye(void 0,o.error,void 0,e.headers);yield o}else{let o;try{o=JSON.parse(r.data)}catch(c){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),c}if(r.event=="error")throw new Ye(void 0,o.error,o.message,void 0);yield{event:r.event,data:o}}}a=!0}catch(r){if(or(r))return;throw r}finally{a||t.abort()}}return new ai(i,t)}static fromReadableStream(e,t){let n=!1;async function*i(){const r=new Ei,o=il(e);for await(const c of o)for(const l of r.decode(c))yield l;for(const c of r.flush())yield c}async function*a(){if(n)throw new K("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const o of i())r||o&&(yield JSON.parse(o));r=!0}catch(o){if(or(o))return;throw o}finally{r||t.abort()}}return new ai(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),i=a=>({next:()=>{if(a.length===0){const r=n.next();e.push(r),t.push(r)}return a.shift()}});return[new ai(()=>i(e),this.controller),new ai(()=>i(t),this.controller)]}toReadableStream(){const e=this;let t;return sl({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{const{value:i,done:a}=await t.next();if(a)return n.close();const r=hr(JSON.stringify(i)+`
`);n.enqueue(r)}catch(i){n.error(i)}},async cancel(){var n;await((n=t.return)==null?void 0:n.call(t))}})}};async function*Ay(s,e){if(!s.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new K("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new K("Attempted to iterate over a response with no body");const t=new Sy,n=new Ei,i=il(s.body);for await(const a of Py(i))for(const r of n.decode(a)){const o=t.decode(r);o&&(yield o)}for(const a of n.flush()){const r=t.decode(a);r&&(yield r)}}async function*Py(s){let e=new Uint8Array;for await(const t of s){if(t==null)continue;const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?hr(t):t;let i=new Uint8Array(e.length+n.length);i.set(e),i.set(n,e.length),e=i;let a;for(;(a=Cy(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}let Sy=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(s){if(s.endsWith("\r")&&(s=s.substring(0,s.length-1)),!s){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(s),s.startsWith(":"))return null;let[e,t,n]=Ty(s,":");return n.startsWith(" ")&&(n=n.substring(1)),e==="event"?this.event=n:e==="data"&&this.data.push(n),null}};function Ty(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}const Mi={off:0,error:200,warn:300,info:400,debug:500},yl=(s,e,t)=>{if(s){if(cy(Mi,s))return s;Ve(t).warn(`${e} was set to ${JSON.stringify(s)}, expected one of ${JSON.stringify(Object.keys(Mi))}`)}};function Sn(){}function ki(s,e,t){return!e||Mi[s]>Mi[t]?Sn:e[s].bind(e)}const Ny={error:Sn,warn:Sn,info:Sn,debug:Sn};let gl=new WeakMap;function Ve(s){const e=s.logger,t=s.logLevel??"off";if(!e)return Ny;const n=gl.get(e);if(n&&n[0]===t)return n[1];const i={error:ki("error",e,t),warn:ki("warn",e,t),info:ki("info",e,t),debug:ki("debug",e,t)};return gl.set(e,[t,i]),i}const xs=s=>(s.options&&(s.options={...s.options},delete s.options.headers),s.headers&&(s.headers=Object.fromEntries((s.headers instanceof Headers?[...s.headers]:Object.entries(s.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in s&&(s.retryOfRequestLogID&&(s.retryOf=s.retryOfRequestLogID),delete s.retryOfRequestLogID),s);async function bl(s,e){const{response:t,requestLogID:n,retryOfRequestLogID:i,startTime:a}=e,r=await(async()=>{var c,l;if(e.options.stream)return Ve(s).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Pn.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const o=(l=(c=t.headers.get("content-type"))==null?void 0:c.split(";")[0])==null?void 0:l.trim();if(o!=null&&o.includes("application/json")||o!=null&&o.endsWith("+json")){const u=await t.json();return _l(u,t)}return await t.text()})();return Ve(s).debug(`[${n}] response parsed`,xs({retryOfRequestLogID:i,url:t.url,status:t.status,body:r,durationMs:Date.now()-a})),r}function _l(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Tn;let vl=class gh extends Promise{constructor(e,t,n=bl){super(i=>{i(null)}),this.responsePromise=t,this.parseResponse=n,Tn.set(this,void 0),G(this,Tn,e)}_thenUnwrap(e){return new gh(w(this,Tn,"f"),this.responsePromise,async(t,n)=>_l(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(w(this,Tn,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};Tn=new WeakMap;var Ci;class wl{constructor(e,t,n,i){Ci.set(this,void 0),G(this,Ci,e),this.options=i,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new K("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await w(this,Ci,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ci=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}let jy=class extends vl{constructor(s,e,t){super(s,e,async(n,i)=>new t(n,i.response,await bl(n,i),i.options))}async*[Symbol.asyncIterator](){const s=await this;for await(const e of s)yield e}};class Ai extends wl{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class Ae extends wl{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var n;const e=this.getPaginatedItems(),t=(n=e[e.length-1])==null?void 0:n.id;return t?{...this.options,query:{...ry(this.options.query),after:t}}:null}}const xl=()=>{var s;if(typeof File>"u"){const{process:e}=globalThis,t=typeof((s=e==null?void 0:e.versions)==null?void 0:s.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Nn(s,e,t){return xl(),new File(s,e??"unknown_file",t)}function Pi(s){return(typeof s=="object"&&s!==null&&("name"in s&&s.name&&String(s.name)||"url"in s&&s.url&&String(s.url)||"filename"in s&&s.filename&&String(s.filename)||"path"in s&&s.path&&String(s.path))||"").split(/[\\/]/).pop()||void 0}const Ol=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",Os=async(s,e)=>({...s,body:await Iy(s.body,e)}),El=new WeakMap;function Ry(s){const e=typeof s=="function"?s:s.fetch,t=El.get(e);if(t)return t;const n=(async()=>{try{const i="Response"in e?e.Response:(await e("data:,")).constructor,a=new FormData;return a.toString()!==await new i(a).text()}catch{return!0}})();return El.set(e,n),n}const Iy=async(s,e)=>{if(!await Ry(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const t=new FormData;return await Promise.all(Object.entries(s||{}).map(([n,i])=>mr(t,n,i))),t},$y=s=>s instanceof Blob&&"name"in s,mr=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(t instanceof Response)s.append(e,Nn([await t.blob()],Pi(t)));else if(Ol(t))s.append(e,Nn([await new Response(nl(t)).blob()],Pi(t)));else if($y(t))s.append(e,t,Pi(t));else if(Array.isArray(t))await Promise.all(t.map(n=>mr(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>mr(s,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}},Ml=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",Ly=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&Ml(s),By=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function";async function qy(s,e,t){if(xl(),s=await s,Ly(s))return s instanceof File?s:Nn([await s.arrayBuffer()],s.name);if(By(s)){const i=await s.blob();return e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()),Nn(await fr(i),e,t)}const n=await fr(s);if(e||(e=Pi(s)),!(t!=null&&t.type)){const i=n.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof i=="string"&&(t={...t,type:i})}return Nn(n,e,t)}async function fr(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(Ml(s))e.push(s instanceof Blob?s:await s.arrayBuffer());else if(Ol(s))for await(const n of s)e.push(...await fr(n));else{const n=(t=s==null?void 0:s.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof s}${n?`; constructor: ${n}`:""}${Dy(s)}`)}return e}function Dy(s){return typeof s!="object"||s===null?"":`; props: [${Object.getOwnPropertyNames(s).map(e=>`"${e}"`).join(", ")}]`}let X=class{constructor(s){this._client=s}};function kl(s){return s.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Uy=(s=kl)=>function(e,...t){if(e.length===1)return e[0];let n=!1;const i=e.reduce((l,u,d)=>(/[?#]/.test(u)&&(n=!0),l+u+(d===t.length?"":(n?encodeURIComponent:s)(String(t[d])))),""),a=i.split(/[?#]/,1)[0],r=[],o=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let c;for(;(c=o.exec(a))!==null;)r.push({start:c.index,length:c[0].length});if(r.length>0){let l=0;const u=r.reduce((d,p)=>{const h=" ".repeat(p.start-l),m="^".repeat(p.length);return l=p.start+p.length,d+h+m},"");throw new K(`Path parameters result in path with invalid segments:
${i}
${u}`)}return i},T=Uy(kl);let Cl=class extends X{list(s,e={},t){return this._client.getAPIList(T`/chat/completions/${s}/messages`,Ae,{query:e,...t})}};function Fy(s){return typeof s.parse=="function"}const Si=s=>(s==null?void 0:s.role)==="assistant",Al=s=>(s==null?void 0:s.role)==="tool";var yr,Ti,Ni,jn,Rn,ji,In,Jt,$n,Ri,Ii,Zs,Pl;class gr{constructor(){yr.add(this),this.controller=new AbortController,Ti.set(this,void 0),Ni.set(this,()=>{}),jn.set(this,()=>{}),Rn.set(this,void 0),ji.set(this,()=>{}),In.set(this,()=>{}),Jt.set(this,{}),$n.set(this,!1),Ri.set(this,!1),Ii.set(this,!1),Zs.set(this,!1),G(this,Ti,new Promise((e,t)=>{G(this,Ni,e,"f"),G(this,jn,t,"f")})),G(this,Rn,new Promise((e,t)=>{G(this,ji,e,"f"),G(this,In,t,"f")})),w(this,Ti,"f").catch(()=>{}),w(this,Rn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},w(this,yr,"m",Pl).bind(this))},0)}_connected(){this.ended||(w(this,Ni,"f").call(this),this._emit("connect"))}get ended(){return w(this,$n,"f")}get errored(){return w(this,Ri,"f")}get aborted(){return w(this,Ii,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,Jt,"f")[e]||(w(this,Jt,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=w(this,Jt,"f")[e];if(!n)return this;const i=n.findIndex(a=>a.listener===t);return i>=0&&n.splice(i,1),this}once(e,t){return(w(this,Jt,"f")[e]||(w(this,Jt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{G(this,Zs,!0),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){G(this,Zs,!0),await w(this,Rn,"f")}_emit(e,...t){if(w(this,$n,"f"))return;e==="end"&&(G(this,$n,!0),w(this,ji,"f").call(this));const n=w(this,Jt,"f")[e];if(n&&(w(this,Jt,"f")[e]=n.filter(i=>!i.once),n.forEach(({listener:i})=>i(...t))),e==="abort"){const i=t[0];!w(this,Zs,"f")&&!(n!=null&&n.length)&&Promise.reject(i),w(this,jn,"f").call(this,i),w(this,In,"f").call(this,i),this._emit("end");return}if(e==="error"){const i=t[0];!w(this,Zs,"f")&&!(n!=null&&n.length)&&Promise.reject(i),w(this,jn,"f").call(this,i),w(this,In,"f").call(this,i),this._emit("end")}}_emitFinal(){}}Ti=new WeakMap,Ni=new WeakMap,jn=new WeakMap,Rn=new WeakMap,ji=new WeakMap,In=new WeakMap,Jt=new WeakMap,$n=new WeakMap,Ri=new WeakMap,Ii=new WeakMap,Zs=new WeakMap,yr=new WeakSet,Pl=function(s){if(G(this,Ri,!0),s instanceof Error&&s.name==="AbortError"&&(s=new rt),s instanceof rt)return G(this,Ii,!0),this._emit("abort",s);if(s instanceof K)return this._emit("error",s);if(s instanceof Error){const e=new K(s.message);return e.cause=s,this._emit("error",e)}return this._emit("error",new K(String(s)))};function Zy(s,e){const t={...s};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function br(s){return(s==null?void 0:s.$brand)==="auto-parseable-response-format"}function Ln(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function Wy(s,e){return!e||!Sl(e)?{...s,choices:s.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:_r(s,e)}function _r(s,e){const t=s.choices.map(n=>{var i;if(n.finish_reason==="length")throw new Jc;if(n.finish_reason==="content_filter")throw new Gc;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:((i=n.message.tool_calls)==null?void 0:i.map(a=>Vy(e,a)))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?zy(e,n.message.content):null}}});return{...s,choices:t}}function zy(s,e){var t,n;return((t=s.response_format)==null?void 0:t.type)!=="json_schema"?null:((n=s.response_format)==null?void 0:n.type)==="json_schema"?"$parseRaw"in s.response_format?s.response_format.$parseRaw(e):JSON.parse(e):null}function Vy(s,e){var n;const t=(n=s.tools)==null?void 0:n.find(i=>{var a;return((a=i.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Ln(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function Ky(s,e){var n;if(!s)return!1;const t=(n=s.tools)==null?void 0:n.find(i=>{var a;return((a=i.function)==null?void 0:a.name)===e.function.name});return Ln(t)||(t==null?void 0:t.function.strict)||!1}function Sl(s){var e;return br(s.response_format)?!0:((e=s.tools)==null?void 0:e.some(t=>Ln(t)||t.type==="function"&&t.function.strict===!0))??!1}function Qy(s){for(const e of s??[]){if(e.type!=="function")throw new K(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new K(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Ge,vr,$i,wr,xr,Or,Tl,Nl;const Hy=10;class jl extends gr{constructor(){super(...arguments),Ge.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var n;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(n=e.choices[0])==null?void 0:n.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),Al(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Si(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionToolCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new K("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),w(this,Ge,"m",vr).call(this)}async finalMessage(){return await this.done(),w(this,Ge,"m",$i).call(this)}async finalFunctionToolCall(){return await this.done(),w(this,Ge,"m",wr).call(this)}async finalFunctionToolCallResult(){return await this.done(),w(this,Ge,"m",xr).call(this)}async totalUsage(){return await this.done(),w(this,Ge,"m",Or).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=w(this,Ge,"m",$i).call(this);t&&this._emit("finalMessage",t);const n=w(this,Ge,"m",vr).call(this);n&&this._emit("finalContent",n);const i=w(this,Ge,"m",wr).call(this);i&&this._emit("finalFunctionToolCall",i);const a=w(this,Ge,"m",xr).call(this);a!=null&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(r=>r.usage)&&this._emit("totalUsage",w(this,Ge,"m",Or).call(this))}async _createChatCompletion(e,t,n){const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),w(this,Ge,"m",Tl).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(_r(a,t))}async _runChatCompletion(e,t,n){for(const i of t.messages)this._addMessage(i,!1);return await this._createChatCompletion(e,t,n)}async _runTools(e,t,n){var h,m,y;const i="tool",{tool_choice:a="auto",stream:r,...o}=t,c=typeof a!="string"&&((h=a==null?void 0:a.function)==null?void 0:h.name),{maxChatCompletions:l=Hy}=n||{},u=t.tools.map(f=>{if(Ln(f)){if(!f.$callback)throw new K("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:f.$callback,name:f.function.name,description:f.function.description||"",parameters:f.function.parameters,parse:f.$parseRaw,strict:!0}}}return f}),d={};for(const f of u)f.type==="function"&&(d[f.function.name||f.function.function.name]=f.function);const p="tools"in t?u.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description,strict:f.function.strict}}:f):void 0;for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<l;++f){const g=(m=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:p,messages:[...this.messages]},n)).choices[0])==null?void 0:m.message;if(!g)throw new K("missing message in ChatCompletion response");if(!((y=g.tool_calls)!=null&&y.length))return;for(const b of g.tool_calls){if(b.type!=="function")continue;const v=b.id,{name:E,arguments:S}=b.function,A=d[E];if(A){if(c&&c!==E){const U=`Invalid tool_call: ${JSON.stringify(E)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:i,tool_call_id:v,content:U});continue}}else{const U=`Invalid tool_call: ${JSON.stringify(E)}. Available options are: ${Object.keys(d).map(me=>JSON.stringify(me)).join(", ")}. Please try again`;this._addMessage({role:i,tool_call_id:v,content:U});continue}let Q;try{Q=Fy(A)?await A.parse(S):S}catch(U){const me=U instanceof Error?U.message:String(U);this._addMessage({role:i,tool_call_id:v,content:me});continue}const H=await A.function(Q,this),W=w(this,Ge,"m",Nl).call(this,H);if(this._addMessage({role:i,tool_call_id:v,content:W}),c)return}}}}Ge=new WeakSet,vr=function(){return w(this,Ge,"m",$i).call(this).content??null},$i=function(){let s=this.messages.length;for(;s-- >0;){const e=this.messages[s];if(Si(e))return{...e,content:e.content??null,refusal:e.refusal??null}}throw new K("stream ended without producing a ChatCompletionMessage with role=assistant")},wr=function(){var s,e;for(let t=this.messages.length-1;t>=0;t--){const n=this.messages[t];if(Si(n)&&((s=n==null?void 0:n.tool_calls)!=null&&s.length))return(e=n.tool_calls.at(-1))==null?void 0:e.function}},xr=function(){for(let s=this.messages.length-1;s>=0;s--){const e=this.messages[s];if(Al(e)&&e.content!=null&&typeof e.content=="string"&&this.messages.some(t=>{var n;return t.role==="assistant"&&((n=t.tool_calls)==null?void 0:n.some(i=>i.type==="function"&&i.id===e.tool_call_id))}))return e.content}},Or=function(){const s={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:e}of this._chatCompletions)e&&(s.completion_tokens+=e.completion_tokens,s.prompt_tokens+=e.prompt_tokens,s.total_tokens+=e.total_tokens);return s},Tl=function(s){if(s.n!=null&&s.n>1)throw new K("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Nl=function(s){return typeof s=="string"?s:s===void 0?"undefined":JSON.stringify(s)};class Er extends jl{static runTools(e,t,n){const i=new Er,a={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,a)),i}_addMessage(e,t=!0){super._addMessage(e,t),Si(e)&&e.content&&this._emit("content",e.content)}}const Rl=1,Il=2,$l=4,Ll=8,Bl=16,ql=32,Dl=64,Ul=128,Fl=256,Zl=Ul|Fl,Wl=Bl|ql|Zl|Dl,zl=Rl|Il|Wl,Vl=$l|Ll,Jy=zl|Vl,$e={STR:Rl,NUM:Il,ARR:$l,OBJ:Ll,NULL:Bl,BOOL:ql,NAN:Dl,INFINITY:Ul,MINUS_INFINITY:Fl,INF:Zl,SPECIAL:Wl,ATOM:zl,COLLECTION:Vl,ALL:Jy};class Gy extends Error{}class Xy extends Error{}function Yy(s,e=$e.ALL){if(typeof s!="string")throw new TypeError(`expecting str, got ${typeof s}`);if(!s.trim())throw new Error(`${s} is empty`);return eg(s.trim(),e)}const eg=(s,e)=>{const t=s.length;let n=0;const i=p=>{throw new Gy(`${p} at position ${n}`)},a=p=>{throw new Xy(`${p} at position ${n}`)},r=()=>(d(),n>=t&&i("Unexpected end of input"),s[n]==='"'?o():s[n]==="{"?c():s[n]==="["?l():s.substring(n,n+4)==="null"||$e.NULL&e&&t-n<4&&"null".startsWith(s.substring(n))?(n+=4,null):s.substring(n,n+4)==="true"||$e.BOOL&e&&t-n<4&&"true".startsWith(s.substring(n))?(n+=4,!0):s.substring(n,n+5)==="false"||$e.BOOL&e&&t-n<5&&"false".startsWith(s.substring(n))?(n+=5,!1):s.substring(n,n+8)==="Infinity"||$e.INFINITY&e&&t-n<8&&"Infinity".startsWith(s.substring(n))?(n+=8,1/0):s.substring(n,n+9)==="-Infinity"||$e.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(s.substring(n))?(n+=9,-1/0):s.substring(n,n+3)==="NaN"||$e.NAN&e&&t-n<3&&"NaN".startsWith(s.substring(n))?(n+=3,NaN):u()),o=()=>{const p=n;let h=!1;for(n++;n<t&&(s[n]!=='"'||h&&s[n-1]==="\\");)h=s[n]==="\\"?!h:!1,n++;if(s.charAt(n)=='"')try{return JSON.parse(s.substring(p,++n-Number(h)))}catch(m){a(String(m))}else if($e.STR&e)try{return JSON.parse(s.substring(p,n-Number(h))+'"')}catch{return JSON.parse(s.substring(p,s.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},c=()=>{n++,d();const p={};try{for(;s[n]!=="}";){if(d(),n>=t&&$e.OBJ&e)return p;const h=o();d(),n++;try{const m=r();Object.defineProperty(p,h,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if($e.OBJ&e)return p;throw m}d(),s[n]===","&&n++}}catch{if($e.OBJ&e)return p;i("Expected '}' at end of object")}return n++,p},l=()=>{n++;const p=[];try{for(;s[n]!=="]";)p.push(r()),d(),s[n]===","&&n++}catch{if($e.ARR&e)return p;i("Expected ']' at end of array")}return n++,p},u=()=>{if(n===0){s==="-"&&$e.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s)}catch(h){if($e.NUM&e)try{return s[s.length-1]==="."?JSON.parse(s.substring(0,s.lastIndexOf("."))):JSON.parse(s.substring(0,s.lastIndexOf("e")))}catch{}a(String(h))}}const p=n;for(s[n]==="-"&&n++;s[n]&&!",]}".includes(s[n]);)n++;n==t&&!($e.NUM&e)&&i("Unterminated number literal");try{return JSON.parse(s.substring(p,n))}catch{s.substring(p,n)==="-"&&$e.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s.substring(p,s.lastIndexOf("e")))}catch(h){a(String(h))}}},d=()=>{for(;n<t&&` 
\r	`.includes(s[n]);)n++};return r()},Kl=s=>Yy(s,$e.ALL^$e.NUM);var Te,Gt,Ws,os,Mr,Li,kr,Cr,Ar,Bi,Pr,Ql;class Bn extends jl{constructor(e){super(),Te.add(this),Gt.set(this,void 0),Ws.set(this,void 0),os.set(this,void 0),G(this,Gt,e),G(this,Ws,[])}get currentChatCompletionSnapshot(){return w(this,os,"f")}static fromReadableStream(e){const t=new Bn(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const i=new Bn(t);return i._run(()=>i._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createChatCompletion(e,t,n){var r;super._createChatCompletion;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),w(this,Te,"m",Mr).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const o of a)w(this,Te,"m",kr).call(this,o);if((r=a.controller.signal)!=null&&r.aborted)throw new rt;return this._addChatCompletion(w(this,Te,"m",Bi).call(this))}async _fromReadableStream(e,t){var r;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),w(this,Te,"m",Mr).call(this),this._connected();const i=Pn.fromReadableStream(e,this.controller);let a;for await(const o of i)a&&a!==o.id&&this._addChatCompletion(w(this,Te,"m",Bi).call(this)),w(this,Te,"m",kr).call(this,o),a=o.id;if((r=i.controller.signal)!=null&&r.aborted)throw new rt;return this._addChatCompletion(w(this,Te,"m",Bi).call(this))}[(Gt=new WeakMap,Ws=new WeakMap,os=new WeakMap,Te=new WeakSet,Mr=function(){this.ended||G(this,os,void 0)},Li=function(e){let t=w(this,Ws,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},w(this,Ws,"f")[e.index]=t,t)},kr=function(e){var n,i,a,r,o,c,l,u,d,p,h,m,y,f,g;if(this.ended)return;const t=w(this,Te,"m",Ql).call(this,e);this._emit("chunk",e,t);for(const b of e.choices){const v=t.choices[b.index];b.delta.content!=null&&((n=v.message)==null?void 0:n.role)==="assistant"&&((i=v.message)!=null&&i.content)&&(this._emit("content",b.delta.content,v.message.content),this._emit("content.delta",{delta:b.delta.content,snapshot:v.message.content,parsed:v.message.parsed})),b.delta.refusal!=null&&((a=v.message)==null?void 0:a.role)==="assistant"&&((r=v.message)!=null&&r.refusal)&&this._emit("refusal.delta",{delta:b.delta.refusal,snapshot:v.message.refusal}),((o=b.logprobs)==null?void 0:o.content)!=null&&((c=v.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=b.logprobs)==null?void 0:l.content,snapshot:((u=v.logprobs)==null?void 0:u.content)??[]}),((d=b.logprobs)==null?void 0:d.refusal)!=null&&((p=v.message)==null?void 0:p.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(h=b.logprobs)==null?void 0:h.refusal,snapshot:((m=v.logprobs)==null?void 0:m.refusal)??[]});const E=w(this,Te,"m",Li).call(this,v);v.finish_reason&&(w(this,Te,"m",Ar).call(this,v),E.current_tool_call_index!=null&&w(this,Te,"m",Cr).call(this,v,E.current_tool_call_index));for(const S of b.delta.tool_calls??[])E.current_tool_call_index!==S.index&&(w(this,Te,"m",Ar).call(this,v),E.current_tool_call_index!=null&&w(this,Te,"m",Cr).call(this,v,E.current_tool_call_index)),E.current_tool_call_index=S.index;for(const S of b.delta.tool_calls??[]){const A=(y=v.message.tool_calls)==null?void 0:y[S.index];A!=null&&A.type&&((A==null?void 0:A.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(f=A.function)==null?void 0:f.name,index:S.index,arguments:A.function.arguments,parsed_arguments:A.function.parsed_arguments,arguments_delta:((g=S.function)==null?void 0:g.arguments)??""}):A==null||A.type)}}},Cr=function(e,t){var i,a,r;if(w(this,Te,"m",Li).call(this,e).done_tool_calls.has(t))return;const n=(i=e.message.tool_calls)==null?void 0:i[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if(n.type==="function"){const o=(r=(a=w(this,Gt,"f"))==null?void 0:a.tools)==null?void 0:r.find(c=>c.type==="function"&&c.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Ln(o)?o.$parseRaw(n.function.arguments):o!=null&&o.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Ar=function(e){var n,i;const t=w(this,Te,"m",Li).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const a=w(this,Te,"m",Pr).call(this);this._emit("content.done",{content:e.message.content,parsed:a?a.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),(n=e.logprobs)!=null&&n.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),(i=e.logprobs)!=null&&i.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Bi=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");const e=w(this,os,"f");if(!e)throw new K("request ended without sending any chunks");return G(this,os,void 0),G(this,Ws,[]),tg(e,w(this,Gt,"f"))},Pr=function(){var t;const e=(t=w(this,Gt,"f"))==null?void 0:t.response_format;return br(e)?e:null},Ql=function(e){var t,n,i,a;let r=w(this,os,"f");const{choices:o,...c}=e;r?Object.assign(r,c):r=G(this,os,{...c,choices:[]});for(const{delta:l,finish_reason:u,index:d,logprobs:p=null,...h}of e.choices){let m=r.choices[d];if(m||(m=r.choices[d]={finish_reason:u,index:d,message:{},logprobs:p,...h}),p)if(!m.logprobs)m.logprobs=Object.assign({},p);else{const{content:S,refusal:A,...Q}=p;Object.assign(m.logprobs,Q),S&&((t=m.logprobs).content??(t.content=[]),m.logprobs.content.push(...S)),A&&((n=m.logprobs).refusal??(n.refusal=[]),m.logprobs.refusal.push(...A))}if(u&&(m.finish_reason=u,w(this,Gt,"f")&&Sl(w(this,Gt,"f")))){if(u==="length")throw new Jc;if(u==="content_filter")throw new Gc}if(Object.assign(m,h),!l)continue;const{content:y,refusal:f,function_call:g,role:b,tool_calls:v,...E}=l;if(Object.assign(m.message,E),f&&(m.message.refusal=(m.message.refusal||"")+f),b&&(m.message.role=b),g&&(m.message.function_call?(g.name&&(m.message.function_call.name=g.name),g.arguments&&((i=m.message.function_call).arguments??(i.arguments=""),m.message.function_call.arguments+=g.arguments)):m.message.function_call=g),y&&(m.message.content=(m.message.content||"")+y,!m.message.refusal&&w(this,Te,"m",Pr).call(this)&&(m.message.parsed=Kl(m.message.content))),v){m.message.tool_calls||(m.message.tool_calls=[]);for(const{index:S,id:A,type:Q,function:H,...W}of v){const U=(a=m.message.tool_calls)[S]??(a[S]={});Object.assign(U,W),A&&(U.id=A),Q&&(U.type=Q),H&&(U.function??(U.function={name:H.name??"",arguments:""})),H!=null&&H.name&&(U.function.name=H.name),H!=null&&H.arguments&&(U.function.arguments+=H.arguments,Ky(w(this,Gt,"f"),U)&&(U.function.parsed_arguments=Kl(U.function.arguments)))}}}return r},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",i=>{const a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Pn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function tg(s,e){const{id:t,choices:n,created:i,model:a,system_fingerprint:r,...o}=s,c={...o,id:t,choices:n.map(({message:l,finish_reason:u,index:d,logprobs:p,...h})=>{if(!u)throw new K(`missing finish_reason for choice ${d}`);const{content:m=null,function_call:y,tool_calls:f,...g}=l,b=l.role;if(!b)throw new K(`missing role for choice ${d}`);if(y){const{arguments:v,name:E}=y;if(v==null)throw new K(`missing function_call.arguments for choice ${d}`);if(!E)throw new K(`missing function_call.name for choice ${d}`);return{...h,message:{content:m,function_call:{arguments:v,name:E},role:b,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:p}}return f?{...h,index:d,finish_reason:u,logprobs:p,message:{...g,role:b,content:m,refusal:l.refusal??null,tool_calls:f.map((v,E)=>{const{function:S,type:A,id:Q,...H}=v,{arguments:W,name:U,...me}=S||{};if(Q==null)throw new K(`missing choices[${d}].tool_calls[${E}].id
${qi(s)}`);if(A==null)throw new K(`missing choices[${d}].tool_calls[${E}].type
${qi(s)}`);if(U==null)throw new K(`missing choices[${d}].tool_calls[${E}].function.name
${qi(s)}`);if(W==null)throw new K(`missing choices[${d}].tool_calls[${E}].function.arguments
${qi(s)}`);return{...H,id:Q,type:A,function:{...me,name:U,arguments:W}}})}}:{...h,message:{...g,content:m,role:b,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:p}}),created:i,model:a,object:"chat.completion",...r?{system_fingerprint:r}:{}};return Wy(c,e)}function qi(s){return JSON.stringify(s)}class Di extends Bn{static fromReadableStream(e){const t=new Di(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,n){const i=new Di(t),a={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,a)),i}}let Sr=class extends X{constructor(){super(...arguments),this.messages=new Cl(this._client)}create(s,e){return this._client.post("/chat/completions",{body:s,...e,stream:s.stream??!1})}retrieve(s,e){return this._client.get(T`/chat/completions/${s}`,e)}update(s,e,t){return this._client.post(T`/chat/completions/${s}`,{body:e,...t})}list(s={},e){return this._client.getAPIList("/chat/completions",Ae,{query:s,...e})}delete(s,e){return this._client.delete(T`/chat/completions/${s}`,e)}parse(s,e){return Qy(s.tools),this._client.chat.completions.create(s,{...e,headers:{...e==null?void 0:e.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>_r(t,s))}runTools(s,e){return s.stream?Di.runTools(this._client,s,e):Er.runTools(this._client,s,e)}stream(s,e){return Bn.createChatCompletion(this._client,s,e)}};Sr.Messages=Cl;let Tr=class extends X{constructor(){super(...arguments),this.completions=new Sr(this._client)}};Tr.Completions=Sr;const Hl=Symbol("brand.privateNullableHeaders");function*sg(s){if(!s)return;if(Hl in s){const{values:n,nulls:i}=s;yield*n.entries();for(const a of i)yield[a,null];return}let e=!1,t;s instanceof Headers?t=s.entries():Xc(s)?t=s:(e=!0,t=Object.entries(s??{}));for(let n of t){const i=n[0];if(typeof i!="string")throw new TypeError("expected header name to be a string");const a=Xc(n[1])?n[1]:[n[1]];let r=!1;for(const o of a)o!==void 0&&(e&&!r&&(r=!0,yield[i,null]),yield[i,o])}}const Z=s=>{const e=new Headers,t=new Set;for(const n of s){const i=new Set;for(const[a,r]of sg(n)){const o=a.toLowerCase();i.has(o)||(e.delete(a),i.add(o)),r===null?(e.delete(a),t.add(o)):(e.append(a,r),t.delete(o))}}return{[Hl]:!0,values:e,nulls:t}};let Jl=class extends X{create(s,e){return this._client.post("/audio/speech",{body:s,...e,headers:Z([{Accept:"application/octet-stream"},e==null?void 0:e.headers]),__binaryResponse:!0})}},Gl=class extends X{create(s,e){return this._client.post("/audio/transcriptions",Os({body:s,...e,stream:s.stream??!1,__metadata:{model:s.model}},this._client))}},Xl=class extends X{create(s,e){return this._client.post("/audio/translations",Os({body:s,...e,__metadata:{model:s.model}},this._client))}},qn=class extends X{constructor(){super(...arguments),this.transcriptions=new Gl(this._client),this.translations=new Xl(this._client),this.speech=new Jl(this._client)}};qn.Transcriptions=Gl,qn.Translations=Xl,qn.Speech=Jl;let Yl=class extends X{create(s,e){return this._client.post("/batches",{body:s,...e})}retrieve(s,e){return this._client.get(T`/batches/${s}`,e)}list(s={},e){return this._client.getAPIList("/batches",Ae,{query:s,...e})}cancel(s,e){return this._client.post(T`/batches/${s}/cancel`,e)}};class eu extends X{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(T`/assistants/${e}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,n){return this._client.post(T`/assistants/${e}`,{body:t,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e={},t){return this._client.getAPIList("/assistants",Ae,{query:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(T`/assistants/${e}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class tu extends X{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class su extends X{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class Ui extends X{constructor(){super(...arguments),this.sessions=new tu(this._client),this.transcriptionSessions=new su(this._client)}}Ui.Sessions=tu,Ui.TranscriptionSessions=su;class nu extends X{create(e,t,n){return this._client.post(T`/threads/${e}/messages`,{body:t,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,t,n){const{thread_id:i}=t;return this._client.get(T`/threads/${i}/messages/${e}`,{...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,t,n){const{thread_id:i,...a}=t;return this._client.post(T`/threads/${i}/messages/${e}`,{body:a,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,t={},n){return this._client.getAPIList(T`/threads/${e}/messages`,Ae,{query:t,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,t,n){const{thread_id:i}=t;return this._client.delete(T`/threads/${i}/messages/${e}`,{...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}class iu extends X{retrieve(e,t,n){const{thread_id:i,run_id:a,...r}=t;return this._client.get(T`/threads/${i}/runs/${a}/steps/${e}`,{query:r,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,t,n){const{thread_id:i,...a}=t;return this._client.getAPIList(T`/threads/${i}/runs/${e}/steps`,Ae,{query:a,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}const ng=s=>{if(typeof at<"u"){const e=at.from(s,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(s),t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return Array.from(new Float32Array(n.buffer))}};var Nr={};const zs=s=>{var e,t,n,i;if(typeof globalThis.process<"u")return((e=Nr==null?void 0:Nr[s])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(i=(n=(t=globalThis.Deno.env)==null?void 0:t.get)==null?void 0:n.call(t,s))==null?void 0:i.trim()};var Fe,Es,jr,Dt,Fi,Ot,Ms,Vs,ks,Zi,lt,Wi,zi,Dn,Un,Fn,au,ru,ou,cu,lu,uu,du;class Zn extends gr{constructor(){super(...arguments),Fe.add(this),jr.set(this,[]),Dt.set(this,{}),Fi.set(this,{}),Ot.set(this,void 0),Ms.set(this,void 0),Vs.set(this,void 0),ks.set(this,void 0),Zi.set(this,void 0),lt.set(this,void 0),Wi.set(this,void 0),zi.set(this,void 0),Dn.set(this,void 0)}[(jr=new WeakMap,Dt=new WeakMap,Fi=new WeakMap,Ot=new WeakMap,Ms=new WeakMap,Vs=new WeakMap,ks=new WeakMap,Zi=new WeakMap,lt=new WeakMap,Wi=new WeakMap,zi=new WeakMap,Dn=new WeakMap,Fe=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Es;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var a;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const i=Pn.fromReadableStream(e,this.controller);for await(const r of i)w(this,Fe,"m",Un).call(this,r);if((a=i.controller.signal)!=null&&a.aborted)throw new rt;return this._addRun(w(this,Fe,"m",Fn).call(this))}toReadableStream(){return new Pn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,i){const a=new Es;return a._run(()=>a._runToolAssistantStream(e,t,n,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,i){var c;const a=i==null?void 0:i.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const r={...n,stream:!0},o=await e.submitToolOutputs(t,r,{...i,signal:this.controller.signal});this._connected();for await(const l of o)w(this,Fe,"m",Un).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new rt;return this._addRun(w(this,Fe,"m",Fn).call(this))}static createThreadAssistantStream(e,t,n){const i=new Es;return i._run(()=>i._threadAssistantStream(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}static createAssistantStream(e,t,n,i){const a=new Es;return a._run(()=>a._runAssistantStream(e,t,n,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return w(this,Wi,"f")}currentRun(){return w(this,zi,"f")}currentMessageSnapshot(){return w(this,Ot,"f")}currentRunStepSnapshot(){return w(this,Dn,"f")}async finalRunSteps(){return await this.done(),Object.values(w(this,Dt,"f"))}async finalMessages(){return await this.done(),Object.values(w(this,Fi,"f"))}async finalRun(){if(await this.done(),!w(this,Ms,"f"))throw Error("Final run was not received.");return w(this,Ms,"f")}async _createThreadAssistantStream(e,t,n){var o;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},r=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(const c of r)w(this,Fe,"m",Un).call(this,c);if((o=r.controller.signal)!=null&&o.aborted)throw new rt;return this._addRun(w(this,Fe,"m",Fn).call(this))}async _createAssistantStream(e,t,n,i){var c;const a=i==null?void 0:i.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const r={...n,stream:!0},o=await e.create(t,r,{...i,signal:this.controller.signal});this._connected();for await(const l of o)w(this,Fe,"m",Un).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new rt;return this._addRun(w(this,Fe,"m",Fn).call(this))}static accumulateDelta(e,t){for(const[n,i]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=i;continue}let a=e[n];if(a==null){e[n]=i;continue}if(n==="index"||n==="type"){e[n]=i;continue}if(typeof a=="string"&&typeof i=="string")a+=i;else if(typeof a=="number"&&typeof i=="number")a+=i;else if(lr(a)&&lr(i))a=this.accumulateDelta(a,i);else if(Array.isArray(a)&&Array.isArray(i)){if(a.every(r=>typeof r=="string"||typeof r=="number")){a.push(...i);continue}for(const r of i){if(!lr(r))throw new Error(`Expected array delta entry to be an object but got: ${r}`);const o=r.index;if(o==null)throw console.error(r),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=a[o];c==null?a.push(r):a[o]=this.accumulateDelta(c,r)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${i}, accValue: ${a}`);e[n]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,i){return await this._createAssistantStream(t,e,n,i)}async _runToolAssistantStream(e,t,n,i){return await this._createToolAssistantStream(t,e,n,i)}}Es=Zn,Un=function(s){if(!this.ended)switch(G(this,Wi,s),w(this,Fe,"m",ou).call(this,s),s.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":w(this,Fe,"m",du).call(this,s);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":w(this,Fe,"m",ru).call(this,s);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":w(this,Fe,"m",au).call(this,s);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Fn=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");if(!w(this,Ms,"f"))throw Error("Final run has not been received");return w(this,Ms,"f")},au=function(s){const[e,t]=w(this,Fe,"m",lu).call(this,s,w(this,Ot,"f"));G(this,Ot,e),w(this,Fi,"f")[e.id]=e;for(const n of t){const i=e.content[n.index];(i==null?void 0:i.type)=="text"&&this._emit("textCreated",i.text)}switch(s.event){case"thread.message.created":this._emit("messageCreated",s.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",s.data.delta,e),s.data.delta.content)for(const n of s.data.delta.content){if(n.type=="text"&&n.text){let i=n.text,a=e.content[n.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(n.index!=w(this,Vs,"f")){if(w(this,ks,"f"))switch(w(this,ks,"f").type){case"text":this._emit("textDone",w(this,ks,"f").text,w(this,Ot,"f"));break;case"image_file":this._emit("imageFileDone",w(this,ks,"f").image_file,w(this,Ot,"f"));break}G(this,Vs,n.index)}G(this,ks,e.content[n.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(w(this,Vs,"f")!==void 0){const n=s.data.content[w(this,Vs,"f")];if(n)switch(n.type){case"image_file":this._emit("imageFileDone",n.image_file,w(this,Ot,"f"));break;case"text":this._emit("textDone",n.text,w(this,Ot,"f"));break}}w(this,Ot,"f")&&this._emit("messageDone",s.data),G(this,Ot,void 0)}},ru=function(s){const e=w(this,Fe,"m",cu).call(this,s);switch(G(this,Dn,e),s.event){case"thread.run.step.created":this._emit("runStepCreated",s.data);break;case"thread.run.step.delta":const t=s.data.delta;if(t.step_details&&t.step_details.type=="tool_calls"&&t.step_details.tool_calls&&e.step_details.type=="tool_calls")for(const n of t.step_details.tool_calls)n.index==w(this,Zi,"f")?this._emit("toolCallDelta",n,e.step_details.tool_calls[n.index]):(w(this,lt,"f")&&this._emit("toolCallDone",w(this,lt,"f")),G(this,Zi,n.index),G(this,lt,e.step_details.tool_calls[n.index]),w(this,lt,"f")&&this._emit("toolCallCreated",w(this,lt,"f")));this._emit("runStepDelta",s.data.delta,e);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":G(this,Dn,void 0),s.data.step_details.type=="tool_calls"&&w(this,lt,"f")&&(this._emit("toolCallDone",w(this,lt,"f")),G(this,lt,void 0)),this._emit("runStepDone",s.data,e);break}},ou=function(s){w(this,jr,"f").push(s),this._emit("event",s)},cu=function(s){switch(s.event){case"thread.run.step.created":return w(this,Dt,"f")[s.data.id]=s.data,s.data;case"thread.run.step.delta":let e=w(this,Dt,"f")[s.data.id];if(!e)throw Error("Received a RunStepDelta before creation of a snapshot");let t=s.data;if(t.delta){const n=Es.accumulateDelta(e,t.delta);w(this,Dt,"f")[s.data.id]=n}return w(this,Dt,"f")[s.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":w(this,Dt,"f")[s.data.id]=s.data;break}if(w(this,Dt,"f")[s.data.id])return w(this,Dt,"f")[s.data.id];throw new Error("No snapshot available")},lu=function(s,e){let t=[];switch(s.event){case"thread.message.created":return[s.data,t];case"thread.message.delta":if(!e)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=s.data;if(n.delta.content)for(const i of n.delta.content)if(i.index in e.content){let a=e.content[i.index];e.content[i.index]=w(this,Fe,"m",uu).call(this,i,a)}else e.content[i.index]=i,t.push(i);return[e,t];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(e)return[e,t];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},uu=function(s,e){return Es.accumulateDelta(e,s)},du=function(s){switch(G(this,zi,s.data),s.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":G(this,Ms,s.data),w(this,lt,"f")&&(this._emit("toolCallDone",w(this,lt,"f")),G(this,lt,void 0));break}};let Rr=class extends X{constructor(){super(...arguments),this.steps=new iu(this._client)}create(s,e,t){const{include:n,...i}=e;return this._client.post(T`/threads/${s}/runs`,{query:{include:n},body:i,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}retrieve(s,e,t){const{thread_id:n}=e;return this._client.get(T`/threads/${n}/runs/${s}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(s,e,t){const{thread_id:n,...i}=e;return this._client.post(T`/threads/${n}/runs/${s}`,{body:i,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}list(s,e={},t){return this._client.getAPIList(T`/threads/${s}/runs`,Ae,{query:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}cancel(s,e,t){const{thread_id:n}=e;return this._client.post(T`/threads/${n}/runs/${s}/cancel`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}async createAndPoll(s,e,t){const n=await this.create(s,e,t);return await this.poll(n.id,{thread_id:s},t)}createAndStream(s,e,t){return Zn.createAssistantStream(s,this._client.beta.threads.runs,e,t)}async poll(s,e,t){var i;const n=Z([t==null?void 0:t.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=t==null?void 0:t.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:r}=await this.retrieve(s,e,{...t,headers:{...t==null?void 0:t.headers,...n}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(t!=null&&t.pollIntervalMs)o=t.pollIntervalMs;else{const c=r.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await An(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(s,e,t){return Zn.createAssistantStream(s,this._client.beta.threads.runs,e,t)}submitToolOutputs(s,e,t){const{thread_id:n,...i}=e;return this._client.post(T`/threads/${n}/runs/${s}/submit_tool_outputs`,{body:i,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async submitToolOutputsAndPoll(s,e,t){const n=await this.submitToolOutputs(s,e,t);return await this.poll(n.id,e,t)}submitToolOutputsStream(s,e,t){return Zn.createToolAssistantStream(s,this._client.beta.threads.runs,e,t)}};Rr.Steps=iu;class Vi extends X{constructor(){super(...arguments),this.runs=new Rr(this._client),this.messages=new nu(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(T`/threads/${e}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,n){return this._client.post(T`/threads/${e}`,{body:t,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,t){return this._client.delete(T`/threads/${e}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.id,{thread_id:n.thread_id},t)}createAndRunStream(e,t){return Zn.createThreadAssistantStream(e,this._client.beta.threads,t)}}Vi.Runs=Rr,Vi.Messages=nu;class Wn extends X{constructor(){super(...arguments),this.realtime=new Ui(this._client),this.assistants=new eu(this._client),this.threads=new Vi(this._client)}}Wn.Realtime=Ui,Wn.Assistants=eu,Wn.Threads=Vi;let pu=class extends X{create(s,e){return this._client.post("/completions",{body:s,...e,stream:s.stream??!1})}};class hu extends X{retrieve(e,t,n){const{container_id:i}=t;return this._client.get(T`/containers/${i}/files/${e}/content`,{...n,headers:Z([{Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}}let Ir=class extends X{constructor(){super(...arguments),this.content=new hu(this._client)}create(s,e,t){return this._client.post(T`/containers/${s}/files`,Os({body:e,...t},this._client))}retrieve(s,e,t){const{container_id:n}=e;return this._client.get(T`/containers/${n}/files/${s}`,t)}list(s,e={},t){return this._client.getAPIList(T`/containers/${s}/files`,Ae,{query:e,...t})}delete(s,e,t){const{container_id:n}=e;return this._client.delete(T`/containers/${n}/files/${s}`,{...t,headers:Z([{Accept:"*/*"},t==null?void 0:t.headers])})}};Ir.Content=hu;class $r extends X{constructor(){super(...arguments),this.files=new Ir(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(T`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",Ae,{query:e,...t})}delete(e,t){return this._client.delete(T`/containers/${e}`,{...t,headers:Z([{Accept:"*/*"},t==null?void 0:t.headers])})}}$r.Files=Ir;let mu=class extends X{create(s,e){const t=!!s.encoding_format;let n=t?s.encoding_format:"base64";t&&Ve(this._client).debug("embeddings/user defined encoding_format:",s.encoding_format);const i=this._client.post("/embeddings",{body:{...s,encoding_format:n},...e});return t?i:(Ve(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(r=>{const o=r.embedding;r.embedding=ng(o)}),a)))}};class fu extends X{retrieve(e,t,n){const{eval_id:i,run_id:a}=t;return this._client.get(T`/evals/${i}/runs/${a}/output_items/${e}`,n)}list(e,t,n){const{eval_id:i,...a}=t;return this._client.getAPIList(T`/evals/${i}/runs/${e}/output_items`,Ae,{query:a,...n})}}class Lr extends X{constructor(){super(...arguments),this.outputItems=new fu(this._client)}create(e,t,n){return this._client.post(T`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){const{eval_id:i}=t;return this._client.get(T`/evals/${i}/runs/${e}`,n)}list(e,t={},n){return this._client.getAPIList(T`/evals/${e}/runs`,Ae,{query:t,...n})}delete(e,t,n){const{eval_id:i}=t;return this._client.delete(T`/evals/${i}/runs/${e}`,n)}cancel(e,t,n){const{eval_id:i}=t;return this._client.post(T`/evals/${i}/runs/${e}`,n)}}Lr.OutputItems=fu;class Br extends X{constructor(){super(...arguments),this.runs=new Lr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(T`/evals/${e}`,t)}update(e,t,n){return this._client.post(T`/evals/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/evals",Ae,{query:e,...t})}delete(e,t){return this._client.delete(T`/evals/${e}`,t)}}Br.Runs=Lr;let yu=class extends X{create(s,e){return this._client.post("/files",Os({body:s,...e},this._client))}retrieve(s,e){return this._client.get(T`/files/${s}`,e)}list(s={},e){return this._client.getAPIList("/files",Ae,{query:s,...e})}delete(s,e){return this._client.delete(T`/files/${s}`,e)}content(s,e){return this._client.get(T`/files/${s}/content`,{...e,headers:Z([{Accept:"application/binary"},e==null?void 0:e.headers]),__binaryResponse:!0})}async waitForProcessing(s,{pollInterval:e=5e3,maxWait:t=30*60*1e3}={}){const n=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(s);for(;!a.status||!n.has(a.status);)if(await An(e),a=await this.retrieve(s),Date.now()-i>t)throw new Oi({message:`Giving up on waiting for file ${s} to finish processing after ${t} milliseconds.`});return a}};class gu extends X{}let bu=class extends X{run(s,e){return this._client.post("/fine_tuning/alpha/graders/run",{body:s,...e})}validate(s,e){return this._client.post("/fine_tuning/alpha/graders/validate",{body:s,...e})}};class qr extends X{constructor(){super(...arguments),this.graders=new bu(this._client)}}qr.Graders=bu;class _u extends X{create(e,t,n){return this._client.getAPIList(T`/fine_tuning/checkpoints/${e}/permissions`,Ai,{body:t,method:"post",...n})}retrieve(e,t={},n){return this._client.get(T`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}delete(e,t,n){const{fine_tuned_model_checkpoint:i}=t;return this._client.delete(T`/fine_tuning/checkpoints/${i}/permissions/${e}`,n)}}let Dr=class extends X{constructor(){super(...arguments),this.permissions=new _u(this._client)}};Dr.Permissions=_u;class vu extends X{list(e,t={},n){return this._client.getAPIList(T`/fine_tuning/jobs/${e}/checkpoints`,Ae,{query:t,...n})}}class Ur extends X{constructor(){super(...arguments),this.checkpoints=new vu(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(T`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",Ae,{query:e,...t})}cancel(e,t){return this._client.post(T`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return this._client.getAPIList(T`/fine_tuning/jobs/${e}/events`,Ae,{query:t,...n})}pause(e,t){return this._client.post(T`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(T`/fine_tuning/jobs/${e}/resume`,t)}}Ur.Checkpoints=vu;class Ks extends X{constructor(){super(...arguments),this.methods=new gu(this._client),this.jobs=new Ur(this._client),this.checkpoints=new Dr(this._client),this.alpha=new qr(this._client)}}Ks.Methods=gu,Ks.Jobs=Ur,Ks.Checkpoints=Dr,Ks.Alpha=qr;class wu extends X{}class Fr extends X{constructor(){super(...arguments),this.graderModels=new wu(this._client)}}Fr.GraderModels=wu;class xu extends X{createVariation(e,t){return this._client.post("/images/variations",Os({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",Os({body:e,...t},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}let Ou=class extends X{retrieve(s,e){return this._client.get(T`/models/${s}`,e)}list(s){return this._client.getAPIList("/models",Ai,s)}delete(s,e){return this._client.delete(T`/models/${s}`,e)}};class Eu extends X{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function ig(s,e){return!e||!rg(e)?{...s,output_parsed:null,output:s.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:Mu(s,e)}function Mu(s,e){const t=s.output.map(i=>{if(i.type==="function_call")return{...i,parsed_arguments:lg(e,i)};if(i.type==="message"){const a=i.content.map(r=>r.type==="output_text"?{...r,parsed:ag(e,r.text)}:r);return{...i,content:a}}return i}),n=Object.assign({},s,{output:t});return Object.getOwnPropertyDescriptor(s,"output_text")||Zr(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const i of n.output)if(i.type==="message"){for(const a of i.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),n}function ag(s,e){var t,n,i,a;return((n=(t=s.text)==null?void 0:t.format)==null?void 0:n.type)!=="json_schema"?null:"$parseRaw"in((i=s.text)==null?void 0:i.format)?((a=s.text)==null?void 0:a.format).$parseRaw(e):JSON.parse(e)}function rg(s){var e;return!!br((e=s.text)==null?void 0:e.format)}function og(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function cg(s,e){return s.find(t=>t.type==="function"&&t.name===e)}function lg(s,e){const t=cg(s.tools??[],e.name);return{...e,...e,parsed_arguments:og(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function Zr(s){const e=[];for(const t of s.output)if(t.type==="message")for(const n of t.content)n.type==="output_text"&&e.push(n.text);s.output_text=e.join("")}var Qs,Ki,cs,Qi,ku,Cu,Au,Pu;class Wr extends gr{constructor(e){super(),Qs.add(this),Ki.set(this,void 0),cs.set(this,void 0),Qi.set(this,void 0),G(this,Ki,e)}static createResponse(e,t,n){const i=new Wr(t);return i._run(()=>i._createOrRetrieveResponse(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createOrRetrieveResponse(e,t,n){var o;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),w(this,Qs,"m",ku).call(this);let a,r=null;"response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),r=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const c of a)w(this,Qs,"m",Cu).call(this,c,r);if((o=a.controller.signal)!=null&&o.aborted)throw new rt;return w(this,Qs,"m",Au).call(this)}[(Ki=new WeakMap,cs=new WeakMap,Qi=new WeakMap,Qs=new WeakSet,ku=function(){this.ended||G(this,cs,void 0)},Cu=function(e,t){if(this.ended)return;const n=(a,r)=>{(t==null||r.sequence_number>t)&&this._emit(a,r)},i=w(this,Qs,"m",Pu).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const a=i.output[e.output_index];if(!a)throw new K(`missing output at index ${e.output_index}`);if(a.type==="message"){const r=a.content[e.content_index];if(!r)throw new K(`missing content at index ${e.content_index}`);if(r.type!=="output_text")throw new K(`expected content to be 'output_text', got ${r.type}`);n("response.output_text.delta",{...e,snapshot:r.text})}break}case"response.function_call_arguments.delta":{const a=i.output[e.output_index];if(!a)throw new K(`missing output at index ${e.output_index}`);a.type==="function_call"&&n("response.function_call_arguments.delta",{...e,snapshot:a.arguments});break}default:n(e.type,e);break}},Au=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");const e=w(this,cs,"f");if(!e)throw new K("request ended without sending any events");G(this,cs,void 0);const t=ug(e,w(this,Ki,"f"));return G(this,Qi,t),t},Pu=function(e){let t=w(this,cs,"f");if(!t){if(e.type!=="response.created")throw new K(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=G(this,cs,e.response),t}switch(e.type){case"response.output_item.added":{t.output.push(e.item);break}case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new K(`missing output at index ${e.output_index}`);n.type==="message"&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new K(`missing output at index ${e.output_index}`);if(n.type==="message"){const i=n.content[e.content_index];if(!i)throw new K(`missing content at index ${e.content_index}`);if(i.type!=="output_text")throw new K(`expected content to be 'output_text', got ${i.type}`);i.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new K(`missing output at index ${e.output_index}`);n.type==="function_call"&&(n.arguments+=e.delta);break}case"response.completed":{G(this,cs,e.response);break}}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=w(this,Qi,"f");if(!e)throw new K("stream ended without producing a ChatCompletion");return e}}function ug(s,e){return ig(s,e)}class Su extends X{list(e,t={},n){return this._client.getAPIList(T`/responses/${e}/input_items`,Ae,{query:t,...n})}}class zr extends X{constructor(){super(...arguments),this.inputItems=new Su(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Zr(n),n))}retrieve(e,t={},n){return this._client.get(T`/responses/${e}`,{query:t,...n,stream:(t==null?void 0:t.stream)??!1})._thenUnwrap(i=>("object"in i&&i.object==="response"&&Zr(i),i))}delete(e,t){return this._client.delete(T`/responses/${e}`,{...t,headers:Z([{Accept:"*/*"},t==null?void 0:t.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>Mu(n,e))}stream(e,t){return Wr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(T`/responses/${e}/cancel`,t)}}zr.InputItems=Su;class Tu extends X{create(e,t,n){return this._client.post(T`/uploads/${e}/parts`,Os({body:t,...n},this._client))}}class Vr extends X{constructor(){super(...arguments),this.parts=new Tu(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(T`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(T`/uploads/${e}/complete`,{body:t,...n})}}Vr.Parts=Tu;const dg=async s=>{const e=await Promise.allSettled(s),t=e.filter(i=>i.status==="rejected");if(t.length){for(const i of t)console.error(i.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const n=[];for(const i of e)i.status==="fulfilled"&&n.push(i.value);return n};class Nu extends X{create(e,t,n){return this._client.post(T`/vector_stores/${e}/file_batches`,{body:t,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,t,n){const{vector_store_id:i}=t;return this._client.get(T`/vector_stores/${i}/file_batches/${e}`,{...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}cancel(e,t,n){const{vector_store_id:i}=t;return this._client.post(T`/vector_stores/${i}/file_batches/${e}/cancel`,{...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async createAndPoll(e,t,n){const i=await this.create(e,t);return await this.poll(e,i.id,n)}listFiles(e,t,n){const{vector_store_id:i,...a}=t;return this._client.getAPIList(T`/vector_stores/${i}/file_batches/${e}/files`,Ae,{query:a,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async poll(e,t,n){var a;const i=Z([n==null?void 0:n.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((a=n==null?void 0:n.pollIntervalMs)==null?void 0:a.toString())??void 0}]);for(;;){const{data:r,response:o}=await this.retrieve(t,{vector_store_id:e},{...n,headers:i}).withResponse();switch(r.status){case"in_progress":let c=5e3;if(n!=null&&n.pollIntervalMs)c=n.pollIntervalMs;else{const l=o.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await An(c);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},i){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(i==null?void 0:i.maxConcurrency)??5,r=Math.min(a,t.length),o=this._client,c=t.values(),l=[...n];async function u(p){for(let h of p){const m=await o.files.create({file:h,purpose:"assistants"},i);l.push(m.id)}}const d=Array(r).fill(c).map(u);return await dg(d),await this.createAndPoll(e,{file_ids:l})}}let ju=class extends X{create(s,e,t){return this._client.post(T`/vector_stores/${s}/files`,{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(s,e,t){const{vector_store_id:n}=e;return this._client.get(T`/vector_stores/${n}/files/${s}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(s,e,t){const{vector_store_id:n,...i}=e;return this._client.post(T`/vector_stores/${n}/files/${s}`,{body:i,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}list(s,e={},t){return this._client.getAPIList(T`/vector_stores/${s}/files`,Ae,{query:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(s,e,t){const{vector_store_id:n}=e;return this._client.delete(T`/vector_stores/${n}/files/${s}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}async createAndPoll(s,e,t){const n=await this.create(s,e,t);return await this.poll(s,n.id,t)}async poll(s,e,t){var i;const n=Z([t==null?void 0:t.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=t==null?void 0:t.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const a=await this.retrieve(e,{vector_store_id:s},{...t,headers:n}).withResponse(),r=a.data;switch(r.status){case"in_progress":let o=5e3;if(t!=null&&t.pollIntervalMs)o=t.pollIntervalMs;else{const c=a.response.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await An(o);break;case"failed":case"completed":return r}}}async upload(s,e,t){const n=await this._client.files.create({file:e,purpose:"assistants"},t);return this.create(s,{file_id:n.id},t)}async uploadAndPoll(s,e,t){const n=await this.upload(s,e,t);return await this.poll(s,n.id,t)}content(s,e,t){const{vector_store_id:n}=e;return this._client.getAPIList(T`/vector_stores/${n}/files/${s}/content`,Ai,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};class Hi extends X{constructor(){super(...arguments),this.files=new ju(this._client),this.fileBatches=new Nu(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(T`/vector_stores/${e}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,n){return this._client.post(T`/vector_stores/${e}`,{body:t,...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",Ae,{query:e,...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(T`/vector_stores/${e}`,{...t,headers:Z([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}search(e,t,n){return this._client.getAPIList(T`/vector_stores/${e}/search`,Ai,{body:t,method:"post",...n,headers:Z([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}Hi.Files=ju,Hi.FileBatches=Nu;var Hs,Ru,Ji;class Iu extends X{constructor(){super(...arguments),Hs.add(this)}async unwrap(e,t,n=this._client.webhookSecret,i=300){return await this.verifySignature(e,t,n,i),JSON.parse(e)}async verifySignature(e,t,n=this._client.webhookSecret,i=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");w(this,Hs,"m",Ru).call(this,n);const a=Z([t]).values,r=w(this,Hs,"m",Ji).call(this,a,"webhook-signature"),o=w(this,Hs,"m",Ji).call(this,a,"webhook-timestamp"),c=w(this,Hs,"m",Ji).call(this,a,"webhook-id"),l=parseInt(o,10);if(isNaN(l))throw new Cn("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-l>i)throw new Cn("Webhook timestamp is too old");if(l>u+i)throw new Cn("Webhook timestamp is too new");const d=r.split(" ").map(y=>y.startsWith("v1,")?y.substring(3):y),p=n.startsWith("whsec_")?at.from(n.replace("whsec_",""),"base64"):at.from(n,"utf-8"),h=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",p,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const y of d)try{const f=at.from(y,"base64");if(await crypto.subtle.verify("HMAC",m,f,new TextEncoder().encode(h)))return}catch{continue}throw new Cn("The given webhook signature does not match the expected signature")}}Hs=new WeakSet,Ru=function(s){if(typeof s!="string"||s.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Ji=function(s,e){if(!s)throw new Error("Headers are required");const t=s.get(e);if(t==null)throw new Error(`Missing required header: ${e}`);return t};var Kr,Qr,Gi,$u;ae=class{constructor({baseURL:s=zs("OPENAI_BASE_URL"),apiKey:e=zs("OPENAI_API_KEY"),organization:t=zs("OPENAI_ORG_ID")??null,project:n=zs("OPENAI_PROJECT_ID")??null,webhookSecret:i=zs("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Kr.add(this),Gi.set(this,void 0),this.completions=new pu(this),this.chat=new Tr(this),this.embeddings=new mu(this),this.files=new yu(this),this.images=new xu(this),this.audio=new qn(this),this.moderations=new Eu(this),this.models=new Ou(this),this.fineTuning=new Ks(this),this.graders=new Fr(this),this.vectorStores=new Hi(this),this.webhooks=new Iu(this),this.beta=new Wn(this),this.batches=new Yl(this),this.uploads=new Vr(this),this.responses=new zr(this),this.evals=new Br(this),this.containers=new $r(this),e===void 0)throw new K("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const r={apiKey:e,organization:t,project:n,webhookSecret:i,...a,baseURL:s||"https://api.openai.com/v1"};if(!r.dangerouslyAllowBrowser&&dy())throw new K(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=r.baseURL,this.timeout=r.timeout??Qr.DEFAULT_TIMEOUT,this.logger=r.logger??console;const o="warn";this.logLevel=o,this.logLevel=yl(r.logLevel,"ClientOptions.logLevel",this)??yl(zs("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=r.fetchOptions,this.maxRetries=r.maxRetries??2,this.fetch=r.fetch??yy(),G(this,Gi,by),this._options=r,this.apiKey=e,this.organization=t,this.project=n,this.webhookSecret=i}withOptions(s){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...s})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:s,nulls:e}){}authHeaders(s){return Z([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(s){return Ey(s,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Fs}`}defaultIdempotencyKey(){return`stainless-node-retry-${Uc()}`}makeStatusError(s,e,t,n){return Ye.generate(s,e,t,n)}buildURL(s,e,t){const n=!w(this,Kr,"m",$u).call(this)&&t||this.baseURL,i=ay(s)?new URL(s):new URL(n+(n.endsWith("/")&&s.startsWith("/")?s.slice(1):s)),a=this.defaultQuery();return oy(a)||(e={...a,...e}),typeof e=="object"&&e&&!Array.isArray(e)&&(i.search=this.stringifyQuery(e)),i.toString()}async prepareOptions(s){}async prepareRequest(s,{url:e,options:t}){}get(s,e){return this.methodRequest("get",s,e)}post(s,e){return this.methodRequest("post",s,e)}patch(s,e){return this.methodRequest("patch",s,e)}put(s,e){return this.methodRequest("put",s,e)}delete(s,e){return this.methodRequest("delete",s,e)}methodRequest(s,e,t){return this.request(Promise.resolve(t).then(n=>({method:s,path:e,...n})))}request(s,e=null){return new vl(this,this.makeRequest(s,e,void 0))}async makeRequest(s,e,t){var f,g;const n=await s,i=n.maxRetries??this.maxRetries;e==null&&(e=i),await this.prepareOptions(n);const{req:a,url:r,timeout:o}=this.buildRequest(n,{retryCount:i-e});await this.prepareRequest(a,{url:r,options:n});const c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),l=t===void 0?"":`, retryOf: ${t}`,u=Date.now();if(Ve(this).debug(`[${c}] sending request`,xs({retryOfRequestLogID:t,method:n.method,url:r,options:n,headers:a.headers})),(f=n.signal)==null?void 0:f.aborted)throw new rt;const d=new AbortController,p=await this.fetchWithTimeout(r,a,o,d).catch(cr),h=Date.now();if(p instanceof Error){const b=`retrying, ${e} attempts remaining`;if((g=n.signal)!=null&&g.aborted)throw new rt;const v=or(p)||/timed? ?out/i.test(String(p)+("cause"in p?String(p.cause):""));if(e)return Ve(this).info(`[${c}] connection ${v?"timed out":"failed"} - ${b}`),Ve(this).debug(`[${c}] connection ${v?"timed out":"failed"} (${b})`,xs({retryOfRequestLogID:t,url:r,durationMs:h-u,message:p.message})),this.retryRequest(n,e,t??c);throw Ve(this).info(`[${c}] connection ${v?"timed out":"failed"} - error; no more retries left`),Ve(this).debug(`[${c}] connection ${v?"timed out":"failed"} (error; no more retries left)`,xs({retryOfRequestLogID:t,url:r,durationMs:h-u,message:p.message})),v?new Oi:new xi({cause:p})}const m=[...p.headers.entries()].filter(([b])=>b==="x-request-id").map(([b,v])=>", "+b+": "+JSON.stringify(v)).join(""),y=`[${c}${l}${m}] ${a.method} ${r} ${p.ok?"succeeded":"failed"} with status ${p.status} in ${h-u}ms`;if(!p.ok){const b=this.shouldRetry(p);if(e&&b){const Q=`retrying, ${e} attempts remaining`;return await gy(p.body),Ve(this).info(`${y} - ${Q}`),Ve(this).debug(`[${c}] response error (${Q})`,xs({retryOfRequestLogID:t,url:p.url,status:p.status,headers:p.headers,durationMs:h-u})),this.retryRequest(n,e,t??c,p.headers)}const v=b?"error; no more retries left":"error; not retryable";Ve(this).info(`${y} - ${v}`);const E=await p.text().catch(Q=>cr(Q).message),S=uy(E),A=S?void 0:E;throw Ve(this).debug(`[${c}] response error (${v})`,xs({retryOfRequestLogID:t,url:p.url,status:p.status,headers:p.headers,message:A,durationMs:Date.now()-u})),this.makeStatusError(p.status,S,A,p.headers)}return Ve(this).info(y),Ve(this).debug(`[${c}] response start`,xs({retryOfRequestLogID:t,url:p.url,status:p.status,headers:p.headers,durationMs:h-u})),{response:p,options:n,controller:d,requestLogID:c,retryOfRequestLogID:t,startTime:u}}getAPIList(s,e,t){return this.requestAPIList(e,{method:"get",path:s,...t})}requestAPIList(s,e){const t=this.makeRequest(e,null,void 0);return new jy(this,t,s)}async fetchWithTimeout(s,e,t,n){const{signal:i,method:a,...r}=e||{};i&&i.addEventListener("abort",()=>n.abort());const o=setTimeout(()=>n.abort(),t),c=globalThis.ReadableStream&&r.body instanceof globalThis.ReadableStream||typeof r.body=="object"&&r.body!==null&&Symbol.asyncIterator in r.body,l={signal:n.signal,...c?{duplex:"half"}:{},method:"GET",...r};a&&(l.method=a.toUpperCase());try{return await this.fetch.call(void 0,s,l)}finally{clearTimeout(o)}}shouldRetry(s){const e=s.headers.get("x-should-retry");return e==="true"?!0:e==="false"?!1:s.status===408||s.status===409||s.status===429||s.status>=500}async retryRequest(s,e,t,n){let i;const a=n==null?void 0:n.get("retry-after-ms");if(a){const o=parseFloat(a);Number.isNaN(o)||(i=o)}const r=n==null?void 0:n.get("retry-after");if(r&&!i){const o=parseFloat(r);Number.isNaN(o)?i=Date.parse(r)-Date.now():i=o*1e3}if(!(i&&0<=i&&i<60*1e3)){const o=s.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(e,o)}return await An(i),this.makeRequest(s,e-1,t)}calculateDefaultRetryTimeoutMillis(s,e){const t=e-s,n=Math.min(.5*Math.pow(2,t),8),i=1-Math.random()*.25;return n*i*1e3}buildRequest(s,{retryCount:e=0}={}){const t={...s},{method:n,path:i,query:a,defaultBaseURL:r}=t,o=this.buildURL(i,a,r);"timeout"in t&&ly("timeout",t.timeout),t.timeout=t.timeout??this.timeout;const{bodyHeaders:c,body:l}=this.buildBody({options:t}),u=this.buildHeaders({options:s,method:n,bodyHeaders:c,retryCount:e});return{req:{method:n,headers:u,...t.signal&&{signal:t.signal},...globalThis.ReadableStream&&l instanceof globalThis.ReadableStream&&{duplex:"half"},...l&&{body:l},...this.fetchOptions??{},...t.fetchOptions??{}},url:o,timeout:t.timeout}}buildHeaders({options:s,method:e,bodyHeaders:t,retryCount:n}){let i={};this.idempotencyHeader&&e!=="get"&&(s.idempotencyKey||(s.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=s.idempotencyKey);const a=Z([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...s.timeout?{"X-Stainless-Timeout":String(Math.trunc(s.timeout/1e3))}:{},...fy(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},this.authHeaders(s),this._options.defaultHeaders,t,s.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:s,headers:e}}){if(!s)return{bodyHeaders:void 0,body:void 0};const t=Z([e]);return ArrayBuffer.isView(s)||s instanceof ArrayBuffer||s instanceof DataView||typeof s=="string"&&t.values.has("content-type")||s instanceof Blob||s instanceof FormData||s instanceof URLSearchParams||globalThis.ReadableStream&&s instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:s}:typeof s=="object"&&(Symbol.asyncIterator in s||Symbol.iterator in s&&"next"in s&&typeof s.next=="function")?{bodyHeaders:void 0,body:nl(s)}:w(this,Gi,"f").call(this,{body:s,headers:t})}},Qr=ae,Gi=new WeakMap,Kr=new WeakSet,$u=function(){return this.baseURL!=="https://api.openai.com/v1"},ae.OpenAI=Qr,ae.DEFAULT_TIMEOUT=6e5,ae.OpenAIError=K,ae.APIError=Ye,ae.APIConnectionError=xi,ae.APIConnectionTimeoutError=Oi,ae.APIUserAbortError=rt,ae.NotFoundError=zc,ae.ConflictError=Vc,ae.RateLimitError=Qc,ae.BadRequestError=Fc,ae.AuthenticationError=Zc,ae.InternalServerError=Hc,ae.PermissionDeniedError=Wc,ae.UnprocessableEntityError=Kc,ae.InvalidWebhookSignatureError=Cn,ae.toFile=qy,ae.Completions=pu,ae.Chat=Tr,ae.Embeddings=mu,ae.Files=yu,ae.Images=xu,ae.Audio=qn,ae.Moderations=Eu,ae.Models=Ou,ae.FineTuning=Ks,ae.Graders=Fr,ae.VectorStores=Hi,ae.Webhooks=Iu,ae.Beta=Wn,ae.Batches=Yl,ae.Uploads=Vr,ae.Responses=zr,ae.Evals=Br,ae.Containers=$r;function pg(s,e,t){function n(o,c){var l;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(l=o._zod).traits??(l.traits=new Set),o._zod.traits.add(s),e(o,c);for(const u in r.prototype)u in o||Object.defineProperty(o,u,{value:r.prototype[u].bind(o)});o._zod.constr=r,o._zod.def=c}const i=(t==null?void 0:t.Parent)??Object;class a extends i{}Object.defineProperty(a,"name",{value:s});function r(o){var c;const l=t!=null&&t.Parent?new a:this;n(l,o),(c=l._zod).deferred??(c.deferred=[]);for(const u of l._zod.deferred)u();return l}return Object.defineProperty(r,"init",{value:n}),Object.defineProperty(r,Symbol.hasInstance,{value:o=>{var c,l;return t!=null&&t.Parent&&o instanceof t.Parent?!0:(l=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:l.has(s)}}),Object.defineProperty(r,"name",{value:s}),r}class hg extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const mg={};function fg(s){return mg}function yg(s){const e=Object.values(s).filter(t=>typeof t=="number");return Object.entries(s).filter(([t,n])=>e.indexOf(+t)===-1).map(([t,n])=>n)}function gg(s,e){return typeof e=="bigint"?e.toString():e}const bg=Error.captureStackTrace?Error.captureStackTrace:(...s)=>{};function Xi(s){return typeof s=="string"?s:s==null?void 0:s.message}function _g(s,e,t){var i,a,r,o,c,l;const n={...s,path:s.path??[]};if(!s.message){const u=Xi((r=(a=(i=s.inst)==null?void 0:i._zod.def)==null?void 0:a.error)==null?void 0:r.call(a,s))??Xi((o=e==null?void 0:e.error)==null?void 0:o.call(e,s))??Xi((c=t.customError)==null?void 0:c.call(t,s))??Xi((l=t.localeError)==null?void 0:l.call(t,s))??"Invalid input";n.message=u}return delete n.inst,delete n.continue,e!=null&&e.reportInput||delete n.input,n}const vg=(s,e)=>{s.name="$ZodError",Object.defineProperty(s,"_zod",{value:s._zod,enumerable:!1}),Object.defineProperty(s,"issues",{value:e,enumerable:!1}),Object.defineProperty(s,"message",{get(){return JSON.stringify(e,gg,2)},enumerable:!0})},wg=pg("$ZodError",vg,{Parent:Error}),xg=s=>(e,t,n,i)=>{const a=n?Object.assign(n,{async:!1}):{async:!1},r=e._zod.run({value:t,issues:[]},a);if(r instanceof Promise)throw new hg;if(r.issues.length){const o=new((i==null?void 0:i.Err)??s)(r.issues.map(c=>_g(c,a,fg())));throw bg(o,i==null?void 0:i.callee),o}return r.value},Og=xg(wg);class Lu{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}remove(e){return this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function Eg(){return new Lu}const Mg=Eg();class Bu{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??Mg,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var u,d,p;var n;const i=e._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},r=this.seen.get(e);if(r)return r.count++,t.schemaPath.includes(e)&&(r.cycle=t.path),r.schema;const o={schema:{},count:1,cycle:void 0};this.seen.set(e,o);const c=(d=(u=e._zod).toJSONSchema)==null?void 0:d.call(u);if(c)o.schema=c;else{const h={...t,schemaPath:[...t.schemaPath,e],path:t.path},m=e._zod.parent;if(m)o.ref=m,this.process(m,h),this.seen.get(m).isParent=!0;else{const y=o.schema;switch(i.type){case"string":{const f=y;f.type="string";const{minimum:g,maximum:b,format:v,patterns:E,contentEncoding:S}=e._zod.bag;if(typeof g=="number"&&(f.minLength=g),typeof b=="number"&&(f.maxLength=b),v&&(f.format=a[v]??v,f.format===""&&delete f.format),S&&(f.contentEncoding=S),E&&E.size>0){const A=[...E];A.length===1?f.pattern=A[0].source:A.length>1&&(o.schema.allOf=[...A.map(Q=>({...this.target==="draft-7"?{type:"string"}:{},pattern:Q.source}))])}break}case"number":{const f=y,{minimum:g,maximum:b,format:v,multipleOf:E,exclusiveMaximum:S,exclusiveMinimum:A}=e._zod.bag;typeof v=="string"&&v.includes("int")?f.type="integer":f.type="number",typeof A=="number"&&(f.exclusiveMinimum=A),typeof g=="number"&&(f.minimum=g,typeof A=="number"&&(A>=g?delete f.minimum:delete f.exclusiveMinimum)),typeof S=="number"&&(f.exclusiveMaximum=S),typeof b=="number"&&(f.maximum=b,typeof S=="number"&&(S<=b?delete f.maximum:delete f.exclusiveMaximum)),typeof E=="number"&&(f.multipleOf=E);break}case"boolean":{const f=y;f.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"undefined":{const f=y;f.type="null";break}case"null":{y.type="null";break}case"any":break;case"unknown":break;case"never":{y.not={};break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const f=y,{minimum:g,maximum:b}=e._zod.bag;typeof g=="number"&&(f.minItems=g),typeof b=="number"&&(f.maxItems=b),f.type="array",f.items=this.process(i.element,{...h,path:[...h.path,"items"]});break}case"object":{const f=y;f.type="object",f.properties={};const g=i.shape;for(const E in g)f.properties[E]=this.process(g[E],{...h,path:[...h.path,"properties",E]});const b=new Set(Object.keys(g)),v=new Set([...b].filter(E=>{const S=i.shape[E]._zod;return this.io==="input"?S.optin===void 0:S.optout===void 0}));v.size>0&&(f.required=Array.from(v)),((p=i.catchall)==null?void 0:p._zod.def.type)==="never"?f.additionalProperties=!1:i.catchall?i.catchall&&(f.additionalProperties=this.process(i.catchall,{...h,path:[...h.path,"additionalProperties"]})):this.io==="output"&&(f.additionalProperties=!1);break}case"union":{const f=y;f.anyOf=i.options.map((g,b)=>this.process(g,{...h,path:[...h.path,"anyOf",b]}));break}case"intersection":{const f=y,g=this.process(i.left,{...h,path:[...h.path,"allOf",0]}),b=this.process(i.right,{...h,path:[...h.path,"allOf",1]}),v=S=>"allOf"in S&&Object.keys(S).length===1,E=[...v(g)?g.allOf:[g],...v(b)?b.allOf:[b]];f.allOf=E;break}case"tuple":{const f=y;f.type="array";const g=i.items.map((E,S)=>this.process(E,{...h,path:[...h.path,"prefixItems",S]}));if(this.target==="draft-2020-12"?f.prefixItems=g:f.items=g,i.rest){const E=this.process(i.rest,{...h,path:[...h.path,"items"]});this.target==="draft-2020-12"?f.items=E:f.additionalItems=E}i.rest&&(f.items=this.process(i.rest,{...h,path:[...h.path,"items"]}));const{minimum:b,maximum:v}=e._zod.bag;typeof b=="number"&&(f.minItems=b),typeof v=="number"&&(f.maxItems=v);break}case"record":{const f=y;f.type="object",f.propertyNames=this.process(i.keyType,{...h,path:[...h.path,"propertyNames"]}),f.additionalProperties=this.process(i.valueType,{...h,path:[...h.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const f=y,g=yg(i.entries);g.every(b=>typeof b=="number")&&(f.type="number"),g.every(b=>typeof b=="string")&&(f.type="string"),f.enum=g;break}case"literal":{const f=y,g=[];for(const b of i.values)if(b===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof b=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");g.push(Number(b))}else g.push(b);if(g.length!==0)if(g.length===1){const b=g[0];f.type=b===null?"null":typeof b,f.const=b}else g.every(b=>typeof b=="number")&&(f.type="number"),g.every(b=>typeof b=="string")&&(f.type="string"),g.every(b=>typeof b=="boolean")&&(f.type="string"),g.every(b=>b===null)&&(f.type="null"),f.enum=g;break}case"file":{const f=y,g={type:"string",format:"binary",contentEncoding:"binary"},{minimum:b,maximum:v,mime:E}=e._zod.bag;b!==void 0&&(g.minLength=b),v!==void 0&&(g.maxLength=v),E?E.length===1?(g.contentMediaType=E[0],Object.assign(f,g)):f.anyOf=E.map(S=>({...g,contentMediaType:S})):Object.assign(f,g);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const f=this.process(i.innerType,h);y.anyOf=[f,{type:"null"}];break}case"nonoptional":{this.process(i.innerType,h),o.ref=i.innerType;break}case"success":{const f=y;f.type="boolean";break}case"default":{this.process(i.innerType,h),o.ref=i.innerType,y.default=JSON.parse(JSON.stringify(i.defaultValue));break}case"prefault":{this.process(i.innerType,h),o.ref=i.innerType,this.io==="input"&&(y._prefault=JSON.parse(JSON.stringify(i.defaultValue)));break}case"catch":{this.process(i.innerType,h),o.ref=i.innerType;let f;try{f=i.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}y.default=f;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const f=y,g=e._zod.pattern;if(!g)throw new Error("Pattern not found in template literal");f.type="string",f.pattern=g.source;break}case"pipe":{const f=this.io==="input"?i.in._zod.def.type==="transform"?i.out:i.in:i.out;this.process(f,h),o.ref=f;break}case"readonly":{this.process(i.innerType,h),o.ref=i.innerType,y.readOnly=!0;break}case"promise":{this.process(i.innerType,h),o.ref=i.innerType;break}case"optional":{this.process(i.innerType,h),o.ref=i.innerType;break}case"lazy":{const f=e._zod.innerType;this.process(f,h),o.ref=f;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const l=this.metadataRegistry.get(e);return l&&Object.assign(o.schema,l),this.io==="input"&&Ne(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){var u,d,p,h;const n={cycles:(t==null?void 0:t.cycles)??"ref",reused:(t==null?void 0:t.reused)??"inline",external:(t==null?void 0:t.external)??void 0},i=this.seen.get(e);if(!i)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=m=>{var b;const y=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const v=(b=n.external.registry.get(m[0]))==null?void 0:b.id;if(v)return{ref:n.external.uri(v)};const E=m[1].defId??m[1].schema.id??`schema${this.counter++}`;return m[1].defId=E,{defId:E,ref:`${n.external.uri("__shared")}#/${y}/${E}`}}if(m[1]===i)return{ref:"#"};const f=`#/${y}/`,g=m[1].schema.id??`__schema${this.counter++}`;return{defId:g,ref:f+g}},r=m=>{if(m[1].schema.$ref)return;const y=m[1],{ref:f,defId:g}=a(m);y.def={...y.schema},g&&(y.defId=g);const b=y.schema;for(const v in b)delete b[v];b.$ref=f};for(const m of this.seen.entries()){const y=m[1];if(e===m[0]){r(m);continue}if(n.external){const f=(u=n.external.registry.get(m[0]))==null?void 0:u.id;if(e!==m[0]&&f){r(m);continue}}if((d=this.metadataRegistry.get(m[0]))!=null&&d.id){r(m);continue}if(y.cycle){if(n.cycles==="throw")throw new Error(`Cycle detected: #/${(p=y.cycle)==null?void 0:p.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`);n.cycles==="ref"&&r(m);continue}if(y.count>1&&n.reused==="ref"){r(m);continue}}const o=(m,y)=>{const f=this.seen.get(m),g=f.def??f.schema,b={...g};if(f.ref===null)return;const v=f.ref;if(f.ref=null,v){o(v,y);const E=this.seen.get(v).schema;E.$ref&&y.target==="draft-7"?(g.allOf=g.allOf??[],g.allOf.push(E)):(Object.assign(g,E),Object.assign(g,b))}f.isParent||this.override({zodSchema:m,jsonSchema:g})};for(const m of[...this.seen.entries()].reverse())o(m[0],{target:this.target});const c={};this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),Object.assign(c,i.def);const l=((h=n.external)==null?void 0:h.defs)??{};for(const m of this.seen.entries()){const y=m[1];y.def&&y.defId&&(l[y.defId]=y.def)}!n.external&&Object.keys(l).length>0&&(this.target==="draft-2020-12"?c.$defs=l:c.definitions=l);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function kg(s,e){if(s instanceof Lu){const n=new Bu(e),i={};for(const o of s._idmap.entries()){const[c,l]=o;n.process(l)}const a={},r={registry:s,uri:(e==null?void 0:e.uri)||(o=>o),defs:i};for(const o of s._idmap.entries()){const[c,l]=o;a[c]=n.emit(l,{...e,external:r})}if(Object.keys(i).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";a.__shared={[o]:i}}return{schemas:a}}const t=new Bu(e);return t.process(s),t.emit(s,e)}function Ne(s,e){const t=e??{seen:new Set};if(t.seen.has(s))return!1;t.seen.add(s);const n=s._zod.def;switch(n.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Ne(n.element,t);case"object":{for(const i in n.shape)if(Ne(n.shape[i],t))return!0;return!1}case"union":{for(const i of n.options)if(Ne(i,t))return!0;return!1}case"intersection":return Ne(n.left,t)||Ne(n.right,t);case"tuple":{for(const i of n.items)if(Ne(i,t))return!0;return!!(n.rest&&Ne(n.rest,t))}case"record":return Ne(n.keyType,t)||Ne(n.valueType,t);case"map":return Ne(n.keyType,t)||Ne(n.valueType,t);case"set":return Ne(n.valueType,t);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Ne(n.innerType,t);case"lazy":return Ne(n.getter(),t);case"default":return Ne(n.innerType,t);case"prefault":return Ne(n.innerType,t);case"custom":return!1;case"transform":return!0;case"pipe":return Ne(n.in,t)||Ne(n.out,t);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${n.type}`)}var Cg=typeof window=="object"?window:{},ie="0123456789abcdef".split(""),Ag=[-2147483648,8388608,32768,128],Et=[24,16,8,0],Le=[];function Mt(s){s?(Le[0]=Le[16]=Le[1]=Le[2]=Le[3]=Le[4]=Le[5]=Le[6]=Le[7]=Le[8]=Le[9]=Le[10]=Le[11]=Le[12]=Le[13]=Le[14]=Le[15]=0,this.blocks=Le):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Mt.prototype.update=function(s){if(!this.finalized){var e=typeof s!="string";e&&s.constructor===Cg.ArrayBuffer&&(s=new Uint8Array(s));for(var t,n=0,i,a=s.length||0,r=this.blocks;n<a;){if(this.hashed&&(this.hashed=!1,r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),e)for(i=this.start;n<a&&i<64;++n)r[i>>2]|=s[n]<<Et[i++&3];else for(i=this.start;n<a&&i<64;++n)t=s.charCodeAt(n),t<128?r[i>>2]|=t<<Et[i++&3]:t<2048?(r[i>>2]|=(192|t>>6)<<Et[i++&3],r[i>>2]|=(128|t&63)<<Et[i++&3]):t<55296||t>=57344?(r[i>>2]|=(224|t>>12)<<Et[i++&3],r[i>>2]|=(128|t>>6&63)<<Et[i++&3],r[i>>2]|=(128|t&63)<<Et[i++&3]):(t=65536+((t&1023)<<10|s.charCodeAt(++n)&1023),r[i>>2]|=(240|t>>18)<<Et[i++&3],r[i>>2]|=(128|t>>12&63)<<Et[i++&3],r[i>>2]|=(128|t>>6&63)<<Et[i++&3],r[i>>2]|=(128|t&63)<<Et[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=r[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Mt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var s=this.blocks,e=this.lastByteIndex;s[16]=this.block,s[e>>2]|=Ag[e&3],this.block=s[16],e>=56&&(this.hashed||this.hash(),s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),s[14]=this.hBytes<<3|this.bytes>>>29,s[15]=this.bytes<<3,this.hash()}},Mt.prototype.hash=function(){var s=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4,a,r,o,c=this.blocks;for(r=16;r<80;++r)o=c[r-3]^c[r-8]^c[r-14]^c[r-16],c[r]=o<<1|o>>>31;for(r=0;r<20;r+=5)a=e&t|~e&n,o=s<<5|s>>>27,i=o+a+i+1518500249+c[r]<<0,e=e<<30|e>>>2,a=s&e|~s&t,o=i<<5|i>>>27,n=o+a+n+1518500249+c[r+1]<<0,s=s<<30|s>>>2,a=i&s|~i&e,o=n<<5|n>>>27,t=o+a+t+1518500249+c[r+2]<<0,i=i<<30|i>>>2,a=n&i|~n&s,o=t<<5|t>>>27,e=o+a+e+1518500249+c[r+3]<<0,n=n<<30|n>>>2,a=t&n|~t&i,o=e<<5|e>>>27,s=o+a+s+1518500249+c[r+4]<<0,t=t<<30|t>>>2;for(;r<40;r+=5)a=e^t^n,o=s<<5|s>>>27,i=o+a+i+1859775393+c[r]<<0,e=e<<30|e>>>2,a=s^e^t,o=i<<5|i>>>27,n=o+a+n+1859775393+c[r+1]<<0,s=s<<30|s>>>2,a=i^s^e,o=n<<5|n>>>27,t=o+a+t+1859775393+c[r+2]<<0,i=i<<30|i>>>2,a=n^i^s,o=t<<5|t>>>27,e=o+a+e+1859775393+c[r+3]<<0,n=n<<30|n>>>2,a=t^n^i,o=e<<5|e>>>27,s=o+a+s+1859775393+c[r+4]<<0,t=t<<30|t>>>2;for(;r<60;r+=5)a=e&t|e&n|t&n,o=s<<5|s>>>27,i=o+a+i-1894007588+c[r]<<0,e=e<<30|e>>>2,a=s&e|s&t|e&t,o=i<<5|i>>>27,n=o+a+n-1894007588+c[r+1]<<0,s=s<<30|s>>>2,a=i&s|i&e|s&e,o=n<<5|n>>>27,t=o+a+t-1894007588+c[r+2]<<0,i=i<<30|i>>>2,a=n&i|n&s|i&s,o=t<<5|t>>>27,e=o+a+e-1894007588+c[r+3]<<0,n=n<<30|n>>>2,a=t&n|t&i|n&i,o=e<<5|e>>>27,s=o+a+s-1894007588+c[r+4]<<0,t=t<<30|t>>>2;for(;r<80;r+=5)a=e^t^n,o=s<<5|s>>>27,i=o+a+i-899497514+c[r]<<0,e=e<<30|e>>>2,a=s^e^t,o=i<<5|i>>>27,n=o+a+n-899497514+c[r+1]<<0,s=s<<30|s>>>2,a=i^s^e,o=n<<5|n>>>27,t=o+a+t-899497514+c[r+2]<<0,i=i<<30|i>>>2,a=n^i^s,o=t<<5|t>>>27,e=o+a+e-899497514+c[r+3]<<0,n=n<<30|n>>>2,a=t^n^i,o=e<<5|e>>>27,s=o+a+s-899497514+c[r+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+s<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+i<<0},Mt.prototype.hex=function(){this.finalize();var s=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4;return ie[s>>28&15]+ie[s>>24&15]+ie[s>>20&15]+ie[s>>16&15]+ie[s>>12&15]+ie[s>>8&15]+ie[s>>4&15]+ie[s&15]+ie[e>>28&15]+ie[e>>24&15]+ie[e>>20&15]+ie[e>>16&15]+ie[e>>12&15]+ie[e>>8&15]+ie[e>>4&15]+ie[e&15]+ie[t>>28&15]+ie[t>>24&15]+ie[t>>20&15]+ie[t>>16&15]+ie[t>>12&15]+ie[t>>8&15]+ie[t>>4&15]+ie[t&15]+ie[n>>28&15]+ie[n>>24&15]+ie[n>>20&15]+ie[n>>16&15]+ie[n>>12&15]+ie[n>>8&15]+ie[n>>4&15]+ie[n&15]+ie[i>>28&15]+ie[i>>24&15]+ie[i>>20&15]+ie[i>>16&15]+ie[i>>12&15]+ie[i>>8&15]+ie[i>>4&15]+ie[i&15]},Mt.prototype.toString=Mt.prototype.hex,Mt.prototype.digest=function(){this.finalize();var s=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4;return[s>>24&255,s>>16&255,s>>8&255,s&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,i>>24&255,i>>16&255,i>>8&255,i&255]},Mt.prototype.array=Mt.prototype.digest,Mt.prototype.arrayBuffer=function(){this.finalize();var s=new ArrayBuffer(20),e=new DataView(s);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),s};let qu=!1;const Pg=s=>(qu||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","\u2514> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),qu=!0),new Mt(!0).update(s).hex()),Sg=(...s)=>Pg(s.join("_"));class Tg{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:Sg})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}const Ng=new Map;class Hr extends Tg{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,n){this.cache.set(this.keyEncoder(e,t),n)}static global(){return new Hr(Ng)}}const jg=s=>s.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":s.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":s.startsWith("gpt-4-32k")?"gpt-4-32k":s.startsWith("gpt-4-")?"gpt-4":s.startsWith("gpt-4o")?"gpt-4o":s;function Yi(s){return typeof s!="object"||!s?!1:!!("type"in s&&s.type==="function"&&"function"in s&&typeof s.function=="object"&&s.function&&"name"in s.function&&"parameters"in s.function)}const Rg=()=>!1;wo=class extends va{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(s){super(s),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=s.verbose??Rg(),this.callbacks=s.callbacks,this.tags=s.tags??[],this.metadata=s.metadata??{}}};class Ig extends wo{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){const{cache:i,...a}=n;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof i=="object"?this.cache=i:i?this.cache=Hr.global():this.cache=void 0,this.caller=new $_(n??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(i=>typeof i=="string"?i:i.type==="text"&&"text"in i?i.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await L_("modelName"in this?jg(this.modelName):"gpt2")}catch(i){console.warn("Failed to calculate number of tokens, falling back to approximate count",i)}if(this._encoding)try{n=this._encoding.encode(t).length}catch(i){console.warn("Failed to calculate number of tokens, falling back to approximate count",i)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new ko(e):Array.isArray(e)?new Yf(e.map(Yn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([i,a])=>a!==void 0).map(([i,a])=>`${i}:${JSON.stringify(a)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class ls extends va{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=Kp(t);return this.func&&await this.func(e,n),this._callWithConfig(i=>Promise.resolve(i),e,n)}async*transform(e,t){const n=Kp(t);let i,a=!0;for await(const r of this._transformStreamWithConfig(e,o=>o,n))if(yield r,a)if(i===void 0)i=r;else try{i=Qp(i,r)}catch{i=void 0,a=!1}this.func&&i!==void 0&&await this.func(i,n)}static assign(e){return new B_(new q_({steps:e}))}}function Jr(s){const e=[];for(const t of s){let n=t;if(Array.isArray(t.content))for(let i=0;i<t.content.length;i++){const a=t.content[i];(U_(a)||F_(a))&&n===t&&(n=new t.constructor({...n,content:[...t.content.slice(0,i),Z_(a),...t.content.slice(i+1)]}))}e.push(n)}return e}class Ut extends Ig{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){const n=Ut._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){var n;if(this._streamResponseChunks===Ut.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const i=Ut._convertInputToPromptValue(e).toChatMessages(),[a,r]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...a.metadata,...this.getLsParams(r)},c=await go.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:1},u=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[Jr(i)],a.runId,void 0,l,void 0,void 0,a.runName));let d,p;try{for await(const h of this._streamResponseChunks(i,r,u==null?void 0:u[0])){if(h.message.id==null){const m=(n=u==null?void 0:u.at(0))==null?void 0:n.runId;m!=null&&h.message._updateId(`run-${m}`)}h.message.response_metadata={...h.generationInfo,...h.message.response_metadata},yield h.message,d?d=d.concat(h):d=h,Hp(h.message)&&h.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:h.message.usage_metadata.input_tokens,completionTokens:h.message.usage_metadata.output_tokens,totalTokens:h.message.usage_metadata.total_tokens}})}}catch(h){throw await Promise.all((u??[]).map(m=>m==null?void 0:m.handleLLMError(h))),h}await Promise.all((u??[]).map(h=>h==null?void 0:h.handleLLMEnd({generations:[[d]],llmOutput:p})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n,i){var u,d;const a=e.map(p=>p.map(Yn));let r;if(i!==void 0&&i.length===a.length)r=i;else{const p={...n.metadata,...this.getLsParams(t)},h=await go.configure(n.callbacks,this.callbacks,n.tags,this.tags,p,this.metadata,{verbose:this.verbose}),m={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1};r=await(h==null?void 0:h.handleChatModelStart(this.toJSON(),a.map(Jr),n.runId,void 0,m,void 0,void 0,n.runName))}const o=[],c=[];if(r!=null&&r[0].handlers.find(D_)&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==Ut.prototype._streamResponseChunks)try{const p=await this._streamResponseChunks(a[0],t,r==null?void 0:r[0]);let h,m;for await(const y of p){if(y.message.id==null){const f=(u=r==null?void 0:r.at(0))==null?void 0:u.runId;f!=null&&y.message._updateId(`run-${f}`)}h===void 0?h=y:h=Qp(h,y),Hp(y.message)&&y.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:y.message.usage_metadata.input_tokens,completionTokens:y.message.usage_metadata.output_tokens,totalTokens:y.message.usage_metadata.total_tokens}})}if(h===void 0)throw new Error("Received empty response from chat model call.");o.push([h]),await(r==null?void 0:r[0].handleLLMEnd({generations:o,llmOutput:m}))}catch(p){throw await(r==null?void 0:r[0].handleLLMError(p)),p}else{const p=await Promise.allSettled(a.map((h,m)=>this._generate(h,{...t,promptIndex:m},r==null?void 0:r[m])));await Promise.all(p.map(async(h,m)=>{var y,f,g;if(h.status==="fulfilled"){const b=h.value;for(const v of b.generations){if(v.message.id==null){const E=(y=r==null?void 0:r.at(0))==null?void 0:y.runId;E!=null&&v.message._updateId(`run-${E}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata}}return b.generations.length===1&&(b.generations[0].message.response_metadata={...b.llmOutput,...b.generations[0].message.response_metadata}),o[m]=b.generations,c[m]=b.llmOutput,(f=r==null?void 0:r[m])==null?void 0:f.handleLLMEnd({generations:[b.generations],llmOutput:b.llmOutput})}else return await((g=r==null?void 0:r[m])==null?void 0:g.handleLLMError(h.reason)),Promise.reject(h.reason)}))}const l={generations:o,llmOutput:c.length?(d=this._combineLLMOutput)==null?void 0:d.call(this,...c):void 0};return Object.defineProperty(l,Jp,{value:r?{runIds:r==null?void 0:r.map(p=>p.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:i,handledOptions:a}){const r=e.map(y=>y.map(Yn)),o={...a.metadata,...this.getLsParams(i)},c=await go.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},u=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),r.map(Jr),a.runId,void 0,l,void 0,void 0,a.runName)),d=[],p=(await Promise.allSettled(r.map(async(y,f)=>{const g=Ut._convertInputToPromptValue(y).toString(),b=await t.lookup(g,n);return b==null&&d.push(f),b}))).map((y,f)=>({result:y,runManager:u==null?void 0:u[f]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),h=[];await Promise.all(p.map(async({result:y,runManager:f},g)=>{if(y.status==="fulfilled"){const b=y.value;return h[g]=b.map(v=>("message"in v&&bo(v.message)&&fs(v.message)&&(v.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),v.generationInfo={...v.generationInfo,tokenUsage:{}},v)),b.length&&await(f==null?void 0:f.handleLLMNewToken(b[0].text)),f==null?void 0:f.handleLLMEnd({generations:[b]},void 0,void 0,void 0,{cached:!0})}else return await(f==null?void 0:f.handleLLMError(y.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(y.reason)}));const m={generations:h,missingPromptIndices:d,startedRunManagers:u};return Object.defineProperty(m,Jp,{value:u?{runIds:u==null?void 0:u.map(y=>y.runId)}:void 0,configurable:!0}),m}async generate(e,t,n){let i;Array.isArray(t)?i={stop:t}:i=t;const a=e.map(m=>m.map(Yn)),[r,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(r.callbacks=r.callbacks??n,!this.cache)return this._generateUncached(a,o,r);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d,startedRunManagers:p}=await this._generateCached({messages:a,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:r});let h={};if(d.length>0){const m=await this._generateUncached(d.map(y=>a[y]),o,r,p!==void 0?d.map(y=>p==null?void 0:p[y]):void 0);await Promise.all(m.generations.map(async(y,f)=>{const g=d[f];u[g]=y;const b=Ut._convertInputToPromptValue(a[g]).toString();return c.update(b,l,y)})),h=m.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const i=e.map(a=>a.toChatMessages());return this.generate(i,t,n)}async call(e,t,n){return(await this.generate([e.map(Yn)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const i=e.toChatMessages();return this.call(i,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const i=new Vp(e),a=await this.call([i],t,n);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,i=t==null?void 0:t.name,a=Gp(n)??"A function available to call.",r=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(r==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let c=i??"extract",l;Kt(n)?l=[{type:"function",function:{name:c,description:a,parameters:Xt(n)}}]:("name"in n&&(c=n.name),l=[{type:"function",function:{name:c,description:a,parameters:n}}]);const u=this.bindTools(l),d=Xp.from(y=>{if(!y.tool_calls||y.tool_calls.length===0)throw new Error("No tool calls found in the response.");const f=y.tool_calls.find(g=>g.name===c);if(!f)throw new Error(`No tool call found with name ${c}.`);return f.args});if(!o)return u.pipe(d).withConfig({runName:"StructuredOutput"});const p=ls.assign({parsed:(y,f)=>d.invoke(y.raw,f)}),h=ls.assign({parsed:()=>null}),m=p.withFallbacks({fallbacks:[h]});return wa.from([{raw:u},m]).withConfig({runName:"StructuredOutputRunnable"})}}class Du extends va{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(n,i)=>this.parseResult([{text:n}],i==null?void 0:i.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(n,i)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],i==null?void 0:i.callbacks),e,{...t,runType:"parser"})}}class Uu extends Du{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class ea extends Error{constructor(e,t,n,i=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=i,i&&(n===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");W_(this,"OUTPUT_PARSING_FAILURE")}}class $g extends Uu{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Fu extends $g{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,n;for await(const i of e){if(typeof i!="string"&&typeof i.content!="string")throw new Error("Cannot handle non-string output.");let a;if(z_(i)){if(typeof i.content!="string")throw new Error("Cannot handle non-string message output.");a=new ys({message:i,text:i.content})}else if(bo(i)){if(typeof i.content!="string")throw new Error("Cannot handle non-string message output.");a=new ys({message:V_(i),text:i.content})}else a=new K_({text:i});n===void 0?n=a:n=n.concat(a);const r=await this.parsePartialResult([n]);r!=null&&!si(r,t)&&(this.diff?yield this._diff(t,r):yield r,t=r)}}getFormatInstructions(){return""}}class Gr extends Uu{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Q_(Object.fromEntries(Object.entries(e).map(([n,i])=>[n,H_().describe(i)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Xt(this.schema))}
\`\`\`
`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(n,i)=>`"${i.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await J_(this.schema,JSON.parse(t))}catch(t){throw new ea(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class ta extends Fu{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Qt(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Yp(e[0].text)}async parse(e){return Yp(e,JSON.parse)}getFormatInstructions(){return""}}function sa(s,e){if(s.function===void 0)return;let t;if(e!=null&&e.partial)try{t=G_(s.function.arguments??"{}")}catch{return}else try{t=JSON.parse(s.function.arguments)}catch(i){throw new ea([`Function "${s.function.name}" arguments:`,"",s.function.arguments,"","are not valid JSON.",`Error: ${i.message}`].join(`
`))}const n={name:s.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(n.id=s.id),n}function Zu(s){if(s.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:s.id,type:"function",function:{name:s.name,arguments:JSON.stringify(s.args)}}}function Xr(s,e){var t,n;return{name:(t=s.function)==null?void 0:t.name,args:(n=s.function)==null?void 0:n.arguments,id:s.id,error:e,type:"invalid_tool_call"}}class Lg extends Fu{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var r;const n=e[0].message;let i;if(fs(n)&&((r=n.tool_calls)!=null&&r.length)?i=n.tool_calls.map(o=>{const{id:c,...l}=o;return this.returnId?{id:c,...l}:l}):n.additional_kwargs.tool_calls!==void 0&&(i=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(o=>sa(o,{returnId:this.returnId,partial:t}))),!i)return[];const a=[];for(const o of i)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};a.push(c)}return a}}class na extends Lg{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){var n;if(this.zodSchema===void 0)return e;const t=await eh(this.zodSchema,e);if(t.success)return t.data;throw new ea(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((n=t.error)==null?void 0:n.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let n=t;if(t.length)return this.returnId||(n=t.map(i=>i.args)),this.returnSingle?n[0]:n}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let n=t;return t.length?(this.returnId||(n=t.map(i=>i.args)),this.returnSingle?this._validateResult(n[0]):await Promise.all(n.map(i=>this._validateResult(i)))):void 0}}const Bg=Symbol("Let zodToJsonSchema decide on which parser to use"),Wu={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},qg=s=>typeof s=="string"?{...Wu,basePath:["#"],definitions:{},name:s}:{...Wu,basePath:["#"],definitions:{},...s},Yr=s=>"_def"in s?s._def:s;function Dg(s){if(!s)return!0;for(const e in s)return!1;return!0}const Ug=s=>{const e=qg(s),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([n,i])=>[Yr(i),{def:Yr(i),path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function zu(s,e,t,n){n!=null&&n.errorMessages&&t&&(s.errorMessage={...s.errorMessage,[e]:t})}function he(s,e,t,n,i){s[e]=t,zu(s,e,n,i)}var zn;(function(s){s.assertEqual=i=>{};function e(i){}s.assertIs=e;function t(i){throw new Error}s.assertNever=t,s.arrayToEnum=i=>{const a={};for(const r of i)a[r]=r;return a},s.getValidEnumValues=i=>{const a=s.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),r={};for(const o of a)r[o]=i[o];return s.objectValues(r)},s.objectValues=i=>s.objectKeys(i).map(function(a){return i[a]}),s.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const a=[];for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&a.push(r);return a},s.find=(i,a)=>{for(const r of i)if(a(r))return r},s.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function n(i,a=" | "){return i.map(r=>typeof r=="string"?`'${r}'`:r).join(a)}s.joinValues=n,s.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(zn||(zn={}));var Vu;(function(s){s.mergeShapes=(e,t)=>({...e,...t})})(Vu||(Vu={})),zn.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),zn.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class ia extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},n={_errors:[]},i=a=>{for(const r of a.issues)if(r.code==="invalid_union")r.unionErrors.map(i);else if(r.code==="invalid_return_type")i(r.returnTypeError);else if(r.code==="invalid_arguments")i(r.argumentsError);else if(r.path.length===0)n._errors.push(t(r));else{let o=n,c=0;for(;c<r.path.length;){const l=r.path[c];c===r.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(r))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return i(this),n}static assert(e){if(!(e instanceof ia))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,zn.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const i of this.issues)i.path.length>0?(t[i.path[0]]=t[i.path[0]]||[],t[i.path[0]].push(e(i))):n.push(e(i));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}ia.create=s=>new ia(s);var Ku;(function(s){s.errToObj=e=>typeof e=="string"?{message:e}:e||{},s.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(Ku||(Ku={}));var te;(function(s){s.ZodString="ZodString",s.ZodNumber="ZodNumber",s.ZodNaN="ZodNaN",s.ZodBigInt="ZodBigInt",s.ZodBoolean="ZodBoolean",s.ZodDate="ZodDate",s.ZodSymbol="ZodSymbol",s.ZodUndefined="ZodUndefined",s.ZodNull="ZodNull",s.ZodAny="ZodAny",s.ZodUnknown="ZodUnknown",s.ZodNever="ZodNever",s.ZodVoid="ZodVoid",s.ZodArray="ZodArray",s.ZodObject="ZodObject",s.ZodUnion="ZodUnion",s.ZodDiscriminatedUnion="ZodDiscriminatedUnion",s.ZodIntersection="ZodIntersection",s.ZodTuple="ZodTuple",s.ZodRecord="ZodRecord",s.ZodMap="ZodMap",s.ZodSet="ZodSet",s.ZodFunction="ZodFunction",s.ZodLazy="ZodLazy",s.ZodLiteral="ZodLiteral",s.ZodEnum="ZodEnum",s.ZodEffects="ZodEffects",s.ZodNativeEnum="ZodNativeEnum",s.ZodOptional="ZodOptional",s.ZodNullable="ZodNullable",s.ZodDefault="ZodDefault",s.ZodCatch="ZodCatch",s.ZodPromise="ZodPromise",s.ZodBranded="ZodBranded",s.ZodPipeline="ZodPipeline",s.ZodReadonly="ZodReadonly"})(te||(te={}));function Fg(){return{}}function Zg(s,e){var n,i;const t={type:"array"};return((i=(n=s.type)==null?void 0:n._def)==null?void 0:i.typeName)!==te.ZodAny&&(t.items=de(s.type._def,{...e,currentPath:[...e.currentPath,"items"]})),s.minLength&&he(t,"minItems",s.minLength.value,s.minLength.message,e),s.maxLength&&he(t,"maxItems",s.maxLength.value,s.maxLength.message,e),s.exactLength&&(he(t,"minItems",s.exactLength.value,s.exactLength.message,e),he(t,"maxItems",s.exactLength.value,s.exactLength.message,e)),t}function Wg(s,e){const t={type:"integer",format:"int64"};if(!s.checks)return t;for(const n of s.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?he(t,"minimum",n.value,n.message,e):he(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),he(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?he(t,"maximum",n.value,n.message,e):he(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),he(t,"maximum",n.value,n.message,e));break;case"multipleOf":he(t,"multipleOf",n.value,n.message,e);break}return t}function zg(){return{type:"boolean"}}function Vg(s,e){return de(s.type._def,e)}const Kg=(s,e)=>de(s.innerType._def,e);function Qu(s,e,t){const n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((i,a)=>Qu(s,e,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Qg(s,e)}}const Qg=(s,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const n of s.checks)switch(n.kind){case"min":he(t,"minimum",n.value,n.message,e);break;case"max":he(t,"maximum",n.value,n.message,e);break}return t};function Hg(s,e){return{...de(s.innerType._def,e),default:s.defaultValue()}}function Jg(s,e,t){return e.effectStrategy==="input"?de(s.schema._def,e,t):{}}function Gg(s){return{type:"string",enum:[...s.values]}}const Xg=s=>"type"in s&&s.type==="string"?!1:"allOf"in s;function Yg(s,e){const t=[de(s.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),de(s.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const i=[];return t.forEach(a=>{if(Xg(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let r=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;r=c}else n=void 0;i.push(r)}}),i.length?{allOf:i,...n}:void 0}function e0(s,e){const t=typeof s.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(s.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[s.value]}:{type:t==="bigint"?"integer":t,const:s.value}}let eo;const Cs={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(eo===void 0&&(eo=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),eo),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Hu(s,e){const t={type:"string"};function n(i){return e.patternStrategy==="escape"?t0(i):i}if(s.checks)for(const i of s.checks)switch(i.kind){case"min":he(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e);break;case"max":he(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"email":switch(e.emailStrategy){case"format:email":kt(t,"email",i.message,e);break;case"format:idn-email":kt(t,"idn-email",i.message,e);break;case"pattern:zod":Ct(t,Cs.email,i.message,e);break}break;case"url":kt(t,"uri",i.message,e);break;case"uuid":kt(t,"uuid",i.message,e);break;case"regex":Ct(t,i.regex,i.message,e);break;case"cuid":Ct(t,Cs.cuid,i.message,e);break;case"cuid2":Ct(t,Cs.cuid2,i.message,e);break;case"startsWith":Ct(t,RegExp(`^${n(i.value)}`),i.message,e);break;case"endsWith":Ct(t,RegExp(`${n(i.value)}$`),i.message,e);break;case"datetime":kt(t,"date-time",i.message,e);break;case"date":kt(t,"date",i.message,e);break;case"time":kt(t,"time",i.message,e);break;case"duration":kt(t,"duration",i.message,e);break;case"length":he(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e),he(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"includes":{Ct(t,RegExp(n(i.value)),i.message,e);break}case"ip":{i.version!=="v6"&&kt(t,"ipv4",i.message,e),i.version!=="v4"&&kt(t,"ipv6",i.message,e);break}case"emoji":Ct(t,Cs.emoji,i.message,e);break;case"ulid":{Ct(t,Cs.ulid,i.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{kt(t,"binary",i.message,e);break}case"contentEncoding:base64":{he(t,"contentEncoding","base64",i.message,e);break}case"pattern:zod":{Ct(t,Cs.base64,i.message,e);break}}break}case"nanoid":Ct(t,Cs.nanoid,i.message,e)}return t}const t0=s=>Array.from(s).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),kt=(s,e,t,n)=>{var i;s.format||(i=s.anyOf)!=null&&i.some(a=>a.format)?(s.anyOf||(s.anyOf=[]),s.format&&(s.anyOf.push({format:s.format,...s.errorMessage&&n.errorMessages&&{errorMessage:{format:s.errorMessage.format}}}),delete s.format,s.errorMessage&&(delete s.errorMessage.format,Object.keys(s.errorMessage).length===0&&delete s.errorMessage)),s.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):he(s,"format",e,t,n)},Ct=(s,e,t,n)=>{var i;s.pattern||(i=s.allOf)!=null&&i.some(a=>a.pattern)?(s.allOf||(s.allOf=[]),s.pattern&&(s.allOf.push({pattern:s.pattern,...s.errorMessage&&n.errorMessages&&{errorMessage:{pattern:s.errorMessage.pattern}}}),delete s.pattern,s.errorMessage&&(delete s.errorMessage.pattern,Object.keys(s.errorMessage).length===0&&delete s.errorMessage)),s.allOf.push({pattern:Ju(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):he(s,"pattern",Ju(e,n),t,n)},Ju=(s,e)=>{var l;const t=typeof s=="function"?s():s;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},i=n.i?t.source.toLowerCase():t.source;let a="",r=!1,o=!1,c=!1;for(let u=0;u<i.length;u++){if(r){a+=i[u],r=!1;continue}if(n.i){if(o){if(i[u].match(/[a-z]/)){c?(a+=i[u],a+=`${i[u-2]}-${i[u]}`.toUpperCase(),c=!1):i[u+1]==="-"&&((l=i[u+2])!=null&&l.match(/[a-z]/))?(a+=i[u],c=!0):a+=`${i[u]}${i[u].toUpperCase()}`;continue}}else if(i[u].match(/[a-z]/)){a+=`[${i[u]}${i[u].toUpperCase()}]`;continue}}if(n.m){if(i[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(i[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(n.s&&i[u]==="."){a+=o?`${i[u]}\r
`:`[${i[u]}\r
]`;continue}a+=i[u],i[u]==="\\"?r=!0:o&&i[u]==="]"?o=!1:!o&&i[u]==="["&&(o=!0)}try{const u=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return a};function Gu(s,e){var n,i,a,r;if(e.target==="openApi3"&&((n=s.keyType)==null?void 0:n._def.typeName)===te.ZodEnum)return{type:"object",required:s.keyType._def.values,properties:s.keyType._def.values.reduce((o,c)=>({...o,[c]:de(s.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:de(s.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((i=s.keyType)==null?void 0:i._def.typeName)===te.ZodString&&((a=s.keyType._def.checks)!=null&&a.length)){const o=Object.entries(Hu(s.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...t,propertyNames:o}}else if(((r=s.keyType)==null?void 0:r._def.typeName)===te.ZodEnum)return{...t,propertyNames:{enum:s.keyType._def.values}};return t}function s0(s,e){if(e.mapStrategy==="record")return Gu(s,e);const t=de(s.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=de(s.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function n0(s){const e=s.values,t=Object.keys(s.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),n=Array.from(new Set(t.map(i=>typeof i)));return{type:n.length===1?n[0]==="string"?"string":"number":["string","number"],enum:t}}function i0(){return{not:{}}}function a0(s){return s.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const aa={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function r0(s,e){if(e.target==="openApi3")return Xu(s,e);const t=s.options instanceof Map?Array.from(s.options.values()):s.options;if(t.every(n=>n._def.typeName in aa&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((i,a)=>{const r=aa[a._def.typeName];return r&&!i.includes(r)?[...i,r]:i},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((i,a)=>{const r=typeof a._def.value;switch(r){case"string":case"number":case"boolean":return[...i,r];case"bigint":return[...i,"integer"];case"object":if(a._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(n.length===t.length){const i=n.filter((a,r,o)=>o.indexOf(a)===r);return{type:i.length>1?i:i[0],enum:t.reduce((a,r)=>a.includes(r._def.value)?a:[...a,r._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return Xu(s,e)}const Xu=(s,e)=>{const t=(s.options instanceof Map?Array.from(s.options.values()):s.options).map((n,i)=>de(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function o0(s,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(s.innerType._def.typeName)&&(!s.innerType._def.checks||!s.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:aa[s.innerType._def.typeName],nullable:!0}:{type:[aa[s.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=de(s.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=de(s.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function c0(s,e){const t={type:"number"};if(!s.checks)return t;for(const n of s.checks)switch(n.kind){case"int":t.type="integer",zu(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?he(t,"minimum",n.value,n.message,e):he(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),he(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?he(t,"maximum",n.value,n.message,e):he(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),he(t,"maximum",n.value,n.message,e));break;case"multipleOf":he(t,"multipleOf",n.value,n.message,e);break}return t}function l0(s,e){return e.removeAdditionalStrategy==="strict"?s.catchall._def.typeName==="ZodNever"?s.unknownKeys!=="strict":de(s.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:s.catchall._def.typeName==="ZodNever"?s.unknownKeys==="passthrough":de(s.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function u0(s,e){const t={type:"object",...Object.entries(s.shape()).reduce((n,[i,a])=>{var c;if(a===void 0||a._def===void 0)return n;const r=[...e.currentPath,"properties",i],o=de(a._def,{...e,currentPath:r,propertyPath:r});if(o===void 0)return n;if(e.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&typeof((c=a._def)==null?void 0:c.defaultValue)>"u")throw new Error(`Zod field at \`${r.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...n.properties,[i]:o},required:a.isOptional()&&!e.openaiStrictMode?n.required:[...n.required,i]}},{properties:{},required:[]}),additionalProperties:l0(s,e)};return t.required.length||delete t.required,t}const d0=(s,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return de(s.innerType._def,e);const t=de(s.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},p0=(s,e)=>{if(e.pipeStrategy==="input")return de(s.in._def,e);if(e.pipeStrategy==="output")return de(s.out._def,e);const t=de(s.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=de(s.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(i=>i!==void 0)}};function h0(s,e){return de(s.type._def,e)}function m0(s,e){const t={type:"array",uniqueItems:!0,items:de(s.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return s.minSize&&he(t,"minItems",s.minSize.value,s.minSize.message,e),s.maxSize&&he(t,"maxItems",s.maxSize.value,s.maxSize.message,e),t}function f0(s,e){return s.rest?{type:"array",minItems:s.items.length,items:s.items.map((t,n)=>de(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:de(s.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:s.items.length,maxItems:s.items.length,items:s.items.map((t,n)=>de(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function y0(){return{not:{}}}function g0(){return{}}const b0=(s,e)=>de(s.innerType._def,e);function de(s,e,t=!1){var r;const n=e.seen.get(s);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,s,e,n,t);if(o!==Bg)return o}if(n&&!t){const o=_0(n,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const i={def:s,path:e.currentPath,jsonSchema:void 0};e.seen.set(s,i);const a=w0(s,s.typeName,e,t);return a&&x0(s,e,a),i.jsonSchema=a,a}const _0=(s,e)=>{switch(e.$refStrategy){case"root":return{$ref:s.path.join("/")};case"extract-to-root":const t=s.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=s.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:v0(e.currentPath,s.path)};case"none":case"seen":return s.path.length<e.currentPath.length&&s.path.every((n,i)=>e.currentPath[i]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},v0=(s,e)=>{let t=0;for(;t<s.length&&t<e.length&&s[t]===e[t];t++);return[(s.length-t).toString(),...e.slice(t)].join("/")},w0=(s,e,t,n)=>{switch(e){case te.ZodString:return Hu(s,t);case te.ZodNumber:return c0(s,t);case te.ZodObject:return u0(s,t);case te.ZodBigInt:return Wg(s,t);case te.ZodBoolean:return zg();case te.ZodDate:return Qu(s,t);case te.ZodUndefined:return y0();case te.ZodNull:return a0(t);case te.ZodArray:return Zg(s,t);case te.ZodUnion:case te.ZodDiscriminatedUnion:return r0(s,t);case te.ZodIntersection:return Yg(s,t);case te.ZodTuple:return f0(s,t);case te.ZodRecord:return Gu(s,t);case te.ZodLiteral:return e0(s,t);case te.ZodEnum:return Gg(s);case te.ZodNativeEnum:return n0(s);case te.ZodNullable:return o0(s,t);case te.ZodOptional:return d0(s,t);case te.ZodMap:return s0(s,t);case te.ZodSet:return m0(s,t);case te.ZodLazy:return de(s.getter()._def,t);case te.ZodPromise:return h0(s,t);case te.ZodNaN:case te.ZodNever:return i0();case te.ZodEffects:return Jg(s,t,n);case te.ZodAny:return Fg();case te.ZodUnknown:return g0();case te.ZodDefault:return Hg(s,t);case te.ZodBranded:return Vg(s,t);case te.ZodReadonly:return b0(s,t);case te.ZodCatch:return Kg(s,t);case te.ZodPipeline:return p0(s,t);case te.ZodFunction:case te.ZodVoid:case te.ZodSymbol:return;default:return(i=>{})()}},x0=(s,e,t)=>(s.description&&(t.description=s.description,e.markdownDescription&&(t.markdownDescription=s.description)),t),O0=(s,e)=>{const t=Ug(e),n=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,i=de(s._def,n===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,n]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(i.title=a);const r=(()=>{if(Dg(t.definitions))return;const c={},l=new Set;for(let u=0;u<500;u++){const d=Object.entries(t.definitions).filter(([p])=>!l.has(p));if(d.length===0)break;for(const[p,h]of d)c[p]=de(Yr(h),{...t,currentPath:[...t.basePath,t.definitionPath,p]},!0)??{},l.add(p)}return c})(),o=n===void 0?r?{...i,[t.definitionPath]:r}:i:t.nameStrategy==="duplicate-ref"?{...i,...r||t.seenRefs.size?{[t.definitionPath]:{...r,...t.seenRefs.size?{[n]:i}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,n].join("/"),[t.definitionPath]:{...r,[n]:i}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function E0(s,e){return O0(s,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function M0(s,e,t){return Zy({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:E0(s,{name:e})}},n=>s.parse(JSON.parse(n)))}Co=function(s){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:n,azureOpenAIBasePath:i,baseURL:a,azureADTokenProvider:r,azureOpenAIEndpoint:o}=s;if((n||r)&&i&&e)return`${i}/${e}`;if((n||r)&&o&&e)return`${o}/openai/deployments/${e}`;if(n||r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return a};function k0(s){return s!==void 0&&Array.isArray(s.lc_namespace)}function C0(s){return s!==void 0&&va.isRunnable(s)&&"lc_name"in s.constructor&&typeof s.constructor.lc_name=="function"&&s.constructor.lc_name()==="RunnableToolLike"}function A0(s){return!!s&&typeof s=="object"&&"name"in s&&"schema"in s&&(Kt(s.schema)||s.schema!=null&&typeof s.schema=="object"&&"type"in s.schema&&typeof s.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(s.schema.type))}function ra(s){return A0(s)||C0(s)||k0(s)}function P0(s,e){return{name:s.name,description:s.description,parameters:Xt(s.schema)}}function to(s,e){let t;return ra(s)?t={type:"function",function:P0(s)}:t=s,t}function oa(s,e){return s.lc_error_code=e,s.message=`${s.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,s}ii=function(s){let e;return s.constructor.name===Oi.name?(e=new Error(s.message),e.name="TimeoutError"):s.constructor.name===rt.name?(e=new Error(s.message),e.name="AbortError"):s.status===400&&s.message.includes("tool_calls")?e=oa(s,"INVALID_TOOL_RESULTS"):s.status===401?e=oa(s,"MODEL_AUTHENTICATION"):s.status===429?e=oa(s,"MODEL_RATE_LIMIT"):s.status===404?e=oa(s,"MODEL_NOT_FOUND"):e=s,e};function Yu(s){if(s)return s==="any"||s==="required"?"required":s==="auto"?"auto":s==="none"?"none":typeof s=="string"?{type:"function",function:{name:s}}:s}function S0(s){return s.anyOf!==void 0&&Array.isArray(s.anyOf)}function T0(s){const e=["namespace functions {",""];for(const t of s)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(ed(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function ed(s,e){var n;const t=[];for(const[i,a]of Object.entries(s.properties??{}))a.description&&e<2&&t.push(`// ${a.description}`),(n=s.required)!=null&&n.includes(i)?t.push(`${i}: ${ca(a,e)},`):t.push(`${i}?: ${ca(a,e)},`);return t.map(i=>" ".repeat(e)+i).join(`
`)}function ca(s,e){if(S0(s))return s.anyOf.map(t=>ca(t,e)).join(" | ");switch(s.type){case"string":return s.enum?s.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return s.enum?s.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return s.enum?s.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",ed(s,e+2),"}"].join(`
`);case"array":return s.items?`${ca(s.items,e)}[]`:"any[]";default:return""}}function N0(s,e){let t;return ra(s)?t=to(s):t=s,(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function j0(s){return s.role!=="system"&&s.role!=="developer"&&s.role!=="assistant"&&s.role!=="user"&&s.role!=="function"&&s.role!=="tool"&&console.warn(`Unknown message role: ${s.role}`),s.role}function so(s){const e=s._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Oa.isInstance(s))throw new Error("Invalid generic chat message");return j0(s)}default:throw new Error(`Unknown message type: ${e}`)}}const td={providerName:"ChatOpenAI",fromStandardTextBlock(s){return{type:"text",text:s.text}},fromStandardImageBlock(s){var e,t;if(s.source_type==="url")return{type:"image_url",image_url:{url:s.url,...(e=s.metadata)!=null&&e.detail?{detail:s.metadata.detail}:{}}};if(s.source_type==="base64")return{type:"image_url",image_url:{url:`data:${s.mime_type??""};base64,${s.data}`,...(t=s.metadata)!=null&&t.detail?{detail:s.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${s.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(s){if(s.source_type==="url"){const e=ei({dataUrl:s.url});if(!e)throw new Error(`URL audio blocks with source_type ${s.source_type} must be formatted as a data URL for ChatOpenAI`);const t=e.mime_type||s.mime_type||"";let n;try{n=ah(t)}catch{throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`)}if(n.type!=="audio"||n.subtype!=="wav"&&n.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:n.subtype,data:e.data}}}if(s.source_type==="base64"){let e;try{e=ah(s.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:s.data}}}throw new Error(`Audio content blocks with source_type ${s.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(s){var e,t,n,i,a,r,o,c,l,u;if(s.source_type==="url"){if(!ei({dataUrl:s.url}))throw new Error(`URL file blocks with source_type ${s.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:s.url,...(e=s.metadata)!=null&&e.filename||(t=s.metadata)!=null&&t.name?{filename:((n=s.metadata)==null?void 0:n.filename)||((i=s.metadata)==null?void 0:i.name)}:{}}}}if(s.source_type==="base64")return{type:"file",file:{file_data:`data:${s.mime_type??""};base64,${s.data}`,...(a=s.metadata)!=null&&a.filename||(r=s.metadata)!=null&&r.name||(o=s.metadata)!=null&&o.title?{filename:((c=s.metadata)==null?void 0:c.filename)||((l=s.metadata)==null?void 0:l.name)||((u=s.metadata)==null?void 0:u.title)}:{}}};if(s.source_type==="id")return{type:"file",file:{file_id:s.id}};throw new Error(`File content blocks with source_type ${s.source_type} are not supported for ChatOpenAI`)}};function sd(s,e){return s.flatMap(t=>{var r;let n=so(t);n==="system"&&la(e)&&(n="developer");const i=typeof t.content=="string"?t.content:t.content.map(o=>_o(o)?vo(o,td):o),a={role:n,content:i};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=""),fs(t)&&((r=t.tool_calls)!=null&&r.length)?(a.tool_calls=t.tool_calls.map(Zu),a.content=""):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const o={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,o]}return a})}const Js="__openai_function_call_ids__";function R0(s){const e=(s.summary.length>1?s.summary.reduce((t,n)=>{const i=t.at(-1);return i.index===n.index?i.text+=n.text:t.push(n),t},[{...s.summary[0]}]):s.summary).map(t=>Object.fromEntries(Object.entries(t).filter(([n])=>n!=="index")));return{...s,summary:e}}function nd(s,e,t){return s.flatMap(n=>{var r,o,c;const i=n.additional_kwargs;let a=so(n);if(a==="system"&&la(e)&&(a="developer"),a==="function")throw new Error("Function messages are not supported in Responses API");if(a==="tool"){const l=n;return(i==null?void 0:i.type)==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof l.content=="string")return{type:"computer_screenshot",image_url:l.content};if(Array.isArray(l.content)){const u=l.content.find(p=>p.type==="computer_screenshot");if(u)return u;const d=l.content.find(p=>p.type==="image_url");if(d)return{type:"computer_screenshot",image_url:typeof d.image_url=="string"?d.image_url:d.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:l.tool_call_id}:{type:"function_call_output",call_id:l.tool_call_id,id:(r=l.id)!=null&&r.startsWith("fc_")?l.id:void 0,output:typeof l.content!="string"?JSON.stringify(l.content):l.content}}if(a==="assistant"){if(!t&&n.response_metadata.output!=null&&Array.isArray(n.response_metadata.output)&&n.response_metadata.output.length>0&&n.response_metadata.output.every(m=>"type"in m))return n.response_metadata.output;const l=[];if(i!=null&&i.reasoning&&!t){const m=R0(i.reasoning);l.push(m)}let{content:u}=n;i!=null&&i.refusal&&(typeof u=="string"&&(u=[{type:"output_text",text:u,annotations:[]}]),u=[...u,{type:"refusal",refusal:i.refusal}]),l.push({type:"message",role:"assistant",...n.id&&!t?{id:n.id}:{},content:typeof u=="string"?u:u.flatMap(m=>m.type==="text"?{type:"output_text",text:m.text,annotations:m.annotations??[]}:m.type==="output_text"||m.type==="refusal"?m:[])});const d=i==null?void 0:i[Js];fs(n)&&((o=n.tool_calls)!=null&&o.length)?l.push(...n.tool_calls.map(m=>({type:"function_call",name:m.name,arguments:JSON.stringify(m.args),call_id:m.id,...t?{id:d==null?void 0:d[m.id]}:{}}))):i!=null&&i.tool_calls&&l.push(...i.tool_calls.map(m=>({type:"function_call",name:m.function.name,call_id:m.id,arguments:m.function.arguments,...t?{id:d==null?void 0:d[m.id]}:{}})));const p=(c=n.response_metadata.output)!=null&&c.length?n.response_metadata.output:i.tool_outputs,h=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(p!=null){const m=p==null?void 0:p.filter(y=>h.includes(y.type));m.length>0&&l.push(...m)}return l}if(a==="user"||a==="system"||a==="developer"){if(typeof n.content=="string")return{type:"message",role:a,content:n.content};const l=[],u=n.content.flatMap(d=>(d.type==="mcp_approval_response"&&l.push({type:"mcp_approval_response",approval_request_id:d.approval_request_id,approve:d.approve}),_o(d)?vo(d,td):d.type==="text"?{type:"input_text",text:d.text}:d.type==="image_url"?{type:"input_image",image_url:typeof d.image_url=="string"?d.image_url:d.image_url.url,detail:typeof d.image_url=="string"?"auto":d.image_url.detail}:d.type==="input_text"||d.type==="input_image"||d.type==="input_file"?d:[]));return u.length>0&&l.push({type:"message",role:a,content:u}),l}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${a}`),[]})}function id(s){if(s.error){const o=new Error(s.error.message);throw o.name=s.error.code,o}let e;const t=[],n=[],i=[],a={model:s.model,created_at:s.created_at,id:s.id,incomplete_details:s.incomplete_details,metadata:s.metadata,object:s.object,status:s.status,user:s.user,service_tier:s.service_tier,model_name:s.model},r={};for(const o of s.output)if(o.type==="message")e=o.id,t.push(...o.content.flatMap(c=>c.type==="output_text"?("parsed"in c&&c.parsed!=null&&(r.parsed=c.parsed),{type:"text",text:c.text,annotations:c.annotations}):c.type==="refusal"?(r.refusal=c.refusal,[]):c));else if(o.type==="function_call"){const c={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{n.push(sa(c,{returnId:!0}))}catch(l){let u;typeof l=="object"&&l!=null&&"message"in l&&typeof l.message=="string"&&(u=l.message),i.push(Xr(c,u))}r[Js]??(r[Js]={}),o.id&&(r[Js][o.call_id]=o.id)}else o.type==="reasoning"?r.reasoning=o:(r.tool_outputs??(r.tool_outputs=[]),r.tool_outputs.push(o));return new an({id:e,content:t,tool_calls:n,invalid_tool_calls:i,usage_metadata:s.usage,additional_kwargs:r,response_metadata:a})}function I0(s){var c,l;const e=[];let t={},n;const i=[],a={},r={};let o;if(s.type==="response.output_text.delta")e.push({type:"text",text:s.delta,index:s.content_index});else if(s.type==="response.output_text_annotation.added")e.push({type:"text",text:"",annotations:[s.annotation],index:s.content_index});else if(s.type==="response.output_item.added"&&s.item.type==="message")o=s.item.id;else if(s.type==="response.output_item.added"&&s.item.type==="function_call")i.push({type:"tool_call_chunk",name:s.item.name,args:s.item.arguments,id:s.item.call_id,index:s.output_index}),r[Js]={[s.item.call_id]:s.item.id};else if(s.type==="response.output_item.done"&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call"].includes(s.item.type))r.tool_outputs=[s.item];else if(s.type==="response.created")a.id=s.response.id,a.model_name=s.response.model,a.model=s.response.model;else if(s.type==="response.completed"){const u=id(s.response);n=s.response.usage,((l=(c=s.response.text)==null?void 0:c.format)==null?void 0:l.type)==="json_schema"&&(r.parsed??(r.parsed=JSON.parse(u.text)));for(const[d,p]of Object.entries(s.response))d!=="id"&&(a[d]=p)}else if(s.type==="response.function_call_arguments.delta")i.push({type:"tool_call_chunk",args:s.delta,index:s.output_index});else if(s.type==="response.web_search_call.completed"||s.type==="response.file_search_call.completed")t={tool_outputs:{id:s.item_id,type:s.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(s.type==="response.refusal.done")r.refusal=s.refusal;else if(s.type==="response.output_item.added"&&"item"in s&&s.item.type==="reasoning"){const u=s.item.summary?s.item.summary.map((d,p)=>({...d,index:p})):void 0;r.reasoning={id:s.item.id,type:s.item.type,...u?{summary:u}:{}}}else if(s.type==="response.reasoning_summary_part.added")r.reasoning={type:"reasoning",summary:[{...s.part,index:s.summary_index}]};else if(s.type==="response.reasoning_summary_text.delta")r.reasoning={type:"reasoning",summary:[{text:s.delta,type:"summary_text",index:s.summary_index}]};else return s.type,null;return new ys({text:e.map(u=>u.text).join(""),message:new rn({id:o,content:e,tool_call_chunks:i,usage_metadata:n,additional_kwargs:r,response_metadata:a}),generationInfo:t})}function no(s){return"type"in s&&s.type!=="function"}function $0(s){return s!=null&&typeof s=="object"&&"type"in s&&s.type!=="function"}function L0(s,e){const t=[];for(const n of s)no(n)?(n.type==="image_generation"&&(e!=null&&e.stream)&&(n.partial_images=1),t.push(n)):Yi(n)&&t.push({type:"function",name:n.function.name,parameters:n.function.parameters,description:n.function.description,strict:(e==null?void 0:e.strict)??null});return t}function ad(s,e){return Yi(s)?(e==null?void 0:e.strict)!==void 0?{...s,function:{...s.function,strict:e.strict}}:s:N0(s,e)}function la(s){return s&&/^o\d/.test(s)}class B0 extends Ut{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort","service_tier"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","useResponsesApi","zdrEnabled","reasoning"]}constructor(e){var t,n,i;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zdrEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"service_tier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((t=e==null?void 0:e.configuration)==null?void 0:t.apiKey)??xa("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((n=e==null?void 0:e.configuration)==null?void 0:n.organization)??xa("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=(e==null?void 0:e.reasoningEffort)??((i=e==null?void 0:e.reasoning)==null?void 0:i.effort),this.reasoning=(e==null?void 0:e.reasoning)??(e!=null&&e.reasoningEffort?{effort:e.reasoningEffort}:void 0),this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.useResponsesApi=(e==null?void 0:e.useResponsesApi)??this.useResponsesApi,this.disableStreaming=(e==null?void 0:e.disableStreaming)??this.disableStreaming,this.streaming=(e==null?void 0:e.streaming)??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),(e==null?void 0:e.service_tier)!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=(e==null?void 0:e.zdrEnabled)??!1}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return(t==null?void 0:t.strict)!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.withConfig({tools:e.map(i=>no(i)?i:ad(i,{strict:n})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Kt(e.json_schema.schema)?U0(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}getReasoningParams(e){if(!la(this.model))return;let t;return this.reasoningEffort!==void 0&&(t={effort:this.reasoningEffort}),this.reasoning!==void 0&&(t={...t,...this.reasoning}),(e==null?void 0:e.reasoning_effort)!==void 0&&(t={...t,effort:e.reasoning_effort}),(e==null?void 0:e.reasoning)!==void 0&&(t={...t,...e.reasoning}),t}invocationParams(e,t){var o,c;let n;if((e==null?void 0:e.strict)!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this._useResponseApi(e)){const l={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e==null?void 0:e.previous_response_id,truncation:e==null?void 0:e.truncation,include:e==null?void 0:e.include,tools:(o=e==null?void 0:e.tools)!=null&&o.length?L0(e.tools,{stream:this.streaming,strict:n}):void 0,tool_choice:$0(e==null?void 0:e.tool_choice)?e==null?void 0:e.tool_choice:(()=>{const d=Yu(e==null?void 0:e.tool_choice);if(typeof d=="object"&&"type"in d)return{type:"function",name:d.function.name}})(),text:(()=>{if(e!=null&&e.text)return e.text;const d=this.createResponseFormat(e==null?void 0:e.response_format);return(d==null?void 0:d.type)==="json_schema"?d.json_schema.schema!=null?{format:{type:"json_schema",schema:d.json_schema.schema,description:d.json_schema.description,name:d.json_schema.name,strict:d.json_schema.strict}}:void 0:{format:d}})(),parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},u=this.getReasoningParams(e);return u!==void 0&&(l.reasoning=u),l}let i={};(e==null?void 0:e.stream_options)!==void 0?i={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(i={stream_options:{include_usage:!0}});const a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(c=e==null?void 0:e.tools)!=null&&c.length?e.tools.map(l=>ad(l,{strict:n})):void 0,tool_choice:Yu(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...i,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(a.prediction=e.prediction),this.service_tier!==void 0&&(a.service_tier=this.service_tier),(e==null?void 0:e.service_tier)!==void 0&&(a.service_tier=e.service_tier);const r=this.getReasoningParams(e);return r!==void 0&&r.effort!==void 0&&(a.reasoning_effort=r.effort),la(a.model)?a.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:a.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,a}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const n=e.tool_calls;switch(e.role){case"assistant":{const i=[],a=[];for(const c of n??[])try{i.push(sa(c,{returnId:!0}))}catch(l){a.push(Xr(c,l.message))}const r={function_call:e.function_call,tool_calls:n};this.__includeRawResponse!==void 0&&(r.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(r.audio=e.audio),new an({content:e.content||"",tool_calls:i,invalid_tool_calls:a,additional_kwargs:r,response_metadata:o,id:t.id})}default:return new Oa(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,t,n){var c,l;const i=e.role??n,a=e.content??"";let r;e.function_call?r={function_call:e.function_call}:e.tool_calls?r={tool_calls:e.tool_calls}:r={},this.__includeRawResponse&&(r.__raw_response=t),e.audio&&(r.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if(i==="user")return new th({content:a,response_metadata:o});if(i==="assistant"){const u=[];if(Array.isArray(e.tool_calls))for(const d of e.tool_calls)u.push({name:(c=d.function)==null?void 0:c.name,args:(l=d.function)==null?void 0:l.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new rn({content:a,tool_call_chunks:u,additional_kwargs:r,id:t.id,response_metadata:o})}else return i==="system"?new Ea({content:a,response_metadata:o}):i==="developer"?new Ea({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):i==="function"?new sh({content:a,additional_kwargs:r,name:e.name,response_metadata:o}):i==="tool"?new nh({content:a,additional_kwargs:r,tool_call_id:e.tool_call_id,response_metadata:o}):new ih({content:a,role:i,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){var l,u,d,p,h,m,y,f,g,b;if(this._useResponseApi(t)){const v=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:nd(e,this.model,this.zdrEnabled),stream:!0},t);for await(const E of v){const S=I0(E);S!=null&&(yield S)}return}const i=sd(e,this.model),a={...this.invocationParams(t,{streaming:!0}),messages:i,stream:!0};let r;const o=await this.completionWithRetry(a,t);let c;for await(const v of o){const E=(l=v==null?void 0:v.choices)==null?void 0:l[0];if(v.usage&&(c=v.usage),!E)continue;const{delta:S}=E;if(!S)continue;const A=this._convertOpenAIDeltaToBaseMessageChunk(S,v,r);r=S.role??r;const Q={prompt:t.promptIndex??0,completion:E.index??0};if(typeof A.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const H={...Q};E.finish_reason!=null&&(H.finish_reason=E.finish_reason,H.system_fingerprint=v.system_fingerprint,H.model_name=v.model,H.service_tier=v.service_tier),this.logprobs&&(H.logprobs=E.logprobs);const W=new ys({message:A,text:A.content,generationInfo:H});yield W,await(n==null?void 0:n.handleLLMNewToken(W.text??"",Q,void 0,void 0,void 0,{chunk:W}))}if(c){const v={...((u=c.prompt_tokens_details)==null?void 0:u.audio_tokens)!==null&&{audio:(d=c.prompt_tokens_details)==null?void 0:d.audio_tokens},...((p=c.prompt_tokens_details)==null?void 0:p.cached_tokens)!==null&&{cache_read:(h=c.prompt_tokens_details)==null?void 0:h.cached_tokens}},E={...((m=c.completion_tokens_details)==null?void 0:m.audio_tokens)!==null&&{audio:(y=c.completion_tokens_details)==null?void 0:y.audio_tokens},...((f=c.completion_tokens_details)==null?void 0:f.reasoning_tokens)!==null&&{reasoning:(g=c.completion_tokens_details)==null?void 0:g.reasoning_tokens}};yield new ys({message:new rn({content:"",response_metadata:{usage:{...c}},usage_metadata:{input_tokens:c.prompt_tokens,output_tokens:c.completion_tokens,total_tokens:c.total_tokens,...Object.keys(v).length>0&&{input_token_details:v},...Object.keys(E).length>0&&{output_token_details:E}}}),text:""})}if((b=t.signal)!=null&&b.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,n){var o;const i=this.invocationParams(t);if(i.stream){const c=this._streamResponseChunks(e,t,n);let l;for await(const u of c)u.message.response_metadata={...u.generationInfo,...u.message.response_metadata},l=(l==null?void 0:l.concat(u))??u;return{generations:l?[l]:[],llmOutput:{estimatedTokenUsage:(o=l==null?void 0:l.message)==null?void 0:o.usage_metadata}}}const a=nd(e,this.model,this.zdrEnabled),r=await this.responseApiWithRetry({input:a,...i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});return{generations:[{text:r.output_text,message:id(r)}],llmOutput:{id:r.id,estimatedTokenUsage:r.usage?{promptTokens:r.usage.input_tokens,completionTokens:r.usage.output_tokens,totalTokens:r.usage.total_tokens}:void 0}}}_useResponseApi(e){var i,a,r;const t=(i=e==null?void 0:e.tools)==null?void 0:i.some(no),n=(e==null?void 0:e.previous_response_id)!=null||(e==null?void 0:e.text)!=null||(e==null?void 0:e.truncation)!=null||(e==null?void 0:e.include)!=null||((a=e==null?void 0:e.reasoning)==null?void 0:a.summary)!=null||((r=this.reasoning)==null?void 0:r.summary)!=null;return this.useResponsesApi||t||n}async _generate(e,t,n){var o,c;if(this._useResponseApi(t))return this._responseApiGenerate(e,t,n);const i={},a=this.invocationParams(t),r=sd(e,this.model);if(a.stream){const l=this._streamResponseChunks(e,t,n),u={};for await(const f of l){f.message.response_metadata={...f.generationInfo,...f.message.response_metadata};const g=((o=f.generationInfo)==null?void 0:o.completion)??0;u[g]===void 0?u[g]=f:u[g]=u[g].concat(f)}const d=Object.entries(u).sort(([f],[g])=>parseInt(f,10)-parseInt(g,10)).map(([f,g])=>g),{functions:p,function_call:h}=this.invocationParams(t),m=await this.getEstimatedTokenCountFromPrompt(e,p,h),y=await this.getNumTokensFromGenerations(d);return i.input_tokens=m,i.output_tokens=y,i.total_tokens=m+y,{generations:d,llmOutput:{estimatedTokenUsage:{promptTokens:i.input_tokens,completionTokens:i.output_tokens,totalTokens:i.total_tokens}}}}else{let l;t.response_format&&t.response_format.type==="json_schema"?l=await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:r},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):l=await this.completionWithRetry({...a,stream:!1,messages:r},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});const{completion_tokens:u,prompt_tokens:d,total_tokens:p,prompt_tokens_details:h,completion_tokens_details:m}=(l==null?void 0:l.usage)??{};u&&(i.output_tokens=(i.output_tokens??0)+u),d&&(i.input_tokens=(i.input_tokens??0)+d),p&&(i.total_tokens=(i.total_tokens??0)+p),((h==null?void 0:h.audio_tokens)!==null||(h==null?void 0:h.cached_tokens)!==null)&&(i.input_token_details={...(h==null?void 0:h.audio_tokens)!==null&&{audio:h==null?void 0:h.audio_tokens},...(h==null?void 0:h.cached_tokens)!==null&&{cache_read:h==null?void 0:h.cached_tokens}}),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.reasoning_tokens)!==null)&&(i.output_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.reasoning_tokens)!==null&&{reasoning:m==null?void 0:m.reasoning_tokens}});const y=[];for(const f of(l==null?void 0:l.choices)??[]){const g={text:((c=f.message)==null?void 0:c.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(f.message??{role:"assistant"},l)};g.generationInfo={...f.finish_reason?{finish_reason:f.finish_reason}:{},...f.logprobs?{logprobs:f.logprobs}:{}},fs(g.message)&&(g.message.usage_metadata=i),g.message=new an(Object.fromEntries(Object.entries(g.message).filter(([b])=>!b.startsWith("lc_")))),y.push(g)}return{generations:y,llmOutput:{tokenUsage:{promptTokens:i.input_tokens,completionTokens:i.output_tokens,totalTokens:i.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let i=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){const a=T0(t);i+=await this.getNumTokens(a),i+=9}return t&&e.find(a=>a._getType()==="system")&&(i-=4),n==="none"?i+=1:typeof n=="object"&&(i+=await this.getNumTokens(n.name)+4),i}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async t=>{var n;return(n=t.message.additional_kwargs)!=null&&n.function_call?(await this.getNumTokensFromMessages([t.message])).countPerMessage[0]:await this.getNumTokens(t.message.content)}))).reduce((t,n)=>t+n,0)}async getNumTokensFromMessages(e){let t=0,n=0,i=0;this.model==="gpt-3.5-turbo-0301"?(n=4,i=-1):(n=3,i=1);const a=await Promise.all(e.map(async r=>{var p,h,m,y,f,g;const o=await this.getNumTokens(r.content),c=await this.getNumTokens(so(r)),l=r.name!==void 0?i+await this.getNumTokens(r.name):0;let u=o+n+c+l;const d=r;if(d._getType()==="function"&&(u-=2),(p=d.additional_kwargs)!=null&&p.function_call&&(u+=3),(h=d==null?void 0:d.additional_kwargs.function_call)!=null&&h.name&&(u+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.name)),(y=d.additional_kwargs.function_call)==null?void 0:y.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse((f=d.additional_kwargs.function_call)==null?void 0:f.arguments)))}catch(b){console.error("Error parsing function arguments",b,JSON.stringify(d.additional_kwargs.function_call)),u+=await this.getNumTokens((g=d.additional_kwargs.function_call)==null?void 0:g.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(i){throw ii(i)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{var i,a;const n=this._getClientOptions(t);try{return((a=(i=e.text)==null?void 0:i.format)==null?void 0:a.type)==="json_schema"&&!e.stream?await this.client.responses.parse(e,n):await this.client.responses.create(e,n)}catch(r){throw ii(r)}})}async betaParsedCompletionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.parse(e,n)}catch(i){throw ii(i)}})}_getClientOptions(e){if(!this.client){const t={baseURL:this.clientConfig.baseURL},n=Co(t),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new ae(i)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,i,a,r;q0(e)?(n=e.schema,i=e.name,a=e.method,r=e.includeRaw):(n=e,i=t==null?void 0:t.name,a=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw);let o,c;if((t==null?void 0:t.strict)!==void 0&&a==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?a===void 0&&(a="jsonSchema"):a==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),a==="jsonMode"){let p;Kt(n)?(c=Gr.fromZodSchema(n),p=Xt(n)):c=new ta,o=this.withConfig({response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"jsonMode"},schema:p}})}else if(a==="jsonSchema")if(o=this.withConfig({response_format:{type:"json_schema",json_schema:{name:i??"extract",description:Gp(n),schema:n,strict:t==null?void 0:t.strict}},ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:Xt(n)}}),Kt(n)){const p=Gr.fromZodSchema(n);c=Xp.from(h=>"parsed"in h.additional_kwargs?h.additional_kwargs.parsed:p)}else c=new ta;else{let p=i??"extract";if(Kt(n)){const h=Xt(n);o=this.withConfig({tools:[{type:"function",function:{name:p,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:p}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:h},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new na({returnSingle:!0,keyName:p,zodSchema:n})}else{let h;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(h=n,p=n.name):(p=n.title??p,h={name:p,description:n.description??"",parameters:n}),o=this.withConfig({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:p}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:Xt(n)},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new na({returnSingle:!0,keyName:p})}}if(!r)return o.pipe(c);const l=ls.assign({parsed:(p,h)=>c.invoke(p.raw,h)}),u=ls.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return wa.from([{raw:o},d])}}function q0(s){return s!==void 0&&typeof s.schema=="object"}function D0(s,e){const t={...s};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function U0(s,e,t){if(X_(s))return M0(s,e,t);if(Y_(s))return D0({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:kg(s,{cycles:"ref",reused:"ref",override(n){n.jsonSchema.title=e}})}},n=>Og(s,JSON.parse(n)));throw new Error("Unsupported schema response format")}const Gs="0.19.0";let rd=!1,Vn,od,cd,io,ld,ud,dd,pd,hd;function F0(s,e={auto:!1}){if(rd)throw new Error(`you must \`import 'groq-sdk/shims/${s.kind}'\` before importing anything else from groq-sdk`);if(Vn)throw new Error(`can't \`import 'groq-sdk/shims/${s.kind}'\` after \`import 'groq-sdk/shims/${Vn}'\``);rd=e.auto,Vn=s.kind,od=s.fetch,cd=s.FormData,io=s.File,ld=s.ReadableStream,ud=s.getMultipartRequestOptions,dd=s.getDefaultAgent,pd=s.fileFromPath,hd=s.isFsReadStream}class Z0{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function W0({manuallyImported:s}={}){const e=s?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n";let t,n,i,a;try{t=fetch,n=Request,i=Response,a=Headers}catch(r){throw new Error(`this environment is missing the following Web Fetch API type: ${r.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:i,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(r,o)=>({...o,body:new Z0(r)}),getDefaultAgent:r=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:r=>!1}}const md=()=>{Vn||F0(W0(),{auto:!0})};md();class At extends Error{}class Ke extends At{constructor(e,t,n,i){super(`${Ke.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.error=t}static makeMessage(e,t,n){const i=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new ua({message:n,cause:uo(t)});const a=t;return e===400?new yd(e,a,n,i):e===401?new gd(e,a,n,i):e===403?new bd(e,a,n,i):e===404?new _d(e,a,n,i):e===409?new vd(e,a,n,i):e===422?new wd(e,a,n,i):e===429?new xd(e,a,n,i):e>=500?new Od(e,a,n,i):new Ke(e,a,n,i)}}class ao extends Ke{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class ua extends Ke{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class fd extends ua{constructor({message:e}={}){super({message:e??"Request timed out."})}}class yd extends Ke{}class gd extends Ke{}class bd extends Ke{}class _d extends Ke{}class vd extends Ke{}class wd extends Ke{}class xd extends Ke{}class Od extends Ke{}class Xs{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;const i=new z0;async function*a(){if(!e.body)throw t.abort(),new At("Attempted to iterate over a response with no body");const o=new As,c=Ed(e.body);for await(const l of c)for(const u of o.decode(l)){const d=i.decode(u);d&&(yield d)}for(const l of o.flush()){const u=i.decode(l);u&&(yield u)}}async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(const c of a())if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||c.event==="error"){let l;try{l=JSON.parse(c.data)}catch(u){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),u}if(l&&l.error)throw new Ke(l.error.status_code,l.error,l.error.message,void 0);yield l}}o=!0}catch(c){if(c instanceof Error&&c.name==="AbortError")return;throw c}finally{o||t.abort()}}return new Xs(r,t)}static fromReadableStream(e,t){let n=!1;async function*i(){const r=new As,o=Ed(e);for await(const c of o)for(const l of r.decode(c))yield l;for(const c of r.flush())yield c}async function*a(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const o of i())r||o&&(yield JSON.parse(o));r=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{r||t.abort()}}return new Xs(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),i=a=>({next:()=>{if(a.length===0){const r=n.next();e.push(r),t.push(r)}return a.shift()}});return[new Xs(()=>i(e),this.controller),new Xs(()=>i(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new ld({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{const{value:a,done:r}=await t.next();if(r)return i.close();const o=n.encode(JSON.stringify(a)+`
`);i.enqueue(o)}catch(a){i.error(a)}},async cancel(){var i;await((i=t.return)==null?void 0:i.call(t))}})}}class z0{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,i]=V0(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}}class As{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=As.NEWLINE_CHARS.has(t[t.length-1]||"");let i=t.split(As.NEWLINE_REGEXP);return i.length===1&&!n?(this.buffer.push(i[0]),[]):(this.buffer.length>0&&(i=[this.buffer.join("")+i[0],...i.slice(1)],this.buffer=[]),n||(this.buffer=[i.pop()||""]),i)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof at<"u"){if(e instanceof at)return e.toString();if(e instanceof Uint8Array)return at.from(e).toString();throw new At(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new At(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new At("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}As.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]),As.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function V0(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}function Ed(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Md=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function",kd=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&da(s),da=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",K0=s=>kd(s)||Md(s)||hd(s);async function Cd(s,e,t){var i;if(s=await s,kd(s))return s;if(Md(s)){const a=await s.blob();e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=da(a)?[await a.arrayBuffer()]:[a];return new io(r,e,t)}const n=await Q0(s);if(e||(e=J0(s)??"unknown_file"),!(t!=null&&t.type)){const a=(i=n[0])==null?void 0:i.type;typeof a=="string"&&(t={...t,type:a})}return new io(n,e,t)}async function Q0(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(da(s))e.push(await s.arrayBuffer());else if(G0(s))for await(const n of s)e.push(n);else throw new Error(`Unexpected data type: ${typeof s}; constructor: ${(t=s==null?void 0:s.constructor)==null?void 0:t.name}; props: ${H0(s)}`);return e}function H0(s){return`[${Object.getOwnPropertyNames(s).map(e=>`"${e}"`).join(", ")}]`}function J0(s){var e;return ro(s.name)||ro(s.filename)||((e=ro(s.path))==null?void 0:e.split(/[\\/]/).pop())}const ro=s=>{if(typeof s=="string")return s;if(typeof at<"u"&&s instanceof at)return String(s)},G0=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",Ad=s=>s&&typeof s=="object"&&s.body&&s[Symbol.toStringTag]==="MultipartBody",oo=async s=>{const e=await X0(s.body);return ud(e,s)},X0=async s=>{const e=new cd;return await Promise.all(Object.entries(s||{}).map(([t,n])=>co(e,t,n))),e},co=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(K0(t)){const n=await Cd(t);s.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>co(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>co(s,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Ys={};md();async function Pd(s){var i,a;const{response:e}=s;if(s.options.stream)return en("response",e.status,e.url,e.headers,e.body),s.options.__streamClass?s.options.__streamClass.fromSSEResponse(e,s.controller):Xs.fromSSEResponse(e,s.controller);if(e.status===204)return null;if(s.options.__binaryResponse)return e;const t=(a=(i=e.headers.get("content-type"))==null?void 0:i.split(";")[0])==null?void 0:a.trim();if(t!=null&&t.includes("application/json")||t!=null&&t.endsWith("+json")){const r=await e.json();return en("response",e.status,e.url,e.headers,r),r}const n=await e.text();return en("response",e.status,e.url,e.headers,n),n}class pa extends Promise{constructor(e,t=Pd){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new pa(this.responsePromise,async t=>e(await this.parseResponse(t),t))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Y0{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e4,httpAgent:i,fetch:a}){this.baseURL=e,this.maxRetries=lo("maxRetries",t),this.timeout=lo("timeout",n),this.httpAgent=i,this.fetch=a??od}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ib(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${db()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async i=>{const a=i&&da(i==null?void 0:i.body)?new DataView(await i.body.arrayBuffer()):(i==null?void 0:i.body)instanceof DataView?i.body:(i==null?void 0:i.body)instanceof ArrayBuffer?new DataView(i.body):i&&ArrayBuffer.isView(i==null?void 0:i.body)?new DataView(i.body.buffer):i==null?void 0:i.body;return{method:e,path:t,...i,body:a}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof at<"u")return at.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var h;e={...e};const{method:n,path:i,query:a,headers:r={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Ad(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,c=this.calculateContentLength(o),l=this.buildURL(i,a);"timeout"in e&&lo("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const u=e.httpAgent??this.httpAgent??dd(l),d=e.timeout+1e3;typeof((h=u==null?void 0:u.options)==null?void 0:h.timeout)=="number"&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);const p=this.buildHeaders({options:e,headers:r,contentLength:c,retryCount:t});return{req:{method:n,...o&&{body:o},headers:p,...u&&{agent:u},signal:e.signal??null},url:l,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:i}){const a={};n&&(a["content-length"]=n);const r=this.defaultHeaders(e);return Rd(a,r),Rd(a,t),Ad(e.body)&&Vn!=="node"&&delete a["content-type"],ha(r,"x-stainless-retry-count")===void 0&&ha(t,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(i)),ha(r,"x-stainless-timeout")===void 0&&ha(t,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,i){return Ke.generate(e,t,n,i)}request(e,t=null){return new pa(this.makeRequest(e,t))}async makeRequest(e,t){var d,p;const n=await e,i=n.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);const{req:a,url:r,timeout:o}=this.buildRequest(n,{retryCount:i-t});if(await this.prepareRequest(a,{url:r,options:n}),en("request",r,n,a.headers),(d=n.signal)==null?void 0:d.aborted)throw new ao;const c=new AbortController,l=await this.fetchWithTimeout(r,a,o,c).catch(uo);if(l instanceof Error){if((p=n.signal)!=null&&p.aborted)throw new ao;if(t)return this.retryRequest(n,t);throw l.name==="AbortError"?new fd:new ua({cause:l})}const u=tb(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){const f=`retrying, ${t} attempts remaining`;return en(`response (error; ${f})`,l.status,r,u),this.retryRequest(n,t,u)}const h=await l.text().catch(f=>uo(f).message),m=ab(h),y=m?void 0:h;throw en(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,r,u,y),this.makeStatusError(l.status,m,y,u)}return{response:l,options:n,controller:c}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new eb(this,n,e)}buildURL(e,t){const n=ob(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return lb(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new At(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,i){const{signal:a,...r}=t||{};a&&a.addEventListener("abort",()=>i.abort());const o=setTimeout(()=>i.abort(),n),c={signal:i.signal,...r};return c.method&&(c.method=c.method.toUpperCase()),this.fetch.call(void 0,e,c).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let i;const a=n==null?void 0:n["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(i=o)}const r=n==null?void 0:n["retry-after"];if(r&&!i){const o=parseFloat(r);Number.isNaN(o)?i=Date.parse(r)-Date.now():i=o*1e3}if(!(i&&0<=i&&i<60*1e3)){const o=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,o)}return await cb(i),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e,i=Math.min(.5*Math.pow(2,n),8),a=1-Math.random()*.25;return i*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Gs}`}}class eb extends pa{constructor(e,t,n){super(t,async i=>new n(e,i.response,await Pd(i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const tb=s=>new Proxy(Object.fromEntries(s.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),sb=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gs,"X-Stainless-OS":Td(Deno.build.os),"X-Stainless-Arch":Sd(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":Vt.version};if(Object.prototype.toString.call(typeof Vt<"u"?Vt:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gs,"X-Stainless-OS":Td(Vt.platform),"X-Stainless-Arch":Sd(Vt.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":Vt.version};const s=nb();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Gs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function nb(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const i=n[1]||0,a=n[2]||0,r=n[3]||0;return{browser:e,version:`${i}.${a}.${r}`}}}return null}const Sd=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",Td=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let Nd;const ib=()=>Nd??(Nd=sb()),ab=s=>{try{return JSON.parse(s)}catch{return}},rb=/^[a-z][a-z0-9+.-]*:/i,ob=s=>rb.test(s),cb=s=>new Promise(e=>setTimeout(e,s)),lo=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new At(`${s} must be an integer`);if(e<0)throw new At(`${s} must be a positive integer`);return e},uo=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null)try{return new Error(JSON.stringify(s))}catch{}return new Error(s)},jd=s=>{var e,t,n,i;if(typeof Vt<"u")return((e=Ys==null?void 0:Ys[s])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(i=(n=(t=Deno.env)==null?void 0:t.get)==null?void 0:n.call(t,s))==null?void 0:i.trim()};function lb(s){if(!s)return!0;for(const e in s)return!1;return!0}function ub(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Rd(s,e){for(const t in e){if(!ub(e,t))continue;const n=t.toLowerCase();if(!n)continue;const i=e[t];i===null?delete s[n]:i!==void 0&&(s[n]=i)}}function en(s,...e){typeof Vt<"u"&&(Ys==null?void 0:Ys.DEBUG)==="true"&&console.log(`Groq:DEBUG:${s}`,...e)}const db=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}),pb=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",hb=s=>typeof(s==null?void 0:s.get)=="function",ha=(s,e)=>{var n;const t=e.toLowerCase();if(hb(s)){const i=((n=e[0])==null?void 0:n.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,r,o)=>r+o.toUpperCase());for(const a of[e,t,e.toUpperCase(),i]){const r=s.get(a);if(r)return r}}for(const[i,a]of Object.entries(s))if(i.toLowerCase()===t)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};class Pt{constructor(e){this._client=e}}class Id extends Pt{create(e,t){return this._client.post("/openai/v1/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class $d extends Pt{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",oo({body:e,...t}))}}class Ld extends Pt{create(e,t){return this._client.post("/openai/v1/audio/translations",oo({body:e,...t}))}}class Kn extends Pt{constructor(){super(...arguments),this.speech=new Id(this._client),this.transcriptions=new $d(this._client),this.translations=new Ld(this._client)}}Kn.Speech=Id,Kn.Transcriptions=$d,Kn.Translations=Ld;class Bd extends Pt{create(e,t){return this._client.post("/openai/v1/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/openai/v1/batches/${e}`,t)}list(e){return this._client.get("/openai/v1/batches",e)}cancel(e,t){return this._client.post(`/openai/v1/batches/${e}/cancel`,t)}}let qd=class extends Pt{create(s,e){return this._client.post("/openai/v1/chat/completions",{body:s,...e,stream:s.stream??!1})}};class po extends Pt{constructor(){super(...arguments),this.completions=new qd(this._client)}}po.Completions=qd;class Dd extends Pt{}class Ud extends Pt{create(e,t){return this._client.post("/openai/v1/embeddings",{body:e,...t})}}class Fd extends Pt{create(e,t){return this._client.post("/openai/v1/files",oo({body:e,...t}))}list(e){return this._client.get("/openai/v1/files",e)}delete(e,t){return this._client.delete(`/openai/v1/files/${e}`,t)}content(e,t){return this._client.get(`/openai/v1/files/${e}/content`,t)}info(e,t){return this._client.get(`/openai/v1/files/${e}`,t)}}class Zd extends Pt{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,t)}}var Wd;class ge extends Y0{constructor({baseURL:e=jd("GROQ_BASE_URL"),apiKey:t=jd("GROQ_API_KEY"),...n}={}){if(t===void 0)throw new At("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");const i={apiKey:t,...n,baseURL:e||"https://api.groq.com"};if(!i.dangerouslyAllowBrowser&&pb())throw new At(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:i.baseURL,timeout:i.timeout??6e4,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Dd(this),this.chat=new po(this),this.embeddings=new Ud(this),this.audio=new Kn(this),this.models=new Zd(this),this.batches=new Bd(this),this.files=new Fd(this),this._options=i,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}Wd=ge,ge.Groq=Wd,ge.DEFAULT_TIMEOUT=6e4,ge.GroqError=At,ge.APIError=Ke,ge.APIConnectionError=ua,ge.APIConnectionTimeoutError=fd,ge.APIUserAbortError=ao,ge.NotFoundError=_d,ge.ConflictError=vd,ge.RateLimitError=xd,ge.BadRequestError=yd,ge.AuthenticationError=gd,ge.InternalServerError=Od,ge.PermissionDeniedError=bd,ge.UnprocessableEntityError=wd,ge.toFile=Cd,ge.fileFromPath=pd,ge.Completions=Dd,ge.Chat=po,ge.Embeddings=Ud,ge.Audio=Kn,ge.Models=Zd,ge.Batches=Bd,ge.Files=Fd;const mb=["frequency_penalty","function_call","functions","logit_bias","logprobs","max_completion_tokens","max_tokens","n","parallel_tool_calls","presence_penalty","reasoning_format","response_format","seed","service_tier","stop","temperature","tool_choice","top_logprobs","top_p"],fb=["headers","promptIndex","stream_options","tools"],yb=[...mb,...fb];function gb(s){const e=s._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}}function zd(s){return s.map(e=>{var n;if(typeof e.content!="string")throw new Error("Non string message content not supported");const t={role:gb(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return fs(e)&&((n=e.tool_calls)!=null&&n.length)?t.tool_calls=e.tool_calls.map(Zu):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function bb(s,e,t){const n=s.tool_calls;switch(s.role){case"assistant":{const i=[],a=[];for(const r of n??[])try{i.push(sa(r,{returnId:!0}))}catch(o){a.push(Xr(r,o.message))}return new an({content:s.content||"",additional_kwargs:{tool_calls:n},tool_calls:i,invalid_tool_calls:a,usage_metadata:e,response_metadata:t})}default:return new Oa(s.content||"",s.role??"unknown")}}function _b(s,e,t,n){var p,h;const i=s.role??e,a=s.content??"";let r;s.function_call?r={function_call:s.function_call}:s.tool_calls?r={tool_calls:s.tool_calls}:r={},s.audio&&(r.audio={...s.audio,index:t.choices[0].index});let o,c=n,l;const u=t.x_groq;u!=null&&u.usage&&(o={input_tokens:u.usage.prompt_tokens,output_tokens:u.usage.completion_tokens,total_tokens:u.usage.total_tokens},l={completion_time:u.usage.completion_time,prompt_time:u.usage.prompt_time,queue_time:u.usage.queue_time,total_time:u.usage.total_time}),u!=null&&u.id&&(c=u.id);const d={usage:o,timing:l};if(i==="user")return new th({content:a,response_metadata:d});if(i==="assistant"){const m=[];if(Array.isArray(s.tool_calls))for(const y of s.tool_calls)m.push({name:(p=y.function)==null?void 0:p.name,args:(h=y.function)==null?void 0:h.arguments,id:y.id,index:y.index,type:"tool_call_chunk"});return new rn({content:a,tool_call_chunks:m,additional_kwargs:r,id:c,response_metadata:d})}else return i==="system"?new Ea({content:a,response_metadata:d}):i==="developer"?new Ea({content:a,response_metadata:d,additional_kwargs:{__openai_role__:"developer"}}):i==="function"?new sh({content:a,additional_kwargs:r,name:s.name,response_metadata:d}):i==="tool"?new nh({content:a,additional_kwargs:r,tool_call_id:s.tool_call_id,response_metadata:d}):new ih({content:a,role:i,response_metadata:d})}class vb extends Ut{get lc_serialized_keys(){return["client","model","temperature","stop","stopSequences","maxTokens","streaming","apiKey","streamUsage","topP","frequencyPenalty","presencePenalty","logprobs","n","logitBias","user","reasoningFormat","serviceTier","topLogprobs"]}static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}get callKeys(){return[...super.callKeys,...yb]}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","groq"]}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceTier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=e.apiKey||xa("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');const n={"User-Agent":"langchainjs",...e.defaultHeaders??{}};this.client=new ge({apiKey:t,dangerouslyAllowBrowser:!0,baseURL:e.baseUrl,timeout:e.timeout,httpAgent:e.httpAgent,fetch:e.fetch,maxRetries:0,defaultHeaders:n,defaultQuery:e.defaultQuery}),this.apiKey=t,this.temperature=e.temperature??this.temperature,this.model=e.model,this.streaming=e.streaming??this.streaming,this.stop=e.stopSequences??(typeof e.stop=="string"?[e.stop]:e.stop)??[],this.stopSequences=this.stop,this.maxTokens=e.maxTokens,this.topP=e.topP,this.frequencyPenalty=e.frequencyPenalty,this.presencePenalty=e.presencePenalty,this.logprobs=e.logprobs,this.n=e.n,this.logitBias=e.logitBias,this.user=e.user}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"groq",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??this.temperature,ls_max_tokens:t.max_tokens??this.maxTokens,ls_stop:e.stop}}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e,t){var r;const n=super.invocationParams(e);let i={};(e==null?void 0:e.stream_options)!==void 0?i={stream_options:e.stream_options}:(this.streamUsage&&this.streaming||t!=null&&t.streaming)&&(i={stream_options:{include_usage:!0}});const a={model:this.model,frequency_penalty:this.frequencyPenalty,function_call:e==null?void 0:e.function_call,functions:e==null?void 0:e.functions,logit_bias:this.logitBias,logprobs:this.logprobs,n:this.n,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,presence_penalty:this.presencePenalty,reasoning_format:this.reasoningFormat,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,service_tier:this.serviceTier,stop:(e==null?void 0:e.stop)??this.stopSequences,temperature:(e==null?void 0:e.temperature)??this.temperature,tool_choice:wb(e==null?void 0:e.tool_choice),tools:(r=e==null?void 0:e.tools)!=null&&r.length?e.tools.map(o=>to(o)):void 0,top_logprobs:this.topLogprobs,top_p:this.topP,user:this.user,stream:this.streaming,...n,...i};return a.max_completion_tokens=(e==null?void 0:e.max_completion_tokens)??(e==null?void 0:e.max_tokens)??this.maxTokens,a.max_completion_tokens===-1&&delete a.max_completion_tokens,a}bindTools(e,t){return this.withConfig({tools:e.map(n=>to(n)),...t})}async*_streamResponseChunks(e,t,n){var u,d;const i=this.invocationParams(t,{streaming:!0}),a=zd(e),r=await this.completionWithRetry({...i,messages:a,stream:!0},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});let o,c,l;for await(const p of r){l=p;const h=p==null?void 0:p.choices[0];if(!h)continue;(u=h.delta)!=null&&u.role&&(o=h.delta.role);const m=_b(h.delta,o,p,c),y={prompt:t.promptIndex??0,completion:h.index??0};if(typeof m.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const f={...y};h.finish_reason!=null&&(f.finish_reason=h.finish_reason,f.system_fingerprint=p.system_fingerprint,f.model_name=p.model);const g=new ys({message:m,text:m.content,generationInfo:f});yield g,await(n==null?void 0:n.handleLLMNewToken(g.text??"",y,void 0,void 0,void 0,{chunk:g}))}if(l&&("choices"in l&&delete l.choices,yield new ys({message:new rn({content:"",response_metadata:l}),text:""})),(d=t.signal)==null?void 0:d.aborted)throw new Error("AbortError")}async _generate(e,t,n){var i;if(this.streaming){const a={},r=this._streamResponseChunks(e,t,n),o={};for await(const c of r){const l=((i=c.generationInfo)==null?void 0:i.completion)??0;o[l]===void 0?o[l]=c:o[l]=o[l].concat(c)}return{generations:Object.entries(o).sort(([c],[l])=>parseInt(c,10)-parseInt(l,10)).map(([c,l])=>l),llmOutput:{estimatedTokenUsage:a}}}else return this._generateNonStreaming(e,t,n)}async _generateNonStreaming(e,t,n){var l;const i={},a=this.invocationParams(t),r=zd(e),o=await this.completionWithRetry({...a,stream:!1,messages:r},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});if("usage"in o&&o.usage){const{completion_tokens:u,prompt_tokens:d,total_tokens:p}=o.usage;u&&(i.completionTokens=(i.completionTokens??0)+u),d&&(i.promptTokens=(i.promptTokens??0)+d),p&&(i.totalTokens=(i.totalTokens??0)+p)}const c=[];if("choices"in o&&o.choices)for(const u of o.choices){const d=((l=u.message)==null?void 0:l.content)??"";let p;i.totalTokens!==void 0&&(p={input_tokens:i.promptTokens??0,output_tokens:i.completionTokens??0,total_tokens:i.totalTokens});const{choices:h,...m}=o,y={text:d,message:bb(u.message??{role:"assistant"},p,m)};y.generationInfo={...u.finish_reason?{finish_reason:u.finish_reason}:{},...u.logprobs?{logprobs:u.logprobs}:{}},c.push(y)}return{generations:c,llmOutput:{tokenUsage:i}}}withStructuredOutput(e,t){const n=e,i=t==null?void 0:t.name,a=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw;let o=i??"extract",c,l;if(a==="jsonMode")l=this.withConfig({response_format:{type:"json_object"}}),Kt(n)?c=Gr.fromZodSchema(n):c=new ta;else if(Kt(n)){const h=Xt(n);l=this.bindTools([{type:"function",function:{name:o,description:h.description,parameters:h}}]).withConfig({tool_choice:{type:"function",function:{name:o}}}),c=new na({returnSingle:!0,keyName:o,zodSchema:n})}else{let h;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(h=n,o=n.name):(o=n.title??o,h={name:o,description:n.description??"",parameters:n}),l=this.bindTools([{type:"function",function:h}]).withConfig({tool_choice:{type:"function",function:{name:o}}}),c=new na({returnSingle:!0,keyName:o})}if(!r)return l.pipe(c).withConfig({runName:"ChatGroqStructuredOutput"});const u=ls.assign({parsed:(h,m)=>c.invoke(h.raw,m)}),d=ls.assign({parsed:()=>null}),p=u.withFallbacks({fallbacks:[d]});return wa.from([{raw:l},p]).withConfig({runName:"ChatGroqStructuredOutput"})}}function wb(s){if(s)return s==="any"||s==="required"?"required":s==="auto"?"auto":s==="none"?"none":typeof s=="string"?{type:"function",function:{name:s}}:s}var Vd;(function(s){s.STRING="string",s.NUMBER="number",s.INTEGER="integer",s.BOOLEAN="boolean",s.ARRAY="array",s.OBJECT="object"})(Vd||(Vd={}));var Kd;(function(s){s.LANGUAGE_UNSPECIFIED="language_unspecified",s.PYTHON="python"})(Kd||(Kd={}));var Qd;(function(s){s.OUTCOME_UNSPECIFIED="outcome_unspecified",s.OUTCOME_OK="outcome_ok",s.OUTCOME_FAILED="outcome_failed",s.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(Qd||(Qd={}));const Hd=["user","model","function","system"];var Jd;(function(s){s.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",s.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",s.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",s.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",s.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",s.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(Jd||(Jd={}));var Gd;(function(s){s.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE"})(Gd||(Gd={}));var Xd;(function(s){s.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",s.NEGLIGIBLE="NEGLIGIBLE",s.LOW="LOW",s.MEDIUM="MEDIUM",s.HIGH="HIGH"})(Xd||(Xd={}));var Yd;(function(s){s.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",s.SAFETY="SAFETY",s.OTHER="OTHER"})(Yd||(Yd={}));var Qn;(function(s){s.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",s.STOP="STOP",s.MAX_TOKENS="MAX_TOKENS",s.SAFETY="SAFETY",s.RECITATION="RECITATION",s.LANGUAGE="LANGUAGE",s.BLOCKLIST="BLOCKLIST",s.PROHIBITED_CONTENT="PROHIBITED_CONTENT",s.SPII="SPII",s.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",s.OTHER="OTHER"})(Qn||(Qn={}));var ep;(function(s){s.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",s.RETRIEVAL_QUERY="RETRIEVAL_QUERY",s.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",s.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",s.CLASSIFICATION="CLASSIFICATION",s.CLUSTERING="CLUSTERING"})(ep||(ep={}));var tn;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.AUTO="AUTO",s.ANY="ANY",s.NONE="NONE"})(tn||(tn={}));var tp;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.MODE_DYNAMIC="MODE_DYNAMIC"})(tp||(tp={}));class Qe extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class sn extends Qe{constructor(e,t){super(e),this.response=t}}class sp extends Qe{constructor(e,t,n,i){super(e),this.status=t,this.statusText=n,this.errorDetails=i}}class us extends Qe{}class np extends Qe{}const xb="https://generativelanguage.googleapis.com",Ob="v1beta",Eb="0.24.1",Mb="genai-js";var Ps;(function(s){s.GENERATE_CONTENT="generateContent",s.STREAM_GENERATE_CONTENT="streamGenerateContent",s.COUNT_TOKENS="countTokens",s.EMBED_CONTENT="embedContent",s.BATCH_EMBED_CONTENTS="batchEmbedContents"})(Ps||(Ps={}));class kb{constructor(e,t,n,i,a){this.model=e,this.task=t,this.apiKey=n,this.stream=i,this.requestOptions=a}toString(){var e,t;const n=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||Ob;let i=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||xb}/${n}/${this.model}:${this.task}`;return this.stream&&(i+="?alt=sse"),i}}function Cb(s){const e=[];return s!=null&&s.apiClient&&e.push(s.apiClient),e.push(`${Mb}/${Eb}`),e.join(" ")}async function Ab(s){var e;const t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",Cb(s.requestOptions)),t.append("x-goog-api-key",s.apiKey);let n=(e=s.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(n){if(!(n instanceof Headers))try{n=new Headers(n)}catch(i){throw new us(`unable to convert customHeaders value ${JSON.stringify(n)} to Headers: ${i.message}`)}for(const[i,a]of n.entries()){if(i==="x-goog-api-key")throw new us(`Cannot set reserved header name ${i}`);if(i==="x-goog-api-client")throw new us(`Header name ${i} can only be set using the apiClient field`);t.append(i,a)}}return t}async function Pb(s,e,t,n,i,a){const r=new kb(s,e,t,n,a);return{url:r.toString(),fetchOptions:Object.assign(Object.assign({},jb(a)),{method:"POST",headers:await Ab(r),body:i})}}async function Hn(s,e,t,n,i,a={},r=fetch){const{url:o,fetchOptions:c}=await Pb(s,e,t,n,i,a);return Sb(o,c,r)}async function Sb(s,e,t=fetch){let n;try{n=await t(s,e)}catch(i){Tb(i,s)}return n.ok||await Nb(n,s),n}function Tb(s,e){let t=s;throw t.name==="AbortError"?(t=new np(`Request aborted when fetching ${e.toString()}: ${s.message}`),t.stack=s.stack):s instanceof sp||s instanceof us||(t=new Qe(`Error fetching from ${e.toString()}: ${s.message}`),t.stack=s.stack),t}async function Nb(s,e){let t="",n;try{const i=await s.json();t=i.error.message,i.error.details&&(t+=` ${JSON.stringify(i.error.details)}`,n=i.error.details)}catch{}throw new sp(`Error fetching from ${e.toString()}: [${s.status} ${s.statusText}] ${t}`,s.status,s.statusText,n)}function jb(s){const e={};if((s==null?void 0:s.signal)!==void 0||(s==null?void 0:s.timeout)>=0){const t=new AbortController;(s==null?void 0:s.timeout)>=0&&setTimeout(()=>t.abort(),s.timeout),s!=null&&s.signal&&s.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function ho(s){return s.text=()=>{if(s.candidates&&s.candidates.length>0){if(s.candidates.length>1&&console.warn(`This response had ${s.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),ma(s.candidates[0]))throw new sn(`${ds(s)}`,s);return Rb(s)}else if(s.promptFeedback)throw new sn(`Text not available. ${ds(s)}`,s);return""},s.functionCall=()=>{if(s.candidates&&s.candidates.length>0){if(s.candidates.length>1&&console.warn(`This response had ${s.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ma(s.candidates[0]))throw new sn(`${ds(s)}`,s);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),ip(s)[0]}else if(s.promptFeedback)throw new sn(`Function call not available. ${ds(s)}`,s)},s.functionCalls=()=>{if(s.candidates&&s.candidates.length>0){if(s.candidates.length>1&&console.warn(`This response had ${s.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ma(s.candidates[0]))throw new sn(`${ds(s)}`,s);return ip(s)}else if(s.promptFeedback)throw new sn(`Function call not available. ${ds(s)}`,s)},s}function Rb(s){var e,t,n,i;const a=[];if(!((t=(e=s.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const r of(i=(n=s.candidates)===null||n===void 0?void 0:n[0].content)===null||i===void 0?void 0:i.parts)r.text&&a.push(r.text),r.executableCode&&a.push("\n```"+r.executableCode.language+`
`+r.executableCode.code+"\n```\n"),r.codeExecutionResult&&a.push("\n```\n"+r.codeExecutionResult.output+"\n```\n");return a.length>0?a.join(""):""}function ip(s){var e,t,n,i;const a=[];if(!((t=(e=s.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const r of(i=(n=s.candidates)===null||n===void 0?void 0:n[0].content)===null||i===void 0?void 0:i.parts)r.functionCall&&a.push(r.functionCall);if(a.length>0)return a}const Ib=[Qn.RECITATION,Qn.SAFETY,Qn.LANGUAGE];function ma(s){return!!s.finishReason&&Ib.includes(s.finishReason)}function ds(s){var e,t,n;let i="";if((!s.candidates||s.candidates.length===0)&&s.promptFeedback)i+="Response was blocked",!((e=s.promptFeedback)===null||e===void 0)&&e.blockReason&&(i+=` due to ${s.promptFeedback.blockReason}`),!((t=s.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(i+=`: ${s.promptFeedback.blockReasonMessage}`);else if(!((n=s.candidates)===null||n===void 0)&&n[0]){const a=s.candidates[0];ma(a)&&(i+=`Candidate was blocked due to ${a.finishReason}`,a.finishMessage&&(i+=`: ${a.finishMessage}`))}return i}function Jn(s){return this instanceof Jn?(this.v=s,this):new Jn(s)}function $b(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(s,e||[]),i,a=[];return i={},r("next"),r("throw"),r("return"),i[Symbol.asyncIterator]=function(){return this},i;function r(p){n[p]&&(i[p]=function(h){return new Promise(function(m,y){a.push([p,h,m,y])>1||o(p,h)})})}function o(p,h){try{c(n[p](h))}catch(m){d(a[0][3],m)}}function c(p){p.value instanceof Jn?Promise.resolve(p.value.v).then(l,u):d(a[0][2],p)}function l(p){o("next",p)}function u(p){o("throw",p)}function d(p,h){p(h),a.shift(),a.length&&o(a[0][0],a[0][1])}}const ap=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Lb(s){const e=s.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=Db(e),[n,i]=t.tee();return{stream:qb(n),response:Bb(i)}}async function Bb(s){const e=[],t=s.getReader();for(;;){const{done:n,value:i}=await t.read();if(n)return ho(Ub(e));e.push(i)}}function qb(s){return $b(this,arguments,function*(){const e=s.getReader();for(;;){const{value:t,done:n}=yield Jn(e.read());if(n)break;yield yield Jn(ho(t))}})}function Db(s){const e=s.getReader();return new ReadableStream({start(t){let n="";return i();function i(){return e.read().then(({value:a,done:r})=>{if(r){if(n.trim()){t.error(new Qe("Failed to parse stream"));return}t.close();return}n+=a;let o=n.match(ap),c;for(;o;){try{c=JSON.parse(o[1])}catch{t.error(new Qe(`Error parsing JSON response: "${o[1]}"`));return}t.enqueue(c),n=n.substring(o[0].length),o=n.match(ap)}return i()}).catch(a=>{let r=a;throw r.stack=a.stack,r.name==="AbortError"?r=new np("Request aborted when reading from the stream"):r=new Qe("Error reading from the stream"),r})}}})}function Ub(s){const e=s[s.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(const n of s){if(n.candidates){let i=0;for(const a of n.candidates)if(t.candidates||(t.candidates=[]),t.candidates[i]||(t.candidates[i]={index:i}),t.candidates[i].citationMetadata=a.citationMetadata,t.candidates[i].groundingMetadata=a.groundingMetadata,t.candidates[i].finishReason=a.finishReason,t.candidates[i].finishMessage=a.finishMessage,t.candidates[i].safetyRatings=a.safetyRatings,a.content&&a.content.parts){t.candidates[i].content||(t.candidates[i].content={role:a.content.role||"user",parts:[]});const r={};for(const o of a.content.parts)o.text&&(r.text=o.text),o.functionCall&&(r.functionCall=o.functionCall),o.executableCode&&(r.executableCode=o.executableCode),o.codeExecutionResult&&(r.codeExecutionResult=o.codeExecutionResult),Object.keys(r).length===0&&(r.text=""),t.candidates[i].content.parts.push(r)}i++}n.usageMetadata&&(t.usageMetadata=n.usageMetadata)}return t}async function rp(s,e,t,n){const i=await Hn(e,Ps.STREAM_GENERATE_CONTENT,s,!0,JSON.stringify(t),n);return Lb(i)}async function op(s,e,t,n){const i=await(await Hn(e,Ps.GENERATE_CONTENT,s,!1,JSON.stringify(t),n)).json();return{response:ho(i)}}function cp(s){if(s!=null){if(typeof s=="string")return{role:"system",parts:[{text:s}]};if(s.text)return{role:"system",parts:[s]};if(s.parts)return s.role?s:{role:"system",parts:s.parts}}}function Gn(s){let e=[];if(typeof s=="string")e=[{text:s}];else for(const t of s)typeof t=="string"?e.push({text:t}):e.push(t);return Fb(e)}function Fb(s){const e={role:"user",parts:[]},t={role:"function",parts:[]};let n=!1,i=!1;for(const a of s)"functionResponse"in a?(t.parts.push(a),i=!0):(e.parts.push(a),n=!0);if(n&&i)throw new Qe("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!n&&!i)throw new Qe("No content is provided for sending chat message.");return n?e:t}function Zb(s,e){var t;let n={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(t=e==null?void 0:e.cachedContent)===null||t===void 0?void 0:t.name,contents:[]};const i=s.generateContentRequest!=null;if(s.contents){if(i)throw new us("CountTokensRequest must have one of contents or generateContentRequest, not both.");n.contents=s.contents}else if(i)n=Object.assign(Object.assign({},n),s.generateContentRequest);else{const a=Gn(s);n.contents=[a]}return{generateContentRequest:n}}function lp(s){let e;return s.contents?e=s:e={contents:[Gn(s)]},s.systemInstruction&&(e.systemInstruction=cp(s.systemInstruction)),e}function Wb(s){return typeof s=="string"||Array.isArray(s)?{content:Gn(s)}:s}const up=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],zb={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function Vb(s){let e=!1;for(const t of s){const{role:n,parts:i}=t;if(!e&&n!=="user")throw new Qe(`First content should be with role 'user', got ${n}`);if(!Hd.includes(n))throw new Qe(`Each item should include role field. Got ${n} but valid roles are: ${JSON.stringify(Hd)}`);if(!Array.isArray(i))throw new Qe("Content should have 'parts' property with an array of Parts");if(i.length===0)throw new Qe("Each Content should have at least one part");const a={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const o of i)for(const c of up)c in o&&(a[c]+=1);const r=zb[n];for(const o of up)if(!r.includes(o)&&a[o]>0)throw new Qe(`Content with role '${n}' can't contain '${o}' part`);e=!0}}function dp(s){var e;if(s.candidates===void 0||s.candidates.length===0)return!1;const t=(e=s.candidates[0])===null||e===void 0?void 0:e.content;if(t===void 0||t.parts===void 0||t.parts.length===0)return!1;for(const n of t.parts)if(n===void 0||Object.keys(n).length===0||n.text!==void 0&&n.text==="")return!1;return!0}const pp="SILENT_ERROR";class Kb{constructor(e,t,n,i={}){this.model=t,this.params=n,this._requestOptions=i,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,n!=null&&n.history&&(Vb(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,i,a,r,o,c;await this._sendPromise;const l=Gn(e),u={safetySettings:(n=this.params)===null||n===void 0?void 0:n.safetySettings,generationConfig:(i=this.params)===null||i===void 0?void 0:i.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,l]},d=Object.assign(Object.assign({},this._requestOptions),t);let p;return this._sendPromise=this._sendPromise.then(()=>op(this._apiKey,this.model,u,d)).then(h=>{var m;if(dp(h.response)){this._history.push(l);const y=Object.assign({parts:[],role:"model"},(m=h.response.candidates)===null||m===void 0?void 0:m[0].content);this._history.push(y)}else{const y=ds(h.response);y&&console.warn(`sendMessage() was unsuccessful. ${y}. Inspect response object for details.`)}p=h}).catch(h=>{throw this._sendPromise=Promise.resolve(),h}),await this._sendPromise,p}async sendMessageStream(e,t={}){var n,i,a,r,o,c;await this._sendPromise;const l=Gn(e),u={safetySettings:(n=this.params)===null||n===void 0?void 0:n.safetySettings,generationConfig:(i=this.params)===null||i===void 0?void 0:i.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,l]},d=Object.assign(Object.assign({},this._requestOptions),t),p=rp(this._apiKey,this.model,u,d);return this._sendPromise=this._sendPromise.then(()=>p).catch(h=>{throw new Error(pp)}).then(h=>h.response).then(h=>{if(dp(h)){this._history.push(l);const m=Object.assign({},h.candidates[0].content);m.role||(m.role="model"),this._history.push(m)}else{const m=ds(h);m&&console.warn(`sendMessageStream() was unsuccessful. ${m}. Inspect response object for details.`)}}).catch(h=>{h.message!==pp&&console.error(h)}),p}}async function Qb(s,e,t,n){return(await Hn(e,Ps.COUNT_TOKENS,s,!1,JSON.stringify(t),n)).json()}async function Hb(s,e,t,n){return(await Hn(e,Ps.EMBED_CONTENT,s,!1,JSON.stringify(t),n)).json()}async function Jb(s,e,t,n){const i=t.requests.map(a=>Object.assign(Object.assign({},a),{model:e}));return(await Hn(e,Ps.BATCH_EMBED_CONTENTS,s,!1,JSON.stringify({requests:i}),n)).json()}class hp{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=cp(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;const i=lp(e),a=Object.assign(Object.assign({},this._requestOptions),t);return op(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},i),a)}async generateContentStream(e,t={}){var n;const i=lp(e),a=Object.assign(Object.assign({},this._requestOptions),t);return rp(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},i),a)}startChat(e){var t;return new Kb(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const n=Zb(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),i=Object.assign(Object.assign({},this._requestOptions),t);return Qb(this.apiKey,this.model,n,i)}async embedContent(e,t={}){const n=Wb(e),i=Object.assign(Object.assign({},this._requestOptions),t);return Hb(this.apiKey,this.model,n,i)}async batchEmbedContents(e,t={}){const n=Object.assign(Object.assign({},this._requestOptions),t);return Jb(this.apiKey,this.model,e,n)}}Ma=class{constructor(s){this.apiKey=s}getGenerativeModel(s,e){if(!s.model)throw new Qe("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new hp(this.apiKey,s,e)}getGenerativeModelFromCachedContent(s,e,t){if(!s.name)throw new us("Cached content must contain a `name` field.");if(!s.model)throw new us("Cached content must contain a `model` field.");const n=["model","systemInstruction"];for(const a of n)if(e!=null&&e[a]&&s[a]&&(e==null?void 0:e[a])!==s[a]){if(a==="model"){const r=e.model.startsWith("models/")?e.model.replace("models/",""):e.model,o=s.model.startsWith("models/")?s.model.replace("models/",""):s.model;if(r===o)continue}throw new us(`Different value for "${a}" specified in modelParams (${e[a]}) and cachedContent (${s[a]})`)}const i=Object.assign(Object.assign({},e),{model:s.model,tools:s.tools,toolConfig:s.toolConfig,systemInstruction:s.systemInstruction,cachedContent:s});return new hp(this.apiKey,i,t)}};function Ss(s){if(typeof s=="object"&&s!==null){const e={...s};"additionalProperties"in e&&delete e.additionalProperties,"$schema"in e&&delete e.$schema,"strict"in e&&delete e.strict;for(const t in e)t in e&&(Array.isArray(e[t])?e[t]=e[t].map(Ss):typeof e[t]=="object"&&e[t]!==null&&(e[t]=Ss(e[t])));return e}return s}function mo(s){const e=Ss(Kt(s)?Xt(s):s),{$schema:t,...n}=e;return n}function Gb(s){const e=Ss(s),{$schema:t,...n}=e;return n}const Ze=[];for(let s=0;s<256;++s)Ze.push((s+256).toString(16).slice(1));function Xb(s,e=0){return(Ze[s[e+0]]+Ze[s[e+1]]+Ze[s[e+2]]+Ze[s[e+3]]+"-"+Ze[s[e+4]]+Ze[s[e+5]]+"-"+Ze[s[e+6]]+Ze[s[e+7]]+"-"+Ze[s[e+8]]+Ze[s[e+9]]+"-"+Ze[s[e+10]]+Ze[s[e+11]]+Ze[s[e+12]]+Ze[s[e+13]]+Ze[s[e+14]]+Ze[s[e+15]]).toLowerCase()}let fo;const Yb=new Uint8Array(16);function e_(){if(!fo){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");fo=crypto.getRandomValues.bind(crypto)}return fo(Yb)}const t_=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),mp={randomUUID:t_};function fp(s,e,t){var i;if(mp.randomUUID&&!e&&!s)return mp.randomUUID();s=s||{};const n=s.random??((i=s.rng)==null?void 0:i.call(s))??e_();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Xb(n)}function s_(s){const e=s._getType();return Oa.isInstance(s)?s.role:e==="tool"?e:s.name??e}function n_(s){switch(s){case"supervisor":case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${s}`)}}function i_(s){if("mimeType"in s&&"data"in s)return{inlineData:{mimeType:s.mimeType,data:s.data}};if("mimeType"in s&&"fileUri"in s)return{fileData:{mimeType:s.mimeType,fileUri:s.fileUri}};throw new Error("Invalid media content")}function a_(s,e){var t;return(t=e.map(n=>fs(n)?n.tool_calls??[]:[]).flat().find(n=>n.id===s.tool_call_id))==null?void 0:t.name}function r_(s){return{providerName:"Google Gemini",fromStandardTextBlock(e){return{text:e.text}},fromStandardImageBlock(e){if(!s)throw new Error("This model does not support images");if(e.source_type==="url"){const t=ei({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)},fromStandardAudioBlock(e){if(!s)throw new Error("This model does not support audio");if(e.source_type==="url"){const t=ei({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)},fromStandardFileBlock(e){if(!s)throw new Error("This model does not support files");if(e.source_type==="text")return{text:e.text};if(e.source_type==="url"){const t=ei({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)}}}function yp(s,e){var t;if(_o(s))return vo(s,r_(e));if(s.type==="text")return{text:s.text};if(s.type==="executableCode")return{executableCode:s.executableCode};if(s.type==="codeExecutionResult")return{codeExecutionResult:s.codeExecutionResult};if(s.type==="image_url"){if(!e)throw new Error("This model does not support images");let n;if(typeof s.image_url=="string")n=s.image_url;else if(typeof s.image_url=="object"&&"url"in s.image_url)n=s.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");const[i,a]=n.split(",");if(!i.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[r,o]=i.replace(/^data:/,"").split(";");if(o!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:a,mimeType:r}}}else{if(s.type==="media")return i_(s);if(s.type==="tool_use")return{functionCall:{name:s.name,args:s.input}};if((t=s.type)!=null&&t.includes("/")&&s.type.split("/").length===2&&"data"in s&&typeof s.data=="string")return{inlineData:{mimeType:s.type,data:s.data}};if("functionCall"in s)return;throw"type"in s?new Error(`Unknown content type ${s.type}`):new Error(`Unknown content ${JSON.stringify(s)}`)}}function o_(s,e,t){var a;if(ev(s)){const r=s.name??a_(s,t);if(r===void 0)throw new Error(`Google requires a tool name for each tool call response, and we could not infer a called tool name for ToolMessage "${s.id}" from your passed messages. Please populate a "name" field on that ToolMessage explicitly.`);const o=Array.isArray(s.content)?s.content.map(c=>yp(c,e)).filter(c=>c!==void 0):s.content;return s.status==="error"?[{functionResponse:{name:r,response:{error:{details:o}}}}]:[{functionResponse:{name:r,response:{result:o}}}]}let n=[];const i=[];return typeof s.content=="string"&&s.content&&i.push({text:s.content}),Array.isArray(s.content)&&i.push(...s.content.map(r=>yp(r,e)).filter(r=>r!==void 0)),fs(s)&&((a=s.tool_calls)!=null&&a.length)&&(n=s.tool_calls.map(r=>({functionCall:{name:r.name,args:r.args}}))),[...i,...n]}function gp(s,e,t=!1){return s.reduce((n,i,a)=>{if(!bo(i))throw new Error("Unsupported message input");const r=s_(i);if(r==="system"&&a!==0)throw new Error("System message should be the first one");const o=n_(r),c=n.content[n.content.length];if(!n.mergeWithPreviousContent&&c&&c.role===o)throw new Error("Google Generative AI requires alternate messages between authors");const l=o_(i,e,s.slice(0,a));if(n.mergeWithPreviousContent){const p=n.content[n.content.length-1];if(!p)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return p.parts.push(...l),{mergeWithPreviousContent:!1,content:n.content}}let u=o;(u==="function"||u==="system"&&!t)&&(u="user");const d={role:u,parts:l};return{mergeWithPreviousContent:r==="system"&&!t,content:[...n.content,d]}},{content:[],mergeWithPreviousContent:!1}).content}function c_(s,e){var c,l,u,d;if(!s.candidates||s.candidates.length===0||!s.candidates[0])return{generations:[],llmOutput:{filters:s.promptFeedback}};const t=s.functionCalls(),[n]=s.candidates,{content:i,...a}=n;let r;Array.isArray(i==null?void 0:i.parts)&&i.parts.length===1&&i.parts[0].text?r=i.parts[0].text:Array.isArray(i==null?void 0:i.parts)&&i.parts.length>0?r=i.parts.map(p=>"text"in p?{type:"text",text:p.text}:"executableCode"in p?{type:"executableCode",executableCode:p.executableCode}:"codeExecutionResult"in p?{type:"codeExecutionResult",codeExecutionResult:p.codeExecutionResult}:p):r=[];let o="";return typeof r=="string"?o=r:Array.isArray(r)&&r.length>0&&(o=((c=r.find(p=>"text"in p))==null?void 0:c.text)??o),{generations:[{text:o,message:new an({content:r??"",tool_calls:t==null?void 0:t.map(p=>({...p,type:"tool_call",id:"id"in p&&typeof p.id=="string"?p.id:fp()})),additional_kwargs:{...a},usage_metadata:e==null?void 0:e.usageMetadata}),generationInfo:a}],llmOutput:{tokenUsage:{promptTokens:(l=e==null?void 0:e.usageMetadata)==null?void 0:l.input_tokens,completionTokens:(u=e==null?void 0:e.usageMetadata)==null?void 0:u.output_tokens,totalTokens:(d=e==null?void 0:e.usageMetadata)==null?void 0:d.total_tokens}}}}function l_(s,e){var l;if(!s.candidates||s.candidates.length===0)return null;const t=s.functionCalls(),[n]=s.candidates,{content:i,...a}=n;let r;Array.isArray(i==null?void 0:i.parts)&&i.parts.every(u=>"text"in u)?r=i.parts.map(u=>u.text).join(""):Array.isArray(i==null?void 0:i.parts)?r=i.parts.map(u=>"text"in u?{type:"text",text:u.text}:"executableCode"in u?{type:"executableCode",executableCode:u.executableCode}:"codeExecutionResult"in u?{type:"codeExecutionResult",codeExecutionResult:u.codeExecutionResult}:u):r=[];let o="";r&&typeof r=="string"?o=r:Array.isArray(r)&&(o=((l=r.find(u=>"text"in u))==null?void 0:l.text)??"");const c=[];return t&&c.push(...t.map(u=>({...u,args:JSON.stringify(u.args),index:e.index,type:"tool_call_chunk",id:"id"in u&&typeof u.id=="string"?u.id:fp()}))),new ys({text:o,message:new rn({content:r||"",name:i?i.role:void 0,tool_call_chunks:c,additional_kwargs:{},usage_metadata:e.usageMetadata}),generationInfo:a})}function u_(s){return s.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?s:[{functionDeclarations:s.map(e=>{if(ra(e)){const t=mo(e.schema);return t.type==="object"&&"properties"in t&&Object.keys(t.properties).length===0?{name:e.name,description:e.description}:{name:e.name,description:e.description,parameters:t}}return Yi(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:Gb(e.function.parameters)}:e})}]}class bp extends Du{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await eh(this.zodSchema,e);if(t.success)return t.data;throw new ea(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.issues)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap(i=>{const{message:a}=i;return!("tool_calls"in a)||!Array.isArray(a.tool_calls)?[]:a.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function _p(s,e){const t=d_(s),n=h_(t,e);return{tools:t,toolConfig:n}}function d_(s){let e=[];const t=[];return s.forEach(n=>{if(ra(n)){const[i]=u_([n]);i.functionDeclarations&&e.push(...i.functionDeclarations)}else if(Yi(n)){const{functionDeclarations:i}=p_(n);if(i)e.push(...i);else throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else t.push(n)}),t.find(n=>"functionDeclarations"in n)?t.map(n=>{if((e==null?void 0:e.length)>0&&"functionDeclarations"in n){const i={functionDeclarations:[...n.functionDeclarations||[],...e]};return e=[],i}return n}):[...t,...e.length>0?[{functionDeclarations:e}]:[]]}function p_(s){return{functionDeclarations:[{name:s.function.name,description:s.function.description,parameters:Ss(s.function.parameters)}]}}function h_(s,e){if(!s.length||!e)return;const{toolChoice:t,allowedFunctionNames:n}=e,i={any:tn.ANY,auto:tn.AUTO,none:tn.NONE};if(t&&["any","auto","none"].includes(t))return{functionCallingConfig:{mode:i[t]??"MODE_UNSPECIFIED",allowedFunctionNames:n}};if(typeof t=="string"||n)return{functionCallingConfig:{mode:tn.ANY,allowedFunctionNames:[...n??[],...t&&typeof t=="string"?[t]:[]]}}}class m_ extends Ut{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"json",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model.replace(/^models\//,""),this.maxOutputTokens=e.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw new Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=e.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e.stopSequences??this.stopSequences,this.apiKey=e.apiKey??xa("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(t=>t.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=e.streaming??this.streaming,this.json=e.json,this.client=new Ma(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...this.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e.apiVersion,baseUrl:e.baseUrl}),this.streamUsage=e.streamUsage??this.streamUsage}useCachedContent(e,t,n){this.apiKey&&(this.client=new Ma(this.apiKey).getGenerativeModelFromCachedContent(e,t,n))}get useSystemInstruction(){return typeof this.convertSystemMessageToHumanContent=="boolean"?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return this.model==="gemini-1.0-pro-001"||this.model.startsWith("gemini-pro-vision")||this.model.startsWith("gemini-1.0-pro-vision")?!1:this.model!=="gemini-pro"}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){var n;return this.withConfig({tools:(n=_p(e))==null?void 0:n.tools,...t})}invocationParams(e){var n;const t=(n=e==null?void 0:e.tools)!=null&&n.length?_p(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return e!=null&&e.responseSchema?(this.client.generationConfig.responseSchema=e.responseSchema,this.client.generationConfig.responseMimeType="application/json"):(this.client.generationConfig.responseSchema=void 0,this.client.generationConfig.responseMimeType=this.json?"application/json":void 0),{...t!=null&&t.tools?{tools:t.tools}:{},...t!=null&&t.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,n){var u,d,p;const i=gp(e,this._isMultimodalModel,this.useSystemInstruction);let a=i;if(i[0].role==="system"){const[h]=i;this.client.systemInstruction=h,a=i.slice(1)}const r=this.invocationParams(t);if(this.streaming){const h={},m=this._streamResponseChunks(e,t,n),y={};for await(const f of m){const g=((u=f.generationInfo)==null?void 0:u.completion)??0;y[g]===void 0?y[g]=f:y[g]=y[g].concat(f)}return{generations:Object.entries(y).sort(([f],[g])=>parseInt(f,10)-parseInt(g,10)).map(([f,g])=>g),llmOutput:{estimatedTokenUsage:h}}}const o=await this.completionWithRetry({...r,contents:a});let c;if("usageMetadata"in o.response){const h=o.response.usageMetadata;c={input_tokens:h.promptTokenCount??0,output_tokens:h.candidatesTokenCount??0,total_tokens:h.totalTokenCount??0}}const l=c_(o.response,{usageMetadata:c});return((d=l.generations)==null?void 0:d.length)>0&&await(n==null?void 0:n.handleLLMNewToken(((p=l.generations[0])==null?void 0:p.text)??"")),l}async*_streamResponseChunks(e,t,n){const i=gp(e,this._isMultimodalModel,this.useSystemInstruction);let a=i;if(i[0].role==="system"){const[u]=i;this.client.systemInstruction=u,a=i.slice(1)}const r={...this.invocationParams(t),contents:a},o=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{const{stream:u}=await this.client.generateContentStream(r);return u});let c,l=0;for await(const u of o){if("usageMetadata"in u&&this.streamUsage!==!1&&t.streamUsage!==!1){const p=u.usageMetadata;if(!c)c={input_tokens:p.promptTokenCount??0,output_tokens:p.candidatesTokenCount??0,total_tokens:p.totalTokenCount??0};else{const h=(p.candidatesTokenCount??0)-c.output_tokens;c={input_tokens:0,output_tokens:h,total_tokens:h}}}const d=l_(u,{usageMetadata:c,index:l});l+=1,d&&(yield d,await(n==null?void 0:n.handleLLMNewToken(d.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var n;try{return await this.client.generateContent(e)}catch(i){throw(n=i.message)!=null&&n.includes("400 Bad Request")&&(i.status=400),i}})}withStructuredOutput(e,t){const n=e,i=t==null?void 0:t.name,a=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw;if(a==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "jsonSchema" or "functionCalling" as a method.');let o,c;if(a==="functionCalling"){let p=i??"extract",h;if(Kt(n)){const m=mo(n);h=[{functionDeclarations:[{name:p,description:m.description??"A function available to call.",parameters:m}]}],c=new bp({returnSingle:!0,keyName:p,zodSchema:n})}else{let m;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(m=n,m.parameters=Ss(n.parameters),p=n.name):m={name:p,description:n.description??"",parameters:Ss(n)},h=[{functionDeclarations:[m]}],c=new bp({returnSingle:!0,keyName:p})}o=this.bindTools(h).withConfig({allowedFunctionNames:[p]})}else{const p=mo(n);o=this.withConfig({responseSchema:p}),c=new ta}if(!r)return o.pipe(c).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const l=ls.assign({parsed:(p,h)=>c.invoke(p.raw,h)}),u=ls.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return wa.from([{raw:o},d]).withConfig({runName:"StructuredOutputRunnable"})}}let fa,vp,wp,xp,Op,Ep,Mp,kp,Cp,Ap,Pp,Sp,Tp,Np,jp,Rp;fa=async(s,e,{schemas:t,onMessageUpdate:n})=>{let i="",a;if(t!=null&&t.length){const r=t.filter(c=>{var l;return(l=c.schema_items)==null?void 0:l.length}).flatMap(c=>c.schema_items),o=await s.withStructuredOutput(wi(r)).stream(e);for await(const c of o)i=JSON.stringify(c),n==null||n({content:i})}else{const r=await s.stream(e);for await(const o of r)i+=`${o.content}`,a=o,n==null||n({content:i,chunk:o})}return{lastChunk:a,content:i}},vp={async stream(s,e){var d,p,h,m,y;const{schemas:t,onMessageUpdate:n,onMessageFinish:i}=e||{};let a=e==null?void 0:e.passphrase;if(!a&&(a=await _a.get("passphrase")||void 0,!a))throw new Error("Passphrase is required. Either provide it as parameter, ensure it exists in secure session, or provide confirmPassphrase function.");const r=(d=e==null?void 0:e.llm)==null?void 0:d.encrypted,o=((p=e==null?void 0:e.llm)==null?void 0:p.options)||{};if(!(r!=null&&r.key)||typeof r.key!="string")throw new Error("API Key is not found");const c=await ti(r.key,a);if(!c)throw new Error("API Key is not found");let l="",u;switch(e==null?void 0:e.provider){case ht.GoogleGenerativeAI:{const f=new m_({apiKey:c,model:((h=e==null?void 0:e.llm)==null?void 0:h.name)||"gemini-1.5-flash",temperature:o!=null&&o.temperature?+o.temperature:void 0,topK:o!=null&&o.topK?+o.topK:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxOutputTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0});if(r!=null&&r.enabled_google_search_retrieval){const b={googleSearchRetrieval:{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.7}}};f.bindTools([b])}const g=await fa(f,s,{schemas:t,onMessageUpdate:n});l=g.content,u=g.lastChunk}break;case ht.Groq:{const f=new vb({apiKey:c,model:((m=e==null?void 0:e.llm)==null?void 0:m.name)||"",temperature:o!=null&&o.temperature?+o.temperature:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),g=await fa(f,s,{schemas:t,onMessageUpdate:n});l=g.content,u=g.lastChunk}break;case ht.OpenAI:{const f=new B0({apiKey:c,model:(y=e==null?void 0:e.llm)==null?void 0:y.name,temperature:o!=null&&o.temperature?+o.temperature:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),g=await fa(f,s,{schemas:t,onMessageUpdate:n});l=g.content,u=g.lastChunk}break;default:throw new Error("Provider is not supported")}return i==null||i({content:l,lastChunk:u}),{lastChunk:u,content:l}}},uh={async stream(s,e,t){switch(s){case ht.WebLLM:case ht.Wllama:return ny.stream(e,t);case ht.GoogleGenerativeAI:case ht.Groq:case ht.OpenAI:return vp.stream(e,{...t,provider:s});default:throw new Error(`Provider ${s} is not supported`)}}},mh=()=>{const{toast:s}=x_(),{t:e}=qp("errors"),t=tv(i=>i.currentSession),{modalRef:n}=Mo(Eo);return{confirmPassphrase:M.useCallback(async()=>{t!=null&&t.passphrase&&(await _a.exists("passphrase")||await new Promise((i,a)=>{n.current.show({onConfirm:async r=>{try{const o=await ti(t.passphrase,r);await _a.set("passphrase",o),i()}catch(o){s({content:e("invalid_passphrase"),variant:"destructive"}),a(o)}finally{n.current.hide()}},onCancel:()=>{a()}})}))},[t==null?void 0:t.passphrase,n,e,s])}},wp=s=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",fill:"none",height:192,viewBox:"0 0 150 150",width:192,...s},M.createElement("clipPath",{id:"a"},M.createElement("path",{d:"m0 0h150v150h-150z"})),M.createElement("g",{clipPath:"url(#a)"},M.createElement("path",{d:"m150 0h-150v150h150z",fill:"#29b5e8"}),M.createElement("path",{clipRule:"evenodd",d:"m130.375 67.2532-14.096 8.1221 14.096 8.0536c.843.4872 1.581 1.1357 2.174 1.9084.592.7727 1.026 1.6545 1.278 2.5951.251.9406.315 1.9215.188 2.8867-.128.9652-.444 1.8959-.931 2.7388-.488.843-1.136 1.5817-1.909 2.174s-1.654 1.0267-2.595 1.2782-1.921.3154-2.887.1878c-.965-.1275-1.896-.444-2.739-.9312l-25.2559-14.5496c-1.1575-.6696-2.1128-1.6394-2.765-2.8068-.6523-1.1674-.9773-2.4893-.9408-3.826.0198-.5792.1089-1.1538.2653-1.7117.517-1.8711 1.7458-3.4654 3.4234-4.4419l25.256-14.4983c.847-.4892 1.782-.8067 2.751-.9343.97-.1275 1.955-.0627 2.899.1909.945.2536 1.83.6909 2.605 1.287.775.596 1.425 1.3391 1.913 2.1866.49.8402.808 1.7693.935 2.7334.128.964.063 1.9439-.191 2.8826-.254.9388-.692 1.8177-1.288 2.5859-.597.7681-1.34 1.4101-2.186 1.8887zm-13.343 39.3698-25.2478-14.5243c-1.1296-.6483-2.4091-.9896-3.7115-.9902s-2.5823.3397-3.7124.987c-1.1301.6472-2.0712 1.579-2.7297 2.7026-.6585 1.1237-1.0115 2.4001-1.0239 3.7024v29.0135c.0654 1.928.8772 3.755 2.264 5.095 1.3869 1.341 3.2403 2.09 5.1691 2.09 1.9289 0 3.7823-.749 5.1691-2.09 1.3868-1.34 2.1986-3.167 2.264-5.095v-16.261l14.1301 8.122c.843.488 1.774.805 2.739.933.966.128 1.947.064 2.888-.187s1.823-.685 2.596-1.277c.774-.592 1.423-1.331 1.91-2.174.488-.843.805-1.773.933-2.739.128-.965.065-1.946-.186-2.887s-.685-1.824-1.277-2.597-1.331-1.422-2.174-1.91zm-29.0992-28.3806-10.527 10.3986c-.3601.3349-.8269.5319-1.318.5563h-3.0897c-.49-.0294-.9551-.2257-1.318-.5563l-10.4671-10.4329c-.3274-.3573-.521-.817-.5478-1.3009v-3.081c.0283-.4861.2215-.9481.5478-1.3095l10.4671-10.4329c.3637-.3281.829-.5214 1.318-.5477h3.0897c.4899.0228.9562.2166 1.318.5477l10.4928 10.4329c.3237.3623.514.8243.5392 1.3095v3.081c-.0237.483-.2143.9428-.5392 1.3009zm-8.3874-2.8928c-.0404-.499-.2485-.9696-.5905-1.3352l-3.0383-3.004c-.3641-.3275-.8291-.5207-1.318-.5478h-.1113c-.4867.0255-.9495.2191-1.3094.5478l-3.0383 3.004c-.3262.3676-.5165.8358-.5392 1.3266v.1113c.0215.4834.2124.9439.5392 1.3009l3.0554 2.9955c.3607.3274.823.5208 1.3094.5477h.1113c.4889-.027.9539-.2203 1.318-.5477l3.0383-3.0212c.3282-.3576.5244-.8166.5563-1.3009zm-47.4914-31.2217 25.2563 14.4811c1.1308.648 2.4115.989 3.7149.9889 1.3033 0 2.584-.3409 3.7148-.989 1.1309-.648 2.0725-1.5806 2.7314-2.7051.659-1.1245 1.0123-2.4018 1.0249-3.7051v-28.9879c-.0654-1.9277-.8772-3.7546-2.264-5.0952s-3.2402-2.0899-5.1691-2.0899c-1.9288 0-3.7822.7493-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v16.2613l-14.1473-8.1307c-.8429-.4877-1.7737-.8047-2.7392-.9328-.9654-.1281-1.9466-.0647-2.8876.1864s-1.8232.6852-2.5965 1.2773c-.7732.5921-1.4222 1.3307-1.91 2.1736-.4878.843-.8048 1.7738-.9329 2.7392-.128.9655-.0647 1.9467.1864 2.8876.2512.941.6852 1.8233 1.2773 2.5965.5921.7733 1.3307 1.4223 2.1737 1.9101zm55.4252 15.4739c1.4914.118 2.9836-.2193 4.2793-.9671l25.2475-14.5496c.843-.4877 1.582-1.1368 2.174-1.91s1.026-1.6555 1.277-2.5965.315-1.9222.187-2.8876c-.128-.9655-.445-1.8962-.933-2.7392-.488-.8429-1.137-1.5816-1.91-2.1737-.774-.5921-1.656-1.0261-2.597-1.2772-1.9-.5072-3.924-.2387-5.627.7464l-14.1298 8.1991v-16.2613c-.0654-1.9277-.8772-3.7546-2.264-5.0952-1.3868-1.3405-3.2402-2.0899-5.1691-2.0899-1.9288 0-3.7822.7494-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v29.0136c-.0023 1.8784.7086 3.6876 1.9892 5.0619 1.2805 1.3743 3.0351 2.2111 4.909 2.3412zm-25.8554 31.5298c-1.4916-.1213-2.9847.2162-4.2793.9671l-25.2905 14.4893c-1.7024.985-2.9438 2.607-3.451 4.507s-.2387 3.924.7465 5.627c.9851 1.702 2.6061 2.943 4.5065 3.451 1.9004.507 3.9244.238 5.6268-.747l14.1473-8.122v16.261c.0654 1.928.8772 3.755 2.2641 5.096 1.3868 1.34 3.2402 2.09 5.169 2.09 1.9289 0 3.7823-.75 5.1691-2.09 1.3868-1.341 2.1986-3.168 2.264-5.096v-29.0645c-.0038-1.869-.7144-3.6673-1.9891-5.0341s-3.0192-2.2009-4.8834-2.3348zm-6.8468-13.5825c.4875-1.6032.414-3.3247-.2083-4.8806-.6224-1.5559-1.7564-2.8532-3.2152-3.6779l-25.2306-14.541c-1.704-.976-3.7248-1.2385-5.6216-.7303-1.8968.5083-3.5155 1.7461-4.5032 3.4433-.4889.84-.8065 1.7686-.9343 2.732-.1278.9635-.0632 1.9428.1899 2.8811.2531.9384.6897 1.8173 1.2846 2.5858.595.7686 1.3364 1.4115 2.1814 1.8917l14.096 8.1221-14.096 8.0536c-.8429.4861-1.5819 1.1334-2.1746 1.9051-.5928.7717-1.0277 1.6526-1.2801 2.5923-.2523.9398-.317 1.9201-.1905 2.8849s.4418 1.8952.9279 2.7382c.4861.8429 1.1335 1.5819 1.9051 2.1746.7717.5928 1.6526 1.0277 2.5924 1.2801.9397.2523 1.92.317 2.8848.1905s1.8952-.4418 2.7382-.9279l25.2306-14.5496c1.6248-.9071 2.8451-2.3965 3.4149-4.168z",fill:"#fff",fillRule:"evenodd"}))),xp=s=>M.createElement("svg",{className:"mr-2 w-5 h-5",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",width:48,height:48,...s},M.createElement("path",{fill:"#fbc02d",d:"M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20 s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"}),M.createElement("path",{fill:"#e53935",d:"M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039 l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"}),M.createElement("path",{fill:"#4caf50",d:"M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"}),M.createElement("path",{fill:"#1565c0",d:"M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"})),Op=s=>M.createElement("svg",{className:"mr-2 w-5 h-5",width:1024,height:1024,viewBox:"0 0 1024 1024",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},M.createElement("path",{d:"M44.522 44.5217H489.739V489.739H44.522V44.5217Z",fill:"#F35325"}),M.createElement("path",{d:"M534.261 44.5217H979.478V489.739H534.261V44.5217Z",fill:"#81BC06"}),M.createElement("path",{d:"M44.522 534.261H489.739V979.478H44.522V534.261Z",fill:"#05A6F0"}),M.createElement("path",{d:"M534.261 534.261H979.478V979.478H534.261V534.261Z",fill:"#FFBA08"})),Ep=s=>M.createElement("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 287.56 191",...s},M.createElement("defs",null,M.createElement("style",null,".cls-1{fill:#0081fb;}.cls-2{fill:url(#linear-gradient);}.cls-3{fill:url(#linear-gradient-2);}"),M.createElement("linearGradient",{id:"linear-gradient",x1:62.34,y1:101.45,x2:260.34,y2:91.45,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},M.createElement("stop",{offset:0,stopColor:"#0064e1"}),M.createElement("stop",{offset:.4,stopColor:"#0064e1"}),M.createElement("stop",{offset:.83,stopColor:"#0073ee"}),M.createElement("stop",{offset:1,stopColor:"#0082fb"})),M.createElement("linearGradient",{id:"linear-gradient-2",x1:41.42,y1:53,x2:41.42,y2:126,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},M.createElement("stop",{offset:0,stopColor:"#0082fb"}),M.createElement("stop",{offset:1,stopColor:"#0064e0"}))),M.createElement("title",null,"facebook-meta"),M.createElement("path",{className:"cls-1",d:"M31.06,126c0,11,2.41,19.41,5.56,24.51A19,19,0,0,0,53.19,160c8.1,0,15.51-2,29.79-21.76,11.44-15.83,24.92-38,34-52l15.36-23.6c10.67-16.39,23-34.61,37.18-47C181.07,5.6,193.54,0,206.09,0c21.07,0,41.14,12.21,56.5,35.11,16.81,25.08,25,56.67,25,89.27,0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191V160c17.63,0,22-16.2,22-34.74,0-26.42-6.16-55.74-19.73-76.69-9.63-14.86-22.11-23.94-35.84-23.94-14.85,0-26.8,11.2-40.23,31.17-7.14,10.61-14.47,23.54-22.7,38.13l-9.06,16c-18.2,32.27-22.81,39.62-31.91,51.75C84.74,183,71.12,191,53.19,191c-21.27,0-34.72-9.21-43-23.09C3.34,156.6,0,141.76,0,124.85Z"}),M.createElement("path",{className:"cls-2",d:"M24.49,37.3C38.73,15.35,59.28,0,82.85,0c13.65,0,27.22,4,41.39,15.61,15.5,12.65,32,33.48,52.63,67.81l7.39,12.32c17.84,29.72,28,45,33.93,52.22,7.64,9.26,13,12,19.94,12,17.63,0,22-16.2,22-34.74l27.4-.86c0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191c-12.8,0-24.14-2.78-36.68-14.61-9.64-9.08-20.91-25.21-29.58-39.71L146.08,93.6c-12.94-21.62-24.81-37.74-31.68-45C107,40.71,97.51,31.23,82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78Z"}),M.createElement("path",{className:"cls-3",d:"M82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78C38.61,71.62,31.06,99.34,31.06,126c0,11,2.41,19.41,5.56,24.51L10.14,167.91C3.34,156.6,0,141.76,0,124.85,0,94.1,8.44,62.05,24.49,37.3,38.73,15.35,59.28,0,82.85,0Z"})),Mp=s=>M.createElement("svg",{className:"mr-2 w-5 h-5",width:256,height:233,viewBox:"0 0 256 233",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},M.createElement("path",{d:"M186.182 0h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#f7d046",d:"M209.455 0H256v46.545h-46.545z"}),M.createElement("path",{d:"M0 0h46.545v46.545H0zm0 46.545h46.545V93.09H0zm0 46.546h46.545v46.545H0zm0 46.545h46.545v46.545H0zm0 46.546h46.545v46.545H0z"}),M.createElement("path",{fill:"#f7d046",d:"M23.273 0h46.545v46.545H23.273z"}),M.createElement("path",{fill:"#f2a73b",d:"M209.455 46.545H256V93.09h-46.545zm-186.182 0h46.545V93.09H23.273z"}),M.createElement("path",{d:"M139.636 46.545h46.545V93.09h-46.545z"}),M.createElement("path",{fill:"#f2a73b",d:"M162.909 46.545h46.545V93.09h-46.545zm-93.091 0h46.545V93.09H69.818z"}),M.createElement("path",{fill:"#ee792f",d:"M116.364 93.091h46.545v46.545h-46.545zm46.545 0h46.545v46.545h-46.545zm-93.091 0h46.545v46.545H69.818z"}),M.createElement("path",{d:"M93.091 139.636h46.545v46.545H93.091z"}),M.createElement("path",{fill:"#eb5829",d:"M116.364 139.636h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#ee792f",d:"M209.455 93.091H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"}),M.createElement("path",{d:"M186.182 139.636h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#eb5829",d:"M209.455 139.636H256v46.545h-46.545z"}),M.createElement("path",{d:"M186.182 186.182h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#eb5829",d:"M23.273 139.636h46.545v46.545H23.273z"}),M.createElement("path",{fill:"#ea3326",d:"M209.455 186.182H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"})),kp="/NoLLMChat/assets/qwen-B-gSh3_v.webp",Cp="/NoLLMChat/assets/smollm-CikBjd4F.png",Ap="/NoLLMChat/assets/stablelm-BquePdQ7.png",Pp="/NoLLMChat/assets/nomic-BjJqoFji.webp",Sp="/NoLLMChat/assets/joshua-ByaReJuI.webp",Tp="/NoLLMChat/assets/deepseek-CRqFMahi.png",Np="/NoLLMChat/assets/redpajama-CmUGqSQW.png",jp=s=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...s},M.createElement("path",{fill:"#fff",d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),Rp=s=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...s},M.createElement("path",{d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),ch=M.memo(({name:s,className:e,...t})=>{const n=O_(i=>i.theme);return s=s.toLowerCase(),s.includes("gpt")?n==="dark"?se.jsx(jp,{className:Ie("w-5 h-5",e),...t}):se.jsx(Rp,{className:Ie("w-5 h-5",e),...t}):s!=null&&s.includes("deepseek")?se.jsx("img",{className:Ie("w-5 h-5 rounded-full",e),src:Tp,alt:"deepseek",...t}):s!=null&&s.includes("redpajama")?se.jsx("img",{className:Ie("w-5 h-5 rounded-full",e),src:Np,alt:"deepseek",...t}):s.includes("gemma")||s.includes("gemini")?se.jsx(xp,{className:Ie("w-5 h-5",e),...t}):s!=null&&s.includes("qwen")?se.jsx("img",{className:Ie("w-5 h-5",e),src:kp,alt:"qwen",...t}):s!=null&&s.includes("phi")?se.jsx(Op,{className:Ie("w-5 h-5",e),...t}):s!=null&&s.includes("llama")?se.jsx(Ep,{className:Ie("w-5 h-5",e),...t}):s!=null&&s.includes("smollm")?se.jsx("img",{className:Ie("w-5 h-5",e),src:Cp,alt:"smollm",...t}):s!=null&&s.includes("mistral")?se.jsx(Mp,{className:Ie("w-5 h-5",e),...t}):s!=null&&s.includes("snowflake")?se.jsx(wp,{className:Ie("w-5 h-5 rounded-full",e),...t}):s!=null&&s.includes("stablelm")?se.jsx("img",{className:Ie("w-5 h-5 rounded-full",e),src:Ap,alt:"stablelm",...t}):s!=null&&s.includes("nomic")?se.jsx("img",{className:Ie("w-5 h-5 rounded-full",e),src:Pp,alt:"nomic",...t}):s!=null&&s.includes("Xenova")||s!=null&&s.includes("janus")?se.jsx("img",{className:Ie("w-5 h-5 rounded-full",e),src:Sp,alt:"Xenova",...t}):se.jsx(E_,{className:Ie("w-5 h-5",e),name:"brain"})})});export{wo as B,Ma as G,xo as I,Oo as L,ae as O,Eo as S,nv as __tla,oh as a,Mo as b,ch as c,lh as d,ko as e,Co as f,ka as g,ti as h,si as i,ht as j,Ao as k,uh as l,Ca as m,ni as n,Yt as o,dh as p,Aa as q,ph as r,Po as s,hh as t,mh as u,fh as v,ii as w,gs as x,Pa as y,jt as z};
