import{r as M,I as pp,G as hp,ae as pb,af as Ms,g as hb,B as it,j as se,c as je,s as mb,v as mp,d as fp,e as fb,A as yb,L as gb,__tla as bb}from"./index-DZC_xMPJ.js";import{bk as yp,bl as gp,bm as Js,bn as la,b5 as Hs,bo as _b,A as Gs,p as Ut,bp as vb,r as wb,s as xb,t as Ob,v as Eb,b3 as Mb,b4 as kb,B as Cb,ak as ua,H as bp,bq as Ab,br as Sb,af as da,bs as Tb,bt as Pb,bu as zn,aF as _p,bv as Nb,bw as jb,bx as vp,aK as io,by as wp,bz as Ib,bA as xp,bB as ao,bC as ls,bD as Op,aH as Wt,bE as Kt,bF as Ep,bG as pa,bH as Rb,bI as $b,bJ as Lb,ag as Bb,bK as Db,bL as us,bM as qb,bN as Fb,bO as Ub,bP as Wb,aI as Zb,bQ as Mp,bR as Vb,bS as kp,ai as ha,bT as ma,bU as Cp,bV as Xs,bW as fa,bX as Ap,bY as Sp,bZ as Tp,b_ as zb,b$ as Kb,c0 as ro,c1 as oo,c2 as Kn,c3 as Pp,c4 as Qb,u as Jb,__tla as Hb}from"./routes-CTo4wjkf.js";import Np from"./dot-DFtq2eFQ.js";let co,ya,lo,uo,ae,po,V,jp,ho,Ip,Rp,mo,fo,ga,yo,Qn,Ge,Jn,go,ba,Hn,Qt,$p,_a,Lp,bo,Bp,Dp,qp,Gn,ds,St,Gb=Promise.all([(()=>{try{return bb}catch{}})(),(()=>{try{return Hb}catch{}})()]).then(async()=>{ga=globalThis||void 0||self,uo=(s=>(s.Started="started",s.Downloading="downloading",s.Downloaded="downloaded",s.Loading="loading",s.Loaded="loaded",s))(uo||{}),go=(s=>(s.LLM="LLM",s.embedding="embedding",s.VLM="VLM",s))(go||{}),Ge=(s=>(s.WebLLM="WebLLM",s.Wllama="Wllama",s.OpenAI="OpenAI",s.Groq="Groq",s.GoogleGenerativeAI="GoogleGenerativeAI",s))(Ge||{});function vo(s,e,t,n,i){if(e!==s){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=yp(e),r=yp(s),o=!1,c=r.length-1;c>=0;c--){var l=r[c],u=s[l];if(gp(e,l)&&!(e[l]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var d=e[l];typeof u=="object"&&u!=null&&typeof d=="object"&&d!=null&&Array.isArray(u)===Array.isArray(d)?vo(u,d,t,n+"/"+Js(l),i):u!==d&&(i&&t.push({op:"test",path:n+"/"+Js(l),value:la(u)}),t.push({op:"replace",path:n+"/"+Js(l),value:la(d)}))}else Array.isArray(s)===Array.isArray(e)?(i&&t.push({op:"test",path:n+"/"+Js(l),value:la(u)}),t.push({op:"remove",path:n+"/"+Js(l)}),o=!0):(i&&t.push({op:"test",path:n,value:s}),t.push({op:"replace",path:n,value:e}))}if(!(!o&&a.length==r.length))for(var c=0;c<a.length;c++){var l=a[c];!gp(s,l)&&e[l]!==void 0&&t.push({op:"add",path:n+"/"+Js(l),value:la(e[l])})}}}function Wp(s,e,t=!1){var n=[];return vo(s,e,n,"",t),n}Jn=function(s,e){const t=typeof s;if(t!==typeof e)return!1;if(Array.isArray(s)){if(!Array.isArray(e))return!1;const n=s.length;if(n!==e.length)return!1;for(let i=0;i<n;i++)if(!Jn(s[i],e[i]))return!1;return!0}if(t==="object"){if(!s||!e)return s===e;const n=Object.keys(s),i=Object.keys(e);if(n.length!==i.length)return!1;for(const a of n)if(!Jn(s[a],e[a]))return!1;return!0}return s===e};const Zp=async(s,e)=>{let t="",n="",i;const a=[];await s;for await(const r of s)r&&(Array.isArray(r)?(a.push(...r.map(o=>o.content)),a!=null&&a.length&&(n=a.join(""),e==null||e({chunk:r,content:n}))):(t=typeof r=="object"&&"content"in r?`${r.content}`:`${r}`,e==null||e({chunk:r,content:t})),i=r);return{lastChunk:i,content:t}},Vp=()=>{const s=Hs(e=>e.getCurrentModelInfo);return{getCurrentModelInfo:M.useCallback(async e=>{switch(e){case Ge.WebLLM:return s();default:return}},[s])}},zp=()=>{const s=Hs(e=>e.unLoadModel);return{unLoadModel:M.useCallback(async e=>{switch(e){case Ge.WebLLM:return s();default:return}},[s])}},Kp=()=>{const s=Hs(o=>o.toolsCallingStream),e=Hs(o=>o.structuredStream),t=Hs(o=>o.stream),{unLoadModel:n}=zp(),{getCurrentModelInfo:i}=Vp(),a=M.useCallback(async(o,c)=>{var f,g,b,v,E;const{tools:l,schemas:u,onMessageUpdate:d,onMessageFinish:p}=c||{};let h;if(!(c!=null&&c.llm))throw new Error("LLM is not found");if(!await(i==null?void 0:i((f=c==null?void 0:c.llm)==null?void 0:f.provider)))throw new Error("Model is not found");if(u!=null&&u.length?(u&&(u==null?void 0:u.length)>1&&pp("Multiple schemas are not supported. Only the first schema will be used."),h=e(((g=u==null?void 0:u[0])==null?void 0:g.schema_items)||[],o,{provider:(b=c==null?void 0:c.llm)==null?void 0:b.provider})):l!=null&&l.length?h=s(l,o,{provider:(v=c==null?void 0:c.llm)==null?void 0:v.provider}):h=t(o,{provider:(E=c==null?void 0:c.llm)==null?void 0:E.provider}),!h)throw new Error("Stream is not supported");const{lastChunk:m,content:y}=await Zp(h,d);return p==null||p({content:y,lastChunk:m}),{lastChunk:m,content:y}},[i,t,e,s]),r=M.useCallback(async(o,c)=>{var y,f;let l="",u;const{tools:d,schemas:p,onMessageUpdate:h,onMessageFinish:m}=c||{};if(!(c!=null&&c.llm))throw new Error("LLM is not found");if(await(i==null?void 0:i((y=c==null?void 0:c.llm)==null?void 0:y.provider))&&(n==null||n((f=c==null?void 0:c.llm)==null?void 0:f.provider)),p==null?void 0:p.length)throw p&&(p==null?void 0:p.length)>1&&pp("Multiple schemas are not supported. Only the first schema will be used."),new Error("Structured stream is not supported");if(d!=null&&d.length)throw new Error("Tools calling stream is not supported");{const g=await _b(o,{onNewToken:(b,v,E)=>{l+=E,h==null||h({content:l,chunk:new Gs(E)})}});l=`${g.content}`,u=g}return m==null||m({content:l,lastChunk:u}),{lastChunk:u,content:l}},[i,t,e,s,n]);return{stream:M.useCallback(async(o,c)=>{var l;switch((l=c==null?void 0:c.llm)==null?void 0:l.provider){case"WebLLM":return a(o,c);case"Wllama":return r(o,c);default:return}},[a,r])}};var ce;(function(s){s.assertEqual=i=>i;function e(i){}s.assertIs=e;function t(i){throw new Error}s.assertNever=t,s.arrayToEnum=i=>{const a={};for(const r of i)a[r]=r;return a},s.getValidEnumValues=i=>{const a=s.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),r={};for(const o of a)r[o]=i[o];return s.objectValues(r)},s.objectValues=i=>s.objectKeys(i).map(function(a){return i[a]}),s.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const a=[];for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&a.push(r);return a},s.find=(i,a)=>{for(const r of i)if(a(r))return r},s.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&isFinite(i)&&Math.floor(i)===i;function n(i,a=" | "){return i.map(r=>typeof r=="string"?`'${r}'`:r).join(a)}s.joinValues=n,s.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(ce||(ce={}));var va;(function(s){s.mergeShapes=(e,t)=>({...e,...t})})(va||(va={}));const R=ce.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Jt=s=>{switch(typeof s){case"undefined":return R.undefined;case"string":return R.string;case"number":return isNaN(s)?R.nan:R.number;case"boolean":return R.boolean;case"function":return R.function;case"bigint":return R.bigint;case"symbol":return R.symbol;case"object":return Array.isArray(s)?R.array:s===null?R.null:s.then&&typeof s.then=="function"&&s.catch&&typeof s.catch=="function"?R.promise:typeof Map<"u"&&s instanceof Map?R.map:typeof Set<"u"&&s instanceof Set?R.set:typeof Date<"u"&&s instanceof Date?R.date:R.object;default:return R.unknown}},k=ce.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Qp=s=>JSON.stringify(s,null,2).replace(/"([^"]+)":/g,"$1:");let ft=class Fp extends Error{constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(a){return a.message},n={_errors:[]},i=a=>{for(const r of a.issues)if(r.code==="invalid_union")r.unionErrors.map(i);else if(r.code==="invalid_return_type")i(r.returnTypeError);else if(r.code==="invalid_arguments")i(r.argumentsError);else if(r.path.length===0)n._errors.push(t(r));else{let o=n,c=0;for(;c<r.path.length;){const l=r.path[c];c===r.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(r))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return i(this),n}static assert(e){if(!(e instanceof Fp))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ce.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const i of this.issues)i.path.length>0?(t[i.path[0]]=t[i.path[0]]||[],t[i.path[0]].push(e(i))):n.push(e(i));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}};ft.create=s=>new ft(s);const ks=(s,e)=>{let t;switch(s.code){case k.invalid_type:s.received===R.undefined?t="Required":t=`Expected ${s.expected}, received ${s.received}`;break;case k.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(s.expected,ce.jsonStringifyReplacer)}`;break;case k.unrecognized_keys:t=`Unrecognized key(s) in object: ${ce.joinValues(s.keys,", ")}`;break;case k.invalid_union:t="Invalid input";break;case k.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ce.joinValues(s.options)}`;break;case k.invalid_enum_value:t=`Invalid enum value. Expected ${ce.joinValues(s.options)}, received '${s.received}'`;break;case k.invalid_arguments:t="Invalid function arguments";break;case k.invalid_return_type:t="Invalid function return type";break;case k.invalid_date:t="Invalid date";break;case k.invalid_string:typeof s.validation=="object"?"includes"in s.validation?(t=`Invalid input: must include "${s.validation.includes}"`,typeof s.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${s.validation.position}`)):"startsWith"in s.validation?t=`Invalid input: must start with "${s.validation.startsWith}"`:"endsWith"in s.validation?t=`Invalid input: must end with "${s.validation.endsWith}"`:ce.assertNever(s.validation):s.validation!=="regex"?t=`Invalid ${s.validation}`:t="Invalid";break;case k.too_small:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at least":"more than"} ${s.minimum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at least":"over"} ${s.minimum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${s.minimum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(s.minimum))}`:t="Invalid input";break;case k.too_big:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at most":"less than"} ${s.maximum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at most":"under"} ${s.maximum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="bigint"?t=`BigInt must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly":s.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(s.maximum))}`:t="Invalid input";break;case k.custom:t="Invalid input";break;case k.invalid_intersection_types:t="Intersection results could not be merged";break;case k.not_multiple_of:t=`Number must be a multiple of ${s.multipleOf}`;break;case k.not_finite:t="Number must be finite";break;default:t=e.defaultError,ce.assertNever(s)}return{message:t}};let wo=ks;function Jp(s){wo=s}function Yn(){return wo}const ei=s=>{const{data:e,path:t,errorMaps:n,issueData:i}=s,a=[...t,...i.path||[]],r={...i,path:a};if(i.message!==void 0)return{...i,path:a,message:i.message};let o="";const c=n.filter(l=>!!l).slice().reverse();for(const l of c)o=l(r,{data:e,defaultError:o}).message;return{...i,path:a,message:o}},Hp=[];function N(s,e){const t=Yn(),n=ei({issueData:e,data:s.data,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,t,t===ks?void 0:ks].filter(i=>!!i)});s.common.issues.push(n)}class We{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const i of t){if(i.status==="aborted")return H;i.status==="dirty"&&e.dirty(),n.push(i.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const i of t){const a=await i.key,r=await i.value;n.push({key:a,value:r})}return We.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const i of t){const{key:a,value:r}=i;if(a.status==="aborted"||r.status==="aborted")return H;a.status==="dirty"&&e.dirty(),r.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof r.value<"u"||i.alwaysSet)&&(n[a.value]=r.value)}return{status:e.value,value:n}}}const H=Object.freeze({status:"aborted"}),ti=s=>({status:"dirty",value:s}),Qe=s=>({status:"valid",value:s}),wa=s=>s.status==="aborted",xa=s=>s.status==="dirty",Ys=s=>s.status==="valid",en=s=>typeof Promise<"u"&&s instanceof Promise;function si(s,e,t,n){if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(s)}function xo(s,e,t,n,i){if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(s,t),t}var D;(function(s){s.errToObj=e=>typeof e=="string"?{message:e}:e||{},s.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(D||(D={}));var tn,sn;class Tt{constructor(e,t,n,i){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=i}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Oo=(s,e)=>{if(Ys(e))return{success:!0,data:e.value};if(!s.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new ft(s.common.issues);return this._error=t,this._error}}};function ee(s){if(!s)return{};const{errorMap:e,invalid_type_error:t,required_error:n,description:i}=s;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:i}:{errorMap:(a,r)=>{var o,c;const{message:l}=s;return a.code==="invalid_enum_value"?{message:l??r.defaultError}:typeof r.data>"u"?{message:(o=l??n)!==null&&o!==void 0?o:r.defaultError}:a.code!=="invalid_type"?{message:r.defaultError}:{message:(c=l??t)!==null&&c!==void 0?c:r.defaultError}},description:i}}class ne{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Jt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Jt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new We,ctx:{common:e.parent.common,data:e.data,parsedType:Jt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(en(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const i={common:{issues:[],async:(n=t==null?void 0:t.async)!==null&&n!==void 0?n:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Jt(e)},a=this._parseSync({data:e,path:i.path,parent:i});return Oo(i,a)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Jt(e)},i=this._parse({data:e,path:n.path,parent:n}),a=await(en(i)?i:Promise.resolve(i));return Oo(n,a)}refine(e,t){const n=i=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(i):t;return this._refinement((i,a)=>{const r=e(i),o=()=>a.addIssue({code:k.custom,...n(i)});return typeof Promise<"u"&&r instanceof Promise?r.then(c=>c?!0:(o(),!1)):r?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,i)=>e(n)?!0:(i.addIssue(typeof t=="function"?t(n,i):t),!1))}_refinement(e){return new bt({schema:this,typeName:V.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Nt.create(this,this._def)}nullable(){return es.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return gt.create(this,this._def)}promise(){return Ts.create(this,this._def)}or(e){return on.create([this,e],this._def)}and(e){return cn.create(this,e,this._def)}transform(e){return new bt({...ee(this._def),schema:this,typeName:V.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new hn({...ee(this._def),innerType:this,defaultValue:t,typeName:V.ZodDefault})}brand(){return new Ma({typeName:V.ZodBranded,type:this,...ee(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new mn({...ee(this._def),innerType:this,catchValue:t,typeName:V.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return fn.create(this,e)}readonly(){return yn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Gp=/^c[^\s-]{8,}$/i,Xp=/^[0-9a-z]+$/,Yp=/^[0-9A-HJKMNP-TV-Z]{26}$/,eh=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,th=/^[a-z0-9_-]{21}$/i,sh=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,nh=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,ih="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Oa;const ah=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,rh=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,oh=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Eo="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ch=new RegExp(`^${Eo}$`);function Mo(s){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return s.precision?e=`${e}\\.\\d{${s.precision}}`:s.precision==null&&(e=`${e}(\\.\\d+)?`),e}function lh(s){return new RegExp(`^${Mo(s)}$`)}function ko(s){let e=`${Eo}T${Mo(s)}`;const t=[];return t.push(s.local?"Z?":"Z"),s.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function uh(s,e){return!!((e==="v4"||!e)&&ah.test(s)||(e==="v6"||!e)&&rh.test(s))}class yt extends ne{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==R.string){const i=this._getOrReturnCtx(e);return N(i,{code:k.invalid_type,expected:R.string,received:i.parsedType}),H}const t=new We;let n;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(n=this._getOrReturnCtx(e,n),N(n,{code:k.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if(i.kind==="max")e.data.length>i.value&&(n=this._getOrReturnCtx(e,n),N(n,{code:k.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),t.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,r=e.data.length<i.value;(a||r)&&(n=this._getOrReturnCtx(e,n),a?N(n,{code:k.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):r&&N(n,{code:k.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),t.dirty())}else if(i.kind==="email")nh.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"email",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="emoji")Oa||(Oa=new RegExp(ih,"u")),Oa.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"emoji",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="uuid")eh.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"uuid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="nanoid")th.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"nanoid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="cuid")Gp.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"cuid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="cuid2")Xp.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"cuid2",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="ulid")Yp.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"ulid",code:k.invalid_string,message:i.message}),t.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),N(n,{validation:"url",code:k.invalid_string,message:i.message}),t.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"regex",code:k.invalid_string,message:i.message}),t.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(n=this._getOrReturnCtx(e,n),N(n,{code:k.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),t.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(n=this._getOrReturnCtx(e,n),N(n,{code:k.invalid_string,validation:{startsWith:i.value},message:i.message}),t.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(n=this._getOrReturnCtx(e,n),N(n,{code:k.invalid_string,validation:{endsWith:i.value},message:i.message}),t.dirty()):i.kind==="datetime"?ko(i).test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{code:k.invalid_string,validation:"datetime",message:i.message}),t.dirty()):i.kind==="date"?ch.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{code:k.invalid_string,validation:"date",message:i.message}),t.dirty()):i.kind==="time"?lh(i).test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{code:k.invalid_string,validation:"time",message:i.message}),t.dirty()):i.kind==="duration"?sh.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"duration",code:k.invalid_string,message:i.message}),t.dirty()):i.kind==="ip"?uh(e.data,i.version)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"ip",code:k.invalid_string,message:i.message}),t.dirty()):i.kind==="base64"?oh.test(e.data)||(n=this._getOrReturnCtx(e,n),N(n,{validation:"base64",code:k.invalid_string,message:i.message}),t.dirty()):ce.assertNever(i);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(i=>e.test(i),{validation:t,code:k.invalid_string,...D.errToObj(n)})}_addCheck(e){return new yt({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...D.errToObj(e)})}url(e){return this._addCheck({kind:"url",...D.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...D.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...D.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...D.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...D.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...D.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...D.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...D.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...D.errToObj(e)})}datetime(e){var t,n;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(n=e==null?void 0:e.local)!==null&&n!==void 0?n:!1,...D.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...D.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...D.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...D.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...D.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...D.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...D.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...D.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...D.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...D.errToObj(t)})}nonempty(e){return this.min(1,D.errToObj(e))}trim(){return new yt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new yt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new yt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}yt.create=s=>{var e;return new yt({checks:[],typeName:V.ZodString,coerce:(e=s==null?void 0:s.coerce)!==null&&e!==void 0?e:!1,...ee(s)})};function dh(s,e){const t=(s.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,i=t>n?t:n,a=parseInt(s.toFixed(i).replace(".","")),r=parseInt(e.toFixed(i).replace(".",""));return a%r/Math.pow(10,i)}class Ht extends ne{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==R.number){const i=this._getOrReturnCtx(e);return N(i,{code:k.invalid_type,expected:R.number,received:i.parsedType}),H}let t;const n=new We;for(const i of this._def.checks)i.kind==="int"?ce.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),N(t,{code:k.invalid_type,expected:"integer",received:"float",message:i.message}),n.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(t=this._getOrReturnCtx(e,t),N(t,{code:k.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),n.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(t=this._getOrReturnCtx(e,t),N(t,{code:k.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),n.dirty()):i.kind==="multipleOf"?dh(e.data,i.value)!==0&&(t=this._getOrReturnCtx(e,t),N(t,{code:k.not_multiple_of,multipleOf:i.value,message:i.message}),n.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),N(t,{code:k.not_finite,message:i.message}),n.dirty()):ce.assertNever(i);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,D.toString(t))}gt(e,t){return this.setLimit("min",e,!1,D.toString(t))}lte(e,t){return this.setLimit("max",e,!0,D.toString(t))}lt(e,t){return this.setLimit("max",e,!1,D.toString(t))}setLimit(e,t,n,i){return new Ht({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:D.toString(i)}]})}_addCheck(e){return new Ht({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:D.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:D.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:D.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:D.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:D.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ce.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Ht.create=s=>new Ht({checks:[],typeName:V.ZodNumber,coerce:(s==null?void 0:s.coerce)||!1,...ee(s)});class Gt extends ne{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==R.bigint){const i=this._getOrReturnCtx(e);return N(i,{code:k.invalid_type,expected:R.bigint,received:i.parsedType}),H}let t;const n=new We;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(t=this._getOrReturnCtx(e,t),N(t,{code:k.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),n.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(t=this._getOrReturnCtx(e,t),N(t,{code:k.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),n.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),N(t,{code:k.not_multiple_of,multipleOf:i.value,message:i.message}),n.dirty()):ce.assertNever(i);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,D.toString(t))}gt(e,t){return this.setLimit("min",e,!1,D.toString(t))}lte(e,t){return this.setLimit("max",e,!0,D.toString(t))}lt(e,t){return this.setLimit("max",e,!1,D.toString(t))}setLimit(e,t,n,i){return new Gt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:D.toString(i)}]})}_addCheck(e){return new Gt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:D.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:D.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:D.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:D.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:D.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Gt.create=s=>{var e;return new Gt({checks:[],typeName:V.ZodBigInt,coerce:(e=s==null?void 0:s.coerce)!==null&&e!==void 0?e:!1,...ee(s)})};class nn extends ne{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==R.boolean){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.boolean,received:t.parsedType}),H}return Qe(e.data)}}nn.create=s=>new nn({typeName:V.ZodBoolean,coerce:(s==null?void 0:s.coerce)||!1,...ee(s)});class ps extends ne{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==R.date){const i=this._getOrReturnCtx(e);return N(i,{code:k.invalid_type,expected:R.date,received:i.parsedType}),H}if(isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return N(i,{code:k.invalid_date}),H}const t=new We;let n;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(n=this._getOrReturnCtx(e,n),N(n,{code:k.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),t.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(n=this._getOrReturnCtx(e,n),N(n,{code:k.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),t.dirty()):ce.assertNever(i);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ps({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:D.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:D.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}ps.create=s=>new ps({checks:[],coerce:(s==null?void 0:s.coerce)||!1,typeName:V.ZodDate,...ee(s)});class ni extends ne{_parse(e){if(this._getType(e)!==R.symbol){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.symbol,received:t.parsedType}),H}return Qe(e.data)}}ni.create=s=>new ni({typeName:V.ZodSymbol,...ee(s)});class an extends ne{_parse(e){if(this._getType(e)!==R.undefined){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.undefined,received:t.parsedType}),H}return Qe(e.data)}}an.create=s=>new an({typeName:V.ZodUndefined,...ee(s)});class rn extends ne{_parse(e){if(this._getType(e)!==R.null){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.null,received:t.parsedType}),H}return Qe(e.data)}}rn.create=s=>new rn({typeName:V.ZodNull,...ee(s)});class Cs extends ne{constructor(){super(...arguments),this._any=!0}_parse(e){return Qe(e.data)}}Cs.create=s=>new Cs({typeName:V.ZodAny,...ee(s)});class hs extends ne{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Qe(e.data)}}hs.create=s=>new hs({typeName:V.ZodUnknown,...ee(s)});class Zt extends ne{_parse(e){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.never,received:t.parsedType}),H}}Zt.create=s=>new Zt({typeName:V.ZodNever,...ee(s)});class ii extends ne{_parse(e){if(this._getType(e)!==R.undefined){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.void,received:t.parsedType}),H}return Qe(e.data)}}ii.create=s=>new ii({typeName:V.ZodVoid,...ee(s)});class gt extends ne{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),i=this._def;if(t.parsedType!==R.array)return N(t,{code:k.invalid_type,expected:R.array,received:t.parsedType}),H;if(i.exactLength!==null){const r=t.data.length>i.exactLength.value,o=t.data.length<i.exactLength.value;(r||o)&&(N(t,{code:r?k.too_big:k.too_small,minimum:o?i.exactLength.value:void 0,maximum:r?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),n.dirty())}if(i.minLength!==null&&t.data.length<i.minLength.value&&(N(t,{code:k.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),n.dirty()),i.maxLength!==null&&t.data.length>i.maxLength.value&&(N(t,{code:k.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((r,o)=>i.type._parseAsync(new Tt(t,r,t.path,o)))).then(r=>We.mergeArray(n,r));const a=[...t.data].map((r,o)=>i.type._parseSync(new Tt(t,r,t.path,o)));return We.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new gt({...this._def,minLength:{value:e,message:D.toString(t)}})}max(e,t){return new gt({...this._def,maxLength:{value:e,message:D.toString(t)}})}length(e,t){return new gt({...this._def,exactLength:{value:e,message:D.toString(t)}})}nonempty(e){return this.min(1,e)}}gt.create=(s,e)=>new gt({type:s,minLength:null,maxLength:null,exactLength:null,typeName:V.ZodArray,...ee(e)});function As(s){if(s instanceof ve){const e={};for(const t in s.shape){const n=s.shape[t];e[t]=Nt.create(As(n))}return new ve({...s._def,shape:()=>e})}else return s instanceof gt?new gt({...s._def,type:As(s.element)}):s instanceof Nt?Nt.create(As(s.unwrap())):s instanceof es?es.create(As(s.unwrap())):s instanceof Pt?Pt.create(s.items.map(e=>As(e))):s}class ve extends ne{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=ce.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==R.object){const c=this._getOrReturnCtx(e);return N(c,{code:k.invalid_type,expected:R.object,received:c.parsedType}),H}const{status:t,ctx:n}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),r=[];if(!(this._def.catchall instanceof Zt&&this._def.unknownKeys==="strip"))for(const c in n.data)a.includes(c)||r.push(c);const o=[];for(const c of a){const l=i[c],u=n.data[c];o.push({key:{status:"valid",value:c},value:l._parse(new Tt(n,u,n.path,c)),alwaysSet:c in n.data})}if(this._def.catchall instanceof Zt){const c=this._def.unknownKeys;if(c==="passthrough")for(const l of r)o.push({key:{status:"valid",value:l},value:{status:"valid",value:n.data[l]}});else if(c==="strict")r.length>0&&(N(n,{code:k.unrecognized_keys,keys:r}),t.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const l of r){const u=n.data[l];o.push({key:{status:"valid",value:l},value:c._parse(new Tt(n,u,n.path,l)),alwaysSet:l in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const c=[];for(const l of o){const u=await l.key,d=await l.value;c.push({key:u,value:d,alwaysSet:l.alwaysSet})}return c}).then(c=>We.mergeObjectSync(t,c)):We.mergeObjectSync(t,o)}get shape(){return this._def.shape()}strict(e){return D.errToObj,new ve({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{var i,a,r,o;const c=(r=(a=(i=this._def).errorMap)===null||a===void 0?void 0:a.call(i,t,n).message)!==null&&r!==void 0?r:n.defaultError;return t.code==="unrecognized_keys"?{message:(o=D.errToObj(e).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new ve({...this._def,unknownKeys:"strip"})}passthrough(){return new ve({...this._def,unknownKeys:"passthrough"})}extend(e){return new ve({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ve({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:V.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new ve({...this._def,catchall:e})}pick(e){const t={};return ce.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])}),new ve({...this._def,shape:()=>t})}omit(e){const t={};return ce.objectKeys(this.shape).forEach(n=>{e[n]||(t[n]=this.shape[n])}),new ve({...this._def,shape:()=>t})}deepPartial(){return As(this)}partial(e){const t={};return ce.objectKeys(this.shape).forEach(n=>{const i=this.shape[n];e&&!e[n]?t[n]=i:t[n]=i.optional()}),new ve({...this._def,shape:()=>t})}required(e){const t={};return ce.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])t[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof Nt;)i=i._def.innerType;t[n]=i}}),new ve({...this._def,shape:()=>t})}keyof(){return Co(ce.objectKeys(this.shape))}}ve.create=(s,e)=>new ve({shape:()=>s,unknownKeys:"strip",catchall:Zt.create(),typeName:V.ZodObject,...ee(e)}),ve.strictCreate=(s,e)=>new ve({shape:()=>s,unknownKeys:"strict",catchall:Zt.create(),typeName:V.ZodObject,...ee(e)}),ve.lazycreate=(s,e)=>new ve({shape:s,unknownKeys:"strip",catchall:Zt.create(),typeName:V.ZodObject,...ee(e)});class on extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;function i(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const r=a.map(o=>new ft(o.ctx.common.issues));return N(t,{code:k.invalid_union,unionErrors:r}),H}if(t.common.async)return Promise.all(n.map(async a=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(i);{let a;const r=[];for(const c of n){const l={...t,common:{...t.common,issues:[]},parent:null},u=c._parseSync({data:t.data,path:t.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!a&&(a={result:u,ctx:l}),l.common.issues.length&&r.push(l.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=r.map(c=>new ft(c));return N(t,{code:k.invalid_union,unionErrors:o}),H}}get options(){return this._def.options}}on.create=(s,e)=>new on({options:s,typeName:V.ZodUnion,...ee(e)});const Xt=s=>s instanceof un?Xt(s.schema):s instanceof bt?Xt(s.innerType()):s instanceof dn?[s.value]:s instanceof Yt?s.options:s instanceof pn?ce.objectValues(s.enum):s instanceof hn?Xt(s._def.innerType):s instanceof an?[void 0]:s instanceof rn?[null]:s instanceof Nt?[void 0,...Xt(s.unwrap())]:s instanceof es?[null,...Xt(s.unwrap())]:s instanceof Ma||s instanceof yn?Xt(s.unwrap()):s instanceof mn?Xt(s._def.innerType):[];class ai extends ne{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.object)return N(t,{code:k.invalid_type,expected:R.object,received:t.parsedType}),H;const n=this.discriminator,i=t.data[n],a=this.optionsMap.get(i);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(N(t,{code:k.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),H)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const i=new Map;for(const a of t){const r=Xt(a.shape[e]);if(!r.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of r){if(i.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);i.set(o,a)}}return new ai({typeName:V.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:i,...ee(n)})}}function Ea(s,e){const t=Jt(s),n=Jt(e);if(s===e)return{valid:!0,data:s};if(t===R.object&&n===R.object){const i=ce.objectKeys(e),a=ce.objectKeys(s).filter(o=>i.indexOf(o)!==-1),r={...s,...e};for(const o of a){const c=Ea(s[o],e[o]);if(!c.valid)return{valid:!1};r[o]=c.data}return{valid:!0,data:r}}else if(t===R.array&&n===R.array){if(s.length!==e.length)return{valid:!1};const i=[];for(let a=0;a<s.length;a++){const r=s[a],o=e[a],c=Ea(r,o);if(!c.valid)return{valid:!1};i.push(c.data)}return{valid:!0,data:i}}else return t===R.date&&n===R.date&&+s==+e?{valid:!0,data:s}:{valid:!1}}class cn extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),i=(a,r)=>{if(wa(a)||wa(r))return H;const o=Ea(a.value,r.value);return o.valid?((xa(a)||xa(r))&&t.dirty(),{status:t.value,value:o.data}):(N(n,{code:k.invalid_intersection_types}),H)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,r])=>i(a,r)):i(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}cn.create=(s,e,t)=>new cn({left:s,right:e,typeName:V.ZodIntersection,...ee(t)});class Pt extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.array)return N(n,{code:k.invalid_type,expected:R.array,received:n.parsedType}),H;if(n.data.length<this._def.items.length)return N(n,{code:k.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),H;!this._def.rest&&n.data.length>this._def.items.length&&(N(n,{code:k.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const i=[...n.data].map((a,r)=>{const o=this._def.items[r]||this._def.rest;return o?o._parse(new Tt(n,a,n.path,r)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>We.mergeArray(t,a)):We.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new Pt({...this._def,rest:e})}}Pt.create=(s,e)=>{if(!Array.isArray(s))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Pt({items:s,typeName:V.ZodTuple,rest:null,...ee(e)})};class ln extends ne{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.object)return N(n,{code:k.invalid_type,expected:R.object,received:n.parsedType}),H;const i=[],a=this._def.keyType,r=this._def.valueType;for(const o in n.data)i.push({key:a._parse(new Tt(n,o,n.path,o)),value:r._parse(new Tt(n,n.data[o],n.path,o)),alwaysSet:o in n.data});return n.common.async?We.mergeObjectAsync(t,i):We.mergeObjectSync(t,i)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof ne?new ln({keyType:e,valueType:t,typeName:V.ZodRecord,...ee(n)}):new ln({keyType:yt.create(),valueType:e,typeName:V.ZodRecord,...ee(t)})}}class ri extends ne{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.map)return N(n,{code:k.invalid_type,expected:R.map,received:n.parsedType}),H;const i=this._def.keyType,a=this._def.valueType,r=[...n.data.entries()].map(([o,c],l)=>({key:i._parse(new Tt(n,o,n.path,[l,"key"])),value:a._parse(new Tt(n,c,n.path,[l,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of r){const l=await c.key,u=await c.value;if(l.status==="aborted"||u.status==="aborted")return H;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(l.value,u.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const c of r){const l=c.key,u=c.value;if(l.status==="aborted"||u.status==="aborted")return H;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),o.set(l.value,u.value)}return{status:t.value,value:o}}}}ri.create=(s,e,t)=>new ri({valueType:e,keyType:s,typeName:V.ZodMap,...ee(t)});class ms extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.set)return N(n,{code:k.invalid_type,expected:R.set,received:n.parsedType}),H;const i=this._def;i.minSize!==null&&n.data.size<i.minSize.value&&(N(n,{code:k.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),i.maxSize!==null&&n.data.size>i.maxSize.value&&(N(n,{code:k.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());const a=this._def.valueType;function r(c){const l=new Set;for(const u of c){if(u.status==="aborted")return H;u.status==="dirty"&&t.dirty(),l.add(u.value)}return{status:t.value,value:l}}const o=[...n.data.values()].map((c,l)=>a._parse(new Tt(n,c,n.path,l)));return n.common.async?Promise.all(o).then(c=>r(c)):r(o)}min(e,t){return new ms({...this._def,minSize:{value:e,message:D.toString(t)}})}max(e,t){return new ms({...this._def,maxSize:{value:e,message:D.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}ms.create=(s,e)=>new ms({valueType:s,minSize:null,maxSize:null,typeName:V.ZodSet,...ee(e)});class Ss extends ne{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.function)return N(t,{code:k.invalid_type,expected:R.function,received:t.parsedType}),H;function n(o,c){return ei({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Yn(),ks].filter(l=>!!l),issueData:{code:k.invalid_arguments,argumentsError:c}})}function i(o,c){return ei({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Yn(),ks].filter(l=>!!l),issueData:{code:k.invalid_return_type,returnTypeError:c}})}const a={errorMap:t.common.contextualErrorMap},r=t.data;if(this._def.returns instanceof Ts){const o=this;return Qe(async function(...c){const l=new ft([]),u=await o._def.args.parseAsync(c,a).catch(p=>{throw l.addIssue(n(c,p)),l}),d=await Reflect.apply(r,this,u);return await o._def.returns._def.type.parseAsync(d,a).catch(p=>{throw l.addIssue(i(d,p)),l})})}else{const o=this;return Qe(function(...c){const l=o._def.args.safeParse(c,a);if(!l.success)throw new ft([n(c,l.error)]);const u=Reflect.apply(r,this,l.data),d=o._def.returns.safeParse(u,a);if(!d.success)throw new ft([i(u,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Ss({...this._def,args:Pt.create(e).rest(hs.create())})}returns(e){return new Ss({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new Ss({args:e||Pt.create([]).rest(hs.create()),returns:t||hs.create(),typeName:V.ZodFunction,...ee(n)})}}class un extends ne{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}un.create=(s,e)=>new un({getter:s,typeName:V.ZodLazy,...ee(e)});class dn extends ne{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return N(t,{received:t.data,code:k.invalid_literal,expected:this._def.value}),H}return{status:"valid",value:e.data}}get value(){return this._def.value}}dn.create=(s,e)=>new dn({value:s,typeName:V.ZodLiteral,...ee(e)});function Co(s,e){return new Yt({values:s,typeName:V.ZodEnum,...ee(e)})}class Yt extends ne{constructor(){super(...arguments),tn.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return N(t,{expected:ce.joinValues(n),received:t.parsedType,code:k.invalid_type}),H}if(si(this,tn)||xo(this,tn,new Set(this._def.values)),!si(this,tn).has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return N(t,{received:t.data,code:k.invalid_enum_value,options:n}),H}return Qe(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Yt.create(e,{...this._def,...t})}exclude(e,t=this._def){return Yt.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}}tn=new WeakMap,Yt.create=Co;class pn extends ne{constructor(){super(...arguments),sn.set(this,void 0)}_parse(e){const t=ce.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==R.string&&n.parsedType!==R.number){const i=ce.objectValues(t);return N(n,{expected:ce.joinValues(i),received:n.parsedType,code:k.invalid_type}),H}if(si(this,sn)||xo(this,sn,new Set(ce.getValidEnumValues(this._def.values))),!si(this,sn).has(e.data)){const i=ce.objectValues(t);return N(n,{received:n.data,code:k.invalid_enum_value,options:i}),H}return Qe(e.data)}get enum(){return this._def.values}}sn=new WeakMap,pn.create=(s,e)=>new pn({values:s,typeName:V.ZodNativeEnum,...ee(e)});class Ts extends ne{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.promise&&t.common.async===!1)return N(t,{code:k.invalid_type,expected:R.promise,received:t.parsedType}),H;const n=t.parsedType===R.promise?t.data:Promise.resolve(t.data);return Qe(n.then(i=>this._def.type.parseAsync(i,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Ts.create=(s,e)=>new Ts({type:s,typeName:V.ZodPromise,...ee(e)});class bt extends ne{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===V.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),i=this._def.effect||null,a={addIssue:r=>{N(n,r),r.fatal?t.abort():t.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),i.type==="preprocess"){const r=i.transform(n.data,a);if(n.common.async)return Promise.resolve(r).then(async o=>{if(t.value==="aborted")return H;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?H:c.status==="dirty"||t.value==="dirty"?ti(c.value):c});{if(t.value==="aborted")return H;const o=this._def.schema._parseSync({data:r,path:n.path,parent:n});return o.status==="aborted"?H:o.status==="dirty"||t.value==="dirty"?ti(o.value):o}}if(i.type==="refinement"){const r=o=>{const c=i.refinement(o,a);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?H:(o.status==="dirty"&&t.dirty(),r(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?H:(o.status==="dirty"&&t.dirty(),r(o.value).then(()=>({status:t.value,value:o.value}))))}if(i.type==="transform")if(n.common.async===!1){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Ys(r))return r;const o=i.transform(r.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(r=>Ys(r)?Promise.resolve(i.transform(r.value,a)).then(o=>({status:t.value,value:o})):r);ce.assertNever(i)}}bt.create=(s,e,t)=>new bt({schema:s,typeName:V.ZodEffects,effect:e,...ee(t)}),bt.createWithPreprocess=(s,e,t)=>new bt({schema:e,effect:{type:"preprocess",transform:s},typeName:V.ZodEffects,...ee(t)});class Nt extends ne{_parse(e){return this._getType(e)===R.undefined?Qe(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Nt.create=(s,e)=>new Nt({innerType:s,typeName:V.ZodOptional,...ee(e)});class es extends ne{_parse(e){return this._getType(e)===R.null?Qe(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}es.create=(s,e)=>new es({innerType:s,typeName:V.ZodNullable,...ee(e)});class hn extends ne{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===R.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}hn.create=(s,e)=>new hn({innerType:s,typeName:V.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...ee(e)});class mn extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},i=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return en(i)?i.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new ft(n.common.issues)},input:n.data})})):{status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new ft(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}mn.create=(s,e)=>new mn({innerType:s,typeName:V.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...ee(e)});class oi extends ne{_parse(e){if(this._getType(e)!==R.nan){const t=this._getOrReturnCtx(e);return N(t,{code:k.invalid_type,expected:R.nan,received:t.parsedType}),H}return{status:"valid",value:e.data}}}oi.create=s=>new oi({typeName:V.ZodNaN,...ee(s)});const ph=Symbol("zod_brand");class Ma extends ne{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class fn extends ne{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?H:i.status==="dirty"?(t.dirty(),ti(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const i=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?H:i.status==="dirty"?(t.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:n.path,parent:n})}}static create(e,t){return new fn({in:e,out:t,typeName:V.ZodPipeline})}}class yn extends ne{_parse(e){const t=this._def.innerType._parse(e),n=i=>(Ys(i)&&(i.value=Object.freeze(i.value)),i);return en(t)?t.then(i=>n(i)):n(t)}unwrap(){return this._def.innerType}}yn.create=(s,e)=>new yn({innerType:s,typeName:V.ZodReadonly,...ee(e)});function Ao(s,e={},t){return s?Cs.create().superRefine((n,i)=>{var a,r;if(!s(n)){const o=typeof e=="function"?e(n):typeof e=="string"?{message:e}:e,c=(r=(a=o.fatal)!==null&&a!==void 0?a:t)!==null&&r!==void 0?r:!0,l=typeof o=="string"?{message:o}:o;i.addIssue({code:"custom",...l,fatal:c})}}):Cs.create()}const hh={object:ve.lazycreate};(function(s){s.ZodString="ZodString",s.ZodNumber="ZodNumber",s.ZodNaN="ZodNaN",s.ZodBigInt="ZodBigInt",s.ZodBoolean="ZodBoolean",s.ZodDate="ZodDate",s.ZodSymbol="ZodSymbol",s.ZodUndefined="ZodUndefined",s.ZodNull="ZodNull",s.ZodAny="ZodAny",s.ZodUnknown="ZodUnknown",s.ZodNever="ZodNever",s.ZodVoid="ZodVoid",s.ZodArray="ZodArray",s.ZodObject="ZodObject",s.ZodUnion="ZodUnion",s.ZodDiscriminatedUnion="ZodDiscriminatedUnion",s.ZodIntersection="ZodIntersection",s.ZodTuple="ZodTuple",s.ZodRecord="ZodRecord",s.ZodMap="ZodMap",s.ZodSet="ZodSet",s.ZodFunction="ZodFunction",s.ZodLazy="ZodLazy",s.ZodLiteral="ZodLiteral",s.ZodEnum="ZodEnum",s.ZodEffects="ZodEffects",s.ZodNativeEnum="ZodNativeEnum",s.ZodOptional="ZodOptional",s.ZodNullable="ZodNullable",s.ZodDefault="ZodDefault",s.ZodCatch="ZodCatch",s.ZodPromise="ZodPromise",s.ZodBranded="ZodBranded",s.ZodPipeline="ZodPipeline",s.ZodReadonly="ZodReadonly"})(V||(V={}));const mh=(s,e={message:`Input not instance of ${s.name}`})=>Ao(t=>t instanceof s,e),So=yt.create,To=Ht.create,fh=oi.create,yh=Gt.create,Po=nn.create,gh=ps.create,bh=ni.create,_h=an.create,vh=rn.create,wh=Cs.create,xh=hs.create,Oh=Zt.create,Eh=ii.create,Mh=gt.create,kh=ve.create,Ch=ve.strictCreate,Ah=on.create,Sh=ai.create,Th=cn.create,Ph=Pt.create,Nh=ln.create,jh=ri.create,Ih=ms.create,Rh=Ss.create,$h=un.create,Lh=dn.create,Bh=Yt.create,Dh=pn.create,qh=Ts.create,No=bt.create,Fh=Nt.create,Uh=es.create,Wh=bt.createWithPreprocess,Zh=fn.create,Vh=()=>So().optional(),zh=()=>To().optional(),Kh=()=>Po().optional(),Qh={string:s=>yt.create({...s,coerce:!0}),number:s=>Ht.create({...s,coerce:!0}),boolean:s=>nn.create({...s,coerce:!0}),bigint:s=>Gt.create({...s,coerce:!0}),date:s=>ps.create({...s,coerce:!0})},Jh=H;let ka;St=Object.freeze({__proto__:null,defaultErrorMap:ks,setErrorMap:Jp,getErrorMap:Yn,makeIssue:ei,EMPTY_PATH:Hp,addIssueToContext:N,ParseStatus:We,INVALID:H,DIRTY:ti,OK:Qe,isAborted:wa,isDirty:xa,isValid:Ys,isAsync:en,get util(){return ce},get objectUtil(){return va},ZodParsedType:R,getParsedType:Jt,ZodType:ne,datetimeRegex:ko,ZodString:yt,ZodNumber:Ht,ZodBigInt:Gt,ZodBoolean:nn,ZodDate:ps,ZodSymbol:ni,ZodUndefined:an,ZodNull:rn,ZodAny:Cs,ZodUnknown:hs,ZodNever:Zt,ZodVoid:ii,ZodArray:gt,ZodObject:ve,ZodUnion:on,ZodDiscriminatedUnion:ai,ZodIntersection:cn,ZodTuple:Pt,ZodRecord:ln,ZodMap:ri,ZodSet:ms,ZodFunction:Ss,ZodLazy:un,ZodLiteral:dn,ZodEnum:Yt,ZodNativeEnum:pn,ZodPromise:Ts,ZodEffects:bt,ZodTransformer:bt,ZodOptional:Nt,ZodNullable:es,ZodDefault:hn,ZodCatch:mn,ZodNaN:oi,BRAND:ph,ZodBranded:Ma,ZodPipeline:fn,ZodReadonly:yn,custom:Ao,Schema:ne,ZodSchema:ne,late:hh,get ZodFirstPartyTypeKind(){return V},coerce:Qh,any:wh,array:Mh,bigint:yh,boolean:Po,date:gh,discriminatedUnion:Sh,effect:No,enum:Bh,function:Rh,instanceof:mh,intersection:Th,lazy:$h,literal:Lh,map:jh,nan:fh,nativeEnum:Dh,never:Oh,null:vh,nullable:Uh,number:To,object:kh,oboolean:Kh,onumber:zh,optional:Fh,ostring:Vh,pipeline:Zh,preprocess:Wh,promise:qh,record:Nh,set:Ih,strictObject:Ch,string:So,symbol:bh,transformer:No,tuple:Ph,undefined:_h,union:Ah,unknown:xh,void:Eh,NEVER:Jh,ZodIssueCode:k,quotelessJson:Qp,ZodError:ft}),ka={};var jo;function Hh(){if(jo)return ka;jo=1;var s;return function(e){(function(t){var n=typeof globalThis=="object"?globalThis:typeof hp=="object"?hp:typeof self=="object"?self:typeof this=="object"?this:c(),i=a(e);typeof n.Reflect<"u"&&(i=a(n.Reflect,i)),t(i,n),typeof n.Reflect>"u"&&(n.Reflect=e);function a(l,u){return function(d,p){Object.defineProperty(l,d,{configurable:!0,writable:!0,value:p}),u&&u(d,p)}}function r(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function c(){return r()||o()}})(function(t,n){var i=Object.prototype.hasOwnProperty,a=typeof Symbol=="function",r=a&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=a&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",c=typeof Object.create=="function",l={__proto__:[]}instanceof Array,u=!c&&!l,d={create:c?function(){return Vn(Object.create(null))}:l?function(){return Vn({__proto__:null})}:function(){return Vn({})},has:u?function(_,x){return i.call(_,x)}:function(_,x){return x in _},get:u?function(_,x){return i.call(_,x)?_[x]:void 0}:function(_,x){return _[x]}},p=Object.getPrototypeOf(Function),h=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:oa(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:ca(),y=typeof WeakMap=="function"?WeakMap:no(),f=a?Symbol.for("@reflect-metadata:registry"):void 0,g=dt(),b=qt(g);function v(_,x,O,A){if(F(O)){if(!os(_))throw new TypeError;if(!z(x))throw new TypeError;return le(_,x)}else{if(!os(_))throw new TypeError;if(!be(x))throw new TypeError;if(!be(A)&&!F(A)&&!st(A))throw new TypeError;return st(A)&&(A=void 0),O=nt(O),lt(_,x,O,A)}}t("decorate",v);function E(_,x){function O(A,Z){if(!be(A))throw new TypeError;if(!F(Z)&&!Y(Z))throw new TypeError;tt(_,x,A,Z)}return O}t("metadata",E);function S(_,x,O,A){if(!be(O))throw new TypeError;return F(A)||(A=nt(A)),tt(_,x,O,A)}t("defineMetadata",S);function C(_,x,O){if(!be(x))throw new TypeError;return F(O)||(O=nt(O)),He(_,x,O)}t("hasMetadata",C);function Q(_,x,O){if(!be(x))throw new TypeError;return F(O)||(O=nt(O)),et(_,x,O)}t("hasOwnMetadata",Q);function J(_,x,O){if(!be(x))throw new TypeError;return F(O)||(O=nt(O)),ge(_,x,O)}t("getMetadata",J);function W(_,x,O){if(!be(x))throw new TypeError;return F(O)||(O=nt(O)),kt(_,x,O)}t("getOwnMetadata",W);function q(_,x){if(!be(_))throw new TypeError;return F(x)||(x=nt(x)),rs(_,x)}t("getMetadataKeys",q);function pe(_,x){if(!be(_))throw new TypeError;return F(x)||(x=nt(x)),ut(_,x)}t("getOwnMetadataKeys",pe);function we(_,x,O){if(!be(x))throw new TypeError;if(F(O)||(O=nt(O)),!be(x))throw new TypeError;F(O)||(O=nt(O));var A=mt(x,O,!1);return F(A)?!1:A.OrdinaryDeleteMetadata(_,x,O)}t("deleteMetadata",we);function le(_,x){for(var O=_.length-1;O>=0;--O){var A=_[O],Z=A(x);if(!F(Z)&&!st(Z)){if(!z(Z))throw new TypeError;x=Z}}return x}function lt(_,x,O,A){for(var Z=_.length-1;Z>=0;--Z){var Le=_[Z],Ne=Le(x,O,A);if(!F(Ne)&&!st(Ne)){if(!be(Ne))throw new TypeError;A=Ne}}return A}function He(_,x,O){var A=et(_,x,O);if(A)return!0;var Z=_e(x);return st(Z)?!1:He(_,Z,O)}function et(_,x,O){var A=mt(x,O,!1);return F(A)?!1:pt(A.OrdinaryHasOwnMetadata(_,x,O))}function ge(_,x,O){var A=et(_,x,O);if(A)return kt(_,x,O);var Z=_e(x);if(!st(Z))return ge(_,Z,O)}function kt(_,x,O){var A=mt(x,O,!1);if(!F(A))return A.OrdinaryGetOwnMetadata(_,x,O)}function tt(_,x,O,A){var Z=mt(O,A,!0);Z.OrdinaryDefineOwnMetadata(_,x,O,A)}function rs(_,x){var O=ut(_,x),A=_e(_);if(A===null)return O;var Z=rs(A,x);if(Z.length<=0)return O;if(O.length<=0)return Z;for(var Le=new m,Ne=[],re=0,I=O;re<I.length;re++){var $=I[re],L=Le.has($);L||(Le.add($),Ne.push($))}for(var B=0,oe=Z;B<oe.length;B++){var $=oe[B],L=Le.has($);L||(Le.add($),Ne.push($))}return Ne}function ut(_,x){var O=mt(_,x,!1);return O?O.OrdinaryOwnMetadataKeys(_,x):[]}function Bt(_){if(_===null)return 1;switch(typeof _){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return _===null?1:6;default:return 6}}function F(_){return _===void 0}function st(_){return _===null}function Dt(_){return typeof _=="symbol"}function be(_){return typeof _=="object"?_!==null:typeof _=="function"}function Es(_,x){switch(Bt(_)){case 0:return _;case 1:return _;case 2:return _;case 3:return _;case 4:return _;case 5:return _}var O="string",A=Ue(_,r);if(A!==void 0){var Z=A.call(_,O);if(be(Z))throw new TypeError;return Z}return Ke(_)}function Ke(_,x){var O,A;{var Z=_.toString;if(cs(Z)){var A=Z.call(_);if(!be(A))return A}var O=_.valueOf;if(cs(O)){var A=O.call(_);if(!be(A))return A}}throw new TypeError}function pt(_){return!!_}function Ct(_){return""+_}function nt(_){var x=Es(_);return Dt(x)?x:Ct(x)}function os(_){return Array.isArray?Array.isArray(_):_ instanceof Object?_ instanceof Array:Object.prototype.toString.call(_)==="[object Array]"}function cs(_){return typeof _=="function"}function z(_){return typeof _=="function"}function Y(_){switch(Bt(_)){case 3:return!0;case 4:return!0;default:return!1}}function Oe(_,x){return _===x||_!==_&&x!==x}function Ue(_,x){var O=_[x];if(O!=null){if(!cs(O))throw new TypeError;return O}}function $e(_){var x=Ue(_,o);if(!cs(x))throw new TypeError;var O=x.call(_);if(!be(O))throw new TypeError;return O}function he(_){return _.value}function Pe(_){var x=_.next();return x.done?!1:x}function Ee(_){var x=_.return;x&&x.call(_)}function _e(_){var x=Object.getPrototypeOf(_);if(typeof _!="function"||_===p||x!==p)return x;var O=_.prototype,A=O&&Object.getPrototypeOf(O);if(A==null||A===Object.prototype)return x;var Z=A.constructor;return typeof Z!="function"||Z===_?x:Z}function ht(){var _;!F(f)&&typeof n.Reflect<"u"&&!(f in n.Reflect)&&typeof n.Reflect.defineMetadata=="function"&&(_=Ft(n.Reflect));var x,O,A,Z=new y,Le={registerProvider:Ne,getProvider:I,setProvider:L};return Le;function Ne(B){if(!Object.isExtensible(Le))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case _===B:break;case F(x):x=B;break;case x===B:break;case F(O):O=B;break;case O===B:break;default:A===void 0&&(A=new m),A.add(B);break}}function re(B,oe){if(!F(x)){if(x.isProviderFor(B,oe))return x;if(!F(O)){if(O.isProviderFor(B,oe))return x;if(!F(A))for(var ye=$e(A);;){var Ce=Pe(ye);if(!Ce)return;var At=he(Ce);if(At.isProviderFor(B,oe))return Ee(ye),At}}}if(!F(_)&&_.isProviderFor(B,oe))return _}function I(B,oe){var ye=Z.get(B),Ce;return F(ye)||(Ce=ye.get(oe)),F(Ce)&&(Ce=re(B,oe),F(Ce)||(F(ye)&&(ye=new h,Z.set(B,ye)),ye.set(oe,Ce))),Ce}function $(B){if(F(B))throw new TypeError;return x===B||O===B||!F(A)&&A.has(B)}function L(B,oe,ye){if(!$(ye))throw new Error("Metadata provider not registered.");var Ce=I(B,oe);if(Ce!==ye){if(!F(Ce))return!1;var At=Z.get(B);F(At)&&(At=new h,Z.set(B,At)),At.set(oe,ye)}return!0}}function dt(){var _;return!F(f)&&be(n.Reflect)&&Object.isExtensible(n.Reflect)&&(_=n.Reflect[f]),F(_)&&(_=ht()),!F(f)&&be(n.Reflect)&&Object.isExtensible(n.Reflect)&&Object.defineProperty(n.Reflect,f,{enumerable:!1,configurable:!1,writable:!1,value:_}),_}function qt(_){var x=new y,O={isProviderFor:function($,L){var B=x.get($);return F(B)?!1:B.has(L)},OrdinaryDefineOwnMetadata:Ne,OrdinaryHasOwnMetadata:Z,OrdinaryGetOwnMetadata:Le,OrdinaryOwnMetadataKeys:re,OrdinaryDeleteMetadata:I};return g.registerProvider(O),O;function A($,L,B){var oe=x.get($),ye=!1;if(F(oe)){if(!B)return;oe=new h,x.set($,oe),ye=!0}var Ce=oe.get(L);if(F(Ce)){if(!B)return;if(Ce=new h,oe.set(L,Ce),!_.setProvider($,L,O))throw oe.delete(L),ye&&x.delete($),new Error("Wrong provider for target.")}return Ce}function Z($,L,B){var oe=A(L,B,!1);return F(oe)?!1:pt(oe.has($))}function Le($,L,B){var oe=A(L,B,!1);if(!F(oe))return oe.get($)}function Ne($,L,B,oe){var ye=A(B,oe,!0);ye.set($,L)}function re($,L){var B=[],oe=A($,L,!1);if(F(oe))return B;for(var ye=oe.keys(),Ce=$e(ye),At=0;;){var dp=Pe(Ce);if(!dp)return B.length=At,B;var ub=he(dp);try{B[At]=ub}catch(db){try{Ee(Ce)}finally{throw db}}At++}}function I($,L,B){var oe=A(L,B,!1);if(F(oe)||!oe.delete($))return!1;if(oe.size===0){var ye=x.get(L);F(ye)||(ye.delete(B),ye.size===0&&x.delete(ye))}return!0}}function Ft(_){var x=_.defineMetadata,O=_.hasOwnMetadata,A=_.getOwnMetadata,Z=_.getOwnMetadataKeys,Le=_.deleteMetadata,Ne=new y,re={isProviderFor:function(I,$){var L=Ne.get(I);return!F(L)&&L.has($)?!0:Z(I,$).length?(F(L)&&(L=new m,Ne.set(I,L)),L.add($),!0):!1},OrdinaryDefineOwnMetadata:x,OrdinaryHasOwnMetadata:O,OrdinaryGetOwnMetadata:A,OrdinaryOwnMetadataKeys:Z,OrdinaryDeleteMetadata:Le};return re}function mt(_,x,O){var A=g.getProvider(_,x);if(!F(A))return A;if(O){if(g.setProvider(_,x,b))return b;throw new Error("Illegal state.")}}function oa(){var _={},x=[],O=function(){function re(I,$,L){this._index=0,this._keys=I,this._values=$,this._selector=L}return re.prototype["@@iterator"]=function(){return this},re.prototype[o]=function(){return this},re.prototype.next=function(){var I=this._index;if(I>=0&&I<this._keys.length){var $=this._selector(this._keys[I],this._values[I]);return I+1>=this._keys.length?(this._index=-1,this._keys=x,this._values=x):this._index++,{value:$,done:!1}}return{value:void 0,done:!0}},re.prototype.throw=function(I){throw this._index>=0&&(this._index=-1,this._keys=x,this._values=x),I},re.prototype.return=function(I){return this._index>=0&&(this._index=-1,this._keys=x,this._values=x),{value:I,done:!0}},re}(),A=function(){function re(){this._keys=[],this._values=[],this._cacheKey=_,this._cacheIndex=-2}return Object.defineProperty(re.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),re.prototype.has=function(I){return this._find(I,!1)>=0},re.prototype.get=function(I){var $=this._find(I,!1);return $>=0?this._values[$]:void 0},re.prototype.set=function(I,$){var L=this._find(I,!0);return this._values[L]=$,this},re.prototype.delete=function(I){var $=this._find(I,!1);if($>=0){for(var L=this._keys.length,B=$+1;B<L;B++)this._keys[B-1]=this._keys[B],this._values[B-1]=this._values[B];return this._keys.length--,this._values.length--,Oe(I,this._cacheKey)&&(this._cacheKey=_,this._cacheIndex=-2),!0}return!1},re.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=_,this._cacheIndex=-2},re.prototype.keys=function(){return new O(this._keys,this._values,Z)},re.prototype.values=function(){return new O(this._keys,this._values,Le)},re.prototype.entries=function(){return new O(this._keys,this._values,Ne)},re.prototype["@@iterator"]=function(){return this.entries()},re.prototype[o]=function(){return this.entries()},re.prototype._find=function(I,$){if(!Oe(this._cacheKey,I)){this._cacheIndex=-1;for(var L=0;L<this._keys.length;L++)if(Oe(this._keys[L],I)){this._cacheIndex=L;break}}return this._cacheIndex<0&&$&&(this._cacheIndex=this._keys.length,this._keys.push(I),this._values.push(void 0)),this._cacheIndex},re}();return A;function Z(re,I){return re}function Le(re,I){return I}function Ne(re,I){return[re,I]}}function ca(){var _=function(){function x(){this._map=new h}return Object.defineProperty(x.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),x.prototype.has=function(O){return this._map.has(O)},x.prototype.add=function(O){return this._map.set(O,O),this},x.prototype.delete=function(O){return this._map.delete(O)},x.prototype.clear=function(){this._map.clear()},x.prototype.keys=function(){return this._map.keys()},x.prototype.values=function(){return this._map.keys()},x.prototype.entries=function(){return this._map.entries()},x.prototype["@@iterator"]=function(){return this.keys()},x.prototype[o]=function(){return this.keys()},x}();return _}function no(){var _=16,x=d.create(),O=A();return function(){function I(){this._key=A()}return I.prototype.has=function($){var L=Z($,!1);return L!==void 0?d.has(L,this._key):!1},I.prototype.get=function($){var L=Z($,!1);return L!==void 0?d.get(L,this._key):void 0},I.prototype.set=function($,L){var B=Z($,!0);return B[this._key]=L,this},I.prototype.delete=function($){var L=Z($,!1);return L!==void 0?delete L[this._key]:!1},I.prototype.clear=function(){this._key=A()},I}();function A(){var I;do I="@@WeakMap@@"+re();while(d.has(x,I));return x[I]=!0,I}function Z(I,$){if(!i.call(I,O)){if(!$)return;Object.defineProperty(I,O,{value:d.create()})}return I[O]}function Le(I,$){for(var L=0;L<$;++L)I[L]=Math.random()*255|0;return I}function Ne(I){if(typeof Uint8Array=="function"){var $=new Uint8Array(I);return typeof crypto<"u"?crypto.getRandomValues($):typeof msCrypto<"u"?msCrypto.getRandomValues($):Le($,I),$}return Le(new Array(I),I)}function re(){var I=Ne(_);I[6]=I[6]&79|64,I[8]=I[8]&191|128;for(var $="",L=0;L<_;++L){var B=I[L];(L===4||L===6||L===8)&&($+="-"),B<16&&($+="0"),$+=B.toString(16).toLowerCase()}return $}}function Vn(_){return _.__=void 0,delete _.__,_}})}(s||(s={})),ka}Hh(),typeof window<"u"&&(window.Buffer=pb),typeof ga<"u"&&typeof require<"u"&&(ga.Buffer=require("buffer/").Buffer);class Me{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const n of t)for(const i of Object.getOwnPropertyNames(n))e[i]=n[i]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class j extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class Ps extends j{constructor(){super("Locking not supported on given driver.")}}class Ca extends j{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class me{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class Gh extends j{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return me.isEntitySchema(e)?e.options.name:typeof e=="function"||Me.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class Io extends j{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}}class Ro extends j{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class Xh extends j{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class ci extends j{constructor(){super("OUTPUT or RETURNING clause only supported by Microsoft SQL Server or PostgreSQL or MariaDB databases.")}}class jt extends j{constructor(e,t){super(e),Object.setPrototypeOf(this,jt.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class Yh extends j{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class em extends j{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class gn extends j{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class tm extends j{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class sm extends j{constructor(){super("An open transaction is required for pessimistic lock.")}}class nm extends j{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class $o{constructor(e){Me.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new j(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class It{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var Aa={exports:{}},Sa={exports:{}},Lo;ds=function(){return Lo||(Lo=1,typeof Object.create=="function"?Sa.exports=function(s,e){e&&(s.super_=e,s.prototype=Object.create(e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}))}:Sa.exports=function(s,e){if(e){s.super_=e;var t=function(){};t.prototype=e.prototype,s.prototype=new t,s.prototype.constructor=s}}),Sa.exports};var Ta,Bo;function Ns(){if(Bo)return Ta;Bo=1;var s=Ms().Buffer;function e(t,n){this._block=s.alloc(t),this._finalSize=n,this._blockSize=t,this._len=0}return e.prototype.update=function(t,n){typeof t=="string"&&(n=n||"utf8",t=s.from(t,n));for(var i=this._block,a=this._blockSize,r=t.length,o=this._len,c=0;c<r;){for(var l=o%a,u=Math.min(r-c,a-l),d=0;d<u;d++)i[l+d]=t[c+d];o+=u,c+=u,o%a===0&&this._update(i)}return this._len+=r,this},e.prototype.digest=function(t){var n=this._len%this._blockSize;this._block[n]=128,this._block.fill(0,n+1),n>=this._finalSize&&(this._update(this._block),this._block.fill(0));var i=this._len*8;if(i<=4294967295)this._block.writeUInt32BE(i,this._blockSize-4);else{var a=(i&4294967295)>>>0,r=(i-a)/4294967296;this._block.writeUInt32BE(r,this._blockSize-8),this._block.writeUInt32BE(a,this._blockSize-4)}this._update(this._block);var o=this._hash();return t?o.toString(t):o},e.prototype._update=function(){throw new Error("_update must be implemented by subclass")},Ta=e,Ta}var Pa,Do;function im(){if(Do)return Pa;Do=1;var s=ds(),e=Ns(),t=Ms().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],i=new Array(80);function a(){this.init(),this._w=i,e.call(this,64,56)}s(a,e),a.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function r(l){return l<<5|l>>>27}function o(l){return l<<30|l>>>2}function c(l,u,d,p){return l===0?u&d|~u&p:l===2?u&d|u&p|d&p:u^d^p}return a.prototype._update=function(l){for(var u=this._w,d=this._a|0,p=this._b|0,h=this._c|0,m=this._d|0,y=this._e|0,f=0;f<16;++f)u[f]=l.readInt32BE(f*4);for(;f<80;++f)u[f]=u[f-3]^u[f-8]^u[f-14]^u[f-16];for(var g=0;g<80;++g){var b=~~(g/20),v=r(d)+c(b,p,h,m)+y+u[g]+n[b]|0;y=m,m=h,h=o(p),p=d,d=v}this._a=d+this._a|0,this._b=p+this._b|0,this._c=h+this._c|0,this._d=m+this._d|0,this._e=y+this._e|0},a.prototype._hash=function(){var l=t.allocUnsafe(20);return l.writeInt32BE(this._a|0,0),l.writeInt32BE(this._b|0,4),l.writeInt32BE(this._c|0,8),l.writeInt32BE(this._d|0,12),l.writeInt32BE(this._e|0,16),l},Pa=a,Pa}var Na,qo;function am(){if(qo)return Na;qo=1;var s=ds(),e=Ns(),t=Ms().Buffer,n=[1518500249,1859775393,-1894007588,-899497514],i=new Array(80);function a(){this.init(),this._w=i,e.call(this,64,56)}s(a,e),a.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function r(u){return u<<1|u>>>31}function o(u){return u<<5|u>>>27}function c(u){return u<<30|u>>>2}function l(u,d,p,h){return u===0?d&p|~d&h:u===2?d&p|d&h|p&h:d^p^h}return a.prototype._update=function(u){for(var d=this._w,p=this._a|0,h=this._b|0,m=this._c|0,y=this._d|0,f=this._e|0,g=0;g<16;++g)d[g]=u.readInt32BE(g*4);for(;g<80;++g)d[g]=r(d[g-3]^d[g-8]^d[g-14]^d[g-16]);for(var b=0;b<80;++b){var v=~~(b/20),E=o(p)+l(v,h,m,y)+f+d[b]+n[v]|0;f=y,y=m,m=c(h),h=p,p=E}this._a=p+this._a|0,this._b=h+this._b|0,this._c=m+this._c|0,this._d=y+this._d|0,this._e=f+this._e|0},a.prototype._hash=function(){var u=t.allocUnsafe(20);return u.writeInt32BE(this._a|0,0),u.writeInt32BE(this._b|0,4),u.writeInt32BE(this._c|0,8),u.writeInt32BE(this._d|0,12),u.writeInt32BE(this._e|0,16),u},Na=a,Na}var ja,Fo;function Uo(){if(Fo)return ja;Fo=1;var s=ds(),e=Ns(),t=Ms().Buffer,n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],i=new Array(64);function a(){this.init(),this._w=i,e.call(this,64,56)}s(a,e),a.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function r(p,h,m){return m^p&(h^m)}function o(p,h,m){return p&h|m&(p|h)}function c(p){return(p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10)}function l(p){return(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7)}function u(p){return(p>>>7|p<<25)^(p>>>18|p<<14)^p>>>3}function d(p){return(p>>>17|p<<15)^(p>>>19|p<<13)^p>>>10}return a.prototype._update=function(p){for(var h=this._w,m=this._a|0,y=this._b|0,f=this._c|0,g=this._d|0,b=this._e|0,v=this._f|0,E=this._g|0,S=this._h|0,C=0;C<16;++C)h[C]=p.readInt32BE(C*4);for(;C<64;++C)h[C]=d(h[C-2])+h[C-7]+u(h[C-15])+h[C-16]|0;for(var Q=0;Q<64;++Q){var J=S+l(b)+r(b,v,E)+n[Q]+h[Q]|0,W=c(m)+o(m,y,f)|0;S=E,E=v,v=b,b=g+J|0,g=f,f=y,y=m,m=J+W|0}this._a=m+this._a|0,this._b=y+this._b|0,this._c=f+this._c|0,this._d=g+this._d|0,this._e=b+this._e|0,this._f=v+this._f|0,this._g=E+this._g|0,this._h=S+this._h|0},a.prototype._hash=function(){var p=t.allocUnsafe(32);return p.writeInt32BE(this._a,0),p.writeInt32BE(this._b,4),p.writeInt32BE(this._c,8),p.writeInt32BE(this._d,12),p.writeInt32BE(this._e,16),p.writeInt32BE(this._f,20),p.writeInt32BE(this._g,24),p.writeInt32BE(this._h,28),p},ja=a,ja}var Ia,Wo;function rm(){if(Wo)return Ia;Wo=1;var s=ds(),e=Uo(),t=Ns(),n=Ms().Buffer,i=new Array(64);function a(){this.init(),this._w=i,t.call(this,64,56)}return s(a,e),a.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},a.prototype._hash=function(){var r=n.allocUnsafe(28);return r.writeInt32BE(this._a,0),r.writeInt32BE(this._b,4),r.writeInt32BE(this._c,8),r.writeInt32BE(this._d,12),r.writeInt32BE(this._e,16),r.writeInt32BE(this._f,20),r.writeInt32BE(this._g,24),r},Ia=a,Ia}var Ra,Zo;function Vo(){if(Zo)return Ra;Zo=1;var s=ds(),e=Ns(),t=Ms().Buffer,n=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],i=new Array(160);function a(){this.init(),this._w=i,e.call(this,128,112)}s(a,e),a.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function r(y,f,g){return g^y&(f^g)}function o(y,f,g){return y&f|g&(y|f)}function c(y,f){return(y>>>28|f<<4)^(f>>>2|y<<30)^(f>>>7|y<<25)}function l(y,f){return(y>>>14|f<<18)^(y>>>18|f<<14)^(f>>>9|y<<23)}function u(y,f){return(y>>>1|f<<31)^(y>>>8|f<<24)^y>>>7}function d(y,f){return(y>>>1|f<<31)^(y>>>8|f<<24)^(y>>>7|f<<25)}function p(y,f){return(y>>>19|f<<13)^(f>>>29|y<<3)^y>>>6}function h(y,f){return(y>>>19|f<<13)^(f>>>29|y<<3)^(y>>>6|f<<26)}function m(y,f){return y>>>0<f>>>0?1:0}return a.prototype._update=function(y){for(var f=this._w,g=this._ah|0,b=this._bh|0,v=this._ch|0,E=this._dh|0,S=this._eh|0,C=this._fh|0,Q=this._gh|0,J=this._hh|0,W=this._al|0,q=this._bl|0,pe=this._cl|0,we=this._dl|0,le=this._el|0,lt=this._fl|0,He=this._gl|0,et=this._hl|0,ge=0;ge<32;ge+=2)f[ge]=y.readInt32BE(ge*4),f[ge+1]=y.readInt32BE(ge*4+4);for(;ge<160;ge+=2){var kt=f[ge-30],tt=f[ge-15*2+1],rs=u(kt,tt),ut=d(tt,kt);kt=f[ge-2*2],tt=f[ge-2*2+1];var Bt=p(kt,tt),F=h(tt,kt),st=f[ge-7*2],Dt=f[ge-7*2+1],be=f[ge-16*2],Es=f[ge-16*2+1],Ke=ut+Dt|0,pt=rs+st+m(Ke,ut)|0;Ke=Ke+F|0,pt=pt+Bt+m(Ke,F)|0,Ke=Ke+Es|0,pt=pt+be+m(Ke,Es)|0,f[ge]=pt,f[ge+1]=Ke}for(var Ct=0;Ct<160;Ct+=2){pt=f[Ct],Ke=f[Ct+1];var nt=o(g,b,v),os=o(W,q,pe),cs=c(g,W),z=c(W,g),Y=l(S,le),Oe=l(le,S),Ue=n[Ct],$e=n[Ct+1],he=r(S,C,Q),Pe=r(le,lt,He),Ee=et+Oe|0,_e=J+Y+m(Ee,et)|0;Ee=Ee+Pe|0,_e=_e+he+m(Ee,Pe)|0,Ee=Ee+$e|0,_e=_e+Ue+m(Ee,$e)|0,Ee=Ee+Ke|0,_e=_e+pt+m(Ee,Ke)|0;var ht=z+os|0,dt=cs+nt+m(ht,z)|0;J=Q,et=He,Q=C,He=lt,C=S,lt=le,le=we+Ee|0,S=E+_e+m(le,we)|0,E=v,we=pe,v=b,pe=q,b=g,q=W,W=Ee+ht|0,g=_e+dt+m(W,Ee)|0}this._al=this._al+W|0,this._bl=this._bl+q|0,this._cl=this._cl+pe|0,this._dl=this._dl+we|0,this._el=this._el+le|0,this._fl=this._fl+lt|0,this._gl=this._gl+He|0,this._hl=this._hl+et|0,this._ah=this._ah+g+m(this._al,W)|0,this._bh=this._bh+b+m(this._bl,q)|0,this._ch=this._ch+v+m(this._cl,pe)|0,this._dh=this._dh+E+m(this._dl,we)|0,this._eh=this._eh+S+m(this._el,le)|0,this._fh=this._fh+C+m(this._fl,lt)|0,this._gh=this._gh+Q+m(this._gl,He)|0,this._hh=this._hh+J+m(this._hl,et)|0},a.prototype._hash=function(){var y=t.allocUnsafe(64);function f(g,b,v){y.writeInt32BE(g,v),y.writeInt32BE(b,v+4)}return f(this._ah,this._al,0),f(this._bh,this._bl,8),f(this._ch,this._cl,16),f(this._dh,this._dl,24),f(this._eh,this._el,32),f(this._fh,this._fl,40),f(this._gh,this._gl,48),f(this._hh,this._hl,56),y},Ra=a,Ra}var $a,zo;function om(){if(zo)return $a;zo=1;var s=ds(),e=Vo(),t=Ns(),n=Ms().Buffer,i=new Array(160);function a(){this.init(),this._w=i,t.call(this,128,112)}return s(a,e),a.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},a.prototype._hash=function(){var r=n.allocUnsafe(48);function o(c,l,u){r.writeInt32BE(c,u),r.writeInt32BE(l,u+4)}return o(this._ah,this._al,0),o(this._bh,this._bl,8),o(this._ch,this._cl,16),o(this._dh,this._dl,24),o(this._eh,this._el,32),o(this._fh,this._fl,40),r},$a=a,$a}var Ko;function cm(){if(Ko)return Aa.exports;Ko=1;var s=Aa.exports=function(e){e=e.toLowerCase();var t=s[e];if(!t)throw new Error(e+" is not supported (we accept pull requests)");return new t};return s.sha=im(),s.sha1=am(),s.sha224=rm(),s.sha256=Uo(),s.sha384=om(),s.sha512=Vo(),Aa.exports}var lm=cm();const um=hb(lm);function dm(s,e={}){const{segmentLength:t=4,separator:n="__",termLength:i=2}=e;return s.split(n).reduce((a,r)=>{const o=r.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),c=o.length>1?i:t,l=o.map(u=>u.substr(0,c)).join("");return a.push(l),a},[]).join(n)}function pm(s,e={}){const t=um("sha1");t.update(s,"utf8");const n=t.digest("hex");return e.length?n.slice(0,e.length):n}class hm{static isGreaterOrEqual(e,t){const n=Qo(e),i=Qo(t);return n[0]>i[0]||n[0]===i[0]&&n[1]>i[1]||n[0]===i[0]&&n[1]===i[1]&&n[2]>=i[2]}}function Qo(s=""){const e=[0,0,0];return s.split(".").forEach((t,n)=>e[n]=parseInt(t,10)),e}class P{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return e.version!=null&&hm.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){const i=t&&t.joiner?t.joiner:"_";let a=n.length===1?n[0]:n.join(i);if(e&&e>0&&a.length>e){if(t&&t.shorten===!0){const r=dm(a);if(r.length<e)return r}return pm(a,{length:e})}return a}static buildColumnAlias({maxAliasLength:e},t,...n){return typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),a=i.indexOf("/"),r=a!==-1?i.substr(0,a):i;let o=a!==-1?i.substr(a+1):void 0;o&&o.indexOf("?")!==-1&&(o=o.substr(0,o.indexOf("?")));const c=r.lastIndexOf("@"),l=r.substr(0,c),u=r.substr(c+1);let d=l,p="";const h=l.indexOf(":");h!==-1&&(d=l.substr(0,h),p=l.substr(h+1));const[m,y]=u.split(":");return{type:t,host:m,username:decodeURIComponent(d),password:decodeURIComponent(p),port:y?parseInt(y):void 0,database:o||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),a=i.indexOf("/"),r=a!==-1?i.substr(0,a):i;let o=a!==-1?i.substr(a+1):void 0,c="",l,u,d,p,h={};if(o&&o.indexOf("?")!==-1){c=o.substr(o.indexOf("?")+1,o.length);const S=c.split("&");let C,Q;S.forEach(J=>{C=J.split("=")[0],Q=J.split("=")[1],h[C]=Q}),p=h.replicaSet,o=o.substr(0,o.indexOf("?"))}const m=r.lastIndexOf("@"),y=r.substr(0,m),f=r.substr(m+1);let g=y,b="";const v=y.indexOf(":");v!==-1&&(g=y.substr(0,v),b=y.substr(v+1)),p?d=f:[l,u]=f.split(":");let E={type:t,host:l,hostReplicaSet:d,username:decodeURIComponent(g),password:decodeURIComponent(b),port:u?parseInt(u):void 0,database:o||void 0};for(const[S,C]of Object.entries(h))E[S]=C;return E}}class Jo{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,n&&Me.assign(this,n)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(It.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(It.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!It.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new j(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new j("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new j("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?P.buildAlias(this.connection.driver,void 0,e,this.alias.name):P.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class La{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,Me.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!It.isAliasProperty(this.relationName))throw new j("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!It.isAliasProperty(this.relationName))throw new j("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!It.isAliasProperty(this.relationName))throw new j("Given value must be a string representation of alias property");const e=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new j(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return e}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Ba{constructor(e,t){this.expressionMap=e,Me.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!It.isAliasProperty(this.relationName))throw new j("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!It.isAliasProperty(this.relationName))throw new j("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!It.isAliasProperty(this.relationName))throw new j("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),n=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!n)throw new j(`Relation with property path ${t} in entity was not found.`);return n}get metadata(){if(!It.isAliasProperty(this.relationName))throw new j("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class Da{constructor(e){var t;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((t=e.options)==null?void 0:t.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const n=new $o;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){const t=this.aliases.find(n=>n.name===e);if(!t)throw new j(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new j("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new j(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new Da(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new $o(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Jo(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new La(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Ba(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class Ho{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class qa{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((n,i)=>i.from(n),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,i)=>i.to(n),t):e.to(t)}}class bn{constructor(e,t,n=!0,i=!1,a,r){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=i,this._getSql=a,this._objectLiteralParameters=r}get useParameter(){return me.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return me.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return me.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return me.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(me.isFindOperator(this._value))return this._value}get getSql(){return me.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof bn?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&qa.transformTo(e,t)):qa.transformTo(e,this._value)}}lo=function(s){return new bn("in",s,!0,!0)};const mm=/[.*+\-?^${}()|[\]\\]/g,fm=s=>s.replace(mm,"\\$&");class xe{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,me.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Da(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){xe.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new j("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(n=>({selection:n})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),me.isSelectQueryBuilder(this)?this:xe.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",me.isInsertQueryBuilder(this)?this:xe.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const n=t||e;if(e=me.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const i=this.createFromAlias(e);this.expressionMap.setMainAlias(i)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=n,me.isUpdateQueryBuilder(this)?this:xe.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",me.isDeleteQueryBuilder(this)?this:xe.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",me.isSoftDeleteQueryBuilder(this)?this:xe.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",me.isSoftDeleteQueryBuilder(this)?this:xe.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const n=arguments.length===2?e:void 0,i=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=i,n){const a=this.createFromAlias(n);this.expressionMap.setMainAlias(a)}return me.isRelationQueryBuilder(this)?this:xe.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!n.findRelationWithPropertyPath(i))}hasParameter(e){var t;return((t=this.parentQueryBuilder)==null?void 0:t.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new j(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new j("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const n=t.childEntityMetadatas.filter(i=>i.discriminatorColumn).map(i=>i.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new j('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){const a=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:a?void 0:e,subQuery:a?e:void 0})}const n=e(this.subQuery());this.setParameters(n.getParameters());const i=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:i})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const a of this.expressionMap.aliases){if(!a.hasMetadata)continue;const r=this.expressionMap.aliasNamePrefixingEnabled&&a.name?`${a.name}.`:"";t[r]||(t[r]={});for(const o of a.metadata.relations)o.joinColumns.length>0&&(t[r][o.propertyPath]=o.joinColumns[0].databaseName);for(const o of a.metadata.relations){const c=[...o.joinColumns,...o.inverseJoinColumns];for(const l of c){const u=`${o.propertyPath}.${l.referencedColumn.propertyPath}`;t[r][u]=l.databaseName}}for(const o of a.metadata.columns)t[r][o.databaseName]=o.databaseName;for(const o of a.metadata.columns)t[r][o.propertyName]=o.databaseName;for(const o of a.metadata.columns)t[r][o.propertyPath]=o.databaseName}const n=Object.keys(t),i=n.map(a=>fm(a)).join("|");return n.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${i?"("+i+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...a)=>{let r,o,c;if(i){if(r=a[0],o=a[1],c=a[3],t[a[2]][c])return`${o}${this.escape(a[2].substring(0,a[2].length-1))}.${this.escape(t[a[2]][c])}`}else if(r=a[0],o=a[1],c=a[2],t[""][c])return`${o}${this.escape(t[""][c])}`;return r})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const a=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName,r=`${this.replacePropertyNames(a)} IS NULL`;e.push(r)}if(i.discriminatorColumn&&i.parentEntityMetadata){const a=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName,r=`${this.replacePropertyNames(a)} IN (:...discriminatorColumnValues)`;e.push(r)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(i)}let n="";return n+=this.createTimeTravelQuery(),e.length?e.length===1?n+=` WHERE ${e[0]}`:n+=` WHERE ( ${e.join(" ) AND ( ")} )`:n+="",n}createReturningExpression(e){const t=this.getReturningColumns(),n=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(i=>t.indexOf(i)===-1)),t.length){let i=t.map(a=>{const r=this.escape(a.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+r:this.escape(this.getMainTableName())+"."+r:r}).join(", ");return n.options.type==="oracle"&&(i+=" INTO "+t.map(a=>this.createParameter({type:n.columnTypeToNativeParameter(a.type),dir:n.oracle.BIND_OUT})).join(", ")),n.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(i+=" INTO @OutputTable"),i}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{const i=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(n>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`}return i}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return n.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${bn.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(t=>{const n=typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.getQuery();if(typeof t.queryBuilder!="string"){if(t.queryBuilder.hasCommonTableExpressions())throw new j(`Nested CTEs aren't supported (CTE: ${t.alias})`);if(!this.connection.driver.cteCapabilities.writable&&!me.isSelectQueryBuilder(t.queryBuilder))throw new j(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${t.alias})`);this.setParameters(t.queryBuilder.getParameters())}let i=this.escape(t.alias);if(t.options.columnNames){const o=t.options.columnNames.map(c=>this.escape(c));if(me.isSelectQueryBuilder(t.queryBuilder)&&t.queryBuilder.expressionMap.selects.length&&t.options.columnNames.length!==t.queryBuilder.expressionMap.selects.length)throw new j(`cte.options.columnNames length (${t.options.columnNames.length}) doesn't match subquery select list length ${t.queryBuilder.expressionMap.selects.length} (CTE: ${t.alias})`);i+=`(${o.join(", ")})`}const a=t.options.recursive&&e?"RECURSIVE":"";let r="";return this.connection.driver.cteCapabilities.materializedHint&&t.options.materialized!==void 0&&(r=t.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[a,i,"AS",r,`(${n})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(i=>t.ensureEntityIdMap(i));if(!t.hasMultiplePrimaryKeys){const i=t.primaryColumns[0];if(!i.transformer&&!i.relationMetadata&&!i.embeddedMetadata)return{[i.propertyName]:lo(n.map(a=>i.getEntityValue(a,!1)))}}return new Ho(i=>{for(const a of n)i.orWhere(new Ho(r=>r.where(a)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const n=[],i=e.split(".");for(;i.length>1;){const o=i[0];if(!(t!=null&&t.hasMetadata))break;if(t.metadata.hasEmbeddedWithPropertyPath(o)){i.unshift(`${i.shift()}.${i.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(o)){const c=this.expressionMap.joinAttributes.find(l=>l.relationPropertyPath===o);if(!(c!=null&&c.alias)){const l=n.length>0?`${n.join(".")}.${o}`:o;throw new Error(`Cannot find alias for relation at ${l}`)}t=c.alias,n.push(...o.split(".")),i.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const a=i.join("."),r=t.metadata.findColumnsWithPropertyPath(a);if(!r.length)throw new jt(e,t.metadata);return[t,n,r]}createPropertyPath(e,t,n=""){const i=[];for(const a of Object.keys(t)){const r=n?`${n}.${a}`:a;if(t[a]===null||typeof t[a]!="object"||me.isFindOperator(t[a])){i.push(r);continue}if(e.hasEmbeddedWithPropertyPath(r)){const o=this.createPropertyPath(e,t[a],r);i.push(...o);continue}if(e.hasRelationWithPropertyPath(r)){const o=e.findRelationWithPropertyPath(r);if(o.relationType==="one-to-one"||o.relationType==="many-to-one"){const u=o.joinColumns.map(d=>d.referencedColumn).filter(d=>!!d);if(u.length>0&&u.every(d=>d.getEntityValue(t[a],!1))){i.push(r);continue}}if(o.relationType==="one-to-many"||o.relationType==="many-to-many")throw new Error(`Cannot query across ${o.relationType} for property ${r}`);const c=o.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(u=>u.getEntityValue(t[a],!1))){const u=c.map(d=>`${r}.${d.propertyPath}`);i.push(...u);continue}const l=this.createPropertyPath(o.inverseEntityMetadata,t[a]).map(u=>`${r}.${u}`);i.push(...l);continue}i.push(r)}return i}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const n of t){const[i,a,r]=this.findColumnsForPropertyPath(n);for(const o of r){let c=e;for(const d of a){if(!c||!(d in c)){c={};break}c=c[d]}const l=this.expressionMap.aliasNamePrefixingEnabled?`${i.name}.${o.propertyPath}`:o.propertyPath,u=o.getEntityValue(c,!0);yield[l,u]}}}else for(const t of Object.keys(e)){const n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){if(me.isFindOperator(t)){let n=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const i of t.value)n.push(this.createParameter(i));else n.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...n]};if(t.type==="and"){const i=t.value;return{operator:t.type,parameters:i.map(a=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,a)))}}else if(t.type==="or"){const i=t.value;return{operator:t.type,parameters:i.map(a=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,a)))}}else return{operator:t.type,parameters:[e,...n]}}else return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(me.isBrackets(e)){const i=this.createQueryBuilder();return i.parentQueryBuilder=this,i.expressionMap.mainAlias=this.expressionMap.mainAlias,i.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,i.expressionMap.parameters=this.expressionMap.parameters,i.expressionMap.nativeParameters=this.expressionMap.nativeParameters,i.expressionMap.wheres=[],e.whereFactory(i),{operator:me.isNotBrackets(e)?"not":"brackets",condition:i.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],n=[];for(const i of t){const a=[];for(const[r,o]of this.getPredicates(i))a.push({type:"and",condition:this.getWherePredicateCondition(r,o)});n.push({type:"or",condition:a})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}xe.queryBuilderRegistry={};class ym{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class gm extends xe{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const a=await n.query(e,t,!0),r=ym.from(a);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),i&&await n.commitTransaction(),r}catch(a){if(i)try{await n.rollbackTransaction()}catch{}throw a}finally{n!==this.queryRunner&&await n.release()}}from(e,t){e=me.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new ci;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),n=this.createReturningExpression("delete");return n===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${n}${t}`:`DELETE FROM ${e}${t} RETURNING ${n}`}}let li;const bm=new Uint8Array(16);function _m(){if(!li&&(li=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!li))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return li(bm)}const Be=[];for(let s=0;s<256;++s)Be.push((s+256).toString(16).slice(1));function vm(s,e=0){return Be[s[e+0]]+Be[s[e+1]]+Be[s[e+2]]+Be[s[e+3]]+"-"+Be[s[e+4]]+Be[s[e+5]]+"-"+Be[s[e+6]]+Be[s[e+7]]+"-"+Be[s[e+8]]+Be[s[e+9]]+"-"+Be[s[e+10]]+Be[s[e+11]]+Be[s[e+12]]+Be[s[e+13]]+Be[s[e+14]]+Be[s[e+15]]}const wm=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Go={randomUUID:wm};function xm(s,e,t){if(Go.randomUUID&&!e&&!s)return Go.randomUUID();s=s||{};const n=s.random||(s.rng||_m)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,vm(n)}class Xo{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class Yo{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Fa{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(i,a)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,l,u)=>(c[this.expressionMap.extraReturningColumns[u].databaseName]=l[0],c),{}));const r=Array.isArray(e.raw)?e.raw[a]:e.raw,o=this.queryRunner.connection.driver.createGeneratedMap(n,r);o&&(this.queryRunner.manager.merge(n.target,i,o),e.generatedMaps.push(o))}else{const r=this.expressionMap.extraReturningColumns;if(r.length>0){const o=this.expressionMap.mainAlias.metadata.getEntityIdMap(i);if(!o)throw new j("Cannot update entity because entity id is not set in the entity.");const c=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(l=>n.targetName+"."+l.propertyPath)).addSelect(r.map(l=>n.targetName+"."+l.propertyPath)).from(n.target,n.targetName).where(o).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(n.target,i,c),e.generatedMaps.push(c))}}}))}async insert(e,t){const n=this.expressionMap.mainAlias.metadata;let i=n.getInsertionReturningColumns();const a=this.queryRunner.connection.driver.isReturningSqlSupported("insert");i=i.filter(o=>o.isGenerated?a===!0:!0);const r=t.map((o,c)=>{this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((d,p,h)=>(d[this.expressionMap.extraReturningColumns[h].databaseName]=p[0],d),{}));const l=Array.isArray(e.raw)?e.raw[c]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(n,l,c,t.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,u,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(n.target,o,u),u});if(i.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const o=t.map(l=>{const u=n.getEntityIdMap(l);if(!u)throw new j("Cannot update entity because entity id is not set in the entity.");return u}),c=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(l=>n.targetName+"."+l.propertyPath)).addSelect(i.map(l=>n.targetName+"."+l.propertyPath)).from(n.target,n.targetName).where(o).setOption("create-pojo").getMany();t.forEach((l,u)=>{this.queryRunner.manager.merge(n.target,r[u],c[u]),this.queryRunner.manager.merge(n.target,l,c[u])})}t.forEach((o,c)=>{const l=n.getEntityIdMap(o);e.identifiers.push(l),e.generatedMaps.push(r[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class Om extends xe{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new Yo;const t=this.obtainQueryRunner();let n=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const h=new Xo;e.forEach(m=>{t.broadcaster.broadcastBeforeInsertEvent(h,this.expressionMap.mainAlias.metadata,m)}),await h.wait()}let i=null,a=null;const r=new Fa(t,this.expressionMap),o=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)o.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),o.push(...this.expressionMap.extraReturningColumns.filter(h=>!o.includes(h)))),o.length>0&&this.connection.driver.options.type==="mssql"&&(i=this.connection.driver.buildTableVariableDeclaration("@OutputTable",o),a="SELECT * FROM @OutputTable");const[c,l]=this.getQueryAndParameters(),u=[i,c,a].filter(h=>h!=null).join(`;

`),d=await t.query(u,l,!0),p=Yo.from(d);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.insert(p,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const h=new Xo;e.forEach(m=>{t.broadcaster.broadcastAfterInsertEvent(h,this.expressionMap.mainAlias.metadata,m)}),await h.wait()}return n&&await t.commitTransaction(),p}catch(i){if(n)try{await t.rollbackTransaction()}catch{}throw i}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=me.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e);return this.expressionMap.setMainAlias(n),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new ci;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,n){return Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,indexPredicate:n==null?void 0:n.indexPredicate,upsertType:n==null?void 0:n.upsertType},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,upsertType:n==null?void 0:n.upsertType},this)}createInsertExpression(){var r,o;const e=this.getTableName(this.getMainTableName()),t=this.createValuesExpression(),n=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression();let a="INSERT ";if(((r=this.expressionMap.onUpdate)==null?void 0:r.upsertType)==="primary-key"&&(a="UPSERT "),(P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),a+=`INTO ${e}`,this.alias!==this.getMainTableName()&&P.isPostgresFamily(this.connection.driver)&&(a+=` AS "${this.alias}"`),i?a+=`(${i})`:!t&&(P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+="()"),n&&this.connection.driver.options.type==="mssql"&&(a+=` OUTPUT ${n}`),t?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?a+=` ${t}`:a+=` VALUES ${t}`:P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?a+=" VALUES ()":a+=" DEFAULT VALUES",((o=this.expressionMap.onUpdate)==null?void 0:o.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)a+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)a+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:c,columns:l,conflict:u,skipUpdateIfNoValuesChanged:d,indexPredicate:p}=this.expressionMap.onUpdate;let h="ON CONFLICT";if(Array.isArray(u)){if(h+=` ( ${u.map(y=>this.escape(y)).join(", ")} )`,p&&!P.isPostgresFamily(this.connection.driver))throw new j("indexPredicate option is not supported by the current database driver");p&&P.isPostgresFamily(this.connection.driver)&&(h+=` WHERE ( ${p} )`)}else u&&(h+=` ON CONSTRAINT ${this.escape(u)}`);const m=[];Array.isArray(c)?m.push(...c.map(y=>`${this.escape(y)} = EXCLUDED.${this.escape(y)}`)):l&&m.push(...l.map(y=>`${this.escape(y)} = :${y}`)),m.length>0&&(a+=` ${h} DO UPDATE SET `,m.push(...this.expressionMap.mainAlias.metadata.columns.filter(y=>y.isUpdateDate&&!(c!=null&&c.includes(y.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||P.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(y=>`${this.escape(y.databaseName)} = DEFAULT`)),a+=m.join(", "),a+=" "),Array.isArray(c)&&d&&P.isPostgresFamily(this.connection.driver)&&(a+=" WHERE (",a+=c.map(y=>`${e}.${this.escape(y)} IS DISTINCT FROM EXCLUDED.${this.escape(y)}`).join(" OR "),a+=") ")}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:c,columns:l}=this.expressionMap.onUpdate;Array.isArray(c)?(a+=" ON DUPLICATE KEY UPDATE ",a+=c.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),a+=" "):Array.isArray(l)&&(a+=" ON DUPLICATE KEY UPDATE ",a+=l.map(u=>`${this.escape(u)} = :${u}`).join(", "),a+=" ")}}else if(this.expressionMap.onUpdate)throw new j("onUpdate is not supported by the current database driver")}return n&&(P.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||P.isMySQLFamily(this.connection.driver))&&(a+=` RETURNING ${n}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(c=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(c.propertyPath)!==-1:c.isInsert).some(c=>this.isOverridingAutoIncrementBehavior(c))&&(a=`SET IDENTITY_INSERT ${e} ON; ${a}; SET IDENTITY_INSERT ${e} OFF`),a}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!P.isSQLiteFamily(this.connection.driver)&&!P.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(n=>this.escape(n)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let n="";return e.forEach((i,a)=>{t.forEach((r,o)=>{o===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?n+=" SELECT ":n+="(");let c=r.getEntityValue(i);if(typeof c!="function"&&(c=this.connection.driver.preparePersistentValue(c,r)),r.isVersion&&c===void 0)n+="1";else if(r.isDiscriminator)n+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(r.isGenerated&&r.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&c===void 0)c=xm(),n+=this.createParameter(c),a in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[a]={}),r.setEntityValue(this.expressionMap.locallyGenerated[a],c);else if(c===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||P.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r.default!==void 0&&r.default!==null?n+=this.connection.driver.normalizeDefault(r):n+="NULL":n+="DEFAULT";else if(c===null&&this.connection.driver.options.type==="spanner")n+="NULL";else if(typeof c=="function")n+=c();else{this.connection.driver.options.type==="mssql"&&(c=this.connection.driver.parametrizeValue(r,c));const l=this.createParameter(c);if((P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1){const u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";r.srid!=null?n+=`${u}(${l}, ${r.srid})`:n+=`${u}(${l})`}else P.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1?r.srid!=null?n+=`ST_SetSRID(ST_GeomFromGeoJSON(${l}), ${r.srid})::${r.type}`:n+=`ST_GeomFromGeoJSON(${l})::${r.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1?n+=r.type+"::STGeomFromText("+l+", "+(r.srid||"0")+")":n+=l}o===t.length-1?a===e.length-1?this.connection.driver.options.type==="oracle"&&e.length>1?n+=" FROM DUAL ":this.connection.driver.options.type==="sap"&&e.length>1?n+=" FROM dummy ":n+=")":this.connection.driver.options.type==="oracle"&&e.length>1?n+=" FROM DUAL UNION ALL ":this.connection.driver.options.type==="sap"&&e.length>1?n+=" FROM dummy UNION ALL ":n+="), ":n+=", "})}),n==="()"?"":n}else{let n="";return e.forEach((i,a)=>{Object.keys(i).forEach((r,o)=>{o===0&&(n+="(");const c=i[r];typeof c=="function"?n+=c():c===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||P.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n+="NULL":n+="DEFAULT":c===null&&this.connection.driver.options.type==="spanner"||(n+=this.createParameter(c)),o===Object.keys(i).length-1?a===e.length-1?n+=")":n+="), ":n+=", "})}),n==="()"?"":n}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(Me.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new em}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}}class ec{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const n=t.joinColumns.reduce((i,a)=>{const r=Me.isObject(e)?a.referencedColumn.getEntityValue(e):e;return a.setEntityValue(i,r),i},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const n={};t.inverseRelation.joinColumns.forEach(c=>{n[c.propertyName]=null});const i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a={},r=[];i.forEach((c,l)=>{t.inverseRelation.joinColumns.map((u,d)=>{const p="joinColumn_"+l+"_"+d;a[p]=Me.isObject(c)?u.referencedColumn.getEntityValue(c):c,r.push(`${u.propertyPath} = :${p}`)})});const o=r.map(c=>"("+c+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(o).setParameters(a).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new j("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const n=this.expressionMap.of,i=t.inverseRelation.joinColumns.reduce((a,r)=>{const o=Me.isObject(n)?r.referencedColumn.getEntityValue(n):n;return r.setEntityValue(a,o),a},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).whereInIds(e).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?i:a,o=t.isManyToManyOwner?a:i,c=[];if(r.forEach(l=>{o.forEach(u=>{const d={};n.ownerColumns.forEach(p=>{d[p.databaseName]=Me.isObject(l)?p.referencedColumn.getEntityValue(l):l}),n.inverseColumns.forEach(p=>{d[p.databaseName]=Me.isObject(u)?p.referencedColumn.getEntityValue(u):u}),c.push(d)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(l=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(l).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(c).execute()}}}class Em{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],a={};t.inverseRelation.joinColumns.forEach(l=>{a[l.propertyName]=null});const r={},o=[];n.forEach((l,u)=>{o.push(...i.map((d,p)=>[...t.inverseRelation.joinColumns.map((h,m)=>{const y="joinColumn_"+u+"_"+p+"_"+m;return r[y]=Me.isObject(l)?h.referencedColumn.getEntityValue(l):l,`${h.propertyPath} = :${y}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((h,m)=>{const y="primaryColumn_"+p+"_"+p+"_"+m;return r[y]=Me.isObject(d)?h.getEntityValue(d):d,`${h.propertyPath} = :${y}`})].join(" AND ")))});const c=o.map(l=>"("+l+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(a).where(c).setParameters(r).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?i:a,o=t.isManyToManyOwner?a:i,c={},l=[];r.forEach((d,p)=>{l.push(...o.map((h,m)=>[...n.ownerColumns.map((y,f)=>{const g="firstValue_"+p+"_"+m+"_"+f;return c[g]=Me.isObject(d)?y.referencedColumn.getEntityValue(d):d,`${y.databaseName} = :${g}`}),...n.inverseColumns.map((y,f)=>{const g="secondValue_"+p+"_"+m+"_"+f;return c[g]=Me.isObject(h)?y.referencedColumn.getEntityValue(h):h,`${y.databaseName} = :${g}`})].join(" AND ")))});const u=l.map(d=>"("+d+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(u).setParameters(c).execute()}}}class Mm extends xe{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new j("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new j(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Me.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new j('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new ec(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new j("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new j(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Me.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new j('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new ec(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new j("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new j(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new Em(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!Me.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new j("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class De{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,i)=>e.slice(i*t,i*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,i)=>{const a=t(i);let r=n.find(o=>o.id===a);return r||(r={id:a,items:[]},n.push(r)),r.items.push(i),n},[])}static uniq(e,t){return e.reduce((n,i)=>{let a=!1;if(typeof t=="function"){const r=t(i);a=!!n.find(o=>t(o)===r)}else typeof t=="string"?a=!!n.find(r=>r[t]===i[t]):a=n.indexOf(i)!==-1;return a||n.push(i),n},[])}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,i){if(i.has(n)){e[t]=i.get(n);return}if(!(n instanceof Promise)){if(!this.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),i.set(n,e[t]),this.merge(e[t],n,i),i.delete(n)}}static mergeObjectKey(e,t,n,i){if(i.has(n)){Object.assign(e,{[t]:i.get(n)});return}if(!(n instanceof Promise)){if(!this.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),i.set(n,e[t]),this.merge(e[t],n,i),i.delete(n)}}static merge(e,t,n=new Map){if(this.isPlainObject(e)&&this.isPlainObject(t))for(const i of Object.keys(t))i!=="__proto__"&&this.mergeObjectKey(e,i,t[i],n);if(Array.isArray(e)&&Array.isArray(t))for(let i=0;i<t.length;i++)this.mergeArrayKey(e,i,t[i],n)}static mergeDeep(e,...t){if(!t.length)return e;for(const n of t)De.merge(e,n);return e}static deepCompare(...e){let t,n,i,a;if(arguments.length<1)return!0;for(t=1,n=arguments.length;t<n;t++)if(i=[],a=[],!this.compare2Objects(i,a,arguments[0],arguments[t]))return!1;return!0}static deepValue(e,t){const n=t.split(".");for(let i=0,a=n.length;i<a;i++)e=e[n[i]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:this.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let n of e){const i=n.split(".");if(!i.length)continue;(!t[i[0]]||t[i[0]]===!0)&&(t[i[0]]={});let a=t[i[0]];for(let[r,o]of i.entries())r!==0&&(a[o]?a=a[o]:r===i.length-1?(a[o]={},a=null):(a[o]={},a=a[o]))}return this.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:De.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static zipObject(e,t){return e.reduce((n,i,a)=>(n[i]=t[a],n),{})}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.indexOf(n)!==-1)}static areMutuallyExclusive(...e){return!e.some(t=>{const n=e.filter(i=>i!==t);return t.some(i=>n.some(a=>a.includes(i)))})}static parseSqlCheckExpression(e,t){const n=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(n&&n.index){const i=e.substring(n.index+n[0].length);let a="",r="";const o=[];for(let c=0;c<i.length;c++){const l=i[c];switch(l){case",":a==""?(o.push(r),r=""):r+=l;break;case"'":a==l?i[c+1]===l?(r+=l,c+=1):a="":a=l;break;case")":if(a=="")return o.push(r),o;r+=l;break;default:a!=""&&(r+=l)}}}}static compare2Objects(e,t,n,i){let a;if(Number.isNaN(n)&&Number.isNaN(i)||n===i)return!0;if(n===null||i===null||n===void 0||i===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(i))return!0;if(typeof n=="function"&&typeof i=="function"||n instanceof Date&&i instanceof Date||n instanceof RegExp&&i instanceof RegExp||typeof n=="string"&&typeof i=="string"||typeof n=="number"&&typeof i=="number")return n.toString()===i.toString();if(!(typeof n=="object"&&typeof i=="object")||Object.prototype.isPrototypeOf.call(n,i)||Object.prototype.isPrototypeOf.call(i,n)||n.constructor!==i.constructor||n.prototype!==i.prototype||e.indexOf(n)>-1||t.indexOf(i)>-1)return!1;for(a in i)if(i.hasOwnProperty(a)!==n.hasOwnProperty(a)||typeof i[a]!=typeof n[a])return!1;for(a in n){if(i.hasOwnProperty(a)!==n.hasOwnProperty(a)||typeof i[a]!=typeof n[a])return!1;switch(typeof n[a]){case"object":case"function":if(e.push(n),t.push(i),!this.compare2Objects(e,t,n[a],i[a]))return!1;e.pop(),t.pop();break;default:if(n[a]!==i[a])return!1;break}}return!0}}class km{constructor(e,t,n,i,a){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=i,this.queryRunner=a}transform(e,t){const n=this.group(e,t),i=[];return n.forEach(a=>{const r=this.transformRawResultsGroup(a,t);r!==void 0&&!Object.values(r).every(o=>o===null)&&i.push(r)}),i}group(e,t){const n=new Map,i=[];return t.metadata.tableType==="view"?i.push(...t.metadata.columns.map(a=>P.buildAlias(this.driver,void 0,t.name,a.databaseName))):i.push(...t.metadata.primaryColumns.map(a=>P.buildAlias(this.driver,void 0,t.name,a.databaseName))),e.forEach(a=>{const r=i.map(c=>{const l=a[c];return it.isBuffer(l)?l.toString("hex"):Me.isObject(l)?JSON.stringify(l):l}).join("_"),o=n.get(r);o?o.push(a):n.set(r,[a])}),n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){const l=e.map(d=>d[P.buildAlias(this.driver,void 0,t.name,t.metadata.discriminatorColumn.databaseName)]),u=n.childEntityMetadatas.find(d=>typeof l.find(p=>p===d.discriminatorValue)<"u");u&&(n=u)}let i=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.expressionMap.options.indexOf("create-pojo")!==-1});const a=this.transformColumns(e,t,i,n),r=this.transformJoins(e,i,t,n),o=this.transformRelationIds(e,t,i,n),c=this.transformRelationCounts(e,t,i);if(a||n.primaryColumns.filter(l=>l.isVirtual===!1).length===0&&(r||o||c))return i}transformColumns(e,t,n,i){let a=!1;return i.columns.forEach(r=>{if(i.childEntityMetadatas.length>0&&i.childEntityMetadatas.findIndex(c=>c.target===r.target)!==-1)return;const o=e[0][P.buildAlias(this.driver,void 0,t.name,r.databaseName)];o===void 0||r.isVirtual||this.expressionMap.selects.find(c=>c.selection===t.name||c.selection===t.name+"."+r.propertyPath)&&(r.setEntityValue(n,this.driver.prepareHydratedValue(o,r)),o!==null&&(a=!0))}),a}transformJoins(e,t,n,i){let a=!1;return this.expressionMap.joinAttributes.forEach(r=>{if(!r.metadata||!r.isSelected||r.relation&&!i.relations.find(c=>c===r.relation))return;if(r.mapToProperty){if(r.mapToPropertyParentAlias!==n.name)return}else if(!r.relation||r.parentAlias!==n.name||r.relationPropertyPath!==r.relation.propertyPath)return;let o=this.transform(e,r.alias);o=r.isMany?o:o[0],o=!r.isMany&&o===void 0?null:o,o!==void 0&&(r.mapToPropertyPropertyName?t[r.mapToPropertyPropertyName]=o:r.relation.setEntityValue(t,o),a=!0)}),a}transformRelationIds(e,t,n,i){let a=!1;return this.rawRelationIdResults.forEach((r,o)=>{if(r.relationIdAttribute.parentAlias!==t.name)return;const c=r.relationIdAttribute.relation,l=this.createValueMapFromJoinColumns(c,r.relationIdAttribute.parentAlias,e);if(l==null)return;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(c,l),d=this.relationIdMaps[o][u]||[],p=r.relationIdAttribute.mapToPropertyPropertyPath.split("."),h=(m,y,f)=>{const g=m.shift();if(g&&m.length===0)return y[g]=f,y;if(g&&m.length>0)h(m,y[g],f);else return y};c.isOneToOne||c.isManyToOne?d[0]!==void 0&&(h(p,n,d[0]),a=!0):(h(p,n,d),a=a||d.length>0)}),a}transformRelationCounts(e,t,n){let i=!1;return this.rawRelationCountResults.filter(a=>a.relationCountAttribute.parentAlias===t.name).forEach(a=>{const r=a.relationCountAttribute.relation;let o;r.isOneToMany?o=r.inverseRelation.joinColumns[0].referencedColumn.databaseName:o=r.isOwning?r.joinColumns[0].referencedColumn.databaseName:r.inverseRelation.joinColumns[0].referencedColumn.databaseName;const c=e[0][P.buildAlias(this.driver,void 0,t.name,o)];c!=null&&(n[a.relationCountAttribute.mapToPropertyPropertyName]=0,a.results.filter(l=>l.parentId===c).forEach(l=>{n[a.relationCountAttribute.mapToPropertyPropertyName]=parseInt(l.cnt),i=!0}))}),i}createValueMapFromJoinColumns(e,t,n){let i;return e.isManyToOne||e.isOneToOneOwner?i=e.entityMetadata.primaryColumns.map(a=>a):e.isOneToMany||e.isOneToOneNotOwner?i=e.inverseRelation.joinColumns.map(a=>a):e.isOwning?i=e.joinColumns.map(a=>a):i=e.inverseRelation.inverseJoinColumns.map(a=>a),i.reduce((a,r)=>(n.forEach(o=>{e.isManyToOne||e.isOneToOneOwner?a[r.databaseName]=this.driver.prepareHydratedValue(o[P.buildAlias(this.driver,void 0,t,r.databaseName)],r):a[r.databaseName]=this.driver.prepareHydratedValue(o[P.buildAlias(this.driver,void 0,t,r.referencedColumn.databaseName)],r.referencedColumn)}),a),{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?n=e.joinColumns.map(i=>i):n=e.inverseRelation.inverseJoinColumns.map(i=>i),n.reduce((i,a)=>(i[a.databaseName]=t[a.databaseName],i),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((i,a)=>{let r=n.reduce((o,c)=>{let l=a[c.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(l=c.referencedColumn.createValueMap(l)),De.mergeDeep(o,c.createValueMap(l))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(l=c.referencedColumn.referencedColumn.createValueMap(l)),De.mergeDeep(o,c.referencedColumn.createValueMap(l)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?r=n[0].getEntityValue(r):r=n[0].referencedColumn.getEntityValue(r)),r!==void 0){const o=this.hashEntityIds(t,a);i[o]?i[o].push(r):i[o]=[r]}return i},{})}))}hashEntityIds(e,t){const n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}}let Cm=class{constructor(s,e,t){this.connection=s,this.queryRunner=e,this.relationIdAttributes=t}async load(s){const e=this.relationIdAttributes.map(async t=>{if(t.relation.isManyToOne||t.relation.isOneToOneOwner){if(t.queryBuilderFactory)throw new j("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const n={},i=s.map(a=>{const r={},o=[];t.relation.joinColumns.forEach(l=>{r[l.databaseName]=this.connection.driver.prepareHydratedValue(a[P.buildAlias(this.connection.driver,void 0,t.parentAlias,l.databaseName)],l.referencedColumn);const u=`${l.databaseName}:${r[l.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),t.relation.entityMetadata.primaryColumns.forEach(l=>{r[l.databaseName]=this.connection.driver.prepareHydratedValue(a[P.buildAlias(this.connection.driver,void 0,t.parentAlias,l.databaseName)],l);const u=`${l.databaseName}:${r[l.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),o.sort();const c=o.join("::");return n[c]?null:(n[c]=!0,r)}).filter(a=>a);return{relationIdAttribute:t,results:i}}else if(t.relation.isOneToMany||t.relation.isOneToOneNotOwner){const n=t.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.joinColumns,a=n.inverseEntityMetadata.target,r=n.inverseEntityMetadata.tableName,o=t.alias||r,c={},l={},u=s.map((h,m)=>{const y=[],f={},g=i.map(v=>{const E=v.databaseName+m,S=h[P.buildAlias(this.connection.driver,void 0,t.parentAlias,v.referencedColumn.databaseName)],C=`${o}:${v.propertyPath}:${S}`;return y.indexOf(C)!==-1?"":(y.push(C),f[E]=S,o+"."+v.propertyPath+" = :"+E)}).filter(v=>v).join(" AND ");y.sort();const b=y.join("::");return c[b]?"":(c[b]=!0,Object.assign(l,f),g)}).filter(h=>h).map(h=>"("+h+")").join(" OR ");if(!u)return{relationIdAttribute:t,results:[]};const d=this.connection.createQueryBuilder(this.queryRunner);De.uniq([...i,...n.inverseRelation.entityMetadata.primaryColumns],h=>h.propertyPath).forEach(h=>{d.addSelect(o+"."+h.propertyPath,h.databaseName)}),d.from(a,o).where("("+u+")").setParameters(l),t.queryBuilderFactory&&t.queryBuilderFactory(d);const p=await d.getRawMany();return p.forEach(h=>{i.forEach(m=>{h[m.databaseName]=this.connection.driver.prepareHydratedValue(h[m.databaseName],m.referencedColumn)}),n.inverseRelation.entityMetadata.primaryColumns.forEach(m=>{h[m.databaseName]=this.connection.driver.prepareHydratedValue(h[m.databaseName],m)})}),{relationIdAttribute:t,results:p}}else{const n=t.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.inverseJoinColumns,a=n.isOwning?n.inverseJoinColumns:n.inverseRelation.joinColumns,r=t.junctionAlias,o=t.joinInverseSideMetadata.tableName,c=t.alias||o,l=n.isOwning?n.junctionEntityMetadata.tableName:n.inverseRelation.junctionEntityMetadata.tableName,u=s.map(b=>i.reduce((v,E)=>(v[E.propertyPath]=b[P.buildAlias(this.connection.driver,void 0,t.parentAlias,E.referencedColumn.databaseName)],v),{}));if(u.length===0)return{relationIdAttribute:t,results:[]};const d={},p={},h=u.map((b,v)=>{const E=[],S={},C=Object.keys(b).map(J=>{const W=J+v,q=b[J],pe=`${r}:${J}:${q}`;return E.indexOf(pe)!==-1?"":(E.push(pe),S[W]=q,r+"."+J+" = :"+W)}).filter(J=>J).join(" AND ");E.sort();const Q=E.join("::");return p[Q]?"":(p[Q]=!0,Object.assign(d,S),C)}).filter(b=>b),m=a.map(b=>r+"."+b.propertyPath+" = "+c+"."+b.referencedColumn.propertyPath).join(" AND "),y=h.map(b=>"("+b+" AND "+m+")").join(" OR "),f=this.connection.createQueryBuilder(this.queryRunner);a.forEach(b=>{f.addSelect(r+"."+b.propertyPath,b.databaseName).addOrderBy(r+"."+b.propertyPath)}),i.forEach(b=>{f.addSelect(r+"."+b.propertyPath,b.databaseName).addOrderBy(r+"."+b.propertyPath)}),f.from(o,c).innerJoin(l,r,y).setParameters(d),t.queryBuilderFactory&&t.queryBuilderFactory(f);const g=await f.getRawMany();return g.forEach(b=>{[...i,...a].forEach(v=>{b[v.databaseName]=this.connection.driver.prepareHydratedValue(b[v.databaseName],v.referencedColumn)})}),{relationIdAttribute:t,results:g}}});return Promise.all(e)}};class Am{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,n){const i=Array.isArray(t)?t:[t],a=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,i,a):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,i,a):this.loadForOneToManyAndOneToOneNotOwner(e,i,a)}async loadManyToManyRelationIdsAndGroup(e,t,n,i){const a=e.isManyToMany||e.isOneToMany,r=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,this.queryRunner,i),!n.length))return r.map(d=>({entity:d,related:a?[]:void 0}));const o=await this.load(e,t,n),c=Array.isArray(n)?n:[n];let l=[],u=[];return e.isManyToManyOwner?(l=e.junctionEntityMetadata.inverseColumns.map(d=>d.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(d=>d.referencedColumn)):e.isManyToManyNotOwner?(l=e.junctionEntityMetadata.ownerColumns.map(d=>d.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(d=>d.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(l=e.joinColumns.map(d=>d.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(l=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(d=>d.referencedColumn)),r.map(d=>{const p={entity:d,related:a?[]:void 0},h=o.filter(m=>u.every(y=>y.compareEntityValue(d,m[y.entityMetadata.name+"_"+y.propertyAliasName])));return h.length&&c.forEach(m=>{h.forEach(y=>{l.every(f=>f.compareEntityValue(m,y[P.buildAlias(this.connection.driver,void 0,f.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+f.propertyPath.replace(".","_"))]))&&(a?p.related.push(m):p.related=m)})}),p})}loadForManyToMany(e,t,n){const i=e.junctionEntityMetadata,a=i.name,r=e.isOwning?i.ownerColumns:i.inverseColumns,o=e.isOwning?i.inverseColumns:i.ownerColumns,c=this.connection.createQueryBuilder(this.queryRunner);r.forEach(p=>{const h=P.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(a+"."+p.propertyPath,h)}),o.forEach(p=>{const h=P.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(a+"."+p.propertyPath,h)});let l="";if(r.length===1){const p=t.map(h=>r[0].referencedColumn.getEntityValue(h));p.every(h=>typeof h=="number")?l=`${a}.${r[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values1",p),l=a+"."+r[0].propertyPath+" IN (:...values1)")}else l="("+t.map((p,h)=>r.map(m=>{const y="entity1_"+h+"_"+m.propertyName;return c.setParameter(y,m.referencedColumn.getEntityValue(p)),a+"."+m.propertyPath+" = :"+y}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";let u="";if(n)if(o.length===1){const p=n.map(h=>o[0].referencedColumn.getEntityValue(h));p.every(h=>typeof h=="number")?u=`${a}.${o[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values2",p),u=a+"."+o[0].propertyPath+" IN (:...values2)")}else u="("+n.map((p,h)=>o.map(m=>{const y="entity2_"+h+"_"+m.propertyName;return c.setParameter(y,m.referencedColumn.getEntityValue(p)),a+"."+m.propertyPath+" = :"+y}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";const d=[l,u].filter(p=>p.length>0).join(" AND ");return c.from(i.target,a).where(d).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){const i=e.entityMetadata.targetName,a=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(l=>l===c));if(n&&a){let c=[];if(t.forEach(l=>{let u={};e.entityMetadata.primaryColumns.forEach(d=>{const p=d.entityMetadata.name+"_"+d.propertyPath.replace(".","_");u[p]=d.getEntityValue(l)}),n.forEach(d=>{e.joinColumns.forEach(p=>{const h=p.getEntityValue(l),m=p.referencedColumn.getEntityValue(d);if(!(h===void 0||m===void 0)&&h===m){const y=p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_");u[y]=m}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(u)}),c.length===t.length)return Promise.resolve(c)}const r=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{const l=P.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));r.addSelect(i+"."+c.propertyPath,l)}),e.joinColumns.forEach(c=>{const l=P.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));r.addSelect(i+"."+c.propertyPath,l)});let o="";if(e.entityMetadata.primaryColumns.length===1){const c=t.map(l=>e.entityMetadata.primaryColumns[0].getEntityValue(l));c.every(l=>typeof l=="number")?o=`${i}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(r.setParameter("values",c),o=i+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else o=t.map((c,l)=>e.entityMetadata.primaryColumns.map((u,d)=>{const p="entity"+l+"_"+d;return r.setParameter(p,u.getEntityValue(c)),i+"."+u.propertyPath+" = :"+p}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return r.from(e.entityMetadata.target,i).where(o).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(o=>e.joinColumns.indexOf(o)!==-1))return Promise.resolve(t.map(o=>{const c={};return e.joinColumns.forEach(function(l){const u=l.referencedColumn.getEntityValue(o),d=l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"),p=l.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_");c[d]=u,c[p]=u}),c}));const i=e.entityMetadata.targetName,a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=P.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));a.addSelect(i+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=P.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));a.addSelect(i+"."+o.propertyPath,c)});let r="";if(e.joinColumns.length===1){const o=t.map(c=>e.joinColumns[0].referencedColumn.getEntityValue(c));o.every(c=>typeof c=="number")?r=`${i}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(a.setParameter("values",o),r=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else r=t.map((o,c)=>e.joinColumns.map((l,u)=>{const d="entity"+c+"_"+u;return a.setParameter(d,l.referencedColumn.getEntityValue(o)),i+"."+l.propertyPath+" = :"+d}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return a.from(e.entityMetadata.target,i).where(r).getRawMany()}}class Sm{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new La(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Tm{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){const t=(i,a,r)=>r.indexOf(i)===a,n=this.relationCountAttributes.map(async i=>{if(i.relation.isOneToMany){const a=i.relation,r=a.inverseRelation,o=r.joinColumns[0].referencedColumn.propertyName,c=a.inverseEntityMetadata.target,l=a.inverseEntityMetadata.tableName,u=i.alias||l,d=r.propertyName;let p=e.map(m=>m[i.parentAlias+"_"+o]).filter(m=>!!m);if(p=p.filter(t),p.length===0)return{relationCountAttribute:i,results:[]};const h=this.connection.createQueryBuilder(this.queryRunner);return h.select(u+"."+d,"parentId").addSelect("COUNT(*)","cnt").from(c,u).where(u+"."+d+" IN (:...ids)").addGroupBy(u+"."+d).setParameter("ids",p),i.queryBuilderFactory&&i.queryBuilderFactory(h),{relationCountAttribute:i,results:await h.getRawMany()}}else{let a,r,o,c;i.relation.isOwning?(a=i.relation.joinColumns[0].referencedColumn.databaseName,r=i.relation.inverseJoinColumns[0].referencedColumn.databaseName,o=i.relation.junctionEntityMetadata.columns[0],c=i.relation.junctionEntityMetadata.columns[1]):(a=i.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,r=i.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,o=i.relation.junctionEntityMetadata.columns[1],c=i.relation.junctionEntityMetadata.columns[0]);let l=e.map(f=>f[i.parentAlias+"_"+a]).filter(f=>!!f);if(l=l.filter(t),l.length===0)return{relationCountAttribute:i,results:[]};const u=i.junctionAlias,d=i.joinInverseSideMetadata.tableName,p=i.alias||d,h=i.relation.junctionEntityMetadata.tableName,m=u+"."+o.propertyName+" IN ("+l.map(f=>isNaN(f)?"'"+f+"'":f)+") AND "+u+"."+c.propertyName+" = "+p+"."+r,y=this.connection.createQueryBuilder(this.queryRunner);return y.select(u+"."+o.propertyName,"parentId").addSelect("COUNT("+y.escape(p)+"."+y.escape(r)+")","cnt").from(d,p).innerJoin(h,u,m).addGroupBy(u+"."+o.propertyName),i.queryBuilderFactory&&i.queryBuilderFactory(y),{relationCountAttribute:i,results:await y.getRawMany()}}});return Promise.all(n)}}class Pm{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new Ba(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Ua{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t!=null&&t.relations){const n=[...t.relations];if(Ua.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new tm(n)}return e}static applyRelationsRecursively(e,t,n,i,a){let r=[];if(a){const o=new RegExp("^"+a.replace(".","\\.")+"\\.");r=t.filter(c=>c.match(o)).map(c=>i.findRelationWithPropertyPath(c.replace(o,""))).filter(c=>c)}else r=t.map(o=>i.findRelationWithPropertyPath(o)).filter(o=>o);r.forEach(o=>{let c=P.buildAlias(e.connection.driver,{joiner:"__"},n,o.propertyPath);const l=n+"."+o.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(o):e.leftJoinAndSelect(l,c),t.splice(t.indexOf(a?a+"."+o.propertyPath:o.propertyPath),1);let u,d;if(e.expressionMap.relationLoadStrategy==="query")u=o.inverseEntityMetadata,d=c;else{const p=e.expressionMap.joinAttributes.find(h=>h.entityOrProperty===l);u=p.metadata,d=p.alias.name}if(!d||!u)throw new jt(o.propertyPath,i);if(this.applyRelationsRecursively(e,t,d,u,a?a+"."+o.propertyPath:o.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const p=i.relations.find(h=>h.propertyName===o.propertyPath);p&&this.joinEagerRelations(e,c,p.inverseEntityMetadata)}})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(i=>{let a=P.buildAlias(e.connection.driver,{joiner:"__"},t,i.propertyName),r=!0;for(const l of e.expressionMap.joinAttributes)if(!(l.condition!==void 0||l.mapToProperty!==void 0||l.isMappingMany!==void 0||l.direction!=="LEFT"||l.entityOrProperty!==`${t}.${i.propertyPath}`)){r=!1,a=l.alias.name;break}const o=!!e.expressionMap.joinAttributes.find(l=>l.alias.name===a);r&&!o&&e.leftJoin(t+"."+i.propertyPath,a);let c=!0;for(const l of e.expressionMap.selects)if(!(l.aliasName!==void 0||l.virtual!==void 0||l.selection!==a)){c=!1;break}c&&e.addSelect(a),this.joinEagerRelations(e,a,i.inverseEntityMetadata)})}}class Wa extends xe{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,i){return this.join("INNER",e,t,n,i),this}leftJoin(e,t,n,i){return this.join("LEFT",e,t,n,i),this}innerJoinAndSelect(e,t,n,i){return this.addSelect(t),this.innerJoin(e,t,n,i),this}leftJoinAndSelect(e,t,n,i){return this.addSelect(t),this.leftJoin(e,t,n,i),this}innerJoinAndMapMany(e,t,n,i,a){return this.addSelect(n),this.join("INNER",t,n,i,a,e,!0),this}innerJoinAndMapOne(e,t,n,i,a,r){return this.addSelect(n),this.join("INNER",t,n,i,a,e,!1,r),this}leftJoinAndMapMany(e,t,n,i,a){return this.addSelect(n),this.join("LEFT",t,n,i,a,e,!0),this}leftJoinAndMapOne(e,t,n,i,a,r){return this.addSelect(n),this.join("LEFT",t,n,i,a,e,!1,r),this}loadRelationIdAndMap(e,t,n,i){const a=new La(this.expressionMap);return a.mapToProperty=e,a.relationName=t,typeof n=="string"&&(a.alias=n),typeof n=="object"&&n.disableMixedMap&&(a.disableMixedMap=!0),a.queryBuilderFactory=i,this.expressionMap.relationIdAttributes.push(a),a.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:a.junctionAlias,metadata:a.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,i){const a=new Ba(this.expressionMap);return a.mapToProperty=e,a.relationName=t,a.alias=n,a.queryBuilderFactory=i,this.expressionMap.relationCountAttributes.push(a),this.expressionMap.createAlias({type:"other",name:a.junctionAlias}),a.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:a.junctionAlias,metadata:a.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new j('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new j('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new j('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new j('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new j('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new j('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new j('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new j('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new gn;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const e=(await this.getRawAndEntities()).entities[0];if(e&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const t=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const n=t.updateDateColumn.getEntityValue(e);if(n.getTime()!==this.expressionMap.lockVersion.getTime())throw new Io(t.name,this.expressionMap.lockVersion,n)}else{const n=t.versionColumn.getEntityValue(e);if(n!==this.expressionMap.lockVersion)throw new Io(t.name,this.expressionMap.lockVersion,n)}}return e===void 0?null:e}async getOneOrFail(){const e=await this.getOne();if(!e)throw new Gh(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new gn;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new gn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new gn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new gn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;const i=this.expressionMap.cacheId;this.expressionMap.cacheId=i&&`${i}-count`;const a=await this.executeCountQuery(e),r=[n.entities,a];return t&&await e.commitTransaction(),r}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0);const a=()=>{if(n!==this.queryRunner)return n.release()},r=n.stream(e,t,a,a);return i&&await n.commitTransaction(),r}catch(a){if(i)try{await n.rollbackTransaction()}catch{}throw a}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,i,a,r,o,c){a&&this.setParameters(a);const l=new Jo(this.connection,this.expressionMap);l.direction=e,l.mapAsEntity=c,l.mapToProperty=r,l.isMappingMany=o,l.entityOrProperty=t,l.condition=i,this.expressionMap.joinAttributes.push(l);const u=l.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const d=`${n}.${u.deleteDateColumn.propertyName} IS NULL`;l.condition=l.condition?` ${l.condition} AND ${d}`:`${d}`}l.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:u}),l.relation&&l.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:l.junctionAlias,metadata:l.relation.junctionEntityMetadata})}else{let d="";if(typeof t=="function"){const h=t(this.subQuery());this.setParameters(h.getParameters()),d=h.getQuery()}else d=t;const p=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";l.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:p===!1?t:void 0,subQuery:p===!0?d:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new j("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const o=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,o)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,o))}this.expressionMap.joinAttributes.forEach(o=>{if(o.metadata)e.push(...this.buildEscapedEntityColumnSelects(o.alias.name,o.metadata)),t.push(...this.findEntityColumnSelects(o.alias.name,o.metadata));else if(this.expressionMap.selects.some(c=>c.selection===o.alias.name)){e.push({selection:this.escape(o.alias.name)+".*"});const c=this.expressionMap.selects.find(l=>l.selection===o.alias.name);t.push(c)}}),this.expressionMap.selects.filter(o=>t.indexOf(o)===-1).forEach(o=>e.push({selection:this.replacePropertyNames(o.selection),aliasName:o.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&P.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);const i=this.expressionMap.aliases.filter(o=>o.type==="from"&&(o.tablePath||o.subQuery)).map(o=>o.subQuery?o.subQuery+" "+this.escape(o.name):this.getTableName(o.tablePath)+" "+this.escape(o.name)),a=this.createSelectDistinctExpression(),r=e.map(o=>o.selection+(o.aliasName?" AS "+this.escape(o.aliasName):"")).join(", ");return a+r+" FROM "+i.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:i}=this.connection;let a="SELECT ";return n>0&&P.isMySQLFamily(i)&&(a+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),P.isPostgresFamily(i)&&t.length>0?a=`SELECT DISTINCT ON (${t.map(r=>this.replacePropertyNames(r)).join(", ")}) `:e&&(a="SELECT DISTINCT "),a}createJoinExpression(){return this.expressionMap.joinAttributes.map(e=>{const t=e.relation,n=e.tablePath,i=e.alias.name;let a=e.condition?" AND ("+e.condition+")":"";const r=e.parentAlias;if(!r||!t){const o=e.alias.subQuery?e.alias.subQuery:this.getTableName(n);return" "+e.direction+" JOIN "+o+" "+this.escape(i)+this.createTableLockExpression()+(e.condition?" ON "+this.replacePropertyNames(e.condition):"")}if(t.isManyToOne||t.isOneToOneOwner){const o=t.joinColumns.map(c=>i+"."+c.referencedColumn.propertyPath+"="+r+"."+t.propertyPath+"."+c.referencedColumn.propertyPath).join(" AND ");return" "+e.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+a)}else if(t.isOneToMany||t.isOneToOneNotOwner){const o=t.inverseRelation.joinColumns.map(c=>(t.inverseEntityMetadata.tableType==="entity-child"&&t.inverseEntityMetadata.discriminatorColumn&&(a+=" AND "+i+"."+t.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+t.inverseEntityMetadata.discriminatorValue+"'"),i+"."+t.inverseRelation.propertyPath+"."+c.referencedColumn.propertyPath+"="+r+"."+c.referencedColumn.propertyPath)).join(" AND ");if(!o)throw new j(`Relation ${t.entityMetadata.name}.${t.propertyName} does not have join columns.`);return" "+e.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+a)}else{const o=t.junctionEntityMetadata.tablePath,c=e.junctionAlias;let l="",u="";return t.isOwning?(l=t.joinColumns.map(d=>c+"."+d.propertyPath+"="+r+"."+d.referencedColumn.propertyPath).join(" AND "),u=t.inverseJoinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+c+"."+d.propertyPath).join(" AND ")):(l=t.inverseRelation.inverseJoinColumns.map(d=>c+"."+d.propertyPath+"="+r+"."+d.referencedColumn.propertyPath).join(" AND "),u=t.inverseRelation.joinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+c+"."+d.propertyPath).join(" AND "))," "+e.direction+" JOIN "+this.getTableName(o)+" "+this.escape(c)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l)+" "+e.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u+a)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const n=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,i=this.expressionMap.selects.find(a=>a.selection===t);if(i&&!i.aliasName&&t.indexOf(".")!==-1){const a=t.split("."),r=a[0],o=a.slice(1).join("."),c=this.expressionMap.aliases.find(l=>l.name===r);if(c){const l=c.metadata.findColumnWithPropertyPath(o);if(l){const u=P.buildAlias(this.connection.driver,void 0,r,l.databaseName);return this.escape(u)+" "+n}}}return this.replacePropertyNames(t)+" "+n}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;if(!e&&!t&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take),this.connection.driver.options.type==="mssql"){let n="";if((t||e)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(n=" ORDER BY (SELECT NULL)"),t&&e)return n+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return n+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(e)return n+" OFFSET "+e+" ROWS"}else if(P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)throw new nm}else if(P.isSQLiteFamily(this.connection.driver)){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(t&&e)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return" FETCH NEXT "+t+" ROWS ONLY";if(e)return" OFFSET "+e+" ROWS"}else{if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(P.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new j("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new j("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return P.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(P.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new Ps;case"pessimistic_write":if(P.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(P.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new Ps;case"pessimistic_partial_write":if(P.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(P.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new Ps;case"pessimistic_write_or_fail":if(P.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(P.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new Ps;case"for_no_key_update":if(P.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new Ps;case"for_key_share":if(P.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new Ps;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const n=this.expressionMap.selects.some(l=>l.selection===e),i=[];if(n&&i.push(...t.columns.filter(l=>l.isSelect===!0)),i.push(...t.columns.filter(l=>this.expressionMap.selects.some(u=>u.selection===e+"."+l.propertyPath))),i.length===0)return[];const a=this.expressionMap.queryEntity?t.primaryColumns.filter(l=>i.indexOf(l)===-1):[],r=[...i,...a],o=[],c=this.escape(e);return r.forEach(l=>{let u=c+"."+this.escape(l.databaseName);l.isVirtualProperty&&l.query&&(u=`(${l.query(c)})`),this.connection.driver.spatialTypes.indexOf(l.type)!==-1&&((P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),P.isPostgresFamily(this.connection.driver)&&(l.precision?u=`ST_AsGeoJSON(${u}, ${l.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const d=this.expressionMap.selects.filter(p=>p.selection===e+"."+l.propertyPath);if(d.length)d.forEach(p=>{o.push({selection:u,aliasName:p.aliasName?p.aliasName:P.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:p.virtual})});else{if(l.isVirtualProperty)return;o.push({selection:u,aliasName:P.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:n})}}),o}findEntityColumnSelects(e,t){const n=this.expressionMap.selects.find(i=>i.selection===e);return n?[n]:this.expressionMap.selects.filter(i=>t.columns.some(a=>i.selection===e+"."+a.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,t=this.expressionMap.mainAlias.metadata.primaryColumns,n=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||P.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+t.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+"))";if(P.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+t.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const i=t.map(a=>`${n}.${this.escape(a.databaseName)}`).join(", '|;|', ");return t.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?t.length===1?`COUNT(DISTINCT(${n}.${this.escape(t[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${t.map(i=>`CAST(${n}.${this.escape(i.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+t.map(i=>`${n}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?De.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?De.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const n=this.expressionMap.aliases.find(i=>i.metadata.tableNameWithoutPrefix===t);if(!n)throw new j(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Ua.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new j('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new sm;if(this.expressionMap.lockMode==="optimistic"){const r=this.expressionMap.mainAlias.metadata;if(!r.versionColumn&&!r.updateDateColumn)throw new Yh(r.name)}const t=new Cm(this.connection,e,this.expressionMap.relationIdAttributes),n=new Tm(this.connection,e,this.expressionMap.relationCountAttributes);new Sm(this.expressionMap).transform(),new Pm(this.expressionMap).transform();let i=[],a=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[r,o]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),c=this.expressionMap.mainAlias.metadata,l=this.expressionMap.mainAlias.name,u=c.primaryColumns.map(h=>{const m=this.escape("distinctAlias"),y=this.escape(P.buildAlias(this.connection.driver,void 0,l,h.databaseName));o[y]||(o[y]="ASC");const f=P.buildAlias(this.connection.driver,void 0,"ids_"+l,h.databaseName);return`${m}.${y} AS ${this.escape(f)}`}),d=this.clone(),p=d.expressionMap.timeTravel;if(i=await new Wa(this.connection,e).select(`DISTINCT ${u.join(", ")}`).addSelect(r).from(`(${d.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(p).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(o).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),i.length>0){let h="";const m={};if(c.hasMultiplePrimaryKeys)h=i.map((y,f)=>c.primaryColumns.map(g=>{const b=`orm_distinct_ids_${f}_${g.databaseName}`,v=P.buildAlias(this.connection.driver,void 0,"ids_"+l,g.databaseName);return m[b]=y[v],`${l}.${g.propertyPath}=:${b}`}).join(" AND ")).join(" OR ");else{const y=P.buildAlias(this.connection.driver,void 0,"ids_"+l,c.primaryColumns[0].databaseName),f=i.map(g=>g[y]);f.every(g=>typeof g=="number")?h=`${l}.${c.primaryColumns[0].propertyPath} IN (${f.join(", ")})`:(m.orm_distinct_ids=f,h=l+"."+c.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}i=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:h}).setParameters(m).loadRawResults(e)}}else i=await this.loadRawResults(e);if(i.length>0){const r=await t.load(i),o=await n.load(i);a=new km(this.expressionMap,this.connection.driver,r,o,this.queryRunner).transform(i,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,a)}if(this.expressionMap.relationLoadStrategy==="query"){const r=new Am(this.connection,e);await Promise.all(this.relationMetadatas.map(async o=>{const c=o.inverseEntityMetadata.target,l=o.inverseEntityMetadata.targetName,u=Array.isArray(this.findOptions.select)?De.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,d=Array.isArray(this.findOptions.relations)?De.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,p=this.createQueryBuilder(e).select(l).from(c,l).setFindOptions({select:u?De.deepValue(u,o.propertyPath):void 0,order:this.findOptions.order?De.deepValue(this.findOptions.order,o.propertyPath):void 0,relations:d?De.deepValue(d,o.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(a.length>0){const h=await r.loadManyToManyRelationIdsAndGroup(o,a,void 0,p);a.forEach(m=>{const y=h.find(f=>f.entity===m);if(y){const f=y.related===void 0?null:y.related;o.setEntityValue(m,f)}})}}))}return{raw:i,entities:a}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,n=Object.keys(t).map(a=>{if(a.indexOf(".")!==-1){const r=a.split("."),o=r[0],c=r.slice(1).join("."),l=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(P.buildAlias(this.connection.driver,void 0,o,l.databaseName))}else return this.expressionMap.selects.find(r=>r.selection===a||r.aliasName===a)?this.escape(e)+"."+this.escape(a):""}).join(", "),i={};return Object.keys(t).forEach(a=>{if(a.indexOf(".")!==-1){const r=a.split("."),o=r[0],c=r.slice(1).join("."),l=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);i[this.escape(e)+"."+this.escape(P.buildAlias(this.connection.driver,void 0,o,l.databaseName))]=t[a]}else this.expressionMap.selects.find(r=>r.selection===a||r.aliasName===a)?i[this.escape(e)+"."+this.escape(a)]=t[a]:i[a]=t[a]}),[n,i]}async loadRawResults(e){const[t,n]=this.getQueryAndParameters(),i=t+" -- PARAMETERS: "+JSON.stringify(n,(u,d)=>typeof d=="bigint"?d.toString():d),a=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let r;const o=a.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let c=!1;if(this.connection.queryResultCache&&o)try{if(r=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:i,duration:this.expressionMap.cacheDuration||a.duration||1e3},e),r&&!this.connection.queryResultCache.isExpired(r))return JSON.parse(r.result)}catch(u){if(!a.ignoreErrors)throw u;c=!0}const l=await e.query(t,n,!0);if(!c&&this.connection.queryResultCache&&o)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:i,time:new Date().getTime(),duration:this.expressionMap.cacheDuration||a.duration||1e3,result:JSON.stringify(l.records)},r,e)}catch(u){if(!a.ignoreErrors)throw u}return l.records}mergeExpressionMap(e){return Me.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,n,i){for(let a in e){if(e[a]===void 0||e[a]===!1)continue;const r=i?i+"."+a:a,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new jt(r,t);o?this.selects.push(n+"."+r):c&&this.buildSelect(e[a],t,n,r)}}buildRelations(e,t,n,i,a){e&&Object.keys(e).forEach(r=>{const o=e[r],c=a?a+"."+r:r,l=n.findEmbeddedWithPropertyPath(c),u=n.findRelationWithPropertyPath(c);if(!l&&!u)throw new jt(c,n);if(l)this.buildRelations(o,typeof t=="object"?De.deepValue(t,l.propertyPath):void 0,n,i,c);else if(u){let d=i+"_"+c.replace(".","_");d=P.buildAlias(this.connection.driver,{joiner:"__"},i,d),(o===!0||typeof o=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[r]=="object"?t[r]:void 0,alias:d,parentAlias:i,relationMetadata:u}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,d))),typeof o=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(o,typeof t=="object"?De.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,d,void 0)}})}buildEagerRelations(e,t,n,i,a){e&&Object.keys(e).forEach(r=>{const o=e[r],c=a?a+"."+r:r,l=n.findEmbeddedWithPropertyPath(c),u=n.findRelationWithPropertyPath(c);if(!l&&!u)throw new jt(c,n);if(l)this.buildEagerRelations(o,typeof t=="object"?De.deepValue(t,l.propertyPath):void 0,n,i,c);else if(u){let d=i+"_"+c.replace(".","_");d=P.buildAlias(this.connection.driver,{joiner:"__"},i,d),(o===!0||typeof o=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(p=>{let h=d+"_"+p.propertyPath.replace(".","_");h=P.buildAlias(this.connection.driver,{joiner:"__"},d,h),this.joins.find(m=>m.alias===h)||this.joins.push({type:"left",select:!0,alias:h,parentAlias:d,selection:void 0,relationMetadata:p}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,d)}),typeof o=="object"&&this.buildEagerRelations(o,typeof t=="object"?De.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,d,void 0)}})}buildOrder(e,t,n,i){for(let a in e){if(e[a]===void 0)continue;const r=i?i+"."+a:a,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new jt(r,t);if(o){let u=typeof e[a]=="object"?e[a].direction:e[a];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let d=typeof e[a]=="object"?e[a].nulls:void 0;d=(d==null?void 0:d.toLowerCase())==="first"?"NULLS FIRST":(d==null?void 0:d.toLowerCase())==="last"?"NULLS LAST":void 0;let p=`${n}.${r}`;this.addOrderBy(p,u,d)}else if(c)this.buildOrder(e[a],t,n,r);else if(l){let u=n+"_"+r.replace(".","_");u=P.buildAlias(this.connection.driver,{joiner:"__"},n,u),this.joins.find(d=>d.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:n,selection:void 0,relationMetadata:l}),this.buildOrder(e[a],l.inverseEntityMetadata,u)}}}buildWhere(e,t,n,i){let a="";if(Array.isArray(e))e.length&&(a=e.map(r=>this.buildWhere(r,t,n,i)).filter(r=>!!r).map(r=>"("+r+")").join(" OR "));else{let r=[];for(let o in e){if(e[o]===void 0||e[o]===null)continue;const c=i?i+"."+o:o,l=t.findColumnWithPropertyPathStrict(c),u=t.findEmbeddedWithPropertyPath(c),d=t.findRelationWithPropertyPath(c);if(!u&&!l&&!d)throw new jt(c,t);if(l){let p=`${n}.${c}`;l.isVirtualProperty&&l.query&&(p=`(${l.query(n)})`);let h=e[o];me.isEqualOperator(e[o])&&(h=e[o].value),l.transformer&&(h instanceof bn?h.transformValue(l.transformer):h=qa.transformTo(l.transformer,h)),r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(p,h)))}else if(u){const p=this.buildWhere(e[o],t,n,c);p&&r.push(p)}else if(d){if(typeof e[o]=="object"&&Object.keys(e[o]).every(p=>e[o][p]===void 0))continue;if(me.isFindOperator(e[o]))if(e[o].type==="moreThan"||e[o].type==="lessThan"||e[o].type==="moreThanOrEqual"||e[o].type==="lessThanOrEqual"){let p="";e[o].type==="moreThan"?p=">":e[o].type==="lessThan"?p="<":e[o].type==="moreThanOrEqual"?p=">=":e[o].type==="lessThanOrEqual"&&(p="<=");const h=this.subQuery();if(d.isManyToManyOwner)h.select("COUNT(*)").from(d.joinTableName,d.joinTableName).where(d.joinColumns.map(m=>`${d.joinTableName}.${m.propertyName} = ${n}.${m.referencedColumn.propertyName}`).join(" AND "));else if(d.isManyToManyNotOwner)h.select("COUNT(*)").from(d.inverseRelation.joinTableName,d.inverseRelation.joinTableName).where(d.inverseRelation.inverseJoinColumns.map(m=>`${d.inverseRelation.joinTableName}.${m.propertyName} = ${n}.${m.referencedColumn.propertyName}`).join(" AND "));else if(d.isOneToMany)h.select("COUNT(*)").from(d.inverseEntityMetadata.target,d.inverseEntityMetadata.tableName).where(d.inverseRelation.joinColumns.map(m=>`${d.inverseEntityMetadata.tableName}.${m.propertyName} = ${n}.${m.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(h.getSql()+" "+p+" "+parseInt(e[o].value))}else if(d.isManyToOne||d.isOneToOne&&d.isOneToOneOwner){const p=`${n}.${c}`;r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(p,e[o])))}else throw new Error("This relation isn't supported by given find operator");else{let p=n+"_"+d.propertyPath.replace(".","_");p=P.buildAlias(this.connection.driver,{joiner:"__"},n,p),this.joins.find(m=>m.alias===p)||this.joins.push({type:"left",select:!1,selection:void 0,alias:p,parentAlias:n,relationMetadata:d});const h=this.buildWhere(e[o],d.inverseEntityMetadata,p);h&&r.push(h)}}}a=r.length?"("+r.join(") AND (")+")":r.join(" AND ")}return a.length?"("+a+")":a}}class tc{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class Nm extends xe{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const n=new Fa(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=n.getSoftDeletionReturningColumns());const[i,a]=this.getQueryAndParameters(),r=await e.query(i,a,!0),o=tc.from(r);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await n.update(o,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),o}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=me.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new ci;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new j(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new j("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new j(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new Xh(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new j('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new Ca;const n=this.createWhereExpression(),i=this.createReturningExpression("update");return i===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${i}${n}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n} RETURNING ${i}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(P.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new Ro}return""}}class jm extends xe{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let n=null,i=null;const a=new Fa(e,this.expressionMap),r=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const p of this.expressionMap.returning)r.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(p));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=a.getUpdationReturningColumns(),r.push(...this.expressionMap.extraReturningColumns.filter(p=>!r.includes(p)))),r.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",r),i="SELECT * FROM @OutputTable");const[o,c]=this.getQueryAndParameters(),l=[n,o,i],u=await e.query(l.filter(p=>p!=null).join(`;

`),c,!0),d=tc.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await a.update(d,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),d}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new ci;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new j(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new j("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,n={};for(let c in e)e[c]!==void 0&&(n[c]=e[c]);const i=[],a=[];if(t?(this.createPropertyPath(t,n).forEach(c=>{const l=t.findColumnsWithPropertyPath(c);if(l.length<=0)throw new jt(c,t);l.forEach(u=>{if(!u.isUpdate||a.includes(u))return;a.push(u);let d=u.getEntityValue(n);if(u.referencedColumn&&typeof d=="object"&&!(d instanceof Date)&&d!==null&&!it.isBuffer(d)?d=u.referencedColumn.getEntityValue(d):typeof d!="function"&&(d=this.connection.driver.preparePersistentValue(d,u)),typeof d=="function")i.push(this.escape(u.databaseName)+" = "+d());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&d===null)i.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(d=this.connection.driver.parametrizeValue(u,d));const p=this.createParameter(d);let h=null;if((P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const m=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?h=`${m}(${p}, ${u.srid})`:h=`${m}(${p})`}else P.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?h=`ST_SetSRID(ST_GeomFromGeoJSON(${p}), ${u.srid})::${u.type}`:h=`ST_GeomFromGeoJSON(${p})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?h=u.type+"::STGeomFromText("+p+", "+(u.srid||"0")+")":h=p;i.push(this.escape(u.databaseName)+" = "+h)}})}),(i.length>0||Object.keys(n).length===0)&&(t.versionColumn&&a.indexOf(t.versionColumn)===-1&&i.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&a.indexOf(t.updateDateColumn)===-1&&i.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(n).map(c=>{let l=n[c];if(typeof l=="function")i.push(this.escape(c)+" = "+l());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&l===null)i.push(this.escape(c)+" = NULL");else{const u=this.createParameter(l);i.push(this.escape(c)+" = "+u)}}),i.length<=0)throw new Ca;const r=this.createWhereExpression(),o=this.createReturningExpression("update");return o===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")} OUTPUT ${o}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${r} RETURNING ${o}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(P.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new Ro}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new Ca}}function Im(){xe.registerQueryBuilderClass("DeleteQueryBuilder",s=>new gm(s)),xe.registerQueryBuilderClass("InsertQueryBuilder",s=>new Om(s)),xe.registerQueryBuilderClass("RelationQueryBuilder",s=>new Mm(s)),xe.registerQueryBuilderClass("SelectQueryBuilder",s=>new Wa(s)),xe.registerQueryBuilderClass("SoftDeleteQueryBuilder",s=>new Nm(s)),xe.registerQueryBuilderClass("UpdateQueryBuilder",s=>new jm(s))}var sc;(function(s){s.VIEW="VIEW",s.MATERIALIZED_VIEW="MATERIALIZED_VIEW",s.GENERATED_COLUMN="GENERATED_COLUMN"})(sc||(sc={}));var Za={exports:{}},Va,nc;function Rm(){if(nc)return Va;nc=1;var s=1e3,e=s*60,t=e*60,n=t*24,i=n*7,a=n*365.25;Va=function(u,d){d=d||{};var p=typeof u;if(p==="string"&&u.length>0)return r(u);if(p==="number"&&isFinite(u))return d.long?c(u):o(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function r(u){if(u=String(u),!(u.length>100)){var d=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(d){var p=parseFloat(d[1]),h=(d[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return p*a;case"weeks":case"week":case"w":return p*i;case"days":case"day":case"d":return p*n;case"hours":case"hour":case"hrs":case"hr":case"h":return p*t;case"minutes":case"minute":case"mins":case"min":case"m":return p*e;case"seconds":case"second":case"secs":case"sec":case"s":return p*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function o(u){var d=Math.abs(u);return d>=n?Math.round(u/n)+"d":d>=t?Math.round(u/t)+"h":d>=e?Math.round(u/e)+"m":d>=s?Math.round(u/s)+"s":u+"ms"}function c(u){var d=Math.abs(u);return d>=n?l(u,d,n,"day"):d>=t?l(u,d,t,"hour"):d>=e?l(u,d,e,"minute"):d>=s?l(u,d,s,"second"):u+" ms"}function l(u,d,p,h){var m=d>=p*1.5;return Math.round(u/p)+" "+h+(m?"s":"")}return Va}var za,ic;function $m(){if(ic)return za;ic=1;function s(e){n.debug=n,n.default=n,n.coerce=l,n.disable=r,n.enable=a,n.enabled=o,n.humanize=Rm(),n.destroy=u,Object.keys(e).forEach(d=>{n[d]=e[d]}),n.names=[],n.skips=[],n.formatters={};function t(d){let p=0;for(let h=0;h<d.length;h++)p=(p<<5)-p+d.charCodeAt(h),p|=0;return n.colors[Math.abs(p)%n.colors.length]}n.selectColor=t;function n(d){let p,h=null,m,y;function f(...g){if(!f.enabled)return;const b=f,v=Number(new Date),E=v-(p||v);b.diff=E,b.prev=p,b.curr=v,p=v,g[0]=n.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let S=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(C,Q)=>{if(C==="%%")return"%";S++;const J=n.formatters[Q];if(typeof J=="function"){const W=g[S];C=J.call(b,W),g.splice(S,1),S--}return C}),n.formatArgs.call(b,g),(b.log||n.log).apply(b,g)}return f.namespace=d,f.useColors=n.useColors(),f.color=n.selectColor(d),f.extend=i,f.destroy=n.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(m!==n.namespaces&&(m=n.namespaces,y=n.enabled(d)),y),set:g=>{h=g}}),typeof n.init=="function"&&n.init(f),f}function i(d,p){const h=n(this.namespace+(typeof p>"u"?":":p)+d);return h.log=this.log,h}function a(d){n.save(d),n.namespaces=d,n.names=[],n.skips=[];let p;const h=(typeof d=="string"?d:"").split(/[\s,]+/),m=h.length;for(p=0;p<m;p++)h[p]&&(d=h[p].replace(/\*/g,".*?"),d[0]==="-"?n.skips.push(new RegExp("^"+d.slice(1)+"$")):n.names.push(new RegExp("^"+d+"$")))}function r(){const d=[...n.names.map(c),...n.skips.map(c).map(p=>"-"+p)].join(",");return n.enable(""),d}function o(d){if(d[d.length-1]==="*")return!0;let p,h;for(p=0,h=n.skips.length;p<h;p++)if(n.skips[p].test(d))return!1;for(p=0,h=n.names.length;p<h;p++)if(n.names[p].test(d))return!0;return!1}function c(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function l(d){return d instanceof Error?d.stack||d.message:d}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}return za=s,za}var ac;function Lm(){return ac||(ac=1,function(s,e){var t={};e.formatArgs=i,e.save=a,e.load=r,e.useColors=n,e.storage=o(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let l;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(l=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(l[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;l.splice(1,0,u,"color: inherit");let d=0,p=0;l[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(d++,h==="%c"&&(p=d))}),l.splice(p,0,u)}e.log=console.debug||console.log||(()=>{});function a(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}}function r(){let l;try{l=e.storage.getItem("debug")}catch{}return!l&&typeof Ut<"u"&&"env"in Ut&&(l=t.DEBUG),l}function o(){try{return localStorage}catch{}}s.exports=$m()(e);const{formatters:c}=s.exports;c.j=function(l){try{return JSON.stringify(l)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}}(Za,Za.exports)),Za.exports}Lm(),Im(),jp=()=>{const s=Hs(e=>e.loadModel);return{loadModel:M.useCallback(async(e,...t)=>{switch(e){case Ge.Wllama:return vb(...t);case Ge.WebLLM:return s(...t);default:return}},[s])}};var Bm=Object.defineProperty,Dm=Object.defineProperties,qm=Object.getOwnPropertyDescriptors,ui=Object.getOwnPropertySymbols,rc=Object.prototype.hasOwnProperty,oc=Object.prototype.propertyIsEnumerable,cc=(s,e,t)=>e in s?Bm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fm=(s,e)=>{for(var t in e||(e={}))rc.call(e,t)&&cc(s,t,e[t]);if(ui)for(var t of ui(e))oc.call(e,t)&&cc(s,t,e[t]);return s},Um=(s,e)=>Dm(s,qm(e)),Wm=(s,e)=>{var t={};for(var n in s)rc.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&ui)for(var n of ui(s))e.indexOf(n)<0&&oc.call(s,n)&&(t[n]=s[n]);return t};function Zm(s){let e=setTimeout(s,0),t=setTimeout(s,10),n=setTimeout(s,50);return[e,t,n]}function Vm(s){let e=M.useRef();return M.useEffect(()=>{e.current=s}),e.current}var zm=18,lc=40,Km=`${lc}px`,Qm=["[data-lastpass-icon-root]","com-1password-button","[data-dashlanecreated]",'[style$="2147483647 !important;"]'].join(",");function Jm({containerRef:s,inputRef:e,pushPasswordManagerStrategy:t,isFocused:n}){let[i,a]=M.useState(!1),[r,o]=M.useState(!1),[c,l]=M.useState(!1),u=M.useMemo(()=>t==="none"?!1:(t==="increase-width"||t==="experimental-no-flickering")&&i&&r,[i,r,t]),d=M.useCallback(()=>{let p=s.current,h=e.current;if(!p||!h||c||t==="none")return;let m=p,y=m.getBoundingClientRect().left+m.offsetWidth,f=m.getBoundingClientRect().top+m.offsetHeight/2,g=y-zm,b=f;document.querySelectorAll(Qm).length===0&&document.elementFromPoint(g,b)===p||(a(!0),l(!0))},[s,e,c,t]);return M.useEffect(()=>{let p=s.current;if(!p||t==="none")return;function h(){let y=window.innerWidth-p.getBoundingClientRect().right;o(y>=lc)}h();let m=setInterval(h,1e3);return()=>{clearInterval(m)}},[s,t]),M.useEffect(()=>{let p=n||document.activeElement===e.current;if(t==="none"||!p)return;let h=setTimeout(d,0),m=setTimeout(d,2e3),y=setTimeout(d,5e3),f=setTimeout(()=>{l(!0)},6e3);return()=>{clearTimeout(h),clearTimeout(m),clearTimeout(y),clearTimeout(f)}},[e,n,t,d]),{hasPWMBadge:i,willPushPWMBadge:u,PWM_BADGE_SPACE_WIDTH:Km}}var uc=M.createContext({}),dc=M.forwardRef((s,e)=>{var t=s,{value:n,onChange:i,maxLength:a,textAlign:r="left",pattern:o,placeholder:c,inputMode:l="numeric",onComplete:u,pushPasswordManagerStrategy:d="increase-width",pasteTransformer:p,containerClassName:h,noScriptCSSFallback:m=Hm,render:y,children:f}=t,g=Wm(t,["value","onChange","maxLength","textAlign","pattern","placeholder","inputMode","onComplete","pushPasswordManagerStrategy","pasteTransformer","containerClassName","noScriptCSSFallback","render","children"]),b,v,E,S,C;let[Q,J]=M.useState(typeof g.defaultValue=="string"?g.defaultValue:""),W=n??Q,q=Vm(W),pe=M.useCallback(z=>{i==null||i(z),J(z)},[i]),we=M.useMemo(()=>o?typeof o=="string"?new RegExp(o):o:null,[o]),le=M.useRef(null),lt=M.useRef(null),He=M.useRef({value:W,onChange:pe,isIOS:typeof window<"u"&&((v=(b=window==null?void 0:window.CSS)==null?void 0:b.supports)==null?void 0:v.call(b,"-webkit-touch-callout","none"))}),et=M.useRef({prev:[(E=le.current)==null?void 0:E.selectionStart,(S=le.current)==null?void 0:S.selectionEnd,(C=le.current)==null?void 0:C.selectionDirection]});M.useImperativeHandle(e,()=>le.current,[]),M.useEffect(()=>{let z=le.current,Y=lt.current;if(!z||!Y)return;He.current.value!==z.value&&He.current.onChange(z.value),et.current.prev=[z.selectionStart,z.selectionEnd,z.selectionDirection];function Oe(){if(document.activeElement!==z){Bt(null),st(null);return}let he=z.selectionStart,Pe=z.selectionEnd,Ee=z.selectionDirection,_e=z.maxLength,ht=z.value,dt=et.current.prev,qt=-1,Ft=-1,mt;if(ht.length!==0&&he!==null&&Pe!==null){let Vn=he===Pe,_=he===ht.length&&ht.length<_e;if(Vn&&!_){let x=he;if(x===0)qt=0,Ft=1,mt="forward";else if(x===_e)qt=x-1,Ft=x,mt="backward";else if(_e>1&&ht.length>1){let O=0;if(dt[0]!==null&&dt[1]!==null){mt=x<dt[1]?"backward":"forward";let A=dt[0]===dt[1]&&dt[0]<_e;mt==="backward"&&!A&&(O=-1)}qt=O+x,Ft=O+x+1}}qt!==-1&&Ft!==-1&&qt!==Ft&&le.current.setSelectionRange(qt,Ft,mt)}let oa=qt!==-1?qt:he,ca=Ft!==-1?Ft:Pe,no=mt??Ee;Bt(oa),st(ca),et.current.prev=[oa,ca,no]}if(document.addEventListener("selectionchange",Oe,{capture:!0}),Oe(),document.activeElement===z&&rs(!0),!document.getElementById("input-otp-style")){let he=document.createElement("style");if(he.id="input-otp-style",document.head.appendChild(he),he.sheet){let Pe="background: transparent !important; color: transparent !important; border-color: transparent !important; opacity: 0 !important; box-shadow: none !important; -webkit-box-shadow: none !important; -webkit-text-fill-color: transparent !important;";_n(he.sheet,"[data-input-otp]::selection { background: transparent !important; color: transparent !important; }"),_n(he.sheet,`[data-input-otp]:autofill { ${Pe} }`),_n(he.sheet,`[data-input-otp]:-webkit-autofill { ${Pe} }`),_n(he.sheet,"@supports (-webkit-touch-callout: none) { [data-input-otp] { letter-spacing: -.6em !important; font-weight: 100 !important; font-stretch: ultra-condensed; font-optical-sizing: none !important; left: -1px !important; right: 1px !important; } }"),_n(he.sheet,"[data-input-otp] + * { pointer-events: all !important; }")}}let Ue=()=>{Y&&Y.style.setProperty("--root-height",`${z.clientHeight}px`)};Ue();let $e=new ResizeObserver(Ue);return $e.observe(z),()=>{document.removeEventListener("selectionchange",Oe,{capture:!0}),$e.disconnect()}},[]);let[ge,kt]=M.useState(!1),[tt,rs]=M.useState(!1),[ut,Bt]=M.useState(null),[F,st]=M.useState(null);M.useEffect(()=>{Zm(()=>{var z,Y,Oe,Ue;(z=le.current)==null||z.dispatchEvent(new Event("input"));let $e=(Y=le.current)==null?void 0:Y.selectionStart,he=(Oe=le.current)==null?void 0:Oe.selectionEnd,Pe=(Ue=le.current)==null?void 0:Ue.selectionDirection;$e!==null&&he!==null&&(Bt($e),st(he),et.current.prev=[$e,he,Pe])})},[W,tt]),M.useEffect(()=>{q!==void 0&&W!==q&&q.length<a&&W.length===a&&(u==null||u(W))},[a,u,q,W]);let Dt=Jm({containerRef:lt,inputRef:le,pushPasswordManagerStrategy:d,isFocused:tt}),be=M.useCallback(z=>{let Y=z.currentTarget.value.slice(0,a);if(Y.length>0&&we&&!we.test(Y)){z.preventDefault();return}typeof q=="string"&&Y.length<q.length&&document.dispatchEvent(new Event("selectionchange")),pe(Y)},[a,pe,q,we]),Es=M.useCallback(()=>{var z;if(le.current){let Y=Math.min(le.current.value.length,a-1),Oe=le.current.value.length;(z=le.current)==null||z.setSelectionRange(Y,Oe),Bt(Y),st(Oe)}rs(!0)},[a]),Ke=M.useCallback(z=>{var Y,Oe;let Ue=le.current;if(!p&&(!He.current.isIOS||!z.clipboardData||!Ue))return;let $e=z.clipboardData.getData("text/plain"),he=p?p($e):$e;z.preventDefault();let Pe=(Y=le.current)==null?void 0:Y.selectionStart,Ee=(Oe=le.current)==null?void 0:Oe.selectionEnd,_e=(Pe!==Ee?W.slice(0,Pe)+he+W.slice(Ee):W.slice(0,Pe)+he+W.slice(Pe)).slice(0,a);if(_e.length>0&&we&&!we.test(_e))return;Ue.value=_e,pe(_e);let ht=Math.min(_e.length,a-1),dt=_e.length;Ue.setSelectionRange(ht,dt),Bt(ht),st(dt)},[a,pe,we,W]),pt=M.useMemo(()=>({position:"relative",cursor:g.disabled?"default":"text",userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"}),[g.disabled]),Ct=M.useMemo(()=>({position:"absolute",inset:0,width:Dt.willPushPWMBadge?`calc(100% + ${Dt.PWM_BADGE_SPACE_WIDTH})`:"100%",clipPath:Dt.willPushPWMBadge?`inset(0 ${Dt.PWM_BADGE_SPACE_WIDTH} 0 0)`:void 0,height:"100%",display:"flex",textAlign:r,opacity:"1",color:"transparent",pointerEvents:"all",background:"transparent",caretColor:"transparent",border:"0 solid transparent",outline:"0 solid transparent",boxShadow:"none",lineHeight:"1",letterSpacing:"-.5em",fontSize:"var(--root-height)",fontFamily:"monospace",fontVariantNumeric:"tabular-nums"}),[Dt.PWM_BADGE_SPACE_WIDTH,Dt.willPushPWMBadge,r]),nt=M.useMemo(()=>M.createElement("input",Um(Fm({autoComplete:g.autoComplete||"one-time-code"},g),{"data-input-otp":!0,"data-input-otp-placeholder-shown":W.length===0||void 0,"data-input-otp-mss":ut,"data-input-otp-mse":F,inputMode:l,pattern:we==null?void 0:we.source,"aria-placeholder":c,style:Ct,maxLength:a,value:W,ref:le,onPaste:z=>{var Y;Ke(z),(Y=g.onPaste)==null||Y.call(g,z)},onChange:be,onMouseOver:z=>{var Y;kt(!0),(Y=g.onMouseOver)==null||Y.call(g,z)},onMouseLeave:z=>{var Y;kt(!1),(Y=g.onMouseLeave)==null||Y.call(g,z)},onFocus:z=>{var Y;Es(),(Y=g.onFocus)==null||Y.call(g,z)},onBlur:z=>{var Y;rs(!1),(Y=g.onBlur)==null||Y.call(g,z)}})),[be,Es,Ke,l,Ct,a,F,ut,g,we==null?void 0:we.source,W]),os=M.useMemo(()=>({slots:Array.from({length:a}).map((z,Y)=>{var Oe;let Ue=tt&&ut!==null&&F!==null&&(ut===F&&Y===ut||Y>=ut&&Y<F),$e=W[Y]!==void 0?W[Y]:null,he=W[0]!==void 0?null:(Oe=c==null?void 0:c[Y])!=null?Oe:null;return{char:$e,placeholderChar:he,isActive:Ue,hasFakeCaret:Ue&&$e===null}}),isFocused:tt,isHovering:!g.disabled&&ge}),[tt,ge,a,F,ut,g.disabled,W]),cs=M.useMemo(()=>y?y(os):M.createElement(uc.Provider,{value:os},f),[f,os,y]);return M.createElement(M.Fragment,null,m!==null&&M.createElement("noscript",null,M.createElement("style",null,m)),M.createElement("div",{ref:lt,"data-input-otp-container":!0,style:pt,className:h},cs,M.createElement("div",{style:{position:"absolute",inset:0,pointerEvents:"none"}},nt)))});dc.displayName="Input";function _n(s,e){try{s.insertRule(e)}catch{console.error("input-otp could not insert CSS rule:",e)}}var Hm=`
[data-input-otp] {
  --nojs-bg: white !important;
  --nojs-fg: black !important;

  background-color: var(--nojs-bg) !important;
  color: var(--nojs-fg) !important;
  caret-color: var(--nojs-fg) !important;
  letter-spacing: .25em !important;
  text-align: center !important;
  border: 1px solid var(--nojs-fg) !important;
  border-radius: 4px !important;
  width: 100% !important;
}
@media (prefers-color-scheme: dark) {
  [data-input-otp] {
    --nojs-bg: black !important;
    --nojs-fg: white !important;
  }
}`;ba=M.forwardRef(({className:s,containerClassName:e,...t},n)=>se.jsx(dc,{ref:n,containerClassName:je("flex items-center gap-2 has-[:disabled]:opacity-50",e),className:je("disabled:cursor-not-allowed",s),...t})),ba.displayName="InputOTP",Hn=M.forwardRef(({className:s,...e},t)=>se.jsx("div",{ref:t,className:je("flex items-center",s),...e})),Hn.displayName="InputOTPGroup",Qt=M.forwardRef(({index:s,className:e,hidden:t,...n},i)=>{const a=M.useContext(uc),{char:r,hasFakeCaret:o,isActive:c}=a.slots[s];return se.jsxs("div",{ref:i,className:je("relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",c&&"z-10 ring-2 ring-ring ring-offset-background",e),...n,children:[t&&r?se.jsx(Np,{}):r,o&&se.jsx("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-center",children:se.jsx("div",{className:"h-4 w-px animate-caret-blink bg-foreground duration-1000"})})]})}),Qt.displayName="InputOTPSlot",_a=M.forwardRef(({...s},e)=>se.jsx("div",{ref:e,role:"separator",...s,children:se.jsx(Np,{})})),_a.displayName="InputOTPSeparator";let js,Ka,pc,di,pi,Qa,hc,mc;po=mb(({onConfirm:s,onCancel:e})=>{const t=mp(),{t:n}=fp("dialogs"),[i,a]=M.useState(""),r=l=>{a(l)},o=async()=>{(i==null?void 0:i.length)===6&&(await(s==null?void 0:s(i)),a(""),t.resolve(!0),t.hide())},c=async()=>{await(e==null?void 0:e()),a(""),t.resolve(!1),t.hide()};return se.jsx(wb,{open:t.visible,onOpenChange:c,children:se.jsxs(xb,{className:"w-[330px]",children:[se.jsxs(Ob,{children:[se.jsx(Eb,{children:n("session_passkey.title")}),se.jsx(Mb,{children:n("session_passkey.description")})]}),se.jsx("div",{className:"py-4",children:se.jsxs(ba,{onChange:r,maxLength:6,children:[se.jsxs(Hn,{children:[se.jsx(Qt,{index:0,hidden:!0}),se.jsx(Qt,{index:1,hidden:!0}),se.jsx(Qt,{index:2,hidden:!0})]}),se.jsx(_a,{}),se.jsxs(Hn,{children:[se.jsx(Qt,{index:3,hidden:!0}),se.jsx(Qt,{index:4,hidden:!0}),se.jsx(Qt,{index:5,hidden:!0})]})]})}),se.jsx(kb,{children:se.jsx(Cb,{disabled:(i==null?void 0:i.length)!==6,onClick:o,type:"submit",children:n("session_passkey.confirm")})})]})})}),js=s=>{const e=s.match(/.{1,2}/g);if(!e)throw new Error("Invalid hexString");return Uint8Array.from(e.map(t=>parseInt(t,16))).buffer},Ka=s=>new TextEncoder().encode(s).buffer,pc=async s=>{const e=Ka(s);return await crypto.subtle.digest("SHA-256",e)},di=s=>[...new Uint8Array(s)].map(e=>e.toString(16).padStart(2,"0")).join(""),Lp=async()=>{const s=crypto.getRandomValues(new Uint8Array(32));return di(s)},pi=async s=>{const e=await pc(s);return di(e)},Qa=async s=>(await pi(s)).substring(0,32),bo=async(s,e)=>{const t=await pi(e),n=await Qa(e),i=Ka(s),a=await hc(i,t,n);return di(a)},Qn=async(s,e)=>{const t=await pi(e),n=await Qa(e),i=js(s),a=await mc(i,t,n);return new TextDecoder().decode(a)},hc=async(s,e,t)=>{const n=js(t),i=js(e),a=await crypto.subtle.importKey("raw",i,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.encrypt({name:"AES-CBC",iv:n},a,s)},mc=async(s,e,t)=>{const n=js(t),i=js(e),a=await crypto.subtle.importKey("raw",i,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.decrypt({name:"AES-CBC",iv:n},a,s)},Bp=async(s,e)=>{const t={};return await Promise.all(Object.entries(s||{}).map(async([n,i])=>{const a=await bo(i,e);t[n]=a})),t},$p=async(s,e)=>{let t;if(await new Promise((n,i)=>{e.show({onConfirm:async a=>{try{t=await Qn(s,a),await ua.set("passphrase",t),n(!0)}catch(r){i(r)}finally{e.hide()}},onCancel:()=>{i()}})}),!t)throw new Error("Passphrase is required");return t},ho=s=>{const e=mp(s),t=M.useRef(e);return t.current=e,{modal:e,modalRef:t}};class fc extends Ab{}mo=class extends fc{static lc_name(){return"StringPromptValue"}constructor(s){super({value:s}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=s}toString(){return this.value}toChatMessages(){return[new bp(this.value)]}};class Gm extends fc{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Sb(this.messages)}toChatMessages(){return this.messages}}function G(s,e,t,n,i){if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(s,t),t}function w(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)}let yc=function(){const{crypto:s}=globalThis;if(s!=null&&s.randomUUID)return yc=s.randomUUID.bind(s),s.randomUUID();const e=new Uint8Array(1),t=s?()=>s.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,n=>(+n^t()&15>>+n/4).toString(16))};function Ja(s){return typeof s=="object"&&s!==null&&("name"in s&&s.name==="AbortError"||"message"in s&&String(s.message).includes("FetchRequestCanceledException"))}const Ha=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null){try{if(Object.prototype.toString.call(s)==="[object Error]"){const e=new Error(s.message,s.cause?{cause:s.cause}:{});return s.stack&&(e.stack=s.stack),s.cause&&!e.cause&&(e.cause=s.cause),s.name&&(e.name=s.name),e}}catch{}try{return new Error(JSON.stringify(s))}catch{}}return new Error(s)};class K extends Error{}let Xe=class _o extends K{constructor(e,t,n,i){super(`${_o.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.requestID=i==null?void 0:i.get("x-request-id"),this.error=t;const a=t;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,t,n){const i=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new hi({message:n,cause:Ha(t)});const a=t==null?void 0:t.error;return e===400?new gc(e,a,n,i):e===401?new bc(e,a,n,i):e===403?new _c(e,a,n,i):e===404?new vc(e,a,n,i):e===409?new wc(e,a,n,i):e===422?new xc(e,a,n,i):e===429?new Oc(e,a,n,i):e>=500?new Ec(e,a,n,i):new _o(e,a,n,i)}},at=class extends Xe{constructor({message:s}={}){super(void 0,void 0,s||"Request was aborted.",void 0)}},hi=class extends Xe{constructor({message:s,cause:e}){super(void 0,void 0,s||"Connection error.",void 0),e&&(this.cause=e)}},mi=class extends hi{constructor({message:s}={}){super({message:s??"Request timed out."})}},gc=class extends Xe{},bc=class extends Xe{},_c=class extends Xe{},vc=class extends Xe{},wc=class extends Xe{},xc=class extends Xe{},Oc=class extends Xe{},Ec=class extends Xe{};class Mc extends K{constructor(){super("Could not parse response content as the length limit was reached")}}class kc extends K{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class vn extends Error{constructor(e){super(e)}}const Xm=/^[a-z][a-z0-9+.-]*:/i,Ym=s=>Xm.test(s);let Ye=s=>(Ye=Array.isArray,Ye(s)),Cc=Ye;function ef(s){return typeof s!="object"?{}:s??{}}function tf(s){if(!s)return!0;for(const e in s)return!1;return!0}function sf(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Ga(s){return s!=null&&typeof s=="object"&&!Array.isArray(s)}const nf=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new K(`${s} must be an integer`);if(e<0)throw new K(`${s} must be a positive integer`);return e},af=s=>{try{return JSON.parse(s)}catch{return}},wn=s=>new Promise(e=>setTimeout(e,s)),Is="5.8.2",rf=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function of(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const cf=()=>{var t;const s=of();if(s==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Is,"X-Stainless-OS":Sc(Deno.build.os),"X-Stainless-Arch":Ac(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((t=Deno.version)==null?void 0:t.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Is,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(s==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Is,"X-Stainless-OS":Sc(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Ac(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=lf();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Is,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Is,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function lf(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const i=n[1]||0,a=n[2]||0,r=n[3]||0;return{browser:e,version:`${i}.${a}.${r}`}}}return null}const Ac=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",Sc=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let Tc;const uf=()=>Tc??(Tc=cf());function df(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Pc(...s){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...s)}function Nc(s){let e=Symbol.asyncIterator in s?s[Symbol.asyncIterator]():s[Symbol.iterator]();return Pc({start(){},async pull(t){const{done:n,value:i}=await e.next();n?t.close():t.enqueue(i)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function jc(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function pf(s){var n,i;if(s===null||typeof s!="object")return;if(s[Symbol.asyncIterator]){await((i=(n=s[Symbol.asyncIterator]()).return)==null?void 0:i.call(n));return}const e=s.getReader(),t=e.cancel();e.releaseLock(),await t}const hf=({headers:s,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),Ic="RFC3986",Rc=s=>String(s),$c={RFC1738:s=>String(s).replace(/%20/g,"+"),RFC3986:Rc},mf="RFC1738";let Xa=(s,e)=>(Xa=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Xa(s,e));const Rt=(()=>{const s=[];for(let e=0;e<256;++e)s.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return s})(),Ya=1024,ff=(s,e,t,n,i)=>{if(s.length===0)return s;let a=s;if(typeof s=="symbol"?a=Symbol.prototype.toString.call(s):typeof s!="string"&&(a=String(s)),t==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let r="";for(let o=0;o<a.length;o+=Ya){const c=a.length>=Ya?a.slice(o,o+Ya):a,l=[];for(let u=0;u<c.length;++u){let d=c.charCodeAt(u);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||i===mf&&(d===40||d===41)){l[l.length]=c.charAt(u);continue}if(d<128){l[l.length]=Rt[d];continue}if(d<2048){l[l.length]=Rt[192|d>>6]+Rt[128|d&63];continue}if(d<55296||d>=57344){l[l.length]=Rt[224|d>>12]+Rt[128|d>>6&63]+Rt[128|d&63];continue}u+=1,d=65536+((d&1023)<<10|c.charCodeAt(u)&1023),l[l.length]=Rt[240|d>>18]+Rt[128|d>>12&63]+Rt[128|d>>6&63]+Rt[128|d&63]}r+=l.join("")}return r};function yf(s){return!s||typeof s!="object"?!1:!!(s.constructor&&s.constructor.isBuffer&&s.constructor.isBuffer(s))}function Lc(s,e){if(Ye(s)){const t=[];for(let n=0;n<s.length;n+=1)t.push(e(s[n]));return t}return e(s)}const Bc={brackets(s){return String(s)+"[]"},comma:"comma",indices(s,e){return String(s)+"["+e+"]"},repeat(s){return String(s)}},Dc=function(s,e){Array.prototype.push.apply(s,Ye(e)?e:[e])};let qc;const Ae={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:ff,encodeValuesOnly:!1,format:Ic,formatter:Rc,indices:!1,serializeDate(s){return(qc??(qc=Function.prototype.call.bind(Date.prototype.toISOString)))(s)},skipNulls:!1,strictNullHandling:!1};function gf(s){return typeof s=="string"||typeof s=="number"||typeof s=="boolean"||typeof s=="symbol"||typeof s=="bigint"}const er={};function Fc(s,e,t,n,i,a,r,o,c,l,u,d,p,h,m,y,f,g){let b=s,v=g,E=0,S=!1;for(;(v=v.get(er))!==void 0&&!S;){const q=v.get(s);if(E+=1,typeof q<"u"){if(q===E)throw new RangeError("Cyclic object value");S=!0}typeof v.get(er)>"u"&&(E=0)}if(typeof l=="function"?b=l(e,b):b instanceof Date?b=p==null?void 0:p(b):t==="comma"&&Ye(b)&&(b=Lc(b,function(q){return q instanceof Date?p==null?void 0:p(q):q})),b===null){if(a)return c&&!y?c(e,Ae.encoder,f,"key",h):e;b=""}if(gf(b)||yf(b)){if(c){const q=y?e:c(e,Ae.encoder,f,"key",h);return[(m==null?void 0:m(q))+"="+(m==null?void 0:m(c(b,Ae.encoder,f,"value",h)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(b)))]}const C=[];if(typeof b>"u")return C;let Q;if(t==="comma"&&Ye(b))y&&c&&(b=Lc(b,c)),Q=[{value:b.length>0?b.join(",")||null:void 0}];else if(Ye(l))Q=l;else{const q=Object.keys(b);Q=u?q.sort(u):q}const J=o?String(e).replace(/\./g,"%2E"):String(e),W=n&&Ye(b)&&b.length===1?J+"[]":J;if(i&&Ye(b)&&b.length===0)return W+"[]";for(let q=0;q<Q.length;++q){const pe=Q[q],we=typeof pe=="object"&&typeof pe.value<"u"?pe.value:b[pe];if(r&&we===null)continue;const le=d&&o?pe.replace(/\./g,"%2E"):pe,lt=Ye(b)?typeof t=="function"?t(W,le):W:W+(d?"."+le:"["+le+"]");g.set(s,E);const He=new WeakMap;He.set(er,g),Dc(C,Fc(we,lt,t,n,i,a,r,o,t==="comma"&&y&&Ye(b)?null:c,l,u,d,p,h,m,y,f,He))}return C}function bf(s=Ae){if(typeof s.allowEmptyArrays<"u"&&typeof s.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof s.encodeDotInKeys<"u"&&typeof s.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(s.encoder!==null&&typeof s.encoder<"u"&&typeof s.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=s.charset||Ae.charset;if(typeof s.charset<"u"&&s.charset!=="utf-8"&&s.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Ic;if(typeof s.format<"u"){if(!Xa($c,s.format))throw new TypeError("Unknown format option provided.");t=s.format}const n=$c[t];let i=Ae.filter;(typeof s.filter=="function"||Ye(s.filter))&&(i=s.filter);let a;if(s.arrayFormat&&s.arrayFormat in Bc?a=s.arrayFormat:"indices"in s?a=s.indices?"indices":"repeat":a=Ae.arrayFormat,"commaRoundTrip"in s&&typeof s.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const r=typeof s.allowDots>"u"?s.encodeDotInKeys?!0:Ae.allowDots:!!s.allowDots;return{addQueryPrefix:typeof s.addQueryPrefix=="boolean"?s.addQueryPrefix:Ae.addQueryPrefix,allowDots:r,allowEmptyArrays:typeof s.allowEmptyArrays=="boolean"?!!s.allowEmptyArrays:Ae.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof s.charsetSentinel=="boolean"?s.charsetSentinel:Ae.charsetSentinel,commaRoundTrip:!!s.commaRoundTrip,delimiter:typeof s.delimiter>"u"?Ae.delimiter:s.delimiter,encode:typeof s.encode=="boolean"?s.encode:Ae.encode,encodeDotInKeys:typeof s.encodeDotInKeys=="boolean"?s.encodeDotInKeys:Ae.encodeDotInKeys,encoder:typeof s.encoder=="function"?s.encoder:Ae.encoder,encodeValuesOnly:typeof s.encodeValuesOnly=="boolean"?s.encodeValuesOnly:Ae.encodeValuesOnly,filter:i,format:t,formatter:n,serializeDate:typeof s.serializeDate=="function"?s.serializeDate:Ae.serializeDate,skipNulls:typeof s.skipNulls=="boolean"?s.skipNulls:Ae.skipNulls,sort:typeof s.sort=="function"?s.sort:null,strictNullHandling:typeof s.strictNullHandling=="boolean"?s.strictNullHandling:Ae.strictNullHandling}}function _f(s,e={}){let t=s;const n=bf(e);let i,a;typeof n.filter=="function"?(a=n.filter,t=a("",t)):Ye(n.filter)&&(a=n.filter,i=a);const r=[];if(typeof t!="object"||t===null)return"";const o=Bc[n.arrayFormat],c=o==="comma"&&n.commaRoundTrip;i||(i=Object.keys(t)),n.sort&&i.sort(n.sort);const l=new WeakMap;for(let p=0;p<i.length;++p){const h=i[p];n.skipNulls&&t[h]===null||Dc(r,Fc(t[h],h,o,c,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,l))}const u=r.join(n.delimiter);let d=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}function vf(s){let e=0;for(const i of s)e+=i.length;const t=new Uint8Array(e);let n=0;for(const i of s)t.set(i,n),n+=i.length;return t}let Uc;function tr(s){let e;return(Uc??(e=new globalThis.TextEncoder,Uc=e.encode.bind(e)))(s)}let Wc;function Zc(s){let e;return(Wc??(e=new globalThis.TextDecoder,Wc=e.decode.bind(e)))(s)}var rt,ot;let fi=class{constructor(){rt.set(this,void 0),ot.set(this,void 0),G(this,rt,new Uint8Array),G(this,ot,null)}decode(s){if(s==null)return[];const e=s instanceof ArrayBuffer?new Uint8Array(s):typeof s=="string"?tr(s):s;G(this,rt,vf([w(this,rt,"f"),e]));const t=[];let n;for(;(n=wf(w(this,rt,"f"),w(this,ot,"f")))!=null;){if(n.carriage&&w(this,ot,"f")==null){G(this,ot,n.index);continue}if(w(this,ot,"f")!=null&&(n.index!==w(this,ot,"f")+1||n.carriage)){t.push(Zc(w(this,rt,"f").subarray(0,w(this,ot,"f")-1))),G(this,rt,w(this,rt,"f").subarray(w(this,ot,"f"))),G(this,ot,null);continue}const i=w(this,ot,"f")!==null?n.preceding-1:n.preceding,a=Zc(w(this,rt,"f").subarray(0,i));t.push(a),G(this,rt,w(this,rt,"f").subarray(n.index)),G(this,ot,null)}return t}flush(){return w(this,rt,"f").length?this.decode(`
`):[]}};rt=new WeakMap,ot=new WeakMap,fi.NEWLINE_CHARS=new Set([`
`,"\r"]),fi.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function wf(s,e){for(let t=e??0;t<s.length;t++){if(s[t]===10)return{preceding:t,index:t+1,carriage:!1};if(s[t]===13)return{preceding:t,index:t+1,carriage:!0}}return null}function xf(s){for(let e=0;e<s.length-1;e++){if(s[e]===10&&s[e+1]===10||s[e]===13&&s[e+1]===13)return e+2;if(s[e]===13&&s[e+1]===10&&e+3<s.length&&s[e+2]===13&&s[e+3]===10)return e+4}return-1}let xn=class Xn{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*i(){if(n)throw new K("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const r of Of(e,t))if(!a){if(r.data.startsWith("[DONE]")){a=!0;continue}if(r.event===null||r.event.startsWith("response.")||r.event.startsWith("transcript.")){let o;try{o=JSON.parse(r.data)}catch(c){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),c}if(o&&o.error)throw new Xe(void 0,o.error,void 0,e.headers);yield o}else{let o;try{o=JSON.parse(r.data)}catch(c){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),c}if(r.event=="error")throw new Xe(void 0,o.error,o.message,void 0);yield{event:r.event,data:o}}}a=!0}catch(r){if(Ja(r))return;throw r}finally{a||t.abort()}}return new Xn(i,t)}static fromReadableStream(e,t){let n=!1;async function*i(){const r=new fi,o=jc(e);for await(const c of o)for(const l of r.decode(c))yield l;for(const c of r.flush())yield c}async function*a(){if(n)throw new K("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const o of i())r||o&&(yield JSON.parse(o));r=!0}catch(o){if(Ja(o))return;throw o}finally{r||t.abort()}}return new Xn(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),i=a=>({next:()=>{if(a.length===0){const r=n.next();e.push(r),t.push(r)}return a.shift()}});return[new Xn(()=>i(e),this.controller),new Xn(()=>i(t),this.controller)]}toReadableStream(){const e=this;let t;return Pc({async start(){t=e[Symbol.asyncIterator]()},async pull(n){try{const{value:i,done:a}=await t.next();if(a)return n.close();const r=tr(JSON.stringify(i)+`
`);n.enqueue(r)}catch(i){n.error(i)}},async cancel(){var n;await((n=t.return)==null?void 0:n.call(t))}})}};async function*Of(s,e){if(!s.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new K("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new K("Attempted to iterate over a response with no body");const t=new Mf,n=new fi,i=jc(s.body);for await(const a of Ef(i))for(const r of n.decode(a)){const o=t.decode(r);o&&(yield o)}for(const a of n.flush()){const r=t.decode(a);r&&(yield r)}}async function*Ef(s){let e=new Uint8Array;for await(const t of s){if(t==null)continue;const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?tr(t):t;let i=new Uint8Array(e.length+n.length);i.set(e),i.set(n,e.length),e=i;let a;for(;(a=xf(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}let Mf=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(s){if(s.endsWith("\r")&&(s=s.substring(0,s.length-1)),!s){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(s),s.startsWith(":"))return null;let[e,t,n]=kf(s,":");return n.startsWith(" ")&&(n=n.substring(1)),e==="event"?this.event=n:e==="data"&&this.data.push(n),null}};function kf(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}const yi={off:0,error:200,warn:300,info:400,debug:500},Vc=(s,e,t)=>{if(s){if(sf(yi,s))return s;Ze(t).warn(`${e} was set to ${JSON.stringify(s)}, expected one of ${JSON.stringify(Object.keys(yi))}`)}};function On(){}function gi(s,e,t){return!e||yi[s]>yi[t]?On:e[s].bind(e)}const Cf={error:On,warn:On,info:On,debug:On};let zc=new WeakMap;function Ze(s){const e=s.logger,t=s.logLevel??"off";if(!e)return Cf;const n=zc.get(e);if(n&&n[0]===t)return n[1];const i={error:gi("error",e,t),warn:gi("warn",e,t),info:gi("info",e,t),debug:gi("debug",e,t)};return zc.set(e,[t,i]),i}const fs=s=>(s.options&&(s.options={...s.options},delete s.options.headers),s.headers&&(s.headers=Object.fromEntries((s.headers instanceof Headers?[...s.headers]:Object.entries(s.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in s&&(s.retryOfRequestLogID&&(s.retryOf=s.retryOfRequestLogID),delete s.retryOfRequestLogID),s);async function Kc(s,e){const{response:t,requestLogID:n,retryOfRequestLogID:i,startTime:a}=e,r=await(async()=>{var c,l;if(e.options.stream)return Ze(s).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):xn.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const o=(l=(c=t.headers.get("content-type"))==null?void 0:c.split(";")[0])==null?void 0:l.trim();if(o!=null&&o.includes("application/json")||o!=null&&o.endsWith("+json")){const u=await t.json();return Qc(u,t)}return await t.text()})();return Ze(s).debug(`[${n}] response parsed`,fs({retryOfRequestLogID:i,url:t.url,status:t.status,body:r,durationMs:Date.now()-a})),r}function Qc(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var En;let Jc=class Up extends Promise{constructor(e,t,n=Kc){super(i=>{i(null)}),this.responsePromise=t,this.parseResponse=n,En.set(this,void 0),G(this,En,e)}_thenUnwrap(e){return new Up(w(this,En,"f"),this.responsePromise,async(t,n)=>Qc(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(w(this,En,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};En=new WeakMap;var bi;class Hc{constructor(e,t,n,i){bi.set(this,void 0),G(this,bi,e),this.options=i,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new K("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await w(this,bi,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(bi=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}let Af=class extends Jc{constructor(s,e,t){super(s,e,async(n,i)=>new t(n,i.response,await Kc(n,i),i.options))}async*[Symbol.asyncIterator](){const s=await this;for await(const e of s)yield e}};class _i extends Hc{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class ke extends Hc{constructor(e,t,n,i){super(e,t,n,i),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var n;const e=this.getPaginatedItems(),t=(n=e[e.length-1])==null?void 0:n.id;return t?{...this.options,query:{...ef(this.options.query),after:t}}:null}}const Gc=()=>{var s;if(typeof File>"u"){const{process:e}=globalThis,t=typeof((s=e==null?void 0:e.versions)==null?void 0:s.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Mn(s,e,t){return Gc(),new File(s,e??"unknown_file",t)}function vi(s){return(typeof s=="object"&&s!==null&&("name"in s&&s.name&&String(s.name)||"url"in s&&s.url&&String(s.url)||"filename"in s&&s.filename&&String(s.filename)||"path"in s&&s.path&&String(s.path))||"").split(/[\\/]/).pop()||void 0}const Xc=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",ys=async(s,e)=>({...s,body:await Tf(s.body,e)}),Yc=new WeakMap;function Sf(s){const e=typeof s=="function"?s:s.fetch,t=Yc.get(e);if(t)return t;const n=(async()=>{try{const i="Response"in e?e.Response:(await e("data:,")).constructor,a=new FormData;return a.toString()!==await new i(a).text()}catch{return!0}})();return Yc.set(e,n),n}const Tf=async(s,e)=>{if(!await Sf(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const t=new FormData;return await Promise.all(Object.entries(s||{}).map(([n,i])=>sr(t,n,i))),t},Pf=s=>s instanceof Blob&&"name"in s,sr=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(t instanceof Response)s.append(e,Mn([await t.blob()],vi(t)));else if(Xc(t))s.append(e,Mn([await new Response(Nc(t)).blob()],vi(t)));else if(Pf(t))s.append(e,t,vi(t));else if(Array.isArray(t))await Promise.all(t.map(n=>sr(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>sr(s,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}},el=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",Nf=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&el(s),jf=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function";async function If(s,e,t){if(Gc(),s=await s,Nf(s))return s instanceof File?s:Mn([await s.arrayBuffer()],s.name);if(jf(s)){const i=await s.blob();return e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()),Mn(await nr(i),e,t)}const n=await nr(s);if(e||(e=vi(s)),!(t!=null&&t.type)){const i=n.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof i=="string"&&(t={...t,type:i})}return Mn(n,e,t)}async function nr(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(el(s))e.push(s instanceof Blob?s:await s.arrayBuffer());else if(Xc(s))for await(const n of s)e.push(...await nr(n));else{const n=(t=s==null?void 0:s.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof s}${n?`; constructor: ${n}`:""}${Rf(s)}`)}return e}function Rf(s){return typeof s!="object"||s===null?"":`; props: [${Object.getOwnPropertyNames(s).map(e=>`"${e}"`).join(", ")}]`}let X=class{constructor(s){this._client=s}};function tl(s){return s.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const $f=(s=tl)=>function(e,...t){if(e.length===1)return e[0];let n=!1;const i=e.reduce((l,u,d)=>(/[?#]/.test(u)&&(n=!0),l+u+(d===t.length?"":(n?encodeURIComponent:s)(String(t[d])))),""),a=i.split(/[?#]/,1)[0],r=[],o=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let c;for(;(c=o.exec(a))!==null;)r.push({start:c.index,length:c[0].length});if(r.length>0){let l=0;const u=r.reduce((d,p)=>{const h=" ".repeat(p.start-l),m="^".repeat(p.length);return l=p.start+p.length,d+h+m},"");throw new K(`Path parameters result in path with invalid segments:
${i}
${u}`)}return i},T=$f(tl);let sl=class extends X{list(s,e={},t){return this._client.getAPIList(T`/chat/completions/${s}/messages`,ke,{query:e,...t})}};function Lf(s){return typeof s.parse=="function"}const wi=s=>(s==null?void 0:s.role)==="assistant",nl=s=>(s==null?void 0:s.role)==="tool";var ir,xi,Oi,kn,Cn,Ei,An,Vt,Sn,Mi,ki,Rs,il;class ar{constructor(){ir.add(this),this.controller=new AbortController,xi.set(this,void 0),Oi.set(this,()=>{}),kn.set(this,()=>{}),Cn.set(this,void 0),Ei.set(this,()=>{}),An.set(this,()=>{}),Vt.set(this,{}),Sn.set(this,!1),Mi.set(this,!1),ki.set(this,!1),Rs.set(this,!1),G(this,xi,new Promise((e,t)=>{G(this,Oi,e,"f"),G(this,kn,t,"f")})),G(this,Cn,new Promise((e,t)=>{G(this,Ei,e,"f"),G(this,An,t,"f")})),w(this,xi,"f").catch(()=>{}),w(this,Cn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},w(this,ir,"m",il).bind(this))},0)}_connected(){this.ended||(w(this,Oi,"f").call(this),this._emit("connect"))}get ended(){return w(this,Sn,"f")}get errored(){return w(this,Mi,"f")}get aborted(){return w(this,ki,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,Vt,"f")[e]||(w(this,Vt,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=w(this,Vt,"f")[e];if(!n)return this;const i=n.findIndex(a=>a.listener===t);return i>=0&&n.splice(i,1),this}once(e,t){return(w(this,Vt,"f")[e]||(w(this,Vt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{G(this,Rs,!0),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){G(this,Rs,!0),await w(this,Cn,"f")}_emit(e,...t){if(w(this,Sn,"f"))return;e==="end"&&(G(this,Sn,!0),w(this,Ei,"f").call(this));const n=w(this,Vt,"f")[e];if(n&&(w(this,Vt,"f")[e]=n.filter(i=>!i.once),n.forEach(({listener:i})=>i(...t))),e==="abort"){const i=t[0];!w(this,Rs,"f")&&!(n!=null&&n.length)&&Promise.reject(i),w(this,kn,"f").call(this,i),w(this,An,"f").call(this,i),this._emit("end");return}if(e==="error"){const i=t[0];!w(this,Rs,"f")&&!(n!=null&&n.length)&&Promise.reject(i),w(this,kn,"f").call(this,i),w(this,An,"f").call(this,i),this._emit("end")}}_emitFinal(){}}xi=new WeakMap,Oi=new WeakMap,kn=new WeakMap,Cn=new WeakMap,Ei=new WeakMap,An=new WeakMap,Vt=new WeakMap,Sn=new WeakMap,Mi=new WeakMap,ki=new WeakMap,Rs=new WeakMap,ir=new WeakSet,il=function(s){if(G(this,Mi,!0),s instanceof Error&&s.name==="AbortError"&&(s=new at),s instanceof at)return G(this,ki,!0),this._emit("abort",s);if(s instanceof K)return this._emit("error",s);if(s instanceof Error){const e=new K(s.message);return e.cause=s,this._emit("error",e)}return this._emit("error",new K(String(s)))};function Bf(s,e){const t={...s};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function rr(s){return(s==null?void 0:s.$brand)==="auto-parseable-response-format"}function Tn(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function Df(s,e){return!e||!al(e)?{...s,choices:s.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:or(s,e)}function or(s,e){const t=s.choices.map(n=>{var i;if(n.finish_reason==="length")throw new Mc;if(n.finish_reason==="content_filter")throw new kc;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:((i=n.message.tool_calls)==null?void 0:i.map(a=>Ff(e,a)))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?qf(e,n.message.content):null}}});return{...s,choices:t}}function qf(s,e){var t,n;return((t=s.response_format)==null?void 0:t.type)!=="json_schema"?null:((n=s.response_format)==null?void 0:n.type)==="json_schema"?"$parseRaw"in s.response_format?s.response_format.$parseRaw(e):JSON.parse(e):null}function Ff(s,e){var n;const t=(n=s.tools)==null?void 0:n.find(i=>{var a;return((a=i.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Tn(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function Uf(s,e){var n;if(!s)return!1;const t=(n=s.tools)==null?void 0:n.find(i=>{var a;return((a=i.function)==null?void 0:a.name)===e.function.name});return Tn(t)||(t==null?void 0:t.function.strict)||!1}function al(s){var e;return rr(s.response_format)?!0:((e=s.tools)==null?void 0:e.some(t=>Tn(t)||t.type==="function"&&t.function.strict===!0))??!1}function Wf(s){for(const e of s??[]){if(e.type!=="function")throw new K(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new K(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Je,cr,Ci,lr,ur,dr,rl,ol;const Zf=10;class cl extends ar{constructor(){super(...arguments),Je.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var n;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(n=e.choices[0])==null?void 0:n.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),nl(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(wi(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionToolCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new K("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),w(this,Je,"m",cr).call(this)}async finalMessage(){return await this.done(),w(this,Je,"m",Ci).call(this)}async finalFunctionToolCall(){return await this.done(),w(this,Je,"m",lr).call(this)}async finalFunctionToolCallResult(){return await this.done(),w(this,Je,"m",ur).call(this)}async totalUsage(){return await this.done(),w(this,Je,"m",dr).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=w(this,Je,"m",Ci).call(this);t&&this._emit("finalMessage",t);const n=w(this,Je,"m",cr).call(this);n&&this._emit("finalContent",n);const i=w(this,Je,"m",lr).call(this);i&&this._emit("finalFunctionToolCall",i);const a=w(this,Je,"m",ur).call(this);a!=null&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(r=>r.usage)&&this._emit("totalUsage",w(this,Je,"m",dr).call(this))}async _createChatCompletion(e,t,n){const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),w(this,Je,"m",rl).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(or(a,t))}async _runChatCompletion(e,t,n){for(const i of t.messages)this._addMessage(i,!1);return await this._createChatCompletion(e,t,n)}async _runTools(e,t,n){var h,m,y;const i="tool",{tool_choice:a="auto",stream:r,...o}=t,c=typeof a!="string"&&((h=a==null?void 0:a.function)==null?void 0:h.name),{maxChatCompletions:l=Zf}=n||{},u=t.tools.map(f=>{if(Tn(f)){if(!f.$callback)throw new K("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:f.$callback,name:f.function.name,description:f.function.description||"",parameters:f.function.parameters,parse:f.$parseRaw,strict:!0}}}return f}),d={};for(const f of u)f.type==="function"&&(d[f.function.name||f.function.function.name]=f.function);const p="tools"in t?u.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description,strict:f.function.strict}}:f):void 0;for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<l;++f){const g=(m=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:p,messages:[...this.messages]},n)).choices[0])==null?void 0:m.message;if(!g)throw new K("missing message in ChatCompletion response");if(!((y=g.tool_calls)!=null&&y.length))return;for(const b of g.tool_calls){if(b.type!=="function")continue;const v=b.id,{name:E,arguments:S}=b.function,C=d[E];if(C){if(c&&c!==E){const q=`Invalid tool_call: ${JSON.stringify(E)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:i,tool_call_id:v,content:q});continue}}else{const q=`Invalid tool_call: ${JSON.stringify(E)}. Available options are: ${Object.keys(d).map(pe=>JSON.stringify(pe)).join(", ")}. Please try again`;this._addMessage({role:i,tool_call_id:v,content:q});continue}let Q;try{Q=Lf(C)?await C.parse(S):S}catch(q){const pe=q instanceof Error?q.message:String(q);this._addMessage({role:i,tool_call_id:v,content:pe});continue}const J=await C.function(Q,this),W=w(this,Je,"m",ol).call(this,J);if(this._addMessage({role:i,tool_call_id:v,content:W}),c)return}}}}Je=new WeakSet,cr=function(){return w(this,Je,"m",Ci).call(this).content??null},Ci=function(){let s=this.messages.length;for(;s-- >0;){const e=this.messages[s];if(wi(e))return{...e,content:e.content??null,refusal:e.refusal??null}}throw new K("stream ended without producing a ChatCompletionMessage with role=assistant")},lr=function(){var s,e;for(let t=this.messages.length-1;t>=0;t--){const n=this.messages[t];if(wi(n)&&((s=n==null?void 0:n.tool_calls)!=null&&s.length))return(e=n.tool_calls.at(-1))==null?void 0:e.function}},ur=function(){for(let s=this.messages.length-1;s>=0;s--){const e=this.messages[s];if(nl(e)&&e.content!=null&&typeof e.content=="string"&&this.messages.some(t=>{var n;return t.role==="assistant"&&((n=t.tool_calls)==null?void 0:n.some(i=>i.type==="function"&&i.id===e.tool_call_id))}))return e.content}},dr=function(){const s={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:e}of this._chatCompletions)e&&(s.completion_tokens+=e.completion_tokens,s.prompt_tokens+=e.prompt_tokens,s.total_tokens+=e.total_tokens);return s},rl=function(s){if(s.n!=null&&s.n>1)throw new K("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ol=function(s){return typeof s=="string"?s:s===void 0?"undefined":JSON.stringify(s)};class pr extends cl{static runTools(e,t,n){const i=new pr,a={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,a)),i}_addMessage(e,t=!0){super._addMessage(e,t),wi(e)&&e.content&&this._emit("content",e.content)}}const ll=1,ul=2,dl=4,pl=8,hl=16,ml=32,fl=64,yl=128,gl=256,bl=yl|gl,_l=hl|ml|bl|fl,vl=ll|ul|_l,wl=dl|pl,Vf=vl|wl,Ie={STR:ll,NUM:ul,ARR:dl,OBJ:pl,NULL:hl,BOOL:ml,NAN:fl,INFINITY:yl,MINUS_INFINITY:gl,INF:bl,SPECIAL:_l,ATOM:vl,COLLECTION:wl,ALL:Vf};class zf extends Error{}class Kf extends Error{}function Qf(s,e=Ie.ALL){if(typeof s!="string")throw new TypeError(`expecting str, got ${typeof s}`);if(!s.trim())throw new Error(`${s} is empty`);return Jf(s.trim(),e)}const Jf=(s,e)=>{const t=s.length;let n=0;const i=p=>{throw new zf(`${p} at position ${n}`)},a=p=>{throw new Kf(`${p} at position ${n}`)},r=()=>(d(),n>=t&&i("Unexpected end of input"),s[n]==='"'?o():s[n]==="{"?c():s[n]==="["?l():s.substring(n,n+4)==="null"||Ie.NULL&e&&t-n<4&&"null".startsWith(s.substring(n))?(n+=4,null):s.substring(n,n+4)==="true"||Ie.BOOL&e&&t-n<4&&"true".startsWith(s.substring(n))?(n+=4,!0):s.substring(n,n+5)==="false"||Ie.BOOL&e&&t-n<5&&"false".startsWith(s.substring(n))?(n+=5,!1):s.substring(n,n+8)==="Infinity"||Ie.INFINITY&e&&t-n<8&&"Infinity".startsWith(s.substring(n))?(n+=8,1/0):s.substring(n,n+9)==="-Infinity"||Ie.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(s.substring(n))?(n+=9,-1/0):s.substring(n,n+3)==="NaN"||Ie.NAN&e&&t-n<3&&"NaN".startsWith(s.substring(n))?(n+=3,NaN):u()),o=()=>{const p=n;let h=!1;for(n++;n<t&&(s[n]!=='"'||h&&s[n-1]==="\\");)h=s[n]==="\\"?!h:!1,n++;if(s.charAt(n)=='"')try{return JSON.parse(s.substring(p,++n-Number(h)))}catch(m){a(String(m))}else if(Ie.STR&e)try{return JSON.parse(s.substring(p,n-Number(h))+'"')}catch{return JSON.parse(s.substring(p,s.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},c=()=>{n++,d();const p={};try{for(;s[n]!=="}";){if(d(),n>=t&&Ie.OBJ&e)return p;const h=o();d(),n++;try{const m=r();Object.defineProperty(p,h,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Ie.OBJ&e)return p;throw m}d(),s[n]===","&&n++}}catch{if(Ie.OBJ&e)return p;i("Expected '}' at end of object")}return n++,p},l=()=>{n++;const p=[];try{for(;s[n]!=="]";)p.push(r()),d(),s[n]===","&&n++}catch{if(Ie.ARR&e)return p;i("Expected ']' at end of array")}return n++,p},u=()=>{if(n===0){s==="-"&&Ie.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s)}catch(h){if(Ie.NUM&e)try{return s[s.length-1]==="."?JSON.parse(s.substring(0,s.lastIndexOf("."))):JSON.parse(s.substring(0,s.lastIndexOf("e")))}catch{}a(String(h))}}const p=n;for(s[n]==="-"&&n++;s[n]&&!",]}".includes(s[n]);)n++;n==t&&!(Ie.NUM&e)&&i("Unterminated number literal");try{return JSON.parse(s.substring(p,n))}catch{s.substring(p,n)==="-"&&Ie.NUM&e&&i("Not sure what '-' is");try{return JSON.parse(s.substring(p,s.lastIndexOf("e")))}catch(h){a(String(h))}}},d=()=>{for(;n<t&&` 
\r	`.includes(s[n]);)n++};return r()},xl=s=>Qf(s,Ie.ALL^Ie.NUM);var Se,zt,$s,ts,hr,Ai,mr,fr,yr,Si,gr,Ol;class Pn extends cl{constructor(e){super(),Se.add(this),zt.set(this,void 0),$s.set(this,void 0),ts.set(this,void 0),G(this,zt,e),G(this,$s,[])}get currentChatCompletionSnapshot(){return w(this,ts,"f")}static fromReadableStream(e){const t=new Pn(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const i=new Pn(t);return i._run(()=>i._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createChatCompletion(e,t,n){var r;super._createChatCompletion;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),w(this,Se,"m",hr).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const o of a)w(this,Se,"m",mr).call(this,o);if((r=a.controller.signal)!=null&&r.aborted)throw new at;return this._addChatCompletion(w(this,Se,"m",Si).call(this))}async _fromReadableStream(e,t){var r;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),w(this,Se,"m",hr).call(this),this._connected();const i=xn.fromReadableStream(e,this.controller);let a;for await(const o of i)a&&a!==o.id&&this._addChatCompletion(w(this,Se,"m",Si).call(this)),w(this,Se,"m",mr).call(this,o),a=o.id;if((r=i.controller.signal)!=null&&r.aborted)throw new at;return this._addChatCompletion(w(this,Se,"m",Si).call(this))}[(zt=new WeakMap,$s=new WeakMap,ts=new WeakMap,Se=new WeakSet,hr=function(){this.ended||G(this,ts,void 0)},Ai=function(e){let t=w(this,$s,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},w(this,$s,"f")[e.index]=t,t)},mr=function(e){var n,i,a,r,o,c,l,u,d,p,h,m,y,f,g;if(this.ended)return;const t=w(this,Se,"m",Ol).call(this,e);this._emit("chunk",e,t);for(const b of e.choices){const v=t.choices[b.index];b.delta.content!=null&&((n=v.message)==null?void 0:n.role)==="assistant"&&((i=v.message)!=null&&i.content)&&(this._emit("content",b.delta.content,v.message.content),this._emit("content.delta",{delta:b.delta.content,snapshot:v.message.content,parsed:v.message.parsed})),b.delta.refusal!=null&&((a=v.message)==null?void 0:a.role)==="assistant"&&((r=v.message)!=null&&r.refusal)&&this._emit("refusal.delta",{delta:b.delta.refusal,snapshot:v.message.refusal}),((o=b.logprobs)==null?void 0:o.content)!=null&&((c=v.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=b.logprobs)==null?void 0:l.content,snapshot:((u=v.logprobs)==null?void 0:u.content)??[]}),((d=b.logprobs)==null?void 0:d.refusal)!=null&&((p=v.message)==null?void 0:p.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(h=b.logprobs)==null?void 0:h.refusal,snapshot:((m=v.logprobs)==null?void 0:m.refusal)??[]});const E=w(this,Se,"m",Ai).call(this,v);v.finish_reason&&(w(this,Se,"m",yr).call(this,v),E.current_tool_call_index!=null&&w(this,Se,"m",fr).call(this,v,E.current_tool_call_index));for(const S of b.delta.tool_calls??[])E.current_tool_call_index!==S.index&&(w(this,Se,"m",yr).call(this,v),E.current_tool_call_index!=null&&w(this,Se,"m",fr).call(this,v,E.current_tool_call_index)),E.current_tool_call_index=S.index;for(const S of b.delta.tool_calls??[]){const C=(y=v.message.tool_calls)==null?void 0:y[S.index];C!=null&&C.type&&((C==null?void 0:C.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(f=C.function)==null?void 0:f.name,index:S.index,arguments:C.function.arguments,parsed_arguments:C.function.parsed_arguments,arguments_delta:((g=S.function)==null?void 0:g.arguments)??""}):C==null||C.type)}}},fr=function(e,t){var i,a,r;if(w(this,Se,"m",Ai).call(this,e).done_tool_calls.has(t))return;const n=(i=e.message.tool_calls)==null?void 0:i[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if(n.type==="function"){const o=(r=(a=w(this,zt,"f"))==null?void 0:a.tools)==null?void 0:r.find(c=>c.type==="function"&&c.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Tn(o)?o.$parseRaw(n.function.arguments):o!=null&&o.function.strict?JSON.parse(n.function.arguments):null})}else n.type},yr=function(e){var n,i;const t=w(this,Se,"m",Ai).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const a=w(this,Se,"m",gr).call(this);this._emit("content.done",{content:e.message.content,parsed:a?a.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),(n=e.logprobs)!=null&&n.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),(i=e.logprobs)!=null&&i.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Si=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");const e=w(this,ts,"f");if(!e)throw new K("request ended without sending any chunks");return G(this,ts,void 0),G(this,$s,[]),Hf(e,w(this,zt,"f"))},gr=function(){var t;const e=(t=w(this,zt,"f"))==null?void 0:t.response_format;return rr(e)?e:null},Ol=function(e){var t,n,i,a;let r=w(this,ts,"f");const{choices:o,...c}=e;r?Object.assign(r,c):r=G(this,ts,{...c,choices:[]});for(const{delta:l,finish_reason:u,index:d,logprobs:p=null,...h}of e.choices){let m=r.choices[d];if(m||(m=r.choices[d]={finish_reason:u,index:d,message:{},logprobs:p,...h}),p)if(!m.logprobs)m.logprobs=Object.assign({},p);else{const{content:S,refusal:C,...Q}=p;Object.assign(m.logprobs,Q),S&&((t=m.logprobs).content??(t.content=[]),m.logprobs.content.push(...S)),C&&((n=m.logprobs).refusal??(n.refusal=[]),m.logprobs.refusal.push(...C))}if(u&&(m.finish_reason=u,w(this,zt,"f")&&al(w(this,zt,"f")))){if(u==="length")throw new Mc;if(u==="content_filter")throw new kc}if(Object.assign(m,h),!l)continue;const{content:y,refusal:f,function_call:g,role:b,tool_calls:v,...E}=l;if(Object.assign(m.message,E),f&&(m.message.refusal=(m.message.refusal||"")+f),b&&(m.message.role=b),g&&(m.message.function_call?(g.name&&(m.message.function_call.name=g.name),g.arguments&&((i=m.message.function_call).arguments??(i.arguments=""),m.message.function_call.arguments+=g.arguments)):m.message.function_call=g),y&&(m.message.content=(m.message.content||"")+y,!m.message.refusal&&w(this,Se,"m",gr).call(this)&&(m.message.parsed=xl(m.message.content))),v){m.message.tool_calls||(m.message.tool_calls=[]);for(const{index:S,id:C,type:Q,function:J,...W}of v){const q=(a=m.message.tool_calls)[S]??(a[S]={});Object.assign(q,W),C&&(q.id=C),Q&&(q.type=Q),J&&(q.function??(q.function={name:J.name??"",arguments:""})),J!=null&&J.name&&(q.function.name=J.name),J!=null&&J.arguments&&(q.function.arguments+=J.arguments,Uf(w(this,zt,"f"),q)&&(q.function.parsed_arguments=xl(q.function.arguments)))}}}return r},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",i=>{const a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new xn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Hf(s,e){const{id:t,choices:n,created:i,model:a,system_fingerprint:r,...o}=s,c={...o,id:t,choices:n.map(({message:l,finish_reason:u,index:d,logprobs:p,...h})=>{if(!u)throw new K(`missing finish_reason for choice ${d}`);const{content:m=null,function_call:y,tool_calls:f,...g}=l,b=l.role;if(!b)throw new K(`missing role for choice ${d}`);if(y){const{arguments:v,name:E}=y;if(v==null)throw new K(`missing function_call.arguments for choice ${d}`);if(!E)throw new K(`missing function_call.name for choice ${d}`);return{...h,message:{content:m,function_call:{arguments:v,name:E},role:b,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:p}}return f?{...h,index:d,finish_reason:u,logprobs:p,message:{...g,role:b,content:m,refusal:l.refusal??null,tool_calls:f.map((v,E)=>{const{function:S,type:C,id:Q,...J}=v,{arguments:W,name:q,...pe}=S||{};if(Q==null)throw new K(`missing choices[${d}].tool_calls[${E}].id
${Ti(s)}`);if(C==null)throw new K(`missing choices[${d}].tool_calls[${E}].type
${Ti(s)}`);if(q==null)throw new K(`missing choices[${d}].tool_calls[${E}].function.name
${Ti(s)}`);if(W==null)throw new K(`missing choices[${d}].tool_calls[${E}].function.arguments
${Ti(s)}`);return{...J,id:Q,type:C,function:{...pe,name:q,arguments:W}}})}}:{...h,message:{...g,content:m,role:b,refusal:l.refusal??null},finish_reason:u,index:d,logprobs:p}}),created:i,model:a,object:"chat.completion",...r?{system_fingerprint:r}:{}};return Df(c,e)}function Ti(s){return JSON.stringify(s)}class Pi extends Pn{static fromReadableStream(e){const t=new Pi(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,n){const i=new Pi(t),a={...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(e,t,a)),i}}let br=class extends X{constructor(){super(...arguments),this.messages=new sl(this._client)}create(s,e){return this._client.post("/chat/completions",{body:s,...e,stream:s.stream??!1})}retrieve(s,e){return this._client.get(T`/chat/completions/${s}`,e)}update(s,e,t){return this._client.post(T`/chat/completions/${s}`,{body:e,...t})}list(s={},e){return this._client.getAPIList("/chat/completions",ke,{query:s,...e})}delete(s,e){return this._client.delete(T`/chat/completions/${s}`,e)}parse(s,e){return Wf(s.tools),this._client.chat.completions.create(s,{...e,headers:{...e==null?void 0:e.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>or(t,s))}runTools(s,e){return s.stream?Pi.runTools(this._client,s,e):pr.runTools(this._client,s,e)}stream(s,e){return Pn.createChatCompletion(this._client,s,e)}};br.Messages=sl;let _r=class extends X{constructor(){super(...arguments),this.completions=new br(this._client)}};_r.Completions=br;const El=Symbol("brand.privateNullableHeaders");function*Gf(s){if(!s)return;if(El in s){const{values:n,nulls:i}=s;yield*n.entries();for(const a of i)yield[a,null];return}let e=!1,t;s instanceof Headers?t=s.entries():Cc(s)?t=s:(e=!0,t=Object.entries(s??{}));for(let n of t){const i=n[0];if(typeof i!="string")throw new TypeError("expected header name to be a string");const a=Cc(n[1])?n[1]:[n[1]];let r=!1;for(const o of a)o!==void 0&&(e&&!r&&(r=!0,yield[i,null]),yield[i,o])}}const U=s=>{const e=new Headers,t=new Set;for(const n of s){const i=new Set;for(const[a,r]of Gf(n)){const o=a.toLowerCase();i.has(o)||(e.delete(a),i.add(o)),r===null?(e.delete(a),t.add(o)):(e.append(a,r),t.delete(o))}}return{[El]:!0,values:e,nulls:t}};let Ml=class extends X{create(s,e){return this._client.post("/audio/speech",{body:s,...e,headers:U([{Accept:"application/octet-stream"},e==null?void 0:e.headers]),__binaryResponse:!0})}},kl=class extends X{create(s,e){return this._client.post("/audio/transcriptions",ys({body:s,...e,stream:s.stream??!1,__metadata:{model:s.model}},this._client))}},Cl=class extends X{create(s,e){return this._client.post("/audio/translations",ys({body:s,...e,__metadata:{model:s.model}},this._client))}},Nn=class extends X{constructor(){super(...arguments),this.transcriptions=new kl(this._client),this.translations=new Cl(this._client),this.speech=new Ml(this._client)}};Nn.Transcriptions=kl,Nn.Translations=Cl,Nn.Speech=Ml;let Al=class extends X{create(s,e){return this._client.post("/batches",{body:s,...e})}retrieve(s,e){return this._client.get(T`/batches/${s}`,e)}list(s={},e){return this._client.getAPIList("/batches",ke,{query:s,...e})}cancel(s,e){return this._client.post(T`/batches/${s}/cancel`,e)}};class Sl extends X{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(T`/assistants/${e}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,n){return this._client.post(T`/assistants/${e}`,{body:t,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e={},t){return this._client.getAPIList("/assistants",ke,{query:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(T`/assistants/${e}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class Tl extends X{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class Pl extends X{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class Ni extends X{constructor(){super(...arguments),this.sessions=new Tl(this._client),this.transcriptionSessions=new Pl(this._client)}}Ni.Sessions=Tl,Ni.TranscriptionSessions=Pl;class Nl extends X{create(e,t,n){return this._client.post(T`/threads/${e}/messages`,{body:t,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,t,n){const{thread_id:i}=t;return this._client.get(T`/threads/${i}/messages/${e}`,{...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}update(e,t,n){const{thread_id:i,...a}=t;return this._client.post(T`/threads/${i}/messages/${e}`,{body:a,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,t={},n){return this._client.getAPIList(T`/threads/${e}/messages`,ke,{query:t,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,t,n){const{thread_id:i}=t;return this._client.delete(T`/threads/${i}/messages/${e}`,{...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}class jl extends X{retrieve(e,t,n){const{thread_id:i,run_id:a,...r}=t;return this._client.get(T`/threads/${i}/runs/${a}/steps/${e}`,{query:r,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e,t,n){const{thread_id:i,...a}=t;return this._client.getAPIList(T`/threads/${i}/runs/${e}/steps`,ke,{query:a,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}const Xf=s=>{if(typeof it<"u"){const e=it.from(s,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(s),t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return Array.from(new Float32Array(n.buffer))}};var vr={};const Ls=s=>{var e,t,n,i;if(typeof globalThis.process<"u")return((e=vr==null?void 0:vr[s])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(i=(n=(t=globalThis.Deno.env)==null?void 0:t.get)==null?void 0:n.call(t,s))==null?void 0:i.trim()};var qe,gs,wr,$t,ji,_t,bs,Bs,_s,Ii,ct,Ri,$i,jn,In,Rn,Il,Rl,$l,Ll,Bl,Dl,ql;class $n extends ar{constructor(){super(...arguments),qe.add(this),wr.set(this,[]),$t.set(this,{}),ji.set(this,{}),_t.set(this,void 0),bs.set(this,void 0),Bs.set(this,void 0),_s.set(this,void 0),Ii.set(this,void 0),ct.set(this,void 0),Ri.set(this,void 0),$i.set(this,void 0),jn.set(this,void 0)}[(wr=new WeakMap,$t=new WeakMap,ji=new WeakMap,_t=new WeakMap,bs=new WeakMap,Bs=new WeakMap,_s=new WeakMap,Ii=new WeakMap,ct=new WeakMap,Ri=new WeakMap,$i=new WeakMap,jn=new WeakMap,qe=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new gs;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var a;const n=t==null?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const i=xn.fromReadableStream(e,this.controller);for await(const r of i)w(this,qe,"m",In).call(this,r);if((a=i.controller.signal)!=null&&a.aborted)throw new at;return this._addRun(w(this,qe,"m",Rn).call(this))}toReadableStream(){return new xn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,i){const a=new gs;return a._run(()=>a._runToolAssistantStream(e,t,n,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,i){var c;const a=i==null?void 0:i.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const r={...n,stream:!0},o=await e.submitToolOutputs(t,r,{...i,signal:this.controller.signal});this._connected();for await(const l of o)w(this,qe,"m",In).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new at;return this._addRun(w(this,qe,"m",Rn).call(this))}static createThreadAssistantStream(e,t,n){const i=new gs;return i._run(()=>i._threadAssistantStream(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}static createAssistantStream(e,t,n,i){const a=new gs;return a._run(()=>a._runAssistantStream(e,t,n,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return w(this,Ri,"f")}currentRun(){return w(this,$i,"f")}currentMessageSnapshot(){return w(this,_t,"f")}currentRunStepSnapshot(){return w(this,jn,"f")}async finalRunSteps(){return await this.done(),Object.values(w(this,$t,"f"))}async finalMessages(){return await this.done(),Object.values(w(this,ji,"f"))}async finalRun(){if(await this.done(),!w(this,bs,"f"))throw Error("Final run was not received.");return w(this,bs,"f")}async _createThreadAssistantStream(e,t,n){var o;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},r=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(const c of r)w(this,qe,"m",In).call(this,c);if((o=r.controller.signal)!=null&&o.aborted)throw new at;return this._addRun(w(this,qe,"m",Rn).call(this))}async _createAssistantStream(e,t,n,i){var c;const a=i==null?void 0:i.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const r={...n,stream:!0},o=await e.create(t,r,{...i,signal:this.controller.signal});this._connected();for await(const l of o)w(this,qe,"m",In).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new at;return this._addRun(w(this,qe,"m",Rn).call(this))}static accumulateDelta(e,t){for(const[n,i]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=i;continue}let a=e[n];if(a==null){e[n]=i;continue}if(n==="index"||n==="type"){e[n]=i;continue}if(typeof a=="string"&&typeof i=="string")a+=i;else if(typeof a=="number"&&typeof i=="number")a+=i;else if(Ga(a)&&Ga(i))a=this.accumulateDelta(a,i);else if(Array.isArray(a)&&Array.isArray(i)){if(a.every(r=>typeof r=="string"||typeof r=="number")){a.push(...i);continue}for(const r of i){if(!Ga(r))throw new Error(`Expected array delta entry to be an object but got: ${r}`);const o=r.index;if(o==null)throw console.error(r),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=a[o];c==null?a.push(r):a[o]=this.accumulateDelta(c,r)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${i}, accValue: ${a}`);e[n]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,i){return await this._createAssistantStream(t,e,n,i)}async _runToolAssistantStream(e,t,n,i){return await this._createToolAssistantStream(t,e,n,i)}}gs=$n,In=function(s){if(!this.ended)switch(G(this,Ri,s),w(this,qe,"m",$l).call(this,s),s.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":w(this,qe,"m",ql).call(this,s);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":w(this,qe,"m",Rl).call(this,s);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":w(this,qe,"m",Il).call(this,s);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Rn=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");if(!w(this,bs,"f"))throw Error("Final run has not been received");return w(this,bs,"f")},Il=function(s){const[e,t]=w(this,qe,"m",Bl).call(this,s,w(this,_t,"f"));G(this,_t,e),w(this,ji,"f")[e.id]=e;for(const n of t){const i=e.content[n.index];(i==null?void 0:i.type)=="text"&&this._emit("textCreated",i.text)}switch(s.event){case"thread.message.created":this._emit("messageCreated",s.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",s.data.delta,e),s.data.delta.content)for(const n of s.data.delta.content){if(n.type=="text"&&n.text){let i=n.text,a=e.content[n.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(n.index!=w(this,Bs,"f")){if(w(this,_s,"f"))switch(w(this,_s,"f").type){case"text":this._emit("textDone",w(this,_s,"f").text,w(this,_t,"f"));break;case"image_file":this._emit("imageFileDone",w(this,_s,"f").image_file,w(this,_t,"f"));break}G(this,Bs,n.index)}G(this,_s,e.content[n.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(w(this,Bs,"f")!==void 0){const n=s.data.content[w(this,Bs,"f")];if(n)switch(n.type){case"image_file":this._emit("imageFileDone",n.image_file,w(this,_t,"f"));break;case"text":this._emit("textDone",n.text,w(this,_t,"f"));break}}w(this,_t,"f")&&this._emit("messageDone",s.data),G(this,_t,void 0)}},Rl=function(s){const e=w(this,qe,"m",Ll).call(this,s);switch(G(this,jn,e),s.event){case"thread.run.step.created":this._emit("runStepCreated",s.data);break;case"thread.run.step.delta":const t=s.data.delta;if(t.step_details&&t.step_details.type=="tool_calls"&&t.step_details.tool_calls&&e.step_details.type=="tool_calls")for(const n of t.step_details.tool_calls)n.index==w(this,Ii,"f")?this._emit("toolCallDelta",n,e.step_details.tool_calls[n.index]):(w(this,ct,"f")&&this._emit("toolCallDone",w(this,ct,"f")),G(this,Ii,n.index),G(this,ct,e.step_details.tool_calls[n.index]),w(this,ct,"f")&&this._emit("toolCallCreated",w(this,ct,"f")));this._emit("runStepDelta",s.data.delta,e);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":G(this,jn,void 0),s.data.step_details.type=="tool_calls"&&w(this,ct,"f")&&(this._emit("toolCallDone",w(this,ct,"f")),G(this,ct,void 0)),this._emit("runStepDone",s.data,e);break}},$l=function(s){w(this,wr,"f").push(s),this._emit("event",s)},Ll=function(s){switch(s.event){case"thread.run.step.created":return w(this,$t,"f")[s.data.id]=s.data,s.data;case"thread.run.step.delta":let e=w(this,$t,"f")[s.data.id];if(!e)throw Error("Received a RunStepDelta before creation of a snapshot");let t=s.data;if(t.delta){const n=gs.accumulateDelta(e,t.delta);w(this,$t,"f")[s.data.id]=n}return w(this,$t,"f")[s.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":w(this,$t,"f")[s.data.id]=s.data;break}if(w(this,$t,"f")[s.data.id])return w(this,$t,"f")[s.data.id];throw new Error("No snapshot available")},Bl=function(s,e){let t=[];switch(s.event){case"thread.message.created":return[s.data,t];case"thread.message.delta":if(!e)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=s.data;if(n.delta.content)for(const i of n.delta.content)if(i.index in e.content){let a=e.content[i.index];e.content[i.index]=w(this,qe,"m",Dl).call(this,i,a)}else e.content[i.index]=i,t.push(i);return[e,t];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(e)return[e,t];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Dl=function(s,e){return gs.accumulateDelta(e,s)},ql=function(s){switch(G(this,$i,s.data),s.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":G(this,bs,s.data),w(this,ct,"f")&&(this._emit("toolCallDone",w(this,ct,"f")),G(this,ct,void 0));break}};let xr=class extends X{constructor(){super(...arguments),this.steps=new jl(this._client)}create(s,e,t){const{include:n,...i}=e;return this._client.post(T`/threads/${s}/runs`,{query:{include:n},body:i,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}retrieve(s,e,t){const{thread_id:n}=e;return this._client.get(T`/threads/${n}/runs/${s}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(s,e,t){const{thread_id:n,...i}=e;return this._client.post(T`/threads/${n}/runs/${s}`,{body:i,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}list(s,e={},t){return this._client.getAPIList(T`/threads/${s}/runs`,ke,{query:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}cancel(s,e,t){const{thread_id:n}=e;return this._client.post(T`/threads/${n}/runs/${s}/cancel`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}async createAndPoll(s,e,t){const n=await this.create(s,e,t);return await this.poll(n.id,{thread_id:s},t)}createAndStream(s,e,t){return $n.createAssistantStream(s,this._client.beta.threads.runs,e,t)}async poll(s,e,t){var i;const n=U([t==null?void 0:t.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=t==null?void 0:t.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:r}=await this.retrieve(s,e,{...t,headers:{...t==null?void 0:t.headers,...n}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(t!=null&&t.pollIntervalMs)o=t.pollIntervalMs;else{const c=r.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await wn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(s,e,t){return $n.createAssistantStream(s,this._client.beta.threads.runs,e,t)}submitToolOutputs(s,e,t){const{thread_id:n,...i}=e;return this._client.post(T`/threads/${n}/runs/${s}/submit_tool_outputs`,{body:i,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async submitToolOutputsAndPoll(s,e,t){const n=await this.submitToolOutputs(s,e,t);return await this.poll(n.id,e,t)}submitToolOutputsStream(s,e,t){return $n.createToolAssistantStream(s,this._client.beta.threads.runs,e,t)}};xr.Steps=jl;class Li extends X{constructor(){super(...arguments),this.runs=new xr(this._client),this.messages=new Nl(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(T`/threads/${e}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,n){return this._client.post(T`/threads/${e}`,{body:t,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}delete(e,t){return this._client.delete(T`/threads/${e}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.id,{thread_id:n.thread_id},t)}createAndRunStream(e,t){return $n.createThreadAssistantStream(e,this._client.beta.threads,t)}}Li.Runs=xr,Li.Messages=Nl;class Ln extends X{constructor(){super(...arguments),this.realtime=new Ni(this._client),this.assistants=new Sl(this._client),this.threads=new Li(this._client)}}Ln.Realtime=Ni,Ln.Assistants=Sl,Ln.Threads=Li;let Fl=class extends X{create(s,e){return this._client.post("/completions",{body:s,...e,stream:s.stream??!1})}};class Ul extends X{retrieve(e,t,n){const{container_id:i}=t;return this._client.get(T`/containers/${i}/files/${e}/content`,{...n,headers:U([{Accept:"application/binary"},n==null?void 0:n.headers]),__binaryResponse:!0})}}let Or=class extends X{constructor(){super(...arguments),this.content=new Ul(this._client)}create(s,e,t){return this._client.post(T`/containers/${s}/files`,ys({body:e,...t},this._client))}retrieve(s,e,t){const{container_id:n}=e;return this._client.get(T`/containers/${n}/files/${s}`,t)}list(s,e={},t){return this._client.getAPIList(T`/containers/${s}/files`,ke,{query:e,...t})}delete(s,e,t){const{container_id:n}=e;return this._client.delete(T`/containers/${n}/files/${s}`,{...t,headers:U([{Accept:"*/*"},t==null?void 0:t.headers])})}};Or.Content=Ul;class Er extends X{constructor(){super(...arguments),this.files=new Or(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(T`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",ke,{query:e,...t})}delete(e,t){return this._client.delete(T`/containers/${e}`,{...t,headers:U([{Accept:"*/*"},t==null?void 0:t.headers])})}}Er.Files=Or;let Wl=class extends X{create(s,e){const t=!!s.encoding_format;let n=t?s.encoding_format:"base64";t&&Ze(this._client).debug("embeddings/user defined encoding_format:",s.encoding_format);const i=this._client.post("/embeddings",{body:{...s,encoding_format:n},...e});return t?i:(Ze(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(r=>{const o=r.embedding;r.embedding=Xf(o)}),a)))}};class Zl extends X{retrieve(e,t,n){const{eval_id:i,run_id:a}=t;return this._client.get(T`/evals/${i}/runs/${a}/output_items/${e}`,n)}list(e,t,n){const{eval_id:i,...a}=t;return this._client.getAPIList(T`/evals/${i}/runs/${e}/output_items`,ke,{query:a,...n})}}class Mr extends X{constructor(){super(...arguments),this.outputItems=new Zl(this._client)}create(e,t,n){return this._client.post(T`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){const{eval_id:i}=t;return this._client.get(T`/evals/${i}/runs/${e}`,n)}list(e,t={},n){return this._client.getAPIList(T`/evals/${e}/runs`,ke,{query:t,...n})}delete(e,t,n){const{eval_id:i}=t;return this._client.delete(T`/evals/${i}/runs/${e}`,n)}cancel(e,t,n){const{eval_id:i}=t;return this._client.post(T`/evals/${i}/runs/${e}`,n)}}Mr.OutputItems=Zl;class kr extends X{constructor(){super(...arguments),this.runs=new Mr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(T`/evals/${e}`,t)}update(e,t,n){return this._client.post(T`/evals/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/evals",ke,{query:e,...t})}delete(e,t){return this._client.delete(T`/evals/${e}`,t)}}kr.Runs=Mr;let Vl=class extends X{create(s,e){return this._client.post("/files",ys({body:s,...e},this._client))}retrieve(s,e){return this._client.get(T`/files/${s}`,e)}list(s={},e){return this._client.getAPIList("/files",ke,{query:s,...e})}delete(s,e){return this._client.delete(T`/files/${s}`,e)}content(s,e){return this._client.get(T`/files/${s}/content`,{...e,headers:U([{Accept:"application/binary"},e==null?void 0:e.headers]),__binaryResponse:!0})}async waitForProcessing(s,{pollInterval:e=5e3,maxWait:t=30*60*1e3}={}){const n=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(s);for(;!a.status||!n.has(a.status);)if(await wn(e),a=await this.retrieve(s),Date.now()-i>t)throw new mi({message:`Giving up on waiting for file ${s} to finish processing after ${t} milliseconds.`});return a}};class zl extends X{}let Kl=class extends X{run(s,e){return this._client.post("/fine_tuning/alpha/graders/run",{body:s,...e})}validate(s,e){return this._client.post("/fine_tuning/alpha/graders/validate",{body:s,...e})}};class Cr extends X{constructor(){super(...arguments),this.graders=new Kl(this._client)}}Cr.Graders=Kl;class Ql extends X{create(e,t,n){return this._client.getAPIList(T`/fine_tuning/checkpoints/${e}/permissions`,_i,{body:t,method:"post",...n})}retrieve(e,t={},n){return this._client.get(T`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}delete(e,t,n){const{fine_tuned_model_checkpoint:i}=t;return this._client.delete(T`/fine_tuning/checkpoints/${i}/permissions/${e}`,n)}}let Ar=class extends X{constructor(){super(...arguments),this.permissions=new Ql(this._client)}};Ar.Permissions=Ql;class Jl extends X{list(e,t={},n){return this._client.getAPIList(T`/fine_tuning/jobs/${e}/checkpoints`,ke,{query:t,...n})}}class Sr extends X{constructor(){super(...arguments),this.checkpoints=new Jl(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(T`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",ke,{query:e,...t})}cancel(e,t){return this._client.post(T`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return this._client.getAPIList(T`/fine_tuning/jobs/${e}/events`,ke,{query:t,...n})}pause(e,t){return this._client.post(T`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(T`/fine_tuning/jobs/${e}/resume`,t)}}Sr.Checkpoints=Jl;class Ds extends X{constructor(){super(...arguments),this.methods=new zl(this._client),this.jobs=new Sr(this._client),this.checkpoints=new Ar(this._client),this.alpha=new Cr(this._client)}}Ds.Methods=zl,Ds.Jobs=Sr,Ds.Checkpoints=Ar,Ds.Alpha=Cr;class Hl extends X{}class Tr extends X{constructor(){super(...arguments),this.graderModels=new Hl(this._client)}}Tr.GraderModels=Hl;class Gl extends X{createVariation(e,t){return this._client.post("/images/variations",ys({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",ys({body:e,...t},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}let Xl=class extends X{retrieve(s,e){return this._client.get(T`/models/${s}`,e)}list(s){return this._client.getAPIList("/models",_i,s)}delete(s,e){return this._client.delete(T`/models/${s}`,e)}};class Yl extends X{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function Yf(s,e){return!e||!ty(e)?{...s,output_parsed:null,output:s.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:eu(s,e)}function eu(s,e){const t=s.output.map(i=>{if(i.type==="function_call")return{...i,parsed_arguments:iy(e,i)};if(i.type==="message"){const a=i.content.map(r=>r.type==="output_text"?{...r,parsed:ey(e,r.text)}:r);return{...i,content:a}}return i}),n=Object.assign({},s,{output:t});return Object.getOwnPropertyDescriptor(s,"output_text")||Pr(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const i of n.output)if(i.type==="message"){for(const a of i.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),n}function ey(s,e){var t,n,i,a;return((n=(t=s.text)==null?void 0:t.format)==null?void 0:n.type)!=="json_schema"?null:"$parseRaw"in((i=s.text)==null?void 0:i.format)?((a=s.text)==null?void 0:a.format).$parseRaw(e):JSON.parse(e)}function ty(s){var e;return!!rr((e=s.text)==null?void 0:e.format)}function sy(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function ny(s,e){return s.find(t=>t.type==="function"&&t.name===e)}function iy(s,e){const t=ny(s.tools??[],e.name);return{...e,...e,parsed_arguments:sy(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function Pr(s){const e=[];for(const t of s.output)if(t.type==="message")for(const n of t.content)n.type==="output_text"&&e.push(n.text);s.output_text=e.join("")}var qs,Bi,ss,Di,tu,su,nu,iu;class Nr extends ar{constructor(e){super(),qs.add(this),Bi.set(this,void 0),ss.set(this,void 0),Di.set(this,void 0),G(this,Bi,e)}static createResponse(e,t,n){const i=new Nr(t);return i._run(()=>i._createOrRetrieveResponse(e,t,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createOrRetrieveResponse(e,t,n){var o;const i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),w(this,qs,"m",tu).call(this);let a,r=null;"response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),r=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const c of a)w(this,qs,"m",su).call(this,c,r);if((o=a.controller.signal)!=null&&o.aborted)throw new at;return w(this,qs,"m",nu).call(this)}[(Bi=new WeakMap,ss=new WeakMap,Di=new WeakMap,qs=new WeakSet,tu=function(){this.ended||G(this,ss,void 0)},su=function(e,t){if(this.ended)return;const n=(a,r)=>{(t==null||r.sequence_number>t)&&this._emit(a,r)},i=w(this,qs,"m",iu).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const a=i.output[e.output_index];if(!a)throw new K(`missing output at index ${e.output_index}`);if(a.type==="message"){const r=a.content[e.content_index];if(!r)throw new K(`missing content at index ${e.content_index}`);if(r.type!=="output_text")throw new K(`expected content to be 'output_text', got ${r.type}`);n("response.output_text.delta",{...e,snapshot:r.text})}break}case"response.function_call_arguments.delta":{const a=i.output[e.output_index];if(!a)throw new K(`missing output at index ${e.output_index}`);a.type==="function_call"&&n("response.function_call_arguments.delta",{...e,snapshot:a.arguments});break}default:n(e.type,e);break}},nu=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");const e=w(this,ss,"f");if(!e)throw new K("request ended without sending any events");G(this,ss,void 0);const t=ay(e,w(this,Bi,"f"));return G(this,Di,t),t},iu=function(e){let t=w(this,ss,"f");if(!t){if(e.type!=="response.created")throw new K(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=G(this,ss,e.response),t}switch(e.type){case"response.output_item.added":{t.output.push(e.item);break}case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new K(`missing output at index ${e.output_index}`);n.type==="message"&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new K(`missing output at index ${e.output_index}`);if(n.type==="message"){const i=n.content[e.content_index];if(!i)throw new K(`missing content at index ${e.content_index}`);if(i.type!=="output_text")throw new K(`expected content to be 'output_text', got ${i.type}`);i.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new K(`missing output at index ${e.output_index}`);n.type==="function_call"&&(n.arguments+=e.delta);break}case"response.completed":{G(this,ss,e.response);break}}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",i=>{const a=t.shift();a?a.resolve(i):e.push(i)}),this.on("end",()=>{n=!0;for(const i of t)i.resolve(void 0);t.length=0}),this.on("abort",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),this.on("error",i=>{n=!0;for(const a of t)a.reject(i);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=w(this,Di,"f");if(!e)throw new K("stream ended without producing a ChatCompletion");return e}}function ay(s,e){return Yf(s,e)}class au extends X{list(e,t={},n){return this._client.getAPIList(T`/responses/${e}/input_items`,ke,{query:t,...n})}}class jr extends X{constructor(){super(...arguments),this.inputItems=new au(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Pr(n),n))}retrieve(e,t={},n){return this._client.get(T`/responses/${e}`,{query:t,...n,stream:(t==null?void 0:t.stream)??!1})._thenUnwrap(i=>("object"in i&&i.object==="response"&&Pr(i),i))}delete(e,t){return this._client.delete(T`/responses/${e}`,{...t,headers:U([{Accept:"*/*"},t==null?void 0:t.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>eu(n,e))}stream(e,t){return Nr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(T`/responses/${e}/cancel`,t)}}jr.InputItems=au;class ru extends X{create(e,t,n){return this._client.post(T`/uploads/${e}/parts`,ys({body:t,...n},this._client))}}class Ir extends X{constructor(){super(...arguments),this.parts=new ru(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(T`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(T`/uploads/${e}/complete`,{body:t,...n})}}Ir.Parts=ru;const ry=async s=>{const e=await Promise.allSettled(s),t=e.filter(i=>i.status==="rejected");if(t.length){for(const i of t)console.error(i.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const n=[];for(const i of e)i.status==="fulfilled"&&n.push(i.value);return n};class ou extends X{create(e,t,n){return this._client.post(T`/vector_stores/${e}/file_batches`,{body:t,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}retrieve(e,t,n){const{vector_store_id:i}=t;return this._client.get(T`/vector_stores/${i}/file_batches/${e}`,{...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}cancel(e,t,n){const{vector_store_id:i}=t;return this._client.post(T`/vector_stores/${i}/file_batches/${e}/cancel`,{...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async createAndPoll(e,t,n){const i=await this.create(e,t);return await this.poll(e,i.id,n)}listFiles(e,t,n){const{vector_store_id:i,...a}=t;return this._client.getAPIList(T`/vector_stores/${i}/file_batches/${e}/files`,ke,{query:a,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}async poll(e,t,n){var a;const i=U([n==null?void 0:n.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((a=n==null?void 0:n.pollIntervalMs)==null?void 0:a.toString())??void 0}]);for(;;){const{data:r,response:o}=await this.retrieve(t,{vector_store_id:e},{...n,headers:i}).withResponse();switch(r.status){case"in_progress":let c=5e3;if(n!=null&&n.pollIntervalMs)c=n.pollIntervalMs;else{const l=o.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(c=u)}}await wn(c);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},i){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(i==null?void 0:i.maxConcurrency)??5,r=Math.min(a,t.length),o=this._client,c=t.values(),l=[...n];async function u(p){for(let h of p){const m=await o.files.create({file:h,purpose:"assistants"},i);l.push(m.id)}}const d=Array(r).fill(c).map(u);return await ry(d),await this.createAndPoll(e,{file_ids:l})}}let cu=class extends X{create(s,e,t){return this._client.post(T`/vector_stores/${s}/files`,{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(s,e,t){const{vector_store_id:n}=e;return this._client.get(T`/vector_stores/${n}/files/${s}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(s,e,t){const{vector_store_id:n,...i}=e;return this._client.post(T`/vector_stores/${n}/files/${s}`,{body:i,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}list(s,e={},t){return this._client.getAPIList(T`/vector_stores/${s}/files`,ke,{query:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(s,e,t){const{vector_store_id:n}=e;return this._client.delete(T`/vector_stores/${n}/files/${s}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}async createAndPoll(s,e,t){const n=await this.create(s,e,t);return await this.poll(s,n.id,t)}async poll(s,e,t){var i;const n=U([t==null?void 0:t.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=t==null?void 0:t.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const a=await this.retrieve(e,{vector_store_id:s},{...t,headers:n}).withResponse(),r=a.data;switch(r.status){case"in_progress":let o=5e3;if(t!=null&&t.pollIntervalMs)o=t.pollIntervalMs;else{const c=a.response.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await wn(o);break;case"failed":case"completed":return r}}}async upload(s,e,t){const n=await this._client.files.create({file:e,purpose:"assistants"},t);return this.create(s,{file_id:n.id},t)}async uploadAndPoll(s,e,t){const n=await this.upload(s,e,t);return await this.poll(s,n.id,t)}content(s,e,t){const{vector_store_id:n}=e;return this._client.getAPIList(T`/vector_stores/${n}/files/${s}/content`,_i,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};class qi extends X{constructor(){super(...arguments),this.files=new cu(this._client),this.fileBatches=new ou(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(T`/vector_stores/${e}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,n){return this._client.post(T`/vector_stores/${e}`,{body:t,...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",ke,{query:e,...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(T`/vector_stores/${e}`,{...t,headers:U([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}search(e,t,n){return this._client.getAPIList(T`/vector_stores/${e}/search`,_i,{body:t,method:"post",...n,headers:U([{"OpenAI-Beta":"assistants=v2"},n==null?void 0:n.headers])})}}qi.Files=cu,qi.FileBatches=ou;var Fs,lu,Fi;class uu extends X{constructor(){super(...arguments),Fs.add(this)}async unwrap(e,t,n=this._client.webhookSecret,i=300){return await this.verifySignature(e,t,n,i),JSON.parse(e)}async verifySignature(e,t,n=this._client.webhookSecret,i=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");w(this,Fs,"m",lu).call(this,n);const a=U([t]).values,r=w(this,Fs,"m",Fi).call(this,a,"webhook-signature"),o=w(this,Fs,"m",Fi).call(this,a,"webhook-timestamp"),c=w(this,Fs,"m",Fi).call(this,a,"webhook-id"),l=parseInt(o,10);if(isNaN(l))throw new vn("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-l>i)throw new vn("Webhook timestamp is too old");if(l>u+i)throw new vn("Webhook timestamp is too new");const d=r.split(" ").map(y=>y.startsWith("v1,")?y.substring(3):y),p=n.startsWith("whsec_")?it.from(n.replace("whsec_",""),"base64"):it.from(n,"utf-8"),h=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",p,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const y of d)try{const f=it.from(y,"base64");if(await crypto.subtle.verify("HMAC",m,f,new TextEncoder().encode(h)))return}catch{continue}throw new vn("The given webhook signature does not match the expected signature")}}Fs=new WeakSet,lu=function(s){if(typeof s!="string"||s.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Fi=function(s,e){if(!s)throw new Error("Headers are required");const t=s.get(e);if(t==null)throw new Error(`Missing required header: ${e}`);return t};var Rr,$r,Ui,du;ae=class{constructor({baseURL:s=Ls("OPENAI_BASE_URL"),apiKey:e=Ls("OPENAI_API_KEY"),organization:t=Ls("OPENAI_ORG_ID")??null,project:n=Ls("OPENAI_PROJECT_ID")??null,webhookSecret:i=Ls("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Rr.add(this),Ui.set(this,void 0),this.completions=new Fl(this),this.chat=new _r(this),this.embeddings=new Wl(this),this.files=new Vl(this),this.images=new Gl(this),this.audio=new Nn(this),this.moderations=new Yl(this),this.models=new Xl(this),this.fineTuning=new Ds(this),this.graders=new Tr(this),this.vectorStores=new qi(this),this.webhooks=new uu(this),this.beta=new Ln(this),this.batches=new Al(this),this.uploads=new Ir(this),this.responses=new jr(this),this.evals=new kr(this),this.containers=new Er(this),e===void 0)throw new K("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const r={apiKey:e,organization:t,project:n,webhookSecret:i,...a,baseURL:s||"https://api.openai.com/v1"};if(!r.dangerouslyAllowBrowser&&rf())throw new K(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=r.baseURL,this.timeout=r.timeout??$r.DEFAULT_TIMEOUT,this.logger=r.logger??console;const o="warn";this.logLevel=o,this.logLevel=Vc(r.logLevel,"ClientOptions.logLevel",this)??Vc(Ls("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=r.fetchOptions,this.maxRetries=r.maxRetries??2,this.fetch=r.fetch??df(),G(this,Ui,hf),this._options=r,this.apiKey=e,this.organization=t,this.project=n,this.webhookSecret=i}withOptions(s){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...s})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:s,nulls:e}){}authHeaders(s){return U([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(s){return _f(s,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Is}`}defaultIdempotencyKey(){return`stainless-node-retry-${yc()}`}makeStatusError(s,e,t,n){return Xe.generate(s,e,t,n)}buildURL(s,e,t){const n=!w(this,Rr,"m",du).call(this)&&t||this.baseURL,i=Ym(s)?new URL(s):new URL(n+(n.endsWith("/")&&s.startsWith("/")?s.slice(1):s)),a=this.defaultQuery();return tf(a)||(e={...a,...e}),typeof e=="object"&&e&&!Array.isArray(e)&&(i.search=this.stringifyQuery(e)),i.toString()}async prepareOptions(s){}async prepareRequest(s,{url:e,options:t}){}get(s,e){return this.methodRequest("get",s,e)}post(s,e){return this.methodRequest("post",s,e)}patch(s,e){return this.methodRequest("patch",s,e)}put(s,e){return this.methodRequest("put",s,e)}delete(s,e){return this.methodRequest("delete",s,e)}methodRequest(s,e,t){return this.request(Promise.resolve(t).then(n=>({method:s,path:e,...n})))}request(s,e=null){return new Jc(this,this.makeRequest(s,e,void 0))}async makeRequest(s,e,t){var f,g;const n=await s,i=n.maxRetries??this.maxRetries;e==null&&(e=i),await this.prepareOptions(n);const{req:a,url:r,timeout:o}=this.buildRequest(n,{retryCount:i-e});await this.prepareRequest(a,{url:r,options:n});const c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),l=t===void 0?"":`, retryOf: ${t}`,u=Date.now();if(Ze(this).debug(`[${c}] sending request`,fs({retryOfRequestLogID:t,method:n.method,url:r,options:n,headers:a.headers})),(f=n.signal)==null?void 0:f.aborted)throw new at;const d=new AbortController,p=await this.fetchWithTimeout(r,a,o,d).catch(Ha),h=Date.now();if(p instanceof Error){const b=`retrying, ${e} attempts remaining`;if((g=n.signal)!=null&&g.aborted)throw new at;const v=Ja(p)||/timed? ?out/i.test(String(p)+("cause"in p?String(p.cause):""));if(e)return Ze(this).info(`[${c}] connection ${v?"timed out":"failed"} - ${b}`),Ze(this).debug(`[${c}] connection ${v?"timed out":"failed"} (${b})`,fs({retryOfRequestLogID:t,url:r,durationMs:h-u,message:p.message})),this.retryRequest(n,e,t??c);throw Ze(this).info(`[${c}] connection ${v?"timed out":"failed"} - error; no more retries left`),Ze(this).debug(`[${c}] connection ${v?"timed out":"failed"} (error; no more retries left)`,fs({retryOfRequestLogID:t,url:r,durationMs:h-u,message:p.message})),v?new mi:new hi({cause:p})}const m=[...p.headers.entries()].filter(([b])=>b==="x-request-id").map(([b,v])=>", "+b+": "+JSON.stringify(v)).join(""),y=`[${c}${l}${m}] ${a.method} ${r} ${p.ok?"succeeded":"failed"} with status ${p.status} in ${h-u}ms`;if(!p.ok){const b=this.shouldRetry(p);if(e&&b){const Q=`retrying, ${e} attempts remaining`;return await pf(p.body),Ze(this).info(`${y} - ${Q}`),Ze(this).debug(`[${c}] response error (${Q})`,fs({retryOfRequestLogID:t,url:p.url,status:p.status,headers:p.headers,durationMs:h-u})),this.retryRequest(n,e,t??c,p.headers)}const v=b?"error; no more retries left":"error; not retryable";Ze(this).info(`${y} - ${v}`);const E=await p.text().catch(Q=>Ha(Q).message),S=af(E),C=S?void 0:E;throw Ze(this).debug(`[${c}] response error (${v})`,fs({retryOfRequestLogID:t,url:p.url,status:p.status,headers:p.headers,message:C,durationMs:Date.now()-u})),this.makeStatusError(p.status,S,C,p.headers)}return Ze(this).info(y),Ze(this).debug(`[${c}] response start`,fs({retryOfRequestLogID:t,url:p.url,status:p.status,headers:p.headers,durationMs:h-u})),{response:p,options:n,controller:d,requestLogID:c,retryOfRequestLogID:t,startTime:u}}getAPIList(s,e,t){return this.requestAPIList(e,{method:"get",path:s,...t})}requestAPIList(s,e){const t=this.makeRequest(e,null,void 0);return new Af(this,t,s)}async fetchWithTimeout(s,e,t,n){const{signal:i,method:a,...r}=e||{};i&&i.addEventListener("abort",()=>n.abort());const o=setTimeout(()=>n.abort(),t),c=globalThis.ReadableStream&&r.body instanceof globalThis.ReadableStream||typeof r.body=="object"&&r.body!==null&&Symbol.asyncIterator in r.body,l={signal:n.signal,...c?{duplex:"half"}:{},method:"GET",...r};a&&(l.method=a.toUpperCase());try{return await this.fetch.call(void 0,s,l)}finally{clearTimeout(o)}}shouldRetry(s){const e=s.headers.get("x-should-retry");return e==="true"?!0:e==="false"?!1:s.status===408||s.status===409||s.status===429||s.status>=500}async retryRequest(s,e,t,n){let i;const a=n==null?void 0:n.get("retry-after-ms");if(a){const o=parseFloat(a);Number.isNaN(o)||(i=o)}const r=n==null?void 0:n.get("retry-after");if(r&&!i){const o=parseFloat(r);Number.isNaN(o)?i=Date.parse(r)-Date.now():i=o*1e3}if(!(i&&0<=i&&i<60*1e3)){const o=s.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(e,o)}return await wn(i),this.makeRequest(s,e-1,t)}calculateDefaultRetryTimeoutMillis(s,e){const t=e-s,n=Math.min(.5*Math.pow(2,t),8),i=1-Math.random()*.25;return n*i*1e3}buildRequest(s,{retryCount:e=0}={}){const t={...s},{method:n,path:i,query:a,defaultBaseURL:r}=t,o=this.buildURL(i,a,r);"timeout"in t&&nf("timeout",t.timeout),t.timeout=t.timeout??this.timeout;const{bodyHeaders:c,body:l}=this.buildBody({options:t}),u=this.buildHeaders({options:s,method:n,bodyHeaders:c,retryCount:e});return{req:{method:n,headers:u,...t.signal&&{signal:t.signal},...globalThis.ReadableStream&&l instanceof globalThis.ReadableStream&&{duplex:"half"},...l&&{body:l},...this.fetchOptions??{},...t.fetchOptions??{}},url:o,timeout:t.timeout}}buildHeaders({options:s,method:e,bodyHeaders:t,retryCount:n}){let i={};this.idempotencyHeader&&e!=="get"&&(s.idempotencyKey||(s.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=s.idempotencyKey);const a=U([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...s.timeout?{"X-Stainless-Timeout":String(Math.trunc(s.timeout/1e3))}:{},...uf(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},this.authHeaders(s),this._options.defaultHeaders,t,s.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:s,headers:e}}){if(!s)return{bodyHeaders:void 0,body:void 0};const t=U([e]);return ArrayBuffer.isView(s)||s instanceof ArrayBuffer||s instanceof DataView||typeof s=="string"&&t.values.has("content-type")||s instanceof Blob||s instanceof FormData||s instanceof URLSearchParams||globalThis.ReadableStream&&s instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:s}:typeof s=="object"&&(Symbol.asyncIterator in s||Symbol.iterator in s&&"next"in s&&typeof s.next=="function")?{bodyHeaders:void 0,body:Nc(s)}:w(this,Ui,"f").call(this,{body:s,headers:t})}},$r=ae,Ui=new WeakMap,Rr=new WeakSet,du=function(){return this.baseURL!=="https://api.openai.com/v1"},ae.OpenAI=$r,ae.DEFAULT_TIMEOUT=6e5,ae.OpenAIError=K,ae.APIError=Xe,ae.APIConnectionError=hi,ae.APIConnectionTimeoutError=mi,ae.APIUserAbortError=at,ae.NotFoundError=vc,ae.ConflictError=wc,ae.RateLimitError=Oc,ae.BadRequestError=gc,ae.AuthenticationError=bc,ae.InternalServerError=Ec,ae.PermissionDeniedError=_c,ae.UnprocessableEntityError=xc,ae.InvalidWebhookSignatureError=vn,ae.toFile=If,ae.Completions=Fl,ae.Chat=_r,ae.Embeddings=Wl,ae.Files=Vl,ae.Images=Gl,ae.Audio=Nn,ae.Moderations=Yl,ae.Models=Xl,ae.FineTuning=Ds,ae.Graders=Tr,ae.VectorStores=qi,ae.Webhooks=uu,ae.Beta=Ln,ae.Batches=Al,ae.Uploads=Ir,ae.Responses=jr,ae.Evals=kr,ae.Containers=Er;function oy(s,e,t){function n(o,c){var l;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(l=o._zod).traits??(l.traits=new Set),o._zod.traits.add(s),e(o,c);for(const u in r.prototype)u in o||Object.defineProperty(o,u,{value:r.prototype[u].bind(o)});o._zod.constr=r,o._zod.def=c}const i=(t==null?void 0:t.Parent)??Object;class a extends i{}Object.defineProperty(a,"name",{value:s});function r(o){var c;const l=t!=null&&t.Parent?new a:this;n(l,o),(c=l._zod).deferred??(c.deferred=[]);for(const u of l._zod.deferred)u();return l}return Object.defineProperty(r,"init",{value:n}),Object.defineProperty(r,Symbol.hasInstance,{value:o=>{var c,l;return t!=null&&t.Parent&&o instanceof t.Parent?!0:(l=(c=o==null?void 0:o._zod)==null?void 0:c.traits)==null?void 0:l.has(s)}}),Object.defineProperty(r,"name",{value:s}),r}class cy extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const ly={};function uy(s){return ly}function dy(s){const e=Object.values(s).filter(t=>typeof t=="number");return Object.entries(s).filter(([t,n])=>e.indexOf(+t)===-1).map(([t,n])=>n)}function py(s,e){return typeof e=="bigint"?e.toString():e}const hy=Error.captureStackTrace?Error.captureStackTrace:(...s)=>{};function Wi(s){return typeof s=="string"?s:s==null?void 0:s.message}function my(s,e,t){var i,a,r,o,c,l;const n={...s,path:s.path??[]};if(!s.message){const u=Wi((r=(a=(i=s.inst)==null?void 0:i._zod.def)==null?void 0:a.error)==null?void 0:r.call(a,s))??Wi((o=e==null?void 0:e.error)==null?void 0:o.call(e,s))??Wi((c=t.customError)==null?void 0:c.call(t,s))??Wi((l=t.localeError)==null?void 0:l.call(t,s))??"Invalid input";n.message=u}return delete n.inst,delete n.continue,e!=null&&e.reportInput||delete n.input,n}const fy=(s,e)=>{s.name="$ZodError",Object.defineProperty(s,"_zod",{value:s._zod,enumerable:!1}),Object.defineProperty(s,"issues",{value:e,enumerable:!1}),Object.defineProperty(s,"message",{get(){return JSON.stringify(e,py,2)},enumerable:!0})},yy=oy("$ZodError",fy,{Parent:Error}),gy=s=>(e,t,n,i)=>{const a=n?Object.assign(n,{async:!1}):{async:!1},r=e._zod.run({value:t,issues:[]},a);if(r instanceof Promise)throw new cy;if(r.issues.length){const o=new((i==null?void 0:i.Err)??s)(r.issues.map(c=>my(c,a,uy())));throw hy(o,i==null?void 0:i.callee),o}return r.value},by=gy(yy);class pu{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}remove(e){return this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function _y(){return new pu}const vy=_y();class hu{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??vy,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var u,d,p;var n;const i=e._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},r=this.seen.get(e);if(r)return r.count++,t.schemaPath.includes(e)&&(r.cycle=t.path),r.schema;const o={schema:{},count:1,cycle:void 0};this.seen.set(e,o);const c=(d=(u=e._zod).toJSONSchema)==null?void 0:d.call(u);if(c)o.schema=c;else{const h={...t,schemaPath:[...t.schemaPath,e],path:t.path},m=e._zod.parent;if(m)o.ref=m,this.process(m,h),this.seen.get(m).isParent=!0;else{const y=o.schema;switch(i.type){case"string":{const f=y;f.type="string";const{minimum:g,maximum:b,format:v,patterns:E,contentEncoding:S}=e._zod.bag;if(typeof g=="number"&&(f.minLength=g),typeof b=="number"&&(f.maxLength=b),v&&(f.format=a[v]??v,f.format===""&&delete f.format),S&&(f.contentEncoding=S),E&&E.size>0){const C=[...E];C.length===1?f.pattern=C[0].source:C.length>1&&(o.schema.allOf=[...C.map(Q=>({...this.target==="draft-7"?{type:"string"}:{},pattern:Q.source}))])}break}case"number":{const f=y,{minimum:g,maximum:b,format:v,multipleOf:E,exclusiveMaximum:S,exclusiveMinimum:C}=e._zod.bag;typeof v=="string"&&v.includes("int")?f.type="integer":f.type="number",typeof C=="number"&&(f.exclusiveMinimum=C),typeof g=="number"&&(f.minimum=g,typeof C=="number"&&(C>=g?delete f.minimum:delete f.exclusiveMinimum)),typeof S=="number"&&(f.exclusiveMaximum=S),typeof b=="number"&&(f.maximum=b,typeof S=="number"&&(S<=b?delete f.maximum:delete f.exclusiveMaximum)),typeof E=="number"&&(f.multipleOf=E);break}case"boolean":{const f=y;f.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"undefined":{const f=y;f.type="null";break}case"null":{y.type="null";break}case"any":break;case"unknown":break;case"never":{y.not={};break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const f=y,{minimum:g,maximum:b}=e._zod.bag;typeof g=="number"&&(f.minItems=g),typeof b=="number"&&(f.maxItems=b),f.type="array",f.items=this.process(i.element,{...h,path:[...h.path,"items"]});break}case"object":{const f=y;f.type="object",f.properties={};const g=i.shape;for(const E in g)f.properties[E]=this.process(g[E],{...h,path:[...h.path,"properties",E]});const b=new Set(Object.keys(g)),v=new Set([...b].filter(E=>{const S=i.shape[E]._zod;return this.io==="input"?S.optin===void 0:S.optout===void 0}));v.size>0&&(f.required=Array.from(v)),((p=i.catchall)==null?void 0:p._zod.def.type)==="never"?f.additionalProperties=!1:i.catchall?i.catchall&&(f.additionalProperties=this.process(i.catchall,{...h,path:[...h.path,"additionalProperties"]})):this.io==="output"&&(f.additionalProperties=!1);break}case"union":{const f=y;f.anyOf=i.options.map((g,b)=>this.process(g,{...h,path:[...h.path,"anyOf",b]}));break}case"intersection":{const f=y,g=this.process(i.left,{...h,path:[...h.path,"allOf",0]}),b=this.process(i.right,{...h,path:[...h.path,"allOf",1]}),v=S=>"allOf"in S&&Object.keys(S).length===1,E=[...v(g)?g.allOf:[g],...v(b)?b.allOf:[b]];f.allOf=E;break}case"tuple":{const f=y;f.type="array";const g=i.items.map((E,S)=>this.process(E,{...h,path:[...h.path,"prefixItems",S]}));if(this.target==="draft-2020-12"?f.prefixItems=g:f.items=g,i.rest){const E=this.process(i.rest,{...h,path:[...h.path,"items"]});this.target==="draft-2020-12"?f.items=E:f.additionalItems=E}i.rest&&(f.items=this.process(i.rest,{...h,path:[...h.path,"items"]}));const{minimum:b,maximum:v}=e._zod.bag;typeof b=="number"&&(f.minItems=b),typeof v=="number"&&(f.maxItems=v);break}case"record":{const f=y;f.type="object",f.propertyNames=this.process(i.keyType,{...h,path:[...h.path,"propertyNames"]}),f.additionalProperties=this.process(i.valueType,{...h,path:[...h.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const f=y,g=dy(i.entries);g.every(b=>typeof b=="number")&&(f.type="number"),g.every(b=>typeof b=="string")&&(f.type="string"),f.enum=g;break}case"literal":{const f=y,g=[];for(const b of i.values)if(b===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof b=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");g.push(Number(b))}else g.push(b);if(g.length!==0)if(g.length===1){const b=g[0];f.type=b===null?"null":typeof b,f.const=b}else g.every(b=>typeof b=="number")&&(f.type="number"),g.every(b=>typeof b=="string")&&(f.type="string"),g.every(b=>typeof b=="boolean")&&(f.type="string"),g.every(b=>b===null)&&(f.type="null"),f.enum=g;break}case"file":{const f=y,g={type:"string",format:"binary",contentEncoding:"binary"},{minimum:b,maximum:v,mime:E}=e._zod.bag;b!==void 0&&(g.minLength=b),v!==void 0&&(g.maxLength=v),E?E.length===1?(g.contentMediaType=E[0],Object.assign(f,g)):f.anyOf=E.map(S=>({...g,contentMediaType:S})):Object.assign(f,g);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const f=this.process(i.innerType,h);y.anyOf=[f,{type:"null"}];break}case"nonoptional":{this.process(i.innerType,h),o.ref=i.innerType;break}case"success":{const f=y;f.type="boolean";break}case"default":{this.process(i.innerType,h),o.ref=i.innerType,y.default=JSON.parse(JSON.stringify(i.defaultValue));break}case"prefault":{this.process(i.innerType,h),o.ref=i.innerType,this.io==="input"&&(y._prefault=JSON.parse(JSON.stringify(i.defaultValue)));break}case"catch":{this.process(i.innerType,h),o.ref=i.innerType;let f;try{f=i.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}y.default=f;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const f=y,g=e._zod.pattern;if(!g)throw new Error("Pattern not found in template literal");f.type="string",f.pattern=g.source;break}case"pipe":{const f=this.io==="input"?i.in._zod.def.type==="transform"?i.out:i.in:i.out;this.process(f,h),o.ref=f;break}case"readonly":{this.process(i.innerType,h),o.ref=i.innerType,y.readOnly=!0;break}case"promise":{this.process(i.innerType,h),o.ref=i.innerType;break}case"optional":{this.process(i.innerType,h),o.ref=i.innerType;break}case"lazy":{const f=e._zod.innerType;this.process(f,h),o.ref=f;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const l=this.metadataRegistry.get(e);return l&&Object.assign(o.schema,l),this.io==="input"&&Te(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){var u,d,p,h;const n={cycles:(t==null?void 0:t.cycles)??"ref",reused:(t==null?void 0:t.reused)??"inline",external:(t==null?void 0:t.external)??void 0},i=this.seen.get(e);if(!i)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=m=>{var b;const y=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){const v=(b=n.external.registry.get(m[0]))==null?void 0:b.id;if(v)return{ref:n.external.uri(v)};const E=m[1].defId??m[1].schema.id??`schema${this.counter++}`;return m[1].defId=E,{defId:E,ref:`${n.external.uri("__shared")}#/${y}/${E}`}}if(m[1]===i)return{ref:"#"};const f=`#/${y}/`,g=m[1].schema.id??`__schema${this.counter++}`;return{defId:g,ref:f+g}},r=m=>{if(m[1].schema.$ref)return;const y=m[1],{ref:f,defId:g}=a(m);y.def={...y.schema},g&&(y.defId=g);const b=y.schema;for(const v in b)delete b[v];b.$ref=f};for(const m of this.seen.entries()){const y=m[1];if(e===m[0]){r(m);continue}if(n.external){const f=(u=n.external.registry.get(m[0]))==null?void 0:u.id;if(e!==m[0]&&f){r(m);continue}}if((d=this.metadataRegistry.get(m[0]))!=null&&d.id){r(m);continue}if(y.cycle){if(n.cycles==="throw")throw new Error(`Cycle detected: #/${(p=y.cycle)==null?void 0:p.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`);n.cycles==="ref"&&r(m);continue}if(y.count>1&&n.reused==="ref"){r(m);continue}}const o=(m,y)=>{const f=this.seen.get(m),g=f.def??f.schema,b={...g};if(f.ref===null)return;const v=f.ref;if(f.ref=null,v){o(v,y);const E=this.seen.get(v).schema;E.$ref&&y.target==="draft-7"?(g.allOf=g.allOf??[],g.allOf.push(E)):(Object.assign(g,E),Object.assign(g,b))}f.isParent||this.override({zodSchema:m,jsonSchema:g})};for(const m of[...this.seen.entries()].reverse())o(m[0],{target:this.target});const c={};this.target==="draft-2020-12"?c.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?c.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),Object.assign(c,i.def);const l=((h=n.external)==null?void 0:h.defs)??{};for(const m of this.seen.entries()){const y=m[1];y.def&&y.defId&&(l[y.defId]=y.def)}!n.external&&Object.keys(l).length>0&&(this.target==="draft-2020-12"?c.$defs=l:c.definitions=l);try{return JSON.parse(JSON.stringify(c))}catch{throw new Error("Error converting schema to JSON.")}}}function wy(s,e){if(s instanceof pu){const n=new hu(e),i={};for(const o of s._idmap.entries()){const[c,l]=o;n.process(l)}const a={},r={registry:s,uri:(e==null?void 0:e.uri)||(o=>o),defs:i};for(const o of s._idmap.entries()){const[c,l]=o;a[c]=n.emit(l,{...e,external:r})}if(Object.keys(i).length>0){const o=n.target==="draft-2020-12"?"$defs":"definitions";a.__shared={[o]:i}}return{schemas:a}}const t=new hu(e);return t.process(s),t.emit(s,e)}function Te(s,e){const t=e??{seen:new Set};if(t.seen.has(s))return!1;t.seen.add(s);const n=s._zod.def;switch(n.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Te(n.element,t);case"object":{for(const i in n.shape)if(Te(n.shape[i],t))return!0;return!1}case"union":{for(const i of n.options)if(Te(i,t))return!0;return!1}case"intersection":return Te(n.left,t)||Te(n.right,t);case"tuple":{for(const i of n.items)if(Te(i,t))return!0;return!!(n.rest&&Te(n.rest,t))}case"record":return Te(n.keyType,t)||Te(n.valueType,t);case"map":return Te(n.keyType,t)||Te(n.valueType,t);case"set":return Te(n.valueType,t);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Te(n.innerType,t);case"lazy":return Te(n.getter(),t);case"default":return Te(n.innerType,t);case"prefault":return Te(n.innerType,t);case"custom":return!1;case"transform":return!0;case"pipe":return Te(n.in,t)||Te(n.out,t);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${n.type}`)}var xy=typeof window=="object"?window:{},ie="0123456789abcdef".split(""),Oy=[-2147483648,8388608,32768,128],vt=[24,16,8,0],Re=[];function wt(s){s?(Re[0]=Re[16]=Re[1]=Re[2]=Re[3]=Re[4]=Re[5]=Re[6]=Re[7]=Re[8]=Re[9]=Re[10]=Re[11]=Re[12]=Re[13]=Re[14]=Re[15]=0,this.blocks=Re):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}wt.prototype.update=function(s){if(!this.finalized){var e=typeof s!="string";e&&s.constructor===xy.ArrayBuffer&&(s=new Uint8Array(s));for(var t,n=0,i,a=s.length||0,r=this.blocks;n<a;){if(this.hashed&&(this.hashed=!1,r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),e)for(i=this.start;n<a&&i<64;++n)r[i>>2]|=s[n]<<vt[i++&3];else for(i=this.start;n<a&&i<64;++n)t=s.charCodeAt(n),t<128?r[i>>2]|=t<<vt[i++&3]:t<2048?(r[i>>2]|=(192|t>>6)<<vt[i++&3],r[i>>2]|=(128|t&63)<<vt[i++&3]):t<55296||t>=57344?(r[i>>2]|=(224|t>>12)<<vt[i++&3],r[i>>2]|=(128|t>>6&63)<<vt[i++&3],r[i>>2]|=(128|t&63)<<vt[i++&3]):(t=65536+((t&1023)<<10|s.charCodeAt(++n)&1023),r[i>>2]|=(240|t>>18)<<vt[i++&3],r[i>>2]|=(128|t>>12&63)<<vt[i++&3],r[i>>2]|=(128|t>>6&63)<<vt[i++&3],r[i>>2]|=(128|t&63)<<vt[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=r[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},wt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var s=this.blocks,e=this.lastByteIndex;s[16]=this.block,s[e>>2]|=Oy[e&3],this.block=s[16],e>=56&&(this.hashed||this.hash(),s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),s[14]=this.hBytes<<3|this.bytes>>>29,s[15]=this.bytes<<3,this.hash()}},wt.prototype.hash=function(){var s=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4,a,r,o,c=this.blocks;for(r=16;r<80;++r)o=c[r-3]^c[r-8]^c[r-14]^c[r-16],c[r]=o<<1|o>>>31;for(r=0;r<20;r+=5)a=e&t|~e&n,o=s<<5|s>>>27,i=o+a+i+1518500249+c[r]<<0,e=e<<30|e>>>2,a=s&e|~s&t,o=i<<5|i>>>27,n=o+a+n+1518500249+c[r+1]<<0,s=s<<30|s>>>2,a=i&s|~i&e,o=n<<5|n>>>27,t=o+a+t+1518500249+c[r+2]<<0,i=i<<30|i>>>2,a=n&i|~n&s,o=t<<5|t>>>27,e=o+a+e+1518500249+c[r+3]<<0,n=n<<30|n>>>2,a=t&n|~t&i,o=e<<5|e>>>27,s=o+a+s+1518500249+c[r+4]<<0,t=t<<30|t>>>2;for(;r<40;r+=5)a=e^t^n,o=s<<5|s>>>27,i=o+a+i+1859775393+c[r]<<0,e=e<<30|e>>>2,a=s^e^t,o=i<<5|i>>>27,n=o+a+n+1859775393+c[r+1]<<0,s=s<<30|s>>>2,a=i^s^e,o=n<<5|n>>>27,t=o+a+t+1859775393+c[r+2]<<0,i=i<<30|i>>>2,a=n^i^s,o=t<<5|t>>>27,e=o+a+e+1859775393+c[r+3]<<0,n=n<<30|n>>>2,a=t^n^i,o=e<<5|e>>>27,s=o+a+s+1859775393+c[r+4]<<0,t=t<<30|t>>>2;for(;r<60;r+=5)a=e&t|e&n|t&n,o=s<<5|s>>>27,i=o+a+i-1894007588+c[r]<<0,e=e<<30|e>>>2,a=s&e|s&t|e&t,o=i<<5|i>>>27,n=o+a+n-1894007588+c[r+1]<<0,s=s<<30|s>>>2,a=i&s|i&e|s&e,o=n<<5|n>>>27,t=o+a+t-1894007588+c[r+2]<<0,i=i<<30|i>>>2,a=n&i|n&s|i&s,o=t<<5|t>>>27,e=o+a+e-1894007588+c[r+3]<<0,n=n<<30|n>>>2,a=t&n|t&i|n&i,o=e<<5|e>>>27,s=o+a+s-1894007588+c[r+4]<<0,t=t<<30|t>>>2;for(;r<80;r+=5)a=e^t^n,o=s<<5|s>>>27,i=o+a+i-899497514+c[r]<<0,e=e<<30|e>>>2,a=s^e^t,o=i<<5|i>>>27,n=o+a+n-899497514+c[r+1]<<0,s=s<<30|s>>>2,a=i^s^e,o=n<<5|n>>>27,t=o+a+t-899497514+c[r+2]<<0,i=i<<30|i>>>2,a=n^i^s,o=t<<5|t>>>27,e=o+a+e-899497514+c[r+3]<<0,n=n<<30|n>>>2,a=t^n^i,o=e<<5|e>>>27,s=o+a+s-899497514+c[r+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+s<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+i<<0},wt.prototype.hex=function(){this.finalize();var s=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4;return ie[s>>28&15]+ie[s>>24&15]+ie[s>>20&15]+ie[s>>16&15]+ie[s>>12&15]+ie[s>>8&15]+ie[s>>4&15]+ie[s&15]+ie[e>>28&15]+ie[e>>24&15]+ie[e>>20&15]+ie[e>>16&15]+ie[e>>12&15]+ie[e>>8&15]+ie[e>>4&15]+ie[e&15]+ie[t>>28&15]+ie[t>>24&15]+ie[t>>20&15]+ie[t>>16&15]+ie[t>>12&15]+ie[t>>8&15]+ie[t>>4&15]+ie[t&15]+ie[n>>28&15]+ie[n>>24&15]+ie[n>>20&15]+ie[n>>16&15]+ie[n>>12&15]+ie[n>>8&15]+ie[n>>4&15]+ie[n&15]+ie[i>>28&15]+ie[i>>24&15]+ie[i>>20&15]+ie[i>>16&15]+ie[i>>12&15]+ie[i>>8&15]+ie[i>>4&15]+ie[i&15]},wt.prototype.toString=wt.prototype.hex,wt.prototype.digest=function(){this.finalize();var s=this.h0,e=this.h1,t=this.h2,n=this.h3,i=this.h4;return[s>>24&255,s>>16&255,s>>8&255,s&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,i>>24&255,i>>16&255,i>>8&255,i&255]},wt.prototype.array=wt.prototype.digest,wt.prototype.arrayBuffer=function(){this.finalize();var s=new ArrayBuffer(20),e=new DataView(s);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),s};let mu=!1;const Ey=s=>(mu||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","\u2514> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),mu=!0),new wt(!0).update(s).hex()),My=(...s)=>Ey(s.join("_"));class ky{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:My})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}const Cy=new Map;class Lr extends ky{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,n){this.cache.set(this.keyEncoder(e,t),n)}static global(){return new Lr(Cy)}}const Ay=s=>s.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":s.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":s.startsWith("gpt-4-32k")?"gpt-4-32k":s.startsWith("gpt-4-")?"gpt-4":s.startsWith("gpt-4o")?"gpt-4o":s;function Zi(s){return typeof s!="object"||!s?!1:!!("type"in s&&s.type==="function"&&"function"in s&&typeof s.function=="object"&&s.function&&"name"in s.function&&"parameters"in s.function)}const Sy=()=>!1;co=class extends da{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(s){super(s),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=s.verbose??Sy(),this.callbacks=s.callbacks,this.tags=s.tags??[],this.metadata=s.metadata??{}}};class Ty extends co{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){const{cache:i,...a}=n;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof i=="object"?this.cache=i:i?this.cache=Lr.global():this.cache=void 0,this.caller=new Tb(n??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(i=>typeof i=="string"?i:i.type==="text"&&"text"in i?i.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await Pb("modelName"in this?Ay(this.modelName):"gpt2")}catch(i){console.warn("Failed to calculate number of tokens, falling back to approximate count",i)}if(this._encoding)try{n=this._encoding.encode(t).length}catch(i){console.warn("Failed to calculate number of tokens, falling back to approximate count",i)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new mo(e):Array.isArray(e)?new Gm(e.map(zn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([i,a])=>a!==void 0).map(([i,a])=>`${i}:${JSON.stringify(a)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class ns extends da{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=_p(t);return this.func&&await this.func(e,n),this._callWithConfig(i=>Promise.resolve(i),e,n)}async*transform(e,t){const n=_p(t);let i,a=!0;for await(const r of this._transformStreamWithConfig(e,o=>o,n))if(yield r,a)if(i===void 0)i=r;else try{i=vp(i,r)}catch{i=void 0,a=!1}this.func&&i!==void 0&&await this.func(i,n)}static assign(e){return new Nb(new jb({steps:e}))}}function Br(s){const e=[];for(const t of s){let n=t;if(Array.isArray(t.content))for(let i=0;i<t.content.length;i++){const a=t.content[i];(Rb(a)||$b(a))&&n===t&&(n=new t.constructor({...n,content:[...t.content.slice(0,i),Lb(a),...t.content.slice(i+1)]}))}e.push(n)}return e}class Lt extends Ty{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){const n=Lt._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){var n;if(this._streamResponseChunks===Lt.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const i=Lt._convertInputToPromptValue(e).toChatMessages(),[a,r]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...a.metadata,...this.getLsParams(r)},c=await io.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:1},u=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[Br(i)],a.runId,void 0,l,void 0,void 0,a.runName));let d,p;try{for await(const h of this._streamResponseChunks(i,r,u==null?void 0:u[0])){if(h.message.id==null){const m=(n=u==null?void 0:u.at(0))==null?void 0:n.runId;m!=null&&h.message._updateId(`run-${m}`)}h.message.response_metadata={...h.generationInfo,...h.message.response_metadata},yield h.message,d?d=d.concat(h):d=h,wp(h.message)&&h.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:h.message.usage_metadata.input_tokens,completionTokens:h.message.usage_metadata.output_tokens,totalTokens:h.message.usage_metadata.total_tokens}})}}catch(h){throw await Promise.all((u??[]).map(m=>m==null?void 0:m.handleLLMError(h))),h}await Promise.all((u??[]).map(h=>h==null?void 0:h.handleLLMEnd({generations:[[d]],llmOutput:p})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n,i){var u,d;const a=e.map(p=>p.map(zn));let r;if(i!==void 0&&i.length===a.length)r=i;else{const p={...n.metadata,...this.getLsParams(t)},h=await io.configure(n.callbacks,this.callbacks,n.tags,this.tags,p,this.metadata,{verbose:this.verbose}),m={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1};r=await(h==null?void 0:h.handleChatModelStart(this.toJSON(),a.map(Br),n.runId,void 0,m,void 0,void 0,n.runName))}const o=[],c=[];if(r!=null&&r[0].handlers.find(Ib)&&!this.disableStreaming&&a.length===1&&this._streamResponseChunks!==Lt.prototype._streamResponseChunks)try{const p=await this._streamResponseChunks(a[0],t,r==null?void 0:r[0]);let h,m;for await(const y of p){if(y.message.id==null){const f=(u=r==null?void 0:r.at(0))==null?void 0:u.runId;f!=null&&y.message._updateId(`run-${f}`)}h===void 0?h=y:h=vp(h,y),wp(y.message)&&y.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:y.message.usage_metadata.input_tokens,completionTokens:y.message.usage_metadata.output_tokens,totalTokens:y.message.usage_metadata.total_tokens}})}if(h===void 0)throw new Error("Received empty response from chat model call.");o.push([h]),await(r==null?void 0:r[0].handleLLMEnd({generations:o,llmOutput:m}))}catch(p){throw await(r==null?void 0:r[0].handleLLMError(p)),p}else{const p=await Promise.allSettled(a.map((h,m)=>this._generate(h,{...t,promptIndex:m},r==null?void 0:r[m])));await Promise.all(p.map(async(h,m)=>{var y,f,g;if(h.status==="fulfilled"){const b=h.value;for(const v of b.generations){if(v.message.id==null){const E=(y=r==null?void 0:r.at(0))==null?void 0:y.runId;E!=null&&v.message._updateId(`run-${E}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata}}return b.generations.length===1&&(b.generations[0].message.response_metadata={...b.llmOutput,...b.generations[0].message.response_metadata}),o[m]=b.generations,c[m]=b.llmOutput,(f=r==null?void 0:r[m])==null?void 0:f.handleLLMEnd({generations:[b.generations],llmOutput:b.llmOutput})}else return await((g=r==null?void 0:r[m])==null?void 0:g.handleLLMError(h.reason)),Promise.reject(h.reason)}))}const l={generations:o,llmOutput:c.length?(d=this._combineLLMOutput)==null?void 0:d.call(this,...c):void 0};return Object.defineProperty(l,xp,{value:r?{runIds:r==null?void 0:r.map(p=>p.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:i,handledOptions:a}){const r=e.map(y=>y.map(zn)),o={...a.metadata,...this.getLsParams(i)},c=await io.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},u=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),r.map(Br),a.runId,void 0,l,void 0,void 0,a.runName)),d=[],p=(await Promise.allSettled(r.map(async(y,f)=>{const g=Lt._convertInputToPromptValue(y).toString(),b=await t.lookup(g,n);return b==null&&d.push(f),b}))).map((y,f)=>({result:y,runManager:u==null?void 0:u[f]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),h=[];await Promise.all(p.map(async({result:y,runManager:f},g)=>{if(y.status==="fulfilled"){const b=y.value;return h[g]=b.map(v=>("message"in v&&ao(v.message)&&ls(v.message)&&(v.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),v.generationInfo={...v.generationInfo,tokenUsage:{}},v)),b.length&&await(f==null?void 0:f.handleLLMNewToken(b[0].text)),f==null?void 0:f.handleLLMEnd({generations:[b]},void 0,void 0,void 0,{cached:!0})}else return await(f==null?void 0:f.handleLLMError(y.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(y.reason)}));const m={generations:h,missingPromptIndices:d,startedRunManagers:u};return Object.defineProperty(m,xp,{value:u?{runIds:u==null?void 0:u.map(y=>y.runId)}:void 0,configurable:!0}),m}async generate(e,t,n){let i;Array.isArray(t)?i={stop:t}:i=t;const a=e.map(m=>m.map(zn)),[r,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(r.callbacks=r.callbacks??n,!this.cache)return this._generateUncached(a,o,r);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d,startedRunManagers:p}=await this._generateCached({messages:a,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:r});let h={};if(d.length>0){const m=await this._generateUncached(d.map(y=>a[y]),o,r,p!==void 0?d.map(y=>p==null?void 0:p[y]):void 0);await Promise.all(m.generations.map(async(y,f)=>{const g=d[f];u[g]=y;const b=Lt._convertInputToPromptValue(a[g]).toString();return c.update(b,l,y)})),h=m.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const i=e.map(a=>a.toChatMessages());return this.generate(i,t,n)}async call(e,t,n){return(await this.generate([e.map(zn)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const i=e.toChatMessages();return this.call(i,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const i=new bp(e),a=await this.call([i],t,n);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,i=t==null?void 0:t.name,a=Op(n)??"A function available to call.",r=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(r==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let c=i??"extract",l;Wt(n)?l=[{type:"function",function:{name:c,description:a,parameters:Kt(n)}}]:("name"in n&&(c=n.name),l=[{type:"function",function:{name:c,description:a,parameters:n}}]);const u=this.bindTools(l),d=Ep.from(y=>{if(!y.tool_calls||y.tool_calls.length===0)throw new Error("No tool calls found in the response.");const f=y.tool_calls.find(g=>g.name===c);if(!f)throw new Error(`No tool call found with name ${c}.`);return f.args});if(!o)return u.pipe(d).withConfig({runName:"StructuredOutput"});const p=ns.assign({parsed:(y,f)=>d.invoke(y.raw,f)}),h=ns.assign({parsed:()=>null}),m=p.withFallbacks({fallbacks:[h]});return pa.from([{raw:u},m]).withConfig({runName:"StructuredOutputRunnable"})}}class fu extends da{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(n,i)=>this.parseResult([{text:n}],i==null?void 0:i.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(n,i)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],i==null?void 0:i.callbacks),e,{...t,runType:"parser"})}}class yu extends fu{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class Vi extends Error{constructor(e,t,n,i=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=i,i&&(n===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Bb(this,"OUTPUT_PARSING_FAILURE")}}class Py extends yu{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class gu extends Py{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,n;for await(const i of e){if(typeof i!="string"&&typeof i.content!="string")throw new Error("Cannot handle non-string output.");let a;if(Db(i)){if(typeof i.content!="string")throw new Error("Cannot handle non-string message output.");a=new us({message:i,text:i.content})}else if(ao(i)){if(typeof i.content!="string")throw new Error("Cannot handle non-string message output.");a=new us({message:qb(i),text:i.content})}else a=new Fb({text:i});n===void 0?n=a:n=n.concat(a);const r=await this.parsePartialResult([n]);r!=null&&!Jn(r,t)&&(this.diff?yield this._diff(t,r):yield r,t=r)}}getFormatInstructions(){return""}}class Dr extends yu{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Ub(Object.fromEntries(Object.entries(e).map(([n,i])=>[n,Wb().describe(i)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Kt(this.schema))}
\`\`\`
`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(n,i)=>`"${i.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await Zb(this.schema,JSON.parse(t))}catch(t){throw new Vi(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class zi extends gu{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Wp(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Mp(e[0].text)}async parse(e){return Mp(e,JSON.parse)}getFormatInstructions(){return""}}function Ki(s,e){if(s.function===void 0)return;let t;if(e!=null&&e.partial)try{t=Vb(s.function.arguments??"{}")}catch{return}else try{t=JSON.parse(s.function.arguments)}catch(i){throw new Vi([`Function "${s.function.name}" arguments:`,"",s.function.arguments,"","are not valid JSON.",`Error: ${i.message}`].join(`
`))}const n={name:s.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(n.id=s.id),n}function bu(s){if(s.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:s.id,type:"function",function:{name:s.name,arguments:JSON.stringify(s.args)}}}function qr(s,e){var t,n;return{name:(t=s.function)==null?void 0:t.name,args:(n=s.function)==null?void 0:n.arguments,id:s.id,error:e,type:"invalid_tool_call"}}class Ny extends gu{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var r;const n=e[0].message;let i;if(ls(n)&&((r=n.tool_calls)!=null&&r.length)?i=n.tool_calls.map(o=>{const{id:c,...l}=o;return this.returnId?{id:c,...l}:l}):n.additional_kwargs.tool_calls!==void 0&&(i=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(o=>Ki(o,{returnId:this.returnId,partial:t}))),!i)return[];const a=[];for(const o of i)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};a.push(c)}return a}}class Qi extends Ny{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){var n;if(this.zodSchema===void 0)return e;const t=await kp(this.zodSchema,e);if(t.success)return t.data;throw new Vi(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((n=t.error)==null?void 0:n.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName);let n=t;if(t.length)return this.returnId||(n=t.map(i=>i.args)),this.returnSingle?n[0]:n}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName);let n=t;return t.length?(this.returnId||(n=t.map(i=>i.args)),this.returnSingle?this._validateResult(n[0]):await Promise.all(n.map(i=>this._validateResult(i)))):void 0}}const jy=Symbol("Let zodToJsonSchema decide on which parser to use"),_u={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Iy=s=>typeof s=="string"?{..._u,basePath:["#"],definitions:{},name:s}:{..._u,basePath:["#"],definitions:{},...s},Fr=s=>"_def"in s?s._def:s;function Ry(s){if(!s)return!0;for(const e in s)return!1;return!0}const $y=s=>{const e=Iy(s),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([n,i])=>[Fr(i),{def:Fr(i),path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function vu(s,e,t,n){n!=null&&n.errorMessages&&t&&(s.errorMessage={...s.errorMessage,[e]:t})}function de(s,e,t,n,i){s[e]=t,vu(s,e,n,i)}var Bn;(function(s){s.assertEqual=i=>{};function e(i){}s.assertIs=e;function t(i){throw new Error}s.assertNever=t,s.arrayToEnum=i=>{const a={};for(const r of i)a[r]=r;return a},s.getValidEnumValues=i=>{const a=s.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),r={};for(const o of a)r[o]=i[o];return s.objectValues(r)},s.objectValues=i=>s.objectKeys(i).map(function(a){return i[a]}),s.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{const a=[];for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&a.push(r);return a},s.find=(i,a)=>{for(const r of i)if(a(r))return r},s.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function n(i,a=" | "){return i.map(r=>typeof r=="string"?`'${r}'`:r).join(a)}s.joinValues=n,s.jsonStringifyReplacer=(i,a)=>typeof a=="bigint"?a.toString():a})(Bn||(Bn={}));var wu;(function(s){s.mergeShapes=(e,t)=>({...e,...t})})(wu||(wu={})),Bn.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Bn.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Ji extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},n={_errors:[]},i=a=>{for(const r of a.issues)if(r.code==="invalid_union")r.unionErrors.map(i);else if(r.code==="invalid_return_type")i(r.returnTypeError);else if(r.code==="invalid_arguments")i(r.argumentsError);else if(r.path.length===0)n._errors.push(t(r));else{let o=n,c=0;for(;c<r.path.length;){const l=r.path[c];c===r.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(r))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return i(this),n}static assert(e){if(!(e instanceof Ji))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Bn.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const i of this.issues)i.path.length>0?(t[i.path[0]]=t[i.path[0]]||[],t[i.path[0]].push(e(i))):n.push(e(i));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Ji.create=s=>new Ji(s);var xu;(function(s){s.errToObj=e=>typeof e=="string"?{message:e}:e||{},s.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(xu||(xu={}));var te;(function(s){s.ZodString="ZodString",s.ZodNumber="ZodNumber",s.ZodNaN="ZodNaN",s.ZodBigInt="ZodBigInt",s.ZodBoolean="ZodBoolean",s.ZodDate="ZodDate",s.ZodSymbol="ZodSymbol",s.ZodUndefined="ZodUndefined",s.ZodNull="ZodNull",s.ZodAny="ZodAny",s.ZodUnknown="ZodUnknown",s.ZodNever="ZodNever",s.ZodVoid="ZodVoid",s.ZodArray="ZodArray",s.ZodObject="ZodObject",s.ZodUnion="ZodUnion",s.ZodDiscriminatedUnion="ZodDiscriminatedUnion",s.ZodIntersection="ZodIntersection",s.ZodTuple="ZodTuple",s.ZodRecord="ZodRecord",s.ZodMap="ZodMap",s.ZodSet="ZodSet",s.ZodFunction="ZodFunction",s.ZodLazy="ZodLazy",s.ZodLiteral="ZodLiteral",s.ZodEnum="ZodEnum",s.ZodEffects="ZodEffects",s.ZodNativeEnum="ZodNativeEnum",s.ZodOptional="ZodOptional",s.ZodNullable="ZodNullable",s.ZodDefault="ZodDefault",s.ZodCatch="ZodCatch",s.ZodPromise="ZodPromise",s.ZodBranded="ZodBranded",s.ZodPipeline="ZodPipeline",s.ZodReadonly="ZodReadonly"})(te||(te={}));function Ly(){return{}}function By(s,e){var n,i;const t={type:"array"};return((i=(n=s.type)==null?void 0:n._def)==null?void 0:i.typeName)!==te.ZodAny&&(t.items=ue(s.type._def,{...e,currentPath:[...e.currentPath,"items"]})),s.minLength&&de(t,"minItems",s.minLength.value,s.minLength.message,e),s.maxLength&&de(t,"maxItems",s.maxLength.value,s.maxLength.message,e),s.exactLength&&(de(t,"minItems",s.exactLength.value,s.exactLength.message,e),de(t,"maxItems",s.exactLength.value,s.exactLength.message,e)),t}function Dy(s,e){const t={type:"integer",format:"int64"};if(!s.checks)return t;for(const n of s.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?de(t,"minimum",n.value,n.message,e):de(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),de(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?de(t,"maximum",n.value,n.message,e):de(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),de(t,"maximum",n.value,n.message,e));break;case"multipleOf":de(t,"multipleOf",n.value,n.message,e);break}return t}function qy(){return{type:"boolean"}}function Fy(s,e){return ue(s.type._def,e)}const Uy=(s,e)=>ue(s.innerType._def,e);function Ou(s,e,t){const n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((i,a)=>Ou(s,e,i))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Wy(s,e)}}const Wy=(s,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const n of s.checks)switch(n.kind){case"min":de(t,"minimum",n.value,n.message,e);break;case"max":de(t,"maximum",n.value,n.message,e);break}return t};function Zy(s,e){return{...ue(s.innerType._def,e),default:s.defaultValue()}}function Vy(s,e,t){return e.effectStrategy==="input"?ue(s.schema._def,e,t):{}}function zy(s){return{type:"string",enum:[...s.values]}}const Ky=s=>"type"in s&&s.type==="string"?!1:"allOf"in s;function Qy(s,e){const t=[ue(s.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),ue(s.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const i=[];return t.forEach(a=>{if(Ky(a))i.push(...a.allOf),a.unevaluatedProperties===void 0&&(n=void 0);else{let r=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...c}=a;r=c}else n=void 0;i.push(r)}}),i.length?{allOf:i,...n}:void 0}function Jy(s,e){const t=typeof s.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(s.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[s.value]}:{type:t==="bigint"?"integer":t,const:s.value}}let Ur;const vs={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ur===void 0&&(Ur=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ur),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Eu(s,e){const t={type:"string"};function n(i){return e.patternStrategy==="escape"?Hy(i):i}if(s.checks)for(const i of s.checks)switch(i.kind){case"min":de(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e);break;case"max":de(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"email":switch(e.emailStrategy){case"format:email":xt(t,"email",i.message,e);break;case"format:idn-email":xt(t,"idn-email",i.message,e);break;case"pattern:zod":Ot(t,vs.email,i.message,e);break}break;case"url":xt(t,"uri",i.message,e);break;case"uuid":xt(t,"uuid",i.message,e);break;case"regex":Ot(t,i.regex,i.message,e);break;case"cuid":Ot(t,vs.cuid,i.message,e);break;case"cuid2":Ot(t,vs.cuid2,i.message,e);break;case"startsWith":Ot(t,RegExp(`^${n(i.value)}`),i.message,e);break;case"endsWith":Ot(t,RegExp(`${n(i.value)}$`),i.message,e);break;case"datetime":xt(t,"date-time",i.message,e);break;case"date":xt(t,"date",i.message,e);break;case"time":xt(t,"time",i.message,e);break;case"duration":xt(t,"duration",i.message,e);break;case"length":de(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,i.value):i.value,i.message,e),de(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,i.value):i.value,i.message,e);break;case"includes":{Ot(t,RegExp(n(i.value)),i.message,e);break}case"ip":{i.version!=="v6"&&xt(t,"ipv4",i.message,e),i.version!=="v4"&&xt(t,"ipv6",i.message,e);break}case"emoji":Ot(t,vs.emoji,i.message,e);break;case"ulid":{Ot(t,vs.ulid,i.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{xt(t,"binary",i.message,e);break}case"contentEncoding:base64":{de(t,"contentEncoding","base64",i.message,e);break}case"pattern:zod":{Ot(t,vs.base64,i.message,e);break}}break}case"nanoid":Ot(t,vs.nanoid,i.message,e)}return t}const Hy=s=>Array.from(s).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),xt=(s,e,t,n)=>{var i;s.format||(i=s.anyOf)!=null&&i.some(a=>a.format)?(s.anyOf||(s.anyOf=[]),s.format&&(s.anyOf.push({format:s.format,...s.errorMessage&&n.errorMessages&&{errorMessage:{format:s.errorMessage.format}}}),delete s.format,s.errorMessage&&(delete s.errorMessage.format,Object.keys(s.errorMessage).length===0&&delete s.errorMessage)),s.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):de(s,"format",e,t,n)},Ot=(s,e,t,n)=>{var i;s.pattern||(i=s.allOf)!=null&&i.some(a=>a.pattern)?(s.allOf||(s.allOf=[]),s.pattern&&(s.allOf.push({pattern:s.pattern,...s.errorMessage&&n.errorMessages&&{errorMessage:{pattern:s.errorMessage.pattern}}}),delete s.pattern,s.errorMessage&&(delete s.errorMessage.pattern,Object.keys(s.errorMessage).length===0&&delete s.errorMessage)),s.allOf.push({pattern:Mu(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):de(s,"pattern",Mu(e,n),t,n)},Mu=(s,e)=>{var l;const t=typeof s=="function"?s():s;if(!e.applyRegexFlags||!t.flags)return t.source;const n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},i=n.i?t.source.toLowerCase():t.source;let a="",r=!1,o=!1,c=!1;for(let u=0;u<i.length;u++){if(r){a+=i[u],r=!1;continue}if(n.i){if(o){if(i[u].match(/[a-z]/)){c?(a+=i[u],a+=`${i[u-2]}-${i[u]}`.toUpperCase(),c=!1):i[u+1]==="-"&&((l=i[u+2])!=null&&l.match(/[a-z]/))?(a+=i[u],c=!0):a+=`${i[u]}${i[u].toUpperCase()}`;continue}}else if(i[u].match(/[a-z]/)){a+=`[${i[u]}${i[u].toUpperCase()}]`;continue}}if(n.m){if(i[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(i[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(n.s&&i[u]==="."){a+=o?`${i[u]}\r
`:`[${i[u]}\r
]`;continue}a+=i[u],i[u]==="\\"?r=!0:o&&i[u]==="]"?o=!1:!o&&i[u]==="["&&(o=!0)}try{const u=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return a};function ku(s,e){var n,i,a,r;if(e.target==="openApi3"&&((n=s.keyType)==null?void 0:n._def.typeName)===te.ZodEnum)return{type:"object",required:s.keyType._def.values,properties:s.keyType._def.values.reduce((o,c)=>({...o,[c]:ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((i=s.keyType)==null?void 0:i._def.typeName)===te.ZodString&&((a=s.keyType._def.checks)!=null&&a.length)){const o=Object.entries(Eu(s.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...t,propertyNames:o}}else if(((r=s.keyType)==null?void 0:r._def.typeName)===te.ZodEnum)return{...t,propertyNames:{enum:s.keyType._def.values}};return t}function Gy(s,e){if(e.mapStrategy==="record")return ku(s,e);const t=ue(s.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function Xy(s){const e=s.values,t=Object.keys(s.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),n=Array.from(new Set(t.map(i=>typeof i)));return{type:n.length===1?n[0]==="string"?"string":"number":["string","number"],enum:t}}function Yy(){return{not:{}}}function eg(s){return s.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Hi={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function tg(s,e){if(e.target==="openApi3")return Cu(s,e);const t=s.options instanceof Map?Array.from(s.options.values()):s.options;if(t.every(n=>n._def.typeName in Hi&&(!n._def.checks||!n._def.checks.length))){const n=t.reduce((i,a)=>{const r=Hi[a._def.typeName];return r&&!i.includes(r)?[...i,r]:i},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){const n=t.reduce((i,a)=>{const r=typeof a._def.value;switch(r){case"string":case"number":case"boolean":return[...i,r];case"bigint":return[...i,"integer"];case"object":if(a._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(n.length===t.length){const i=n.filter((a,r,o)=>o.indexOf(a)===r);return{type:i.length>1?i:i[0],enum:t.reduce((a,r)=>a.includes(r._def.value)?a:[...a,r._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,i)=>[...n,...i._def.values.filter(a=>!n.includes(a))],[])};return Cu(s,e)}const Cu=(s,e)=>{const t=(s.options instanceof Map?Array.from(s.options.values()):s.options).map((n,i)=>ue(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${i}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function sg(s,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(s.innerType._def.typeName)&&(!s.innerType._def.checks||!s.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Hi[s.innerType._def.typeName],nullable:!0}:{type:[Hi[s.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const n=ue(s.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const t=ue(s.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function ng(s,e){const t={type:"number"};if(!s.checks)return t;for(const n of s.checks)switch(n.kind){case"int":t.type="integer",vu(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?de(t,"minimum",n.value,n.message,e):de(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),de(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?de(t,"maximum",n.value,n.message,e):de(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),de(t,"maximum",n.value,n.message,e));break;case"multipleOf":de(t,"multipleOf",n.value,n.message,e);break}return t}function ig(s,e){return e.removeAdditionalStrategy==="strict"?s.catchall._def.typeName==="ZodNever"?s.unknownKeys!=="strict":ue(s.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:s.catchall._def.typeName==="ZodNever"?s.unknownKeys==="passthrough":ue(s.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function ag(s,e){const t={type:"object",...Object.entries(s.shape()).reduce((n,[i,a])=>{var c;if(a===void 0||a._def===void 0)return n;const r=[...e.currentPath,"properties",i],o=ue(a._def,{...e,currentPath:r,propertyPath:r});if(o===void 0)return n;if(e.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&typeof((c=a._def)==null?void 0:c.defaultValue)>"u")throw new Error(`Zod field at \`${r.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...n.properties,[i]:o},required:a.isOptional()&&!e.openaiStrictMode?n.required:[...n.required,i]}},{properties:{},required:[]}),additionalProperties:ig(s,e)};return t.required.length||delete t.required,t}const rg=(s,e)=>{var n;if(e.currentPath.toString()===((n=e.propertyPath)==null?void 0:n.toString()))return ue(s.innerType._def,e);const t=ue(s.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},og=(s,e)=>{if(e.pipeStrategy==="input")return ue(s.in._def,e);if(e.pipeStrategy==="output")return ue(s.out._def,e);const t=ue(s.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=ue(s.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(i=>i!==void 0)}};function cg(s,e){return ue(s.type._def,e)}function lg(s,e){const t={type:"array",uniqueItems:!0,items:ue(s.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return s.minSize&&de(t,"minItems",s.minSize.value,s.minSize.message,e),s.maxSize&&de(t,"maxItems",s.maxSize.value,s.maxSize.message,e),t}function ug(s,e){return s.rest?{type:"array",minItems:s.items.length,items:s.items.map((t,n)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:ue(s.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:s.items.length,maxItems:s.items.length,items:s.items.map((t,n)=>ue(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function dg(){return{not:{}}}function pg(){return{}}const hg=(s,e)=>ue(s.innerType._def,e);function ue(s,e,t=!1){var r;const n=e.seen.get(s);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,s,e,n,t);if(o!==jy)return o}if(n&&!t){const o=mg(n,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const i={def:s,path:e.currentPath,jsonSchema:void 0};e.seen.set(s,i);const a=yg(s,s.typeName,e,t);return a&&gg(s,e,a),i.jsonSchema=a,a}const mg=(s,e)=>{switch(e.$refStrategy){case"root":return{$ref:s.path.join("/")};case"extract-to-root":const t=s.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=s.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:fg(e.currentPath,s.path)};case"none":case"seen":return s.path.length<e.currentPath.length&&s.path.every((n,i)=>e.currentPath[i]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},fg=(s,e)=>{let t=0;for(;t<s.length&&t<e.length&&s[t]===e[t];t++);return[(s.length-t).toString(),...e.slice(t)].join("/")},yg=(s,e,t,n)=>{switch(e){case te.ZodString:return Eu(s,t);case te.ZodNumber:return ng(s,t);case te.ZodObject:return ag(s,t);case te.ZodBigInt:return Dy(s,t);case te.ZodBoolean:return qy();case te.ZodDate:return Ou(s,t);case te.ZodUndefined:return dg();case te.ZodNull:return eg(t);case te.ZodArray:return By(s,t);case te.ZodUnion:case te.ZodDiscriminatedUnion:return tg(s,t);case te.ZodIntersection:return Qy(s,t);case te.ZodTuple:return ug(s,t);case te.ZodRecord:return ku(s,t);case te.ZodLiteral:return Jy(s,t);case te.ZodEnum:return zy(s);case te.ZodNativeEnum:return Xy(s);case te.ZodNullable:return sg(s,t);case te.ZodOptional:return rg(s,t);case te.ZodMap:return Gy(s,t);case te.ZodSet:return lg(s,t);case te.ZodLazy:return ue(s.getter()._def,t);case te.ZodPromise:return cg(s,t);case te.ZodNaN:case te.ZodNever:return Yy();case te.ZodEffects:return Vy(s,t,n);case te.ZodAny:return Ly();case te.ZodUnknown:return pg();case te.ZodDefault:return Zy(s,t);case te.ZodBranded:return Fy(s,t);case te.ZodReadonly:return hg(s,t);case te.ZodCatch:return Uy(s,t);case te.ZodPipeline:return og(s,t);case te.ZodFunction:case te.ZodVoid:case te.ZodSymbol:return;default:return(i=>{})()}},gg=(s,e,t)=>(s.description&&(t.description=s.description,e.markdownDescription&&(t.markdownDescription=s.description)),t),bg=(s,e)=>{const t=$y(e),n=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,i=ue(s._def,n===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,n]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(i.title=a);const r=(()=>{if(Ry(t.definitions))return;const c={},l=new Set;for(let u=0;u<500;u++){const d=Object.entries(t.definitions).filter(([p])=>!l.has(p));if(d.length===0)break;for(const[p,h]of d)c[p]=ue(Fr(h),{...t,currentPath:[...t.basePath,t.definitionPath,p]},!0)??{},l.add(p)}return c})(),o=n===void 0?r?{...i,[t.definitionPath]:r}:i:t.nameStrategy==="duplicate-ref"?{...i,...r||t.seenRefs.size?{[t.definitionPath]:{...r,...t.seenRefs.size?{[n]:i}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,n].join("/"),[t.definitionPath]:{...r,[n]:i}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function _g(s,e){return bg(s,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function vg(s,e,t){return Bf({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:_g(s,{name:e})}},n=>s.parse(JSON.parse(n)))}fo=function(s){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:n,azureOpenAIBasePath:i,baseURL:a,azureADTokenProvider:r,azureOpenAIEndpoint:o}=s;if((n||r)&&i&&e)return`${i}/${e}`;if((n||r)&&o&&e)return`${o}/openai/deployments/${e}`;if(n||r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return a};function wg(s){return s!==void 0&&Array.isArray(s.lc_namespace)}function xg(s){return s!==void 0&&da.isRunnable(s)&&"lc_name"in s.constructor&&typeof s.constructor.lc_name=="function"&&s.constructor.lc_name()==="RunnableToolLike"}function Og(s){return!!s&&typeof s=="object"&&"name"in s&&"schema"in s&&(Wt(s.schema)||s.schema!=null&&typeof s.schema=="object"&&"type"in s.schema&&typeof s.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(s.schema.type))}function Gi(s){return Og(s)||xg(s)||wg(s)}function Eg(s,e){return{name:s.name,description:s.description,parameters:Kt(s.schema)}}function Wr(s,e){let t;return Gi(s)?t={type:"function",function:Eg(s)}:t=s,t}function Xi(s,e){return s.lc_error_code=e,s.message=`${s.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,s}Gn=function(s){let e;return s.constructor.name===mi.name?(e=new Error(s.message),e.name="TimeoutError"):s.constructor.name===at.name?(e=new Error(s.message),e.name="AbortError"):s.status===400&&s.message.includes("tool_calls")?e=Xi(s,"INVALID_TOOL_RESULTS"):s.status===401?e=Xi(s,"MODEL_AUTHENTICATION"):s.status===429?e=Xi(s,"MODEL_RATE_LIMIT"):s.status===404?e=Xi(s,"MODEL_NOT_FOUND"):e=s,e};function Au(s){if(s)return s==="any"||s==="required"?"required":s==="auto"?"auto":s==="none"?"none":typeof s=="string"?{type:"function",function:{name:s}}:s}function Mg(s){return s.anyOf!==void 0&&Array.isArray(s.anyOf)}function kg(s){const e=["namespace functions {",""];for(const t of s)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Su(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Su(s,e){var n;const t=[];for(const[i,a]of Object.entries(s.properties??{}))a.description&&e<2&&t.push(`// ${a.description}`),(n=s.required)!=null&&n.includes(i)?t.push(`${i}: ${Yi(a,e)},`):t.push(`${i}?: ${Yi(a,e)},`);return t.map(i=>" ".repeat(e)+i).join(`
`)}function Yi(s,e){if(Mg(s))return s.anyOf.map(t=>Yi(t,e)).join(" | ");switch(s.type){case"string":return s.enum?s.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return s.enum?s.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return s.enum?s.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Su(s,e+2),"}"].join(`
`);case"array":return s.items?`${Yi(s.items,e)}[]`:"any[]";default:return""}}function Cg(s,e){let t;return Gi(s)?t=Wr(s):t=s,(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function Ag(s){return s.role!=="system"&&s.role!=="developer"&&s.role!=="assistant"&&s.role!=="user"&&s.role!=="function"&&s.role!=="tool"&&console.warn(`Unknown message role: ${s.role}`),s.role}function Zr(s){const e=s._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!ma.isInstance(s))throw new Error("Invalid generic chat message");return Ag(s)}default:throw new Error(`Unknown message type: ${e}`)}}const Tu={providerName:"ChatOpenAI",fromStandardTextBlock(s){return{type:"text",text:s.text}},fromStandardImageBlock(s){var e,t;if(s.source_type==="url")return{type:"image_url",image_url:{url:s.url,...(e=s.metadata)!=null&&e.detail?{detail:s.metadata.detail}:{}}};if(s.source_type==="base64")return{type:"image_url",image_url:{url:`data:${s.mime_type??""};base64,${s.data}`,...(t=s.metadata)!=null&&t.detail?{detail:s.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${s.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(s){if(s.source_type==="url"){const e=Kn({dataUrl:s.url});if(!e)throw new Error(`URL audio blocks with source_type ${s.source_type} must be formatted as a data URL for ChatOpenAI`);const t=e.mime_type||s.mime_type||"";let n;try{n=Pp(t)}catch{throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`)}if(n.type!=="audio"||n.subtype!=="wav"&&n.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:n.subtype,data:e.data}}}if(s.source_type==="base64"){let e;try{e=Pp(s.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${s.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:s.data}}}throw new Error(`Audio content blocks with source_type ${s.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(s){var e,t,n,i,a,r,o,c,l,u;if(s.source_type==="url"){if(!Kn({dataUrl:s.url}))throw new Error(`URL file blocks with source_type ${s.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:s.url,...(e=s.metadata)!=null&&e.filename||(t=s.metadata)!=null&&t.name?{filename:((n=s.metadata)==null?void 0:n.filename)||((i=s.metadata)==null?void 0:i.name)}:{}}}}if(s.source_type==="base64")return{type:"file",file:{file_data:`data:${s.mime_type??""};base64,${s.data}`,...(a=s.metadata)!=null&&a.filename||(r=s.metadata)!=null&&r.name||(o=s.metadata)!=null&&o.title?{filename:((c=s.metadata)==null?void 0:c.filename)||((l=s.metadata)==null?void 0:l.name)||((u=s.metadata)==null?void 0:u.title)}:{}}};if(s.source_type==="id")return{type:"file",file:{file_id:s.id}};throw new Error(`File content blocks with source_type ${s.source_type} are not supported for ChatOpenAI`)}};function Pu(s,e){return s.flatMap(t=>{var r;let n=Zr(t);n==="system"&&ea(e)&&(n="developer");const i=typeof t.content=="string"?t.content:t.content.map(o=>ro(o)?oo(o,Tu):o),a={role:n,content:i};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=""),ls(t)&&((r=t.tool_calls)!=null&&r.length)?(a.tool_calls=t.tool_calls.map(bu),a.content=""):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const o={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,o]}return a})}const Us="__openai_function_call_ids__";function Sg(s){const e=(s.summary.length>1?s.summary.reduce((t,n)=>{const i=t.at(-1);return i.index===n.index?i.text+=n.text:t.push(n),t},[{...s.summary[0]}]):s.summary).map(t=>Object.fromEntries(Object.entries(t).filter(([n])=>n!=="index")));return{...s,summary:e}}function Nu(s,e,t){return s.flatMap(n=>{var r,o,c;const i=n.additional_kwargs;let a=Zr(n);if(a==="system"&&ea(e)&&(a="developer"),a==="function")throw new Error("Function messages are not supported in Responses API");if(a==="tool"){const l=n;return(i==null?void 0:i.type)==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof l.content=="string")return{type:"computer_screenshot",image_url:l.content};if(Array.isArray(l.content)){const u=l.content.find(p=>p.type==="computer_screenshot");if(u)return u;const d=l.content.find(p=>p.type==="image_url");if(d)return{type:"computer_screenshot",image_url:typeof d.image_url=="string"?d.image_url:d.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:l.tool_call_id}:{type:"function_call_output",call_id:l.tool_call_id,id:(r=l.id)!=null&&r.startsWith("fc_")?l.id:void 0,output:typeof l.content!="string"?JSON.stringify(l.content):l.content}}if(a==="assistant"){if(!t&&n.response_metadata.output!=null&&Array.isArray(n.response_metadata.output)&&n.response_metadata.output.length>0&&n.response_metadata.output.every(m=>"type"in m))return n.response_metadata.output;const l=[];if(i!=null&&i.reasoning&&!t){const m=Sg(i.reasoning);l.push(m)}let{content:u}=n;i!=null&&i.refusal&&(typeof u=="string"&&(u=[{type:"output_text",text:u,annotations:[]}]),u=[...u,{type:"refusal",refusal:i.refusal}]),l.push({type:"message",role:"assistant",...n.id&&!t?{id:n.id}:{},content:typeof u=="string"?u:u.flatMap(m=>m.type==="text"?{type:"output_text",text:m.text,annotations:m.annotations??[]}:m.type==="output_text"||m.type==="refusal"?m:[])});const d=i==null?void 0:i[Us];ls(n)&&((o=n.tool_calls)!=null&&o.length)?l.push(...n.tool_calls.map(m=>({type:"function_call",name:m.name,arguments:JSON.stringify(m.args),call_id:m.id,...t?{id:d==null?void 0:d[m.id]}:{}}))):i!=null&&i.tool_calls&&l.push(...i.tool_calls.map(m=>({type:"function_call",name:m.function.name,call_id:m.id,arguments:m.function.arguments,...t?{id:d==null?void 0:d[m.id]}:{}})));const p=(c=n.response_metadata.output)!=null&&c.length?n.response_metadata.output:i.tool_outputs,h=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(p!=null){const m=p==null?void 0:p.filter(y=>h.includes(y.type));m.length>0&&l.push(...m)}return l}if(a==="user"||a==="system"||a==="developer"){if(typeof n.content=="string")return{type:"message",role:a,content:n.content};const l=[],u=n.content.flatMap(d=>(d.type==="mcp_approval_response"&&l.push({type:"mcp_approval_response",approval_request_id:d.approval_request_id,approve:d.approve}),ro(d)?oo(d,Tu):d.type==="text"?{type:"input_text",text:d.text}:d.type==="image_url"?{type:"input_image",image_url:typeof d.image_url=="string"?d.image_url:d.image_url.url,detail:typeof d.image_url=="string"?"auto":d.image_url.detail}:d.type==="input_text"||d.type==="input_image"||d.type==="input_file"?d:[]));return u.length>0&&l.push({type:"message",role:a,content:u}),l}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${a}`),[]})}function ju(s){if(s.error){const o=new Error(s.error.message);throw o.name=s.error.code,o}let e;const t=[],n=[],i=[],a={model:s.model,created_at:s.created_at,id:s.id,incomplete_details:s.incomplete_details,metadata:s.metadata,object:s.object,status:s.status,user:s.user,service_tier:s.service_tier,model_name:s.model},r={};for(const o of s.output)if(o.type==="message")e=o.id,t.push(...o.content.flatMap(c=>c.type==="output_text"?("parsed"in c&&c.parsed!=null&&(r.parsed=c.parsed),{type:"text",text:c.text,annotations:c.annotations}):c.type==="refusal"?(r.refusal=c.refusal,[]):c));else if(o.type==="function_call"){const c={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{n.push(Ki(c,{returnId:!0}))}catch(l){let u;typeof l=="object"&&l!=null&&"message"in l&&typeof l.message=="string"&&(u=l.message),i.push(qr(c,u))}r[Us]??(r[Us]={}),o.id&&(r[Us][o.call_id]=o.id)}else o.type==="reasoning"?r.reasoning=o:(r.tool_outputs??(r.tool_outputs=[]),r.tool_outputs.push(o));return new Gs({id:e,content:t,tool_calls:n,invalid_tool_calls:i,usage_metadata:s.usage,additional_kwargs:r,response_metadata:a})}function Tg(s){var c,l;const e=[];let t={},n;const i=[],a={},r={};let o;if(s.type==="response.output_text.delta")e.push({type:"text",text:s.delta,index:s.content_index});else if(s.type==="response.output_text_annotation.added")e.push({type:"text",text:"",annotations:[s.annotation],index:s.content_index});else if(s.type==="response.output_item.added"&&s.item.type==="message")o=s.item.id;else if(s.type==="response.output_item.added"&&s.item.type==="function_call")i.push({type:"tool_call_chunk",name:s.item.name,args:s.item.arguments,id:s.item.call_id,index:s.output_index}),r[Us]={[s.item.call_id]:s.item.id};else if(s.type==="response.output_item.done"&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call"].includes(s.item.type))r.tool_outputs=[s.item];else if(s.type==="response.created")a.id=s.response.id,a.model_name=s.response.model,a.model=s.response.model;else if(s.type==="response.completed"){const u=ju(s.response);n=s.response.usage,((l=(c=s.response.text)==null?void 0:c.format)==null?void 0:l.type)==="json_schema"&&(r.parsed??(r.parsed=JSON.parse(u.text)));for(const[d,p]of Object.entries(s.response))d!=="id"&&(a[d]=p)}else if(s.type==="response.function_call_arguments.delta")i.push({type:"tool_call_chunk",args:s.delta,index:s.output_index});else if(s.type==="response.web_search_call.completed"||s.type==="response.file_search_call.completed")t={tool_outputs:{id:s.item_id,type:s.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(s.type==="response.refusal.done")r.refusal=s.refusal;else if(s.type==="response.output_item.added"&&"item"in s&&s.item.type==="reasoning"){const u=s.item.summary?s.item.summary.map((d,p)=>({...d,index:p})):void 0;r.reasoning={id:s.item.id,type:s.item.type,...u?{summary:u}:{}}}else if(s.type==="response.reasoning_summary_part.added")r.reasoning={type:"reasoning",summary:[{...s.part,index:s.summary_index}]};else if(s.type==="response.reasoning_summary_text.delta")r.reasoning={type:"reasoning",summary:[{text:s.delta,type:"summary_text",index:s.summary_index}]};else return s.type,null;return new us({text:e.map(u=>u.text).join(""),message:new Xs({id:o,content:e,tool_call_chunks:i,usage_metadata:n,additional_kwargs:r,response_metadata:a}),generationInfo:t})}function Vr(s){return"type"in s&&s.type!=="function"}function Pg(s){return s!=null&&typeof s=="object"&&"type"in s&&s.type!=="function"}function Ng(s,e){const t=[];for(const n of s)Vr(n)?(n.type==="image_generation"&&(e!=null&&e.stream)&&(n.partial_images=1),t.push(n)):Zi(n)&&t.push({type:"function",name:n.function.name,parameters:n.function.parameters,description:n.function.description,strict:(e==null?void 0:e.strict)??null});return t}function Iu(s,e){return Zi(s)?(e==null?void 0:e.strict)!==void 0?{...s,function:{...s.function,strict:e.strict}}:s:Cg(s,e)}function ea(s){return s&&/^o\d/.test(s)}class jg extends Lt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort","service_tier"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","useResponsesApi","zdrEnabled","reasoning"]}constructor(e){var t,n,i;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zdrEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"service_tier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((t=e==null?void 0:e.configuration)==null?void 0:t.apiKey)??ha("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((n=e==null?void 0:e.configuration)==null?void 0:n.organization)??ha("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=(e==null?void 0:e.reasoningEffort)??((i=e==null?void 0:e.reasoning)==null?void 0:i.effort),this.reasoning=(e==null?void 0:e.reasoning)??(e!=null&&e.reasoningEffort?{effort:e.reasoningEffort}:void 0),this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.useResponsesApi=(e==null?void 0:e.useResponsesApi)??this.useResponsesApi,this.disableStreaming=(e==null?void 0:e.disableStreaming)??this.disableStreaming,this.streaming=(e==null?void 0:e.streaming)??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),(e==null?void 0:e.service_tier)!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=(e==null?void 0:e.zdrEnabled)??!1}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return(t==null?void 0:t.strict)!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.withConfig({tools:e.map(i=>Vr(i)?i:Iu(i,{strict:n})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Wt(e.json_schema.schema)?$g(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}getReasoningParams(e){if(!ea(this.model))return;let t;return this.reasoningEffort!==void 0&&(t={effort:this.reasoningEffort}),this.reasoning!==void 0&&(t={...t,...this.reasoning}),(e==null?void 0:e.reasoning_effort)!==void 0&&(t={...t,effort:e.reasoning_effort}),(e==null?void 0:e.reasoning)!==void 0&&(t={...t,...e.reasoning}),t}invocationParams(e,t){var o,c;let n;if((e==null?void 0:e.strict)!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this._useResponseApi(e)){const l={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e==null?void 0:e.previous_response_id,truncation:e==null?void 0:e.truncation,include:e==null?void 0:e.include,tools:(o=e==null?void 0:e.tools)!=null&&o.length?Ng(e.tools,{stream:this.streaming,strict:n}):void 0,tool_choice:Pg(e==null?void 0:e.tool_choice)?e==null?void 0:e.tool_choice:(()=>{const d=Au(e==null?void 0:e.tool_choice);if(typeof d=="object"&&"type"in d)return{type:"function",name:d.function.name}})(),text:(()=>{if(e!=null&&e.text)return e.text;const d=this.createResponseFormat(e==null?void 0:e.response_format);return(d==null?void 0:d.type)==="json_schema"?d.json_schema.schema!=null?{format:{type:"json_schema",schema:d.json_schema.schema,description:d.json_schema.description,name:d.json_schema.name,strict:d.json_schema.strict}}:void 0:{format:d}})(),parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},u=this.getReasoningParams(e);return u!==void 0&&(l.reasoning=u),l}let i={};(e==null?void 0:e.stream_options)!==void 0?i={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(i={stream_options:{include_usage:!0}});const a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(c=e==null?void 0:e.tools)!=null&&c.length?e.tools.map(l=>Iu(l,{strict:n})):void 0,tool_choice:Au(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...i,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(a.prediction=e.prediction),this.service_tier!==void 0&&(a.service_tier=this.service_tier),(e==null?void 0:e.service_tier)!==void 0&&(a.service_tier=e.service_tier);const r=this.getReasoningParams(e);return r!==void 0&&r.effort!==void 0&&(a.reasoning_effort=r.effort),ea(a.model)?a.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:a.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,a}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const n=e.tool_calls;switch(e.role){case"assistant":{const i=[],a=[];for(const c of n??[])try{i.push(Ki(c,{returnId:!0}))}catch(l){a.push(qr(c,l.message))}const r={function_call:e.function_call,tool_calls:n};this.__includeRawResponse!==void 0&&(r.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(r.audio=e.audio),new Gs({content:e.content||"",tool_calls:i,invalid_tool_calls:a,additional_kwargs:r,response_metadata:o,id:t.id})}default:return new ma(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,t,n){var c,l;const i=e.role??n,a=e.content??"";let r;e.function_call?r={function_call:e.function_call}:e.tool_calls?r={tool_calls:e.tool_calls}:r={},this.__includeRawResponse&&(r.__raw_response=t),e.audio&&(r.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if(i==="user")return new Cp({content:a,response_metadata:o});if(i==="assistant"){const u=[];if(Array.isArray(e.tool_calls))for(const d of e.tool_calls)u.push({name:(c=d.function)==null?void 0:c.name,args:(l=d.function)==null?void 0:l.arguments,id:d.id,index:d.index,type:"tool_call_chunk"});return new Xs({content:a,tool_call_chunks:u,additional_kwargs:r,id:t.id,response_metadata:o})}else return i==="system"?new fa({content:a,response_metadata:o}):i==="developer"?new fa({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):i==="function"?new Ap({content:a,additional_kwargs:r,name:e.name,response_metadata:o}):i==="tool"?new Sp({content:a,additional_kwargs:r,tool_call_id:e.tool_call_id,response_metadata:o}):new Tp({content:a,role:i,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){var l,u,d,p,h,m,y,f,g,b;if(this._useResponseApi(t)){const v=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:Nu(e,this.model,this.zdrEnabled),stream:!0},t);for await(const E of v){const S=Tg(E);S!=null&&(yield S)}return}const i=Pu(e,this.model),a={...this.invocationParams(t,{streaming:!0}),messages:i,stream:!0};let r;const o=await this.completionWithRetry(a,t);let c;for await(const v of o){const E=(l=v==null?void 0:v.choices)==null?void 0:l[0];if(v.usage&&(c=v.usage),!E)continue;const{delta:S}=E;if(!S)continue;const C=this._convertOpenAIDeltaToBaseMessageChunk(S,v,r);r=S.role??r;const Q={prompt:t.promptIndex??0,completion:E.index??0};if(typeof C.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const J={...Q};E.finish_reason!=null&&(J.finish_reason=E.finish_reason,J.system_fingerprint=v.system_fingerprint,J.model_name=v.model,J.service_tier=v.service_tier),this.logprobs&&(J.logprobs=E.logprobs);const W=new us({message:C,text:C.content,generationInfo:J});yield W,await(n==null?void 0:n.handleLLMNewToken(W.text??"",Q,void 0,void 0,void 0,{chunk:W}))}if(c){const v={...((u=c.prompt_tokens_details)==null?void 0:u.audio_tokens)!==null&&{audio:(d=c.prompt_tokens_details)==null?void 0:d.audio_tokens},...((p=c.prompt_tokens_details)==null?void 0:p.cached_tokens)!==null&&{cache_read:(h=c.prompt_tokens_details)==null?void 0:h.cached_tokens}},E={...((m=c.completion_tokens_details)==null?void 0:m.audio_tokens)!==null&&{audio:(y=c.completion_tokens_details)==null?void 0:y.audio_tokens},...((f=c.completion_tokens_details)==null?void 0:f.reasoning_tokens)!==null&&{reasoning:(g=c.completion_tokens_details)==null?void 0:g.reasoning_tokens}};yield new us({message:new Xs({content:"",response_metadata:{usage:{...c}},usage_metadata:{input_tokens:c.prompt_tokens,output_tokens:c.completion_tokens,total_tokens:c.total_tokens,...Object.keys(v).length>0&&{input_token_details:v},...Object.keys(E).length>0&&{output_token_details:E}}}),text:""})}if((b=t.signal)!=null&&b.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,n){var o;const i=this.invocationParams(t);if(i.stream){const c=this._streamResponseChunks(e,t,n);let l;for await(const u of c)u.message.response_metadata={...u.generationInfo,...u.message.response_metadata},l=(l==null?void 0:l.concat(u))??u;return{generations:l?[l]:[],llmOutput:{estimatedTokenUsage:(o=l==null?void 0:l.message)==null?void 0:o.usage_metadata}}}const a=Nu(e,this.model,this.zdrEnabled),r=await this.responseApiWithRetry({input:a,...i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});return{generations:[{text:r.output_text,message:ju(r)}],llmOutput:{id:r.id,estimatedTokenUsage:r.usage?{promptTokens:r.usage.input_tokens,completionTokens:r.usage.output_tokens,totalTokens:r.usage.total_tokens}:void 0}}}_useResponseApi(e){var i,a,r;const t=(i=e==null?void 0:e.tools)==null?void 0:i.some(Vr),n=(e==null?void 0:e.previous_response_id)!=null||(e==null?void 0:e.text)!=null||(e==null?void 0:e.truncation)!=null||(e==null?void 0:e.include)!=null||((a=e==null?void 0:e.reasoning)==null?void 0:a.summary)!=null||((r=this.reasoning)==null?void 0:r.summary)!=null;return this.useResponsesApi||t||n}async _generate(e,t,n){var o,c;if(this._useResponseApi(t))return this._responseApiGenerate(e,t,n);const i={},a=this.invocationParams(t),r=Pu(e,this.model);if(a.stream){const l=this._streamResponseChunks(e,t,n),u={};for await(const f of l){f.message.response_metadata={...f.generationInfo,...f.message.response_metadata};const g=((o=f.generationInfo)==null?void 0:o.completion)??0;u[g]===void 0?u[g]=f:u[g]=u[g].concat(f)}const d=Object.entries(u).sort(([f],[g])=>parseInt(f,10)-parseInt(g,10)).map(([f,g])=>g),{functions:p,function_call:h}=this.invocationParams(t),m=await this.getEstimatedTokenCountFromPrompt(e,p,h),y=await this.getNumTokensFromGenerations(d);return i.input_tokens=m,i.output_tokens=y,i.total_tokens=m+y,{generations:d,llmOutput:{estimatedTokenUsage:{promptTokens:i.input_tokens,completionTokens:i.output_tokens,totalTokens:i.total_tokens}}}}else{let l;t.response_format&&t.response_format.type==="json_schema"?l=await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:r},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):l=await this.completionWithRetry({...a,stream:!1,messages:r},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});const{completion_tokens:u,prompt_tokens:d,total_tokens:p,prompt_tokens_details:h,completion_tokens_details:m}=(l==null?void 0:l.usage)??{};u&&(i.output_tokens=(i.output_tokens??0)+u),d&&(i.input_tokens=(i.input_tokens??0)+d),p&&(i.total_tokens=(i.total_tokens??0)+p),((h==null?void 0:h.audio_tokens)!==null||(h==null?void 0:h.cached_tokens)!==null)&&(i.input_token_details={...(h==null?void 0:h.audio_tokens)!==null&&{audio:h==null?void 0:h.audio_tokens},...(h==null?void 0:h.cached_tokens)!==null&&{cache_read:h==null?void 0:h.cached_tokens}}),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.reasoning_tokens)!==null)&&(i.output_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.reasoning_tokens)!==null&&{reasoning:m==null?void 0:m.reasoning_tokens}});const y=[];for(const f of(l==null?void 0:l.choices)??[]){const g={text:((c=f.message)==null?void 0:c.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(f.message??{role:"assistant"},l)};g.generationInfo={...f.finish_reason?{finish_reason:f.finish_reason}:{},...f.logprobs?{logprobs:f.logprobs}:{}},ls(g.message)&&(g.message.usage_metadata=i),g.message=new Gs(Object.fromEntries(Object.entries(g.message).filter(([b])=>!b.startsWith("lc_")))),y.push(g)}return{generations:y,llmOutput:{tokenUsage:{promptTokens:i.input_tokens,completionTokens:i.output_tokens,totalTokens:i.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let i=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){const a=kg(t);i+=await this.getNumTokens(a),i+=9}return t&&e.find(a=>a._getType()==="system")&&(i-=4),n==="none"?i+=1:typeof n=="object"&&(i+=await this.getNumTokens(n.name)+4),i}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async t=>{var n;return(n=t.message.additional_kwargs)!=null&&n.function_call?(await this.getNumTokensFromMessages([t.message])).countPerMessage[0]:await this.getNumTokens(t.message.content)}))).reduce((t,n)=>t+n,0)}async getNumTokensFromMessages(e){let t=0,n=0,i=0;this.model==="gpt-3.5-turbo-0301"?(n=4,i=-1):(n=3,i=1);const a=await Promise.all(e.map(async r=>{var p,h,m,y,f,g;const o=await this.getNumTokens(r.content),c=await this.getNumTokens(Zr(r)),l=r.name!==void 0?i+await this.getNumTokens(r.name):0;let u=o+n+c+l;const d=r;if(d._getType()==="function"&&(u-=2),(p=d.additional_kwargs)!=null&&p.function_call&&(u+=3),(h=d==null?void 0:d.additional_kwargs.function_call)!=null&&h.name&&(u+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.name)),(y=d.additional_kwargs.function_call)==null?void 0:y.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse((f=d.additional_kwargs.function_call)==null?void 0:f.arguments)))}catch(b){console.error("Error parsing function arguments",b,JSON.stringify(d.additional_kwargs.function_call)),u+=await this.getNumTokens((g=d.additional_kwargs.function_call)==null?void 0:g.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(i){throw Gn(i)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{var i,a;const n=this._getClientOptions(t);try{return((a=(i=e.text)==null?void 0:i.format)==null?void 0:a.type)==="json_schema"&&!e.stream?await this.client.responses.parse(e,n):await this.client.responses.create(e,n)}catch(r){throw Gn(r)}})}async betaParsedCompletionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.parse(e,n)}catch(i){throw Gn(i)}})}_getClientOptions(e){if(!this.client){const t={baseURL:this.clientConfig.baseURL},n=fo(t),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new ae(i)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,i,a,r;Ig(e)?(n=e.schema,i=e.name,a=e.method,r=e.includeRaw):(n=e,i=t==null?void 0:t.name,a=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw);let o,c;if((t==null?void 0:t.strict)!==void 0&&a==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?a===void 0&&(a="jsonSchema"):a==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),a==="jsonMode"){let p;Wt(n)?(c=Dr.fromZodSchema(n),p=Kt(n)):c=new zi,o=this.withConfig({response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"jsonMode"},schema:p}})}else if(a==="jsonSchema")if(o=this.withConfig({response_format:{type:"json_schema",json_schema:{name:i??"extract",description:Op(n),schema:n,strict:t==null?void 0:t.strict}},ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:Kt(n)}}),Wt(n)){const p=Dr.fromZodSchema(n);c=Ep.from(h=>"parsed"in h.additional_kwargs?h.additional_kwargs.parsed:p)}else c=new zi;else{let p=i??"extract";if(Wt(n)){const h=Kt(n);o=this.withConfig({tools:[{type:"function",function:{name:p,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:p}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:h},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new Qi({returnSingle:!0,keyName:p,zodSchema:n})}else{let h;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(h=n,p=n.name):(p=n.title??p,h={name:p,description:n.description??"",parameters:n}),o=this.withConfig({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:p}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:Kt(n)},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new Qi({returnSingle:!0,keyName:p})}}if(!r)return o.pipe(c);const l=ns.assign({parsed:(p,h)=>c.invoke(p.raw,h)}),u=ns.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return pa.from([{raw:o},d])}}function Ig(s){return s!==void 0&&typeof s.schema=="object"}function Rg(s,e){const t={...s};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function $g(s,e,t){if(zb(s))return vg(s,e,t);if(Kb(s))return Rg({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:wy(s,{cycles:"ref",reused:"ref",override(n){n.jsonSchema.title=e}})}},n=>by(s,JSON.parse(n)));throw new Error("Unsupported schema response format")}const Ws="0.19.0";let Ru=!1,Dn,$u,Lu,zr,Bu,Du,qu,Fu,Uu;function Lg(s,e={auto:!1}){if(Ru)throw new Error(`you must \`import 'groq-sdk/shims/${s.kind}'\` before importing anything else from groq-sdk`);if(Dn)throw new Error(`can't \`import 'groq-sdk/shims/${s.kind}'\` after \`import 'groq-sdk/shims/${Dn}'\``);Ru=e.auto,Dn=s.kind,$u=s.fetch,Lu=s.FormData,zr=s.File,Bu=s.ReadableStream,Du=s.getMultipartRequestOptions,qu=s.getDefaultAgent,Fu=s.fileFromPath,Uu=s.isFsReadStream}class Bg{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Dg({manuallyImported:s}={}){const e=s?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n";let t,n,i,a;try{t=fetch,n=Request,i=Response,a=Headers}catch(r){throw new Error(`this environment is missing the following Web Fetch API type: ${r.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:i,Headers:a,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(r,o)=>({...o,body:new Bg(r)}),getDefaultAgent:r=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:r=>!1}}const Wu=()=>{Dn||Lg(Dg(),{auto:!0})};Wu();class Et extends Error{}class Ve extends Et{constructor(e,t,n,i){super(`${Ve.makeMessage(e,t,n)}`),this.status=e,this.headers=i,this.error=t}static makeMessage(e,t,n){const i=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&i?`${e} ${i}`:e?`${e} status code (no body)`:i||"(no status code or body)"}static generate(e,t,n,i){if(!e||!i)return new ta({message:n,cause:Xr(t)});const a=t;return e===400?new Vu(e,a,n,i):e===401?new zu(e,a,n,i):e===403?new Ku(e,a,n,i):e===404?new Qu(e,a,n,i):e===409?new Ju(e,a,n,i):e===422?new Hu(e,a,n,i):e===429?new Gu(e,a,n,i):e>=500?new Xu(e,a,n,i):new Ve(e,a,n,i)}}class Kr extends Ve{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class ta extends Ve{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Zu extends ta{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Vu extends Ve{}class zu extends Ve{}class Ku extends Ve{}class Qu extends Ve{}class Ju extends Ve{}class Hu extends Ve{}class Gu extends Ve{}class Xu extends Ve{}class Zs{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;const i=new qg;async function*a(){if(!e.body)throw t.abort(),new Et("Attempted to iterate over a response with no body");const o=new ws,c=Yu(e.body);for await(const l of c)for(const u of o.decode(l)){const d=i.decode(u);d&&(yield d)}for(const l of o.flush()){const u=i.decode(l);u&&(yield u)}}async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(const c of a())if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||c.event==="error"){let l;try{l=JSON.parse(c.data)}catch(u){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),u}if(l&&l.error)throw new Ve(l.error.status_code,l.error,l.error.message,void 0);yield l}}o=!0}catch(c){if(c instanceof Error&&c.name==="AbortError")return;throw c}finally{o||t.abort()}}return new Zs(r,t)}static fromReadableStream(e,t){let n=!1;async function*i(){const r=new ws,o=Yu(e);for await(const c of o)for(const l of r.decode(c))yield l;for(const c of r.flush())yield c}async function*a(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const o of i())r||o&&(yield JSON.parse(o));r=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{r||t.abort()}}return new Zs(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),i=a=>({next:()=>{if(a.length===0){const r=n.next();e.push(r),t.push(r)}return a.shift()}});return[new Zs(()=>i(e),this.controller),new Zs(()=>i(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new Bu({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{const{value:a,done:r}=await t.next();if(r)return i.close();const o=n.encode(JSON.stringify(a)+`
`);i.enqueue(o)}catch(a){i.error(a)}},async cancel(){var i;await((i=t.return)==null?void 0:i.call(t))}})}}class qg{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,i]=Fg(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}}class ws{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=ws.NEWLINE_CHARS.has(t[t.length-1]||"");let i=t.split(ws.NEWLINE_REGEXP);return i.length===1&&!n?(this.buffer.push(i[0]),[]):(this.buffer.length>0&&(i=[this.buffer.join("")+i[0],...i.slice(1)],this.buffer=[]),n||(this.buffer=[i.pop()||""]),i)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof it<"u"){if(e instanceof it)return e.toString();if(e instanceof Uint8Array)return it.from(e).toString();throw new Et(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Et(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Et("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}ws.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]),ws.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function Fg(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}function Yu(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const ed=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function",td=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&sa(s),sa=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",Ug=s=>td(s)||ed(s)||Uu(s);async function sd(s,e,t){var i;if(s=await s,td(s))return s;if(ed(s)){const a=await s.blob();e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=sa(a)?[await a.arrayBuffer()]:[a];return new zr(r,e,t)}const n=await Wg(s);if(e||(e=Vg(s)??"unknown_file"),!(t!=null&&t.type)){const a=(i=n[0])==null?void 0:i.type;typeof a=="string"&&(t={...t,type:a})}return new zr(n,e,t)}async function Wg(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(sa(s))e.push(await s.arrayBuffer());else if(zg(s))for await(const n of s)e.push(n);else throw new Error(`Unexpected data type: ${typeof s}; constructor: ${(t=s==null?void 0:s.constructor)==null?void 0:t.name}; props: ${Zg(s)}`);return e}function Zg(s){return`[${Object.getOwnPropertyNames(s).map(e=>`"${e}"`).join(", ")}]`}function Vg(s){var e;return Qr(s.name)||Qr(s.filename)||((e=Qr(s.path))==null?void 0:e.split(/[\\/]/).pop())}const Qr=s=>{if(typeof s=="string")return s;if(typeof it<"u"&&s instanceof it)return String(s)},zg=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",nd=s=>s&&typeof s=="object"&&s.body&&s[Symbol.toStringTag]==="MultipartBody",Jr=async s=>{const e=await Kg(s.body);return Du(e,s)},Kg=async s=>{const e=new Lu;return await Promise.all(Object.entries(s||{}).map(([t,n])=>Hr(e,t,n))),e},Hr=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(Ug(t)){const n=await sd(t);s.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>Hr(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,i])=>Hr(s,`${e}[${n}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Vs={};Wu();async function id(s){var i,a;const{response:e}=s;if(s.options.stream)return zs("response",e.status,e.url,e.headers,e.body),s.options.__streamClass?s.options.__streamClass.fromSSEResponse(e,s.controller):Zs.fromSSEResponse(e,s.controller);if(e.status===204)return null;if(s.options.__binaryResponse)return e;const t=(a=(i=e.headers.get("content-type"))==null?void 0:i.split(";")[0])==null?void 0:a.trim();if(t!=null&&t.includes("application/json")||t!=null&&t.endsWith("+json")){const r=await e.json();return zs("response",e.status,e.url,e.headers,r),r}const n=await e.text();return zs("response",e.status,e.url,e.headers,n),n}class na extends Promise{constructor(e,t=id){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new na(this.responsePromise,async t=>e(await this.parseResponse(t),t))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Qg{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e4,httpAgent:i,fetch:a}){this.baseURL=e,this.maxRetries=Gr("maxRetries",t),this.timeout=Gr("timeout",n),this.httpAgent=i,this.fetch=a??$u}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Yg(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${r0()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async i=>{const a=i&&sa(i==null?void 0:i.body)?new DataView(await i.body.arrayBuffer()):(i==null?void 0:i.body)instanceof DataView?i.body:(i==null?void 0:i.body)instanceof ArrayBuffer?new DataView(i.body):i&&ArrayBuffer.isView(i==null?void 0:i.body)?new DataView(i.body.buffer):i==null?void 0:i.body;return{method:e,path:t,...i,body:a}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof it<"u")return it.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var h;e={...e};const{method:n,path:i,query:a,headers:r={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:nd(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,c=this.calculateContentLength(o),l=this.buildURL(i,a);"timeout"in e&&Gr("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const u=e.httpAgent??this.httpAgent??qu(l),d=e.timeout+1e3;typeof((h=u==null?void 0:u.options)==null?void 0:h.timeout)=="number"&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);const p=this.buildHeaders({options:e,headers:r,contentLength:c,retryCount:t});return{req:{method:n,...o&&{body:o},headers:p,...u&&{agent:u},signal:e.signal??null},url:l,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:i}){const a={};n&&(a["content-length"]=n);const r=this.defaultHeaders(e);return ld(a,r),ld(a,t),nd(e.body)&&Dn!=="node"&&delete a["content-type"],ia(r,"x-stainless-retry-count")===void 0&&ia(t,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(i)),ia(r,"x-stainless-timeout")===void 0&&ia(t,"x-stainless-timeout")===void 0&&e.timeout&&(a["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,i){return Ve.generate(e,t,n,i)}request(e,t=null){return new na(this.makeRequest(e,t))}async makeRequest(e,t){var d,p;const n=await e,i=n.maxRetries??this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);const{req:a,url:r,timeout:o}=this.buildRequest(n,{retryCount:i-t});if(await this.prepareRequest(a,{url:r,options:n}),zs("request",r,n,a.headers),(d=n.signal)==null?void 0:d.aborted)throw new Kr;const c=new AbortController,l=await this.fetchWithTimeout(r,a,o,c).catch(Xr);if(l instanceof Error){if((p=n.signal)!=null&&p.aborted)throw new Kr;if(t)return this.retryRequest(n,t);throw l.name==="AbortError"?new Zu:new ta({cause:l})}const u=Hg(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){const f=`retrying, ${t} attempts remaining`;return zs(`response (error; ${f})`,l.status,r,u),this.retryRequest(n,t,u)}const h=await l.text().catch(f=>Xr(f).message),m=e0(h),y=m?void 0:h;throw zs(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,r,u,y),this.makeStatusError(l.status,m,y,u)}return{response:l,options:n,controller:c}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Jg(this,n,e)}buildURL(e,t){const n=s0(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return i0(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new Et(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,i){const{signal:a,...r}=t||{};a&&a.addEventListener("abort",()=>i.abort());const o=setTimeout(()=>i.abort(),n),c={signal:i.signal,...r};return c.method&&(c.method=c.method.toUpperCase()),this.fetch.call(void 0,e,c).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let i;const a=n==null?void 0:n["retry-after-ms"];if(a){const o=parseFloat(a);Number.isNaN(o)||(i=o)}const r=n==null?void 0:n["retry-after"];if(r&&!i){const o=parseFloat(r);Number.isNaN(o)?i=Date.parse(r)-Date.now():i=o*1e3}if(!(i&&0<=i&&i<60*1e3)){const o=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,o)}return await n0(i),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e,i=Math.min(.5*Math.pow(2,n),8),a=1-Math.random()*.25;return i*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ws}`}}class Jg extends na{constructor(e,t,n){super(t,async i=>new n(e,i.response,await id(i),i.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const Hg=s=>new Proxy(Object.fromEntries(s.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),Gg=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ws,"X-Stainless-OS":rd(Deno.build.os),"X-Stainless-Arch":ad(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ws,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":Ut.version};if(Object.prototype.toString.call(typeof Ut<"u"?Ut:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ws,"X-Stainless-OS":rd(Ut.platform),"X-Stainless-Arch":ad(Ut.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":Ut.version};const s=Xg();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ws,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ws,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Xg(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const i=n[1]||0,a=n[2]||0,r=n[3]||0;return{browser:e,version:`${i}.${a}.${r}`}}}return null}const ad=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",rd=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let od;const Yg=()=>od??(od=Gg()),e0=s=>{try{return JSON.parse(s)}catch{return}},t0=/^[a-z][a-z0-9+.-]*:/i,s0=s=>t0.test(s),n0=s=>new Promise(e=>setTimeout(e,s)),Gr=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Et(`${s} must be an integer`);if(e<0)throw new Et(`${s} must be a positive integer`);return e},Xr=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null)try{return new Error(JSON.stringify(s))}catch{}return new Error(s)},cd=s=>{var e,t,n,i;if(typeof Ut<"u")return((e=Vs==null?void 0:Vs[s])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(i=(n=(t=Deno.env)==null?void 0:t.get)==null?void 0:n.call(t,s))==null?void 0:i.trim()};function i0(s){if(!s)return!0;for(const e in s)return!1;return!0}function a0(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function ld(s,e){for(const t in e){if(!a0(e,t))continue;const n=t.toLowerCase();if(!n)continue;const i=e[t];i===null?delete s[n]:i!==void 0&&(s[n]=i)}}function zs(s,...e){typeof Ut<"u"&&(Vs==null?void 0:Vs.DEBUG)==="true"&&console.log(`Groq:DEBUG:${s}`,...e)}const r0=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}),o0=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",c0=s=>typeof(s==null?void 0:s.get)=="function",ia=(s,e)=>{var n;const t=e.toLowerCase();if(c0(s)){const i=((n=e[0])==null?void 0:n.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(a,r,o)=>r+o.toUpperCase());for(const a of[e,t,e.toUpperCase(),i]){const r=s.get(a);if(r)return r}}for(const[i,a]of Object.entries(s))if(i.toLowerCase()===t)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${e} header, using the first entry.`),a[0]):a};class Mt{constructor(e){this._client=e}}class ud extends Mt{create(e,t){return this._client.post("/openai/v1/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class dd extends Mt{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",Jr({body:e,...t}))}}class pd extends Mt{create(e,t){return this._client.post("/openai/v1/audio/translations",Jr({body:e,...t}))}}class qn extends Mt{constructor(){super(...arguments),this.speech=new ud(this._client),this.transcriptions=new dd(this._client),this.translations=new pd(this._client)}}qn.Speech=ud,qn.Transcriptions=dd,qn.Translations=pd;class hd extends Mt{create(e,t){return this._client.post("/openai/v1/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/openai/v1/batches/${e}`,t)}list(e){return this._client.get("/openai/v1/batches",e)}cancel(e,t){return this._client.post(`/openai/v1/batches/${e}/cancel`,t)}}let md=class extends Mt{create(s,e){return this._client.post("/openai/v1/chat/completions",{body:s,...e,stream:s.stream??!1})}};class Yr extends Mt{constructor(){super(...arguments),this.completions=new md(this._client)}}Yr.Completions=md;class fd extends Mt{}class yd extends Mt{create(e,t){return this._client.post("/openai/v1/embeddings",{body:e,...t})}}class gd extends Mt{create(e,t){return this._client.post("/openai/v1/files",Jr({body:e,...t}))}list(e){return this._client.get("/openai/v1/files",e)}delete(e,t){return this._client.delete(`/openai/v1/files/${e}`,t)}content(e,t){return this._client.get(`/openai/v1/files/${e}/content`,t)}info(e,t){return this._client.get(`/openai/v1/files/${e}`,t)}}class bd extends Mt{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,t)}}var _d;class fe extends Qg{constructor({baseURL:e=cd("GROQ_BASE_URL"),apiKey:t=cd("GROQ_API_KEY"),...n}={}){if(t===void 0)throw new Et("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");const i={apiKey:t,...n,baseURL:e||"https://api.groq.com"};if(!i.dangerouslyAllowBrowser&&o0())throw new Et(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:i.baseURL,timeout:i.timeout??6e4,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new fd(this),this.chat=new Yr(this),this.embeddings=new yd(this),this.audio=new qn(this),this.models=new bd(this),this.batches=new hd(this),this.files=new gd(this),this._options=i,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}_d=fe,fe.Groq=_d,fe.DEFAULT_TIMEOUT=6e4,fe.GroqError=Et,fe.APIError=Ve,fe.APIConnectionError=ta,fe.APIConnectionTimeoutError=Zu,fe.APIUserAbortError=Kr,fe.NotFoundError=Qu,fe.ConflictError=Ju,fe.RateLimitError=Gu,fe.BadRequestError=Vu,fe.AuthenticationError=zu,fe.InternalServerError=Xu,fe.PermissionDeniedError=Ku,fe.UnprocessableEntityError=Hu,fe.toFile=sd,fe.fileFromPath=Fu,fe.Completions=fd,fe.Chat=Yr,fe.Embeddings=yd,fe.Audio=qn,fe.Models=bd,fe.Batches=hd,fe.Files=gd;const l0=["frequency_penalty","function_call","functions","logit_bias","logprobs","max_completion_tokens","max_tokens","n","parallel_tool_calls","presence_penalty","reasoning_format","response_format","seed","service_tier","stop","temperature","tool_choice","top_logprobs","top_p"],u0=["headers","promptIndex","stream_options","tools"],d0=[...l0,...u0];function p0(s){const e=s._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}}function vd(s){return s.map(e=>{var n;if(typeof e.content!="string")throw new Error("Non string message content not supported");const t={role:p0(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return ls(e)&&((n=e.tool_calls)!=null&&n.length)?t.tool_calls=e.tool_calls.map(bu):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function h0(s,e,t){const n=s.tool_calls;switch(s.role){case"assistant":{const i=[],a=[];for(const r of n??[])try{i.push(Ki(r,{returnId:!0}))}catch(o){a.push(qr(r,o.message))}return new Gs({content:s.content||"",additional_kwargs:{tool_calls:n},tool_calls:i,invalid_tool_calls:a,usage_metadata:e,response_metadata:t})}default:return new ma(s.content||"",s.role??"unknown")}}function m0(s,e,t,n){var p,h;const i=s.role??e,a=s.content??"";let r;s.function_call?r={function_call:s.function_call}:s.tool_calls?r={tool_calls:s.tool_calls}:r={},s.audio&&(r.audio={...s.audio,index:t.choices[0].index});let o,c=n,l;const u=t.x_groq;u!=null&&u.usage&&(o={input_tokens:u.usage.prompt_tokens,output_tokens:u.usage.completion_tokens,total_tokens:u.usage.total_tokens},l={completion_time:u.usage.completion_time,prompt_time:u.usage.prompt_time,queue_time:u.usage.queue_time,total_time:u.usage.total_time}),u!=null&&u.id&&(c=u.id);const d={usage:o,timing:l};if(i==="user")return new Cp({content:a,response_metadata:d});if(i==="assistant"){const m=[];if(Array.isArray(s.tool_calls))for(const y of s.tool_calls)m.push({name:(p=y.function)==null?void 0:p.name,args:(h=y.function)==null?void 0:h.arguments,id:y.id,index:y.index,type:"tool_call_chunk"});return new Xs({content:a,tool_call_chunks:m,additional_kwargs:r,id:c,response_metadata:d})}else return i==="system"?new fa({content:a,response_metadata:d}):i==="developer"?new fa({content:a,response_metadata:d,additional_kwargs:{__openai_role__:"developer"}}):i==="function"?new Ap({content:a,additional_kwargs:r,name:s.name,response_metadata:d}):i==="tool"?new Sp({content:a,additional_kwargs:r,tool_call_id:s.tool_call_id,response_metadata:d}):new Tp({content:a,role:i,response_metadata:d})}class f0 extends Lt{get lc_serialized_keys(){return["client","model","temperature","stop","stopSequences","maxTokens","streaming","apiKey","streamUsage","topP","frequencyPenalty","presencePenalty","logprobs","n","logitBias","user","reasoningFormat","serviceTier","topLogprobs"]}static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}get callKeys(){return[...super.callKeys,...d0]}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","groq"]}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceTier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=e.apiKey||ha("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');const n={"User-Agent":"langchainjs",...e.defaultHeaders??{}};this.client=new fe({apiKey:t,dangerouslyAllowBrowser:!0,baseURL:e.baseUrl,timeout:e.timeout,httpAgent:e.httpAgent,fetch:e.fetch,maxRetries:0,defaultHeaders:n,defaultQuery:e.defaultQuery}),this.apiKey=t,this.temperature=e.temperature??this.temperature,this.model=e.model,this.streaming=e.streaming??this.streaming,this.stop=e.stopSequences??(typeof e.stop=="string"?[e.stop]:e.stop)??[],this.stopSequences=this.stop,this.maxTokens=e.maxTokens,this.topP=e.topP,this.frequencyPenalty=e.frequencyPenalty,this.presencePenalty=e.presencePenalty,this.logprobs=e.logprobs,this.n=e.n,this.logitBias=e.logitBias,this.user=e.user}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"groq",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??this.temperature,ls_max_tokens:t.max_tokens??this.maxTokens,ls_stop:e.stop}}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e,t){var r;const n=super.invocationParams(e);let i={};(e==null?void 0:e.stream_options)!==void 0?i={stream_options:e.stream_options}:(this.streamUsage&&this.streaming||t!=null&&t.streaming)&&(i={stream_options:{include_usage:!0}});const a={model:this.model,frequency_penalty:this.frequencyPenalty,function_call:e==null?void 0:e.function_call,functions:e==null?void 0:e.functions,logit_bias:this.logitBias,logprobs:this.logprobs,n:this.n,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,presence_penalty:this.presencePenalty,reasoning_format:this.reasoningFormat,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,service_tier:this.serviceTier,stop:(e==null?void 0:e.stop)??this.stopSequences,temperature:(e==null?void 0:e.temperature)??this.temperature,tool_choice:y0(e==null?void 0:e.tool_choice),tools:(r=e==null?void 0:e.tools)!=null&&r.length?e.tools.map(o=>Wr(o)):void 0,top_logprobs:this.topLogprobs,top_p:this.topP,user:this.user,stream:this.streaming,...n,...i};return a.max_completion_tokens=(e==null?void 0:e.max_completion_tokens)??(e==null?void 0:e.max_tokens)??this.maxTokens,a.max_completion_tokens===-1&&delete a.max_completion_tokens,a}bindTools(e,t){return this.withConfig({tools:e.map(n=>Wr(n)),...t})}async*_streamResponseChunks(e,t,n){var u,d;const i=this.invocationParams(t,{streaming:!0}),a=vd(e),r=await this.completionWithRetry({...i,messages:a,stream:!0},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});let o,c,l;for await(const p of r){l=p;const h=p==null?void 0:p.choices[0];if(!h)continue;(u=h.delta)!=null&&u.role&&(o=h.delta.role);const m=m0(h.delta,o,p,c),y={prompt:t.promptIndex??0,completion:h.index??0};if(typeof m.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const f={...y};h.finish_reason!=null&&(f.finish_reason=h.finish_reason,f.system_fingerprint=p.system_fingerprint,f.model_name=p.model);const g=new us({message:m,text:m.content,generationInfo:f});yield g,await(n==null?void 0:n.handleLLMNewToken(g.text??"",y,void 0,void 0,void 0,{chunk:g}))}if(l&&("choices"in l&&delete l.choices,yield new us({message:new Xs({content:"",response_metadata:l}),text:""})),(d=t.signal)==null?void 0:d.aborted)throw new Error("AbortError")}async _generate(e,t,n){var i;if(this.streaming){const a={},r=this._streamResponseChunks(e,t,n),o={};for await(const c of r){const l=((i=c.generationInfo)==null?void 0:i.completion)??0;o[l]===void 0?o[l]=c:o[l]=o[l].concat(c)}return{generations:Object.entries(o).sort(([c],[l])=>parseInt(c,10)-parseInt(l,10)).map(([c,l])=>l),llmOutput:{estimatedTokenUsage:a}}}else return this._generateNonStreaming(e,t,n)}async _generateNonStreaming(e,t,n){var l;const i={},a=this.invocationParams(t),r=vd(e),o=await this.completionWithRetry({...a,stream:!1,messages:r},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});if("usage"in o&&o.usage){const{completion_tokens:u,prompt_tokens:d,total_tokens:p}=o.usage;u&&(i.completionTokens=(i.completionTokens??0)+u),d&&(i.promptTokens=(i.promptTokens??0)+d),p&&(i.totalTokens=(i.totalTokens??0)+p)}const c=[];if("choices"in o&&o.choices)for(const u of o.choices){const d=((l=u.message)==null?void 0:l.content)??"";let p;i.totalTokens!==void 0&&(p={input_tokens:i.promptTokens??0,output_tokens:i.completionTokens??0,total_tokens:i.totalTokens});const{choices:h,...m}=o,y={text:d,message:h0(u.message??{role:"assistant"},p,m)};y.generationInfo={...u.finish_reason?{finish_reason:u.finish_reason}:{},...u.logprobs?{logprobs:u.logprobs}:{}},c.push(y)}return{generations:c,llmOutput:{tokenUsage:i}}}withStructuredOutput(e,t){const n=e,i=t==null?void 0:t.name,a=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw;let o=i??"extract",c,l;if(a==="jsonMode")l=this.withConfig({response_format:{type:"json_object"}}),Wt(n)?c=Dr.fromZodSchema(n):c=new zi;else if(Wt(n)){const h=Kt(n);l=this.bindTools([{type:"function",function:{name:o,description:h.description,parameters:h}}]).withConfig({tool_choice:{type:"function",function:{name:o}}}),c=new Qi({returnSingle:!0,keyName:o,zodSchema:n})}else{let h;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(h=n,o=n.name):(o=n.title??o,h={name:o,description:n.description??"",parameters:n}),l=this.bindTools([{type:"function",function:h}]).withConfig({tool_choice:{type:"function",function:{name:o}}}),c=new Qi({returnSingle:!0,keyName:o})}if(!r)return l.pipe(c).withConfig({runName:"ChatGroqStructuredOutput"});const u=ns.assign({parsed:(h,m)=>c.invoke(h.raw,m)}),d=ns.assign({parsed:()=>null}),p=u.withFallbacks({fallbacks:[d]});return pa.from([{raw:l},p]).withConfig({runName:"ChatGroqStructuredOutput"})}}function y0(s){if(s)return s==="any"||s==="required"?"required":s==="auto"?"auto":s==="none"?"none":typeof s=="string"?{type:"function",function:{name:s}}:s}var wd;(function(s){s.STRING="string",s.NUMBER="number",s.INTEGER="integer",s.BOOLEAN="boolean",s.ARRAY="array",s.OBJECT="object"})(wd||(wd={}));var xd;(function(s){s.LANGUAGE_UNSPECIFIED="language_unspecified",s.PYTHON="python"})(xd||(xd={}));var Od;(function(s){s.OUTCOME_UNSPECIFIED="outcome_unspecified",s.OUTCOME_OK="outcome_ok",s.OUTCOME_FAILED="outcome_failed",s.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(Od||(Od={}));const Ed=["user","model","function","system"];var Md;(function(s){s.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",s.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",s.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",s.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",s.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",s.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(Md||(Md={}));var kd;(function(s){s.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE"})(kd||(kd={}));var Cd;(function(s){s.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",s.NEGLIGIBLE="NEGLIGIBLE",s.LOW="LOW",s.MEDIUM="MEDIUM",s.HIGH="HIGH"})(Cd||(Cd={}));var Ad;(function(s){s.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",s.SAFETY="SAFETY",s.OTHER="OTHER"})(Ad||(Ad={}));var Fn;(function(s){s.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",s.STOP="STOP",s.MAX_TOKENS="MAX_TOKENS",s.SAFETY="SAFETY",s.RECITATION="RECITATION",s.LANGUAGE="LANGUAGE",s.BLOCKLIST="BLOCKLIST",s.PROHIBITED_CONTENT="PROHIBITED_CONTENT",s.SPII="SPII",s.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",s.OTHER="OTHER"})(Fn||(Fn={}));var Sd;(function(s){s.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",s.RETRIEVAL_QUERY="RETRIEVAL_QUERY",s.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",s.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",s.CLASSIFICATION="CLASSIFICATION",s.CLUSTERING="CLUSTERING"})(Sd||(Sd={}));var Ks;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.AUTO="AUTO",s.ANY="ANY",s.NONE="NONE"})(Ks||(Ks={}));var Td;(function(s){s.MODE_UNSPECIFIED="MODE_UNSPECIFIED",s.MODE_DYNAMIC="MODE_DYNAMIC"})(Td||(Td={}));class ze extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class Qs extends ze{constructor(e,t){super(e),this.response=t}}class Pd extends ze{constructor(e,t,n,i){super(e),this.status=t,this.statusText=n,this.errorDetails=i}}class is extends ze{}class Nd extends ze{}const g0="https://generativelanguage.googleapis.com",b0="v1beta",_0="0.24.1",v0="genai-js";var xs;(function(s){s.GENERATE_CONTENT="generateContent",s.STREAM_GENERATE_CONTENT="streamGenerateContent",s.COUNT_TOKENS="countTokens",s.EMBED_CONTENT="embedContent",s.BATCH_EMBED_CONTENTS="batchEmbedContents"})(xs||(xs={}));class w0{constructor(e,t,n,i,a){this.model=e,this.task=t,this.apiKey=n,this.stream=i,this.requestOptions=a}toString(){var e,t;const n=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||b0;let i=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||g0}/${n}/${this.model}:${this.task}`;return this.stream&&(i+="?alt=sse"),i}}function x0(s){const e=[];return s!=null&&s.apiClient&&e.push(s.apiClient),e.push(`${v0}/${_0}`),e.join(" ")}async function O0(s){var e;const t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",x0(s.requestOptions)),t.append("x-goog-api-key",s.apiKey);let n=(e=s.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(n){if(!(n instanceof Headers))try{n=new Headers(n)}catch(i){throw new is(`unable to convert customHeaders value ${JSON.stringify(n)} to Headers: ${i.message}`)}for(const[i,a]of n.entries()){if(i==="x-goog-api-key")throw new is(`Cannot set reserved header name ${i}`);if(i==="x-goog-api-client")throw new is(`Header name ${i} can only be set using the apiClient field`);t.append(i,a)}}return t}async function E0(s,e,t,n,i,a){const r=new w0(s,e,t,n,a);return{url:r.toString(),fetchOptions:Object.assign(Object.assign({},A0(a)),{method:"POST",headers:await O0(r),body:i})}}async function Un(s,e,t,n,i,a={},r=fetch){const{url:o,fetchOptions:c}=await E0(s,e,t,n,i,a);return M0(o,c,r)}async function M0(s,e,t=fetch){let n;try{n=await t(s,e)}catch(i){k0(i,s)}return n.ok||await C0(n,s),n}function k0(s,e){let t=s;throw t.name==="AbortError"?(t=new Nd(`Request aborted when fetching ${e.toString()}: ${s.message}`),t.stack=s.stack):s instanceof Pd||s instanceof is||(t=new ze(`Error fetching from ${e.toString()}: ${s.message}`),t.stack=s.stack),t}async function C0(s,e){let t="",n;try{const i=await s.json();t=i.error.message,i.error.details&&(t+=` ${JSON.stringify(i.error.details)}`,n=i.error.details)}catch{}throw new Pd(`Error fetching from ${e.toString()}: [${s.status} ${s.statusText}] ${t}`,s.status,s.statusText,n)}function A0(s){const e={};if((s==null?void 0:s.signal)!==void 0||(s==null?void 0:s.timeout)>=0){const t=new AbortController;(s==null?void 0:s.timeout)>=0&&setTimeout(()=>t.abort(),s.timeout),s!=null&&s.signal&&s.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function eo(s){return s.text=()=>{if(s.candidates&&s.candidates.length>0){if(s.candidates.length>1&&console.warn(`This response had ${s.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),aa(s.candidates[0]))throw new Qs(`${as(s)}`,s);return S0(s)}else if(s.promptFeedback)throw new Qs(`Text not available. ${as(s)}`,s);return""},s.functionCall=()=>{if(s.candidates&&s.candidates.length>0){if(s.candidates.length>1&&console.warn(`This response had ${s.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),aa(s.candidates[0]))throw new Qs(`${as(s)}`,s);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),jd(s)[0]}else if(s.promptFeedback)throw new Qs(`Function call not available. ${as(s)}`,s)},s.functionCalls=()=>{if(s.candidates&&s.candidates.length>0){if(s.candidates.length>1&&console.warn(`This response had ${s.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),aa(s.candidates[0]))throw new Qs(`${as(s)}`,s);return jd(s)}else if(s.promptFeedback)throw new Qs(`Function call not available. ${as(s)}`,s)},s}function S0(s){var e,t,n,i;const a=[];if(!((t=(e=s.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const r of(i=(n=s.candidates)===null||n===void 0?void 0:n[0].content)===null||i===void 0?void 0:i.parts)r.text&&a.push(r.text),r.executableCode&&a.push("\n```"+r.executableCode.language+`
`+r.executableCode.code+"\n```\n"),r.codeExecutionResult&&a.push("\n```\n"+r.codeExecutionResult.output+"\n```\n");return a.length>0?a.join(""):""}function jd(s){var e,t,n,i;const a=[];if(!((t=(e=s.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const r of(i=(n=s.candidates)===null||n===void 0?void 0:n[0].content)===null||i===void 0?void 0:i.parts)r.functionCall&&a.push(r.functionCall);if(a.length>0)return a}const T0=[Fn.RECITATION,Fn.SAFETY,Fn.LANGUAGE];function aa(s){return!!s.finishReason&&T0.includes(s.finishReason)}function as(s){var e,t,n;let i="";if((!s.candidates||s.candidates.length===0)&&s.promptFeedback)i+="Response was blocked",!((e=s.promptFeedback)===null||e===void 0)&&e.blockReason&&(i+=` due to ${s.promptFeedback.blockReason}`),!((t=s.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(i+=`: ${s.promptFeedback.blockReasonMessage}`);else if(!((n=s.candidates)===null||n===void 0)&&n[0]){const a=s.candidates[0];aa(a)&&(i+=`Candidate was blocked due to ${a.finishReason}`,a.finishMessage&&(i+=`: ${a.finishMessage}`))}return i}function Wn(s){return this instanceof Wn?(this.v=s,this):new Wn(s)}function P0(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(s,e||[]),i,a=[];return i={},r("next"),r("throw"),r("return"),i[Symbol.asyncIterator]=function(){return this},i;function r(p){n[p]&&(i[p]=function(h){return new Promise(function(m,y){a.push([p,h,m,y])>1||o(p,h)})})}function o(p,h){try{c(n[p](h))}catch(m){d(a[0][3],m)}}function c(p){p.value instanceof Wn?Promise.resolve(p.value.v).then(l,u):d(a[0][2],p)}function l(p){o("next",p)}function u(p){o("throw",p)}function d(p,h){p(h),a.shift(),a.length&&o(a[0][0],a[0][1])}}const Id=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function N0(s){const e=s.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=R0(e),[n,i]=t.tee();return{stream:I0(n),response:j0(i)}}async function j0(s){const e=[],t=s.getReader();for(;;){const{done:n,value:i}=await t.read();if(n)return eo($0(e));e.push(i)}}function I0(s){return P0(this,arguments,function*(){const e=s.getReader();for(;;){const{value:t,done:n}=yield Wn(e.read());if(n)break;yield yield Wn(eo(t))}})}function R0(s){const e=s.getReader();return new ReadableStream({start(t){let n="";return i();function i(){return e.read().then(({value:a,done:r})=>{if(r){if(n.trim()){t.error(new ze("Failed to parse stream"));return}t.close();return}n+=a;let o=n.match(Id),c;for(;o;){try{c=JSON.parse(o[1])}catch{t.error(new ze(`Error parsing JSON response: "${o[1]}"`));return}t.enqueue(c),n=n.substring(o[0].length),o=n.match(Id)}return i()}).catch(a=>{let r=a;throw r.stack=a.stack,r.name==="AbortError"?r=new Nd("Request aborted when reading from the stream"):r=new ze("Error reading from the stream"),r})}}})}function $0(s){const e=s[s.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(const n of s){if(n.candidates){let i=0;for(const a of n.candidates)if(t.candidates||(t.candidates=[]),t.candidates[i]||(t.candidates[i]={index:i}),t.candidates[i].citationMetadata=a.citationMetadata,t.candidates[i].groundingMetadata=a.groundingMetadata,t.candidates[i].finishReason=a.finishReason,t.candidates[i].finishMessage=a.finishMessage,t.candidates[i].safetyRatings=a.safetyRatings,a.content&&a.content.parts){t.candidates[i].content||(t.candidates[i].content={role:a.content.role||"user",parts:[]});const r={};for(const o of a.content.parts)o.text&&(r.text=o.text),o.functionCall&&(r.functionCall=o.functionCall),o.executableCode&&(r.executableCode=o.executableCode),o.codeExecutionResult&&(r.codeExecutionResult=o.codeExecutionResult),Object.keys(r).length===0&&(r.text=""),t.candidates[i].content.parts.push(r)}i++}n.usageMetadata&&(t.usageMetadata=n.usageMetadata)}return t}async function Rd(s,e,t,n){const i=await Un(e,xs.STREAM_GENERATE_CONTENT,s,!0,JSON.stringify(t),n);return N0(i)}async function $d(s,e,t,n){const i=await(await Un(e,xs.GENERATE_CONTENT,s,!1,JSON.stringify(t),n)).json();return{response:eo(i)}}function Ld(s){if(s!=null){if(typeof s=="string")return{role:"system",parts:[{text:s}]};if(s.text)return{role:"system",parts:[s]};if(s.parts)return s.role?s:{role:"system",parts:s.parts}}}function Zn(s){let e=[];if(typeof s=="string")e=[{text:s}];else for(const t of s)typeof t=="string"?e.push({text:t}):e.push(t);return L0(e)}function L0(s){const e={role:"user",parts:[]},t={role:"function",parts:[]};let n=!1,i=!1;for(const a of s)"functionResponse"in a?(t.parts.push(a),i=!0):(e.parts.push(a),n=!0);if(n&&i)throw new ze("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!n&&!i)throw new ze("No content is provided for sending chat message.");return n?e:t}function B0(s,e){var t;let n={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(t=e==null?void 0:e.cachedContent)===null||t===void 0?void 0:t.name,contents:[]};const i=s.generateContentRequest!=null;if(s.contents){if(i)throw new is("CountTokensRequest must have one of contents or generateContentRequest, not both.");n.contents=s.contents}else if(i)n=Object.assign(Object.assign({},n),s.generateContentRequest);else{const a=Zn(s);n.contents=[a]}return{generateContentRequest:n}}function Bd(s){let e;return s.contents?e=s:e={contents:[Zn(s)]},s.systemInstruction&&(e.systemInstruction=Ld(s.systemInstruction)),e}function D0(s){return typeof s=="string"||Array.isArray(s)?{content:Zn(s)}:s}const Dd=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],q0={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function F0(s){let e=!1;for(const t of s){const{role:n,parts:i}=t;if(!e&&n!=="user")throw new ze(`First content should be with role 'user', got ${n}`);if(!Ed.includes(n))throw new ze(`Each item should include role field. Got ${n} but valid roles are: ${JSON.stringify(Ed)}`);if(!Array.isArray(i))throw new ze("Content should have 'parts' property with an array of Parts");if(i.length===0)throw new ze("Each Content should have at least one part");const a={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const o of i)for(const c of Dd)c in o&&(a[c]+=1);const r=q0[n];for(const o of Dd)if(!r.includes(o)&&a[o]>0)throw new ze(`Content with role '${n}' can't contain '${o}' part`);e=!0}}function qd(s){var e;if(s.candidates===void 0||s.candidates.length===0)return!1;const t=(e=s.candidates[0])===null||e===void 0?void 0:e.content;if(t===void 0||t.parts===void 0||t.parts.length===0)return!1;for(const n of t.parts)if(n===void 0||Object.keys(n).length===0||n.text!==void 0&&n.text==="")return!1;return!0}const Fd="SILENT_ERROR";class U0{constructor(e,t,n,i={}){this.model=t,this.params=n,this._requestOptions=i,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,n!=null&&n.history&&(F0(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,i,a,r,o,c;await this._sendPromise;const l=Zn(e),u={safetySettings:(n=this.params)===null||n===void 0?void 0:n.safetySettings,generationConfig:(i=this.params)===null||i===void 0?void 0:i.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,l]},d=Object.assign(Object.assign({},this._requestOptions),t);let p;return this._sendPromise=this._sendPromise.then(()=>$d(this._apiKey,this.model,u,d)).then(h=>{var m;if(qd(h.response)){this._history.push(l);const y=Object.assign({parts:[],role:"model"},(m=h.response.candidates)===null||m===void 0?void 0:m[0].content);this._history.push(y)}else{const y=as(h.response);y&&console.warn(`sendMessage() was unsuccessful. ${y}. Inspect response object for details.`)}p=h}).catch(h=>{throw this._sendPromise=Promise.resolve(),h}),await this._sendPromise,p}async sendMessageStream(e,t={}){var n,i,a,r,o,c;await this._sendPromise;const l=Zn(e),u={safetySettings:(n=this.params)===null||n===void 0?void 0:n.safetySettings,generationConfig:(i=this.params)===null||i===void 0?void 0:i.generationConfig,tools:(a=this.params)===null||a===void 0?void 0:a.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,l]},d=Object.assign(Object.assign({},this._requestOptions),t),p=Rd(this._apiKey,this.model,u,d);return this._sendPromise=this._sendPromise.then(()=>p).catch(h=>{throw new Error(Fd)}).then(h=>h.response).then(h=>{if(qd(h)){this._history.push(l);const m=Object.assign({},h.candidates[0].content);m.role||(m.role="model"),this._history.push(m)}else{const m=as(h);m&&console.warn(`sendMessageStream() was unsuccessful. ${m}. Inspect response object for details.`)}}).catch(h=>{h.message!==Fd&&console.error(h)}),p}}async function W0(s,e,t,n){return(await Un(e,xs.COUNT_TOKENS,s,!1,JSON.stringify(t),n)).json()}async function Z0(s,e,t,n){return(await Un(e,xs.EMBED_CONTENT,s,!1,JSON.stringify(t),n)).json()}async function V0(s,e,t,n){const i=t.requests.map(a=>Object.assign(Object.assign({},a),{model:e}));return(await Un(e,xs.BATCH_EMBED_CONTENTS,s,!1,JSON.stringify({requests:i}),n)).json()}class Ud{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=Ld(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;const i=Bd(e),a=Object.assign(Object.assign({},this._requestOptions),t);return $d(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},i),a)}async generateContentStream(e,t={}){var n;const i=Bd(e),a=Object.assign(Object.assign({},this._requestOptions),t);return Rd(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},i),a)}startChat(e){var t;return new U0(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const n=B0(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),i=Object.assign(Object.assign({},this._requestOptions),t);return W0(this.apiKey,this.model,n,i)}async embedContent(e,t={}){const n=D0(e),i=Object.assign(Object.assign({},this._requestOptions),t);return Z0(this.apiKey,this.model,n,i)}async batchEmbedContents(e,t={}){const n=Object.assign(Object.assign({},this._requestOptions),t);return V0(this.apiKey,this.model,e,n)}}ya=class{constructor(s){this.apiKey=s}getGenerativeModel(s,e){if(!s.model)throw new ze("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Ud(this.apiKey,s,e)}getGenerativeModelFromCachedContent(s,e,t){if(!s.name)throw new is("Cached content must contain a `name` field.");if(!s.model)throw new is("Cached content must contain a `model` field.");const n=["model","systemInstruction"];for(const a of n)if(e!=null&&e[a]&&s[a]&&(e==null?void 0:e[a])!==s[a]){if(a==="model"){const r=e.model.startsWith("models/")?e.model.replace("models/",""):e.model,o=s.model.startsWith("models/")?s.model.replace("models/",""):s.model;if(r===o)continue}throw new is(`Different value for "${a}" specified in modelParams (${e[a]}) and cachedContent (${s[a]})`)}const i=Object.assign(Object.assign({},e),{model:s.model,tools:s.tools,toolConfig:s.toolConfig,systemInstruction:s.systemInstruction,cachedContent:s});return new Ud(this.apiKey,i,t)}};function Os(s){if(typeof s=="object"&&s!==null){const e={...s};"additionalProperties"in e&&delete e.additionalProperties,"$schema"in e&&delete e.$schema,"strict"in e&&delete e.strict;for(const t in e)t in e&&(Array.isArray(e[t])?e[t]=e[t].map(Os):typeof e[t]=="object"&&e[t]!==null&&(e[t]=Os(e[t])));return e}return s}function to(s){const e=Os(Wt(s)?Kt(s):s),{$schema:t,...n}=e;return n}function z0(s){const e=Os(s),{$schema:t,...n}=e;return n}const Fe=[];for(let s=0;s<256;++s)Fe.push((s+256).toString(16).slice(1));function K0(s,e=0){return(Fe[s[e+0]]+Fe[s[e+1]]+Fe[s[e+2]]+Fe[s[e+3]]+"-"+Fe[s[e+4]]+Fe[s[e+5]]+"-"+Fe[s[e+6]]+Fe[s[e+7]]+"-"+Fe[s[e+8]]+Fe[s[e+9]]+"-"+Fe[s[e+10]]+Fe[s[e+11]]+Fe[s[e+12]]+Fe[s[e+13]]+Fe[s[e+14]]+Fe[s[e+15]]).toLowerCase()}let so;const Q0=new Uint8Array(16);function J0(){if(!so){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");so=crypto.getRandomValues.bind(crypto)}return so(Q0)}const H0=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Wd={randomUUID:H0};function Zd(s,e,t){var i;if(Wd.randomUUID&&!e&&!s)return Wd.randomUUID();s=s||{};const n=s.random??((i=s.rng)==null?void 0:i.call(s))??J0();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,K0(n)}function G0(s){const e=s._getType();return ma.isInstance(s)?s.role:e==="tool"?e:s.name??e}function X0(s){switch(s){case"supervisor":case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${s}`)}}function Y0(s){if("mimeType"in s&&"data"in s)return{inlineData:{mimeType:s.mimeType,data:s.data}};if("mimeType"in s&&"fileUri"in s)return{fileData:{mimeType:s.mimeType,fileUri:s.fileUri}};throw new Error("Invalid media content")}function eb(s,e){var t;return(t=e.map(n=>ls(n)?n.tool_calls??[]:[]).flat().find(n=>n.id===s.tool_call_id))==null?void 0:t.name}function tb(s){return{providerName:"Google Gemini",fromStandardTextBlock(e){return{text:e.text}},fromStandardImageBlock(e){if(!s)throw new Error("This model does not support images");if(e.source_type==="url"){const t=Kn({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)},fromStandardAudioBlock(e){if(!s)throw new Error("This model does not support audio");if(e.source_type==="url"){const t=Kn({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)},fromStandardFileBlock(e){if(!s)throw new Error("This model does not support files");if(e.source_type==="text")return{text:e.text};if(e.source_type==="url"){const t=Kn({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)}}}function Vd(s,e){var t;if(ro(s))return oo(s,tb(e));if(s.type==="text")return{text:s.text};if(s.type==="executableCode")return{executableCode:s.executableCode};if(s.type==="codeExecutionResult")return{codeExecutionResult:s.codeExecutionResult};if(s.type==="image_url"){if(!e)throw new Error("This model does not support images");let n;if(typeof s.image_url=="string")n=s.image_url;else if(typeof s.image_url=="object"&&"url"in s.image_url)n=s.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");const[i,a]=n.split(",");if(!i.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[r,o]=i.replace(/^data:/,"").split(";");if(o!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:a,mimeType:r}}}else{if(s.type==="media")return Y0(s);if(s.type==="tool_use")return{functionCall:{name:s.name,args:s.input}};if((t=s.type)!=null&&t.includes("/")&&s.type.split("/").length===2&&"data"in s&&typeof s.data=="string")return{inlineData:{mimeType:s.type,data:s.data}};if("functionCall"in s)return;throw"type"in s?new Error(`Unknown content type ${s.type}`):new Error(`Unknown content ${JSON.stringify(s)}`)}}function sb(s,e,t){var a;if(Qb(s)){const r=s.name??eb(s,t);if(r===void 0)throw new Error(`Google requires a tool name for each tool call response, and we could not infer a called tool name for ToolMessage "${s.id}" from your passed messages. Please populate a "name" field on that ToolMessage explicitly.`);const o=Array.isArray(s.content)?s.content.map(c=>Vd(c,e)).filter(c=>c!==void 0):s.content;return s.status==="error"?[{functionResponse:{name:r,response:{error:{details:o}}}}]:[{functionResponse:{name:r,response:{result:o}}}]}let n=[];const i=[];return typeof s.content=="string"&&s.content&&i.push({text:s.content}),Array.isArray(s.content)&&i.push(...s.content.map(r=>Vd(r,e)).filter(r=>r!==void 0)),ls(s)&&((a=s.tool_calls)!=null&&a.length)&&(n=s.tool_calls.map(r=>({functionCall:{name:r.name,args:r.args}}))),[...i,...n]}function zd(s,e,t=!1){return s.reduce((n,i,a)=>{if(!ao(i))throw new Error("Unsupported message input");const r=G0(i);if(r==="system"&&a!==0)throw new Error("System message should be the first one");const o=X0(r),c=n.content[n.content.length];if(!n.mergeWithPreviousContent&&c&&c.role===o)throw new Error("Google Generative AI requires alternate messages between authors");const l=sb(i,e,s.slice(0,a));if(n.mergeWithPreviousContent){const p=n.content[n.content.length-1];if(!p)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return p.parts.push(...l),{mergeWithPreviousContent:!1,content:n.content}}let u=o;(u==="function"||u==="system"&&!t)&&(u="user");const d={role:u,parts:l};return{mergeWithPreviousContent:r==="system"&&!t,content:[...n.content,d]}},{content:[],mergeWithPreviousContent:!1}).content}function nb(s,e){var c,l,u,d;if(!s.candidates||s.candidates.length===0||!s.candidates[0])return{generations:[],llmOutput:{filters:s.promptFeedback}};const t=s.functionCalls(),[n]=s.candidates,{content:i,...a}=n;let r;Array.isArray(i==null?void 0:i.parts)&&i.parts.length===1&&i.parts[0].text?r=i.parts[0].text:Array.isArray(i==null?void 0:i.parts)&&i.parts.length>0?r=i.parts.map(p=>"text"in p?{type:"text",text:p.text}:"executableCode"in p?{type:"executableCode",executableCode:p.executableCode}:"codeExecutionResult"in p?{type:"codeExecutionResult",codeExecutionResult:p.codeExecutionResult}:p):r=[];let o="";return typeof r=="string"?o=r:Array.isArray(r)&&r.length>0&&(o=((c=r.find(p=>"text"in p))==null?void 0:c.text)??o),{generations:[{text:o,message:new Gs({content:r??"",tool_calls:t==null?void 0:t.map(p=>({...p,type:"tool_call",id:"id"in p&&typeof p.id=="string"?p.id:Zd()})),additional_kwargs:{...a},usage_metadata:e==null?void 0:e.usageMetadata}),generationInfo:a}],llmOutput:{tokenUsage:{promptTokens:(l=e==null?void 0:e.usageMetadata)==null?void 0:l.input_tokens,completionTokens:(u=e==null?void 0:e.usageMetadata)==null?void 0:u.output_tokens,totalTokens:(d=e==null?void 0:e.usageMetadata)==null?void 0:d.total_tokens}}}}function ib(s,e){var l;if(!s.candidates||s.candidates.length===0)return null;const t=s.functionCalls(),[n]=s.candidates,{content:i,...a}=n;let r;Array.isArray(i==null?void 0:i.parts)&&i.parts.every(u=>"text"in u)?r=i.parts.map(u=>u.text).join(""):Array.isArray(i==null?void 0:i.parts)?r=i.parts.map(u=>"text"in u?{type:"text",text:u.text}:"executableCode"in u?{type:"executableCode",executableCode:u.executableCode}:"codeExecutionResult"in u?{type:"codeExecutionResult",codeExecutionResult:u.codeExecutionResult}:u):r=[];let o="";r&&typeof r=="string"?o=r:Array.isArray(r)&&(o=((l=r.find(u=>"text"in u))==null?void 0:l.text)??"");const c=[];return t&&c.push(...t.map(u=>({...u,args:JSON.stringify(u.args),index:e.index,type:"tool_call_chunk",id:"id"in u&&typeof u.id=="string"?u.id:Zd()}))),new us({text:o,message:new Xs({content:r||"",name:i?i.role:void 0,tool_call_chunks:c,additional_kwargs:{},usage_metadata:e.usageMetadata}),generationInfo:a})}function ab(s){return s.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?s:[{functionDeclarations:s.map(e=>{if(Gi(e)){const t=to(e.schema);return t.type==="object"&&"properties"in t&&Object.keys(t.properties).length===0?{name:e.name,description:e.description}:{name:e.name,description:e.description,parameters:t}}return Zi(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:z0(e.function.parameters)}:e})}]}class Kd extends fu{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await kp(this.zodSchema,e);if(t.success)return t.data;throw new Vi(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.issues)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap(i=>{const{message:a}=i;return!("tool_calls"in a)||!Array.isArray(a.tool_calls)?[]:a.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function Qd(s,e){const t=rb(s),n=cb(t,e);return{tools:t,toolConfig:n}}function rb(s){let e=[];const t=[];return s.forEach(n=>{if(Gi(n)){const[i]=ab([n]);i.functionDeclarations&&e.push(...i.functionDeclarations)}else if(Zi(n)){const{functionDeclarations:i}=ob(n);if(i)e.push(...i);else throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else t.push(n)}),t.find(n=>"functionDeclarations"in n)?t.map(n=>{if((e==null?void 0:e.length)>0&&"functionDeclarations"in n){const i={functionDeclarations:[...n.functionDeclarations||[],...e]};return e=[],i}return n}):[...t,...e.length>0?[{functionDeclarations:e}]:[]]}function ob(s){return{functionDeclarations:[{name:s.function.name,description:s.function.description,parameters:Os(s.function.parameters)}]}}function cb(s,e){if(!s.length||!e)return;const{toolChoice:t,allowedFunctionNames:n}=e,i={any:Ks.ANY,auto:Ks.AUTO,none:Ks.NONE};if(t&&["any","auto","none"].includes(t))return{functionCallingConfig:{mode:i[t]??"MODE_UNSPECIFIED",allowedFunctionNames:n}};if(typeof t=="string"||n)return{functionCallingConfig:{mode:Ks.ANY,allowedFunctionNames:[...n??[],...t&&typeof t=="string"?[t]:[]]}}}class lb extends Lt{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"json",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model.replace(/^models\//,""),this.maxOutputTokens=e.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw new Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=e.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e.stopSequences??this.stopSequences,this.apiKey=e.apiKey??ha("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(t=>t.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=e.streaming??this.streaming,this.json=e.json,this.client=new ya(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...this.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e.apiVersion,baseUrl:e.baseUrl}),this.streamUsage=e.streamUsage??this.streamUsage}useCachedContent(e,t,n){this.apiKey&&(this.client=new ya(this.apiKey).getGenerativeModelFromCachedContent(e,t,n))}get useSystemInstruction(){return typeof this.convertSystemMessageToHumanContent=="boolean"?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return this.model==="gemini-1.0-pro-001"||this.model.startsWith("gemini-pro-vision")||this.model.startsWith("gemini-1.0-pro-vision")?!1:this.model!=="gemini-pro"}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){var n;return this.withConfig({tools:(n=Qd(e))==null?void 0:n.tools,...t})}invocationParams(e){var n;const t=(n=e==null?void 0:e.tools)!=null&&n.length?Qd(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return e!=null&&e.responseSchema?(this.client.generationConfig.responseSchema=e.responseSchema,this.client.generationConfig.responseMimeType="application/json"):(this.client.generationConfig.responseSchema=void 0,this.client.generationConfig.responseMimeType=this.json?"application/json":void 0),{...t!=null&&t.tools?{tools:t.tools}:{},...t!=null&&t.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,n){var u,d,p;const i=zd(e,this._isMultimodalModel,this.useSystemInstruction);let a=i;if(i[0].role==="system"){const[h]=i;this.client.systemInstruction=h,a=i.slice(1)}const r=this.invocationParams(t);if(this.streaming){const h={},m=this._streamResponseChunks(e,t,n),y={};for await(const f of m){const g=((u=f.generationInfo)==null?void 0:u.completion)??0;y[g]===void 0?y[g]=f:y[g]=y[g].concat(f)}return{generations:Object.entries(y).sort(([f],[g])=>parseInt(f,10)-parseInt(g,10)).map(([f,g])=>g),llmOutput:{estimatedTokenUsage:h}}}const o=await this.completionWithRetry({...r,contents:a});let c;if("usageMetadata"in o.response){const h=o.response.usageMetadata;c={input_tokens:h.promptTokenCount??0,output_tokens:h.candidatesTokenCount??0,total_tokens:h.totalTokenCount??0}}const l=nb(o.response,{usageMetadata:c});return((d=l.generations)==null?void 0:d.length)>0&&await(n==null?void 0:n.handleLLMNewToken(((p=l.generations[0])==null?void 0:p.text)??"")),l}async*_streamResponseChunks(e,t,n){const i=zd(e,this._isMultimodalModel,this.useSystemInstruction);let a=i;if(i[0].role==="system"){const[u]=i;this.client.systemInstruction=u,a=i.slice(1)}const r={...this.invocationParams(t),contents:a},o=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{const{stream:u}=await this.client.generateContentStream(r);return u});let c,l=0;for await(const u of o){if("usageMetadata"in u&&this.streamUsage!==!1&&t.streamUsage!==!1){const p=u.usageMetadata;if(!c)c={input_tokens:p.promptTokenCount??0,output_tokens:p.candidatesTokenCount??0,total_tokens:p.totalTokenCount??0};else{const h=(p.candidatesTokenCount??0)-c.output_tokens;c={input_tokens:0,output_tokens:h,total_tokens:h}}}const d=ib(u,{usageMetadata:c,index:l});l+=1,d&&(yield d,await(n==null?void 0:n.handleLLMNewToken(d.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var n;try{return await this.client.generateContent(e)}catch(i){throw(n=i.message)!=null&&n.includes("400 Bad Request")&&(i.status=400),i}})}withStructuredOutput(e,t){const n=e,i=t==null?void 0:t.name,a=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw;if(a==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "jsonSchema" or "functionCalling" as a method.');let o,c;if(a==="functionCalling"){let p=i??"extract",h;if(Wt(n)){const m=to(n);h=[{functionDeclarations:[{name:p,description:m.description??"A function available to call.",parameters:m}]}],c=new Kd({returnSingle:!0,keyName:p,zodSchema:n})}else{let m;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(m=n,m.parameters=Os(n.parameters),p=n.name):m={name:p,description:n.description??"",parameters:Os(n)},h=[{functionDeclarations:[m]}],c=new Kd({returnSingle:!0,keyName:p})}o=this.bindTools(h).withConfig({allowedFunctionNames:[p]})}else{const p=to(n);o=this.withConfig({responseSchema:p}),c=new zi}if(!r)return o.pipe(c).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const l=ns.assign({parsed:(p,h)=>c.invoke(p.raw,h)}),u=ns.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return pa.from([{raw:o},d]).withConfig({runName:"StructuredOutputRunnable"})}}let Jd,ra,Hd,Gd,Xd,Yd,ep,tp,sp,np,ip,ap,rp,op,cp,lp,up;qp=s=>{const e=(t,n=null)=>{let i=`{
`;return t.filter(a=>a.parent_id===n).forEach(a=>{if(a.type==="object"){const r=s.filter(c=>c.parent_id===a.id),o=e(r,a.id);i+=`  ${a.name}${a.required?"":"?"}: ${o}
`}else i+=`  // ${a.description||""}
  ${a.name}${a.required?"":"?"}: ${a.type};
`}),i+="}",i};return e(s)},Rp=s=>{const e=(n,i=null)=>{let a="";return n.filter(r=>r.parent_id===i).forEach(r=>{if(r.type==="object"){const o=e(n,r.id);a+=`    ${r.name}: z.object({
${o}    })${r.required?"":".optional()"}.describe('${r.description||""}'),
`}else a+=`    ${r.name}: z.${r.type}()${r.required?"":".optional()"}.describe('${r.description||""}'),
`}),a};let t=`const schema = z.object({
`;return t+=e(s),t+="});",t},Jd=s=>{const e={},t={string:St.string,number:St.number,boolean:St.boolean,enum:()=>St.enum([""])};return s.forEach(n=>{if(!n.parent_id)if(n.type==="object"){const i=s.filter(r=>r.parent_id===n.id),a={};i.forEach(r=>{r.type==="object"||r.type==="array"||(a[r.name]=t[r.type](),r.required||(a[r.name]=a[r.name].optional()))}),e[n.name]=St.object(a),n.required||(e[n.name]=e[n.name].optional())}else n.type==="array"?(e[n.name]=St.array(St.string()),n.required||(e[n.name]=e[n.name].optional())):n.type==="enum"?(e[n.name]=St.enum((n.enum||"").split(",")),n.required||(e[n.name]=e[n.name].optional())):(e[n.name]=t[n.type](),n.required||(e[n.name]=e[n.name].optional()))}),St.object(e)},yo=()=>{const{toast:s}=fb(),{t:e}=fp("errors"),t=Jb(i=>i.currentSession),{modalRef:n}=ho(po);return{confirmPassphrase:M.useCallback(async()=>{if(!(t!=null&&t.passphrase))throw new Error("Session is not found");await ua.exists("passphrase")||await new Promise((i,a)=>{n.current.show({onConfirm:async r=>{try{const o=await Qn(t.passphrase,r);await ua.set("passphrase",o),i()}catch(o){s({content:e("invalid_passphrase"),variant:"destructive"}),a(o)}finally{n.current.hide()}},onCancel:()=>{a()}})})},[t==null?void 0:t.passphrase,n,e,s])}},ra=async(s,e,{schemas:t,onMessageUpdate:n})=>{let i="",a;if(t!=null&&t.length){const r=t.filter(c=>{var l;return(l=c.schema_items)==null?void 0:l.length}).flatMap(c=>c.schema_items),o=await s.withStructuredOutput(Jd(r)).stream(e);for await(const c of o)i=JSON.stringify(c),n==null||n({content:i})}else{const r=await s.stream(e);for await(const o of r)i+=`${o.content}`,a=o,n==null||n({content:i,chunk:o})}return{lastChunk:a,content:i}},Hd=()=>{const{confirmPassphrase:s}=yo();return{stream:M.useCallback(async(e,t)=>{var p,h,m,y,f;const{schemas:n,onMessageUpdate:i,onMessageFinish:a}=t||{};await s();const r=(p=t==null?void 0:t.llm)==null?void 0:p.encrypted,o=((h=t==null?void 0:t.llm)==null?void 0:h.options)||{};if(!(r!=null&&r.key)||typeof r.key!="string")throw new Error("API Key is not found");const c=await ua.get("passphrase");if(!c)throw new Error("Passphrase is not found");const l=await Qn(r.key,c);if(!l)throw new Error("API Key is not found");let u="",d;switch(t==null?void 0:t.provider){case Ge.GoogleGenerativeAI:{const g=new lb({apiKey:l,model:((m=t==null?void 0:t.llm)==null?void 0:m.name)||"gemini-1.5-flash",temperature:o!=null&&o.temperature?+o.temperature:void 0,topK:o!=null&&o.topK?+o.topK:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxOutputTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0});if(r!=null&&r.enabled_google_search_retrieval){const v={googleSearchRetrieval:{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.7}}};g.bindTools([v])}const b=await ra(g,e,{schemas:n,onMessageUpdate:i});u=b.content,d=b.lastChunk}break;case Ge.Groq:{const g=new f0({apiKey:l,model:((y=t==null?void 0:t.llm)==null?void 0:y.name)||"",temperature:o!=null&&o.temperature?+o.temperature:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),b=await ra(g,e,{schemas:n,onMessageUpdate:i});u=b.content,d=b.lastChunk}break;case Ge.OpenAI:{const g=new jg({apiKey:l,model:(f=t==null?void 0:t.llm)==null?void 0:f.name,temperature:o!=null&&o.temperature?+o.temperature:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),b=await ra(g,e,{schemas:n,onMessageUpdate:i});u=b.content,d=b.lastChunk}break;default:throw new Error("Provider is not supported")}return a==null||a({content:u,lastChunk:d}),{lastChunk:d,content:u}},[s])}},Dp=()=>{const s=Kp(),e=Hd();return{stream:M.useCallback((t,n,i)=>{switch(t){case Ge.WebLLM:case Ge.Wllama:return s.stream(n,i);case Ge.GoogleGenerativeAI:case Ge.Groq:case Ge.OpenAI:return e.stream(n,{...i,provider:t});default:throw new Error("Provider is not supported")}},[e,s])}},Gd=s=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",fill:"none",height:192,viewBox:"0 0 150 150",width:192,...s},M.createElement("clipPath",{id:"a"},M.createElement("path",{d:"m0 0h150v150h-150z"})),M.createElement("g",{clipPath:"url(#a)"},M.createElement("path",{d:"m150 0h-150v150h150z",fill:"#29b5e8"}),M.createElement("path",{clipRule:"evenodd",d:"m130.375 67.2532-14.096 8.1221 14.096 8.0536c.843.4872 1.581 1.1357 2.174 1.9084.592.7727 1.026 1.6545 1.278 2.5951.251.9406.315 1.9215.188 2.8867-.128.9652-.444 1.8959-.931 2.7388-.488.843-1.136 1.5817-1.909 2.174s-1.654 1.0267-2.595 1.2782-1.921.3154-2.887.1878c-.965-.1275-1.896-.444-2.739-.9312l-25.2559-14.5496c-1.1575-.6696-2.1128-1.6394-2.765-2.8068-.6523-1.1674-.9773-2.4893-.9408-3.826.0198-.5792.1089-1.1538.2653-1.7117.517-1.8711 1.7458-3.4654 3.4234-4.4419l25.256-14.4983c.847-.4892 1.782-.8067 2.751-.9343.97-.1275 1.955-.0627 2.899.1909.945.2536 1.83.6909 2.605 1.287.775.596 1.425 1.3391 1.913 2.1866.49.8402.808 1.7693.935 2.7334.128.964.063 1.9439-.191 2.8826-.254.9388-.692 1.8177-1.288 2.5859-.597.7681-1.34 1.4101-2.186 1.8887zm-13.343 39.3698-25.2478-14.5243c-1.1296-.6483-2.4091-.9896-3.7115-.9902s-2.5823.3397-3.7124.987c-1.1301.6472-2.0712 1.579-2.7297 2.7026-.6585 1.1237-1.0115 2.4001-1.0239 3.7024v29.0135c.0654 1.928.8772 3.755 2.264 5.095 1.3869 1.341 3.2403 2.09 5.1691 2.09 1.9289 0 3.7823-.749 5.1691-2.09 1.3868-1.34 2.1986-3.167 2.264-5.095v-16.261l14.1301 8.122c.843.488 1.774.805 2.739.933.966.128 1.947.064 2.888-.187s1.823-.685 2.596-1.277c.774-.592 1.423-1.331 1.91-2.174.488-.843.805-1.773.933-2.739.128-.965.065-1.946-.186-2.887s-.685-1.824-1.277-2.597-1.331-1.422-2.174-1.91zm-29.0992-28.3806-10.527 10.3986c-.3601.3349-.8269.5319-1.318.5563h-3.0897c-.49-.0294-.9551-.2257-1.318-.5563l-10.4671-10.4329c-.3274-.3573-.521-.817-.5478-1.3009v-3.081c.0283-.4861.2215-.9481.5478-1.3095l10.4671-10.4329c.3637-.3281.829-.5214 1.318-.5477h3.0897c.4899.0228.9562.2166 1.318.5477l10.4928 10.4329c.3237.3623.514.8243.5392 1.3095v3.081c-.0237.483-.2143.9428-.5392 1.3009zm-8.3874-2.8928c-.0404-.499-.2485-.9696-.5905-1.3352l-3.0383-3.004c-.3641-.3275-.8291-.5207-1.318-.5478h-.1113c-.4867.0255-.9495.2191-1.3094.5478l-3.0383 3.004c-.3262.3676-.5165.8358-.5392 1.3266v.1113c.0215.4834.2124.9439.5392 1.3009l3.0554 2.9955c.3607.3274.823.5208 1.3094.5477h.1113c.4889-.027.9539-.2203 1.318-.5477l3.0383-3.0212c.3282-.3576.5244-.8166.5563-1.3009zm-47.4914-31.2217 25.2563 14.4811c1.1308.648 2.4115.989 3.7149.9889 1.3033 0 2.584-.3409 3.7148-.989 1.1309-.648 2.0725-1.5806 2.7314-2.7051.659-1.1245 1.0123-2.4018 1.0249-3.7051v-28.9879c-.0654-1.9277-.8772-3.7546-2.264-5.0952s-3.2402-2.0899-5.1691-2.0899c-1.9288 0-3.7822.7493-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v16.2613l-14.1473-8.1307c-.8429-.4877-1.7737-.8047-2.7392-.9328-.9654-.1281-1.9466-.0647-2.8876.1864s-1.8232.6852-2.5965 1.2773c-.7732.5921-1.4222 1.3307-1.91 2.1736-.4878.843-.8048 1.7738-.9329 2.7392-.128.9655-.0647 1.9467.1864 2.8876.2512.941.6852 1.8233 1.2773 2.5965.5921.7733 1.3307 1.4223 2.1737 1.9101zm55.4252 15.4739c1.4914.118 2.9836-.2193 4.2793-.9671l25.2475-14.5496c.843-.4877 1.582-1.1368 2.174-1.91s1.026-1.6555 1.277-2.5965.315-1.9222.187-2.8876c-.128-.9655-.445-1.8962-.933-2.7392-.488-.8429-1.137-1.5816-1.91-2.1737-.774-.5921-1.656-1.0261-2.597-1.2772-1.9-.5072-3.924-.2387-5.627.7464l-14.1298 8.1991v-16.2613c-.0654-1.9277-.8772-3.7546-2.264-5.0952-1.3868-1.3405-3.2402-2.0899-5.1691-2.0899-1.9288 0-3.7822.7494-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v29.0136c-.0023 1.8784.7086 3.6876 1.9892 5.0619 1.2805 1.3743 3.0351 2.2111 4.909 2.3412zm-25.8554 31.5298c-1.4916-.1213-2.9847.2162-4.2793.9671l-25.2905 14.4893c-1.7024.985-2.9438 2.607-3.451 4.507s-.2387 3.924.7465 5.627c.9851 1.702 2.6061 2.943 4.5065 3.451 1.9004.507 3.9244.238 5.6268-.747l14.1473-8.122v16.261c.0654 1.928.8772 3.755 2.2641 5.096 1.3868 1.34 3.2402 2.09 5.169 2.09 1.9289 0 3.7823-.75 5.1691-2.09 1.3868-1.341 2.1986-3.168 2.264-5.096v-29.0645c-.0038-1.869-.7144-3.6673-1.9891-5.0341s-3.0192-2.2009-4.8834-2.3348zm-6.8468-13.5825c.4875-1.6032.414-3.3247-.2083-4.8806-.6224-1.5559-1.7564-2.8532-3.2152-3.6779l-25.2306-14.541c-1.704-.976-3.7248-1.2385-5.6216-.7303-1.8968.5083-3.5155 1.7461-4.5032 3.4433-.4889.84-.8065 1.7686-.9343 2.732-.1278.9635-.0632 1.9428.1899 2.8811.2531.9384.6897 1.8173 1.2846 2.5858.595.7686 1.3364 1.4115 2.1814 1.8917l14.096 8.1221-14.096 8.0536c-.8429.4861-1.5819 1.1334-2.1746 1.9051-.5928.7717-1.0277 1.6526-1.2801 2.5923-.2523.9398-.317 1.9201-.1905 2.8849s.4418 1.8952.9279 2.7382c.4861.8429 1.1335 1.5819 1.9051 2.1746.7717.5928 1.6526 1.0277 2.5924 1.2801.9397.2523 1.92.317 2.8848.1905s1.8952-.4418 2.7382-.9279l25.2306-14.5496c1.6248-.9071 2.8451-2.3965 3.4149-4.168z",fill:"#fff",fillRule:"evenodd"}))),Xd=s=>M.createElement("svg",{className:"mr-2 w-5 h-5",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",width:48,height:48,...s},M.createElement("path",{fill:"#fbc02d",d:"M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20 s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"}),M.createElement("path",{fill:"#e53935",d:"M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039 l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"}),M.createElement("path",{fill:"#4caf50",d:"M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"}),M.createElement("path",{fill:"#1565c0",d:"M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"})),Yd=s=>M.createElement("svg",{className:"mr-2 w-5 h-5",width:1024,height:1024,viewBox:"0 0 1024 1024",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},M.createElement("path",{d:"M44.522 44.5217H489.739V489.739H44.522V44.5217Z",fill:"#F35325"}),M.createElement("path",{d:"M534.261 44.5217H979.478V489.739H534.261V44.5217Z",fill:"#81BC06"}),M.createElement("path",{d:"M44.522 534.261H489.739V979.478H44.522V534.261Z",fill:"#05A6F0"}),M.createElement("path",{d:"M534.261 534.261H979.478V979.478H534.261V534.261Z",fill:"#FFBA08"})),ep=s=>M.createElement("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 287.56 191",...s},M.createElement("defs",null,M.createElement("style",null,".cls-1{fill:#0081fb;}.cls-2{fill:url(#linear-gradient);}.cls-3{fill:url(#linear-gradient-2);}"),M.createElement("linearGradient",{id:"linear-gradient",x1:62.34,y1:101.45,x2:260.34,y2:91.45,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},M.createElement("stop",{offset:0,stopColor:"#0064e1"}),M.createElement("stop",{offset:.4,stopColor:"#0064e1"}),M.createElement("stop",{offset:.83,stopColor:"#0073ee"}),M.createElement("stop",{offset:1,stopColor:"#0082fb"})),M.createElement("linearGradient",{id:"linear-gradient-2",x1:41.42,y1:53,x2:41.42,y2:126,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},M.createElement("stop",{offset:0,stopColor:"#0082fb"}),M.createElement("stop",{offset:1,stopColor:"#0064e0"}))),M.createElement("title",null,"facebook-meta"),M.createElement("path",{className:"cls-1",d:"M31.06,126c0,11,2.41,19.41,5.56,24.51A19,19,0,0,0,53.19,160c8.1,0,15.51-2,29.79-21.76,11.44-15.83,24.92-38,34-52l15.36-23.6c10.67-16.39,23-34.61,37.18-47C181.07,5.6,193.54,0,206.09,0c21.07,0,41.14,12.21,56.5,35.11,16.81,25.08,25,56.67,25,89.27,0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191V160c17.63,0,22-16.2,22-34.74,0-26.42-6.16-55.74-19.73-76.69-9.63-14.86-22.11-23.94-35.84-23.94-14.85,0-26.8,11.2-40.23,31.17-7.14,10.61-14.47,23.54-22.7,38.13l-9.06,16c-18.2,32.27-22.81,39.62-31.91,51.75C84.74,183,71.12,191,53.19,191c-21.27,0-34.72-9.21-43-23.09C3.34,156.6,0,141.76,0,124.85Z"}),M.createElement("path",{className:"cls-2",d:"M24.49,37.3C38.73,15.35,59.28,0,82.85,0c13.65,0,27.22,4,41.39,15.61,15.5,12.65,32,33.48,52.63,67.81l7.39,12.32c17.84,29.72,28,45,33.93,52.22,7.64,9.26,13,12,19.94,12,17.63,0,22-16.2,22-34.74l27.4-.86c0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191c-12.8,0-24.14-2.78-36.68-14.61-9.64-9.08-20.91-25.21-29.58-39.71L146.08,93.6c-12.94-21.62-24.81-37.74-31.68-45C107,40.71,97.51,31.23,82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78Z"}),M.createElement("path",{className:"cls-3",d:"M82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78C38.61,71.62,31.06,99.34,31.06,126c0,11,2.41,19.41,5.56,24.51L10.14,167.91C3.34,156.6,0,141.76,0,124.85,0,94.1,8.44,62.05,24.49,37.3,38.73,15.35,59.28,0,82.85,0Z"})),tp=s=>M.createElement("svg",{className:"mr-2 w-5 h-5",width:256,height:233,viewBox:"0 0 256 233",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},M.createElement("path",{d:"M186.182 0h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#f7d046",d:"M209.455 0H256v46.545h-46.545z"}),M.createElement("path",{d:"M0 0h46.545v46.545H0zm0 46.545h46.545V93.09H0zm0 46.546h46.545v46.545H0zm0 46.545h46.545v46.545H0zm0 46.546h46.545v46.545H0z"}),M.createElement("path",{fill:"#f7d046",d:"M23.273 0h46.545v46.545H23.273z"}),M.createElement("path",{fill:"#f2a73b",d:"M209.455 46.545H256V93.09h-46.545zm-186.182 0h46.545V93.09H23.273z"}),M.createElement("path",{d:"M139.636 46.545h46.545V93.09h-46.545z"}),M.createElement("path",{fill:"#f2a73b",d:"M162.909 46.545h46.545V93.09h-46.545zm-93.091 0h46.545V93.09H69.818z"}),M.createElement("path",{fill:"#ee792f",d:"M116.364 93.091h46.545v46.545h-46.545zm46.545 0h46.545v46.545h-46.545zm-93.091 0h46.545v46.545H69.818z"}),M.createElement("path",{d:"M93.091 139.636h46.545v46.545H93.091z"}),M.createElement("path",{fill:"#eb5829",d:"M116.364 139.636h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#ee792f",d:"M209.455 93.091H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"}),M.createElement("path",{d:"M186.182 139.636h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#eb5829",d:"M209.455 139.636H256v46.545h-46.545z"}),M.createElement("path",{d:"M186.182 186.182h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#eb5829",d:"M23.273 139.636h46.545v46.545H23.273z"}),M.createElement("path",{fill:"#ea3326",d:"M209.455 186.182H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"})),sp="/NoLLMChat/assets/qwen-B-gSh3_v.webp",np="/NoLLMChat/assets/smollm-CikBjd4F.png",ip="/NoLLMChat/assets/stablelm-BquePdQ7.png",ap="/NoLLMChat/assets/nomic-BjJqoFji.webp",rp="/NoLLMChat/assets/joshua-ByaReJuI.webp",op="/NoLLMChat/assets/deepseek-CRqFMahi.png",cp="/NoLLMChat/assets/redpajama-CmUGqSQW.png",lp=s=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...s},M.createElement("path",{fill:"#fff",d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),up=s=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...s},M.createElement("path",{d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),Ip=M.memo(({name:s,className:e,...t})=>{const n=yb(i=>i.theme);return s=s.toLowerCase(),s.includes("gpt")?n==="dark"?se.jsx(lp,{className:je("w-5 h-5",e),...t}):se.jsx(up,{className:je("w-5 h-5",e),...t}):s!=null&&s.includes("deepseek")?se.jsx("img",{className:je("w-5 h-5 rounded-full",e),src:op,alt:"deepseek",...t}):s!=null&&s.includes("redpajama")?se.jsx("img",{className:je("w-5 h-5 rounded-full",e),src:cp,alt:"deepseek",...t}):s.includes("gemma")||s.includes("gemini")?se.jsx(Xd,{className:je("w-5 h-5",e),...t}):s!=null&&s.includes("qwen")?se.jsx("img",{className:je("w-5 h-5",e),src:sp,alt:"qwen",...t}):s!=null&&s.includes("phi")?se.jsx(Yd,{className:je("w-5 h-5",e),...t}):s!=null&&s.includes("llama")?se.jsx(ep,{className:je("w-5 h-5",e),...t}):s!=null&&s.includes("smollm")?se.jsx("img",{className:je("w-5 h-5",e),src:np,alt:"smollm",...t}):s!=null&&s.includes("mistral")?se.jsx(tp,{className:je("w-5 h-5",e),...t}):s!=null&&s.includes("snowflake")?se.jsx(Gd,{className:je("w-5 h-5 rounded-full",e),...t}):s!=null&&s.includes("stablelm")?se.jsx("img",{className:je("w-5 h-5 rounded-full",e),src:ip,alt:"stablelm",...t}):s!=null&&s.includes("nomic")?se.jsx("img",{className:je("w-5 h-5 rounded-full",e),src:ap,alt:"nomic",...t}):s!=null&&s.includes("Xenova")||s!=null&&s.includes("janus")?se.jsx("img",{className:je("w-5 h-5 rounded-full",e),src:rp,alt:"Xenova",...t}):se.jsx(gb,{className:je("w-5 h-5",e),name:"brain"})})});export{co as B,ya as G,lo as I,uo as L,ae as O,po as S,V as Z,Gb as __tla,jp as a,ho as b,Ip as c,Rp as d,mo as e,fo as f,ga as g,yo as h,Qn as i,Ge as j,Jn as k,go as l,ba as m,Hn as n,Qt as o,$p as p,_a as q,Lp as r,bo as s,Bp as t,Dp as u,qp as v,Gn as w,ds as x,St as z};
