import{bB as Eu,bC as Cu,bD as Cn,bE as sa,aJ as ss,r as M,aQ as Zg,bF as Su,bG as Vg,bH as sn,b2 as Kg,bI as Fe,bJ as Te,j as z,c as Pe,a as Qg,d as ku,b as Tu,q as Hg,s as Jg,t as Gg,v as Xg,aG as Yg,aH as e0,B as t0,aI as aa,H as Nu,bK as n0,bL as s0,bM as a0,bN as i0,bO as as,bc as ia,bP as Iu,bQ as r0,bR as o0,bS as ju,bT as Ji,bU as c0,bV as l0,bW as Ru,bX as Gi,bY as u0,bZ as ra,b_ as p0,b$ as Qt,c0 as $u,c1 as h0,c2 as d0,c3 as Ot,c4 as Lu,c5 as m0,c6 as oa,c7 as w,be as Rt,c8 as Sn,A as ca,c9 as la,ca as Bu,cb as Xi,cc as f0,cd as y0,ce as Fu,cf as g0,e as b0,u as w0,aV as v0,L as x0,__tla as _0}from"./index-pm_YnrGh.js";import qu,{__tla as O0}from"./dot-BQCW_euz.js";let ua,Yi,er,H,tr,nr,Du,Uu,Wu,Mt,sr,pa,is,Bt,ha,zu,ar,ir,Zu,Vu,Ku,rs,rr,or,da,Qu,ma,M0=Promise.all([(()=>{try{return _0}catch{}})(),(()=>{try{return O0}catch{}})()]).then(async()=>{er=(n=>(n.Started="started",n.Downloading="downloading",n.Downloaded="downloaded",n.Loading="loading",n.Loaded="loaded",n))(er||{}),sr=(n=>(n.LLM="LLM",n.embedding="embedding",n.VLM="VLM",n))(sr||{}),Mt=(n=>(n.WebLLM="WebLLM",n.OpenAI="OpenAI",n.Groq="Groq",n.GoogleGenerativeAI="GoogleGenerativeAI",n))(Mt||{}),da=globalThis||void 0||self;function ur(n,e,t,s,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Eu(e),r=Eu(n),o=!1,c=r.length-1;c>=0;c--){var l=r[c],u=n[l];if(Cu(e,l)&&!(e[l]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var p=e[l];typeof u=="object"&&u!=null&&typeof p=="object"&&p!=null&&Array.isArray(u)===Array.isArray(p)?ur(u,p,t,s+"/"+Cn(l),a):u!==p&&(a&&t.push({op:"test",path:s+"/"+Cn(l),value:sa(u)}),t.push({op:"replace",path:s+"/"+Cn(l),value:sa(p)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:s+"/"+Cn(l),value:sa(u)}),t.push({op:"remove",path:s+"/"+Cn(l)}),o=!0):(a&&t.push({op:"test",path:s,value:n}),t.push({op:"replace",path:s,value:e}))}if(!(!o&&i.length==r.length))for(var c=0;c<i.length;c++){var l=i[c];!Cu(n,l)&&e[l]!==void 0&&t.push({op:"add",path:s+"/"+Cn(l),value:sa(e[l])})}}}function Ju(n,e,t=!1){var s=[];return ur(n,e,s,"",t),s}const Gu=async(n,e)=>{let t="",s="",a;const i=[];await n;for await(const r of n)r&&(Array.isArray(r)?(i.push(...r.map(o=>o.content)),i!=null&&i.length&&(s=i.join(""),e==null||e({chunk:r,content:s}))):(t=typeof r=="object"&&"content"in r?`${r.content}`:`${r}`,e==null||e({chunk:r,content:t})),a=r);return{lastChunk:a,content:t}},Xu=()=>{const n=ss(a=>a.toolsCallingStream),e=ss(a=>a.structuredStream),t=ss(a=>a.stream),s=ss(a=>a.getCurrentModelInfo);return{stream:M.useCallback(async(a,i)=>{var d;const{tools:r,schemas:o,onMessageUpdate:c,onMessageFinish:l}=i||{};let u;if(!await s())throw new Error("Model is not found");if(o!=null&&o.length?(o&&(o==null?void 0:o.length)>1&&Zg("Multiple schemas are not supported. Only the first schema will be used."),u=e(((d=o==null?void 0:o[0])==null?void 0:d.schema_items)||[],a)):r!=null&&r.length?u=n(r,a):u=t(a),!u)throw new Error("Stream is not supported");const{lastChunk:p,content:h}=await Gu(u,c);return l==null||l({content:h,lastChunk:p}),{lastChunk:p,content:h}},[s,t,e,n])}};var pr={},hr;function Yu(){if(hr)return pr;hr=1;var n;return function(e){(function(t){var s=typeof globalThis=="object"?globalThis:typeof Su=="object"?Su:typeof self=="object"?self:typeof this=="object"?this:c(),a=i(e);typeof s.Reflect<"u"&&(a=i(s.Reflect,a)),t(a,s),typeof s.Reflect>"u"&&(s.Reflect=e);function i(l,u){return function(p,h){Object.defineProperty(l,p,{configurable:!0,writable:!0,value:h}),u&&u(p,h)}}function r(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function c(){return r()||o()}})(function(t,s){var a=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",r=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",c=typeof Object.create=="function",l={__proto__:[]}instanceof Array,u=!c&&!l,p={create:c?function(){return ns(Object.create(null))}:l?function(){return ns({__proto__:null})}:function(){return ns({})},has:u?function(b,x){return a.call(b,x)}:function(b,x){return x in b},get:u?function(b,x){return a.call(b,x)?b[x]:void 0}:function(b,x){return b[x]}},h=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:ta(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:na(),f=typeof WeakMap=="function"?WeakMap:Hi(),y=i?Symbol.for("@reflect-metadata:registry"):void 0,g=et(),v=It(g);function O(b,x,_,P){if(L(_)){if(!Vt(b))throw new TypeError;if(!q(x))throw new TypeError;return J(b,x)}else{if(!Vt(b))throw new TypeError;if(!he(x))throw new TypeError;if(!he(P)&&!L(P)&&!Qe(P))throw new TypeError;return Qe(P)&&(P=void 0),_=He(_),Xe(b,x,_,P)}}t("decorate",O);function A(b,x){function _(P,F){if(!he(P))throw new TypeError;if(!L(F)&&!U(F))throw new TypeError;Ke(b,x,P,F)}return _}t("metadata",A);function T(b,x,_,P){if(!he(_))throw new TypeError;return L(P)||(P=He(P)),Ke(b,x,_,P)}t("defineMetadata",T);function C(b,x,_){if(!he(x))throw new TypeError;return L(_)||(_=He(_)),De(b,x,_)}t("hasMetadata",C);function W(b,x,_){if(!he(x))throw new TypeError;return L(_)||(_=He(_)),Ve(b,x,_)}t("hasOwnMetadata",W);function D(b,x,_){if(!he(x))throw new TypeError;return L(_)||(_=He(_)),pe(b,x,_)}t("getMetadata",D);function B(b,x,_){if(!he(x))throw new TypeError;return L(_)||(_=He(_)),vt(b,x,_)}t("getOwnMetadata",B);function $(b,x){if(!he(b))throw new TypeError;return L(x)||(x=He(x)),Zt(b,x)}t("getMetadataKeys",$);function re(b,x){if(!he(b))throw new TypeError;return L(x)||(x=He(x)),Ye(b,x)}t("getOwnMetadataKeys",re);function fe(b,x,_){if(!he(x))throw new TypeError;if(L(_)||(_=He(_)),!he(x))throw new TypeError;L(_)||(_=He(_));var P=at(x,_,!1);return L(P)?!1:P.OrdinaryDeleteMetadata(b,x,_)}t("deleteMetadata",fe);function J(b,x){for(var _=b.length-1;_>=0;--_){var P=b[_],F=P(x);if(!L(F)&&!Qe(F)){if(!q(F))throw new TypeError;x=F}}return x}function Xe(b,x,_,P){for(var F=b.length-1;F>=0;--F){var ke=b[F],Ae=ke(x,_,P);if(!L(Ae)&&!Qe(Ae)){if(!he(Ae))throw new TypeError;P=Ae}}return P}function De(b,x,_){var P=Ve(b,x,_);if(P)return!0;var F=de(x);return Qe(F)?!1:De(b,F,_)}function Ve(b,x,_){var P=at(x,_,!1);return L(P)?!1:nt(P.OrdinaryHasOwnMetadata(b,x,_))}function pe(b,x,_){var P=Ve(b,x,_);if(P)return vt(b,x,_);var F=de(x);if(!Qe(F))return pe(b,F,_)}function vt(b,x,_){var P=at(x,_,!1);if(!L(P))return P.OrdinaryGetOwnMetadata(b,x,_)}function Ke(b,x,_,P){var F=at(_,P,!0);F.OrdinaryDefineOwnMetadata(b,x,_,P)}function Zt(b,x){var _=Ye(b,x),P=de(b);if(P===null)return _;var F=Zt(P,x);if(F.length<=0)return _;if(_.length<=0)return F;for(var ke=new m,Ae=[],V=0,k=_;V<k.length;V++){var N=k[V],I=ke.has(N);I||(ke.add(N),Ae.push(N))}for(var j=0,Q=F;j<Q.length;j++){var N=Q[j],I=ke.has(N);I||(ke.add(N),Ae.push(N))}return Ae}function Ye(b,x){var _=at(b,x,!1);return _?_.OrdinaryOwnMetadataKeys(b,x):[]}function Tt(b){if(b===null)return 1;switch(typeof b){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return b===null?1:6;default:return 6}}function L(b){return b===void 0}function Qe(b){return b===null}function Nt(b){return typeof b=="symbol"}function he(b){return typeof b=="object"?b!==null:typeof b=="function"}function nn(b,x){switch(Tt(b)){case 0:return b;case 1:return b;case 2:return b;case 3:return b;case 4:return b;case 5:return b}var _="string",P=Re(b,r);if(P!==void 0){var F=P.call(b,_);if(he(F))throw new TypeError;return F}return Be(b)}function Be(b,x){var _,P;{var F=b.toString;if(Kt(F)){var P=F.call(b);if(!he(P))return P}var _=b.valueOf;if(Kt(_)){var P=_.call(b);if(!he(P))return P}}throw new TypeError}function nt(b){return!!b}function xt(b){return""+b}function He(b){var x=nn(b);return Nt(x)?x:xt(x)}function Vt(b){return Array.isArray?Array.isArray(b):b instanceof Object?b instanceof Array:Object.prototype.toString.call(b)==="[object Array]"}function Kt(b){return typeof b=="function"}function q(b){return typeof b=="function"}function U(b){switch(Tt(b)){case 3:return!0;case 4:return!0;default:return!1}}function ge(b,x){return b===x||b!==b&&x!==x}function Re(b,x){var _=b[x];if(_!=null){if(!Kt(_))throw new TypeError;return _}}function Se(b){var x=Re(b,o);if(!Kt(x))throw new TypeError;var _=x.call(b);if(!he(_))throw new TypeError;return _}function ce(b){return b.value}function Me(b){var x=b.next();return x.done?!1:x}function be(b){var x=b.return;x&&x.call(b)}function de(b){var x=Object.getPrototypeOf(b);if(typeof b!="function"||b===h||x!==h)return x;var _=b.prototype,P=_&&Object.getPrototypeOf(_);if(P==null||P===Object.prototype)return x;var F=P.constructor;return typeof F!="function"||F===b?x:F}function st(){var b;!L(y)&&typeof s.Reflect<"u"&&!(y in s.Reflect)&&typeof s.Reflect.defineMetadata=="function"&&(b=jt(s.Reflect));var x,_,P,F=new f,ke={registerProvider:Ae,getProvider:k,setProvider:I};return ke;function Ae(j){if(!Object.isExtensible(ke))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case b===j:break;case L(x):x=j;break;case x===j:break;case L(_):_=j;break;case _===j:break;default:P===void 0&&(P=new m),P.add(j);break}}function V(j,Q){if(!L(x)){if(x.isProviderFor(j,Q))return x;if(!L(_)){if(_.isProviderFor(j,Q))return x;if(!L(P))for(var ue=Se(P);;){var xe=Me(ue);if(!xe)return;var _t=ce(xe);if(_t.isProviderFor(j,Q))return be(ue),_t}}}if(!L(b)&&b.isProviderFor(j,Q))return b}function k(j,Q){var ue=F.get(j),xe;return L(ue)||(xe=ue.get(Q)),L(xe)&&(xe=V(j,Q),L(xe)||(L(ue)&&(ue=new d,F.set(j,ue)),ue.set(Q,xe))),xe}function N(j){if(L(j))throw new TypeError;return x===j||_===j||!L(P)&&P.has(j)}function I(j,Q,ue){if(!N(ue))throw new Error("Metadata provider not registered.");var xe=k(j,Q);if(xe!==ue){if(!L(xe))return!1;var _t=F.get(j);L(_t)&&(_t=new d,F.set(j,_t)),_t.set(Q,ue)}return!0}}function et(){var b;return!L(y)&&he(s.Reflect)&&Object.isExtensible(s.Reflect)&&(b=s.Reflect[y]),L(b)&&(b=st()),!L(y)&&he(s.Reflect)&&Object.isExtensible(s.Reflect)&&Object.defineProperty(s.Reflect,y,{enumerable:!1,configurable:!1,writable:!1,value:b}),b}function It(b){var x=new f,_={isProviderFor:function(N,I){var j=x.get(N);return L(j)?!1:j.has(I)},OrdinaryDefineOwnMetadata:Ae,OrdinaryHasOwnMetadata:F,OrdinaryGetOwnMetadata:ke,OrdinaryOwnMetadataKeys:V,OrdinaryDeleteMetadata:k};return g.registerProvider(_),_;function P(N,I,j){var Q=x.get(N),ue=!1;if(L(Q)){if(!j)return;Q=new d,x.set(N,Q),ue=!0}var xe=Q.get(I);if(L(xe)){if(!j)return;if(xe=new d,Q.set(I,xe),!b.setProvider(N,I,_))throw Q.delete(I),ue&&x.delete(N),new Error("Wrong provider for target.")}return xe}function F(N,I,j){var Q=P(I,j,!1);return L(Q)?!1:nt(Q.has(N))}function ke(N,I,j){var Q=P(I,j,!1);if(!L(Q))return Q.get(N)}function Ae(N,I,j,Q){var ue=P(j,Q,!0);ue.set(N,I)}function V(N,I){var j=[],Q=P(N,I,!1);if(L(Q))return j;for(var ue=Q.keys(),xe=Se(ue),_t=0;;){var Pu=Me(xe);if(!Pu)return j.length=_t,j;var Wg=ce(Pu);try{j[_t]=Wg}catch(zg){try{be(xe)}finally{throw zg}}_t++}}function k(N,I,j){var Q=P(I,j,!1);if(L(Q)||!Q.delete(N))return!1;if(Q.size===0){var ue=x.get(I);L(ue)||(ue.delete(j),ue.size===0&&x.delete(ue))}return!0}}function jt(b){var x=b.defineMetadata,_=b.hasOwnMetadata,P=b.getOwnMetadata,F=b.getOwnMetadataKeys,ke=b.deleteMetadata,Ae=new f,V={isProviderFor:function(k,N){var I=Ae.get(k);return!L(I)&&I.has(N)?!0:F(k,N).length?(L(I)&&(I=new m,Ae.set(k,I)),I.add(N),!0):!1},OrdinaryDefineOwnMetadata:x,OrdinaryHasOwnMetadata:_,OrdinaryGetOwnMetadata:P,OrdinaryOwnMetadataKeys:F,OrdinaryDeleteMetadata:ke};return V}function at(b,x,_){var P=g.getProvider(b,x);if(!L(P))return P;if(_){if(g.setProvider(b,x,v))return v;throw new Error("Illegal state.")}}function ta(){var b={},x=[],_=function(){function V(k,N,I){this._index=0,this._keys=k,this._values=N,this._selector=I}return V.prototype["@@iterator"]=function(){return this},V.prototype[o]=function(){return this},V.prototype.next=function(){var k=this._index;if(k>=0&&k<this._keys.length){var N=this._selector(this._keys[k],this._values[k]);return k+1>=this._keys.length?(this._index=-1,this._keys=x,this._values=x):this._index++,{value:N,done:!1}}return{value:void 0,done:!0}},V.prototype.throw=function(k){throw this._index>=0&&(this._index=-1,this._keys=x,this._values=x),k},V.prototype.return=function(k){return this._index>=0&&(this._index=-1,this._keys=x,this._values=x),{value:k,done:!0}},V}(),P=function(){function V(){this._keys=[],this._values=[],this._cacheKey=b,this._cacheIndex=-2}return Object.defineProperty(V.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),V.prototype.has=function(k){return this._find(k,!1)>=0},V.prototype.get=function(k){var N=this._find(k,!1);return N>=0?this._values[N]:void 0},V.prototype.set=function(k,N){var I=this._find(k,!0);return this._values[I]=N,this},V.prototype.delete=function(k){var N=this._find(k,!1);if(N>=0){for(var I=this._keys.length,j=N+1;j<I;j++)this._keys[j-1]=this._keys[j],this._values[j-1]=this._values[j];return this._keys.length--,this._values.length--,ge(k,this._cacheKey)&&(this._cacheKey=b,this._cacheIndex=-2),!0}return!1},V.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=b,this._cacheIndex=-2},V.prototype.keys=function(){return new _(this._keys,this._values,F)},V.prototype.values=function(){return new _(this._keys,this._values,ke)},V.prototype.entries=function(){return new _(this._keys,this._values,Ae)},V.prototype["@@iterator"]=function(){return this.entries()},V.prototype[o]=function(){return this.entries()},V.prototype._find=function(k,N){if(!ge(this._cacheKey,k)){this._cacheIndex=-1;for(var I=0;I<this._keys.length;I++)if(ge(this._keys[I],k)){this._cacheIndex=I;break}}return this._cacheIndex<0&&N&&(this._cacheIndex=this._keys.length,this._keys.push(k),this._values.push(void 0)),this._cacheIndex},V}();return P;function F(V,k){return V}function ke(V,k){return k}function Ae(V,k){return[V,k]}}function na(){var b=function(){function x(){this._map=new d}return Object.defineProperty(x.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),x.prototype.has=function(_){return this._map.has(_)},x.prototype.add=function(_){return this._map.set(_,_),this},x.prototype.delete=function(_){return this._map.delete(_)},x.prototype.clear=function(){this._map.clear()},x.prototype.keys=function(){return this._map.keys()},x.prototype.values=function(){return this._map.keys()},x.prototype.entries=function(){return this._map.entries()},x.prototype["@@iterator"]=function(){return this.keys()},x.prototype[o]=function(){return this.keys()},x}();return b}function Hi(){var b=16,x=p.create(),_=P();return function(){function k(){this._key=P()}return k.prototype.has=function(N){var I=F(N,!1);return I!==void 0?p.has(I,this._key):!1},k.prototype.get=function(N){var I=F(N,!1);return I!==void 0?p.get(I,this._key):void 0},k.prototype.set=function(N,I){var j=F(N,!0);return j[this._key]=I,this},k.prototype.delete=function(N){var I=F(N,!1);return I!==void 0?delete I[this._key]:!1},k.prototype.clear=function(){this._key=P()},k}();function P(){var k;do k="@@WeakMap@@"+V();while(p.has(x,k));return x[k]=!0,k}function F(k,N){if(!a.call(k,_)){if(!N)return;Object.defineProperty(k,_,{value:p.create()})}return k[_]}function ke(k,N){for(var I=0;I<N;++I)k[I]=Math.random()*255|0;return k}function Ae(k){if(typeof Uint8Array=="function"){var N=new Uint8Array(k);return typeof crypto<"u"?crypto.getRandomValues(N):typeof msCrypto<"u"?msCrypto.getRandomValues(N):ke(N,k),N}return ke(new Array(k),k)}function V(){var k=Ae(b);k[6]=k[6]&79|64,k[8]=k[8]&191|128;for(var N="",I=0;I<b;++I){var j=k[I];(I===4||I===6||I===8)&&(N+="-"),j<16&&(N+="0"),N+=j.toString(16).toLowerCase()}return N}}function ns(b){return b.__=void 0,delete b.__,b}})}(n||(n={})),pr}Yu(),typeof window<"u"&&(window.Buffer=Vg),typeof da<"u"&&typeof require<"u"&&(da.Buffer=require("buffer/").Buffer);class we{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const s of t)for(const a of Object.getOwnPropertyNames(s))e[a]=s[a]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class S extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class an extends S{constructor(){super("Locking not supported on given driver.")}}class fa extends S{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class le{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class ep extends S{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return le.isEntitySchema(e)?e.options.name:typeof e=="function"||we.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class dr extends S{constructor(e,t,s){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${s}.`)}}class mr extends S{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class tp extends S{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class cs extends S{constructor(){super("OUTPUT or RETURNING clause only supported by Microsoft SQL Server or PostgreSQL or MariaDB databases.")}}class At extends S{constructor(e,t){super(e),Object.setPrototypeOf(this,At.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class np extends S{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class sp extends S{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class kn extends S{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class ap extends S{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class ip extends S{constructor(){super("An open transaction is required for pessimistic lock.")}}class rp extends S{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class fr{constructor(e){we.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new S(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class Pt{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,s]=e.split(".");return!(!t||!s||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var ya={exports:{}},ga={exports:{}},yr;function rn(){return yr||(yr=1,typeof Object.create=="function"?ga.exports=function(n,e){e&&(n.super_=e,n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}))}:ga.exports=function(n,e){if(e){n.super_=e;var t=function(){};t.prototype=e.prototype,n.prototype=new t,n.prototype.constructor=n}}),ga.exports}var ba,gr;function on(){if(gr)return ba;gr=1;var n=sn().Buffer;function e(t,s){this._block=n.alloc(t),this._finalSize=s,this._blockSize=t,this._len=0}return e.prototype.update=function(t,s){typeof t=="string"&&(s=s||"utf8",t=n.from(t,s));for(var a=this._block,i=this._blockSize,r=t.length,o=this._len,c=0;c<r;){for(var l=o%i,u=Math.min(r-c,i-l),p=0;p<u;p++)a[l+p]=t[c+p];o+=u,c+=u,o%i===0&&this._update(a)}return this._len+=r,this},e.prototype.digest=function(t){var s=this._len%this._blockSize;this._block[s]=128,this._block.fill(0,s+1),s>=this._finalSize&&(this._update(this._block),this._block.fill(0));var a=this._len*8;if(a<=4294967295)this._block.writeUInt32BE(a,this._blockSize-4);else{var i=(a&4294967295)>>>0,r=(a-i)/4294967296;this._block.writeUInt32BE(r,this._blockSize-8),this._block.writeUInt32BE(i,this._blockSize-4)}this._update(this._block);var o=this._hash();return t?o.toString(t):o},e.prototype._update=function(){throw new Error("_update must be implemented by subclass")},ba=e,ba}var wa,br;function op(){if(br)return wa;br=1;var n=rn(),e=on(),t=sn().Buffer,s=[1518500249,1859775393,-1894007588,-899497514],a=new Array(80);function i(){this.init(),this._w=a,e.call(this,64,56)}n(i,e),i.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function r(l){return l<<5|l>>>27}function o(l){return l<<30|l>>>2}function c(l,u,p,h){return l===0?u&p|~u&h:l===2?u&p|u&h|p&h:u^p^h}return i.prototype._update=function(l){for(var u=this._w,p=this._a|0,h=this._b|0,d=this._c|0,m=this._d|0,f=this._e|0,y=0;y<16;++y)u[y]=l.readInt32BE(y*4);for(;y<80;++y)u[y]=u[y-3]^u[y-8]^u[y-14]^u[y-16];for(var g=0;g<80;++g){var v=~~(g/20),O=r(p)+c(v,h,d,m)+f+u[g]+s[v]|0;f=m,m=d,d=o(h),h=p,p=O}this._a=p+this._a|0,this._b=h+this._b|0,this._c=d+this._c|0,this._d=m+this._d|0,this._e=f+this._e|0},i.prototype._hash=function(){var l=t.allocUnsafe(20);return l.writeInt32BE(this._a|0,0),l.writeInt32BE(this._b|0,4),l.writeInt32BE(this._c|0,8),l.writeInt32BE(this._d|0,12),l.writeInt32BE(this._e|0,16),l},wa=i,wa}var va,wr;function cp(){if(wr)return va;wr=1;var n=rn(),e=on(),t=sn().Buffer,s=[1518500249,1859775393,-1894007588,-899497514],a=new Array(80);function i(){this.init(),this._w=a,e.call(this,64,56)}n(i,e),i.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function r(u){return u<<1|u>>>31}function o(u){return u<<5|u>>>27}function c(u){return u<<30|u>>>2}function l(u,p,h,d){return u===0?p&h|~p&d:u===2?p&h|p&d|h&d:p^h^d}return i.prototype._update=function(u){for(var p=this._w,h=this._a|0,d=this._b|0,m=this._c|0,f=this._d|0,y=this._e|0,g=0;g<16;++g)p[g]=u.readInt32BE(g*4);for(;g<80;++g)p[g]=r(p[g-3]^p[g-8]^p[g-14]^p[g-16]);for(var v=0;v<80;++v){var O=~~(v/20),A=o(h)+l(O,d,m,f)+y+p[v]+s[O]|0;y=f,f=m,m=c(d),d=h,h=A}this._a=h+this._a|0,this._b=d+this._b|0,this._c=m+this._c|0,this._d=f+this._d|0,this._e=y+this._e|0},i.prototype._hash=function(){var u=t.allocUnsafe(20);return u.writeInt32BE(this._a|0,0),u.writeInt32BE(this._b|0,4),u.writeInt32BE(this._c|0,8),u.writeInt32BE(this._d|0,12),u.writeInt32BE(this._e|0,16),u},va=i,va}var xa,vr;function xr(){if(vr)return xa;vr=1;var n=rn(),e=on(),t=sn().Buffer,s=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],a=new Array(64);function i(){this.init(),this._w=a,e.call(this,64,56)}n(i,e),i.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function r(h,d,m){return m^h&(d^m)}function o(h,d,m){return h&d|m&(h|d)}function c(h){return(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10)}function l(h){return(h>>>6|h<<26)^(h>>>11|h<<21)^(h>>>25|h<<7)}function u(h){return(h>>>7|h<<25)^(h>>>18|h<<14)^h>>>3}function p(h){return(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10}return i.prototype._update=function(h){for(var d=this._w,m=this._a|0,f=this._b|0,y=this._c|0,g=this._d|0,v=this._e|0,O=this._f|0,A=this._g|0,T=this._h|0,C=0;C<16;++C)d[C]=h.readInt32BE(C*4);for(;C<64;++C)d[C]=p(d[C-2])+d[C-7]+u(d[C-15])+d[C-16]|0;for(var W=0;W<64;++W){var D=T+l(v)+r(v,O,A)+s[W]+d[W]|0,B=c(m)+o(m,f,y)|0;T=A,A=O,O=v,v=g+D|0,g=y,y=f,f=m,m=D+B|0}this._a=m+this._a|0,this._b=f+this._b|0,this._c=y+this._c|0,this._d=g+this._d|0,this._e=v+this._e|0,this._f=O+this._f|0,this._g=A+this._g|0,this._h=T+this._h|0},i.prototype._hash=function(){var h=t.allocUnsafe(32);return h.writeInt32BE(this._a,0),h.writeInt32BE(this._b,4),h.writeInt32BE(this._c,8),h.writeInt32BE(this._d,12),h.writeInt32BE(this._e,16),h.writeInt32BE(this._f,20),h.writeInt32BE(this._g,24),h.writeInt32BE(this._h,28),h},xa=i,xa}var _a,_r;function lp(){if(_r)return _a;_r=1;var n=rn(),e=xr(),t=on(),s=sn().Buffer,a=new Array(64);function i(){this.init(),this._w=a,t.call(this,64,56)}return n(i,e),i.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},i.prototype._hash=function(){var r=s.allocUnsafe(28);return r.writeInt32BE(this._a,0),r.writeInt32BE(this._b,4),r.writeInt32BE(this._c,8),r.writeInt32BE(this._d,12),r.writeInt32BE(this._e,16),r.writeInt32BE(this._f,20),r.writeInt32BE(this._g,24),r},_a=i,_a}var Oa,Or;function Mr(){if(Or)return Oa;Or=1;var n=rn(),e=on(),t=sn().Buffer,s=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],a=new Array(160);function i(){this.init(),this._w=a,e.call(this,128,112)}n(i,e),i.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function r(f,y,g){return g^f&(y^g)}function o(f,y,g){return f&y|g&(f|y)}function c(f,y){return(f>>>28|y<<4)^(y>>>2|f<<30)^(y>>>7|f<<25)}function l(f,y){return(f>>>14|y<<18)^(f>>>18|y<<14)^(y>>>9|f<<23)}function u(f,y){return(f>>>1|y<<31)^(f>>>8|y<<24)^f>>>7}function p(f,y){return(f>>>1|y<<31)^(f>>>8|y<<24)^(f>>>7|y<<25)}function h(f,y){return(f>>>19|y<<13)^(y>>>29|f<<3)^f>>>6}function d(f,y){return(f>>>19|y<<13)^(y>>>29|f<<3)^(f>>>6|y<<26)}function m(f,y){return f>>>0<y>>>0?1:0}return i.prototype._update=function(f){for(var y=this._w,g=this._ah|0,v=this._bh|0,O=this._ch|0,A=this._dh|0,T=this._eh|0,C=this._fh|0,W=this._gh|0,D=this._hh|0,B=this._al|0,$=this._bl|0,re=this._cl|0,fe=this._dl|0,J=this._el|0,Xe=this._fl|0,De=this._gl|0,Ve=this._hl|0,pe=0;pe<32;pe+=2)y[pe]=f.readInt32BE(pe*4),y[pe+1]=f.readInt32BE(pe*4+4);for(;pe<160;pe+=2){var vt=y[pe-30],Ke=y[pe-15*2+1],Zt=u(vt,Ke),Ye=p(Ke,vt);vt=y[pe-2*2],Ke=y[pe-2*2+1];var Tt=h(vt,Ke),L=d(Ke,vt),Qe=y[pe-7*2],Nt=y[pe-7*2+1],he=y[pe-16*2],nn=y[pe-16*2+1],Be=Ye+Nt|0,nt=Zt+Qe+m(Be,Ye)|0;Be=Be+L|0,nt=nt+Tt+m(Be,L)|0,Be=Be+nn|0,nt=nt+he+m(Be,nn)|0,y[pe]=nt,y[pe+1]=Be}for(var xt=0;xt<160;xt+=2){nt=y[xt],Be=y[xt+1];var He=o(g,v,O),Vt=o(B,$,re),Kt=c(g,B),q=c(B,g),U=l(T,J),ge=l(J,T),Re=s[xt],Se=s[xt+1],ce=r(T,C,W),Me=r(J,Xe,De),be=Ve+ge|0,de=D+U+m(be,Ve)|0;be=be+Me|0,de=de+ce+m(be,Me)|0,be=be+Se|0,de=de+Re+m(be,Se)|0,be=be+Be|0,de=de+nt+m(be,Be)|0;var st=q+Vt|0,et=Kt+He+m(st,q)|0;D=W,Ve=De,W=C,De=Xe,C=T,Xe=J,J=fe+be|0,T=A+de+m(J,fe)|0,A=O,fe=re,O=v,re=$,v=g,$=B,B=be+st|0,g=de+et+m(B,be)|0}this._al=this._al+B|0,this._bl=this._bl+$|0,this._cl=this._cl+re|0,this._dl=this._dl+fe|0,this._el=this._el+J|0,this._fl=this._fl+Xe|0,this._gl=this._gl+De|0,this._hl=this._hl+Ve|0,this._ah=this._ah+g+m(this._al,B)|0,this._bh=this._bh+v+m(this._bl,$)|0,this._ch=this._ch+O+m(this._cl,re)|0,this._dh=this._dh+A+m(this._dl,fe)|0,this._eh=this._eh+T+m(this._el,J)|0,this._fh=this._fh+C+m(this._fl,Xe)|0,this._gh=this._gh+W+m(this._gl,De)|0,this._hh=this._hh+D+m(this._hl,Ve)|0},i.prototype._hash=function(){var f=t.allocUnsafe(64);function y(g,v,O){f.writeInt32BE(g,O),f.writeInt32BE(v,O+4)}return y(this._ah,this._al,0),y(this._bh,this._bl,8),y(this._ch,this._cl,16),y(this._dh,this._dl,24),y(this._eh,this._el,32),y(this._fh,this._fl,40),y(this._gh,this._gl,48),y(this._hh,this._hl,56),f},Oa=i,Oa}var Ma,Ar;function up(){if(Ar)return Ma;Ar=1;var n=rn(),e=Mr(),t=on(),s=sn().Buffer,a=new Array(160);function i(){this.init(),this._w=a,t.call(this,128,112)}return n(i,e),i.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},i.prototype._hash=function(){var r=s.allocUnsafe(48);function o(c,l,u){r.writeInt32BE(c,u),r.writeInt32BE(l,u+4)}return o(this._ah,this._al,0),o(this._bh,this._bl,8),o(this._ch,this._cl,16),o(this._dh,this._dl,24),o(this._eh,this._el,32),o(this._fh,this._fl,40),r},Ma=i,Ma}var Pr;function pp(){if(Pr)return ya.exports;Pr=1;var n=ya.exports=function(e){e=e.toLowerCase();var t=n[e];if(!t)throw new Error(e+" is not supported (we accept pull requests)");return new t};return n.sha=op(),n.sha1=cp(),n.sha224=lp(),n.sha256=xr(),n.sha384=up(),n.sha512=Mr(),ya.exports}var hp=pp();const dp=Kg(hp);function mp(n,e={}){const{segmentLength:t=4,separator:s="__",termLength:a=2}=e;return n.split(s).reduce((i,r)=>{const o=r.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),c=o.length>1?a:t,l=o.map(u=>u.substr(0,c)).join("");return i.push(l),i},[]).join(s)}function fp(n,e={}){const t=dp("sha1");t.update(n,"utf8");const s=t.digest("hex");return e.length?s.slice(0,e.length):s}class yp{static isGreaterOrEqual(e,t){const s=Er(e),a=Er(t);return s[0]>a[0]||s[0]===a[0]&&s[1]>a[1]||s[0]===a[0]&&s[1]===a[1]&&s[2]>=a[2]}}function Er(n=""){const e=[0,0,0];return n.split(".").forEach((t,s)=>e[s]=parseInt(t,10)),e}class E{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return e.version!=null&&yp.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const s=this.parseConnectionUrl(e.url);t&&t.useSid&&s.database&&(s.sid=s.database);for(const a of Object.keys(s))typeof s[a]>"u"&&delete s[a];return Object.assign({},e,s)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const s=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&s.database&&(s.sid=s.database);for(const a of Object.keys(s))typeof s[a]>"u"&&delete s[a];return Object.assign({},e,s)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...s){const a=t&&t.joiner?t.joiner:"_";let i=s.length===1?s[0]:s.join(a);if(e&&e>0&&i.length>e){if(t&&t.shorten===!0){const r=mp(i);if(r.length<e)return r}return fp(i,{length:e})}return i}static buildColumnAlias({maxAliasLength:e},t,...s){return typeof t=="string"?(s.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...s)}static parseConnectionUrl(e){const t=e.split(":")[0],s=e.indexOf("//"),a=e.substr(s+2),i=a.indexOf("/"),r=i!==-1?a.substr(0,i):a;let o=i!==-1?a.substr(i+1):void 0;o&&o.indexOf("?")!==-1&&(o=o.substr(0,o.indexOf("?")));const c=r.lastIndexOf("@"),l=r.substr(0,c),u=r.substr(c+1);let p=l,h="";const d=l.indexOf(":");d!==-1&&(p=l.substr(0,d),h=l.substr(d+1));const[m,f]=u.split(":");return{type:t,host:m,username:decodeURIComponent(p),password:decodeURIComponent(h),port:f?parseInt(f):void 0,database:o||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],s=e.indexOf("//"),a=e.substr(s+2),i=a.indexOf("/"),r=i!==-1?a.substr(0,i):a;let o=i!==-1?a.substr(i+1):void 0,c="",l,u,p,h,d={};if(o&&o.indexOf("?")!==-1){c=o.substr(o.indexOf("?")+1,o.length);const T=c.split("&");let C,W;T.forEach(D=>{C=D.split("=")[0],W=D.split("=")[1],d[C]=W}),h=d.replicaSet,o=o.substr(0,o.indexOf("?"))}const m=r.lastIndexOf("@"),f=r.substr(0,m),y=r.substr(m+1);let g=f,v="";const O=f.indexOf(":");O!==-1&&(g=f.substr(0,O),v=f.substr(O+1)),h?p=y:[l,u]=y.split(":");let A={type:t,host:l,hostReplicaSet:p,username:decodeURIComponent(g),password:decodeURIComponent(v),port:u?parseInt(u):void 0,database:o||void 0};for(const[T,C]of Object.entries(d))A[T]=C;return A}}class Cr{constructor(e,t,s){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,s&&we.assign(this,s)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(s=>t.selection===this.alias.name+"."+s.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(Pt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(Pt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!Pt.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let s=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(s||t.metadata.parentEntityMetadata&&(s=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),s))return s;throw new S(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new S("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new S("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?E.buildAlias(this.connection.driver,void 0,e,this.alias.name):E.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class Aa{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,we.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value must be a string representation of alias property");const e=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new S(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return e}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Pa{constructor(e,t){this.expressionMap=e,we.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),s=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!s)throw new S(`Relation with property path ${t} in entity was not found.`);return s}get metadata(){if(!Pt.isAliasProperty(this.relationName))throw new S("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class Ea{constructor(e){var t;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((t=e.options)==null?void 0:t.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,s)=>(t[this.mainAlias.name+"."+s]=e[s],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const s=new fr;return s.type=e.type,t&&(s.name=t),e.metadata&&(s.metadata=e.metadata),e.target&&!s.hasMetadata&&(s.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(s.tablePath=e.tablePath),e.subQuery&&(s.subQuery=e.subQuery),this.aliases.push(s),s}findAliasByName(e){const t=this.aliases.find(s=>s.name===e);if(!t)throw new S(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,s]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(s)}get relationMetadata(){if(!this.mainAlias)throw new S("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new S(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new Ea(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new fr(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Cr(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Aa(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Pa(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class Sr{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class Ca{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((s,a)=>a.from(s),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((s,a)=>a.to(s),t):e.to(t)}}class Tn{constructor(e,t,s=!0,a=!1,i,r){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=s,this._multipleParameters=a,this._getSql=i,this._objectLiteralParameters=r}get useParameter(){return le.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return le.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return le.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return le.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(le.isFindOperator(this._value))return this._value}get getSql(){return le.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof Tn?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&Ca.transformTo(e,t)):Ca.transformTo(e,this._value)}}Yi=function(n){return new Tn("in",n,!0,!0)};const gp=/[.*+\-?^${}()|[\]\\]/g,bp=n=>n.replace(gp,"\\$&");class ye{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,le.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Ea(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){ye.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new S("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(s=>({selection:s})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),le.isSelectQueryBuilder(this)?this:ye.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",le.isInsertQueryBuilder(this)?this:ye.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const s=t||e;if(e=le.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const a=this.createFromAlias(e);this.expressionMap.setMainAlias(a)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=s,le.isUpdateQueryBuilder(this)?this:ye.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",le.isDeleteQueryBuilder(this)?this:ye.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",le.isSoftDeleteQueryBuilder(this)?this:ye.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",le.isSoftDeleteQueryBuilder(this)?this:ye.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const s=arguments.length===2?e:void 0,a=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=a,s){const i=this.createFromAlias(s);this.expressionMap.setMainAlias(i)}return le.isRelationQueryBuilder(this)?this:ye.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const s=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(a=>!!s.findRelationWithPropertyPath(a))}hasParameter(e){var t;return((t=this.parentQueryBuilder)==null?void 0:t.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new S(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new S("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,s]of Object.entries(e))this.setParameter(t,s);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const s=t.childEntityMetadatas.filter(a=>a.discriminatorColumn).map(a=>a.discriminatorValue);s.push(t.discriminatorValue),e.discriminatorColumnValues=s}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),s=this.obtainQueryRunner();try{return await s.query(e,t)}finally{s!==this.queryRunner&&await s.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,s){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:s||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new S('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const s=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:s.tablePath})}else{if(typeof e=="string"){const i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}const s=e(this.subQuery());this.setParameters(s.getParameters());const a=s.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:a})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const i of this.expressionMap.aliases){if(!i.hasMetadata)continue;const r=this.expressionMap.aliasNamePrefixingEnabled&&i.name?`${i.name}.`:"";t[r]||(t[r]={});for(const o of i.metadata.relations)o.joinColumns.length>0&&(t[r][o.propertyPath]=o.joinColumns[0].databaseName);for(const o of i.metadata.relations){const c=[...o.joinColumns,...o.inverseJoinColumns];for(const l of c){const u=`${o.propertyPath}.${l.referencedColumn.propertyPath}`;t[r][u]=l.databaseName}}for(const o of i.metadata.columns)t[r][o.databaseName]=o.databaseName;for(const o of i.metadata.columns)t[r][o.propertyName]=o.databaseName;for(const o of i.metadata.columns)t[r][o.propertyPath]=o.databaseName}const s=Object.keys(t),a=s.map(i=>bp(i)).join("|");return s.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${a?"("+a+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...i)=>{let r,o,c;if(a){if(r=i[0],o=i[1],c=i[3],t[i[2]][c])return`${o}${this.escape(i[2].substring(0,i[2].length-1))}.${this.escape(t[i[2]][c])}`}else if(r=i[0],o=i[1],c=i[2],t[""][c])return`${o}${this.escape(t[""][c])}`;return r})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const a=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&a.deleteDateColumn){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+a.deleteDateColumn.propertyName:a.deleteDateColumn.propertyName,r=`${this.replacePropertyNames(i)} IS NULL`;e.push(r)}if(a.discriminatorColumn&&a.parentEntityMetadata){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+a.discriminatorColumn.databaseName:a.discriminatorColumn.databaseName,r=`${this.replacePropertyNames(i)} IN (:...discriminatorColumnValues)`;e.push(r)}}if(this.expressionMap.extraAppendedAndWhereCondition){const a=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(a)}let s="";return s+=this.createTimeTravelQuery(),e.length?e.length===1?s+=` WHERE ${e[0]}`:s+=` WHERE ( ${e.join(" ) AND ( ")} )`:s+="",s}createReturningExpression(e){const t=this.getReturningColumns(),s=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&s.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(a=>t.indexOf(a)===-1)),t.length){let a=t.map(i=>{const r=this.escape(i.databaseName);return s.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+r:this.escape(this.getMainTableName())+"."+r:r}).join(", ");return s.options.type==="oracle"&&(a+=" INTO "+t.map(i=>this.createParameter({type:s.columnTypeToNativeParameter(i.type),dir:s.oracle.BIND_OUT})).join(", ")),s.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(a+=" INTO @OutputTable"),a}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,s)=>{const a=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(s>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${a}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(s>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${a}${this.connection.options.isolateWhereStatements?")":""}`}return a}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:s}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return s.options.type==="postgres"||s.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return s.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${Tn.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(t=>{const s=typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.getQuery();if(typeof t.queryBuilder!="string"){if(t.queryBuilder.hasCommonTableExpressions())throw new S(`Nested CTEs aren't supported (CTE: ${t.alias})`);if(!this.connection.driver.cteCapabilities.writable&&!le.isSelectQueryBuilder(t.queryBuilder))throw new S(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${t.alias})`);this.setParameters(t.queryBuilder.getParameters())}let a=this.escape(t.alias);if(t.options.columnNames){const o=t.options.columnNames.map(c=>this.escape(c));if(le.isSelectQueryBuilder(t.queryBuilder)&&t.queryBuilder.expressionMap.selects.length&&t.options.columnNames.length!==t.queryBuilder.expressionMap.selects.length)throw new S(`cte.options.columnNames length (${t.options.columnNames.length}) doesn't match subquery select list length ${t.queryBuilder.expressionMap.selects.length} (CTE: ${t.alias})`);a+=`(${o.join(", ")})`}const i=t.options.recursive&&e?"RECURSIVE":"";let r="";return this.connection.driver.cteCapabilities.materializedHint&&t.options.materialized!==void 0&&(r=t.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[i,a,"AS",r,`(${s})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,s=(Array.isArray(e)?e:[e]).map(a=>t.ensureEntityIdMap(a));if(!t.hasMultiplePrimaryKeys){const a=t.primaryColumns[0];if(!a.transformer&&!a.relationMetadata&&!a.embeddedMetadata)return{[a.propertyName]:Yi(s.map(i=>a.getEntityValue(i,!1)))}}return new Sr(a=>{for(const i of s)a.orWhere(new Sr(r=>r.where(i)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const s=[],a=e.split(".");for(;a.length>1;){const o=a[0];if(!(t!=null&&t.hasMetadata))break;if(t.metadata.hasEmbeddedWithPropertyPath(o)){a.unshift(`${a.shift()}.${a.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(o)){const c=this.expressionMap.joinAttributes.find(l=>l.relationPropertyPath===o);if(!(c!=null&&c.alias)){const l=s.length>0?`${s.join(".")}.${o}`:o;throw new Error(`Cannot find alias for relation at ${l}`)}t=c.alias,s.push(...o.split(".")),a.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const i=a.join("."),r=t.metadata.findColumnsWithPropertyPath(i);if(!r.length)throw new At(e,t.metadata);return[t,s,r]}createPropertyPath(e,t,s=""){const a=[];for(const i of Object.keys(t)){const r=s?`${s}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||le.isFindOperator(t[i])){a.push(r);continue}if(e.hasEmbeddedWithPropertyPath(r)){const o=this.createPropertyPath(e,t[i],r);a.push(...o);continue}if(e.hasRelationWithPropertyPath(r)){const o=e.findRelationWithPropertyPath(r);if(o.relationType==="one-to-one"||o.relationType==="many-to-one"){const u=o.joinColumns.map(p=>p.referencedColumn).filter(p=>!!p);if(u.length>0&&u.every(p=>p.getEntityValue(t[i],!1))){a.push(r);continue}}if(o.relationType==="one-to-many"||o.relationType==="many-to-many")throw new Error(`Cannot query across ${o.relationType} for property ${r}`);const c=o.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(u=>u.getEntityValue(t[i],!1))){const u=c.map(p=>`${r}.${p.propertyPath}`);a.push(...u);continue}const l=this.createPropertyPath(o.inverseEntityMetadata,t[i]).map(u=>`${r}.${u}`);a.push(...l);continue}a.push(r)}return a}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const s of t){const[a,i,r]=this.findColumnsForPropertyPath(s);for(const o of r){let c=e;for(const p of i){if(!c||!(p in c)){c={};break}c=c[p]}const l=this.expressionMap.aliasNamePrefixingEnabled?`${a.name}.${o.propertyPath}`:o.propertyPath,u=o.getEntityValue(c,!0);yield[l,u]}}}else for(const t of Object.keys(e)){const s=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,s]}}getWherePredicateCondition(e,t){if(le.isFindOperator(t)){let s=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const a of t.value)s.push(this.createParameter(a));else s.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...s]};if(t.type==="and"){const a=t.value;return{operator:t.type,parameters:a.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else if(t.type==="or"){const a=t.value;return{operator:t.type,parameters:a.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else return{operator:t.type,parameters:[e,...s]}}else return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(le.isBrackets(e)){const a=this.createQueryBuilder();return a.parentQueryBuilder=this,a.expressionMap.mainAlias=this.expressionMap.mainAlias,a.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,a.expressionMap.parameters=this.expressionMap.parameters,a.expressionMap.nativeParameters=this.expressionMap.nativeParameters,a.expressionMap.wheres=[],e.whereFactory(a),{operator:le.isNotBrackets(e)?"not":"brackets",condition:a.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],s=[];for(const a of t){const i=[];for(const[r,o]of this.getPredicates(a))i.push({type:"and",condition:this.getWherePredicateCondition(r,o)});s.push({type:"or",condition:i})}return s.length===1?s[0].condition:s}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}ye.queryBuilderRegistry={};class wp{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class vp extends ye{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),s=this.obtainQueryRunner();let a=!1;try{this.expressionMap.useTransaction===!0&&s.isTransactionActive===!1&&(await s.startTransaction(),a=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const i=await s.query(e,t,!0),r=wp.from(i);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),a&&await s.commitTransaction(),r}catch(i){if(a)try{await s.rollbackTransaction()}catch{}throw i}finally{s!==this.queryRunner&&await s.release()}}from(e,t){e=le.isEntitySchema(e)?e.options.name:e;const s=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(s),this}where(e,t){this.expressionMap.wheres=[];const s=this.getWhereCondition(e);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new cs;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),s=this.createReturningExpression("delete");return s===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${s}${t}`:`DELETE FROM ${e}${t} RETURNING ${s}`}}let ls;const xp=new Uint8Array(16);function _p(){if(!ls&&(ls=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ls))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ls(xp)}const Ne=[];for(let n=0;n<256;++n)Ne.push((n+256).toString(16).slice(1));function Op(n,e=0){return Ne[n[e+0]]+Ne[n[e+1]]+Ne[n[e+2]]+Ne[n[e+3]]+"-"+Ne[n[e+4]]+Ne[n[e+5]]+"-"+Ne[n[e+6]]+Ne[n[e+7]]+"-"+Ne[n[e+8]]+Ne[n[e+9]]+"-"+Ne[n[e+10]]+Ne[n[e+11]]+Ne[n[e+12]]+Ne[n[e+13]]+Ne[n[e+14]]+Ne[n[e+15]]}const Mp=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),kr={randomUUID:Mp};function Ap(n,e,t){if(kr.randomUUID&&!e&&!n)return kr.randomUUID();n=n||{};const s=n.random||(n.rng||_p)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Op(s)}class Tr{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class Nr{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Sa{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const s=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(a,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,l,u)=>(c[this.expressionMap.extraReturningColumns[u].databaseName]=l[0],c),{}));const r=Array.isArray(e.raw)?e.raw[i]:e.raw,o=this.queryRunner.connection.driver.createGeneratedMap(s,r);o&&(this.queryRunner.manager.merge(s.target,a,o),e.generatedMaps.push(o))}else{const r=this.expressionMap.extraReturningColumns;if(r.length>0){const o=this.expressionMap.mainAlias.metadata.getEntityIdMap(a);if(!o)throw new S("Cannot update entity because entity id is not set in the entity.");const c=await this.queryRunner.manager.createQueryBuilder().select(s.primaryColumns.map(l=>s.targetName+"."+l.propertyPath)).addSelect(r.map(l=>s.targetName+"."+l.propertyPath)).from(s.target,s.targetName).where(o).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(s.target,a,c),e.generatedMaps.push(c))}}}))}async insert(e,t){const s=this.expressionMap.mainAlias.metadata;let a=s.getInsertionReturningColumns();const i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");a=a.filter(o=>o.isGenerated?i===!0:!0);const r=t.map((o,c)=>{this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((p,h,d)=>(p[this.expressionMap.extraReturningColumns[d].databaseName]=h[0],p),{}));const l=Array.isArray(e.raw)?e.raw[c]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(s,l,c,t.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(s.target,u,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(s.target,o,u),u});if(a.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const o=t.map(l=>{const u=s.getEntityIdMap(l);if(!u)throw new S("Cannot update entity because entity id is not set in the entity.");return u}),c=await this.queryRunner.manager.createQueryBuilder().select(s.primaryColumns.map(l=>s.targetName+"."+l.propertyPath)).addSelect(a.map(l=>s.targetName+"."+l.propertyPath)).from(s.target,s.targetName).where(o).setOption("create-pojo").getMany();t.forEach((l,u)=>{this.queryRunner.manager.merge(s.target,r[u],c[u]),this.queryRunner.manager.merge(s.target,l,c[u])})}t.forEach((o,c)=>{const l=s.getEntityIdMap(o);e.identifiers.push(l),e.generatedMaps.push(r[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class Pp extends ye{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new Nr;const t=this.obtainQueryRunner();let s=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),s=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const d=new Tr;e.forEach(m=>{t.broadcaster.broadcastBeforeInsertEvent(d,this.expressionMap.mainAlias.metadata,m)}),await d.wait()}let a=null,i=null;const r=new Sa(t,this.expressionMap),o=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const d of this.expressionMap.returning)o.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(d));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),o.push(...this.expressionMap.extraReturningColumns.filter(d=>!o.includes(d)))),o.length>0&&this.connection.driver.options.type==="mssql"&&(a=this.connection.driver.buildTableVariableDeclaration("@OutputTable",o),i="SELECT * FROM @OutputTable");const[c,l]=this.getQueryAndParameters(),u=[a,c,i].filter(d=>d!=null).join(`;

`),p=await t.query(u,l,!0),h=Nr.from(p);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.insert(h,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const d=new Tr;e.forEach(m=>{t.broadcaster.broadcastAfterInsertEvent(d,this.expressionMap.mainAlias.metadata,m)}),await d.wait()}return s&&await t.commitTransaction(),h}catch(a){if(s)try{await t.rollbackTransaction()}catch{}throw a}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=le.isEntitySchema(e)?e.options.name:e;const s=this.createFromAlias(e);return this.expressionMap.setMainAlias(s),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new cs;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,s){return Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:s==null?void 0:s.skipUpdateIfNoValuesChanged,indexPredicate:s==null?void 0:s.indexPredicate,upsertType:s==null?void 0:s.upsertType},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:s==null?void 0:s.skipUpdateIfNoValuesChanged,upsertType:s==null?void 0:s.upsertType},this)}createInsertExpression(){var r,o;const e=this.getTableName(this.getMainTableName()),t=this.createValuesExpression(),s=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),a=this.createColumnNamesExpression();let i="INSERT ";if(((r=this.expressionMap.onUpdate)==null?void 0:r.upsertType)==="primary-key"&&(i="UPSERT "),(E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(i+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),i+=`INTO ${e}`,this.alias!==this.getMainTableName()&&E.isPostgresFamily(this.connection.driver)&&(i+=` AS "${this.alias}"`),a?i+=`(${a})`:!t&&(E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(i+="()"),s&&this.connection.driver.options.type==="mssql"&&(i+=` OUTPUT ${s}`),t?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?i+=` ${t}`:i+=` VALUES ${t}`:E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?i+=" VALUES ()":i+=" DEFAULT VALUES",((o=this.expressionMap.onUpdate)==null?void 0:o.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)i+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)i+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:c,columns:l,conflict:u,skipUpdateIfNoValuesChanged:p,indexPredicate:h}=this.expressionMap.onUpdate;let d="ON CONFLICT";if(Array.isArray(u)){if(d+=` ( ${u.map(f=>this.escape(f)).join(", ")} )`,h&&!E.isPostgresFamily(this.connection.driver))throw new S("indexPredicate option is not supported by the current database driver");h&&E.isPostgresFamily(this.connection.driver)&&(d+=` WHERE ( ${h} )`)}else u&&(d+=` ON CONSTRAINT ${this.escape(u)}`);const m=[];Array.isArray(c)?m.push(...c.map(f=>`${this.escape(f)} = EXCLUDED.${this.escape(f)}`)):l&&m.push(...l.map(f=>`${this.escape(f)} = :${f}`)),m.length>0&&(i+=` ${d} DO UPDATE SET `,m.push(...this.expressionMap.mainAlias.metadata.columns.filter(f=>f.isUpdateDate&&!(c!=null&&c.includes(f.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||E.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(f=>`${this.escape(f.databaseName)} = DEFAULT`)),i+=m.join(", "),i+=" "),Array.isArray(c)&&p&&E.isPostgresFamily(this.connection.driver)&&(i+=" WHERE (",i+=c.map(f=>`${e}.${this.escape(f)} IS DISTINCT FROM EXCLUDED.${this.escape(f)}`).join(" OR "),i+=") ")}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:c,columns:l}=this.expressionMap.onUpdate;Array.isArray(c)?(i+=" ON DUPLICATE KEY UPDATE ",i+=c.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),i+=" "):Array.isArray(l)&&(i+=" ON DUPLICATE KEY UPDATE ",i+=l.map(u=>`${this.escape(u)} = :${u}`).join(", "),i+=" ")}}else if(this.expressionMap.onUpdate)throw new S("onUpdate is not supported by the current database driver")}return s&&(E.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||E.isMySQLFamily(this.connection.driver))&&(i+=` RETURNING ${s}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(c=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(c.propertyPath)!==-1:c.isInsert).some(c=>this.isOverridingAutoIncrementBehavior(c))&&(i=`SET IDENTITY_INSERT ${e} ON; ${i}; SET IDENTITY_INSERT ${e} OFF`),i}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!E.isSQLiteFamily(this.connection.driver)&&!E.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(s=>this.escape(s)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let s="";return e.forEach((a,i)=>{t.forEach((r,o)=>{o===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?s+=" SELECT ":s+="(");let c=r.getEntityValue(a);if(typeof c!="function"&&(c=this.connection.driver.preparePersistentValue(c,r)),r.isVersion&&c===void 0)s+="1";else if(r.isDiscriminator)s+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(r.isGenerated&&r.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&c===void 0)c=Ap(),s+=this.createParameter(c),i in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[i]={}),r.setEntityValue(this.expressionMap.locallyGenerated[i],c);else if(c===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||E.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r.default!==void 0&&r.default!==null?s+=this.connection.driver.normalizeDefault(r):s+="NULL":s+="DEFAULT";else if(c===null&&this.connection.driver.options.type==="spanner")s+="NULL";else if(typeof c=="function")s+=c();else{this.connection.driver.options.type==="mssql"&&(c=this.connection.driver.parametrizeValue(r,c));const l=this.createParameter(c);if((E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1){const u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";r.srid!=null?s+=`${u}(${l}, ${r.srid})`:s+=`${u}(${l})`}else E.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1?r.srid!=null?s+=`ST_SetSRID(ST_GeomFromGeoJSON(${l}), ${r.srid})::${r.type}`:s+=`ST_GeomFromGeoJSON(${l})::${r.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(r.type)!==-1?s+=r.type+"::STGeomFromText("+l+", "+(r.srid||"0")+")":s+=l}o===t.length-1?i===e.length-1?this.connection.driver.options.type==="oracle"&&e.length>1?s+=" FROM DUAL ":this.connection.driver.options.type==="sap"&&e.length>1?s+=" FROM dummy ":s+=")":this.connection.driver.options.type==="oracle"&&e.length>1?s+=" FROM DUAL UNION ALL ":this.connection.driver.options.type==="sap"&&e.length>1?s+=" FROM dummy UNION ALL ":s+="), ":s+=", "})}),s==="()"?"":s}else{let s="";return e.forEach((a,i)=>{Object.keys(a).forEach((r,o)=>{o===0&&(s+="(");const c=a[r];typeof c=="function"?s+=c():c===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||E.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?s+="NULL":s+="DEFAULT":c===null&&this.connection.driver.options.type==="spanner"||(s+=this.createParameter(c)),o===Object.keys(a).length-1?i===e.length-1?s+=")":s+="), ":s+=", "})}),s==="()"?"":s}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(we.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new sp}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}}class Ir{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const s=t.joinColumns.reduce((a,i)=>{const r=we.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(a,r),a},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(s).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const s={};t.inverseRelation.joinColumns.forEach(c=>{s[c.propertyName]=null});const a=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},r=[];a.forEach((c,l)=>{t.inverseRelation.joinColumns.map((u,p)=>{const h="joinColumn_"+l+"_"+p;i[h]=we.isObject(c)?u.referencedColumn.getEntityValue(c):c,r.push(`${u.propertyPath} = :${h}`)})});const o=r.map(c=>"("+c+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(s).where(o).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new S("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const s=this.expressionMap.of,a=t.inverseRelation.joinColumns.reduce((i,r)=>{const o=we.isObject(s)?r.referencedColumn.getEntityValue(s):s;return r.setEntityValue(i,o),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(a).whereInIds(e).execute()}else{const s=t.junctionEntityMetadata,a=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?a:i,o=t.isManyToManyOwner?i:a,c=[];if(r.forEach(l=>{o.forEach(u=>{const p={};s.ownerColumns.forEach(h=>{p[h.databaseName]=we.isObject(l)?h.referencedColumn.getEntityValue(l):l}),s.inverseColumns.forEach(h=>{p[h.databaseName]=we.isObject(u)?h.referencedColumn.getEntityValue(u):u}),c.push(p)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(l=>this.queryBuilder.createQueryBuilder().insert().into(s.tableName).values(l).execute())):await this.queryBuilder.createQueryBuilder().insert().into(s.tableName).values(c).execute()}}}class Ep{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],a=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(l=>{i[l.propertyName]=null});const r={},o=[];s.forEach((l,u)=>{o.push(...a.map((p,h)=>[...t.inverseRelation.joinColumns.map((d,m)=>{const f="joinColumn_"+u+"_"+h+"_"+m;return r[f]=we.isObject(l)?d.referencedColumn.getEntityValue(l):l,`${d.propertyPath} = :${f}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((d,m)=>{const f="primaryColumn_"+h+"_"+h+"_"+m;return r[f]=we.isObject(p)?d.getEntityValue(p):p,`${d.propertyPath} = :${f}`})].join(" AND ")))});const c=o.map(l=>"("+l+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(c).setParameters(r).execute()}else{const s=t.junctionEntityMetadata,a=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?a:i,o=t.isManyToManyOwner?i:a,c={},l=[];r.forEach((p,h)=>{l.push(...o.map((d,m)=>[...s.ownerColumns.map((f,y)=>{const g="firstValue_"+h+"_"+m+"_"+y;return c[g]=we.isObject(p)?f.referencedColumn.getEntityValue(p):p,`${f.databaseName} = :${g}`}),...s.inverseColumns.map((f,y)=>{const g="secondValue_"+h+"_"+m+"_"+y;return c[g]=we.isObject(d)?f.referencedColumn.getEntityValue(d):d,`${f.databaseName} = :${g}`})].join(" AND ")))});const u=l.map(p=>"("+p+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(s.tableName).where(u).setParameters(c).execute()}}}class Cp extends ye{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new S("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new S(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!we.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new S('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Ir(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new S("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new S(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!we.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new S('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Ir(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new S("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new S(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new Ep(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!we.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new S("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class Ie{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(s,a)=>e.slice(a*t,a*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((s,a)=>{const i=t(a);let r=s.find(o=>o.id===i);return r||(r={id:i,items:[]},s.push(r)),r.items.push(a),s},[])}static uniq(e,t){return e.reduce((s,a)=>{let i=!1;if(typeof t=="function"){const r=t(a);i=!!s.find(o=>t(o)===r)}else typeof t=="string"?i=!!s.find(r=>r[t]===a[t]):i=s.indexOf(a)!==-1;return i||s.push(a),s},[])}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,s,a){if(a.has(s)){e[t]=a.get(s);return}if(!(s instanceof Promise)){if(!this.isPlainObject(s)&&!Array.isArray(s)){e[t]=s;return}e[t]||(e[t]=Array.isArray(s)?[]:{}),a.set(s,e[t]),this.merge(e[t],s,a),a.delete(s)}}static mergeObjectKey(e,t,s,a){if(a.has(s)){Object.assign(e,{[t]:a.get(s)});return}if(!(s instanceof Promise)){if(!this.isPlainObject(s)&&!Array.isArray(s)){Object.assign(e,{[t]:s});return}e[t]||Object.assign(e,{[t]:Array.isArray(s)?[]:{}}),a.set(s,e[t]),this.merge(e[t],s,a),a.delete(s)}}static merge(e,t,s=new Map){if(this.isPlainObject(e)&&this.isPlainObject(t))for(const a of Object.keys(t))a!=="__proto__"&&this.mergeObjectKey(e,a,t[a],s);if(Array.isArray(e)&&Array.isArray(t))for(let a=0;a<t.length;a++)this.mergeArrayKey(e,a,t[a],s)}static mergeDeep(e,...t){if(!t.length)return e;for(const s of t)Ie.merge(e,s);return e}static deepCompare(...e){let t,s,a,i;if(arguments.length<1)return!0;for(t=1,s=arguments.length;t<s;t++)if(a=[],i=[],!this.compare2Objects(a,i,arguments[0],arguments[t]))return!1;return!0}static deepValue(e,t){const s=t.split(".");for(let a=0,i=s.length;a<i;a++)e=e[s[a]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:this.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let s of e){const a=s.split(".");if(!a.length)continue;(!t[a[0]]||t[a[0]]===!0)&&(t[a[0]]={});let i=t[a[0]];for(let[r,o]of a.entries())r!==0&&(i[o]?i=i[o]:r===a.length-1?(i[o]={},i=null):(i[o]={},i=i[o]))}return this.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:Ie.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static zipObject(e,t){return e.reduce((s,a,i)=>(s[a]=t[i],s),{})}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(s=>t.indexOf(s)!==-1)}static areMutuallyExclusive(...e){return!e.some(t=>{const s=e.filter(a=>a!==t);return t.some(a=>s.some(i=>i.includes(a)))})}static parseSqlCheckExpression(e,t){const s=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(s&&s.index){const a=e.substring(s.index+s[0].length);let i="",r="";const o=[];for(let c=0;c<a.length;c++){const l=a[c];switch(l){case",":i==""?(o.push(r),r=""):r+=l;break;case"'":i==l?a[c+1]===l?(r+=l,c+=1):i="":i=l;break;case")":if(i=="")return o.push(r),o;r+=l;break;default:i!=""&&(r+=l)}}}}static compare2Objects(e,t,s,a){let i;if(Number.isNaN(s)&&Number.isNaN(a)||s===a)return!0;if(s===null||a===null||s===void 0||a===void 0)return!1;if((typeof s.equals=="function"||typeof s.equals=="function")&&s.equals(a))return!0;if(typeof s=="function"&&typeof a=="function"||s instanceof Date&&a instanceof Date||s instanceof RegExp&&a instanceof RegExp||typeof s=="string"&&typeof a=="string"||typeof s=="number"&&typeof a=="number")return s.toString()===a.toString();if(!(typeof s=="object"&&typeof a=="object")||Object.prototype.isPrototypeOf.call(s,a)||Object.prototype.isPrototypeOf.call(a,s)||s.constructor!==a.constructor||s.prototype!==a.prototype||e.indexOf(s)>-1||t.indexOf(a)>-1)return!1;for(i in a)if(a.hasOwnProperty(i)!==s.hasOwnProperty(i)||typeof a[i]!=typeof s[i])return!1;for(i in s){if(a.hasOwnProperty(i)!==s.hasOwnProperty(i)||typeof a[i]!=typeof s[i])return!1;switch(typeof s[i]){case"object":case"function":if(e.push(s),t.push(a),!this.compare2Objects(e,t,s[i],a[i]))return!1;e.pop(),t.pop();break;default:if(s[i]!==a[i])return!1;break}}return!0}}class Sp{constructor(e,t,s,a,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=s,this.rawRelationCountResults=a,this.queryRunner=i}transform(e,t){const s=this.group(e,t),a=[];return s.forEach(i=>{const r=this.transformRawResultsGroup(i,t);r!==void 0&&!Object.values(r).every(o=>o===null)&&a.push(r)}),a}group(e,t){const s=new Map,a=[];return t.metadata.tableType==="view"?a.push(...t.metadata.columns.map(i=>E.buildAlias(this.driver,void 0,t.name,i.databaseName))):a.push(...t.metadata.primaryColumns.map(i=>E.buildAlias(this.driver,void 0,t.name,i.databaseName))),e.forEach(i=>{const r=a.map(c=>{const l=i[c];return Fe.isBuffer(l)?l.toString("hex"):we.isObject(l)?JSON.stringify(l):l}).join("_"),o=s.get(r);o?o.push(i):s.set(r,[i])}),s}transformRawResultsGroup(e,t){let s=t.metadata;if(s.discriminatorColumn){const l=e.map(p=>p[E.buildAlias(this.driver,void 0,t.name,t.metadata.discriminatorColumn.databaseName)]),u=s.childEntityMetadatas.find(p=>typeof l.find(h=>h===p.discriminatorValue)<"u");u&&(s=u)}let a=s.create(this.queryRunner,{fromDeserializer:!0,pojo:this.expressionMap.options.indexOf("create-pojo")!==-1});const i=this.transformColumns(e,t,a,s),r=this.transformJoins(e,a,t,s),o=this.transformRelationIds(e,t,a,s),c=this.transformRelationCounts(e,t,a);if(i||s.primaryColumns.filter(l=>l.isVirtual===!1).length===0&&(r||o||c))return a}transformColumns(e,t,s,a){let i=!1;return a.columns.forEach(r=>{if(a.childEntityMetadatas.length>0&&a.childEntityMetadatas.findIndex(c=>c.target===r.target)!==-1)return;const o=e[0][E.buildAlias(this.driver,void 0,t.name,r.databaseName)];o===void 0||r.isVirtual||this.expressionMap.selects.find(c=>c.selection===t.name||c.selection===t.name+"."+r.propertyPath)&&(r.setEntityValue(s,this.driver.prepareHydratedValue(o,r)),o!==null&&(i=!0))}),i}transformJoins(e,t,s,a){let i=!1;return this.expressionMap.joinAttributes.forEach(r=>{if(!r.metadata||!r.isSelected||r.relation&&!a.relations.find(c=>c===r.relation))return;if(r.mapToProperty){if(r.mapToPropertyParentAlias!==s.name)return}else if(!r.relation||r.parentAlias!==s.name||r.relationPropertyPath!==r.relation.propertyPath)return;let o=this.transform(e,r.alias);o=r.isMany?o:o[0],o=!r.isMany&&o===void 0?null:o,o!==void 0&&(r.mapToPropertyPropertyName?t[r.mapToPropertyPropertyName]=o:r.relation.setEntityValue(t,o),i=!0)}),i}transformRelationIds(e,t,s,a){let i=!1;return this.rawRelationIdResults.forEach((r,o)=>{if(r.relationIdAttribute.parentAlias!==t.name)return;const c=r.relationIdAttribute.relation,l=this.createValueMapFromJoinColumns(c,r.relationIdAttribute.parentAlias,e);if(l==null)return;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(c,l),p=this.relationIdMaps[o][u]||[],h=r.relationIdAttribute.mapToPropertyPropertyPath.split("."),d=(m,f,y)=>{const g=m.shift();if(g&&m.length===0)return f[g]=y,f;if(g&&m.length>0)d(m,f[g],y);else return f};c.isOneToOne||c.isManyToOne?p[0]!==void 0&&(d(h,s,p[0]),i=!0):(d(h,s,p),i=i||p.length>0)}),i}transformRelationCounts(e,t,s){let a=!1;return this.rawRelationCountResults.filter(i=>i.relationCountAttribute.parentAlias===t.name).forEach(i=>{const r=i.relationCountAttribute.relation;let o;r.isOneToMany?o=r.inverseRelation.joinColumns[0].referencedColumn.databaseName:o=r.isOwning?r.joinColumns[0].referencedColumn.databaseName:r.inverseRelation.joinColumns[0].referencedColumn.databaseName;const c=e[0][E.buildAlias(this.driver,void 0,t.name,o)];c!=null&&(s[i.relationCountAttribute.mapToPropertyPropertyName]=0,i.results.filter(l=>l.parentId===c).forEach(l=>{s[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(l.cnt),a=!0}))}),a}createValueMapFromJoinColumns(e,t,s){let a;return e.isManyToOne||e.isOneToOneOwner?a=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?a=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?a=e.joinColumns.map(i=>i):a=e.inverseRelation.inverseJoinColumns.map(i=>i),a.reduce((i,r)=>(s.forEach(o=>{e.isManyToOne||e.isOneToOneOwner?i[r.databaseName]=this.driver.prepareHydratedValue(o[E.buildAlias(this.driver,void 0,t,r.databaseName)],r):i[r.databaseName]=this.driver.prepareHydratedValue(o[E.buildAlias(this.driver,void 0,t,r.referencedColumn.databaseName)],r.referencedColumn)}),i),{})}extractEntityPrimaryIds(e,t){let s;return e.isManyToOne||e.isOneToOneOwner?s=e.entityMetadata.primaryColumns.map(a=>a):e.isOneToMany||e.isOneToOneNotOwner?s=e.inverseRelation.joinColumns.map(a=>a):e.isOwning?s=e.joinColumns.map(a=>a):s=e.inverseRelation.inverseJoinColumns.map(a=>a),s.reduce((a,i)=>(a[i.databaseName]=t[i.databaseName],a),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let s;return t.isManyToOne||t.isOneToOneOwner?s=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?s=t.inverseEntityMetadata.primaryColumns:t.isOwning?s=t.inverseJoinColumns:s=t.inverseRelation.joinColumns,e.results.reduce((a,i)=>{let r=s.reduce((o,c)=>{let l=i[c.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(l=c.referencedColumn.createValueMap(l)),Ie.mergeDeep(o,c.createValueMap(l))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(l=c.referencedColumn.referencedColumn.createValueMap(l)),Ie.mergeDeep(o,c.referencedColumn.createValueMap(l)))},{});if(s.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?r=s[0].getEntityValue(r):r=s[0].referencedColumn.getEntityValue(r)),r!==void 0){const o=this.hashEntityIds(t,i);a[o]?a[o].push(r):a[o]=[r]}return a},{})}))}hashEntityIds(e,t){const s=this.extractEntityPrimaryIds(e,t);return JSON.stringify(s)}}let kp=class{constructor(n,e,t){this.connection=n,this.queryRunner=e,this.relationIdAttributes=t}async load(n){const e=this.relationIdAttributes.map(async t=>{if(t.relation.isManyToOne||t.relation.isOneToOneOwner){if(t.queryBuilderFactory)throw new S("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const s={},a=n.map(i=>{const r={},o=[];t.relation.joinColumns.forEach(l=>{r[l.databaseName]=this.connection.driver.prepareHydratedValue(i[E.buildAlias(this.connection.driver,void 0,t.parentAlias,l.databaseName)],l.referencedColumn);const u=`${l.databaseName}:${r[l.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),t.relation.entityMetadata.primaryColumns.forEach(l=>{r[l.databaseName]=this.connection.driver.prepareHydratedValue(i[E.buildAlias(this.connection.driver,void 0,t.parentAlias,l.databaseName)],l);const u=`${l.databaseName}:${r[l.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),o.sort();const c=o.join("::");return s[c]?null:(s[c]=!0,r)}).filter(i=>i);return{relationIdAttribute:t,results:a}}else if(t.relation.isOneToMany||t.relation.isOneToOneNotOwner){const s=t.relation,a=s.isOwning?s.joinColumns:s.inverseRelation.joinColumns,i=s.inverseEntityMetadata.target,r=s.inverseEntityMetadata.tableName,o=t.alias||r,c={},l={},u=n.map((d,m)=>{const f=[],y={},g=a.map(O=>{const A=O.databaseName+m,T=d[E.buildAlias(this.connection.driver,void 0,t.parentAlias,O.referencedColumn.databaseName)],C=`${o}:${O.propertyPath}:${T}`;return f.indexOf(C)!==-1?"":(f.push(C),y[A]=T,o+"."+O.propertyPath+" = :"+A)}).filter(O=>O).join(" AND ");f.sort();const v=f.join("::");return c[v]?"":(c[v]=!0,Object.assign(l,y),g)}).filter(d=>d).map(d=>"("+d+")").join(" OR ");if(!u)return{relationIdAttribute:t,results:[]};const p=this.connection.createQueryBuilder(this.queryRunner);Ie.uniq([...a,...s.inverseRelation.entityMetadata.primaryColumns],d=>d.propertyPath).forEach(d=>{p.addSelect(o+"."+d.propertyPath,d.databaseName)}),p.from(i,o).where("("+u+")").setParameters(l),t.queryBuilderFactory&&t.queryBuilderFactory(p);const h=await p.getRawMany();return h.forEach(d=>{a.forEach(m=>{d[m.databaseName]=this.connection.driver.prepareHydratedValue(d[m.databaseName],m.referencedColumn)}),s.inverseRelation.entityMetadata.primaryColumns.forEach(m=>{d[m.databaseName]=this.connection.driver.prepareHydratedValue(d[m.databaseName],m)})}),{relationIdAttribute:t,results:h}}else{const s=t.relation,a=s.isOwning?s.joinColumns:s.inverseRelation.inverseJoinColumns,i=s.isOwning?s.inverseJoinColumns:s.inverseRelation.joinColumns,r=t.junctionAlias,o=t.joinInverseSideMetadata.tableName,c=t.alias||o,l=s.isOwning?s.junctionEntityMetadata.tableName:s.inverseRelation.junctionEntityMetadata.tableName,u=n.map(v=>a.reduce((O,A)=>(O[A.propertyPath]=v[E.buildAlias(this.connection.driver,void 0,t.parentAlias,A.referencedColumn.databaseName)],O),{}));if(u.length===0)return{relationIdAttribute:t,results:[]};const p={},h={},d=u.map((v,O)=>{const A=[],T={},C=Object.keys(v).map(D=>{const B=D+O,$=v[D],re=`${r}:${D}:${$}`;return A.indexOf(re)!==-1?"":(A.push(re),T[B]=$,r+"."+D+" = :"+B)}).filter(D=>D).join(" AND ");A.sort();const W=A.join("::");return h[W]?"":(h[W]=!0,Object.assign(p,T),C)}).filter(v=>v),m=i.map(v=>r+"."+v.propertyPath+" = "+c+"."+v.referencedColumn.propertyPath).join(" AND "),f=d.map(v=>"("+v+" AND "+m+")").join(" OR "),y=this.connection.createQueryBuilder(this.queryRunner);i.forEach(v=>{y.addSelect(r+"."+v.propertyPath,v.databaseName).addOrderBy(r+"."+v.propertyPath)}),a.forEach(v=>{y.addSelect(r+"."+v.propertyPath,v.databaseName).addOrderBy(r+"."+v.propertyPath)}),y.from(o,c).innerJoin(l,r,f).setParameters(p),t.queryBuilderFactory&&t.queryBuilderFactory(y);const g=await y.getRawMany();return g.forEach(v=>{[...a,...i].forEach(O=>{v[O.databaseName]=this.connection.driver.prepareHydratedValue(v[O.databaseName],O.referencedColumn)})}),{relationIdAttribute:t,results:g}}});return Promise.all(e)}};class Tp{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,s){const a=Array.isArray(t)?t:[t],i=Array.isArray(s)?s:s?[s]:void 0;return e.isManyToMany?this.loadForManyToMany(e,a,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,a,i):this.loadForOneToManyAndOneToOneNotOwner(e,a,i)}async loadManyToManyRelationIdsAndGroup(e,t,s,a){const i=e.isManyToMany||e.isOneToMany,r=Array.isArray(t)?t:[t];if(!s&&(s=await this.connection.relationLoader.load(e,t,this.queryRunner,a),!s.length))return r.map(p=>({entity:p,related:i?[]:void 0}));const o=await this.load(e,t,s),c=Array.isArray(s)?s:[s];let l=[],u=[];return e.isManyToManyOwner?(l=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn)):e.isManyToManyNotOwner?(l=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(l=e.joinColumns.map(p=>p.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(l=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(p=>p.referencedColumn)),r.map(p=>{const h={entity:p,related:i?[]:void 0},d=o.filter(m=>u.every(f=>f.compareEntityValue(p,m[f.entityMetadata.name+"_"+f.propertyAliasName])));return d.length&&c.forEach(m=>{d.forEach(f=>{l.every(y=>y.compareEntityValue(m,f[E.buildAlias(this.connection.driver,void 0,y.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+y.propertyPath.replace(".","_"))]))&&(i?h.related.push(m):h.related=m)})}),h})}loadForManyToMany(e,t,s){const a=e.junctionEntityMetadata,i=a.name,r=e.isOwning?a.ownerColumns:a.inverseColumns,o=e.isOwning?a.inverseColumns:a.ownerColumns,c=this.connection.createQueryBuilder(this.queryRunner);r.forEach(h=>{const d=E.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+h.propertyPath,d)}),o.forEach(h=>{const d=E.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+h.propertyPath,d)});let l="";if(r.length===1){const h=t.map(d=>r[0].referencedColumn.getEntityValue(d));h.every(d=>typeof d=="number")?l=`${i}.${r[0].propertyPath} IN (${h.join(", ")})`:(c.setParameter("values1",h),l=i+"."+r[0].propertyPath+" IN (:...values1)")}else l="("+t.map((h,d)=>r.map(m=>{const f="entity1_"+d+"_"+m.propertyName;return c.setParameter(f,m.referencedColumn.getEntityValue(h)),i+"."+m.propertyPath+" = :"+f}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";let u="";if(s)if(o.length===1){const h=s.map(d=>o[0].referencedColumn.getEntityValue(d));h.every(d=>typeof d=="number")?u=`${i}.${o[0].propertyPath} IN (${h.join(", ")})`:(c.setParameter("values2",h),u=i+"."+o[0].propertyPath+" IN (:...values2)")}else u="("+s.map((h,d)=>o.map(m=>{const f="entity2_"+d+"_"+m.propertyName;return c.setParameter(f,m.referencedColumn.getEntityValue(h)),i+"."+m.propertyPath+" = :"+f}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";const p=[l,u].filter(h=>h.length>0).join(" AND ");return c.from(a.target,i).where(p).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,s){const a=e.entityMetadata.targetName,i=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(l=>l===c));if(s&&i){let c=[];if(t.forEach(l=>{let u={};e.entityMetadata.primaryColumns.forEach(p=>{const h=p.entityMetadata.name+"_"+p.propertyPath.replace(".","_");u[h]=p.getEntityValue(l)}),s.forEach(p=>{e.joinColumns.forEach(h=>{const d=h.getEntityValue(l),m=h.referencedColumn.getEntityValue(p);if(!(d===void 0||m===void 0)&&d===m){const f=h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_");u[f]=m}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(u)}),c.length===t.length)return Promise.resolve(c)}const r=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{const l=E.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));r.addSelect(a+"."+c.propertyPath,l)}),e.joinColumns.forEach(c=>{const l=E.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));r.addSelect(a+"."+c.propertyPath,l)});let o="";if(e.entityMetadata.primaryColumns.length===1){const c=t.map(l=>e.entityMetadata.primaryColumns[0].getEntityValue(l));c.every(l=>typeof l=="number")?o=`${a}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(r.setParameter("values",c),o=a+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else o=t.map((c,l)=>e.entityMetadata.primaryColumns.map((u,p)=>{const h="entity"+l+"_"+p;return r.setParameter(h,u.getEntityValue(c)),a+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return r.from(e.entityMetadata.target,a).where(o).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,s){if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(o=>e.joinColumns.indexOf(o)!==-1))return Promise.resolve(t.map(o=>{const c={};return e.joinColumns.forEach(function(l){const u=l.referencedColumn.getEntityValue(o),p=l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"),h=l.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_");c[p]=u,c[h]=u}),c}));const a=e.entityMetadata.targetName,i=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const c=E.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));i.addSelect(a+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{const c=E.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));i.addSelect(a+"."+o.propertyPath,c)});let r="";if(e.joinColumns.length===1){const o=t.map(c=>e.joinColumns[0].referencedColumn.getEntityValue(c));o.every(c=>typeof c=="number")?r=`${a}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(i.setParameter("values",o),r=a+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else r=t.map((o,c)=>e.joinColumns.map((l,u)=>{const p="entity"+c+"_"+u;return i.setParameter(p,l.referencedColumn.getEntityValue(o)),a+"."+l.propertyPath+" = :"+p}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return i.from(e.entityMetadata.target,a).where(r).getRawMany()}}class Np{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const s=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(s)})})}metadataToAttribute(e,t){return new Aa(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Ip{constructor(e,t,s){this.connection=e,this.queryRunner=t,this.relationCountAttributes=s}async load(e){const t=(a,i,r)=>r.indexOf(a)===i,s=this.relationCountAttributes.map(async a=>{if(a.relation.isOneToMany){const i=a.relation,r=i.inverseRelation,o=r.joinColumns[0].referencedColumn.propertyName,c=i.inverseEntityMetadata.target,l=i.inverseEntityMetadata.tableName,u=a.alias||l,p=r.propertyName;let h=e.map(m=>m[a.parentAlias+"_"+o]).filter(m=>!!m);if(h=h.filter(t),h.length===0)return{relationCountAttribute:a,results:[]};const d=this.connection.createQueryBuilder(this.queryRunner);return d.select(u+"."+p,"parentId").addSelect("COUNT(*)","cnt").from(c,u).where(u+"."+p+" IN (:...ids)").addGroupBy(u+"."+p).setParameter("ids",h),a.queryBuilderFactory&&a.queryBuilderFactory(d),{relationCountAttribute:a,results:await d.getRawMany()}}else{let i,r,o,c;a.relation.isOwning?(i=a.relation.joinColumns[0].referencedColumn.databaseName,r=a.relation.inverseJoinColumns[0].referencedColumn.databaseName,o=a.relation.junctionEntityMetadata.columns[0],c=a.relation.junctionEntityMetadata.columns[1]):(i=a.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,r=a.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,o=a.relation.junctionEntityMetadata.columns[1],c=a.relation.junctionEntityMetadata.columns[0]);let l=e.map(y=>y[a.parentAlias+"_"+i]).filter(y=>!!y);if(l=l.filter(t),l.length===0)return{relationCountAttribute:a,results:[]};const u=a.junctionAlias,p=a.joinInverseSideMetadata.tableName,h=a.alias||p,d=a.relation.junctionEntityMetadata.tableName,m=u+"."+o.propertyName+" IN ("+l.map(y=>isNaN(y)?"'"+y+"'":y)+") AND "+u+"."+c.propertyName+" = "+h+"."+r,f=this.connection.createQueryBuilder(this.queryRunner);return f.select(u+"."+o.propertyName,"parentId").addSelect("COUNT("+f.escape(h)+"."+f.escape(r)+")","cnt").from(p,h).innerJoin(d,u,m).addGroupBy(u+"."+o.propertyName),a.queryBuilderFactory&&a.queryBuilderFactory(f),{relationCountAttribute:a,results:await f.getRawMany()}}});return Promise.all(s)}}class jp{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const s=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(s)})})}metadataToAttribute(e,t){return new Pa(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class ka{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t!=null&&t.relations){const s=[...t.relations];if(ka.applyRelationsRecursively(e,s,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),s.length>0)throw new ap(s)}return e}static applyRelationsRecursively(e,t,s,a,i){let r=[];if(i){const o=new RegExp("^"+i.replace(".","\\.")+"\\.");r=t.filter(c=>c.match(o)).map(c=>a.findRelationWithPropertyPath(c.replace(o,""))).filter(c=>c)}else r=t.map(o=>a.findRelationWithPropertyPath(o)).filter(o=>o);r.forEach(o=>{let c=E.buildAlias(e.connection.driver,{joiner:"__"},s,o.propertyPath);const l=s+"."+o.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(o):e.leftJoinAndSelect(l,c),t.splice(t.indexOf(i?i+"."+o.propertyPath:o.propertyPath),1);let u,p;if(e.expressionMap.relationLoadStrategy==="query")u=o.inverseEntityMetadata,p=c;else{const h=e.expressionMap.joinAttributes.find(d=>d.entityOrProperty===l);u=h.metadata,p=h.alias.name}if(!p||!u)throw new At(o.propertyPath,a);if(this.applyRelationsRecursively(e,t,p,u,i?i+"."+o.propertyPath:o.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const h=a.relations.find(d=>d.propertyName===o.propertyPath);h&&this.joinEagerRelations(e,c,h.inverseEntityMetadata)}})}static joinEagerRelations(e,t,s){s.eagerRelations.forEach(a=>{let i=E.buildAlias(e.connection.driver,{joiner:"__"},t,a.propertyName),r=!0;for(const l of e.expressionMap.joinAttributes)if(!(l.condition!==void 0||l.mapToProperty!==void 0||l.isMappingMany!==void 0||l.direction!=="LEFT"||l.entityOrProperty!==`${t}.${a.propertyPath}`)){r=!1,i=l.alias.name;break}const o=!!e.expressionMap.joinAttributes.find(l=>l.alias.name===i);r&&!o&&e.leftJoin(t+"."+a.propertyPath,i);let c=!0;for(const l of e.expressionMap.selects)if(!(l.aliasName!==void 0||l.virtual!==void 0||l.selection!==i)){c=!1;break}c&&e.addSelect(i),this.joinEagerRelations(e,i,a.inverseEntityMetadata)})}}class Ta extends ye{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(s=>({selection:s}));else if(typeof e=="function"){const s=e(this.subQuery());this.setParameters(s.getParameters()),this.expressionMap.selects.push({selection:s.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(s=>({selection:s})));else if(typeof e=="function"){const s=e(this.subQuery());this.setParameters(s.getParameters()),this.expressionMap.selects.push({selection:s.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const s=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(s),this}addFrom(e,t){const s=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(s),this}innerJoin(e,t,s,a){return this.join("INNER",e,t,s,a),this}leftJoin(e,t,s,a){return this.join("LEFT",e,t,s,a),this}innerJoinAndSelect(e,t,s,a){return this.addSelect(t),this.innerJoin(e,t,s,a),this}leftJoinAndSelect(e,t,s,a){return this.addSelect(t),this.leftJoin(e,t,s,a),this}innerJoinAndMapMany(e,t,s,a,i){return this.addSelect(s),this.join("INNER",t,s,a,i,e,!0),this}innerJoinAndMapOne(e,t,s,a,i,r){return this.addSelect(s),this.join("INNER",t,s,a,i,e,!1,r),this}leftJoinAndMapMany(e,t,s,a,i){return this.addSelect(s),this.join("LEFT",t,s,a,i,e,!0),this}leftJoinAndMapOne(e,t,s,a,i,r){return this.addSelect(s),this.join("LEFT",t,s,a,i,e,!1,r),this}loadRelationIdAndMap(e,t,s,a){const i=new Aa(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof s=="string"&&(i.alias=s),typeof s=="object"&&s.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=a,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,s,a){const i=new Pa(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=s,i.queryBuilderFactory=a,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const s=this.getWhereCondition(e);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",s){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new S('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(s!==void 0&&s!=="NULLS FIRST"&&s!=="NULLS LAST")throw new S('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:s?this.expressionMap.orderBys={[e]:{order:t,nulls:s}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",s){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new S('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(s!==void 0&&s!=="NULLS FIRST"&&s!=="NULLS LAST")throw new S('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return s?this.expressionMap.orderBys[e]={order:t,nulls:s}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new S('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new S('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new S('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new S('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,s){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=s,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new kn;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const s=await this.loadRawResults(e);return t&&await e.commitTransaction(),s}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const s=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),s}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const e=(await this.getRawAndEntities()).entities[0];if(e&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const t=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const s=t.updateDateColumn.getEntityValue(e);if(s.getTime()!==this.expressionMap.lockVersion.getTime())throw new dr(t.name,this.expressionMap.lockVersion,s)}else{const s=t.versionColumn.getEntityValue(e);if(s!==this.expressionMap.lockVersion)throw new dr(t.name,this.expressionMap.lockVersion,s)}}return e===void 0?null:e}async getOneOrFail(){const e=await this.getOne();if(!e)throw new ep(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new kn;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new kn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const s=await this.executeCountQuery(e);return t&&await e.commitTransaction(),s}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new kn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const s=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),s}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new kn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const s=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;const a=this.expressionMap.cacheId;this.expressionMap.cacheId=a&&`${a}-count`;const i=await this.executeCountQuery(e),r=[s.entities,i];return t&&await e.commitTransaction(),r}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),s=this.obtainQueryRunner();let a=!1;try{this.expressionMap.useTransaction===!0&&s.isTransactionActive===!1&&(await s.startTransaction(),a=!0);const i=()=>{if(s!==this.queryRunner)return s.release()},r=s.stream(e,t,i,i);return a&&await s.commitTransaction(),r}catch(i){if(a)try{await s.rollbackTransaction()}catch{}throw i}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,s,a,i,r,o,c){i&&this.setParameters(i);const l=new Cr(this.connection,this.expressionMap);l.direction=e,l.mapAsEntity=c,l.mapToProperty=r,l.isMappingMany=o,l.entityOrProperty=t,l.condition=a,this.expressionMap.joinAttributes.push(l);const u=l.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const p=`${s}.${u.deleteDateColumn.propertyName} IS NULL`;l.condition=l.condition?` ${l.condition} AND ${p}`:`${p}`}l.alias=this.expressionMap.createAlias({type:"join",name:s,metadata:u}),l.relation&&l.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:l.junctionAlias,metadata:l.relation.junctionEntityMetadata})}else{let p="";if(typeof t=="function"){const d=t(this.subQuery());this.setParameters(d.getParameters()),p=d.getQuery()}else p=t;const h=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";l.alias=this.expressionMap.createAlias({type:"join",name:s,tablePath:h===!1?t:void 0,subQuery:h===!0?p:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new S("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const o=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,o)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,o))}this.expressionMap.joinAttributes.forEach(o=>{if(o.metadata)e.push(...this.buildEscapedEntityColumnSelects(o.alias.name,o.metadata)),t.push(...this.findEntityColumnSelects(o.alias.name,o.metadata));else if(this.expressionMap.selects.some(c=>c.selection===o.alias.name)){e.push({selection:this.escape(o.alias.name)+".*"});const c=this.expressionMap.selects.find(l=>l.selection===o.alias.name);t.push(c)}}),this.expressionMap.selects.filter(o=>t.indexOf(o)===-1).forEach(o=>e.push({selection:this.replacePropertyNames(o.selection),aliasName:o.aliasName})),e.length===0&&e.push({selection:"*"});let s="";this.expressionMap.useIndex&&E.isMySQLFamily(this.connection.driver)&&(s=` USE INDEX (${this.expressionMap.useIndex})`);const a=this.expressionMap.aliases.filter(o=>o.type==="from"&&(o.tablePath||o.subQuery)).map(o=>o.subQuery?o.subQuery+" "+this.escape(o.name):this.getTableName(o.tablePath)+" "+this.escape(o.name)),i=this.createSelectDistinctExpression(),r=e.map(o=>o.selection+(o.aliasName?" AS "+this.escape(o.aliasName):"")).join(", ");return i+r+" FROM "+a.join(", ")+this.createTableLockExpression()+s}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:s}=this.expressionMap,{driver:a}=this.connection;let i="SELECT ";return s>0&&E.isMySQLFamily(a)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),E.isPostgresFamily(a)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(r=>this.replacePropertyNames(r)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(e=>{const t=e.relation,s=e.tablePath,a=e.alias.name;let i=e.condition?" AND ("+e.condition+")":"";const r=e.parentAlias;if(!r||!t){const o=e.alias.subQuery?e.alias.subQuery:this.getTableName(s);return" "+e.direction+" JOIN "+o+" "+this.escape(a)+this.createTableLockExpression()+(e.condition?" ON "+this.replacePropertyNames(e.condition):"")}if(t.isManyToOne||t.isOneToOneOwner){const o=t.joinColumns.map(c=>a+"."+c.referencedColumn.propertyPath+"="+r+"."+t.propertyPath+"."+c.referencedColumn.propertyPath).join(" AND ");return" "+e.direction+" JOIN "+this.getTableName(s)+" "+this.escape(a)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+i)}else if(t.isOneToMany||t.isOneToOneNotOwner){const o=t.inverseRelation.joinColumns.map(c=>(t.inverseEntityMetadata.tableType==="entity-child"&&t.inverseEntityMetadata.discriminatorColumn&&(i+=" AND "+a+"."+t.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+t.inverseEntityMetadata.discriminatorValue+"'"),a+"."+t.inverseRelation.propertyPath+"."+c.referencedColumn.propertyPath+"="+r+"."+c.referencedColumn.propertyPath)).join(" AND ");if(!o)throw new S(`Relation ${t.entityMetadata.name}.${t.propertyName} does not have join columns.`);return" "+e.direction+" JOIN "+this.getTableName(s)+" "+this.escape(a)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+i)}else{const o=t.junctionEntityMetadata.tablePath,c=e.junctionAlias;let l="",u="";return t.isOwning?(l=t.joinColumns.map(p=>c+"."+p.propertyPath+"="+r+"."+p.referencedColumn.propertyPath).join(" AND "),u=t.inverseJoinColumns.map(p=>a+"."+p.referencedColumn.propertyPath+"="+c+"."+p.propertyPath).join(" AND ")):(l=t.inverseRelation.inverseJoinColumns.map(p=>c+"."+p.propertyPath+"="+r+"."+p.referencedColumn.propertyPath).join(" AND "),u=t.inverseRelation.joinColumns.map(p=>a+"."+p.referencedColumn.propertyPath+"="+c+"."+p.propertyPath).join(" AND "))," "+e.direction+" JOIN "+this.getTableName(o)+" "+this.escape(c)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l)+" "+e.direction+" JOIN "+this.getTableName(s)+" "+this.escape(a)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u+i)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const s=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,a=this.expressionMap.selects.find(i=>i.selection===t);if(a&&!a.aliasName&&t.indexOf(".")!==-1){const i=t.split("."),r=i[0],o=i.slice(1).join("."),c=this.expressionMap.aliases.find(l=>l.name===r);if(c){const l=c.metadata.findColumnWithPropertyPath(o);if(l){const u=E.buildAlias(this.connection.driver,void 0,r,l.databaseName);return this.escape(u)+" "+s}}}return this.replacePropertyNames(t)+" "+s}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;if(!e&&!t&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take),this.connection.driver.options.type==="mssql"){let s="";if((t||e)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(s=" ORDER BY (SELECT NULL)"),t&&e)return s+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return s+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(e)return s+" OFFSET "+e+" ROWS"}else if(E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)throw new rp}else if(E.isSQLiteFamily(this.connection.driver)){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(t&&e)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return" FETCH NEXT "+t+" ROWS ONLY";if(e)return" OFFSET "+e+" ROWS"}else{if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(E.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new S("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new S("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let s="";switch(this.expressionMap.onLocked==="nowait"?s=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(s=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return E.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+s:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(E.isPostgresFamily(e))return" FOR SHARE"+t+s;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new an;case"pessimistic_write":if(E.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+s;if(E.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+s;if(e.options.type==="mssql")return"";throw new an;case"pessimistic_partial_write":if(E.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(E.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new an;case"pessimistic_write_or_fail":if(E.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(E.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new an;case"for_no_key_update":if(E.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+s;throw new an;case"for_key_share":if(E.isPostgresFamily(e))return" FOR KEY SHARE"+t+s;throw new an;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,s)=>{switch(t.type){case"and":return(s>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(s>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const s=this.expressionMap.selects.some(l=>l.selection===e),a=[];if(s&&a.push(...t.columns.filter(l=>l.isSelect===!0)),a.push(...t.columns.filter(l=>this.expressionMap.selects.some(u=>u.selection===e+"."+l.propertyPath))),a.length===0)return[];const i=this.expressionMap.queryEntity?t.primaryColumns.filter(l=>a.indexOf(l)===-1):[],r=[...a,...i],o=[],c=this.escape(e);return r.forEach(l=>{let u=c+"."+this.escape(l.databaseName);l.isVirtualProperty&&l.query&&(u=`(${l.query(c)})`),this.connection.driver.spatialTypes.indexOf(l.type)!==-1&&((E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),E.isPostgresFamily(this.connection.driver)&&(l.precision?u=`ST_AsGeoJSON(${u}, ${l.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const p=this.expressionMap.selects.filter(h=>h.selection===e+"."+l.propertyPath);if(p.length)p.forEach(h=>{o.push({selection:u,aliasName:h.aliasName?h.aliasName:E.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:h.virtual})});else{if(l.isVirtualProperty)return;o.push({selection:u,aliasName:E.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:s})}}),o}findEntityColumnSelects(e,t){const s=this.expressionMap.selects.find(a=>a.selection===e);return s?[s]:this.expressionMap.selects.filter(a=>t.columns.some(i=>a.selection===e+"."+i.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,t=this.expressionMap.mainAlias.metadata.primaryColumns,s=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||E.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+t.map(a=>`${s}.${this.escape(a.databaseName)}`).join(", ")+"))";if(E.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+t.map(a=>`${s}.${this.escape(a.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const a=t.map(i=>`${s}.${this.escape(i.databaseName)}`).join(", '|;|', ");return t.length===1?`COUNT(DISTINCT(${a}))`:`COUNT(DISTINCT(CONCAT(${a})))`}return this.connection.driver.options.type==="spanner"?t.length===1?`COUNT(DISTINCT(${s}.${this.escape(t[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${t.map(a=>`CAST(${s}.${this.escape(a.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+t.map(a=>`${s}.${this.escape(a.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),s=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!s||!s[0]||!s[0].cnt?0:parseInt(s[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?Ie.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?Ie.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const s=this.expressionMap.aliases.find(a=>a.metadata.tableNameWithoutPrefix===t);if(!s)throw new S(`"${t}" is not part of this query`);return this.escape(s.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&ka.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new S('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new ip;if(this.expressionMap.lockMode==="optimistic"){const r=this.expressionMap.mainAlias.metadata;if(!r.versionColumn&&!r.updateDateColumn)throw new np(r.name)}const t=new kp(this.connection,e,this.expressionMap.relationIdAttributes),s=new Ip(this.connection,e,this.expressionMap.relationCountAttributes);new Np(this.expressionMap).transform(),new jp(this.expressionMap).transform();let a=[],i=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[r,o]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),c=this.expressionMap.mainAlias.metadata,l=this.expressionMap.mainAlias.name,u=c.primaryColumns.map(d=>{const m=this.escape("distinctAlias"),f=this.escape(E.buildAlias(this.connection.driver,void 0,l,d.databaseName));o[f]||(o[f]="ASC");const y=E.buildAlias(this.connection.driver,void 0,"ids_"+l,d.databaseName);return`${m}.${f} AS ${this.escape(y)}`}),p=this.clone(),h=p.expressionMap.timeTravel;if(a=await new Ta(this.connection,e).select(`DISTINCT ${u.join(", ")}`).addSelect(r).from(`(${p.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(h).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(o).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),a.length>0){let d="";const m={};if(c.hasMultiplePrimaryKeys)d=a.map((f,y)=>c.primaryColumns.map(g=>{const v=`orm_distinct_ids_${y}_${g.databaseName}`,O=E.buildAlias(this.connection.driver,void 0,"ids_"+l,g.databaseName);return m[v]=f[O],`${l}.${g.propertyPath}=:${v}`}).join(" AND ")).join(" OR ");else{const f=E.buildAlias(this.connection.driver,void 0,"ids_"+l,c.primaryColumns[0].databaseName),y=a.map(g=>g[f]);y.every(g=>typeof g=="number")?d=`${l}.${c.primaryColumns[0].propertyPath} IN (${y.join(", ")})`:(m.orm_distinct_ids=y,d=l+"."+c.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}a=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:d}).setParameters(m).loadRawResults(e)}}else a=await this.loadRawResults(e);if(a.length>0){const r=await t.load(a),o=await s.load(a);i=new Sp(this.expressionMap,this.connection.driver,r,o,this.queryRunner).transform(a,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,i)}if(this.expressionMap.relationLoadStrategy==="query"){const r=new Tp(this.connection,e);await Promise.all(this.relationMetadatas.map(async o=>{const c=o.inverseEntityMetadata.target,l=o.inverseEntityMetadata.targetName,u=Array.isArray(this.findOptions.select)?Ie.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,p=Array.isArray(this.findOptions.relations)?Ie.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,h=this.createQueryBuilder(e).select(l).from(c,l).setFindOptions({select:u?Ie.deepValue(u,o.propertyPath):void 0,order:this.findOptions.order?Ie.deepValue(this.findOptions.order,o.propertyPath):void 0,relations:p?Ie.deepValue(p,o.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(i.length>0){const d=await r.loadManyToManyRelationIdsAndGroup(o,i,void 0,h);i.forEach(m=>{const f=d.find(y=>y.entity===m);if(f){const y=f.related===void 0?null:f.related;o.setEntityValue(m,y)}})}}))}return{raw:a,entities:i}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,s=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){const r=i.split("."),o=r[0],c=r.slice(1).join("."),l=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(E.buildAlias(this.connection.driver,void 0,o,l.databaseName))}else return this.expressionMap.selects.find(r=>r.selection===i||r.aliasName===i)?this.escape(e)+"."+this.escape(i):""}).join(", "),a={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){const r=i.split("."),o=r[0],c=r.slice(1).join("."),l=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);a[this.escape(e)+"."+this.escape(E.buildAlias(this.connection.driver,void 0,o,l.databaseName))]=t[i]}else this.expressionMap.selects.find(r=>r.selection===i||r.aliasName===i)?a[this.escape(e)+"."+this.escape(i)]=t[i]:a[i]=t[i]}),[s,a]}async loadRawResults(e){const[t,s]=this.getQueryAndParameters(),a=t+" -- PARAMETERS: "+JSON.stringify(s,(u,p)=>typeof p=="bigint"?p.toString():p),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let r;const o=i.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let c=!1;if(this.connection.queryResultCache&&o)try{if(r=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:a,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),r&&!this.connection.queryResultCache.isExpired(r))return JSON.parse(r.result)}catch(u){if(!i.ignoreErrors)throw u;c=!0}const l=await e.query(t,s,!0);if(!c&&this.connection.queryResultCache&&o)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:a,time:new Date().getTime(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(l.records)},r,e)}catch(u){if(!i.ignoreErrors)throw u}return l.records}mergeExpressionMap(e){return we.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,s,a){for(let i in e){if(e[i]===void 0||e[i]===!1)continue;const r=a?a+"."+i:i,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new At(r,t);o?this.selects.push(s+"."+r):c&&this.buildSelect(e[i],t,s,r)}}buildRelations(e,t,s,a,i){e&&Object.keys(e).forEach(r=>{const o=e[r],c=i?i+"."+r:r,l=s.findEmbeddedWithPropertyPath(c),u=s.findRelationWithPropertyPath(c);if(!l&&!u)throw new At(c,s);if(l)this.buildRelations(o,typeof t=="object"?Ie.deepValue(t,l.propertyPath):void 0,s,a,c);else if(u){let p=a+"_"+c.replace(".","_");p=E.buildAlias(this.connection.driver,{joiner:"__"},a,p),(o===!0||typeof o=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[r]=="object"?t[r]:void 0,alias:p,parentAlias:a,relationMetadata:u}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,p))),typeof o=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(o,typeof t=="object"?Ie.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,p,void 0)}})}buildEagerRelations(e,t,s,a,i){e&&Object.keys(e).forEach(r=>{const o=e[r],c=i?i+"."+r:r,l=s.findEmbeddedWithPropertyPath(c),u=s.findRelationWithPropertyPath(c);if(!l&&!u)throw new At(c,s);if(l)this.buildEagerRelations(o,typeof t=="object"?Ie.deepValue(t,l.propertyPath):void 0,s,a,c);else if(u){let p=a+"_"+c.replace(".","_");p=E.buildAlias(this.connection.driver,{joiner:"__"},a,p),(o===!0||typeof o=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(h=>{let d=p+"_"+h.propertyPath.replace(".","_");d=E.buildAlias(this.connection.driver,{joiner:"__"},p,d),this.joins.find(m=>m.alias===d)||this.joins.push({type:"left",select:!0,alias:d,parentAlias:p,selection:void 0,relationMetadata:h}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,p)}),typeof o=="object"&&this.buildEagerRelations(o,typeof t=="object"?Ie.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,p,void 0)}})}buildOrder(e,t,s,a){for(let i in e){if(e[i]===void 0)continue;const r=a?a+"."+i:i,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new At(r,t);if(o){let u=typeof e[i]=="object"?e[i].direction:e[i];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let p=typeof e[i]=="object"?e[i].nulls:void 0;p=(p==null?void 0:p.toLowerCase())==="first"?"NULLS FIRST":(p==null?void 0:p.toLowerCase())==="last"?"NULLS LAST":void 0;let h=`${s}.${r}`;this.addOrderBy(h,u,p)}else if(c)this.buildOrder(e[i],t,s,r);else if(l){let u=s+"_"+r.replace(".","_");u=E.buildAlias(this.connection.driver,{joiner:"__"},s,u),this.joins.find(p=>p.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:s,selection:void 0,relationMetadata:l}),this.buildOrder(e[i],l.inverseEntityMetadata,u)}}}buildWhere(e,t,s,a){let i="";if(Array.isArray(e))e.length&&(i=e.map(r=>this.buildWhere(r,t,s,a)).filter(r=>!!r).map(r=>"("+r+")").join(" OR "));else{let r=[];for(let o in e){if(e[o]===void 0||e[o]===null)continue;const c=a?a+"."+o:o,l=t.findColumnWithPropertyPathStrict(c),u=t.findEmbeddedWithPropertyPath(c),p=t.findRelationWithPropertyPath(c);if(!u&&!l&&!p)throw new At(c,t);if(l){let h=`${s}.${c}`;l.isVirtualProperty&&l.query&&(h=`(${l.query(s)})`);let d=e[o];le.isEqualOperator(e[o])&&(d=e[o].value),l.transformer&&(d instanceof Tn?d.transformValue(l.transformer):d=Ca.transformTo(l.transformer,d)),r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(h,d)))}else if(u){const h=this.buildWhere(e[o],t,s,c);h&&r.push(h)}else if(p){if(typeof e[o]=="object"&&Object.keys(e[o]).every(h=>e[o][h]===void 0))continue;if(le.isFindOperator(e[o]))if(e[o].type==="moreThan"||e[o].type==="lessThan"||e[o].type==="moreThanOrEqual"||e[o].type==="lessThanOrEqual"){let h="";e[o].type==="moreThan"?h=">":e[o].type==="lessThan"?h="<":e[o].type==="moreThanOrEqual"?h=">=":e[o].type==="lessThanOrEqual"&&(h="<=");const d=this.subQuery();if(p.isManyToManyOwner)d.select("COUNT(*)").from(p.joinTableName,p.joinTableName).where(p.joinColumns.map(m=>`${p.joinTableName}.${m.propertyName} = ${s}.${m.referencedColumn.propertyName}`).join(" AND "));else if(p.isManyToManyNotOwner)d.select("COUNT(*)").from(p.inverseRelation.joinTableName,p.inverseRelation.joinTableName).where(p.inverseRelation.inverseJoinColumns.map(m=>`${p.inverseRelation.joinTableName}.${m.propertyName} = ${s}.${m.referencedColumn.propertyName}`).join(" AND "));else if(p.isOneToMany)d.select("COUNT(*)").from(p.inverseEntityMetadata.target,p.inverseEntityMetadata.tableName).where(p.inverseRelation.joinColumns.map(m=>`${p.inverseEntityMetadata.tableName}.${m.propertyName} = ${s}.${m.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(d.getSql()+" "+h+" "+parseInt(e[o].value))}else if(p.isManyToOne||p.isOneToOne&&p.isOneToOneOwner){const h=`${s}.${c}`;r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(h,e[o])))}else throw new Error("This relation isn't supported by given find operator");else{let h=s+"_"+p.propertyPath.replace(".","_");h=E.buildAlias(this.connection.driver,{joiner:"__"},s,h),this.joins.find(m=>m.alias===h)||this.joins.push({type:"left",select:!1,selection:void 0,alias:h,parentAlias:s,relationMetadata:p});const d=this.buildWhere(e[o],p.inverseEntityMetadata,h);d&&r.push(d)}}}i=r.length?"("+r.join(") AND (")+")":r.join(" AND ")}return i.length?"("+i+")":i}}class jr{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class Rp extends ye{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const s=new Sa(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=s.getSoftDeletionReturningColumns());const[a,i]=this.getQueryAndParameters(),r=await e.query(a,i,!0),o=jr.from(r);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await s.update(o,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),o}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=le.isEntitySchema(e)?e.options.name:e;const s=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(s),this}where(e,t){this.expressionMap.wheres=[];const s=this.getWhereCondition(e);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new cs;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",s){return e?typeof e=="object"?this.expressionMap.orderBys=e:s?this.expressionMap.orderBys={[e]:{order:t,nulls:s}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",s){return s?this.expressionMap.orderBys[e]={order:t,nulls:s}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new S(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(s=>{const a=this.expressionMap.mainAlias.metadata.getEntityIdMap(s);if(!a)throw new S("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(a)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new S(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new tp(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new S('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new fa;const s=this.createWhereExpression(),a=this.createReturningExpression("update");return a===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${a}${s}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${s} RETURNING ${a}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(E.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new mr}return""}}class $p extends ye{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let s=null,a=null;const i=new Sa(e,this.expressionMap),r=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)r.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=i.getUpdationReturningColumns(),r.push(...this.expressionMap.extraReturningColumns.filter(h=>!r.includes(h)))),r.length>0&&this.connection.driver.options.type==="mssql"&&(s=this.connection.driver.buildTableVariableDeclaration("@OutputTable",r),a="SELECT * FROM @OutputTable");const[o,c]=this.getQueryAndParameters(),l=[s,o,a],u=await e.query(l.filter(h=>h!=null).join(`;

`),c,!0),p=jr.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await i.update(p,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),p}catch(s){if(t)try{await e.rollbackTransaction()}catch{}throw s}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const s=this.getWhereCondition(e);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new cs;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",s){return e?typeof e=="object"?this.expressionMap.orderBys=e:s?this.expressionMap.orderBys={[e]:{order:t,nulls:s}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",s){return s?this.expressionMap.orderBys[e]={order:t,nulls:s}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new S(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(s=>{const a=this.expressionMap.mainAlias.metadata.getEntityIdMap(s);if(!a)throw new S("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(a)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,s={};for(let c in e)e[c]!==void 0&&(s[c]=e[c]);const a=[],i=[];if(t?(this.createPropertyPath(t,s).forEach(c=>{const l=t.findColumnsWithPropertyPath(c);if(l.length<=0)throw new At(c,t);l.forEach(u=>{if(!u.isUpdate||i.includes(u))return;i.push(u);let p=u.getEntityValue(s);if(u.referencedColumn&&typeof p=="object"&&!(p instanceof Date)&&p!==null&&!Fe.isBuffer(p)?p=u.referencedColumn.getEntityValue(p):typeof p!="function"&&(p=this.connection.driver.preparePersistentValue(p,u)),typeof p=="function")a.push(this.escape(u.databaseName)+" = "+p());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&p===null)a.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(p=this.connection.driver.parametrizeValue(u,p));const h=this.createParameter(p);let d=null;if((E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const m=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?d=`${m}(${h}, ${u.srid})`:d=`${m}(${h})`}else E.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?d=`ST_SetSRID(ST_GeomFromGeoJSON(${h}), ${u.srid})::${u.type}`:d=`ST_GeomFromGeoJSON(${h})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?d=u.type+"::STGeomFromText("+h+", "+(u.srid||"0")+")":d=h;a.push(this.escape(u.databaseName)+" = "+d)}})}),(a.length>0||Object.keys(s).length===0)&&(t.versionColumn&&i.indexOf(t.versionColumn)===-1&&a.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&i.indexOf(t.updateDateColumn)===-1&&a.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(s).map(c=>{let l=s[c];if(typeof l=="function")a.push(this.escape(c)+" = "+l());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&l===null)a.push(this.escape(c)+" = NULL");else{const u=this.createParameter(l);a.push(this.escape(c)+" = "+u)}}),a.length<=0)throw new fa;const r=this.createWhereExpression(),o=this.createReturningExpression("update");return o===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${a.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${a.join(", ")} OUTPUT ${o}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${a.join(", ")}${r} RETURNING ${o}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(E.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new mr}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new fa}}function Lp(){ye.registerQueryBuilderClass("DeleteQueryBuilder",n=>new vp(n)),ye.registerQueryBuilderClass("InsertQueryBuilder",n=>new Pp(n)),ye.registerQueryBuilderClass("RelationQueryBuilder",n=>new Cp(n)),ye.registerQueryBuilderClass("SelectQueryBuilder",n=>new Ta(n)),ye.registerQueryBuilderClass("SoftDeleteQueryBuilder",n=>new Rp(n)),ye.registerQueryBuilderClass("UpdateQueryBuilder",n=>new $p(n))}var Rr;(function(n){n.VIEW="VIEW",n.MATERIALIZED_VIEW="MATERIALIZED_VIEW",n.GENERATED_COLUMN="GENERATED_COLUMN"})(Rr||(Rr={}));var Na={exports:{}},Ia,$r;function Bp(){if($r)return Ia;$r=1;var n=1e3,e=n*60,t=e*60,s=t*24,a=s*7,i=s*365.25;Ia=function(u,p){p=p||{};var h=typeof u;if(h==="string"&&u.length>0)return r(u);if(h==="number"&&isFinite(u))return p.long?c(u):o(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function r(u){if(u=String(u),!(u.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(p){var h=parseFloat(p[1]),d=(p[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"yrs":case"yr":case"y":return h*i;case"weeks":case"week":case"w":return h*a;case"days":case"day":case"d":return h*s;case"hours":case"hour":case"hrs":case"hr":case"h":return h*t;case"minutes":case"minute":case"mins":case"min":case"m":return h*e;case"seconds":case"second":case"secs":case"sec":case"s":return h*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function o(u){var p=Math.abs(u);return p>=s?Math.round(u/s)+"d":p>=t?Math.round(u/t)+"h":p>=e?Math.round(u/e)+"m":p>=n?Math.round(u/n)+"s":u+"ms"}function c(u){var p=Math.abs(u);return p>=s?l(u,p,s,"day"):p>=t?l(u,p,t,"hour"):p>=e?l(u,p,e,"minute"):p>=n?l(u,p,n,"second"):u+" ms"}function l(u,p,h,d){var m=p>=h*1.5;return Math.round(u/h)+" "+d+(m?"s":"")}return Ia}var ja,Lr;function Fp(){if(Lr)return ja;Lr=1;function n(e){s.debug=s,s.default=s,s.coerce=l,s.disable=r,s.enable=i,s.enabled=o,s.humanize=Bp(),s.destroy=u,Object.keys(e).forEach(p=>{s[p]=e[p]}),s.names=[],s.skips=[],s.formatters={};function t(p){let h=0;for(let d=0;d<p.length;d++)h=(h<<5)-h+p.charCodeAt(d),h|=0;return s.colors[Math.abs(h)%s.colors.length]}s.selectColor=t;function s(p){let h,d=null,m,f;function y(...g){if(!y.enabled)return;const v=y,O=Number(new Date),A=O-(h||O);v.diff=A,v.prev=h,v.curr=O,h=O,g[0]=s.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let T=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(C,W)=>{if(C==="%%")return"%";T++;const D=s.formatters[W];if(typeof D=="function"){const B=g[T];C=D.call(v,B),g.splice(T,1),T--}return C}),s.formatArgs.call(v,g),(v.log||s.log).apply(v,g)}return y.namespace=p,y.useColors=s.useColors(),y.color=s.selectColor(p),y.extend=a,y.destroy=s.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(m!==s.namespaces&&(m=s.namespaces,f=s.enabled(p)),f),set:g=>{d=g}}),typeof s.init=="function"&&s.init(y),y}function a(p,h){const d=s(this.namespace+(typeof h>"u"?":":h)+p);return d.log=this.log,d}function i(p){s.save(p),s.namespaces=p,s.names=[],s.skips=[];let h;const d=(typeof p=="string"?p:"").split(/[\s,]+/),m=d.length;for(h=0;h<m;h++)d[h]&&(p=d[h].replace(/\*/g,".*?"),p[0]==="-"?s.skips.push(new RegExp("^"+p.slice(1)+"$")):s.names.push(new RegExp("^"+p+"$")))}function r(){const p=[...s.names.map(c),...s.skips.map(c).map(h=>"-"+h)].join(",");return s.enable(""),p}function o(p){if(p[p.length-1]==="*")return!0;let h,d;for(h=0,d=s.skips.length;h<d;h++)if(s.skips[h].test(p))return!1;for(h=0,d=s.names.length;h<d;h++)if(s.names[h].test(p))return!0;return!1}function c(p){return p.toString().substring(2,p.toString().length-2).replace(/\.\*\?$/,"*")}function l(p){return p instanceof Error?p.stack||p.message:p}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}return ja=n,ja}var Br;function qp(){return Br||(Br=1,function(n,e){var t={};e.formatArgs=a,e.save=i,e.load=r,e.useColors=s,e.storage=o(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let l;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(l=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(l[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function a(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;l.splice(1,0,u,"color: inherit");let p=0,h=0;l[0].replace(/%[a-zA-Z%]/g,d=>{d!=="%%"&&(p++,d==="%c"&&(h=p))}),l.splice(h,0,u)}e.log=console.debug||console.log||(()=>{});function i(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}}function r(){let l;try{l=e.storage.getItem("debug")}catch{}return!l&&typeof Te<"u"&&"env"in Te&&(l=t.DEBUG),l}function o(){try{return localStorage}catch{}}n.exports=Fp()(e);const{formatters:c}=n.exports;c.j=function(l){try{return JSON.stringify(l)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}}(Na,Na.exports)),Na.exports}qp(),Lp(),Qu=()=>{const n=ss(e=>e.loadModel);return{loadModel:M.useCallback(async(e,...t)=>{switch(e){case Mt.WebLLM:return n(...t);default:return}},[n])}};var Dp=Object.defineProperty,Up=Object.defineProperties,Wp=Object.getOwnPropertyDescriptors,us=Object.getOwnPropertySymbols,Fr=Object.prototype.hasOwnProperty,qr=Object.prototype.propertyIsEnumerable,Dr=(n,e,t)=>e in n?Dp(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,zp=(n,e)=>{for(var t in e||(e={}))Fr.call(e,t)&&Dr(n,t,e[t]);if(us)for(var t of us(e))qr.call(e,t)&&Dr(n,t,e[t]);return n},Zp=(n,e)=>Up(n,Wp(e)),Vp=(n,e)=>{var t={};for(var s in n)Fr.call(n,s)&&e.indexOf(s)<0&&(t[s]=n[s]);if(n!=null&&us)for(var s of us(n))e.indexOf(s)<0&&qr.call(n,s)&&(t[s]=n[s]);return t};function Kp(n){let e=setTimeout(n,0),t=setTimeout(n,10),s=setTimeout(n,50);return[e,t,s]}function Qp(n){let e=M.useRef();return M.useEffect(()=>{e.current=n}),e.current}var Hp=18,Ur=40,Jp=`${Ur}px`,Gp=["[data-lastpass-icon-root]","com-1password-button","[data-dashlanecreated]",'[style$="2147483647 !important;"]'].join(",");function Xp({containerRef:n,inputRef:e,pushPasswordManagerStrategy:t,isFocused:s}){let[a,i]=M.useState(!1),[r,o]=M.useState(!1),[c,l]=M.useState(!1),u=M.useMemo(()=>t==="none"?!1:(t==="increase-width"||t==="experimental-no-flickering")&&a&&r,[a,r,t]),p=M.useCallback(()=>{let h=n.current,d=e.current;if(!h||!d||c||t==="none")return;let m=h,f=m.getBoundingClientRect().left+m.offsetWidth,y=m.getBoundingClientRect().top+m.offsetHeight/2,g=f-Hp,v=y;document.querySelectorAll(Gp).length===0&&document.elementFromPoint(g,v)===h||(i(!0),l(!0))},[n,e,c,t]);return M.useEffect(()=>{let h=n.current;if(!h||t==="none")return;function d(){let f=window.innerWidth-h.getBoundingClientRect().right;o(f>=Ur)}d();let m=setInterval(d,1e3);return()=>{clearInterval(m)}},[n,t]),M.useEffect(()=>{let h=s||document.activeElement===e.current;if(t==="none"||!h)return;let d=setTimeout(p,0),m=setTimeout(p,2e3),f=setTimeout(p,5e3),y=setTimeout(()=>{l(!0)},6e3);return()=>{clearTimeout(d),clearTimeout(m),clearTimeout(f),clearTimeout(y)}},[e,s,t,p]),{hasPWMBadge:a,willPushPWMBadge:u,PWM_BADGE_SPACE_WIDTH:Jp}}var Wr=M.createContext({}),zr=M.forwardRef((n,e)=>{var t=n,{value:s,onChange:a,maxLength:i,textAlign:r="left",pattern:o,placeholder:c,inputMode:l="numeric",onComplete:u,pushPasswordManagerStrategy:p="increase-width",pasteTransformer:h,containerClassName:d,noScriptCSSFallback:m=Yp,render:f,children:y}=t,g=Vp(t,["value","onChange","maxLength","textAlign","pattern","placeholder","inputMode","onComplete","pushPasswordManagerStrategy","pasteTransformer","containerClassName","noScriptCSSFallback","render","children"]),v,O,A,T,C;let[W,D]=M.useState(typeof g.defaultValue=="string"?g.defaultValue:""),B=s??W,$=Qp(B),re=M.useCallback(q=>{a==null||a(q),D(q)},[a]),fe=M.useMemo(()=>o?typeof o=="string"?new RegExp(o):o:null,[o]),J=M.useRef(null),Xe=M.useRef(null),De=M.useRef({value:B,onChange:re,isIOS:typeof window<"u"&&((O=(v=window==null?void 0:window.CSS)==null?void 0:v.supports)==null?void 0:O.call(v,"-webkit-touch-callout","none"))}),Ve=M.useRef({prev:[(A=J.current)==null?void 0:A.selectionStart,(T=J.current)==null?void 0:T.selectionEnd,(C=J.current)==null?void 0:C.selectionDirection]});M.useImperativeHandle(e,()=>J.current,[]),M.useEffect(()=>{let q=J.current,U=Xe.current;if(!q||!U)return;De.current.value!==q.value&&De.current.onChange(q.value),Ve.current.prev=[q.selectionStart,q.selectionEnd,q.selectionDirection];function ge(){if(document.activeElement!==q){Tt(null),Qe(null);return}let ce=q.selectionStart,Me=q.selectionEnd,be=q.selectionDirection,de=q.maxLength,st=q.value,et=Ve.current.prev,It=-1,jt=-1,at;if(st.length!==0&&ce!==null&&Me!==null){let ns=ce===Me,b=ce===st.length&&st.length<de;if(ns&&!b){let x=ce;if(x===0)It=0,jt=1,at="forward";else if(x===de)It=x-1,jt=x,at="backward";else if(de>1&&st.length>1){let _=0;if(et[0]!==null&&et[1]!==null){at=x<et[1]?"backward":"forward";let P=et[0]===et[1]&&et[0]<de;at==="backward"&&!P&&(_=-1)}It=_+x,jt=_+x+1}}It!==-1&&jt!==-1&&It!==jt&&J.current.setSelectionRange(It,jt,at)}let ta=It!==-1?It:ce,na=jt!==-1?jt:Me,Hi=at??be;Tt(ta),Qe(na),Ve.current.prev=[ta,na,Hi]}if(document.addEventListener("selectionchange",ge,{capture:!0}),ge(),document.activeElement===q&&Zt(!0),!document.getElementById("input-otp-style")){let ce=document.createElement("style");if(ce.id="input-otp-style",document.head.appendChild(ce),ce.sheet){let Me="background: transparent !important; color: transparent !important; border-color: transparent !important; opacity: 0 !important; box-shadow: none !important; -webkit-box-shadow: none !important; -webkit-text-fill-color: transparent !important;";Nn(ce.sheet,"[data-input-otp]::selection { background: transparent !important; color: transparent !important; }"),Nn(ce.sheet,`[data-input-otp]:autofill { ${Me} }`),Nn(ce.sheet,`[data-input-otp]:-webkit-autofill { ${Me} }`),Nn(ce.sheet,"@supports (-webkit-touch-callout: none) { [data-input-otp] { letter-spacing: -.6em !important; font-weight: 100 !important; font-stretch: ultra-condensed; font-optical-sizing: none !important; left: -1px !important; right: 1px !important; } }"),Nn(ce.sheet,"[data-input-otp] + * { pointer-events: all !important; }")}}let Re=()=>{U&&U.style.setProperty("--root-height",`${q.clientHeight}px`)};Re();let Se=new ResizeObserver(Re);return Se.observe(q),()=>{document.removeEventListener("selectionchange",ge,{capture:!0}),Se.disconnect()}},[]);let[pe,vt]=M.useState(!1),[Ke,Zt]=M.useState(!1),[Ye,Tt]=M.useState(null),[L,Qe]=M.useState(null);M.useEffect(()=>{Kp(()=>{var q,U,ge,Re;(q=J.current)==null||q.dispatchEvent(new Event("input"));let Se=(U=J.current)==null?void 0:U.selectionStart,ce=(ge=J.current)==null?void 0:ge.selectionEnd,Me=(Re=J.current)==null?void 0:Re.selectionDirection;Se!==null&&ce!==null&&(Tt(Se),Qe(ce),Ve.current.prev=[Se,ce,Me])})},[B,Ke]),M.useEffect(()=>{$!==void 0&&B!==$&&$.length<i&&B.length===i&&(u==null||u(B))},[i,u,$,B]);let Nt=Xp({containerRef:Xe,inputRef:J,pushPasswordManagerStrategy:p,isFocused:Ke}),he=M.useCallback(q=>{let U=q.currentTarget.value.slice(0,i);if(U.length>0&&fe&&!fe.test(U)){q.preventDefault();return}typeof $=="string"&&U.length<$.length&&document.dispatchEvent(new Event("selectionchange")),re(U)},[i,re,$,fe]),nn=M.useCallback(()=>{var q;if(J.current){let U=Math.min(J.current.value.length,i-1),ge=J.current.value.length;(q=J.current)==null||q.setSelectionRange(U,ge),Tt(U),Qe(ge)}Zt(!0)},[i]),Be=M.useCallback(q=>{var U,ge;let Re=J.current;if(!h&&(!De.current.isIOS||!q.clipboardData||!Re))return;let Se=q.clipboardData.getData("text/plain"),ce=h?h(Se):Se;q.preventDefault();let Me=(U=J.current)==null?void 0:U.selectionStart,be=(ge=J.current)==null?void 0:ge.selectionEnd,de=(Me!==be?B.slice(0,Me)+ce+B.slice(be):B.slice(0,Me)+ce+B.slice(Me)).slice(0,i);if(de.length>0&&fe&&!fe.test(de))return;Re.value=de,re(de);let st=Math.min(de.length,i-1),et=de.length;Re.setSelectionRange(st,et),Tt(st),Qe(et)},[i,re,fe,B]),nt=M.useMemo(()=>({position:"relative",cursor:g.disabled?"default":"text",userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"}),[g.disabled]),xt=M.useMemo(()=>({position:"absolute",inset:0,width:Nt.willPushPWMBadge?`calc(100% + ${Nt.PWM_BADGE_SPACE_WIDTH})`:"100%",clipPath:Nt.willPushPWMBadge?`inset(0 ${Nt.PWM_BADGE_SPACE_WIDTH} 0 0)`:void 0,height:"100%",display:"flex",textAlign:r,opacity:"1",color:"transparent",pointerEvents:"all",background:"transparent",caretColor:"transparent",border:"0 solid transparent",outline:"0 solid transparent",boxShadow:"none",lineHeight:"1",letterSpacing:"-.5em",fontSize:"var(--root-height)",fontFamily:"monospace",fontVariantNumeric:"tabular-nums"}),[Nt.PWM_BADGE_SPACE_WIDTH,Nt.willPushPWMBadge,r]),He=M.useMemo(()=>M.createElement("input",Zp(zp({autoComplete:g.autoComplete||"one-time-code"},g),{"data-input-otp":!0,"data-input-otp-placeholder-shown":B.length===0||void 0,"data-input-otp-mss":Ye,"data-input-otp-mse":L,inputMode:l,pattern:fe==null?void 0:fe.source,"aria-placeholder":c,style:xt,maxLength:i,value:B,ref:J,onPaste:q=>{var U;Be(q),(U=g.onPaste)==null||U.call(g,q)},onChange:he,onMouseOver:q=>{var U;vt(!0),(U=g.onMouseOver)==null||U.call(g,q)},onMouseLeave:q=>{var U;vt(!1),(U=g.onMouseLeave)==null||U.call(g,q)},onFocus:q=>{var U;nn(),(U=g.onFocus)==null||U.call(g,q)},onBlur:q=>{var U;Zt(!1),(U=g.onBlur)==null||U.call(g,q)}})),[he,nn,Be,l,xt,i,L,Ye,g,fe==null?void 0:fe.source,B]),Vt=M.useMemo(()=>({slots:Array.from({length:i}).map((q,U)=>{var ge;let Re=Ke&&Ye!==null&&L!==null&&(Ye===L&&U===Ye||U>=Ye&&U<L),Se=B[U]!==void 0?B[U]:null,ce=B[0]!==void 0?null:(ge=c==null?void 0:c[U])!=null?ge:null;return{char:Se,placeholderChar:ce,isActive:Re,hasFakeCaret:Re&&Se===null}}),isFocused:Ke,isHovering:!g.disabled&&pe}),[Ke,pe,i,L,Ye,g.disabled,B]),Kt=M.useMemo(()=>f?f(Vt):M.createElement(Wr.Provider,{value:Vt},y),[y,Vt,f]);return M.createElement(M.Fragment,null,m!==null&&M.createElement("noscript",null,M.createElement("style",null,m)),M.createElement("div",{ref:Xe,"data-input-otp-container":!0,style:nt,className:d},Kt,M.createElement("div",{style:{position:"absolute",inset:0,pointerEvents:"none"}},He)))});zr.displayName="Input";function Nn(n,e){try{n.insertRule(e)}catch{console.error("input-otp could not insert CSS rule:",e)}}var Yp=`
[data-input-otp] {
  --nojs-bg: white !important;
  --nojs-fg: black !important;

  background-color: var(--nojs-bg) !important;
  color: var(--nojs-fg) !important;
  caret-color: var(--nojs-fg) !important;
  letter-spacing: .25em !important;
  text-align: center !important;
  border: 1px solid var(--nojs-fg) !important;
  border-radius: 4px !important;
  width: 100% !important;
}
@media (prefers-color-scheme: dark) {
  [data-input-otp] {
    --nojs-bg: black !important;
    --nojs-fg: white !important;
  }
}`;pa=M.forwardRef(({className:n,containerClassName:e,...t},s)=>z.jsx(zr,{ref:s,containerClassName:Pe("flex items-center gap-2 has-[:disabled]:opacity-50",e),className:Pe("disabled:cursor-not-allowed",n),...t})),pa.displayName="InputOTP",is=M.forwardRef(({className:n,...e},t)=>z.jsx("div",{ref:t,className:Pe("flex items-center",n),...e})),is.displayName="InputOTPGroup",Bt=M.forwardRef(({index:n,className:e,hidden:t,...s},a)=>{const i=M.useContext(Wr),{char:r,hasFakeCaret:o,isActive:c}=i.slots[n];return z.jsxs("div",{ref:a,className:Pe("relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",c&&"z-10 ring-2 ring-ring ring-offset-background",e),...s,children:[t&&r?z.jsx(qu,{}):r,o&&z.jsx("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-center",children:z.jsx("div",{className:"h-4 w-px animate-caret-blink bg-foreground duration-1000"})})]})}),Bt.displayName="InputOTPSlot",ha=M.forwardRef(({...n},e)=>z.jsx("div",{ref:e,role:"separator",...n,children:z.jsx(qu,{})})),ha.displayName="InputOTPSeparator";let cn,Ra,Zr,ps,hs,$a,Vr,Kr;tr=Qg(({onConfirm:n,onCancel:e})=>{const t=ku(),{t:s}=Tu("dialogs"),[a,i]=M.useState(""),r=l=>{i(l)},o=async()=>{(a==null?void 0:a.length)===6&&(await(n==null?void 0:n(a)),i(""),t.resolve(!0),t.hide())},c=async()=>{await(e==null?void 0:e()),i(""),t.resolve(!1),t.hide()};return z.jsx(Hg,{open:t.visible,onOpenChange:c,children:z.jsxs(Jg,{className:"w-[330px]",children:[z.jsxs(Gg,{children:[z.jsx(Xg,{children:s("session_passkey.title")}),z.jsx(Yg,{children:s("session_passkey.description")})]}),z.jsx("div",{className:"py-4",children:z.jsxs(pa,{onChange:r,maxLength:6,children:[z.jsxs(is,{children:[z.jsx(Bt,{index:0,hidden:!0}),z.jsx(Bt,{index:1,hidden:!0}),z.jsx(Bt,{index:2,hidden:!0})]}),z.jsx(ha,{}),z.jsxs(is,{children:[z.jsx(Bt,{index:3,hidden:!0}),z.jsx(Bt,{index:4,hidden:!0}),z.jsx(Bt,{index:5,hidden:!0})]})]})}),z.jsx(e0,{children:z.jsx(t0,{disabled:(a==null?void 0:a.length)!==6,onClick:o,type:"submit",children:s("session_passkey.confirm")})})]})})}),cn=n=>{const e=n.match(/.{1,2}/g);if(!e)throw new Error("Invalid hexString");return Uint8Array.from(e.map(t=>parseInt(t,16))).buffer},Ra=n=>new TextEncoder().encode(n).buffer,Zr=async n=>{const e=Ra(n);return await crypto.subtle.digest("SHA-256",e)},ps=n=>[...new Uint8Array(n)].map(e=>e.toString(16).padStart(2,"0")).join(""),zu=async()=>{const n=crypto.getRandomValues(new Uint8Array(32));return ps(n)},hs=async n=>{const e=await Zr(n);return ps(e)},$a=async n=>(await hs(n)).substring(0,32),ar=async(n,e)=>{const t=await hs(e),s=await $a(e),a=Ra(n),i=await Vr(a,t,s);return ps(i)},rs=async(n,e)=>{const t=await hs(e),s=await $a(e),a=cn(n),i=await Kr(a,t,s);return new TextDecoder().decode(i)},Vr=async(n,e,t)=>{const s=cn(t),a=cn(e),i=await crypto.subtle.importKey("raw",a,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.encrypt({name:"AES-CBC",iv:s},i,n)},Kr=async(n,e,t)=>{const s=cn(t),a=cn(e),i=await crypto.subtle.importKey("raw",a,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.decrypt({name:"AES-CBC",iv:s},i,n)},Zu=async(n,e)=>{const t={};return await Promise.all(Object.entries(n||{}).map(async([s,a])=>{const i=await ar(a,e);t[s]=i})),t},Ku=async(n,e)=>{let t;if(await new Promise((s,a)=>{e.show({onConfirm:async i=>{try{t=await rs(n,i),await aa.set("passphrase",t),s(!0)}catch(r){a(r)}finally{e.hide()}},onCancel:()=>{a()}})}),!t)throw new Error("Passphrase is required");return t},nr=n=>{const e=ku(n),t=M.useRef(e);return t.current=e,{modal:e,modalRef:t}};class Qr extends n0{}rr=class extends Qr{static lc_name(){return"StringPromptValue"}constructor(n){super({value:n}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=n}toString(){return this.value}toChatMessages(){return[new Nu(this.value)]}};class eh extends Qr{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return s0(this.messages)}toChatMessages(){return this.messages}}const La="RFC3986",Ba={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},th="RFC1738",nh=Array.isArray,Et=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),Fa=1024,sh=(n,e,t,s,a)=>{if(n.length===0)return n;let i=n;if(typeof n=="symbol"?i=Symbol.prototype.toString.call(n):typeof n!="string"&&(i=String(n)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let r="";for(let o=0;o<i.length;o+=Fa){const c=i.length>=Fa?i.slice(o,o+Fa):i,l=[];for(let u=0;u<c.length;++u){let p=c.charCodeAt(u);if(p===45||p===46||p===95||p===126||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||a===th&&(p===40||p===41)){l[l.length]=c.charAt(u);continue}if(p<128){l[l.length]=Et[p];continue}if(p<2048){l[l.length]=Et[192|p>>6]+Et[128|p&63];continue}if(p<55296||p>=57344){l[l.length]=Et[224|p>>12]+Et[128|p>>6&63]+Et[128|p&63];continue}u+=1,p=65536+((p&1023)<<10|c.charCodeAt(u)&1023),l[l.length]=Et[240|p>>18]+Et[128|p>>12&63]+Et[128|p>>6&63]+Et[128|p&63]}r+=l.join("")}return r};function ah(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function Hr(n,e){if(nh(n)){const t=[];for(let s=0;s<n.length;s+=1)t.push(e(n[s]));return t}return e(n)}const ih=Object.prototype.hasOwnProperty,Jr={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Ct=Array.isArray,rh=Array.prototype.push,Gr=function(n,e){rh.apply(n,Ct(e)?e:[e])},oh=Date.prototype.toISOString,_e={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:sh,encodeValuesOnly:!1,format:La,formatter:Ba[La],indices:!1,serializeDate(n){return oh.call(n)},skipNulls:!1,strictNullHandling:!1};function ch(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const qa={};function Xr(n,e,t,s,a,i,r,o,c,l,u,p,h,d,m,f,y,g){let v=n,O=g,A=0,T=!1;for(;(O=O.get(qa))!==void 0&&!T;){const $=O.get(n);if(A+=1,typeof $<"u"){if($===A)throw new RangeError("Cyclic object value");T=!0}typeof O.get(qa)>"u"&&(A=0)}if(typeof l=="function"?v=l(e,v):v instanceof Date?v=h==null?void 0:h(v):t==="comma"&&Ct(v)&&(v=Hr(v,function($){return $ instanceof Date?h==null?void 0:h($):$})),v===null){if(i)return c&&!f?c(e,_e.encoder,y,"key",d):e;v=""}if(ch(v)||ah(v)){if(c){const $=f?e:c(e,_e.encoder,y,"key",d);return[(m==null?void 0:m($))+"="+(m==null?void 0:m(c(v,_e.encoder,y,"value",d)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(v)))]}const C=[];if(typeof v>"u")return C;let W;if(t==="comma"&&Ct(v))f&&c&&(v=Hr(v,c)),W=[{value:v.length>0?v.join(",")||null:void 0}];else if(Ct(l))W=l;else{const $=Object.keys(v);W=u?$.sort(u):$}const D=o?String(e).replace(/\./g,"%2E"):String(e),B=s&&Ct(v)&&v.length===1?D+"[]":D;if(a&&Ct(v)&&v.length===0)return B+"[]";for(let $=0;$<W.length;++$){const re=W[$],fe=typeof re=="object"&&typeof re.value<"u"?re.value:v[re];if(r&&fe===null)continue;const J=p&&o?re.replace(/\./g,"%2E"):re,Xe=Ct(v)?typeof t=="function"?t(B,J):B:B+(p?"."+J:"["+J+"]");g.set(n,A);const De=new WeakMap;De.set(qa,g),Gr(C,Xr(fe,Xe,t,s,a,i,r,o,t==="comma"&&f&&Ct(v)?null:c,l,u,p,h,d,m,f,y,De))}return C}function lh(n=_e){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||_e.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=La;if(typeof n.format<"u"){if(!ih.call(Ba,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const s=Ba[t];let a=_e.filter;(typeof n.filter=="function"||Ct(n.filter))&&(a=n.filter);let i;if(n.arrayFormat&&n.arrayFormat in Jr?i=n.arrayFormat:"indices"in n?i=n.indices?"indices":"repeat":i=_e.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const r=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:_e.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:_e.addQueryPrefix,allowDots:r,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:_e.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:_e.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?_e.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:_e.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:_e.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:_e.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:_e.encodeValuesOnly,filter:a,format:t,formatter:s,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:_e.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:_e.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:_e.strictNullHandling}}function uh(n,e={}){let t=n;const s=lh(e);let a,i;typeof s.filter=="function"?(i=s.filter,t=i("",t)):Ct(s.filter)&&(i=s.filter,a=i);const r=[];if(typeof t!="object"||t===null)return"";const o=Jr[s.arrayFormat],c=o==="comma"&&s.commaRoundTrip;a||(a=Object.keys(t)),s.sort&&a.sort(s.sort);const l=new WeakMap;for(let h=0;h<a.length;++h){const d=a[h];s.skipNulls&&t[d]===null||Gr(r,Xr(t[d],d,o,c,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,l))}const u=r.join(s.delimiter);let p=s.addQueryPrefix===!0?"?":"";return s.charsetSentinel&&(s.charset==="iso-8859-1"?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),u.length>0?p+u:""}const ln="4.78.1";let Yr=!1,In,eo,to,Da,no,so,ao,io,ro;function ph(n,e={auto:!1}){if(Yr)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(In)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${In}'\``);Yr=e.auto,In=n.kind,eo=n.fetch,to=n.FormData,Da=n.File,no=n.ReadableStream,so=n.getMultipartRequestOptions,ao=n.getDefaultAgent,io=n.fileFromPath,ro=n.isFsReadStream}let hh=class{constructor(n){this.body=n}get[Symbol.toStringTag](){return"MultipartBody"}};function dh({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,s,a,i;try{t=fetch,s=Request,a=Response,i=Headers}catch(r){throw new Error(`this environment is missing the following Web Fetch API type: ${r.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:a,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(r,o)=>({...o,body:new hh(r)}),getDefaultAgent:r=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:r=>!1}}In||ph(dh(),{auto:!0});class K extends Error{}let Ue=class cr extends K{constructor(e,t,s,a){super(`${cr.makeMessage(e,t,s)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["x-request-id"],this.error=t;const i=t;this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,t,s){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,s,a){if(!e||!a)return new ds({message:s,cause:Za(t)});const i=t==null?void 0:t.error;return e===400?new oo(e,i,s,a):e===401?new co(e,i,s,a):e===403?new lo(e,i,s,a):e===404?new uo(e,i,s,a):e===409?new po(e,i,s,a):e===422?new ho(e,i,s,a):e===429?new mo(e,i,s,a):e>=500?new fo(e,i,s,a):new cr(e,i,s,a)}},tt=class extends Ue{constructor({message:n}={}){super(void 0,void 0,n||"Request was aborted.",void 0)}},ds=class extends Ue{constructor({message:n,cause:e}){super(void 0,void 0,n||"Connection error.",void 0),e&&(this.cause=e)}},ms=class extends ds{constructor({message:n}={}){super({message:n??"Request timed out."})}},oo=class extends Ue{},co=class extends Ue{},lo=class extends Ue{},uo=class extends Ue{},po=class extends Ue{},ho=class extends Ue{},mo=class extends Ue{},fo=class extends Ue{};class yo extends K{constructor(){super("Could not parse response content as the length limit was reached")}}class go extends K{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}let fs=class lr{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const s=lr.NEWLINE_CHARS.has(t[t.length-1]||"");let a=t.split(lr.NEWLINE_REGEXP);return s&&a.pop(),a.length===1&&!s?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),s||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Fe<"u"){if(e instanceof Fe)return e.toString();if(e instanceof Uint8Array)return Fe.from(e).toString();throw new K(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new K(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new K("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};fs.NEWLINE_CHARS=new Set([`
`,"\r"]),fs.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let jn=class os{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*a(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(const r of mh(e,t))if(!i){if(r.data.startsWith("[DONE]")){i=!0;continue}if(r.event===null){let o;try{o=JSON.parse(r.data)}catch(c){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),c}if(o&&o.error)throw new Ue(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(r.data)}catch(c){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),c}if(r.event=="error")throw new Ue(void 0,o.error,o.message,void 0);yield{event:r.event,data:o}}}i=!0}catch(r){if(r instanceof Error&&r.name==="AbortError")return;throw r}finally{i||t.abort()}}return new os(a,t)}static fromReadableStream(e,t){let s=!1;async function*a(){const r=new fs,o=bo(e);for await(const c of o)for(const l of r.decode(c))yield l;for(const c of r.flush())yield c}async function*i(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let r=!1;try{for await(const o of a())r||o&&(yield JSON.parse(o));r=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{r||t.abort()}}return new os(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),a=i=>({next:()=>{if(i.length===0){const r=s.next();e.push(r),t.push(r)}return i.shift()}});return[new os(()=>a(e),this.controller),new os(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const s=new TextEncoder;return new no({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:i,done:r}=await t.next();if(r)return a.close();const o=s.encode(JSON.stringify(i)+`
`);a.enqueue(o)}catch(i){a.error(i)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}};async function*mh(n,e){if(!n.body)throw e.abort(),new K("Attempted to iterate over a response with no body");const t=new gh,s=new fs,a=bo(n.body);for await(const i of fh(a))for(const r of s.decode(i)){const o=t.decode(r);o&&(yield o)}for(const i of s.flush()){const r=t.decode(i);r&&(yield r)}}async function*fh(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let a=new Uint8Array(e.length+s.length);a.set(e),a.set(s,e.length),e=a;let i;for(;(i=yh(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}function yh(n){for(let e=0;e<n.length-2;e++){if(n[e]===10&&n[e+1]===10||n[e]===13&&n[e+1]===13)return e+2;if(n[e]===13&&n[e+1]===10&&e+3<n.length&&n[e+2]===13&&n[e+3]===10)return e+4}return-1}let gh=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(n){if(n.endsWith("\r")&&(n=n.substring(0,n.length-1)),!n){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(n),n.startsWith(":"))return null;let[e,t,s]=bh(n,":");return s.startsWith(" ")&&(s=s.substring(1)),e==="event"?this.event=s:e==="data"&&this.data.push(s),null}};function bh(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function bo(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const wo=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",vo=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&ys(n),ys=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",wh=n=>vo(n)||wo(n)||ro(n);async function xo(n,e,t){var a;if(n=await n,vo(n))return n;if(wo(n)){const i=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const r=ys(i)?[await i.arrayBuffer()]:[i];return new Da(r,e,t)}const s=await vh(n);if(e||(e=_h(n)??"unknown_file"),!(t!=null&&t.type)){const i=(a=s[0])==null?void 0:a.type;typeof i=="string"&&(t={...t,type:i})}return new Da(s,e,t)}async function vh(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(ys(n))e.push(await n.arrayBuffer());else if(Oh(n))for await(const s of n)e.push(s);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${xh(n)}`);return e}function xh(n){return`[${Object.getOwnPropertyNames(n).map(e=>`"${e}"`).join(", ")}]`}function _h(n){var e;return Ua(n.name)||Ua(n.filename)||((e=Ua(n.path))==null?void 0:e.split(/[\\/]/).pop())}const Ua=n=>{if(typeof n=="string")return n;if(typeof Fe<"u"&&n instanceof Fe)return String(n)},Oh=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",_o=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",un=async n=>{const e=await Mh(n.body);return so(e,n)},Mh=async n=>{const e=new to;return await Promise.all(Object.entries(n||{}).map(([t,s])=>Wa(e,t,s))),e},Wa=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(wh(t)){const s=await xo(t);n.append(e,s)}else if(Array.isArray(t))await Promise.all(t.map(s=>Wa(n,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,a])=>Wa(n,`${e}[${s}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var pn={},Ah=function(n,e,t,s,a){if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t},Ph=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},gs;async function Oo(n){const{response:e}=n;if(n.options.stream)return hn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):jn.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if(t!=null&&t.includes("application/json")||t!=null&&t.includes("application/vnd.api+json")){const a=await e.json();return hn("response",e.status,e.url,e.headers,a),Mo(a,e)}const s=await e.text();return hn("response",e.status,e.url,e.headers,s),s}function Mo(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}let Ao=class Hu extends Promise{constructor(e,t=Oo){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Hu(this.responsePromise,async t=>Mo(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Eh=class{constructor({baseURL:n,maxRetries:e=2,timeout:t=6e5,httpAgent:s,fetch:a}){this.baseURL=n,this.maxRetries=za("maxRetries",e),this.timeout=za("timeout",t),this.httpAgent=s,this.fetch=a??eo}authHeaders(n){return{}}defaultHeaders(n){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ih(),...this.authHeaders(n)}}validateHeaders(n,e){}defaultIdempotencyKey(){return`stainless-node-retry-${Lh()}`}get(n,e){return this.methodRequest("get",n,e)}post(n,e){return this.methodRequest("post",n,e)}patch(n,e){return this.methodRequest("patch",n,e)}put(n,e){return this.methodRequest("put",n,e)}delete(n,e){return this.methodRequest("delete",n,e)}methodRequest(n,e,t){return this.request(Promise.resolve(t).then(async s=>{const a=s&&ys(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:n,path:e,...s,body:a}}))}getAPIList(n,e,t){return this.requestAPIList(e,{method:"get",path:n,...t})}calculateContentLength(n){if(typeof n=="string"){if(typeof Fe<"u")return Fe.byteLength(n,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(n).length.toString()}else if(ArrayBuffer.isView(n))return n.byteLength.toString();return null}buildRequest(n,{retryCount:e=0}={}){var d;const{method:t,path:s,query:a,headers:i={}}=n,r=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:_o(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,o=this.calculateContentLength(r),c=this.buildURL(s,a);"timeout"in n&&za("timeout",n.timeout);const l=n.timeout??this.timeout,u=n.httpAgent??this.httpAgent??ao(c),p=l+1e3;typeof((d=u==null?void 0:u.options)==null?void 0:d.timeout)=="number"&&p>(u.options.timeout??0)&&(u.options.timeout=p),this.idempotencyHeader&&t!=="get"&&(n.idempotencyKey||(n.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=n.idempotencyKey);const h=this.buildHeaders({options:n,headers:i,contentLength:o,retryCount:e});return{req:{method:t,...r&&{body:r},headers:h,...u&&{agent:u},signal:n.signal??null},url:c,timeout:l}}buildHeaders({options:n,headers:e,contentLength:t,retryCount:s}){const a={};t&&(a["content-length"]=t);const i=this.defaultHeaders(n);return No(a,i),No(a,e),_o(n.body)&&In!=="node"&&delete a["content-type"],Io(i,"x-stainless-retry-count")===void 0&&Io(e,"x-stainless-retry-count")===void 0&&(a["x-stainless-retry-count"]=String(s)),this.validateHeaders(a,e),a}async prepareOptions(n){}async prepareRequest(n,{url:e,options:t}){}parseHeaders(n){return n?Symbol.iterator in n?Object.fromEntries(Array.from(n).map(e=>[...e])):{...n}:{}}makeStatusError(n,e,t,s){return Ue.generate(n,e,t,s)}request(n,e=null){return new Ao(this.makeRequest(n,e))}async makeRequest(n,e){var u,p;const t=await n,s=t.maxRetries??this.maxRetries;e==null&&(e=s),await this.prepareOptions(t);const{req:a,url:i,timeout:r}=this.buildRequest(t,{retryCount:s-e});if(await this.prepareRequest(a,{url:i,options:t}),hn("request",i,t,a.headers),(u=t.signal)==null?void 0:u.aborted)throw new tt;const o=new AbortController,c=await this.fetchWithTimeout(i,a,r,o).catch(Za);if(c instanceof Error){if((p=t.signal)!=null&&p.aborted)throw new tt;if(e)return this.retryRequest(t,e);throw c.name==="AbortError"?new ms:new ds({cause:c})}const l=Sh(c.headers);if(!c.ok){if(e&&this.shouldRetry(c)){const f=`retrying, ${e} attempts remaining`;return hn(`response (error; ${f})`,c.status,i,l),this.retryRequest(t,e,l)}const h=await c.text().catch(f=>Za(f).message),d=jh(h),m=d?void 0:h;throw hn(`response (error; ${e?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,m),this.makeStatusError(c.status,d,m,l)}return{response:c,options:t,controller:o}}requestAPIList(n,e){const t=this.makeRequest(e,null);return new Ch(this,t,n)}buildURL(n,e){const t=$h(n)?new URL(n):new URL(this.baseURL+(this.baseURL.endsWith("/")&&n.startsWith("/")?n.slice(1):n)),s=this.defaultQuery();return ko(s)||(e={...s,...e}),typeof e=="object"&&e&&!Array.isArray(e)&&(t.search=this.stringifyQuery(e)),t.toString()}stringifyQuery(n){return Object.entries(n).filter(([e,t])=>typeof t<"u").map(([e,t])=>{if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(t===null)return`${encodeURIComponent(e)}=`;throw new K(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(n,e,t,s){const{signal:a,...i}=e||{};a&&a.addEventListener("abort",()=>s.abort());const r=setTimeout(()=>s.abort(),t),o={signal:s.signal,...i};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,n,o).finally(()=>{clearTimeout(r)})}shouldRetry(n){const e=n.headers.get("x-should-retry");return e==="true"?!0:e==="false"?!1:n.status===408||n.status===409||n.status===429||n.status>=500}async retryRequest(n,e,t){let s;const a=t==null?void 0:t["retry-after-ms"];if(a){const r=parseFloat(a);Number.isNaN(r)||(s=r)}const i=t==null?void 0:t["retry-after"];if(i&&!s){const r=parseFloat(i);Number.isNaN(r)?s=Date.parse(i)-Date.now():s=r*1e3}if(!(s&&0<=s&&s<60*1e3)){const r=n.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(e,r)}return await Rn(s),this.makeRequest(n,e-1)}calculateDefaultRetryTimeoutMillis(n,e){const t=e-n,s=Math.min(.5*Math.pow(2,t),8),a=1-Math.random()*.25;return s*a*1e3}getUserAgent(){return`${this.constructor.name}/JS ${ln}`}};class Po{constructor(e,t,s,a){gs.set(this,void 0),Ah(this,gs,e),this.options=a,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new K("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const s=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[a,i]of s)e.url.searchParams.set(a,i);t.query=void 0,t.path=e.url.toString()}return await Ph(this,gs,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(gs=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}let Ch=class extends Ao{constructor(n,e,t){super(e,async s=>new t(n,s.response,await Oo(s),s.options))}async*[Symbol.asyncIterator](){const n=await this;for await(const e of n)yield e}};const Sh=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const s=t.toString();return e[s.toLowerCase()]||e[s]}}),kh={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},We=n=>typeof n=="object"&&n!==null&&!ko(n)&&Object.keys(n).every(e=>To(kh,e)),Th=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":Co(Deno.build.os),"X-Stainless-Arch":Eo(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":Te.version};if(Object.prototype.toString.call(typeof Te<"u"?Te:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":Co(Te.platform),"X-Stainless-Arch":Eo(Te.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":Te.version};const n=Nh();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ln,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Nh(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const s=t.exec(navigator.userAgent);if(s){const a=s[1]||0,i=s[2]||0,r=s[3]||0;return{browser:e,version:`${a}.${i}.${r}`}}}return null}const Eo=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Co=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let So;const Ih=()=>So??(So=Th()),jh=n=>{try{return JSON.parse(n)}catch{return}},Rh=/^[a-z][a-z0-9+.-]*:/i,$h=n=>Rh.test(n),Rn=n=>new Promise(e=>setTimeout(e,n)),za=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new K(`${n} must be an integer`);if(e<0)throw new K(`${n} must be a positive integer`);return e},Za=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},bs=n=>{var e,t,s,a;if(typeof Te<"u")return((e=pn==null?void 0:pn[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(s=(t=Deno.env)==null?void 0:t.get)==null?void 0:s.call(t,n))==null?void 0:a.trim()};function ko(n){if(!n)return!0;for(const e in n)return!1;return!0}function To(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function No(n,e){for(const t in e){if(!To(e,t))continue;const s=t.toLowerCase();if(!s)continue;const a=e[t];a===null?delete n[s]:a!==void 0&&(n[s]=a)}}function hn(n,...e){typeof Te<"u"&&(pn==null?void 0:pn.DEBUG)==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}const Lh=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Bh=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Fh=n=>typeof(n==null?void 0:n.get)=="function",Io=(n,e)=>{var s;const t=e.toLowerCase();if(Fh(n)){const a=((s=e[0])==null?void 0:s.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(i,r,o)=>r+o.toUpperCase());for(const i of[e,t,e.toUpperCase(),a]){const r=n.get(i);if(r)return r}}for(const[a,i]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(i)?(i.length<=1||console.warn(`Received ${i.length} entries for the ${e} header, using the first entry.`),i[0]):i};function Va(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}class qh extends Po{constructor(e,t,s,a){super(e,t,s,a),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class it extends Po{constructor(e,t,s,a){super(e,t,s,a),this.data=s.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var s;const e=this.getPaginatedItems();if(!e.length)return null;const t=(s=e[e.length-1])==null?void 0:s.id;return t?{params:{after:t}}:null}}let X=class{constructor(n){this._client=n}},jo=class extends X{create(n,e){return this._client.post("/chat/completions",{body:n,...e,stream:n.stream??!1})}},Ka=class extends X{constructor(){super(...arguments),this.completions=new jo(this._client)}};Ka.Completions=jo;class Ro extends X{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}let $o=class extends X{create(n,e){return this._client.post("/audio/transcriptions",un({body:n,...e}))}},Lo=class extends X{create(n,e){return this._client.post("/audio/translations",un({body:n,...e}))}},$n=class extends X{constructor(){super(...arguments),this.transcriptions=new $o(this._client),this.translations=new Lo(this._client),this.speech=new Ro(this._client)}};$n.Transcriptions=$o,$n.Translations=Lo,$n.Speech=Ro;class Qa extends X{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return We(e)?this.list({},e):this._client.getAPIList("/batches",Ha,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Ha extends it{}Qa.BatchesPage=Ha;class Ja extends X{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,s){return this._client.post(`/assistants/${e}`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e={},t){return We(e)?this.list({},e):this._client.getAPIList("/assistants",Ga,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class Ga extends it{}Ja.AssistantsPage=Ga;function Bo(n){return typeof n.parse=="function"}const dn=n=>(n==null?void 0:n.role)==="assistant",Fo=n=>(n==null?void 0:n.role)==="function",qo=n=>(n==null?void 0:n.role)==="tool";var rt=function(n,e,t,s,a){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},me=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Xa,ws,vs,Ln,Bn,xs,Fn,$t,qn,_s,Os,mn,Do;class Uo{constructor(){Xa.add(this),this.controller=new AbortController,ws.set(this,void 0),vs.set(this,()=>{}),Ln.set(this,()=>{}),Bn.set(this,void 0),xs.set(this,()=>{}),Fn.set(this,()=>{}),$t.set(this,{}),qn.set(this,!1),_s.set(this,!1),Os.set(this,!1),mn.set(this,!1),rt(this,ws,new Promise((e,t)=>{rt(this,vs,e,"f"),rt(this,Ln,t,"f")}),"f"),rt(this,Bn,new Promise((e,t)=>{rt(this,xs,e,"f"),rt(this,Fn,t,"f")}),"f"),me(this,ws,"f").catch(()=>{}),me(this,Bn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},me(this,Xa,"m",Do).bind(this))},0)}_connected(){this.ended||(me(this,vs,"f").call(this),this._emit("connect"))}get ended(){return me(this,qn,"f")}get errored(){return me(this,_s,"f")}get aborted(){return me(this,Os,"f")}abort(){this.controller.abort()}on(e,t){return(me(this,$t,"f")[e]||(me(this,$t,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=me(this,$t,"f")[e];if(!s)return this;const a=s.findIndex(i=>i.listener===t);return a>=0&&s.splice(a,1),this}once(e,t){return(me(this,$t,"f")[e]||(me(this,$t,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{rt(this,mn,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){rt(this,mn,!0,"f"),await me(this,Bn,"f")}_emit(e,...t){if(me(this,qn,"f"))return;e==="end"&&(rt(this,qn,!0,"f"),me(this,xs,"f").call(this));const s=me(this,$t,"f")[e];if(s&&(me(this,$t,"f")[e]=s.filter(a=>!a.once),s.forEach(({listener:a})=>a(...t))),e==="abort"){const a=t[0];!me(this,mn,"f")&&!(s!=null&&s.length)&&Promise.reject(a),me(this,Ln,"f").call(this,a),me(this,Fn,"f").call(this,a),this._emit("end");return}if(e==="error"){const a=t[0];!me(this,mn,"f")&&!(s!=null&&s.length)&&Promise.reject(a),me(this,Ln,"f").call(this,a),me(this,Fn,"f").call(this,a),this._emit("end")}}_emitFinal(){}}ws=new WeakMap,vs=new WeakMap,Ln=new WeakMap,Bn=new WeakMap,xs=new WeakMap,Fn=new WeakMap,$t=new WeakMap,qn=new WeakMap,_s=new WeakMap,Os=new WeakMap,mn=new WeakMap,Xa=new WeakSet,Do=function(n){if(rt(this,_s,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new tt),n instanceof tt)return rt(this,Os,!0,"f"),this._emit("abort",n);if(n instanceof K)return this._emit("error",n);if(n instanceof Error){const e=new K(n.message);return e.cause=n,this._emit("error",e)}return this._emit("error",new K(String(n)))};function Dh(n,e){const t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function Wo(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function Uh(n,{parser:e,callback:t}){const s={...n};return Object.defineProperties(s,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),s}function Dn(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Wh(n,e){return!e||!zo(e)?{...n,choices:n.choices.map(t=>({...t,message:{...t.message,parsed:null,tool_calls:t.message.tool_calls??[]}}))}:Ya(n,e)}function Ya(n,e){const t=n.choices.map(s=>{var a;if(s.finish_reason==="length")throw new yo;if(s.finish_reason==="content_filter")throw new go;return{...s,message:{...s.message,tool_calls:((a=s.message.tool_calls)==null?void 0:a.map(i=>Zh(e,i)))??[],parsed:s.message.content&&!s.message.refusal?zh(e,s.message.content):null}}});return{...n,choices:t}}function zh(n,e){var t,s;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((s=n.response_format)==null?void 0:s.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function Zh(n,e){var s;const t=(s=n.tools)==null?void 0:s.find(a=>{var i;return((i=a.function)==null?void 0:i.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Dn(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function Vh(n,e){var s;if(!n)return!1;const t=(s=n.tools)==null?void 0:s.find(a=>{var i;return((i=a.function)==null?void 0:i.name)===e.function.name});return Dn(t)||(t==null?void 0:t.function.strict)||!1}function zo(n){var e;return Wo(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(t=>Dn(t)||t.type==="function"&&t.function.strict===!0))??!1}function Kh(n){for(const e of n??[]){if(e.type!=="function")throw new K(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new K(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var ze=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},$e,ei,Ms,ti,ni,si,Zo,ai;const Vo=10;class Ko extends Uo{constructor(){super(...arguments),$e.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var s;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(s=e.choices[0])==null?void 0:s.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Fo(e)||qo(e))&&e.content)this._emit("functionCallResult",e.content);else if(dn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(dn(e)&&e.tool_calls)for(const s of e.tool_calls)s.type==="function"&&this._emit("functionCall",s.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new K("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),ze(this,$e,"m",ei).call(this)}async finalMessage(){return await this.done(),ze(this,$e,"m",Ms).call(this)}async finalFunctionCall(){return await this.done(),ze(this,$e,"m",ti).call(this)}async finalFunctionCallResult(){return await this.done(),ze(this,$e,"m",ni).call(this)}async totalUsage(){return await this.done(),ze(this,$e,"m",si).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=ze(this,$e,"m",Ms).call(this);t&&this._emit("finalMessage",t);const s=ze(this,$e,"m",ei).call(this);s&&this._emit("finalContent",s);const a=ze(this,$e,"m",ti).call(this);a&&this._emit("finalFunctionCall",a);const i=ze(this,$e,"m",ni).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(r=>r.usage)&&this._emit("totalUsage",ze(this,$e,"m",si).call(this))}async _createChatCompletion(e,t,s){const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ze(this,$e,"m",Zo).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Ya(i,t))}async _runChatCompletion(e,t,s){for(const a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,s)}async _runFunctions(e,t,s){var h;const a="function",{function_call:i="auto",stream:r,...o}=t,c=typeof i!="string"&&(i==null?void 0:i.name),{maxChatCompletions:l=Vo}=s||{},u={};for(const d of t.functions)u[d.name||d.function.name]=d;const p=t.functions.map(d=>({name:d.name||d.function.name,parameters:d.parameters,description:d.description}));for(const d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){const m=(h=(await this._createChatCompletion(e,{...o,function_call:i,functions:p,messages:[...this.messages]},s)).choices[0])==null?void 0:h.message;if(!m)throw new K("missing message in ChatCompletion response");if(!m.function_call)return;const{name:f,arguments:y}=m.function_call,g=u[f];if(g){if(c&&c!==f){const T=`Invalid function_call: ${JSON.stringify(f)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:a,name:f,content:T});continue}}else{const T=`Invalid function_call: ${JSON.stringify(f)}. Available options are: ${p.map(C=>JSON.stringify(C.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:f,content:T});continue}let v;try{v=Bo(g)?await g.parse(y):y}catch(T){this._addMessage({role:a,name:f,content:T instanceof Error?T.message:String(T)});continue}const O=await g.function(v,this),A=ze(this,$e,"m",ai).call(this,O);if(this._addMessage({role:a,name:f,content:A}),c)return}}async _runTools(e,t,s){var d,m,f;const a="tool",{tool_choice:i="auto",stream:r,...o}=t,c=typeof i!="string"&&((d=i==null?void 0:i.function)==null?void 0:d.name),{maxChatCompletions:l=Vo}=s||{},u=t.tools.map(y=>{if(Dn(y)){if(!y.$callback)throw new K("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:y.$callback,name:y.function.name,description:y.function.description||"",parameters:y.function.parameters,parse:y.$parseRaw,strict:!0}}}return y}),p={};for(const y of u)y.type==="function"&&(p[y.function.name||y.function.function.name]=y.function);const h="tools"in t?u.map(y=>y.type==="function"?{type:"function",function:{name:y.function.name||y.function.function.name,parameters:y.function.parameters,description:y.function.description,strict:y.function.strict}}:y):void 0;for(const y of t.messages)this._addMessage(y,!1);for(let y=0;y<l;++y){const g=(m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},s)).choices[0])==null?void 0:m.message;if(!g)throw new K("missing message in ChatCompletion response");if(!((f=g.tool_calls)!=null&&f.length))return;for(const v of g.tool_calls){if(v.type!=="function")continue;const O=v.id,{name:A,arguments:T}=v.function,C=p[A];if(C){if(c&&c!==A){const $=`Invalid tool_call: ${JSON.stringify(A)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:a,tool_call_id:O,content:$});continue}}else{const $=`Invalid tool_call: ${JSON.stringify(A)}. Available options are: ${Object.keys(p).map(re=>JSON.stringify(re)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:O,content:$});continue}let W;try{W=Bo(C)?await C.parse(T):T}catch($){const re=$ instanceof Error?$.message:String($);this._addMessage({role:a,tool_call_id:O,content:re});continue}const D=await C.function(W,this),B=ze(this,$e,"m",ai).call(this,D);if(this._addMessage({role:a,tool_call_id:O,content:B}),c)return}}}}$e=new WeakSet,ei=function(){return ze(this,$e,"m",Ms).call(this).content??null},Ms=function(){let n=this.messages.length;for(;n-- >0;){const e=this.messages[n];if(dn(e)){const{function_call:t,...s}=e,a={...s,content:e.content??null,refusal:e.refusal??null};return t&&(a.function_call=t),a}}throw new K("stream ended without producing a ChatCompletionMessage with role=assistant")},ti=function(){var n,e;for(let t=this.messages.length-1;t>=0;t--){const s=this.messages[t];if(dn(s)&&(s!=null&&s.function_call))return s.function_call;if(dn(s)&&((n=s==null?void 0:s.tool_calls)!=null&&n.length))return(e=s.tool_calls.at(-1))==null?void 0:e.function}},ni=function(){for(let n=this.messages.length-1;n>=0;n--){const e=this.messages[n];if(Fo(e)&&e.content!=null||qo(e)&&e.content!=null&&typeof e.content=="string"&&this.messages.some(t=>{var s;return t.role==="assistant"&&((s=t.tool_calls)==null?void 0:s.some(a=>a.type==="function"&&a.id===e.tool_call_id))}))return e.content}},si=function(){const n={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:e}of this._chatCompletions)e&&(n.completion_tokens+=e.completion_tokens,n.prompt_tokens+=e.prompt_tokens,n.total_tokens+=e.total_tokens);return n},Zo=function(n){if(n.n!=null&&n.n>1)throw new K("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ai=function(n){return typeof n=="string"?n:n===void 0?"undefined":JSON.stringify(n)};class Un extends Ko{static runFunctions(e,t,s){const a=new Un,i={...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,i)),a}static runTools(e,t,s){const a=new Un,i={...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,i)),a}_addMessage(e,t=!0){super._addMessage(e,t),dn(e)&&e.content&&this._emit("content",e.content)}}const Qo=1,Ho=2,Jo=4,Go=8,Xo=16,Yo=32,ec=64,tc=128,nc=256,sc=tc|nc,ac=Xo|Yo|sc|ec,ic=Qo|Ho|ac,rc=Jo|Go,Qh=ic|rc,Ee={STR:Qo,NUM:Ho,ARR:Jo,OBJ:Go,NULL:Xo,BOOL:Yo,NAN:ec,INFINITY:tc,MINUS_INFINITY:nc,INF:sc,SPECIAL:ac,ATOM:ic,COLLECTION:rc,ALL:Qh};class Hh extends Error{}class Jh extends Error{}function Gh(n,e=Ee.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return Xh(n.trim(),e)}const Xh=(n,e)=>{const t=n.length;let s=0;const a=h=>{throw new Hh(`${h} at position ${s}`)},i=h=>{throw new Jh(`${h} at position ${s}`)},r=()=>(p(),s>=t&&a("Unexpected end of input"),n[s]==='"'?o():n[s]==="{"?c():n[s]==="["?l():n.substring(s,s+4)==="null"||Ee.NULL&e&&t-s<4&&"null".startsWith(n.substring(s))?(s+=4,null):n.substring(s,s+4)==="true"||Ee.BOOL&e&&t-s<4&&"true".startsWith(n.substring(s))?(s+=4,!0):n.substring(s,s+5)==="false"||Ee.BOOL&e&&t-s<5&&"false".startsWith(n.substring(s))?(s+=5,!1):n.substring(s,s+8)==="Infinity"||Ee.INFINITY&e&&t-s<8&&"Infinity".startsWith(n.substring(s))?(s+=8,1/0):n.substring(s,s+9)==="-Infinity"||Ee.MINUS_INFINITY&e&&1<t-s&&t-s<9&&"-Infinity".startsWith(n.substring(s))?(s+=9,-1/0):n.substring(s,s+3)==="NaN"||Ee.NAN&e&&t-s<3&&"NaN".startsWith(n.substring(s))?(s+=3,NaN):u()),o=()=>{const h=s;let d=!1;for(s++;s<t&&(n[s]!=='"'||d&&n[s-1]==="\\");)d=n[s]==="\\"?!d:!1,s++;if(n.charAt(s)=='"')try{return JSON.parse(n.substring(h,++s-Number(d)))}catch(m){i(String(m))}else if(Ee.STR&e)try{return JSON.parse(n.substring(h,s-Number(d))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},c=()=>{s++,p();const h={};try{for(;n[s]!=="}";){if(p(),s>=t&&Ee.OBJ&e)return h;const d=o();p(),s++;try{const m=r();Object.defineProperty(h,d,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Ee.OBJ&e)return h;throw m}p(),n[s]===","&&s++}}catch{if(Ee.OBJ&e)return h;a("Expected '}' at end of object")}return s++,h},l=()=>{s++;const h=[];try{for(;n[s]!=="]";)h.push(r()),p(),n[s]===","&&s++}catch{if(Ee.ARR&e)return h;a("Expected ']' at end of array")}return s++,h},u=()=>{if(s===0){n==="-"&&Ee.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n)}catch(d){if(Ee.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}i(String(d))}}const h=s;for(n[s]==="-"&&s++;n[s]&&!",]}".includes(n[s]);)s++;s==t&&!(Ee.NUM&e)&&a("Unterminated number literal");try{return JSON.parse(n.substring(h,s))}catch{n.substring(h,s)==="-"&&Ee.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(d){i(String(d))}}},p=()=>{for(;s<t&&` 
\r	`.includes(n[s]);)s++};return r()},oc=n=>Gh(n,Ee.ALL^Ee.NUM);var fn=function(n,e,t,s,a){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},oe=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Oe,Lt,yn,Ft,ii,As,ri,oi,ci,Ps,li,cc;class Wn extends Ko{constructor(e){super(),Oe.add(this),Lt.set(this,void 0),yn.set(this,void 0),Ft.set(this,void 0),fn(this,Lt,e,"f"),fn(this,yn,[],"f")}get currentChatCompletionSnapshot(){return oe(this,Ft,"f")}static fromReadableStream(e){const t=new Wn(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const a=new Wn(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,s){var r;super._createChatCompletion;const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),oe(this,Oe,"m",ii).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const o of i)oe(this,Oe,"m",ri).call(this,o);if((r=i.controller.signal)!=null&&r.aborted)throw new tt;return this._addChatCompletion(oe(this,Oe,"m",Ps).call(this))}async _fromReadableStream(e,t){var r;const s=t==null?void 0:t.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),oe(this,Oe,"m",ii).call(this),this._connected();const a=jn.fromReadableStream(e,this.controller);let i;for await(const o of a)i&&i!==o.id&&this._addChatCompletion(oe(this,Oe,"m",Ps).call(this)),oe(this,Oe,"m",ri).call(this,o),i=o.id;if((r=a.controller.signal)!=null&&r.aborted)throw new tt;return this._addChatCompletion(oe(this,Oe,"m",Ps).call(this))}[(Lt=new WeakMap,yn=new WeakMap,Ft=new WeakMap,Oe=new WeakSet,ii=function(){this.ended||fn(this,Ft,void 0,"f")},As=function(e){let t=oe(this,yn,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},oe(this,yn,"f")[e.index]=t,t)},ri=function(e){var s,a,i,r,o,c,l,u,p,h,d,m,f,y,g;if(this.ended)return;const t=oe(this,Oe,"m",cc).call(this,e);this._emit("chunk",e,t);for(const v of e.choices){const O=t.choices[v.index];v.delta.content!=null&&((s=O.message)==null?void 0:s.role)==="assistant"&&((a=O.message)!=null&&a.content)&&(this._emit("content",v.delta.content,O.message.content),this._emit("content.delta",{delta:v.delta.content,snapshot:O.message.content,parsed:O.message.parsed})),v.delta.refusal!=null&&((i=O.message)==null?void 0:i.role)==="assistant"&&((r=O.message)!=null&&r.refusal)&&this._emit("refusal.delta",{delta:v.delta.refusal,snapshot:O.message.refusal}),((o=v.logprobs)==null?void 0:o.content)!=null&&((c=O.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=v.logprobs)==null?void 0:l.content,snapshot:((u=O.logprobs)==null?void 0:u.content)??[]}),((p=v.logprobs)==null?void 0:p.refusal)!=null&&((h=O.message)==null?void 0:h.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(d=v.logprobs)==null?void 0:d.refusal,snapshot:((m=O.logprobs)==null?void 0:m.refusal)??[]});const A=oe(this,Oe,"m",As).call(this,O);O.finish_reason&&(oe(this,Oe,"m",ci).call(this,O),A.current_tool_call_index!=null&&oe(this,Oe,"m",oi).call(this,O,A.current_tool_call_index));for(const T of v.delta.tool_calls??[])A.current_tool_call_index!==T.index&&(oe(this,Oe,"m",ci).call(this,O),A.current_tool_call_index!=null&&oe(this,Oe,"m",oi).call(this,O,A.current_tool_call_index)),A.current_tool_call_index=T.index;for(const T of v.delta.tool_calls??[]){const C=(f=O.message.tool_calls)==null?void 0:f[T.index];C!=null&&C.type&&((C==null?void 0:C.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(y=C.function)==null?void 0:y.name,index:T.index,arguments:C.function.arguments,parsed_arguments:C.function.parsed_arguments,arguments_delta:((g=T.function)==null?void 0:g.arguments)??""}):C==null||C.type)}}},oi=function(e,t){var a,i,r;if(oe(this,Oe,"m",As).call(this,e).done_tool_calls.has(t))return;const s=(a=e.message.tool_calls)==null?void 0:a[t];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if(s.type==="function"){const o=(r=(i=oe(this,Lt,"f"))==null?void 0:i.tools)==null?void 0:r.find(c=>c.type==="function"&&c.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:t,arguments:s.function.arguments,parsed_arguments:Dn(o)?o.$parseRaw(s.function.arguments):o!=null&&o.function.strict?JSON.parse(s.function.arguments):null})}else s.type},ci=function(e){var s,a;const t=oe(this,Oe,"m",As).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const i=oe(this,Oe,"m",li).call(this);this._emit("content.done",{content:e.message.content,parsed:i?i.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),(s=e.logprobs)!=null&&s.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),(a=e.logprobs)!=null&&a.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Ps=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");const e=oe(this,Ft,"f");if(!e)throw new K("request ended without sending any chunks");return fn(this,Ft,void 0,"f"),fn(this,yn,[],"f"),Yh(e,oe(this,Lt,"f"))},li=function(){var t;const e=(t=oe(this,Lt,"f"))==null?void 0:t.response_format;return Wo(e)?e:null},cc=function(e){var t,s,a,i;let r=oe(this,Ft,"f");const{choices:o,...c}=e;r?Object.assign(r,c):r=fn(this,Ft,{...c,choices:[]},"f");for(const{delta:l,finish_reason:u,index:p,logprobs:h=null,...d}of e.choices){let m=r.choices[p];if(m||(m=r.choices[p]={finish_reason:u,index:p,message:{},logprobs:h,...d}),h)if(!m.logprobs)m.logprobs=Object.assign({},h);else{const{content:T,refusal:C,...W}=h;Object.assign(m.logprobs,W),T&&((t=m.logprobs).content??(t.content=[]),m.logprobs.content.push(...T)),C&&((s=m.logprobs).refusal??(s.refusal=[]),m.logprobs.refusal.push(...C))}if(u&&(m.finish_reason=u,oe(this,Lt,"f")&&zo(oe(this,Lt,"f")))){if(u==="length")throw new yo;if(u==="content_filter")throw new go}if(Object.assign(m,d),!l)continue;const{content:f,refusal:y,function_call:g,role:v,tool_calls:O,...A}=l;if(Object.assign(m.message,A),y&&(m.message.refusal=(m.message.refusal||"")+y),v&&(m.message.role=v),g&&(m.message.function_call?(g.name&&(m.message.function_call.name=g.name),g.arguments&&((a=m.message.function_call).arguments??(a.arguments=""),m.message.function_call.arguments+=g.arguments)):m.message.function_call=g),f&&(m.message.content=(m.message.content||"")+f,!m.message.refusal&&oe(this,Oe,"m",li).call(this)&&(m.message.parsed=oc(m.message.content))),O){m.message.tool_calls||(m.message.tool_calls=[]);for(const{index:T,id:C,type:W,function:D,...B}of O){const $=(i=m.message.tool_calls)[T]??(i[T]={});Object.assign($,B),C&&($.id=C),W&&($.type=W),D&&($.function??($.function={name:D.name??"",arguments:""})),D!=null&&D.name&&($.function.name=D.name),D!=null&&D.arguments&&($.function.arguments+=D.arguments,Vh(oe(this,Lt,"f"),$)&&($.function.parsed_arguments=oc($.function.arguments)))}}}return r},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",a=>{const i=t.shift();i?i.resolve(a):e.push(a)}),this.on("end",()=>{s=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{s=!0;for(const i of t)i.reject(a);t.length=0}),this.on("error",a=>{s=!0;for(const i of t)i.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new jn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Yh(n,e){const{id:t,choices:s,created:a,model:i,system_fingerprint:r,...o}=n,c={...o,id:t,choices:s.map(({message:l,finish_reason:u,index:p,logprobs:h,...d})=>{if(!u)throw new K(`missing finish_reason for choice ${p}`);const{content:m=null,function_call:f,tool_calls:y,...g}=l,v=l.role;if(!v)throw new K(`missing role for choice ${p}`);if(f){const{arguments:O,name:A}=f;if(O==null)throw new K(`missing function_call.arguments for choice ${p}`);if(!A)throw new K(`missing function_call.name for choice ${p}`);return{...d,message:{content:m,function_call:{arguments:O,name:A},role:v,refusal:l.refusal??null},finish_reason:u,index:p,logprobs:h}}return y?{...d,index:p,finish_reason:u,logprobs:h,message:{...g,role:v,content:m,refusal:l.refusal??null,tool_calls:y.map((O,A)=>{const{function:T,type:C,id:W,...D}=O,{arguments:B,name:$,...re}=T||{};if(W==null)throw new K(`missing choices[${p}].tool_calls[${A}].id
${Es(n)}`);if(C==null)throw new K(`missing choices[${p}].tool_calls[${A}].type
${Es(n)}`);if($==null)throw new K(`missing choices[${p}].tool_calls[${A}].function.name
${Es(n)}`);if(B==null)throw new K(`missing choices[${p}].tool_calls[${A}].function.arguments
${Es(n)}`);return{...D,id:W,type:C,function:{...re,name:$,arguments:B}}})}}:{...d,message:{...g,content:m,role:v,refusal:l.refusal??null},finish_reason:u,index:p,logprobs:h}}),created:a,model:i,object:"chat.completion",...r?{system_fingerprint:r}:{}};return Wh(c,e)}function Es(n){return JSON.stringify(n)}class gn extends Wn{static fromReadableStream(e){const t=new gn(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,s){const a=new gn(null),i={...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,i)),a}static runTools(e,t,s){const a=new gn(t),i={...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,i)),a}}let lc=class extends X{parse(n,e){return Kh(n.tools),this._client.chat.completions.create(n,{...e,headers:{...e==null?void 0:e.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(t=>Ya(t,n))}runFunctions(n,e){return n.stream?gn.runFunctions(this._client,n,e):Un.runFunctions(this._client,n,e)}runTools(n,e){return n.stream?gn.runTools(this._client,n,e):Un.runTools(this._client,n,e)}stream(n,e){return Wn.createChatCompletion(this._client,n,e)}},ui=class extends X{constructor(){super(...arguments),this.completions=new lc(this._client)}};(function(n){n.Completions=lc})(ui||(ui={}));class uc extends X{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class pi extends X{constructor(){super(...arguments),this.sessions=new uc(this._client)}}pi.Sessions=uc;var R=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Je=function(n,e,t,s,a){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},je,hi,St,Cs,ot,Ht,bn,Jt,Ss,Ge,ks,Ts,zn,Zn,Vn,pc,hc,dc,mc,fc,yc,gc;class ct extends Uo{constructor(){super(...arguments),je.add(this),hi.set(this,[]),St.set(this,{}),Cs.set(this,{}),ot.set(this,void 0),Ht.set(this,void 0),bn.set(this,void 0),Jt.set(this,void 0),Ss.set(this,void 0),Ge.set(this,void 0),ks.set(this,void 0),Ts.set(this,void 0),zn.set(this,void 0)}[(hi=new WeakMap,St=new WeakMap,Cs=new WeakMap,ot=new WeakMap,Ht=new WeakMap,bn=new WeakMap,Jt=new WeakMap,Ss=new WeakMap,Ge=new WeakMap,ks=new WeakMap,Ts=new WeakMap,zn=new WeakMap,je=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",a=>{const i=t.shift();i?i.resolve(a):e.push(a)}),this.on("end",()=>{s=!0;for(const a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{s=!0;for(const i of t)i.reject(a);t.length=0}),this.on("error",a=>{s=!0;for(const i of t)i.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new ct;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var i;const s=t==null?void 0:t.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const a=jn.fromReadableStream(e,this.controller);for await(const r of a)R(this,je,"m",Zn).call(this,r);if((i=a.controller.signal)!=null&&i.aborted)throw new tt;return this._addRun(R(this,je,"m",Vn).call(this))}toReadableStream(){return new jn(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,a,i){const r=new ct;return r._run(()=>r._runToolAssistantStream(e,t,s,a,{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createToolAssistantStream(e,t,s,a,i){var l;const r=i==null?void 0:i.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const o={...a,stream:!0},c=await e.submitToolOutputs(t,s,o,{...i,signal:this.controller.signal});this._connected();for await(const u of c)R(this,je,"m",Zn).call(this,u);if((l=c.controller.signal)!=null&&l.aborted)throw new tt;return this._addRun(R(this,je,"m",Vn).call(this))}static createThreadAssistantStream(e,t,s){const a=new ct;return a._run(()=>a._threadAssistantStream(e,t,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,s,a){const i=new ct;return i._run(()=>i._runAssistantStream(e,t,s,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return R(this,ks,"f")}currentRun(){return R(this,Ts,"f")}currentMessageSnapshot(){return R(this,ot,"f")}currentRunStepSnapshot(){return R(this,zn,"f")}async finalRunSteps(){return await this.done(),Object.values(R(this,St,"f"))}async finalMessages(){return await this.done(),Object.values(R(this,Cs,"f"))}async finalRun(){if(await this.done(),!R(this,Ht,"f"))throw Error("Final run was not received.");return R(this,Ht,"f")}async _createThreadAssistantStream(e,t,s){var o;const a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...t,stream:!0},r=await e.createAndRun(i,{...s,signal:this.controller.signal});this._connected();for await(const c of r)R(this,je,"m",Zn).call(this,c);if((o=r.controller.signal)!=null&&o.aborted)throw new tt;return this._addRun(R(this,je,"m",Vn).call(this))}async _createAssistantStream(e,t,s,a){var c;const i=a==null?void 0:a.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const r={...s,stream:!0},o=await e.create(t,r,{...a,signal:this.controller.signal});this._connected();for await(const l of o)R(this,je,"m",Zn).call(this,l);if((c=o.controller.signal)!=null&&c.aborted)throw new tt;return this._addRun(R(this,je,"m",Vn).call(this))}static accumulateDelta(e,t){for(const[s,a]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=a;continue}let i=e[s];if(i==null){e[s]=a;continue}if(s==="index"||s==="type"){e[s]=a;continue}if(typeof i=="string"&&typeof a=="string")i+=a;else if(typeof i=="number"&&typeof a=="number")i+=a;else if(Va(i)&&Va(a))i=this.accumulateDelta(i,a);else if(Array.isArray(i)&&Array.isArray(a)){if(i.every(r=>typeof r=="string"||typeof r=="number")){i.push(...a);continue}for(const r of a){if(!Va(r))throw new Error(`Expected array delta entry to be an object but got: ${r}`);const o=r.index;if(o==null)throw console.error(r),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=i[o];c==null?i.push(r):i[o]=this.accumulateDelta(c,r)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${a}, accValue: ${i}`);e[s]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,a){return await this._createAssistantStream(t,e,s,a)}async _runToolAssistantStream(e,t,s,a,i){return await this._createToolAssistantStream(s,e,t,a,i)}}Zn=function(n){if(!this.ended)switch(Je(this,ks,n,"f"),R(this,je,"m",dc).call(this,n),n.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":R(this,je,"m",gc).call(this,n);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":R(this,je,"m",hc).call(this,n);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":R(this,je,"m",pc).call(this,n);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Vn=function(){if(this.ended)throw new K("stream has ended, this shouldn't happen");if(!R(this,Ht,"f"))throw Error("Final run has not been received");return R(this,Ht,"f")},pc=function(n){const[e,t]=R(this,je,"m",fc).call(this,n,R(this,ot,"f"));Je(this,ot,e,"f"),R(this,Cs,"f")[e.id]=e;for(const s of t){const a=e.content[s.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(n.event){case"thread.message.created":this._emit("messageCreated",n.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",n.data.delta,e),n.data.delta.content)for(const s of n.data.delta.content){if(s.type=="text"&&s.text){let a=s.text,i=e.content[s.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=R(this,bn,"f")){if(R(this,Jt,"f"))switch(R(this,Jt,"f").type){case"text":this._emit("textDone",R(this,Jt,"f").text,R(this,ot,"f"));break;case"image_file":this._emit("imageFileDone",R(this,Jt,"f").image_file,R(this,ot,"f"));break}Je(this,bn,s.index,"f")}Je(this,Jt,e.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(R(this,bn,"f")!==void 0){const s=n.data.content[R(this,bn,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,R(this,ot,"f"));break;case"text":this._emit("textDone",s.text,R(this,ot,"f"));break}}R(this,ot,"f")&&this._emit("messageDone",n.data),Je(this,ot,void 0,"f")}},hc=function(n){const e=R(this,je,"m",mc).call(this,n);switch(Je(this,zn,e,"f"),n.event){case"thread.run.step.created":this._emit("runStepCreated",n.data);break;case"thread.run.step.delta":const t=n.data.delta;if(t.step_details&&t.step_details.type=="tool_calls"&&t.step_details.tool_calls&&e.step_details.type=="tool_calls")for(const s of t.step_details.tool_calls)s.index==R(this,Ss,"f")?this._emit("toolCallDelta",s,e.step_details.tool_calls[s.index]):(R(this,Ge,"f")&&this._emit("toolCallDone",R(this,Ge,"f")),Je(this,Ss,s.index,"f"),Je(this,Ge,e.step_details.tool_calls[s.index],"f"),R(this,Ge,"f")&&this._emit("toolCallCreated",R(this,Ge,"f")));this._emit("runStepDelta",n.data.delta,e);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Je(this,zn,void 0,"f"),n.data.step_details.type=="tool_calls"&&R(this,Ge,"f")&&(this._emit("toolCallDone",R(this,Ge,"f")),Je(this,Ge,void 0,"f")),this._emit("runStepDone",n.data,e);break}},dc=function(n){R(this,hi,"f").push(n),this._emit("event",n)},mc=function(n){switch(n.event){case"thread.run.step.created":return R(this,St,"f")[n.data.id]=n.data,n.data;case"thread.run.step.delta":let e=R(this,St,"f")[n.data.id];if(!e)throw Error("Received a RunStepDelta before creation of a snapshot");let t=n.data;if(t.delta){const s=ct.accumulateDelta(e,t.delta);R(this,St,"f")[n.data.id]=s}return R(this,St,"f")[n.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":R(this,St,"f")[n.data.id]=n.data;break}if(R(this,St,"f")[n.data.id])return R(this,St,"f")[n.data.id];throw new Error("No snapshot available")},fc=function(n,e){let t=[];switch(n.event){case"thread.message.created":return[n.data,t];case"thread.message.delta":if(!e)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=n.data;if(s.delta.content)for(const a of s.delta.content)if(a.index in e.content){let i=e.content[a.index];e.content[a.index]=R(this,je,"m",yc).call(this,a,i)}else e.content[a.index]=a,t.push(a);return[e,t];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(e)return[e,t];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},yc=function(n,e){return ct.accumulateDelta(e,n)},gc=function(n){switch(Je(this,Ts,n.data,"f"),n.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Je(this,Ht,n.data,"f"),R(this,Ge,"f")&&(this._emit("toolCallDone",R(this,Ge,"f")),Je(this,Ge,void 0,"f"));break}};class di extends X{create(e,t,s){return this._client.post(`/threads/${e}/messages`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}retrieve(e,t,s){return this._client.get(`/threads/${e}/messages/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}update(e,t,s,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},s){return We(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,mi,{query:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}del(e,t,s){return this._client.delete(`/threads/${e}/messages/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}}class mi extends it{}di.MessagesPage=mi;class fi extends X{retrieve(e,t,s,a={},i){return We(a)?this.retrieve(e,t,s,{},a):this._client.get(`/threads/${e}/runs/${t}/steps/${s}`,{query:a,...i,headers:{"OpenAI-Beta":"assistants=v2",...i==null?void 0:i.headers}})}list(e,t,s={},a){return We(s)?this.list(e,t,{},s):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,yi,{query:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}}class yi extends it{}fi.RunStepsPage=yi;class Kn extends X{constructor(){super(...arguments),this.steps=new fi(this._client)}create(e,t,s){const{include:a,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:a},body:i,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers},stream:t.stream??!1})}retrieve(e,t,s){return this._client.get(`/threads/${e}/runs/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}update(e,t,s,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},s){return We(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,gi,{query:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}cancel(e,t,s){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async createAndPoll(e,t,s){const a=await this.create(e,t,s);return await this.poll(e,a.id,s)}createAndStream(e,t,s){return ct.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){const a={...s==null?void 0:s.headers,"X-Stainless-Poll-Helper":"true"};for((s==null?void 0:s.pollIntervalMs)&&(a["X-Stainless-Custom-Poll-Interval"]=s.pollIntervalMs.toString());;){const{data:i,response:r}=await this.retrieve(e,t,{...s,headers:{...s==null?void 0:s.headers,...a}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(s!=null&&s.pollIntervalMs)o=s.pollIntervalMs;else{const c=r.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await Rn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,s){return ct.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers},stream:s.stream??!1})}async submitToolOutputsAndPoll(e,t,s,a){const i=await this.submitToolOutputs(e,t,s,a);return await this.poll(e,i.id,a)}submitToolOutputsStream(e,t,s,a){return ct.createToolAssistantStream(e,t,this._client.beta.threads.runs,s,a)}}class gi extends it{}Kn.RunsPage=gi,Kn.Steps=fi,Kn.RunStepsPage=yi;class wn extends X{constructor(){super(...arguments),this.runs=new Kn(this._client),this.messages=new di(this._client)}create(e={},t){return We(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,s){return this._client.post(`/threads/${e}`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.thread_id,s.id,t)}createAndRunStream(e,t){return ct.createThreadAssistantStream(e,this._client.beta.threads,t)}}wn.Runs=Kn,wn.RunsPage=gi,wn.Messages=di,wn.MessagesPage=mi;const ed=async n=>{const e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(const a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const s=[];for(const a of e)a.status==="fulfilled"&&s.push(a.value);return s};let bi=class extends X{create(n,e,t){return this._client.post(`/vector_stores/${n}/files`,{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(n,e,t){return this._client.get(`/vector_stores/${n}/files/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}list(n,e={},t){return We(e)?this.list(n,{},e):this._client.getAPIList(`/vector_stores/${n}/files`,Ns,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(n,e,t){return this._client.delete(`/vector_stores/${n}/files/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}async createAndPoll(n,e,t){const s=await this.create(n,e,t);return await this.poll(n,s.id,t)}async poll(n,e,t){const s={...t==null?void 0:t.headers,"X-Stainless-Poll-Helper":"true"};for((t==null?void 0:t.pollIntervalMs)&&(s["X-Stainless-Custom-Poll-Interval"]=t.pollIntervalMs.toString());;){const a=await this.retrieve(n,e,{...t,headers:s}).withResponse(),i=a.data;switch(i.status){case"in_progress":let r=5e3;if(t!=null&&t.pollIntervalMs)r=t.pollIntervalMs;else{const o=a.response.headers.get("openai-poll-after-ms");if(o){const c=parseInt(o);isNaN(c)||(r=c)}}await Rn(r);break;case"failed":case"completed":return i}}}async upload(n,e,t){const s=await this._client.files.create({file:e,purpose:"assistants"},t);return this.create(n,{file_id:s.id},t)}async uploadAndPoll(n,e,t){const s=await this.upload(n,e,t);return await this.poll(n,s.id,t)}};class Ns extends it{}bi.VectorStoreFilesPage=Ns;class bc extends X{create(e,t,s){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}retrieve(e,t,s){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}cancel(e,t,s){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}async createAndPoll(e,t,s){const a=await this.create(e,t);return await this.poll(e,a.id,s)}listFiles(e,t,s={},a){return We(s)?this.listFiles(e,t,{},s):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Ns,{query:s,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async poll(e,t,s){const a={...s==null?void 0:s.headers,"X-Stainless-Poll-Helper":"true"};for((s==null?void 0:s.pollIntervalMs)&&(a["X-Stainless-Custom-Poll-Interval"]=s.pollIntervalMs.toString());;){const{data:i,response:r}=await this.retrieve(e,t,{...s,headers:a}).withResponse();switch(i.status){case"in_progress":let o=5e3;if(s!=null&&s.pollIntervalMs)o=s.pollIntervalMs;else{const c=r.headers.get("openai-poll-after-ms");if(c){const l=parseInt(c);isNaN(l)||(o=l)}}await Rn(o);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},a){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=(a==null?void 0:a.maxConcurrency)??5,r=Math.min(i,t.length),o=this._client,c=t.values(),l=[...s];async function u(h){for(let d of h){const m=await o.files.create({file:d,purpose:"assistants"},a);l.push(m.id)}}const p=Array(r).fill(c).map(u);return await ed(p),await this.createAndPoll(e,{file_ids:l})}}class vn extends X{constructor(){super(...arguments),this.files=new bi(this._client),this.fileBatches=new bc(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,s){return this._client.post(`/vector_stores/${e}`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e={},t){return We(e)?this.list({},e):this._client.getAPIList("/vector_stores",wi,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}}class wi extends it{}vn.VectorStoresPage=wi,vn.Files=bi,vn.VectorStoreFilesPage=Ns,vn.FileBatches=bc;class qt extends X{constructor(){super(...arguments),this.realtime=new pi(this._client),this.vectorStores=new vn(this._client),this.chat=new ui(this._client),this.assistants=new Ja(this._client),this.threads=new wn(this._client)}}qt.Realtime=pi,qt.VectorStores=vn,qt.VectorStoresPage=wi,qt.Assistants=Ja,qt.AssistantsPage=Ga,qt.Threads=wn;let wc=class extends X{create(n,e){return this._client.post("/completions",{body:n,...e,stream:n.stream??!1})}},vc=class extends X{create(n,e){return this._client.post("/embeddings",{body:n,...e})}};class vi extends X{create(e,t){return this._client.post("/files",un({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return We(e)?this.list({},e):this._client.getAPIList("/files",xi,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t==null?void 0:t.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=30*60*1e3}={}){const a=new Set(["processed","error","deleted"]),i=Date.now();let r=await this.retrieve(e);for(;!r.status||!a.has(r.status);)if(await Rn(t),r=await this.retrieve(e),Date.now()-i>s)throw new ms({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return r}}class xi extends it{}vi.FileObjectsPage=xi;class _i extends X{list(e,t={},s){return We(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Oi,{query:t,...s})}}class Oi extends it{}_i.FineTuningJobCheckpointsPage=Oi;class xn extends X{constructor(){super(...arguments),this.checkpoints=new _i(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return We(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Mi,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return We(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Ai,{query:t,...s})}}class Mi extends it{}class Ai extends it{}xn.FineTuningJobsPage=Mi,xn.FineTuningJobEventsPage=Ai,xn.Checkpoints=_i,xn.FineTuningJobCheckpointsPage=Oi;class Qn extends X{constructor(){super(...arguments),this.jobs=new xn(this._client)}}Qn.Jobs=xn,Qn.FineTuningJobsPage=Mi,Qn.FineTuningJobEventsPage=Ai;class xc extends X{createVariation(e,t){return this._client.post("/images/variations",un({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",un({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}let Pi=class extends X{retrieve(n,e){return this._client.get(`/models/${n}`,e)}list(n){return this._client.getAPIList("/models",Ei,n)}del(n,e){return this._client.delete(`/models/${n}`,e)}};class Ei extends qh{}Pi.ModelsPage=Ei;class _c extends X{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Oc extends X{create(e,t,s){return this._client.post(`/uploads/${e}/parts`,un({body:t,...s}))}}class Ci extends X{constructor(){super(...arguments),this.parts=new Oc(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(`/uploads/${e}/complete`,{body:t,...s})}}Ci.Parts=Oc;var Mc;H=class extends Eh{constructor({baseURL:n=bs("OPENAI_BASE_URL"),apiKey:e=bs("OPENAI_API_KEY"),organization:t=bs("OPENAI_ORG_ID")??null,project:s=bs("OPENAI_PROJECT_ID")??null,...a}={}){if(e===void 0)throw new K("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:e,organization:t,project:s,...a,baseURL:n||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Bh())throw new K(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new wc(this),this.chat=new Ka(this),this.embeddings=new vc(this),this.files=new vi(this),this.images=new xc(this),this.audio=new $n(this),this.moderations=new _c(this),this.models=new Pi(this),this.fineTuning=new Qn(this),this.beta=new qt(this),this.batches=new Qa(this),this.uploads=new Ci(this),this._options=i,this.apiKey=e,this.organization=t,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(n){return{...super.defaultHeaders(n),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(n){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(n){return uh(n,{arrayFormat:"brackets"})}},Mc=H,H.OpenAI=Mc,H.DEFAULT_TIMEOUT=6e5,H.OpenAIError=K,H.APIError=Ue,H.APIConnectionError=ds,H.APIConnectionTimeoutError=ms,H.APIUserAbortError=tt,H.NotFoundError=uo,H.ConflictError=po,H.RateLimitError=mo,H.BadRequestError=oo,H.AuthenticationError=co,H.InternalServerError=fo,H.PermissionDeniedError=lo,H.UnprocessableEntityError=ho,H.toFile=xo,H.fileFromPath=io,H.Completions=wc,H.Chat=Ka,H.Embeddings=vc,H.Files=vi,H.FileObjectsPage=xi,H.Images=xc,H.Audio=$n,H.Moderations=_c,H.Models=Pi,H.ModelsPage=Ei,H.FineTuning=Qn,H.Beta=qt,H.Batches=Qa,H.BatchesPage=Ha,H.Uploads=Ci;var td=typeof window=="object"?window:{},Z="0123456789abcdef".split(""),nd=[-2147483648,8388608,32768,128],lt=[24,16,8,0],Ce=[];function ut(n){n?(Ce[0]=Ce[16]=Ce[1]=Ce[2]=Ce[3]=Ce[4]=Ce[5]=Ce[6]=Ce[7]=Ce[8]=Ce[9]=Ce[10]=Ce[11]=Ce[12]=Ce[13]=Ce[14]=Ce[15]=0,this.blocks=Ce):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}ut.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===td.ArrayBuffer&&(n=new Uint8Array(n));for(var t,s=0,a,i=n.length||0,r=this.blocks;s<i;){if(this.hashed&&(this.hashed=!1,r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),e)for(a=this.start;s<i&&a<64;++s)r[a>>2]|=n[s]<<lt[a++&3];else for(a=this.start;s<i&&a<64;++s)t=n.charCodeAt(s),t<128?r[a>>2]|=t<<lt[a++&3]:t<2048?(r[a>>2]|=(192|t>>6)<<lt[a++&3],r[a>>2]|=(128|t&63)<<lt[a++&3]):t<55296||t>=57344?(r[a>>2]|=(224|t>>12)<<lt[a++&3],r[a>>2]|=(128|t>>6&63)<<lt[a++&3],r[a>>2]|=(128|t&63)<<lt[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++s)&1023),r[a>>2]|=(240|t>>18)<<lt[a++&3],r[a>>2]|=(128|t>>12&63)<<lt[a++&3],r[a>>2]|=(128|t>>6&63)<<lt[a++&3],r[a>>2]|=(128|t&63)<<lt[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=r[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},ut.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=nd[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}},ut.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,s=this.h3,a=this.h4,i,r,o,c=this.blocks;for(r=16;r<80;++r)o=c[r-3]^c[r-8]^c[r-14]^c[r-16],c[r]=o<<1|o>>>31;for(r=0;r<20;r+=5)i=e&t|~e&s,o=n<<5|n>>>27,a=o+i+a+1518500249+c[r]<<0,e=e<<30|e>>>2,i=n&e|~n&t,o=a<<5|a>>>27,s=o+i+s+1518500249+c[r+1]<<0,n=n<<30|n>>>2,i=a&n|~a&e,o=s<<5|s>>>27,t=o+i+t+1518500249+c[r+2]<<0,a=a<<30|a>>>2,i=s&a|~s&n,o=t<<5|t>>>27,e=o+i+e+1518500249+c[r+3]<<0,s=s<<30|s>>>2,i=t&s|~t&a,o=e<<5|e>>>27,n=o+i+n+1518500249+c[r+4]<<0,t=t<<30|t>>>2;for(;r<40;r+=5)i=e^t^s,o=n<<5|n>>>27,a=o+i+a+1859775393+c[r]<<0,e=e<<30|e>>>2,i=n^e^t,o=a<<5|a>>>27,s=o+i+s+1859775393+c[r+1]<<0,n=n<<30|n>>>2,i=a^n^e,o=s<<5|s>>>27,t=o+i+t+1859775393+c[r+2]<<0,a=a<<30|a>>>2,i=s^a^n,o=t<<5|t>>>27,e=o+i+e+1859775393+c[r+3]<<0,s=s<<30|s>>>2,i=t^s^a,o=e<<5|e>>>27,n=o+i+n+1859775393+c[r+4]<<0,t=t<<30|t>>>2;for(;r<60;r+=5)i=e&t|e&s|t&s,o=n<<5|n>>>27,a=o+i+a-1894007588+c[r]<<0,e=e<<30|e>>>2,i=n&e|n&t|e&t,o=a<<5|a>>>27,s=o+i+s-1894007588+c[r+1]<<0,n=n<<30|n>>>2,i=a&n|a&e|n&e,o=s<<5|s>>>27,t=o+i+t-1894007588+c[r+2]<<0,a=a<<30|a>>>2,i=s&a|s&n|a&n,o=t<<5|t>>>27,e=o+i+e-1894007588+c[r+3]<<0,s=s<<30|s>>>2,i=t&s|t&a|s&a,o=e<<5|e>>>27,n=o+i+n-1894007588+c[r+4]<<0,t=t<<30|t>>>2;for(;r<80;r+=5)i=e^t^s,o=n<<5|n>>>27,a=o+i+a-899497514+c[r]<<0,e=e<<30|e>>>2,i=n^e^t,o=a<<5|a>>>27,s=o+i+s-899497514+c[r+1]<<0,n=n<<30|n>>>2,i=a^n^e,o=s<<5|s>>>27,t=o+i+t-899497514+c[r+2]<<0,a=a<<30|a>>>2,i=s^a^n,o=t<<5|t>>>27,e=o+i+e-899497514+c[r+3]<<0,s=s<<30|s>>>2,i=t^s^a,o=e<<5|e>>>27,n=o+i+n-899497514+c[r+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+s<<0,this.h4=this.h4+a<<0},ut.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,s=this.h3,a=this.h4;return Z[n>>28&15]+Z[n>>24&15]+Z[n>>20&15]+Z[n>>16&15]+Z[n>>12&15]+Z[n>>8&15]+Z[n>>4&15]+Z[n&15]+Z[e>>28&15]+Z[e>>24&15]+Z[e>>20&15]+Z[e>>16&15]+Z[e>>12&15]+Z[e>>8&15]+Z[e>>4&15]+Z[e&15]+Z[t>>28&15]+Z[t>>24&15]+Z[t>>20&15]+Z[t>>16&15]+Z[t>>12&15]+Z[t>>8&15]+Z[t>>4&15]+Z[t&15]+Z[s>>28&15]+Z[s>>24&15]+Z[s>>20&15]+Z[s>>16&15]+Z[s>>12&15]+Z[s>>8&15]+Z[s>>4&15]+Z[s&15]+Z[a>>28&15]+Z[a>>24&15]+Z[a>>20&15]+Z[a>>16&15]+Z[a>>12&15]+Z[a>>8&15]+Z[a>>4&15]+Z[a&15]},ut.prototype.toString=ut.prototype.hex,ut.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,s=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,s>>24&255,s>>16&255,s>>8&255,s&255,a>>24&255,a>>16&255,a>>8&255,a&255]},ut.prototype.array=ut.prototype.digest,ut.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const sd=n=>new ut(!0).update(n).hex(),Ac=(...n)=>sd(n.join("_"));class ad{}const id=new Map;class Si extends ad{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Ac(e,t))??null)}async update(e,t,s){this.cache.set(Ac(e,t),s)}static global(){return new Si(id)}}const rd=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;function ki(n){return typeof n!="object"||!n?!1:!!("type"in n&&n.type==="function"&&"function"in n&&typeof n.function=="object"&&n.function&&"name"in n.function&&"parameters"in n.function)}const od=()=>!1;class cd extends ia{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??od(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class ld extends cd{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...s}){super({callbacks:e??t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof s.cache=="object"?this.cache=s.cache:s.cache?this.cache=Si.global():this.cache=void 0,this.caller=new a0(s??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await i0("modelName"in this?rd(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new rr(e):Array.isArray(e)?new eh(e.map(as)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const s={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(s).filter(([a,i])=>i!==void 0).map(([a,i])=>`${a}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Dt extends ia{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const s=Iu(t);return this.func&&await this.func(e,s),this._callWithConfig(a=>Promise.resolve(a),e,s)}async*transform(e,t){const s=Iu(t);let a,i=!0;for await(const r of this._transformStreamWithConfig(e,o=>o,s))if(yield r,i)if(a===void 0)a=r;else try{a=ju(a,r)}catch{a=void 0,i=!1}this.func&&a!==void 0&&await this.func(a,s)}static assign(e){return new r0(new o0({steps:e}))}}function Hn(n){return typeof(n==null?void 0:n.parse)=="function"}class kt extends ld{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,s]=super._separateRunnableConfigFromCallOptions(e);return s.signal=t.signal,[t,s]}async invoke(e,t){const s=kt._convertInputToPromptValue(e);return(await this.generatePrompt([s],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,s){throw new Error("Not implemented.")}async*_streamIterator(e,t){var s;if(this._streamResponseChunks===kt.prototype._streamResponseChunks)yield this.invoke(e,t);else{const a=kt._convertInputToPromptValue(e).toChatMessages(),[i,r]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...i.metadata,...this.getLsParams(r)},c=await Ji.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this==null?void 0:this.invocationParams(r),batch_size:1},u=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[a],i.runId,void 0,l,void 0,void 0,i.runName));let p;try{for await(const h of this._streamResponseChunks(a,r,u==null?void 0:u[0])){if(h.message.id==null){const d=(s=u==null?void 0:u.at(0))==null?void 0:s.runId;d!=null&&h.message._updateId(`run-${d}`)}h.message.response_metadata={...h.generationInfo,...h.message.response_metadata},yield h.message,p?p=p.concat(h):p=h}}catch(h){throw await Promise.all((u??[]).map(d=>d==null?void 0:d.handleLLMError(h))),h}await Promise.all((u??[]).map(h=>h==null?void 0:h.handleLLMEnd({generations:[[p]]})))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,s){var h,d;const a=e.map(m=>m.map(as)),i={...s.metadata,...this.getLsParams(t)},r=await Ji.configure(s.callbacks,this.callbacks,s.tags,this.tags,i,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},c=await(r==null?void 0:r.handleChatModelStart(this.toJSON(),a,s.runId,void 0,o,void 0,void 0,s.runName)),l=[],u=[];if(c!=null&&c[0].handlers.find(m=>c0(m)||l0(m))&&a.length===1&&this._streamResponseChunks!==kt.prototype._streamResponseChunks)try{const m=await this._streamResponseChunks(a[0],t,c==null?void 0:c[0]);let f;for await(const y of m){if(y.message.id==null){const g=(h=c==null?void 0:c.at(0))==null?void 0:h.runId;g!=null&&y.message._updateId(`run-${g}`)}f===void 0?f=y:f=ju(f,y)}if(f===void 0)throw new Error("Received empty response from chat model call.");l.push([f]),await(c==null?void 0:c[0].handleLLMEnd({generations:l,llmOutput:{}}))}catch(m){throw await(c==null?void 0:c[0].handleLLMError(m)),m}else{const m=await Promise.allSettled(a.map((f,y)=>this._generate(f,{...t,promptIndex:y},c==null?void 0:c[y])));await Promise.all(m.map(async(f,y)=>{var g,v,O;if(f.status==="fulfilled"){const A=f.value;for(const T of A.generations){if(T.message.id==null){const C=(g=c==null?void 0:c.at(0))==null?void 0:g.runId;C!=null&&T.message._updateId(`run-${C}`)}T.message.response_metadata={...T.generationInfo,...T.message.response_metadata}}return A.generations.length===1&&(A.generations[0].message.response_metadata={...A.llmOutput,...A.generations[0].message.response_metadata}),l[y]=A.generations,u[y]=A.llmOutput,(v=c==null?void 0:c[y])==null?void 0:v.handleLLMEnd({generations:[A.generations],llmOutput:A.llmOutput})}else return await((O=c==null?void 0:c[y])==null?void 0:O.handleLLMError(f.reason)),Promise.reject(f.reason)}))}const p={generations:l,llmOutput:u.length?(d=this._combineLLMOutput)==null?void 0:d.call(this,...u):void 0};return Object.defineProperty(p,Ru,{value:c?{runIds:c==null?void 0:c.map(m=>m.runId)}:void 0,configurable:!0}),p}async _generateCached({messages:e,cache:t,llmStringKey:s,parsedOptions:a,handledOptions:i}){const r=e.map(f=>f.map(as)),o={...i.metadata,...this.getLsParams(a)},c=await Ji.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1,cached:!0},u=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),r,i.runId,void 0,l,void 0,void 0,i.runName)),p=[],h=(await Promise.allSettled(r.map(async(f,y)=>{const g=kt._convertInputToPromptValue(f).toString(),v=await t.lookup(g,s);return v==null&&p.push(y),v}))).map((f,y)=>({result:f,runManager:u==null?void 0:u[y]})).filter(({result:f})=>f.status==="fulfilled"&&f.value!=null||f.status==="rejected"),d=[];await Promise.all(h.map(async({result:f,runManager:y},g)=>{if(f.status==="fulfilled"){const v=f.value;return d[g]=v,v.length&&await(y==null?void 0:y.handleLLMNewToken(v[0].text)),y==null?void 0:y.handleLLMEnd({generations:[v]})}else return await(y==null?void 0:y.handleLLMError(f.reason)),Promise.reject(f.reason)}));const m={generations:d,missingPromptIndices:p};return Object.defineProperty(m,Ru,{value:u?{runIds:u==null?void 0:u.map(f=>f.runId)}:void 0,configurable:!0}),m}async generate(e,t,s){let a;Array.isArray(t)?a={stop:t}:a=t;const i=e.map(d=>d.map(as)),[r,o]=this._separateRunnableConfigFromCallOptionsCompat(a);if(r.callbacks=r.callbacks??s,!this.cache)return this._generateUncached(i,o,r);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:p}=await this._generateCached({messages:i,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:r});let h={};if(p.length>0){const d=await this._generateUncached(p.map(m=>i[m]),o,r);await Promise.all(d.generations.map(async(m,f)=>{const y=p[f];u[y]=m;const g=kt._convertInputToPromptValue(i[y]).toString();return c.update(g,l,m)})),h=d.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,s){const a=e.map(i=>i.toChatMessages());return this.generate(a,t,s)}async call(e,t,s){return(await this.generate([e.map(as)],t,s)).generations[0][0].message}async callPrompt(e,t,s){const a=e.toChatMessages();return this.call(a,t,s)}async predictMessages(e,t,s){return this.call(e,t,s)}async predict(e,t,s){const a=new Nu(e),i=await this.call([a],t,s);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');const s=e,a=t==null?void 0:t.name,i=s.description??"A function available to call.",r=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(r==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let c=a??"extract",l;Hn(s)?l=[{type:"function",function:{name:c,description:i,parameters:Gi(s)}}]:("name"in s&&(c=s.name),l=[{type:"function",function:{name:c,description:i,parameters:s}}]);const u=this.bindTools(l),p=u0.from(f=>{if(!f.tool_calls||f.tool_calls.length===0)throw new Error("No tool calls found in the response.");const y=f.tool_calls.find(g=>g.name===c);if(!y)throw new Error(`No tool call found with name ${c}.`);return y.args});if(!o)return u.pipe(p).withConfig({runName:"StructuredOutput"});const h=Dt.assign({parsed:(f,y)=>p.invoke(f.raw,y)}),d=Dt.assign({parsed:()=>null}),m=h.withFallbacks({fallbacks:[d]});return ra.from([{raw:u},m]).withConfig({runName:"StructuredOutputRunnable"})}}class Pc extends ia{parseResultWithPrompt(e,t,s){return this.parseResult(e,s)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(s,a)=>this.parseResult([{text:s}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(s,a)=>this.parseResult([{message:s,text:this._baseMessageToString(s)}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"})}}class Ec extends Pc{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,s){return this.parse(e,s)}_type(){throw new Error("_type not implemented")}}class Is extends Error{constructor(e,t,s,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=s,this.sendToLLM=a,a&&(s===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function Ti(n,e){const t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;const s=n.length;if(s!==e.length)return!1;for(let a=0;a<s;a++)if(!Ti(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;const s=Object.keys(n),a=Object.keys(e);if(s.length!==a.length)return!1;for(const i of s)if(!Ti(n[i],e[i]))return!1;return!0}return n===e}class ud extends Ec{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Cc extends ud{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,s;for await(const a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let i;if(p0(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");i=new Qt({message:a,text:a.content})}else if($u(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");i=new Qt({message:h0(a),text:a.content})}else i=new d0({text:a});s===void 0?s=i:s=s.concat(i);const r=await this.parsePartialResult([s]);r!=null&&!Ti(r,t)&&(this.diff?yield this._diff(t,r):yield r,t=r)}}getFormatInstructions(){return""}}class Ni extends Ec{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Ot.object(Object.fromEntries(Object.entries(e).map(([s,a])=>[s,Ot.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Gi(this.schema))}
\`\`\`
`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(s,a)=>`"${a.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new Is(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class Ii extends Cc{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Ju(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Lu(e[0].text)}async parse(e){return Lu(e,JSON.parse)}getFormatInstructions(){return""}}function ji(n,e){if(n.function===void 0)return;let t;if(e!=null&&e.partial)try{t=m0(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(a){throw new Is([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${a.message}`].join(`
`))}const s={name:n.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(s.id=n.id),s}function Sc(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function kc(n,e){var t,s;return{name:(t=n.function)==null?void 0:t.name,args:(s=n.function)==null?void 0:s.arguments,id:n.id,error:e,type:"invalid_tool_call"}}class pd extends Cc{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var r;const s=e[0].message;let a;if(oa(s)&&((r=s.tool_calls)!=null&&r.length)?a=s.tool_calls.map(o=>{const{id:c,...l}=o;return this.returnId?{id:c,...l}:l}):s.additional_kwargs.tool_calls!==void 0&&(a=JSON.parse(JSON.stringify(s.additional_kwargs.tool_calls)).map(o=>ji(o,{returnId:this.returnId,partial:t}))),!a)return[];const i=[];for(const o of a)if(o!==void 0){const c={type:o.name,args:o.args,id:o.id};i.push(c)}return i}}class js extends pd{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Is(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(a=>a.type===this.keyName);let s=t;if(t.length)return this.returnId||(s=t.map(a=>a.args)),this.returnSingle?s[0]:s}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName);let s=t;return t.length?(this.returnId||(s=t.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}}const hd=Symbol("Let zodToJsonSchema decide on which parser to use"),dd={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},md=n=>({...dd,...n}),fd=n=>{const e=md(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([s,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function Tc(n,e,t,s){s!=null&&s.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ne(n,e,t,s,a){n[e]=t,Tc(n,e,s,a)}function yd(){return{}}function gd(n,e){var s,a;const t={type:"array"};return((a=(s=n.type)==null?void 0:s._def)==null?void 0:a.typeName)!==w.ZodAny&&(t.items=Y(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ne(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ne(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ne(t,"minItems",n.exactLength.value,n.exactLength.message,e),ne(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function bd(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?ne(t,"minimum",s.value,s.message,e):ne(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),ne(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?ne(t,"maximum",s.value,s.message,e):ne(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),ne(t,"maximum",s.value,s.message,e));break;case"multipleOf":ne(t,"multipleOf",s.value,s.message,e);break}return t}function wd(){return{type:"boolean"}}function vd(n,e){return Y(n.type._def,e)}const xd=(n,e)=>Y(n.innerType._def,e);function Nc(n,e,t){const s=t??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,i)=>Nc(n,e,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return _d(n,e)}}const _d=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const s of n.checks)switch(s.kind){case"min":ne(t,"minimum",s.value,s.message,e);break;case"max":ne(t,"maximum",s.value,s.message,e);break}return t};function Od(n,e){return{...Y(n.innerType._def,e),default:n.defaultValue()}}function Md(n,e){return e.effectStrategy==="input"?Y(n.schema._def,e):{}}function Ad(n){return{type:"string",enum:n.values}}const Pd=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Ed(n,e){const t=[Y(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),Y(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(i=>{if(Pd(i))a.push(...i.allOf),i.unevaluatedProperties===void 0&&(s=void 0);else{let r=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;r=c}else s=void 0;a.push(r)}}),a.length?{allOf:a,...s}:void 0}function Cd(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Ri;const Gt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ri===void 0&&(Ri=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ri),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Ic(n,e){const t={type:"string"};function s(a){return e.patternStrategy==="escape"?Sd(a):a}if(n.checks)for(const a of n.checks)switch(a.kind){case"min":ne(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":ne(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":pt(t,"email",a.message,e);break;case"format:idn-email":pt(t,"idn-email",a.message,e);break;case"pattern:zod":ht(t,Gt.email,a.message,e);break}break;case"url":pt(t,"uri",a.message,e);break;case"uuid":pt(t,"uuid",a.message,e);break;case"regex":ht(t,a.regex,a.message,e);break;case"cuid":ht(t,Gt.cuid,a.message,e);break;case"cuid2":ht(t,Gt.cuid2,a.message,e);break;case"startsWith":ht(t,RegExp(`^${s(a.value)}`),a.message,e);break;case"endsWith":ht(t,RegExp(`${s(a.value)}$`),a.message,e);break;case"datetime":pt(t,"date-time",a.message,e);break;case"date":pt(t,"date",a.message,e);break;case"time":pt(t,"time",a.message,e);break;case"duration":pt(t,"duration",a.message,e);break;case"length":ne(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),ne(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{ht(t,RegExp(s(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&pt(t,"ipv4",a.message,e),a.version!=="v4"&&pt(t,"ipv6",a.message,e);break}case"emoji":ht(t,Gt.emoji,a.message,e);break;case"ulid":{ht(t,Gt.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{pt(t,"binary",a.message,e);break}case"contentEncoding:base64":{ne(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{ht(t,Gt.base64,a.message,e);break}}break}case"nanoid":ht(t,Gt.nanoid,a.message,e)}return t}const Sd=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),pt=(n,e,t,s)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(i=>i.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&s.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&s.errorMessages&&{errorMessage:{format:t}}})):ne(n,"format",e,t,s)},ht=(n,e,t,s)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&s.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:jc(e,s),...t&&s.errorMessages&&{errorMessage:{pattern:t}}})):ne(n,"pattern",jc(e,s),t,s)},jc=(n,e)=>{var l;const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const s={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=s.i?t.source.toLowerCase():t.source;let i="",r=!1,o=!1,c=!1;for(let u=0;u<a.length;u++){if(r){i+=a[u],r=!1;continue}if(s.i){if(o){if(a[u].match(/[a-z]/)){c?(i+=a[u],i+=`${a[u-2]}-${a[u]}`.toUpperCase(),c=!1):a[u+1]==="-"&&((l=a[u+2])!=null&&l.match(/[a-z]/))?(i+=a[u],c=!0):i+=`${a[u]}${a[u].toUpperCase()}`;continue}}else if(a[u].match(/[a-z]/)){i+=`[${a[u]}${a[u].toUpperCase()}]`;continue}}if(s.m){if(a[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(a[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(s.s&&a[u]==="."){i+=o?`${a[u]}\r
`:`[${a[u]}\r
]`;continue}i+=a[u],a[u]==="\\"?r=!0:o&&a[u]==="]"?o=!1:!o&&a[u]==="["&&(o=!0)}try{const u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i};function Rc(n,e){var s,a,i,r;if(e.target==="openApi3"&&((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,c)=>({...o,[c]:Y(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:Y(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){const o=Object.entries(Ic(n.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...t,propertyNames:o}}else if(((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function kd(n,e){if(e.mapStrategy==="record")return Rc(n,e);const t=Y(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=Y(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,s],minItems:2,maxItems:2}}}function Td(n){const e=n.values,t=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(t.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:t}}function Nd(){return{not:{}}}function Id(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Rs={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function jd(n,e){if(e.target==="openApi3")return $c(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(s=>s._def.typeName in Rs&&(!s._def.checks||!s._def.checks.length))){const s=t.reduce((a,i)=>{const r=Rs[i._def.typeName];return r&&!a.includes(r)?[...a,r]:a},[]);return{type:s.length>1?s:s[0]}}else if(t.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=t.reduce((a,i)=>{const r=typeof i._def.value;switch(r){case"string":case"number":case"boolean":return[...a,r];case"bigint":return[...a,"integer"];case"object":if(i._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(s.length===t.length){const a=s.filter((i,r,o)=>o.indexOf(i)===r);return{type:a.length>1?a:a[0],enum:t.reduce((i,r)=>i.includes(r._def.value)?i:[...i,r._def.value],[])}}}else if(t.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((s,a)=>[...s,...a._def.values.filter(i=>!s.includes(i))],[])};return $c(n,e)}const $c=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((s,a)=>Y(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return t.length?{anyOf:t}:void 0};function Rd(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Rs[n.innerType._def.typeName],nullable:!0}:{type:[Rs[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=Y(n.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const t=Y(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function $d(n,e){const t={type:"number"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"int":t.type="integer",Tc(t,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?ne(t,"minimum",s.value,s.message,e):ne(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),ne(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?ne(t,"maximum",s.value,s.message,e):ne(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),ne(t,"maximum",s.value,s.message,e));break;case"multipleOf":ne(t,"multipleOf",s.value,s.message,e);break}return t}function Ld(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":Y(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":Y(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Bd(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((s,[a,i])=>{if(i===void 0||i._def===void 0)return s;const r=Y(i._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return r===void 0?s:{properties:{...s.properties,[a]:r},required:i.isOptional()?s.required:[...s.required,a]}},{properties:{},required:[]}),additionalProperties:Ld(n,e)};return t.required.length||delete t.required,t}const Fd=(n,e)=>{var s;if(e.currentPath.toString()===((s=e.propertyPath)==null?void 0:s.toString()))return Y(n.innerType._def,e);const t=Y(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},qd=(n,e)=>{if(e.pipeStrategy==="input")return Y(n.in._def,e);if(e.pipeStrategy==="output")return Y(n.out._def,e);const t=Y(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=Y(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,s].filter(a=>a!==void 0)}};function Dd(n,e){return Y(n.type._def,e)}function Ud(n,e){const t={type:"array",uniqueItems:!0,items:Y(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ne(t,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ne(t,"maxItems",n.maxSize.value,n.maxSize.message,e),t}function Wd(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,s)=>Y(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[]),additionalItems:Y(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,s)=>Y(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[])}}function zd(){return{not:{}}}function Zd(){return{}}const Vd=(n,e)=>Y(n.innerType._def,e);function Y(n,e,t=!1){var r;const s=e.seen.get(n);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,n,e,s,t);if(o!==hd)return o}if(s&&!t){const o=Kd(s,e);if(o!==void 0)return o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const i=Hd(n,n.typeName,e);return i&&Jd(n,e,i),a.jsonSchema=i,i}const Kd=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Qd(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,s)=>e.currentPath[s]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Qd=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Hd=(n,e,t)=>{switch(e){case w.ZodString:return Ic(n,t);case w.ZodNumber:return $d(n,t);case w.ZodObject:return Bd(n,t);case w.ZodBigInt:return bd(n,t);case w.ZodBoolean:return wd();case w.ZodDate:return Nc(n,t);case w.ZodUndefined:return zd();case w.ZodNull:return Id(t);case w.ZodArray:return gd(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return jd(n,t);case w.ZodIntersection:return Ed(n,t);case w.ZodTuple:return Wd(n,t);case w.ZodRecord:return Rc(n,t);case w.ZodLiteral:return Cd(n,t);case w.ZodEnum:return Ad(n);case w.ZodNativeEnum:return Td(n);case w.ZodNullable:return Rd(n,t);case w.ZodOptional:return Fd(n,t);case w.ZodMap:return kd(n,t);case w.ZodSet:return Ud(n,t);case w.ZodLazy:return Y(n.getter()._def,t);case w.ZodPromise:return Dd(n,t);case w.ZodNaN:case w.ZodNever:return Nd();case w.ZodEffects:return Md(n,t);case w.ZodAny:return yd();case w.ZodUnknown:return Zd();case w.ZodDefault:return Od(n,t);case w.ZodBranded:return vd(n,t);case w.ZodReadonly:return Vd(n,t);case w.ZodCatch:return xd(n,t);case w.ZodPipeline:return qd(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(s=>{})()}},Jd=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),Gd=(n,e)=>{const t=fd(e),s=void 0,a=e==null?void 0:e.name,i=Y(n._def,t,!1)??{},r=a===void 0?s?{...i,[t.definitionPath]:s}:i:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...s,[a]:i}};return t.target==="jsonSchema7"?r.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(r.$schema="https://json-schema.org/draft/2019-09/schema#"),r},Xd=Symbol("Let zodToJsonSchema decide on which parser to use"),Lc={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Yd=n=>typeof n=="string"?{...Lc,basePath:["#"],definitions:{},name:n}:{...Lc,basePath:["#"],definitions:{},...n},$i=n=>"_def"in n?n._def:n;function em(n){if(!n)return!0;for(const e in n)return!1;return!0}const tm=n=>{const e=Yd(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([s,a])=>[$i(a),{def:$i(a),path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function Bc(n,e,t,s){s!=null&&s.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function se(n,e,t,s,a){n[e]=t,Bc(n,e,s,a)}function nm(){return{}}function sm(n,e){var s,a;const t={type:"array"};return((a=(s=n.type)==null?void 0:s._def)==null?void 0:a.typeName)!==w.ZodAny&&(t.items=G(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&se(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&se(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(se(t,"minItems",n.exactLength.value,n.exactLength.message,e),se(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function am(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?se(t,"minimum",s.value,s.message,e):se(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),se(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?se(t,"maximum",s.value,s.message,e):se(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),se(t,"maximum",s.value,s.message,e));break;case"multipleOf":se(t,"multipleOf",s.value,s.message,e);break}return t}function im(){return{type:"boolean"}}function rm(n,e){return G(n.type._def,e)}const om=(n,e)=>G(n.innerType._def,e);function Fc(n,e,t){const s=t??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,i)=>Fc(n,e,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return cm(n,e)}}const cm=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const s of n.checks)switch(s.kind){case"min":se(t,"minimum",s.value,s.message,e);break;case"max":se(t,"maximum",s.value,s.message,e);break}return t};function lm(n,e){return{...G(n.innerType._def,e),default:n.defaultValue()}}function um(n,e,t){return e.effectStrategy==="input"?G(n.schema._def,e,t):{}}function pm(n){return{type:"string",enum:[...n.values]}}const hm=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function dm(n,e){const t=[G(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),G(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(i=>{if(hm(i))a.push(...i.allOf),i.unevaluatedProperties===void 0&&(s=void 0);else{let r=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;r=c}else s=void 0;a.push(r)}}),a.length?{allOf:a,...s}:void 0}function mm(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Li;const Xt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Li===void 0&&(Li=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Li),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function qc(n,e){const t={type:"string"};function s(a){return e.patternStrategy==="escape"?fm(a):a}if(n.checks)for(const a of n.checks)switch(a.kind){case"min":se(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":se(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":dt(t,"email",a.message,e);break;case"format:idn-email":dt(t,"idn-email",a.message,e);break;case"pattern:zod":mt(t,Xt.email,a.message,e);break}break;case"url":dt(t,"uri",a.message,e);break;case"uuid":dt(t,"uuid",a.message,e);break;case"regex":mt(t,a.regex,a.message,e);break;case"cuid":mt(t,Xt.cuid,a.message,e);break;case"cuid2":mt(t,Xt.cuid2,a.message,e);break;case"startsWith":mt(t,RegExp(`^${s(a.value)}`),a.message,e);break;case"endsWith":mt(t,RegExp(`${s(a.value)}$`),a.message,e);break;case"datetime":dt(t,"date-time",a.message,e);break;case"date":dt(t,"date",a.message,e);break;case"time":dt(t,"time",a.message,e);break;case"duration":dt(t,"duration",a.message,e);break;case"length":se(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),se(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{mt(t,RegExp(s(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&dt(t,"ipv4",a.message,e),a.version!=="v4"&&dt(t,"ipv6",a.message,e);break}case"emoji":mt(t,Xt.emoji,a.message,e);break;case"ulid":{mt(t,Xt.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{dt(t,"binary",a.message,e);break}case"contentEncoding:base64":{se(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{mt(t,Xt.base64,a.message,e);break}}break}case"nanoid":mt(t,Xt.nanoid,a.message,e)}return t}const fm=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),dt=(n,e,t,s)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(i=>i.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&s.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&s.errorMessages&&{errorMessage:{format:t}}})):se(n,"format",e,t,s)},mt=(n,e,t,s)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&s.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Dc(e,s),...t&&s.errorMessages&&{errorMessage:{pattern:t}}})):se(n,"pattern",Dc(e,s),t,s)},Dc=(n,e)=>{var l;const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const s={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=s.i?t.source.toLowerCase():t.source;let i="",r=!1,o=!1,c=!1;for(let u=0;u<a.length;u++){if(r){i+=a[u],r=!1;continue}if(s.i){if(o){if(a[u].match(/[a-z]/)){c?(i+=a[u],i+=`${a[u-2]}-${a[u]}`.toUpperCase(),c=!1):a[u+1]==="-"&&((l=a[u+2])!=null&&l.match(/[a-z]/))?(i+=a[u],c=!0):i+=`${a[u]}${a[u].toUpperCase()}`;continue}}else if(a[u].match(/[a-z]/)){i+=`[${a[u]}${a[u].toUpperCase()}]`;continue}}if(s.m){if(a[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(a[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(s.s&&a[u]==="."){i+=o?`${a[u]}\r
`:`[${a[u]}\r
]`;continue}i+=a[u],a[u]==="\\"?r=!0:o&&a[u]==="]"?o=!1:!o&&a[u]==="["&&(o=!0)}try{const u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i};function Uc(n,e){var s,a,i,r;if(e.target==="openApi3"&&((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,c)=>({...o,[c]:G(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:G(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){const o=Object.entries(qc(n.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...t,propertyNames:o}}else if(((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function ym(n,e){if(e.mapStrategy==="record")return Uc(n,e);const t=G(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=G(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,s],minItems:2,maxItems:2}}}function gm(n){const e=n.values,t=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(t.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:t}}function bm(){return{not:{}}}function wm(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const $s={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function vm(n,e){if(e.target==="openApi3")return Wc(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(s=>s._def.typeName in $s&&(!s._def.checks||!s._def.checks.length))){const s=t.reduce((a,i)=>{const r=$s[i._def.typeName];return r&&!a.includes(r)?[...a,r]:a},[]);return{type:s.length>1?s:s[0]}}else if(t.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=t.reduce((a,i)=>{const r=typeof i._def.value;switch(r){case"string":case"number":case"boolean":return[...a,r];case"bigint":return[...a,"integer"];case"object":if(i._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(s.length===t.length){const a=s.filter((i,r,o)=>o.indexOf(i)===r);return{type:a.length>1?a:a[0],enum:t.reduce((i,r)=>i.includes(r._def.value)?i:[...i,r._def.value],[])}}}else if(t.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((s,a)=>[...s,...a._def.values.filter(i=>!s.includes(i))],[])};return Wc(n,e)}const Wc=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((s,a)=>G(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return t.length?{anyOf:t}:void 0};function xm(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:$s[n.innerType._def.typeName],nullable:!0}:{type:[$s[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=G(n.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const t=G(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function _m(n,e){const t={type:"number"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"int":t.type="integer",Bc(t,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?se(t,"minimum",s.value,s.message,e):se(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),se(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?se(t,"maximum",s.value,s.message,e):se(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),se(t,"maximum",s.value,s.message,e));break;case"multipleOf":se(t,"multipleOf",s.value,s.message,e);break}return t}function Om(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":G(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":G(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Mm(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((s,[a,i])=>{if(i===void 0||i._def===void 0)return s;const r=G(i._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return r===void 0?s:{properties:{...s.properties,[a]:r},required:i.isOptional()&&!e.openaiStrictMode?s.required:[...s.required,a]}},{properties:{},required:[]}),additionalProperties:Om(n,e)};return t.required.length||delete t.required,t}const Am=(n,e)=>{var s;if(e.currentPath.toString()===((s=e.propertyPath)==null?void 0:s.toString()))return G(n.innerType._def,e);const t=G(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Pm=(n,e)=>{if(e.pipeStrategy==="input")return G(n.in._def,e);if(e.pipeStrategy==="output")return G(n.out._def,e);const t=G(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=G(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,s].filter(a=>a!==void 0)}};function Em(n,e){return G(n.type._def,e)}function Cm(n,e){const t={type:"array",uniqueItems:!0,items:G(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&se(t,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&se(t,"maxItems",n.maxSize.value,n.maxSize.message,e),t}function Sm(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,s)=>G(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[]),additionalItems:G(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,s)=>G(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[])}}function km(){return{not:{}}}function Tm(){return{}}const Nm=(n,e)=>G(n.innerType._def,e);function G(n,e,t=!1){var r;const s=e.seen.get(n);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,n,e,s,t);if(o!==Xd)return o}if(s&&!t){const o=Im(s,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const i=Rm(n,n.typeName,e,t);return i&&$m(n,e,i),a.jsonSchema=i,i}const Im=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":const t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:jm(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((s,a)=>e.currentPath[a]===s)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},jm=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Rm=(n,e,t,s)=>{switch(e){case w.ZodString:return qc(n,t);case w.ZodNumber:return _m(n,t);case w.ZodObject:return Mm(n,t);case w.ZodBigInt:return am(n,t);case w.ZodBoolean:return im();case w.ZodDate:return Fc(n,t);case w.ZodUndefined:return km();case w.ZodNull:return wm(t);case w.ZodArray:return sm(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return vm(n,t);case w.ZodIntersection:return dm(n,t);case w.ZodTuple:return Sm(n,t);case w.ZodRecord:return Uc(n,t);case w.ZodLiteral:return mm(n,t);case w.ZodEnum:return pm(n);case w.ZodNativeEnum:return gm(n);case w.ZodNullable:return xm(n,t);case w.ZodOptional:return Am(n,t);case w.ZodMap:return ym(n,t);case w.ZodSet:return Cm(n,t);case w.ZodLazy:return G(n.getter()._def,t);case w.ZodPromise:return Em(n,t);case w.ZodNaN:case w.ZodNever:return bm();case w.ZodEffects:return um(n,t,s);case w.ZodAny:return nm();case w.ZodUnknown:return Tm();case w.ZodDefault:return lm(n,t);case w.ZodBranded:return rm(n,t);case w.ZodReadonly:return Nm(n,t);case w.ZodCatch:return om(n,t);case w.ZodPipeline:return Pm(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(a=>{})()}},$m=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),Lm=(n,e)=>{const t=tm(e),s=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,a=G(n._def,s===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,s]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(a.title=i);const r=(()=>{if(em(t.definitions))return;const c={},l=new Set;for(let u=0;u<500;u++){const p=Object.entries(t.definitions).filter(([h])=>!l.has(h));if(p.length===0)break;for(const[h,d]of p)c[h]=G($i(d),{...t,currentPath:[...t.basePath,t.definitionPath,h]},!0)??{},l.add(h)}return c})(),o=s===void 0?r?{...a,[t.definitionPath]:r}:a:t.nameStrategy==="duplicate-ref"?{...a,...r||t.seenRefs.size?{[t.definitionPath]:{...r,...t.seenRefs.size?{[s]:a}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...r,[s]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function zc(n,e){return Lm(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Bm(n,e,t){return Dh({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:zc(n,{name:e})}},s=>n.parse(JSON.parse(s)))}function Fm(n){return Uh({type:"function",function:{name:n.name,parameters:zc(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0}},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))})}or=function(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:s,azureOpenAIBasePath:a,baseURL:i,azureADTokenProvider:r,azureOpenAIEndpoint:o}=n;if((s||r)&&a&&e)return`${a}/${e}`;if((s||r)&&o&&e)return`${o}/openai/deployments/${e}`;if(s||r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i};function Zc(n,e){const t=typeof e=="number"?void 0:e;return{name:n.name,description:n.description,parameters:Gi(n.schema),...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}}function qm(n,e){let t;return Ls(n)?t={type:"function",function:Zc(n)}:t=n,t}function Dm(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function Um(n){return n!==void 0&&ia.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function Wm(n){return!!n&&typeof n=="object"&&"name"in n&&"schema"in n&&Hn(n.schema)}function Ls(n){return Wm(n)||Um(n)||Dm(n)}function Bs(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}ma=function(n){let e;return n.constructor.name===ms.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===tt.name?(e=new Error(n.message),e.name="AbortError"):n.status===400&&n.message.includes("tool_calls")?e=Bs(n,"INVALID_TOOL_RESULTS"):n.status===401?e=Bs(n,"MODEL_AUTHENTICATION"):n.status===429?e=Bs(n,"MODEL_RATE_LIMIT"):n.status===404?e=Bs(n,"MODEL_NOT_FOUND"):e=n,e};function zm(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}function Zm(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function Vm(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Vc(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Vc(n,e){var s;const t=[];for(const[a,i]of Object.entries(n.properties??{}))i.description&&e<2&&t.push(`// ${i.description}`),(s=n.required)!=null&&s.includes(a)?t.push(`${a}: ${Fs(i,e)},`):t.push(`${a}?: ${Fs(i,e)},`);return t.map(a=>" ".repeat(e)+a).join(`
`)}function Fs(n,e){if(Zm(n))return n.anyOf.map(t=>Fs(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Vc(n,e+2),"}"].join(`
`);case"array":return n.items?`${Fs(n.items,e)}[]`:"any[]";default:return""}}function Km(n,e){let t;if(Ls(n)){const s=Fm({name:n.name,parameters:n.schema,description:n.description});s.function.parameters?t={type:s.type,function:{name:s.function.name,description:s.function.description,parameters:s.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:Zc(n,e)}}else t=n;return(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function Qm(n){return n.role!=="system"&&n.role!=="developer"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function Kc(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!la.isInstance(n))throw new Error("Invalid generic chat message");return Qm(n)}default:throw new Error(`Unknown message type: ${e}`)}}function Hm(n,e,t){const s=n.tool_calls;switch(n.role){case"assistant":{const a=[],i=[];for(const c of s??[])try{a.push(ji(c,{returnId:!0}))}catch(l){i.push(kc(c,l.message))}const r={function_call:n.function_call,tool_calls:s};t!==void 0&&(r.__raw_response=e);const o={model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};return n.audio&&(r.audio=n.audio),new ca({content:n.content||"",tool_calls:a,invalid_tool_calls:i,additional_kwargs:r,response_metadata:o,id:e.id})}default:return new la(n.content||"",n.role??"unknown")}}function Jm(n,e,t,s){var c,l;const a=n.role??t,i=n.content??"";let r;n.function_call?r={function_call:n.function_call}:n.tool_calls?r={tool_calls:n.tool_calls}:r={},s&&(r.__raw_response=e),n.audio&&(r.audio={...n.audio,index:e.choices[0].index});const o={usage:{...e.usage}};if(a==="user")return new Bu({content:i,response_metadata:o});if(a==="assistant"){const u=[];if(Array.isArray(n.tool_calls))for(const p of n.tool_calls)u.push({name:(c=p.function)==null?void 0:c.name,args:(l=p.function)==null?void 0:l.arguments,id:p.id,index:p.index,type:"tool_call_chunk"});return new Sn({content:i,tool_call_chunks:u,additional_kwargs:r,id:e.id,response_metadata:o})}else return a==="system"?new Xi({content:i,response_metadata:o}):a==="developer"?new Xi({content:i,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):a==="function"?new f0({content:i,additional_kwargs:r,name:n.name,response_metadata:o}):a==="tool"?new y0({content:i,additional_kwargs:r,tool_call_id:n.tool_call_id,response_metadata:o}):new Fu({content:i,role:a,response_metadata:o})}function Qc(n,e){return n.flatMap(t=>{var i;let s=Kc(t);s==="system"&&(e!=null&&e.startsWith("o1"))&&(s="developer");const a={role:s,content:t.content};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=null),oa(t)&&((i=t.tool_calls)!=null&&i.length)?(a.tool_calls=t.tool_calls.map(Sc),a.content=null):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const r={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,r]}return a})}function Hc(n,e){return ki(n)?(e==null?void 0:e.strict)!==void 0?{...n,function:{...n.function,strict:e.strict}}:n:Km(n,e)}class Gm extends kt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var s,a,i,r,o,c,l,u,p;if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((s=e==null?void 0:e.configuration)==null?void 0:s.apiKey)??Rt("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??Rt("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=(e==null?void 0:e.azureADTokenProvider)??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??Rt("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??Rt("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??Rt("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??Rt("AZURE_OPENAI_BASE_PATH"),this.organization=((a=e==null?void 0:e.configuration)==null?void 0:a.organization)??Rt("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=(e==null?void 0:e.azureOpenAIEndpoint)??Rt("AZURE_OPENAI_ENDPOINT"),this.modelName=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.model=this.modelName,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){const h=this.azureOpenAIBasePath.split("/openai/deployments/");if(h.length===2){const[,d]=h;this.azureOpenAIApiDeploymentName=d}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.model==="o1"&&(this.disableStreaming=!0),this.streaming=(e==null?void 0:e.streaming)??!1,this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:(t==null?void 0:t.basePath)??((i=e==null?void 0:e.configuration)==null?void 0:i.basePath),dangerouslyAllowBrowser:!0,defaultHeaders:((r=t==null?void 0:t.baseOptions)==null?void 0:r.headers)??((c=(o=e==null?void 0:e.configuration)==null?void 0:o.baseOptions)==null?void 0:c.headers),defaultQuery:((l=t==null?void 0:t.baseOptions)==null?void 0:l.params)??((p=(u=e==null?void 0:e.configuration)==null?void 0:u.baseOptions)==null?void 0:p.params),...t,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let s;return(t==null?void 0:t.strict)!==void 0?s=t.strict:this.supportsStrictToolCalling!==void 0&&(s=this.supportsStrictToolCalling),this.bind({tools:e.map(a=>Hc(a,{strict:s})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&qs(e.json_schema.schema)?Bm(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){var o;let s;(e==null?void 0:e.strict)!==void 0?s=e.strict:this.supportsStrictToolCalling!==void 0&&(s=this.supportsStrictToolCalling);let a={};(e==null?void 0:e.stream_options)!==void 0?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(a={stream_options:{include_usage:!0}});const i={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(o=e==null?void 0:e.tools)!=null&&o.length?e.tools.map(c=>Hc(c,{strict:s})):void 0,tool_choice:zm(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...a,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(i.prediction=e.prediction);const r=(e==null?void 0:e.reasoning_effort)??this.reasoningEffort;return r!==void 0&&(i.reasoning_effort=r),i}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,s){var l,u,p,h,d,m,f,y,g,v;const a=Qc(e,this.model),i={...this.invocationParams(t,{streaming:!0}),messages:a,stream:!0};let r;const o=await this.completionWithRetry(i,t);let c;for await(const O of o){const A=(l=O==null?void 0:O.choices)==null?void 0:l[0];if(O.usage&&(c=O.usage),!A)continue;const{delta:T}=A;if(!T)continue;const C=Jm(T,O,r,this.__includeRawResponse);r=T.role??r;const W={prompt:t.promptIndex??0,completion:A.index??0};if(typeof C.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const D={...W};A.finish_reason!=null&&(D.finish_reason=A.finish_reason,D.system_fingerprint=O.system_fingerprint,D.model_name=O.model),this.logprobs&&(D.logprobs=A.logprobs);const B=new Qt({message:C,text:C.content,generationInfo:D});yield B,await(s==null?void 0:s.handleLLMNewToken(B.text??"",W,void 0,void 0,void 0,{chunk:B}))}if(c){const O={...((u=c.prompt_tokens_details)==null?void 0:u.audio_tokens)!==null&&{audio:(p=c.prompt_tokens_details)==null?void 0:p.audio_tokens},...((h=c.prompt_tokens_details)==null?void 0:h.cached_tokens)!==null&&{cache_read:(d=c.prompt_tokens_details)==null?void 0:d.cached_tokens}},A={...((m=c.completion_tokens_details)==null?void 0:m.audio_tokens)!==null&&{audio:(f=c.completion_tokens_details)==null?void 0:f.audio_tokens},...((y=c.completion_tokens_details)==null?void 0:y.reasoning_tokens)!==null&&{reasoning:(g=c.completion_tokens_details)==null?void 0:g.reasoning_tokens}};yield new Qt({message:new Sn({content:"",response_metadata:{usage:{...c}},usage_metadata:{input_tokens:c.prompt_tokens,output_tokens:c.completion_tokens,total_tokens:c.total_tokens,...Object.keys(O).length>0&&{input_token_details:O},...Object.keys(A).length>0&&{output_token_details:A}}}),text:""})}if((v=t.signal)!=null&&v.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,s){var o,c;const a={},i=this.invocationParams(t),r=Qc(e,this.model);if(i.stream){const l=this._streamResponseChunks(e,t,s),u={};for await(const y of l){y.message.response_metadata={...y.generationInfo,...y.message.response_metadata};const g=((o=y.generationInfo)==null?void 0:o.completion)??0;u[g]===void 0?u[g]=y:u[g]=u[g].concat(y)}const p=Object.entries(u).sort(([y],[g])=>parseInt(y,10)-parseInt(g,10)).map(([y,g])=>g),{functions:h,function_call:d}=this.invocationParams(t),m=await this.getEstimatedTokenCountFromPrompt(e,h,d),f=await this.getNumTokensFromGenerations(p);return a.input_tokens=m,a.output_tokens=f,a.total_tokens=m+f,{generations:p,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}else{let l;t.response_format&&t.response_format.type==="json_schema"?l=await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:r},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):l=await this.completionWithRetry({...i,stream:!1,messages:r},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});const{completion_tokens:u,prompt_tokens:p,total_tokens:h,prompt_tokens_details:d,completion_tokens_details:m}=(l==null?void 0:l.usage)??{};u&&(a.output_tokens=(a.output_tokens??0)+u),p&&(a.input_tokens=(a.input_tokens??0)+p),h&&(a.total_tokens=(a.total_tokens??0)+h),((d==null?void 0:d.audio_tokens)!==null||(d==null?void 0:d.cached_tokens)!==null)&&(a.input_token_details={...(d==null?void 0:d.audio_tokens)!==null&&{audio:d==null?void 0:d.audio_tokens},...(d==null?void 0:d.cached_tokens)!==null&&{cache_read:d==null?void 0:d.cached_tokens}}),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.reasoning_tokens)!==null)&&(a.output_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.reasoning_tokens)!==null&&{reasoning:m==null?void 0:m.reasoning_tokens}});const f=[];for(const y of(l==null?void 0:l.choices)??[]){const g={text:((c=y.message)==null?void 0:c.content)??"",message:Hm(y.message??{role:"assistant"},l,this.__includeRawResponse)};g.generationInfo={...y.finish_reason?{finish_reason:y.finish_reason}:{},...y.logprobs?{logprobs:y.logprobs}:{}},oa(g.message)&&(g.message.usage_metadata=a),g.message=new ca(Object.fromEntries(Object.entries(g.message).filter(([v])=>!v.startsWith("lc_")))),f.push(g)}return{generations:f,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,s){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&s!=="auto"){const i=Vm(t);a+=await this.getNumTokens(i),a+=9}return t&&e.find(i=>i._getType()==="system")&&(a-=4),s==="none"?a+=1:typeof s=="object"&&(a+=await this.getNumTokens(s.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async t=>{var s;return(s=t.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([t.message])).countPerMessage[0]:await this.getNumTokens(t.message.content)}))).reduce((t,s)=>t+s,0)}async getNumTokensFromMessages(e){let t=0,s=0,a=0;this.model==="gpt-3.5-turbo-0301"?(s=4,a=-1):(s=3,a=1);const i=await Promise.all(e.map(async r=>{var h,d,m,f,y,g;const o=await this.getNumTokens(r.content),c=await this.getNumTokens(Kc(r)),l=r.name!==void 0?a+await this.getNumTokens(r.name):0;let u=o+s+c+l;const p=r;if(p._getType()==="function"&&(u-=2),(h=p.additional_kwargs)!=null&&h.function_call&&(u+=3),(d=p==null?void 0:p.additional_kwargs.function_call)!=null&&d.name&&(u+=await this.getNumTokens((m=p.additional_kwargs.function_call)==null?void 0:m.name)),(f=p.additional_kwargs.function_call)==null?void 0:f.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse((y=p.additional_kwargs.function_call)==null?void 0:y.arguments)))}catch(v){console.error("Error parsing function arguments",v,JSON.stringify(p.additional_kwargs.function_call)),u+=await this.getNumTokens((g=p.additional_kwargs.function_call)==null?void 0:g.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const s=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,s)}catch(a){throw ma(a)}})}async betaParsedCompletionWithRetry(e,t){const s=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,s)}catch(a){throw ma(a)}})}_getClientOptions(e){if(!this.client){const s={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},a=or(s),i={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new H(i)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,s)=>(s&&s.tokenUsage&&(t.tokenUsage.completionTokens+=s.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=s.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=s.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let s,a,i,r;Xm(e)?(s=e.schema,a=e.name,i=e.method,r=e.includeRaw):(s=e,a=t==null?void 0:t.name,i=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw);let o,c;if((t==null?void 0:t.strict)!==void 0&&i==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(i==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),qs(s)?c=Ni.fromZodSchema(s):c=new Ii;else if(i==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:a??"extract",description:s.description,schema:s,strict:t==null?void 0:t.strict}}}),qs(s)?c=Ni.fromZodSchema(s):c=new Ii;else{let h=a??"extract";if(qs(s)){const d=Gd(s);o=this.bind({tools:[{type:"function",function:{name:h,description:d.description,parameters:d}}],tool_choice:{type:"function",function:{name:h}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new js({returnSingle:!0,keyName:h,zodSchema:s})}else{let d;typeof s.name=="string"&&typeof s.parameters=="object"&&s.parameters!=null?(d=s,h=s.name):(h=s.title??h,d={name:h,description:s.description??"",parameters:s}),o=this.bind({tools:[{type:"function",function:d}],tool_choice:{type:"function",function:{name:h}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),c=new js({returnSingle:!0,keyName:h})}}if(!r)return o.pipe(c);const l=Dt.assign({parsed:(h,d)=>c.invoke(h.raw,d)}),u=Dt.assign({parsed:()=>null}),p=l.withFallbacks({fallbacks:[u]});return ra.from([{raw:o},p])}}function qs(n){return typeof(n==null?void 0:n.parse)=="function"}function Xm(n){return n!==void 0&&typeof n.schema=="object"}const Ym=Symbol("Let zodToJsonSchema decide on which parser to use"),ef={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},tf=n=>({...ef,...n}),nf=n=>{const e=tf(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([s,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function Jc(n,e,t,s){s!=null&&s.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ae(n,e,t,s,a){n[e]=t,Jc(n,e,s,a)}function sf(){return{}}function af(n,e){var s,a;const t={type:"array"};return((a=(s=n.type)==null?void 0:s._def)==null?void 0:a.typeName)!==w.ZodAny&&(t.items=ee(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ae(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ae(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ae(t,"minItems",n.exactLength.value,n.exactLength.message,e),ae(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function rf(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?ae(t,"minimum",s.value,s.message,e):ae(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),ae(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?ae(t,"maximum",s.value,s.message,e):ae(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),ae(t,"maximum",s.value,s.message,e));break;case"multipleOf":ae(t,"multipleOf",s.value,s.message,e);break}return t}function of(){return{type:"boolean"}}function cf(n,e){return ee(n.type._def,e)}const lf=(n,e)=>ee(n.innerType._def,e);function Gc(n,e,t){const s=t??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,i)=>Gc(n,e,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return uf(n,e)}}const uf=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const s of n.checks)switch(s.kind){case"min":ae(t,"minimum",s.value,s.message,e);break;case"max":ae(t,"maximum",s.value,s.message,e);break}return t};function pf(n,e){return{...ee(n.innerType._def,e),default:n.defaultValue()}}function hf(n,e){return e.effectStrategy==="input"?ee(n.schema._def,e):{}}function df(n){return{type:"string",enum:n.values}}const mf=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function ff(n,e){const t=[ee(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),ee(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(i=>{if(mf(i))a.push(...i.allOf),i.unevaluatedProperties===void 0&&(s=void 0);else{let r=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;r=c}else s=void 0;a.push(r)}}),a.length?{allOf:a,...s}:void 0}function yf(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Bi;const Yt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Bi===void 0&&(Bi=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Bi),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Xc(n,e){const t={type:"string"};function s(a){return e.patternStrategy==="escape"?gf(a):a}if(n.checks)for(const a of n.checks)switch(a.kind){case"min":ae(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":ae(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":ft(t,"email",a.message,e);break;case"format:idn-email":ft(t,"idn-email",a.message,e);break;case"pattern:zod":yt(t,Yt.email,a.message,e);break}break;case"url":ft(t,"uri",a.message,e);break;case"uuid":ft(t,"uuid",a.message,e);break;case"regex":yt(t,a.regex,a.message,e);break;case"cuid":yt(t,Yt.cuid,a.message,e);break;case"cuid2":yt(t,Yt.cuid2,a.message,e);break;case"startsWith":yt(t,RegExp(`^${s(a.value)}`),a.message,e);break;case"endsWith":yt(t,RegExp(`${s(a.value)}$`),a.message,e);break;case"datetime":ft(t,"date-time",a.message,e);break;case"date":ft(t,"date",a.message,e);break;case"time":ft(t,"time",a.message,e);break;case"duration":ft(t,"duration",a.message,e);break;case"length":ae(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),ae(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{yt(t,RegExp(s(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&ft(t,"ipv4",a.message,e),a.version!=="v4"&&ft(t,"ipv6",a.message,e);break}case"emoji":yt(t,Yt.emoji,a.message,e);break;case"ulid":{yt(t,Yt.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{ft(t,"binary",a.message,e);break}case"contentEncoding:base64":{ae(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{yt(t,Yt.base64,a.message,e);break}}break}case"nanoid":yt(t,Yt.nanoid,a.message,e)}return t}const gf=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),ft=(n,e,t,s)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(i=>i.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&s.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&s.errorMessages&&{errorMessage:{format:t}}})):ae(n,"format",e,t,s)},yt=(n,e,t,s)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&s.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Yc(e,s),...t&&s.errorMessages&&{errorMessage:{pattern:t}}})):ae(n,"pattern",Yc(e,s),t,s)},Yc=(n,e)=>{var l;const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const s={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=s.i?t.source.toLowerCase():t.source;let i="",r=!1,o=!1,c=!1;for(let u=0;u<a.length;u++){if(r){i+=a[u],r=!1;continue}if(s.i){if(o){if(a[u].match(/[a-z]/)){c?(i+=a[u],i+=`${a[u-2]}-${a[u]}`.toUpperCase(),c=!1):a[u+1]==="-"&&((l=a[u+2])!=null&&l.match(/[a-z]/))?(i+=a[u],c=!0):i+=`${a[u]}${a[u].toUpperCase()}`;continue}}else if(a[u].match(/[a-z]/)){i+=`[${a[u]}${a[u].toUpperCase()}]`;continue}}if(s.m){if(a[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(a[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(s.s&&a[u]==="."){i+=o?`${a[u]}\r
`:`[${a[u]}\r
]`;continue}i+=a[u],a[u]==="\\"?r=!0:o&&a[u]==="]"?o=!1:!o&&a[u]==="["&&(o=!0)}try{const u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i};function el(n,e){var s,a,i,r;if(e.target==="openApi3"&&((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,c)=>({...o,[c]:ee(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:ee(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){const o=Object.entries(Xc(n.keyType._def,e)).reduce((c,[l,u])=>l==="type"?c:{...c,[l]:u},{});return{...t,propertyNames:o}}else if(((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function bf(n,e){if(e.mapStrategy==="record")return el(n,e);const t=ee(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=ee(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,s],minItems:2,maxItems:2}}}function wf(n){const e=n.values,t=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(t.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:t}}function vf(){return{not:{}}}function xf(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ds={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function _f(n,e){if(e.target==="openApi3")return tl(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(s=>s._def.typeName in Ds&&(!s._def.checks||!s._def.checks.length))){const s=t.reduce((a,i)=>{const r=Ds[i._def.typeName];return r&&!a.includes(r)?[...a,r]:a},[]);return{type:s.length>1?s:s[0]}}else if(t.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=t.reduce((a,i)=>{const r=typeof i._def.value;switch(r){case"string":case"number":case"boolean":return[...a,r];case"bigint":return[...a,"integer"];case"object":if(i._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(s.length===t.length){const a=s.filter((i,r,o)=>o.indexOf(i)===r);return{type:a.length>1?a:a[0],enum:t.reduce((i,r)=>i.includes(r._def.value)?i:[...i,r._def.value],[])}}}else if(t.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((s,a)=>[...s,...a._def.values.filter(i=>!s.includes(i))],[])};return tl(n,e)}const tl=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((s,a)=>ee(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return t.length?{anyOf:t}:void 0};function Of(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Ds[n.innerType._def.typeName],nullable:!0}:{type:[Ds[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=ee(n.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const t=ee(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Mf(n,e){const t={type:"number"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"int":t.type="integer",Jc(t,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?ae(t,"minimum",s.value,s.message,e):ae(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),ae(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?ae(t,"maximum",s.value,s.message,e):ae(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),ae(t,"maximum",s.value,s.message,e));break;case"multipleOf":ae(t,"multipleOf",s.value,s.message,e);break}return t}function Af(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":ee(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":ee(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Pf(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((s,[a,i])=>{if(i===void 0||i._def===void 0)return s;const r=ee(i._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return r===void 0?s:{properties:{...s.properties,[a]:r},required:i.isOptional()?s.required:[...s.required,a]}},{properties:{},required:[]}),additionalProperties:Af(n,e)};return t.required.length||delete t.required,t}const Ef=(n,e)=>{var s;if(e.currentPath.toString()===((s=e.propertyPath)==null?void 0:s.toString()))return ee(n.innerType._def,e);const t=ee(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Cf=(n,e)=>{if(e.pipeStrategy==="input")return ee(n.in._def,e);if(e.pipeStrategy==="output")return ee(n.out._def,e);const t=ee(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=ee(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,s].filter(a=>a!==void 0)}};function Sf(n,e){return ee(n.type._def,e)}function kf(n,e){const t={type:"array",uniqueItems:!0,items:ee(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ae(t,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ae(t,"maxItems",n.maxSize.value,n.maxSize.message,e),t}function Tf(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,s)=>ee(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[]),additionalItems:ee(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,s)=>ee(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[])}}function Nf(){return{not:{}}}function If(){return{}}const jf=(n,e)=>ee(n.innerType._def,e);function ee(n,e,t=!1){var r;const s=e.seen.get(n);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,n,e,s,t);if(o!==Ym)return o}if(s&&!t){const o=Rf(s,e);if(o!==void 0)return o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const i=Lf(n,n.typeName,e);return i&&Bf(n,e,i),a.jsonSchema=i,i}const Rf=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:$f(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,s)=>e.currentPath[s]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},$f=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Lf=(n,e,t)=>{switch(e){case w.ZodString:return Xc(n,t);case w.ZodNumber:return Mf(n,t);case w.ZodObject:return Pf(n,t);case w.ZodBigInt:return rf(n,t);case w.ZodBoolean:return of();case w.ZodDate:return Gc(n,t);case w.ZodUndefined:return Nf();case w.ZodNull:return xf(t);case w.ZodArray:return af(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return _f(n,t);case w.ZodIntersection:return ff(n,t);case w.ZodTuple:return Tf(n,t);case w.ZodRecord:return el(n,t);case w.ZodLiteral:return yf(n,t);case w.ZodEnum:return df(n);case w.ZodNativeEnum:return wf(n);case w.ZodNullable:return Of(n,t);case w.ZodOptional:return Ef(n,t);case w.ZodMap:return bf(n,t);case w.ZodSet:return kf(n,t);case w.ZodLazy:return ee(n.getter()._def,t);case w.ZodPromise:return Sf(n,t);case w.ZodNaN:case w.ZodNever:return vf();case w.ZodEffects:return hf(n,t);case w.ZodAny:return sf();case w.ZodUnknown:return If();case w.ZodDefault:return pf(n,t);case w.ZodBranded:return cf(n,t);case w.ZodReadonly:return jf(n,t);case w.ZodCatch:return lf(n,t);case w.ZodPipeline:return Cf(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(s=>{})()}},Bf=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),Ff=(n,e)=>{const t=nf(e),s=void 0,a=e==null?void 0:e.name,i=ee(n._def,t,!1)??{},r=a===void 0?s?{...i,[t.definitionPath]:s}:i:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...s,[a]:i}};return t.target==="jsonSchema7"?r.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(r.$schema="https://json-schema.org/draft/2019-09/schema#"),r},_n="0.5.0";let nl=!1,Jn,sl,al,Fi,il,rl,ol,cl,ll;function qf(n,e={auto:!1}){if(nl)throw new Error(`you must \`import 'groq-sdk/shims/${n.kind}'\` before importing anything else from groq-sdk`);if(Jn)throw new Error(`can't \`import 'groq-sdk/shims/${n.kind}'\` after \`import 'groq-sdk/shims/${Jn}'\``);nl=e.auto,Jn=n.kind,sl=n.fetch,al=n.FormData,Fi=n.File,il=n.ReadableStream,rl=n.getMultipartRequestOptions,ol=n.getDefaultAgent,cl=n.fileFromPath,ll=n.isFsReadStream}class Df{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Uf({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n";let t,s,a,i;try{t=fetch,s=Request,a=Response,i=Headers}catch(r){throw new Error(`this environment is missing the following Web Fetch API type: ${r.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:a,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(r,o)=>({...o,body:new Df(r)}),getDefaultAgent:r=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:r=>!1}}Jn||qf(Uf(),{auto:!0});class gt extends Error{}class Le extends gt{constructor(e,t,s,a){super(`${Le.makeMessage(e,t,s)}`),this.status=e,this.headers=a,this.error=t}static makeMessage(e,t,s){const a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,s,a){if(!e)return new Us({cause:Zi(t)});const i=t;return e===400?new pl(e,i,s,a):e===401?new hl(e,i,s,a):e===403?new dl(e,i,s,a):e===404?new ml(e,i,s,a):e===409?new fl(e,i,s,a):e===422?new yl(e,i,s,a):e===429?new gl(e,i,s,a):e>=500?new bl(e,i,s,a):new Le(e,i,s,a)}}class qi extends Le{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class Us extends Le{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class ul extends Us{constructor({message:e}={}){super({message:e??"Request timed out."})}}class pl extends Le{constructor(){super(...arguments),this.status=400}}class hl extends Le{constructor(){super(...arguments),this.status=401}}class dl extends Le{constructor(){super(...arguments),this.status=403}}class ml extends Le{constructor(){super(...arguments),this.status=404}}class fl extends Le{constructor(){super(...arguments),this.status=409}}class yl extends Le{constructor(){super(...arguments),this.status=422}}class gl extends Le{constructor(){super(...arguments),this.status=429}}class bl extends Le{}class On{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;const a=new Wf;async function*i(){if(!e.body)throw t.abort(),new gt("Attempted to iterate over a response with no body");const o=new en,c=wl(e.body);for await(const l of c)for(const u of o.decode(l)){const p=a.decode(u);p&&(yield p)}for(const l of o.flush()){const u=a.decode(l);u&&(yield u)}}async function*r(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let o=!1;try{for await(const c of i())if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null){let l;try{l=JSON.parse(c.data)}catch(u){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),u}if(l&&l.error)throw new Le(void 0,l.error,void 0,void 0);yield l}}o=!0}catch(c){if(c instanceof Error&&c.name==="AbortError")return;throw c}finally{o||t.abort()}}return new On(r,t)}static fromReadableStream(e,t){let s=!1;async function*a(){const r=new en,o=wl(e);for await(const c of o)for(const l of r.decode(c))yield l;for(const c of r.flush())yield c}async function*i(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let r=!1;try{for await(const o of a())r||o&&(yield JSON.parse(o));r=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{r||t.abort()}}return new On(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),a=i=>({next:()=>{if(i.length===0){const r=s.next();e.push(r),t.push(r)}return i.shift()}});return[new On(()=>a(e),this.controller),new On(()=>a(t),this.controller)]}toReadableStream(){const e=this;let t;const s=new TextEncoder;return new il({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{const{value:i,done:r}=await t.next();if(r)return a.close();const o=s.encode(JSON.stringify(i)+`
`);a.enqueue(o)}catch(i){a.error(i)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}}class Wf{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,a]=zf(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}}class en{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const s=en.NEWLINE_CHARS.has(t[t.length-1]||"");let a=t.split(en.NEWLINE_REGEXP);return a.length===1&&!s?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),s||(this.buffer=[a.pop()||""]),a)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Fe<"u"){if(e instanceof Fe)return e.toString();if(e instanceof Uint8Array)return Fe.from(e).toString();throw new gt(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new gt(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new gt("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}en.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]),en.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function zf(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function wl(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const vl=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",xl=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Di(n),Di=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Zf=n=>xl(n)||vl(n)||ll(n);async function _l(n,e,t){var a;if(n=await n,t??(t=xl(n)?{lastModified:n.lastModified,type:n.type}:{}),vl(n)){const i=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new Fi([i],e,t)}const s=await Vf(n);if(e||(e=Qf(n)??"unknown_file"),!t.type){const i=(a=s[0])==null?void 0:a.type;typeof i=="string"&&(t={...t,type:i})}return new Fi(s,e,t)}async function Vf(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Di(n))e.push(await n.arrayBuffer());else if(Hf(n))for await(const s of n)e.push(s);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${Kf(n)}`);return e}function Kf(n){return`[${Object.getOwnPropertyNames(n).map(e=>`"${e}"`).join(", ")}]`}function Qf(n){var e;return Ui(n.name)||Ui(n.filename)||((e=Ui(n.path))==null?void 0:e.split(/[\\/]/).pop())}const Ui=n=>{if(typeof n=="string")return n;if(typeof Fe<"u"&&n instanceof Fe)return String(n)},Hf=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Ol=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",Ml=async n=>{const e=await Jf(n.body);return rl(e,n)},Jf=async n=>{const e=new al;return await Promise.all(Object.entries(n||{}).map(([t,s])=>Wi(e,t,s))),e},Wi=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Zf(t)){const s=await _l(t);n.append(e,s)}else if(Array.isArray(t))await Promise.all(t.map(s=>Wi(n,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,a])=>Wi(n,`${e}[${s}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Mn={};async function Al(n){const{response:e}=n;if(n.options.stream)return An("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):On.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if(t!=null&&t.includes("application/json")||t!=null&&t.includes("application/vnd.api+json")){const a=await e.json();return An("response",e.status,e.url,e.headers,a),a}const s=await e.text();return An("response",e.status,e.url,e.headers,s),s}class Ws extends Promise{constructor(e,t=Al){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Ws(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Gf{constructor({baseURL:e,maxRetries:t=2,timeout:s=6e4,httpAgent:a,fetch:i}){this.baseURL=e,this.maxRetries=zi("maxRetries",t),this.timeout=zi("timeout",s),this.httpAgent=a,this.fetch=i??sl}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ny(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${ly()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(async a=>{const i=a&&Di(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:i}}))}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}calculateContentLength(e){if(typeof e=="string"){if(typeof Fe<"u")return Fe.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e){var d;const{method:t,path:s,query:a,headers:i={}}=e,r=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Ol(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(r),c=this.buildURL(s,a);"timeout"in e&&zi("timeout",e.timeout);const l=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??ol(c),p=l+1e3;typeof((d=u==null?void 0:u.options)==null?void 0:d.timeout)=="number"&&p>(u.options.timeout??0)&&(u.options.timeout=p),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:i,contentLength:o});return{req:{method:t,...r&&{body:r},headers:h,...u&&{agent:u},signal:e.signal??null},url:c,timeout:l}}buildHeaders({options:e,headers:t,contentLength:s}){const a={};s&&(a["content-length"]=s);const i=this.defaultHeaders(e);return kl(a,i),kl(a,t),Ol(e.body)&&Jn!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,s,a){return Le.generate(e,t,s,a)}request(e,t=null){return new Ws(this.makeRequest(e,t))}async makeRequest(e,t){var u,p;const s=await e;t==null&&(t=s.maxRetries??this.maxRetries),await this.prepareOptions(s);const{req:a,url:i,timeout:r}=this.buildRequest(s);if(await this.prepareRequest(a,{url:i,options:s}),An("request",i,s,a.headers),(u=s.signal)==null?void 0:u.aborted)throw new qi;const o=new AbortController,c=await this.fetchWithTimeout(i,a,r,o).catch(Zi);if(c instanceof Error){if((p=s.signal)!=null&&p.aborted)throw new qi;if(t)return this.retryRequest(s,t);throw c.name==="AbortError"?new ul:new Us({cause:c})}const l=Yf(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const f=`retrying, ${t} attempts remaining`;return An(`response (error; ${f})`,c.status,i,l),this.retryRequest(s,t,l)}const h=await c.text().catch(f=>Zi(f).message),d=sy(h),m=d?void 0:h;throw An(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,m),this.makeStatusError(c.status,d,m,l)}return{response:c,options:s,controller:o}}requestAPIList(e,t){const s=this.makeRequest(t,null);return new Xf(this,s,e)}buildURL(e,t){const s=iy(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return oy(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new gt(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,s,a){const{signal:i,...r}=t||{};i&&i.addEventListener("abort",()=>a.abort());const o=setTimeout(()=>a.abort(),s);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...r}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s){let a;const i=s==null?void 0:s["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(a=o)}const r=s==null?void 0:s["retry-after"];if(r&&!a){const o=parseFloat(r);Number.isNaN(o)?a=Date.parse(r)-Date.now():a=o*1e3}if(!(a&&0<=a&&a<60*1e3)){const o=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,o)}return await ry(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e,a=Math.min(.5*Math.pow(2,s),8),i=1-Math.random()*.25;return a*i*1e3}getUserAgent(){return`${this.constructor.name}/JS ${_n}`}}class Xf extends Ws{constructor(e,t,s){super(t,async a=>new s(e,a.response,await Al(a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const Yf=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const s=t.toString();return e[s.toLowerCase()]||e[s]}}),ey=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_n,"X-Stainless-OS":El(Deno.build.os),"X-Stainless-Arch":Pl(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_n,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":Te.version};if(Object.prototype.toString.call(typeof Te<"u"?Te:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_n,"X-Stainless-OS":El(Te.platform),"X-Stainless-Arch":Pl(Te.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":Te.version};const n=ty();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_n,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":_n,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function ty(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const s=t.exec(navigator.userAgent);if(s){const a=s[1]||0,i=s[2]||0,r=s[3]||0;return{browser:e,version:`${a}.${i}.${r}`}}}return null}const Pl=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",El=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Cl;const ny=()=>Cl??(Cl=ey()),sy=n=>{try{return JSON.parse(n)}catch{return}},ay=new RegExp("^(?:[a-z]+:)?//","i"),iy=n=>ay.test(n),ry=n=>new Promise(e=>setTimeout(e,n)),zi=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new gt(`${n} must be an integer`);if(e<0)throw new gt(`${n} must be a positive integer`);return e},Zi=n=>n instanceof Error?n:new Error(n),Sl=n=>{var e,t,s,a;if(typeof Te<"u")return((e=Mn==null?void 0:Mn[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(a=(s=(t=Deno.env)==null?void 0:t.get)==null?void 0:s.call(t,n))==null?void 0:a.trim()};function oy(n){if(!n)return!0;for(const e in n)return!1;return!0}function cy(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function kl(n,e){for(const t in e){if(!cy(e,t))continue;const s=t.toLowerCase();if(!s)continue;const a=e[t];a===null?delete n[s]:a!==void 0&&(n[s]=a)}}function An(n,...e){typeof Te<"u"&&(Mn==null?void 0:Mn.DEBUG)==="true"&&console.log(`Groq:DEBUG:${n}`,...e)}const ly=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),uy=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";class Ut{constructor(e){this._client=e}}class zs extends Ut{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",Ml({body:e,...t}))}}zs||(zs={});class Zs extends Ut{create(e,t){return this._client.post("/openai/v1/audio/translations",Ml({body:e,...t}))}}Zs||(Zs={});class Vs extends Ut{constructor(){super(...arguments),this.transcriptions=new zs(this._client),this.translations=new Zs(this._client)}}(function(n){n.Transcriptions=zs,n.Translations=Zs})(Vs||(Vs={}));let Ks=class extends Ut{create(n,e){return this._client.post("/openai/v1/chat/completions",{body:n,...e,stream:n.stream??!1})}};Ks||(Ks={});class Qs extends Ut{constructor(){super(...arguments),this.completions=new Ks(this._client)}}(function(n){n.Completions=Ks})(Qs||(Qs={}));class Hs extends Ut{}Hs||(Hs={});class Js extends Ut{create(e,t){return this._client.post("/openai/v1/embeddings",{body:e,...t})}}Js||(Js={});class Gs extends Ut{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,t)}}Gs||(Gs={});var Tl;class ve extends Gf{constructor({baseURL:e=Sl("GROQ_BASE_URL"),apiKey:t=Sl("GROQ_API_KEY"),...s}={}){if(t===void 0)throw new gt("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");const a={apiKey:t,...s,baseURL:e||"https://api.groq.com"};if(!a.dangerouslyAllowBrowser&&uy())throw new gt(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:a.baseURL,timeout:a.timeout??6e4,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new Hs(this),this.chat=new Qs(this),this.embeddings=new Js(this),this.audio=new Vs(this),this.models=new Gs(this),this._options=a,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}Tl=ve,ve.Groq=Tl,ve.GroqError=gt,ve.APIError=Le,ve.APIConnectionError=Us,ve.APIConnectionTimeoutError=ul,ve.APIUserAbortError=qi,ve.NotFoundError=ml,ve.ConflictError=fl,ve.RateLimitError=gl,ve.BadRequestError=pl,ve.AuthenticationError=hl,ve.InternalServerError=bl,ve.PermissionDeniedError=dl,ve.UnprocessableEntityError=yl,ve.toFile=_l,ve.fileFromPath=cl,function(n){n.Completions=Hs,n.Chat=Qs,n.Embeddings=Js,n.Audio=Vs,n.Models=Gs}(ve||(ve={}));function py(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}}function Nl(n){return n.map(e=>{var s;if(typeof e.content!="string")throw new Error("Non string message content not supported");const t={role:py(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return oa(e)&&((s=e.tool_calls)!=null&&s.length)?t.tool_calls=e.tool_calls.map(Sc):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function hy(n,e){const t=n.tool_calls;switch(n.role){case"assistant":{const s=[],a=[];for(const i of t??[])try{s.push(ji(i,{returnId:!0}))}catch(r){a.push(kc(i,r.message))}return new ca({content:n.content||"",additional_kwargs:{tool_calls:t},tool_calls:s,invalid_tool_calls:a,usage_metadata:e})}default:return new la(n.content||"",n.role??"unknown")}}function dy(n,e){if(n!=null&&n.length)return n.map(t=>{var s,a;return{id:t.id,name:(s=t.function)==null?void 0:s.name,args:(a=t.function)==null?void 0:a.arguments,type:"tool_call_chunk",index:e}})}function my(n,e,t){const{role:s}=n,a=n.content??"";let i;n.function_call?i={function_call:n.function_call}:n.tool_calls?i={tool_calls:n.tool_calls}:i={};let r,o;if(t!=null&&t.usage&&(r={input_tokens:t.usage.prompt_tokens,output_tokens:t.usage.completion_tokens,total_tokens:t.usage.total_tokens},o=t.id),s==="user")return{message:new Bu({content:a})};if(s==="assistant"){const c=dy(n.tool_calls,e);return{message:new Sn({content:a,additional_kwargs:i,tool_call_chunks:c?c.map(l=>({type:l.type,args:l.args,index:l.index})):void 0,usage_metadata:r,id:o}),toolCallData:c?c.map(l=>({id:l.id??"",name:l.name??"",index:l.index??e,type:"tool_call_chunk"})):void 0}}else return s==="system"?{message:new Xi({content:a})}:{message:new Fu({content:a,role:s})}}class fy extends kt{static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}constructor(e){super(e??{}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","groq"]}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"mixtral-8x7b-32768"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"mixtral-8x7b-32768"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=(e==null?void 0:e.apiKey)||Rt("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');const s={"User-Agent":"langchainjs",...(e==null?void 0:e.defaultHeaders)??{}};this.client=new ve({apiKey:t,dangerouslyAllowBrowser:!0,baseURL:e==null?void 0:e.baseUrl,timeout:e==null?void 0:e.timeout,httpAgent:e==null?void 0:e.httpAgent,fetch:e==null?void 0:e.fetch,maxRetries:0,defaultHeaders:s,defaultQuery:e==null?void 0:e.defaultQuery}),this.apiKey=t,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.modelName=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.model=this.modelName,this.streaming=(e==null?void 0:e.streaming)??this.streaming,this.stop=(e==null?void 0:e.stopSequences)??(typeof(e==null?void 0:e.stop)=="string"?[e.stop]:e==null?void 0:e.stop)??[],this.stopSequences=this.stop,this.maxTokens=e==null?void 0:e.maxTokens}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"groq",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??this.temperature,ls_max_tokens:t.max_tokens??this.maxTokens,ls_stop:e.stop}}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e){const t=super.invocationParams(e);return e.tool_choice!==void 0&&(t.tool_choice=e.tool_choice),e.tools!==void 0&&(t.tools=e.tools),e.response_format!==void 0&&(t.response_format=e.response_format),{...t,stop:e.stop??this.stopSequences,model:this.model,temperature:this.temperature,max_tokens:this.maxTokens}}bindTools(e,t){return this.bind({tools:e.map(s=>qm(s)),...t})}async*_streamResponseChunks(e,t,s){var u,p;const a=this.invocationParams(t),i=Nl(e),r=await this.completionWithRetry({...a,messages:i,stream:!0},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});let o="";const c=[];let l;for await(const h of r){l=h;const d=h==null?void 0:h.choices[0];if(!d)continue;(u=d.delta)!=null&&u.role&&(o=d.delta.role);const{message:m,toolCallData:f}=my({...d.delta,role:o},d.index,h.x_groq);if(f){const g=f.filter(v=>c.every(O=>O.id!==v.id));c.push(...g),yield new Qt({message:new Sn({content:"",tool_call_chunks:g}),text:""})}const y=new Qt({message:m,text:d.delta.content??"",generationInfo:{finishReason:d.finish_reason}});yield y,s==null||s.handleLLMNewToken(y.text??"")}if(l&&("choices"in l&&delete l.choices,yield new Qt({message:new Sn({content:"",response_metadata:l}),text:""})),(p=t.signal)==null?void 0:p.aborted)throw new Error("AbortError")}async _generate(e,t,s){var a;if(this.streaming){const i={},r=this._streamResponseChunks(e,t,s),o={};for await(const c of r){const l=((a=c.generationInfo)==null?void 0:a.completion)??0;o[l]===void 0?o[l]=c:o[l]=o[l].concat(c)}return{generations:Object.entries(o).sort(([c],[l])=>parseInt(c,10)-parseInt(l,10)).map(([c,l])=>l),llmOutput:{estimatedTokenUsage:i}}}else return this._generateNonStreaming(e,t,s)}async _generateNonStreaming(e,t,s){var l;const a={},i=this.invocationParams(t),r=Nl(e),o=await this.completionWithRetry({...i,stream:!1,messages:r},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});if("usage"in o&&o.usage){const{completion_tokens:u,prompt_tokens:p,total_tokens:h}=o.usage;u&&(a.completionTokens=(a.completionTokens??0)+u),p&&(a.promptTokens=(a.promptTokens??0)+p),h&&(a.totalTokens=(a.totalTokens??0)+h)}const c=[];if("choices"in o&&o.choices)for(const u of o.choices){const p=((l=u.message)==null?void 0:l.content)??"";let h;a.totalTokens!==void 0&&(h={input_tokens:a.promptTokens??0,output_tokens:a.completionTokens??0,total_tokens:a.totalTokens});const d={text:p,message:hy(u.message??{role:"assistant"},h)};d.generationInfo={...u.finish_reason?{finish_reason:u.finish_reason}:{},...u.logprobs?{logprobs:u.logprobs}:{}},c.push(d)}return{generations:c,llmOutput:{tokenUsage:a}}}withStructuredOutput(e,t){const s=e,a=t==null?void 0:t.name,i=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw;let o=a??"extract",c,l;if(i==="jsonMode")l=this.bind({response_format:{type:"json_object"}}),Hn(s)?c=Ni.fromZodSchema(s):c=new Ii;else if(Hn(s)){const d=Ff(s);l=this.bind({tools:[{type:"function",function:{name:o,description:d.description,parameters:d}}],tool_choice:{type:"function",function:{name:o}}}),c=new js({returnSingle:!0,keyName:o,zodSchema:s})}else{let d;typeof s.name=="string"&&typeof s.parameters=="object"&&s.parameters!=null?(d=s,o=s.name):(o=s.title??o,d={name:o,description:s.description??"",parameters:s}),l=this.bind({tools:[{type:"function",function:d}],tool_choice:{type:"function",function:{name:o}}}),c=new js({returnSingle:!0,keyName:o})}if(!r)return l.pipe(c).withConfig({runName:"ChatGroqStructuredOutput"});const u=Dt.assign({parsed:(d,m)=>c.invoke(d.raw,m)}),p=Dt.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[p]});return ra.from([{raw:l},h]).withConfig({runName:"ChatGroqStructuredOutput"})}}var Il;(function(n){n.STRING="string",n.NUMBER="number",n.INTEGER="integer",n.BOOLEAN="boolean",n.ARRAY="array",n.OBJECT="object"})(Il||(Il={}));var jl;(function(n){n.LANGUAGE_UNSPECIFIED="language_unspecified",n.PYTHON="python"})(jl||(jl={}));var Rl;(function(n){n.OUTCOME_UNSPECIFIED="outcome_unspecified",n.OUTCOME_OK="outcome_ok",n.OUTCOME_FAILED="outcome_failed",n.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(Rl||(Rl={}));const $l=["user","model","function","system"];var Ll;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(Ll||(Ll={}));var Bl;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(Bl||(Bl={}));var Fl;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(Fl||(Fl={}));var ql;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(ql||(ql={}));var Gn;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.OTHER="OTHER"})(Gn||(Gn={}));var Dl;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(Dl||(Dl={}));var Pn;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(Pn||(Pn={}));var Ul;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(Ul||(Ul={}));class Ze extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class En extends Ze{constructor(e,t){super(e),this.response=t}}class Wl extends Ze{constructor(e,t,s,a){super(e),this.status=t,this.statusText=s,this.errorDetails=a}}class Wt extends Ze{}const yy="https://generativelanguage.googleapis.com",gy="v1beta",by="0.21.0",wy="genai-js";var tn;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(tn||(tn={}));class vy{constructor(e,t,s,a,i){this.model=e,this.task=t,this.apiKey=s,this.stream=a,this.requestOptions=i}toString(){var e,t;const s=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||gy;let a=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||yy}/${s}/${this.model}:${this.task}`;return this.stream&&(a+="?alt=sse"),a}}function xy(n){const e=[];return n!=null&&n.apiClient&&e.push(n.apiClient),e.push(`${wy}/${by}`),e.join(" ")}async function _y(n){var e;const t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",xy(n.requestOptions)),t.append("x-goog-api-key",n.apiKey);let s=(e=n.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(s){if(!(s instanceof Headers))try{s=new Headers(s)}catch(a){throw new Wt(`unable to convert customHeaders value ${JSON.stringify(s)} to Headers: ${a.message}`)}for(const[a,i]of s.entries()){if(a==="x-goog-api-key")throw new Wt(`Cannot set reserved header name ${a}`);if(a==="x-goog-api-client")throw new Wt(`Header name ${a} can only be set using the apiClient field`);t.append(a,i)}}return t}async function Oy(n,e,t,s,a,i){const r=new vy(n,e,t,s,i);return{url:r.toString(),fetchOptions:Object.assign(Object.assign({},Ey(i)),{method:"POST",headers:await _y(r),body:a})}}async function Xn(n,e,t,s,a,i={},r=fetch){const{url:o,fetchOptions:c}=await Oy(n,e,t,s,a,i);return My(o,c,r)}async function My(n,e,t=fetch){let s;try{s=await t(n,e)}catch(a){Ay(a,n)}return s.ok||await Py(s,n),s}function Ay(n,e){let t=n;throw n instanceof Wl||n instanceof Wt||(t=new Ze(`Error fetching from ${e.toString()}: ${n.message}`),t.stack=n.stack),t}async function Py(n,e){let t="",s;try{const a=await n.json();t=a.error.message,a.error.details&&(t+=` ${JSON.stringify(a.error.details)}`,s=a.error.details)}catch{}throw new Wl(`Error fetching from ${e.toString()}: [${n.status} ${n.statusText}] ${t}`,n.status,n.statusText,s)}function Ey(n){const e={};if((n==null?void 0:n.signal)!==void 0||(n==null?void 0:n.timeout)>=0){const t=new AbortController;(n==null?void 0:n.timeout)>=0&&setTimeout(()=>t.abort(),n.timeout),n!=null&&n.signal&&n.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function Vi(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Xs(n.candidates[0]))throw new En(`${zt(n)}`,n);return Cy(n)}else if(n.promptFeedback)throw new En(`Text not available. ${zt(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Xs(n.candidates[0]))throw new En(`${zt(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),zl(n)[0]}else if(n.promptFeedback)throw new En(`Function call not available. ${zt(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Xs(n.candidates[0]))throw new En(`${zt(n)}`,n);return zl(n)}else if(n.promptFeedback)throw new En(`Function call not available. ${zt(n)}`,n)},n}function Cy(n){var e,t,s,a;const i=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const r of(a=(s=n.candidates)===null||s===void 0?void 0:s[0].content)===null||a===void 0?void 0:a.parts)r.text&&i.push(r.text),r.executableCode&&i.push("\n```"+r.executableCode.language+`
`+r.executableCode.code+"\n```\n"),r.codeExecutionResult&&i.push("\n```\n"+r.codeExecutionResult.output+"\n```\n");return i.length>0?i.join(""):""}function zl(n){var e,t,s,a;const i=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const r of(a=(s=n.candidates)===null||s===void 0?void 0:s[0].content)===null||a===void 0?void 0:a.parts)r.functionCall&&i.push(r.functionCall);if(i.length>0)return i}const Sy=[Gn.RECITATION,Gn.SAFETY,Gn.LANGUAGE];function Xs(n){return!!n.finishReason&&Sy.includes(n.finishReason)}function zt(n){var e,t,s;let a="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)a+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(a+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(a+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((s=n.candidates)===null||s===void 0)&&s[0]){const i=n.candidates[0];Xs(i)&&(a+=`Candidate was blocked due to ${i.finishReason}`,i.finishMessage&&(a+=`: ${i.finishMessage}`))}return a}function Yn(n){return this instanceof Yn?(this.v=n,this):new Yn(n)}function ky(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=t.apply(n,e||[]),a,i=[];return a={},r("next"),r("throw"),r("return"),a[Symbol.asyncIterator]=function(){return this},a;function r(h){s[h]&&(a[h]=function(d){return new Promise(function(m,f){i.push([h,d,m,f])>1||o(h,d)})})}function o(h,d){try{c(s[h](d))}catch(m){p(i[0][3],m)}}function c(h){h.value instanceof Yn?Promise.resolve(h.value.v).then(l,u):p(i[0][2],h)}function l(h){o("next",h)}function u(h){o("throw",h)}function p(h,d){h(d),i.shift(),i.length&&o(i[0][0],i[0][1])}}const Zl=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Ty(n){const e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=jy(e),[s,a]=t.tee();return{stream:Iy(s),response:Ny(a)}}async function Ny(n){const e=[],t=n.getReader();for(;;){const{done:s,value:a}=await t.read();if(s)return Vi(Ry(e));e.push(a)}}function Iy(n){return ky(this,arguments,function*(){const e=n.getReader();for(;;){const{value:t,done:s}=yield Yn(e.read());if(s)break;yield yield Yn(Vi(t))}})}function jy(n){const e=n.getReader();return new ReadableStream({start(t){let s="";return a();function a(){return e.read().then(({value:i,done:r})=>{if(r){if(s.trim()){t.error(new Ze("Failed to parse stream"));return}t.close();return}s+=i;let o=s.match(Zl),c;for(;o;){try{c=JSON.parse(o[1])}catch{t.error(new Ze(`Error parsing JSON response: "${o[1]}"`));return}t.enqueue(c),s=s.substring(o[0].length),o=s.match(Zl)}return a()})}}})}function Ry(n){const e=n[n.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(const s of n){if(s.candidates)for(const a of s.candidates){const i=a.index;if(t.candidates||(t.candidates=[]),t.candidates[i]||(t.candidates[i]={index:a.index}),t.candidates[i].citationMetadata=a.citationMetadata,t.candidates[i].groundingMetadata=a.groundingMetadata,t.candidates[i].finishReason=a.finishReason,t.candidates[i].finishMessage=a.finishMessage,t.candidates[i].safetyRatings=a.safetyRatings,a.content&&a.content.parts){t.candidates[i].content||(t.candidates[i].content={role:a.content.role||"user",parts:[]});const r={};for(const o of a.content.parts)o.text&&(r.text=o.text),o.functionCall&&(r.functionCall=o.functionCall),o.executableCode&&(r.executableCode=o.executableCode),o.codeExecutionResult&&(r.codeExecutionResult=o.codeExecutionResult),Object.keys(r).length===0&&(r.text=""),t.candidates[i].content.parts.push(r)}}s.usageMetadata&&(t.usageMetadata=s.usageMetadata)}return t}async function Vl(n,e,t,s){const a=await Xn(e,tn.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),s);return Ty(a)}async function Kl(n,e,t,s){const a=await(await Xn(e,tn.GENERATE_CONTENT,n,!1,JSON.stringify(t),s)).json();return{response:Vi(a)}}function Ql(n){if(n!=null){if(typeof n=="string")return{role:"system",parts:[{text:n}]};if(n.text)return{role:"system",parts:[n]};if(n.parts)return n.role?n:{role:"system",parts:n.parts}}}function es(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(const t of n)typeof t=="string"?e.push({text:t}):e.push(t);return $y(e)}function $y(n){const e={role:"user",parts:[]},t={role:"function",parts:[]};let s=!1,a=!1;for(const i of n)"functionResponse"in i?(t.parts.push(i),a=!0):(e.parts.push(i),s=!0);if(s&&a)throw new Ze("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!s&&!a)throw new Ze("No content is provided for sending chat message.");return s?e:t}function Ly(n,e){var t;let s={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(t=e==null?void 0:e.cachedContent)===null||t===void 0?void 0:t.name,contents:[]};const a=n.generateContentRequest!=null;if(n.contents){if(a)throw new Wt("CountTokensRequest must have one of contents or generateContentRequest, not both.");s.contents=n.contents}else if(a)s=Object.assign(Object.assign({},s),n.generateContentRequest);else{const i=es(n);s.contents=[i]}return{generateContentRequest:s}}function Hl(n){let e;return n.contents?e=n:e={contents:[es(n)]},n.systemInstruction&&(e.systemInstruction=Ql(n.systemInstruction)),e}function By(n){return typeof n=="string"||Array.isArray(n)?{content:es(n)}:n}const Jl=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],Fy={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function qy(n){let e=!1;for(const t of n){const{role:s,parts:a}=t;if(!e&&s!=="user")throw new Ze(`First content should be with role 'user', got ${s}`);if(!$l.includes(s))throw new Ze(`Each item should include role field. Got ${s} but valid roles are: ${JSON.stringify($l)}`);if(!Array.isArray(a))throw new Ze("Content should have 'parts' property with an array of Parts");if(a.length===0)throw new Ze("Each Content should have at least one part");const i={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const o of a)for(const c of Jl)c in o&&(i[c]+=1);const r=Fy[s];for(const o of Jl)if(!r.includes(o)&&i[o]>0)throw new Ze(`Content with role '${s}' can't contain '${o}' part`);e=!0}}const Gl="SILENT_ERROR";class Dy{constructor(e,t,s,a={}){this.model=t,this.params=s,this._requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,s!=null&&s.history&&(qy(s.history),this._history=s.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var s,a,i,r,o,c;await this._sendPromise;const l=es(e),u={safetySettings:(s=this.params)===null||s===void 0?void 0:s.safetySettings,generationConfig:(a=this.params)===null||a===void 0?void 0:a.generationConfig,tools:(i=this.params)===null||i===void 0?void 0:i.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,l]},p=Object.assign(Object.assign({},this._requestOptions),t);let h;return this._sendPromise=this._sendPromise.then(()=>Kl(this._apiKey,this.model,u,p)).then(d=>{var m;if(d.response.candidates&&d.response.candidates.length>0){this._history.push(l);const f=Object.assign({parts:[],role:"model"},(m=d.response.candidates)===null||m===void 0?void 0:m[0].content);this._history.push(f)}else{const f=zt(d.response);f&&console.warn(`sendMessage() was unsuccessful. ${f}. Inspect response object for details.`)}h=d}),await this._sendPromise,h}async sendMessageStream(e,t={}){var s,a,i,r,o,c;await this._sendPromise;const l=es(e),u={safetySettings:(s=this.params)===null||s===void 0?void 0:s.safetySettings,generationConfig:(a=this.params)===null||a===void 0?void 0:a.generationConfig,tools:(i=this.params)===null||i===void 0?void 0:i.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,l]},p=Object.assign(Object.assign({},this._requestOptions),t),h=Vl(this._apiKey,this.model,u,p);return this._sendPromise=this._sendPromise.then(()=>h).catch(d=>{throw new Error(Gl)}).then(d=>d.response).then(d=>{if(d.candidates&&d.candidates.length>0){this._history.push(l);const m=Object.assign({},d.candidates[0].content);m.role||(m.role="model"),this._history.push(m)}else{const m=zt(d);m&&console.warn(`sendMessageStream() was unsuccessful. ${m}. Inspect response object for details.`)}}).catch(d=>{d.message!==Gl&&console.error(d)}),h}}async function Uy(n,e,t,s){return(await Xn(e,tn.COUNT_TOKENS,n,!1,JSON.stringify(t),s)).json()}async function Wy(n,e,t,s){return(await Xn(e,tn.EMBED_CONTENT,n,!1,JSON.stringify(t),s)).json()}async function zy(n,e,t,s){const a=t.requests.map(i=>Object.assign(Object.assign({},i),{model:e}));return(await Xn(e,tn.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:a}),s)).json()}class Xl{constructor(e,t,s={}){this.apiKey=e,this._requestOptions=s,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=Ql(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var s;const a=Hl(e),i=Object.assign(Object.assign({},this._requestOptions),t);return Kl(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(s=this.cachedContent)===null||s===void 0?void 0:s.name},a),i)}async generateContentStream(e,t={}){var s;const a=Hl(e),i=Object.assign(Object.assign({},this._requestOptions),t);return Vl(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(s=this.cachedContent)===null||s===void 0?void 0:s.name},a),i)}startChat(e){var t;return new Dy(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const s=Ly(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),a=Object.assign(Object.assign({},this._requestOptions),t);return Uy(this.apiKey,this.model,s,a)}async embedContent(e,t={}){const s=By(e),a=Object.assign(Object.assign({},this._requestOptions),t);return Wy(this.apiKey,this.model,s,a)}async batchEmbedContents(e,t={}){const s=Object.assign(Object.assign({},this._requestOptions),t);return zy(this.apiKey,this.model,e,s)}}ua=class{constructor(n){this.apiKey=n}getGenerativeModel(n,e){if(!n.model)throw new Ze("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Xl(this.apiKey,n,e)}getGenerativeModelFromCachedContent(n,e,t){if(!n.name)throw new Wt("Cached content must contain a `name` field.");if(!n.model)throw new Wt("Cached content must contain a `model` field.");const s=["model","systemInstruction"];for(const i of s)if(e!=null&&e[i]&&n[i]&&(e==null?void 0:e[i])!==n[i]){if(i==="model"){const r=e.model.startsWith("models/")?e.model.replace("models/",""):e.model,o=n.model.startsWith("models/")?n.model.replace("models/",""):n.model;if(r===o)continue}throw new Wt(`Different value for "${i}" specified in modelParams (${e[i]}) and cachedContent (${n[i]})`)}const a=Object.assign(Object.assign({},e),{model:n.model,tools:n.tools,toolConfig:n.toolConfig,systemInstruction:n.systemInstruction,cachedContent:n});return new Xl(this.apiKey,a,t)}};const Zy=Symbol("Let zodToJsonSchema decide on which parser to use"),Vy={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Ky=n=>({...Vy,...n}),Qy=n=>{const e=Ky(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([s,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function Yl(n,e,t,s){s!=null&&s.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ie(n,e,t,s,a){n[e]=t,Yl(n,e,s,a)}function Hy(){return{}}function Jy(n,e){var s,a,i;const t={type:"array"};return(s=n.type)!=null&&s._def&&((i=(a=n.type)==null?void 0:a._def)==null?void 0:i.typeName)!==w.ZodAny&&(t.items=te(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ie(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ie(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ie(t,"minItems",n.exactLength.value,n.exactLength.message,e),ie(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Gy(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?ie(t,"minimum",s.value,s.message,e):ie(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),ie(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?ie(t,"maximum",s.value,s.message,e):ie(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),ie(t,"maximum",s.value,s.message,e));break;case"multipleOf":ie(t,"multipleOf",s.value,s.message,e);break}return t}function Xy(){return{type:"boolean"}}function eu(n,e){return te(n.type._def,e)}const Yy=(n,e)=>te(n.innerType._def,e);function tu(n,e,t){const s=t??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((a,i)=>tu(n,e,a))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return eg(n,e)}}const eg=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const s of n.checks)switch(s.kind){case"min":ie(t,"minimum",s.value,s.message,e);break;case"max":ie(t,"maximum",s.value,s.message,e);break}return t};function tg(n,e){return{...te(n.innerType._def,e),default:n.defaultValue()}}function ng(n,e){return e.effectStrategy==="input"?te(n.schema._def,e):{}}function sg(n){return{type:"string",enum:Array.from(n.values)}}const ag=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function ig(n,e){const t=[te(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),te(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(i=>{if(ag(i))a.push(...i.allOf),i.unevaluatedProperties===void 0&&(s=void 0);else{let r=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...c}=i;r=c}else s=void 0;a.push(r)}}),a.length?{allOf:a,...s}:void 0}function rg(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Ki;const bt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ki===void 0&&(Ki=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ki),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function nu(n,e){const t={type:"string"};if(n.checks)for(const s of n.checks)switch(s.kind){case"min":ie(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e);break;case"max":ie(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":wt(t,"email",s.message,e);break;case"format:idn-email":wt(t,"idn-email",s.message,e);break;case"pattern:zod":qe(t,bt.email,s.message,e);break}break;case"url":wt(t,"uri",s.message,e);break;case"uuid":wt(t,"uuid",s.message,e);break;case"regex":qe(t,s.regex,s.message,e);break;case"cuid":qe(t,bt.cuid,s.message,e);break;case"cuid2":qe(t,bt.cuid2,s.message,e);break;case"startsWith":qe(t,RegExp(`^${Qi(s.value,e)}`),s.message,e);break;case"endsWith":qe(t,RegExp(`${Qi(s.value,e)}$`),s.message,e);break;case"datetime":wt(t,"date-time",s.message,e);break;case"date":wt(t,"date",s.message,e);break;case"time":wt(t,"time",s.message,e);break;case"duration":wt(t,"duration",s.message,e);break;case"length":ie(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e),ie(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"includes":{qe(t,RegExp(Qi(s.value,e)),s.message,e);break}case"ip":{s.version!=="v6"&&wt(t,"ipv4",s.message,e),s.version!=="v4"&&wt(t,"ipv6",s.message,e);break}case"base64url":qe(t,bt.base64url,s.message,e);break;case"jwt":qe(t,bt.jwt,s.message,e);break;case"cidr":{s.version!=="v6"&&qe(t,bt.ipv4Cidr,s.message,e),s.version!=="v4"&&qe(t,bt.ipv6Cidr,s.message,e);break}case"emoji":qe(t,bt.emoji(),s.message,e);break;case"ulid":{qe(t,bt.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{wt(t,"binary",s.message,e);break}case"contentEncoding:base64":{ie(t,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{qe(t,bt.base64,s.message,e);break}}break}case"nanoid":qe(t,bt.nanoid,s.message,e)}return t}function Qi(n,e){return e.patternStrategy==="escape"?cg(n):n}const og=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function cg(n){let e="";for(let t=0;t<n.length;t++)og.has(n[t])||(e+="\\"),e+=n[t];return e}function wt(n,e,t,s){var a;n.format||(a=n.anyOf)!=null&&a.some(i=>i.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&s.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&s.errorMessages&&{errorMessage:{format:t}}})):ie(n,"format",e,t,s)}function qe(n,e,t,s){var a;n.pattern||(a=n.allOf)!=null&&a.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&s.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:su(e,s),...t&&s.errorMessages&&{errorMessage:{pattern:t}}})):ie(n,"pattern",su(e,s),t,s)}function su(n,e){var c;if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},s=t.i?n.source.toLowerCase():n.source;let a="",i=!1,r=!1,o=!1;for(let l=0;l<s.length;l++){if(i){a+=s[l],i=!1;continue}if(t.i){if(r){if(s[l].match(/[a-z]/)){o?(a+=s[l],a+=`${s[l-2]}-${s[l]}`.toUpperCase(),o=!1):s[l+1]==="-"&&((c=s[l+2])!=null&&c.match(/[a-z]/))?(a+=s[l],o=!0):a+=`${s[l]}${s[l].toUpperCase()}`;continue}}else if(s[l].match(/[a-z]/)){a+=`[${s[l]}${s[l].toUpperCase()}]`;continue}}if(t.m){if(s[l]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(s[l]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&s[l]==="."){a+=r?`${s[l]}\r
`:`[${s[l]}\r
]`;continue}a+=s[l],s[l]==="\\"?i=!0:r&&s[l]==="]"?r=!1:!r&&s[l]==="["&&(r=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function au(n,e){var s,a,i,r,o,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((l,u)=>({...l,[u]:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",u]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){const{type:l,...u}=nu(n.keyType._def,e);return{...t,propertyNames:u}}else{if(((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((o=n.keyType)==null?void 0:o._def.typeName)===w.ZodBranded&&n.keyType._def.type._def.typeName===w.ZodString&&((c=n.keyType._def.type._def.checks)!=null&&c.length)){const{type:l,...u}=eu(n.keyType._def,e);return{...t,propertyNames:u}}}return t}function lg(n,e){if(e.mapStrategy==="record")return au(n,e);const t=te(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=te(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,s],minItems:2,maxItems:2}}}function ug(n){const e=n.values,t=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(t.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:t}}function pg(){return{not:{}}}function hg(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Ys={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function dg(n,e){if(e.target==="openApi3")return iu(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(s=>s._def.typeName in Ys&&(!s._def.checks||!s._def.checks.length))){const s=t.reduce((a,i)=>{const r=Ys[i._def.typeName];return r&&!a.includes(r)?[...a,r]:a},[]);return{type:s.length>1?s:s[0]}}else if(t.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=t.reduce((a,i)=>{const r=typeof i._def.value;switch(r){case"string":case"number":case"boolean":return[...a,r];case"bigint":return[...a,"integer"];case"object":if(i._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(s.length===t.length){const a=s.filter((i,r,o)=>o.indexOf(i)===r);return{type:a.length>1?a:a[0],enum:t.reduce((i,r)=>i.includes(r._def.value)?i:[...i,r._def.value],[])}}}else if(t.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((s,a)=>[...s,...a._def.values.filter(i=>!s.includes(i))],[])};return iu(n,e)}const iu=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((s,a)=>te(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return t.length?{anyOf:t}:void 0};function mg(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Ys[n.innerType._def.typeName],nullable:!0}:{type:[Ys[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=te(n.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const t=te(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function fg(n,e){const t={type:"number"};if(!n.checks)return t;for(const s of n.checks)switch(s.kind){case"int":t.type="integer",Yl(t,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?ie(t,"minimum",s.value,s.message,e):ie(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),ie(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?ie(t,"maximum",s.value,s.message,e):ie(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),ie(t,"maximum",s.value,s.message,e));break;case"multipleOf":ie(t,"multipleOf",s.value,s.message,e);break}return t}function yg(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":te(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":te(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function gg(n,e){const t=e.target==="openAi",s={type:"object",...Object.entries(n.shape()).reduce((a,[i,r])=>{if(r===void 0||r._def===void 0)return a;let o=r.isOptional();o&&t&&(r instanceof g0&&(r=r._def.innerType),r.isNullable()||(r=r.nullable()),o=!1);const c=te(r._def,{...e,currentPath:[...e.currentPath,"properties",i],propertyPath:[...e.currentPath,"properties",i]});return c===void 0?a:{properties:{...a.properties,[i]:c},required:o?a.required:[...a.required,i]}},{properties:{},required:[]}),additionalProperties:yg(n,e)};return s.required.length||delete s.required,s}const bg=(n,e)=>{var s;if(e.currentPath.toString()===((s=e.propertyPath)==null?void 0:s.toString()))return te(n.innerType._def,e);const t=te(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},wg=(n,e)=>{if(e.pipeStrategy==="input")return te(n.in._def,e);if(e.pipeStrategy==="output")return te(n.out._def,e);const t=te(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=te(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,s].filter(a=>a!==void 0)}};function vg(n,e){return te(n.type._def,e)}function xg(n,e){const t={type:"array",uniqueItems:!0,items:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ie(t,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ie(t,"maxItems",n.maxSize.value,n.maxSize.message,e),t}function _g(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,s)=>te(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[]),additionalItems:te(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,s)=>te(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[])}}function Og(){return{not:{}}}function Mg(){return{}}const Ag=(n,e)=>te(n.innerType._def,e);function te(n,e,t=!1){var r;const s=e.seen.get(n);if(e.override){const o=(r=e.override)==null?void 0:r.call(e,n,e,s,t);if(o!==Zy)return o}if(s&&!t){const o=Pg(s,e);if(o!==void 0)return o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const i=Cg(n,n.typeName,e);return i&&Sg(n,e,i),a.jsonSchema=i,i}const Pg=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Eg(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,s)=>e.currentPath[s]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Eg=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Cg=(n,e,t)=>{switch(e){case w.ZodString:return nu(n,t);case w.ZodNumber:return fg(n,t);case w.ZodObject:return gg(n,t);case w.ZodBigInt:return Gy(n,t);case w.ZodBoolean:return Xy();case w.ZodDate:return tu(n,t);case w.ZodUndefined:return Og();case w.ZodNull:return hg(t);case w.ZodArray:return Jy(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return dg(n,t);case w.ZodIntersection:return ig(n,t);case w.ZodTuple:return _g(n,t);case w.ZodRecord:return au(n,t);case w.ZodLiteral:return rg(n,t);case w.ZodEnum:return sg(n);case w.ZodNativeEnum:return ug(n);case w.ZodNullable:return mg(n,t);case w.ZodOptional:return bg(n,t);case w.ZodMap:return lg(n,t);case w.ZodSet:return xg(n,t);case w.ZodLazy:return te(n.getter()._def,t);case w.ZodPromise:return vg(n,t);case w.ZodNaN:case w.ZodNever:return pg();case w.ZodEffects:return ng(n,t);case w.ZodAny:return Hy();case w.ZodUnknown:return Mg();case w.ZodDefault:return tg(n,t);case w.ZodBranded:return eu(n,t);case w.ZodReadonly:return Ag(n,t);case w.ZodCatch:return Yy(n,t);case w.ZodPipeline:return wg(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(s=>{})()}},Sg=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),kg=(n,e)=>{const t=Qy(e),s=void 0,a=e==null?void 0:e.name,i=te(n._def,t,!1)??{},r=a===void 0?s?{...i,[t.definitionPath]:s}:i:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...s,[a]:i}};return t.target==="jsonSchema7"?r.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(r.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in r||"oneOf"in r||"allOf"in r||"type"in r&&Array.isArray(r.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),r};function ts(n){if(typeof n=="object"&&n!==null){const e={...n};"additionalProperties"in e&&delete e.additionalProperties,"$schema"in e&&delete e.$schema;for(const t in e)t in e&&(Array.isArray(e[t])?e[t]=e[t].map(ts):typeof e[t]=="object"&&e[t]!==null&&(e[t]=ts(e[t])));return e}return n}function ru(n){const e=ts(kg(n)),{$schema:t,...s}=e;return s}function Tg(n){const e=ts(n),{$schema:t,...s}=e;return s}function Ng(n){const e=n._getType();return la.isInstance(n)?n.role:e==="tool"?e:n.name??e}function Ig(n){switch(n){case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function jg(n){if("mimeType"in n&&"data"in n)return{inlineData:{mimeType:n.mimeType,data:n.data}};if("mimeType"in n&&"fileUri"in n)return{fileData:{mimeType:n.mimeType,fileUri:n.fileUri}};throw new Error("Invalid media content")}function Rg(n,e){if(typeof n.content=="string"&&n.content!=="")return[{text:n.content}];let t=[],s=[],a=[];return"tool_calls"in n&&Array.isArray(n.tool_calls)&&n.tool_calls.length>0?t=n.tool_calls.map(i=>({functionCall:{name:i.name,args:i.args}})):n.getType()==="tool"&&n.name&&n.content?s=[{functionResponse:{name:n.name,response:n.content}}]:Array.isArray(n.content)&&(a=n.content.map(i=>{var r;if(i.type==="text")return{text:i.text};if(i.type==="executableCode")return{executableCode:i.executableCode};if(i.type==="codeExecutionResult")return{codeExecutionResult:i.codeExecutionResult};if(i.type==="image_url"){if(!e)throw new Error("This model does not support images");let o;if(typeof i.image_url=="string")o=i.image_url;else if(typeof i.image_url=="object"&&"url"in i.image_url)o=i.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");const[c,l]=o.split(",");if(!c.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[u,p]=c.replace(/^data:/,"").split(";");if(p!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:l,mimeType:u}}}else{if(i.type==="media")return jg(i);if(i.type==="tool_use")return{functionCall:{name:i.name,args:i.input}};if((r=i.type)!=null&&r.includes("/")&&i.type.split("/").length===2&&"data"in i&&typeof i.data=="string")return{inlineData:{mimeType:i.type,data:i.data}}}throw new Error(`Unknown content type ${i.type}`)})),[...a,...t,...s]}function ou(n,e,t=!1){return n.reduce((s,a,i)=>{if(!$u(a))throw new Error("Unsupported message input");const r=Ng(a);if(r==="system"&&i!==0)throw new Error("System message should be the first one");const o=Ig(r),c=s.content[s.content.length];if(!s.mergeWithPreviousContent&&c&&c.role===o)throw new Error("Google Generative AI requires alternate messages between authors");const l=Rg(a,e);if(s.mergeWithPreviousContent){const h=s.content[s.content.length-1];if(!h)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return h.parts.push(...l),{mergeWithPreviousContent:!1,content:s.content}}let u=o;(u==="function"||u==="system"&&!t)&&(u="user");const p={role:u,parts:l};return{mergeWithPreviousContent:r==="system"&&!t,content:[...s.content,p]}},{content:[],mergeWithPreviousContent:!1}).content}function $g(n,e){if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};const t=n.functionCalls(),[s]=n.candidates,{content:a,...i}=s;let r;(a==null?void 0:a.parts.length)===1&&a.parts[0].text?r=a.parts[0].text:r=a.parts.map(c=>"text"in c?{type:"text",text:c.text}:"executableCode"in c?{type:"executableCode",executableCode:c.executableCode}:"codeExecutionResult"in c?{type:"codeExecutionResult",codeExecutionResult:c.codeExecutionResult}:c);let o="";return typeof r=="string"?o=r:"text"in r[0]&&(o=r[0].text),{generations:[{text:o,message:new ca({content:r,tool_calls:t==null?void 0:t.map(c=>({...c,type:"tool_call"})),additional_kwargs:{...i},usage_metadata:e==null?void 0:e.usageMetadata}),generationInfo:i}]}}function Lg(n,e){if(!n.candidates||n.candidates.length===0)return null;const t=n.functionCalls(),[s]=n.candidates,{content:a,...i}=s;let r;a!=null&&a.parts&&a.parts.every(l=>"text"in l)?r=a.parts.map(l=>l.text).join(""):a.parts&&(r=a.parts.map(l=>"text"in l?{type:"text",text:l.text}:"executableCode"in l?{type:"executableCode",executableCode:l.executableCode}:"codeExecutionResult"in l?{type:"codeExecutionResult",codeExecutionResult:l.codeExecutionResult}:l));let o="";r&&typeof r=="string"?o=r:r&&typeof r=="object"&&"text"in r[0]&&(o=r[0].text);const c=[];return t&&c.push(...t.map(l=>({...l,args:JSON.stringify(l.args),index:e.index,type:"tool_call_chunk"}))),new Qt({text:o,message:new Sn({content:r||"",name:a?a.role:void 0,tool_call_chunks:c,additional_kwargs:{},usage_metadata:e.usageMetadata}),generationInfo:i})}function Bg(n){return n.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?n:[{functionDeclarations:n.map(e=>{if(Ls(e)){const t=ru(e.schema);return{name:e.name,description:e.description,parameters:t}}return ki(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:Tg(e.function.parameters)}:e})}]}class cu extends Pc{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Is(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap(a=>{const{message:i}=a;return!("tool_calls"in i)||!Array.isArray(i.tool_calls)?[]:i.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[s]=t;return await this._validateResult(s.args)}}function lu(n,e){const t=Fg(n),s=Dg(t,e);return{tools:t,toolConfig:s}}function Fg(n){let e=[];const t=[];return n.forEach(s=>{if(Ls(s)){const[a]=Bg([s]);a.functionDeclarations&&e.push(...a.functionDeclarations)}else if(ki(s)){const{functionDeclarations:a}=qg(s);if(a)e.push(...a);else throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else t.push(s)}),t.find(s=>"functionDeclarations"in s)?t.map(s=>{if((e==null?void 0:e.length)>0&&"functionDeclarations"in s){const a={functionDeclarations:[...s.functionDeclarations||[],...e]};return e=[],a}return s}):[...t,...e.length>0?[{functionDeclarations:e}]:[]]}function qg(n){return{functionDeclarations:[{name:n.function.name,description:n.function.description,parameters:ts(n.function.parameters)}]}}function Dg(n,e){if(!n.length||!e)return;const{toolChoice:t,allowedFunctionNames:s}=e,a={any:Pn.ANY,auto:Pn.AUTO,none:Pn.NONE};if(t&&["any","auto","none"].includes(t))return{functionCallingConfig:{mode:a[t]??"MODE_UNSPECIFIED",allowedFunctionNames:s}};if(typeof t=="string"||s)return{functionCallingConfig:{mode:Pn.ANY,allowedFunctionNames:[...s??[],...t&&typeof t=="string"?[t]:[]]}}}class Ug extends kt{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){var t,s;if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=((t=e==null?void 0:e.model)==null?void 0:t.replace(/^models\//,""))??((s=e==null?void 0:e.modelName)==null?void 0:s.replace(/^models\//,""))??this.model,this.model=this.modelName,this.maxOutputTokens=(e==null?void 0:e.maxOutputTokens)??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=(e==null?void 0:e.topP)??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=(e==null?void 0:e.topK)??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=(e==null?void 0:e.stopSequences)??this.stopSequences,this.apiKey=(e==null?void 0:e.apiKey)??Rt("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=(e==null?void 0:e.safetySettings)??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(a=>a.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=(e==null?void 0:e.streaming)??this.streaming,this.client=new ua(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...e!=null&&e.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e==null?void 0:e.apiVersion,baseUrl:e==null?void 0:e.baseUrl}),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage}useCachedContent(e,t,s){this.apiKey&&(this.client=new ua(this.apiKey).getGenerativeModelFromCachedContent(e,t,s))}get useSystemInstruction(){return typeof this.convertSystemMessageToHumanContent=="boolean"?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return this.modelName==="gemini-1.0-pro-001"||this.modelName.startsWith("gemini-pro-vision")||this.modelName.startsWith("gemini-1.0-pro-vision")?!1:this.modelName!=="gemini-pro"}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){var s;return this.bind({tools:(s=lu(e))==null?void 0:s.tools,...t})}invocationParams(e){var s;const t=(s=e==null?void 0:e.tools)!=null&&s.length?lu(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return{...t!=null&&t.tools?{tools:t.tools}:{},...t!=null&&t.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,s){var u;const a=ou(e,this._isMultimodalModel,this.useSystemInstruction);let i=a;if(a[0].role==="system"){const[p]=a;this.client.systemInstruction=p,i=a.slice(1)}const r=this.invocationParams(t);if(this.streaming){const p={},h=this._streamResponseChunks(e,t,s),d={};for await(const m of h){const f=((u=m.generationInfo)==null?void 0:u.completion)??0;d[f]===void 0?d[f]=m:d[f]=d[f].concat(m)}return{generations:Object.entries(d).sort(([m],[f])=>parseInt(m,10)-parseInt(f,10)).map(([m,f])=>f),llmOutput:{estimatedTokenUsage:p}}}const o=await this.completionWithRetry({...r,contents:i});let c;if("usageMetadata"in o.response){const p=o.response.usageMetadata;c={input_tokens:p.promptTokenCount??0,output_tokens:p.candidatesTokenCount??0,total_tokens:p.totalTokenCount??0}}const l=$g(o.response,{usageMetadata:c});return await(s==null?void 0:s.handleLLMNewToken(l.generations[0].text??"")),l}async*_streamResponseChunks(e,t,s){const a=ou(e,this._isMultimodalModel,this.useSystemInstruction);let i=a;if(a[0].role==="system"){const[u]=a;this.client.systemInstruction=u,i=a.slice(1)}const r={...this.invocationParams(t),contents:i},o=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{const{stream:u}=await this.client.generateContentStream(r);return u});let c,l=0;for await(const u of o){if("usageMetadata"in u&&this.streamUsage!==!1&&t.streamUsage!==!1){const h=u.usageMetadata;if(!c)c={input_tokens:h.promptTokenCount,output_tokens:h.candidatesTokenCount,total_tokens:h.totalTokenCount};else{const d=h.candidatesTokenCount-c.output_tokens;c={input_tokens:0,output_tokens:d,total_tokens:d}}}const p=Lg(u,{usageMetadata:c,index:l});l+=1,p&&(yield p,await(s==null?void 0:s.handleLLMNewToken(p.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var s;try{return await this.client.generateContent(e)}catch(a){throw(s=a.message)!=null&&s.includes("400 Bad Request")&&(a.status=400),a}})}withStructuredOutput(e,t){const s=e,a=t==null?void 0:t.name,i=t==null?void 0:t.method,r=t==null?void 0:t.includeRaw;if(i==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let o=a??"extract",c,l;if(Hn(s)){const m=ru(s);l=[{functionDeclarations:[{name:o,description:m.description??"A function available to call.",parameters:m}]}],c=new cu({returnSingle:!0,keyName:o,zodSchema:s})}else{let m;typeof s.name=="string"&&typeof s.parameters=="object"&&s.parameters!=null?(m=s,o=s.name):m={name:o,description:s.description??"",parameters:s},l=[{functionDeclarations:[m]}],c=new cu({returnSingle:!0,keyName:o})}const u=this.bind({tools:l,tool_choice:o});if(!r)return u.pipe(c).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const p=Dt.assign({parsed:(m,f)=>c.invoke(m.raw,f)}),h=Dt.assign({parsed:()=>null}),d=p.withFallbacks({fallbacks:[h]});return ra.from([{raw:u},d]).withConfig({runName:"StructuredOutputRunnable"})}}let uu,ea,pu,hu,du,mu,fu,yu,gu,bu,wu,vu,xu,_u,Ou,Mu,Au;Vu=n=>{const e=(t,s=null)=>{let a=`{
`;return t.filter(i=>i.parent_id===s).forEach(i=>{if(i.type==="object"){const r=n.filter(c=>c.parent_id===i.id),o=e(r,i.id);a+=`  ${i.name}${i.required?"":"?"}: ${o}
`}else a+=`  // ${i.description||""}
  ${i.name}${i.required?"":"?"}: ${i.type};
`}),a+="}",a};return e(n)},Wu=n=>{const e=(s,a=null)=>{let i="";return s.filter(r=>r.parent_id===a).forEach(r=>{if(r.type==="object"){const o=e(s,r.id);i+=`    ${r.name}: z.object({
${o}    })${r.required?"":".optional()"}.describe('${r.description||""}'),
`}else i+=`    ${r.name}: z.${r.type}()${r.required?"":".optional()"}.describe('${r.description||""}'),
`}),i};let t=`const schema = z.object({
`;return t+=e(n),t+="});",t},uu=n=>{const e={},t={string:Ot.string,number:Ot.number,boolean:Ot.boolean,enum:()=>Ot.enum([""])};return n.forEach(s=>{if(!s.parent_id)if(s.type==="object"){const a=n.filter(r=>r.parent_id===s.id),i={};a.forEach(r=>{r.type==="object"||r.type==="array"||(i[r.name]=t[r.type](),r.required||(i[r.name]=i[r.name].optional()))}),e[s.name]=Ot.object(i),s.required||(e[s.name]=e[s.name].optional())}else s.type==="array"?(e[s.name]=Ot.array(Ot.string()),s.required||(e[s.name]=e[s.name].optional())):s.type==="enum"?(e[s.name]=Ot.enum((s.enum||"").split(",")),s.required||(e[s.name]=e[s.name].optional())):(e[s.name]=t[s.type](),s.required||(e[s.name]=e[s.name].optional()))}),Ot.object(e)},ir=()=>{const{toast:n}=b0(),{t:e}=Tu("errors"),t=w0(a=>a.currentSession),{modalRef:s}=nr(tr);return{confirmPassphrase:M.useCallback(async()=>{if(!(t!=null&&t.passphrase))throw new Error("Session is not found");await aa.exists("passphrase")||await new Promise((a,i)=>{s.current.show({onConfirm:async r=>{try{const o=await rs(t.passphrase,r);await aa.set("passphrase",o),a()}catch(o){n({content:e("invalid_passphrase"),variant:"destructive"}),i(o)}finally{s.current.hide()}},onCancel:()=>{i()}})})},[t==null?void 0:t.passphrase,s,e,n])}},ea=async(n,e,{schemas:t,onMessageUpdate:s})=>{let a="",i;if(t!=null&&t.length){const r=t.filter(c=>{var l;return(l=c.schema_items)==null?void 0:l.length}).flatMap(c=>c.schema_items),o=await n.withStructuredOutput(uu(r)).stream(e);for await(const c of o)a=JSON.stringify(c),s==null||s({content:a})}else{const r=await n.stream(e);for await(const o of r)a+=`${o.content}`,i=o,s==null||s({content:a,chunk:o})}return{lastChunk:i,content:a}},pu=()=>{const{confirmPassphrase:n}=ir();return{stream:M.useCallback(async(e,t)=>{var h,d,m,f,y;const{schemas:s,onMessageUpdate:a,onMessageFinish:i}=t||{};await n();const r=(h=t==null?void 0:t.llm)==null?void 0:h.encrypted,o=((d=t==null?void 0:t.llm)==null?void 0:d.options)||{};if(!(r!=null&&r.key)||typeof r.key!="string")throw new Error("API Key is not found");const c=await aa.get("passphrase");if(!c)throw new Error("Passphrase is not found");const l=await rs(r.key,c);if(!l)throw new Error("API Key is not found");let u="",p;switch(t==null?void 0:t.provider){case Mt.GoogleGenerativeAI:{const g=new Ug({apiKey:l,model:(m=t==null?void 0:t.llm)==null?void 0:m.name,temperature:o!=null&&o.temperature?+o.temperature:void 0,topK:o!=null&&o.topK?+o.topK:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxOutputTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0});if(r!=null&&r.enabled_google_search_retrieval){const O={googleSearchRetrieval:{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.7}}};g.bindTools([O])}const v=await ea(g,e,{schemas:s,onMessageUpdate:a});u=v.content,p=v.lastChunk}break;case Mt.Groq:{const g=new fy({apiKey:l,model:(f=t==null?void 0:t.llm)==null?void 0:f.name,temperature:o!=null&&o.temperature?+o.temperature:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),v=await ea(g,e,{schemas:s,onMessageUpdate:a});u=v.content,p=v.lastChunk}break;case Mt.OpenAI:{const g=new Gm({apiKey:l,model:(y=t==null?void 0:t.llm)==null?void 0:y.name,temperature:o!=null&&o.temperature?+o.temperature:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),v=await ea(g,e,{schemas:s,onMessageUpdate:a});u=v.content,p=v.lastChunk}break;default:throw new Error("Provider is not supported")}return i==null||i({content:u,lastChunk:p}),{lastChunk:p,content:u}},[n])}},Du=()=>{const n=Xu(),e=pu();return{stream:M.useCallback((t,s,a)=>{switch(t){case Mt.WebLLM:return n.stream(s,a);case Mt.GoogleGenerativeAI:case Mt.Groq:case Mt.OpenAI:return e.stream(s,{...a,provider:t});default:throw new Error("Provider is not supported")}},[e,n])}},hu=n=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",fill:"none",height:192,viewBox:"0 0 150 150",width:192,...n},M.createElement("clipPath",{id:"a"},M.createElement("path",{d:"m0 0h150v150h-150z"})),M.createElement("g",{clipPath:"url(#a)"},M.createElement("path",{d:"m150 0h-150v150h150z",fill:"#29b5e8"}),M.createElement("path",{clipRule:"evenodd",d:"m130.375 67.2532-14.096 8.1221 14.096 8.0536c.843.4872 1.581 1.1357 2.174 1.9084.592.7727 1.026 1.6545 1.278 2.5951.251.9406.315 1.9215.188 2.8867-.128.9652-.444 1.8959-.931 2.7388-.488.843-1.136 1.5817-1.909 2.174s-1.654 1.0267-2.595 1.2782-1.921.3154-2.887.1878c-.965-.1275-1.896-.444-2.739-.9312l-25.2559-14.5496c-1.1575-.6696-2.1128-1.6394-2.765-2.8068-.6523-1.1674-.9773-2.4893-.9408-3.826.0198-.5792.1089-1.1538.2653-1.7117.517-1.8711 1.7458-3.4654 3.4234-4.4419l25.256-14.4983c.847-.4892 1.782-.8067 2.751-.9343.97-.1275 1.955-.0627 2.899.1909.945.2536 1.83.6909 2.605 1.287.775.596 1.425 1.3391 1.913 2.1866.49.8402.808 1.7693.935 2.7334.128.964.063 1.9439-.191 2.8826-.254.9388-.692 1.8177-1.288 2.5859-.597.7681-1.34 1.4101-2.186 1.8887zm-13.343 39.3698-25.2478-14.5243c-1.1296-.6483-2.4091-.9896-3.7115-.9902s-2.5823.3397-3.7124.987c-1.1301.6472-2.0712 1.579-2.7297 2.7026-.6585 1.1237-1.0115 2.4001-1.0239 3.7024v29.0135c.0654 1.928.8772 3.755 2.264 5.095 1.3869 1.341 3.2403 2.09 5.1691 2.09 1.9289 0 3.7823-.749 5.1691-2.09 1.3868-1.34 2.1986-3.167 2.264-5.095v-16.261l14.1301 8.122c.843.488 1.774.805 2.739.933.966.128 1.947.064 2.888-.187s1.823-.685 2.596-1.277c.774-.592 1.423-1.331 1.91-2.174.488-.843.805-1.773.933-2.739.128-.965.065-1.946-.186-2.887s-.685-1.824-1.277-2.597-1.331-1.422-2.174-1.91zm-29.0992-28.3806-10.527 10.3986c-.3601.3349-.8269.5319-1.318.5563h-3.0897c-.49-.0294-.9551-.2257-1.318-.5563l-10.4671-10.4329c-.3274-.3573-.521-.817-.5478-1.3009v-3.081c.0283-.4861.2215-.9481.5478-1.3095l10.4671-10.4329c.3637-.3281.829-.5214 1.318-.5477h3.0897c.4899.0228.9562.2166 1.318.5477l10.4928 10.4329c.3237.3623.514.8243.5392 1.3095v3.081c-.0237.483-.2143.9428-.5392 1.3009zm-8.3874-2.8928c-.0404-.499-.2485-.9696-.5905-1.3352l-3.0383-3.004c-.3641-.3275-.8291-.5207-1.318-.5478h-.1113c-.4867.0255-.9495.2191-1.3094.5478l-3.0383 3.004c-.3262.3676-.5165.8358-.5392 1.3266v.1113c.0215.4834.2124.9439.5392 1.3009l3.0554 2.9955c.3607.3274.823.5208 1.3094.5477h.1113c.4889-.027.9539-.2203 1.318-.5477l3.0383-3.0212c.3282-.3576.5244-.8166.5563-1.3009zm-47.4914-31.2217 25.2563 14.4811c1.1308.648 2.4115.989 3.7149.9889 1.3033 0 2.584-.3409 3.7148-.989 1.1309-.648 2.0725-1.5806 2.7314-2.7051.659-1.1245 1.0123-2.4018 1.0249-3.7051v-28.9879c-.0654-1.9277-.8772-3.7546-2.264-5.0952s-3.2402-2.0899-5.1691-2.0899c-1.9288 0-3.7822.7493-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v16.2613l-14.1473-8.1307c-.8429-.4877-1.7737-.8047-2.7392-.9328-.9654-.1281-1.9466-.0647-2.8876.1864s-1.8232.6852-2.5965 1.2773c-.7732.5921-1.4222 1.3307-1.91 2.1736-.4878.843-.8048 1.7738-.9329 2.7392-.128.9655-.0647 1.9467.1864 2.8876.2512.941.6852 1.8233 1.2773 2.5965.5921.7733 1.3307 1.4223 2.1737 1.9101zm55.4252 15.4739c1.4914.118 2.9836-.2193 4.2793-.9671l25.2475-14.5496c.843-.4877 1.582-1.1368 2.174-1.91s1.026-1.6555 1.277-2.5965.315-1.9222.187-2.8876c-.128-.9655-.445-1.8962-.933-2.7392-.488-.8429-1.137-1.5816-1.91-2.1737-.774-.5921-1.656-1.0261-2.597-1.2772-1.9-.5072-3.924-.2387-5.627.7464l-14.1298 8.1991v-16.2613c-.0654-1.9277-.8772-3.7546-2.264-5.0952-1.3868-1.3405-3.2402-2.0899-5.1691-2.0899-1.9288 0-3.7822.7494-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v29.0136c-.0023 1.8784.7086 3.6876 1.9892 5.0619 1.2805 1.3743 3.0351 2.2111 4.909 2.3412zm-25.8554 31.5298c-1.4916-.1213-2.9847.2162-4.2793.9671l-25.2905 14.4893c-1.7024.985-2.9438 2.607-3.451 4.507s-.2387 3.924.7465 5.627c.9851 1.702 2.6061 2.943 4.5065 3.451 1.9004.507 3.9244.238 5.6268-.747l14.1473-8.122v16.261c.0654 1.928.8772 3.755 2.2641 5.096 1.3868 1.34 3.2402 2.09 5.169 2.09 1.9289 0 3.7823-.75 5.1691-2.09 1.3868-1.341 2.1986-3.168 2.264-5.096v-29.0645c-.0038-1.869-.7144-3.6673-1.9891-5.0341s-3.0192-2.2009-4.8834-2.3348zm-6.8468-13.5825c.4875-1.6032.414-3.3247-.2083-4.8806-.6224-1.5559-1.7564-2.8532-3.2152-3.6779l-25.2306-14.541c-1.704-.976-3.7248-1.2385-5.6216-.7303-1.8968.5083-3.5155 1.7461-4.5032 3.4433-.4889.84-.8065 1.7686-.9343 2.732-.1278.9635-.0632 1.9428.1899 2.8811.2531.9384.6897 1.8173 1.2846 2.5858.595.7686 1.3364 1.4115 2.1814 1.8917l14.096 8.1221-14.096 8.0536c-.8429.4861-1.5819 1.1334-2.1746 1.9051-.5928.7717-1.0277 1.6526-1.2801 2.5923-.2523.9398-.317 1.9201-.1905 2.8849s.4418 1.8952.9279 2.7382c.4861.8429 1.1335 1.5819 1.9051 2.1746.7717.5928 1.6526 1.0277 2.5924 1.2801.9397.2523 1.92.317 2.8848.1905s1.8952-.4418 2.7382-.9279l25.2306-14.5496c1.6248-.9071 2.8451-2.3965 3.4149-4.168z",fill:"#fff",fillRule:"evenodd"}))),du=n=>M.createElement("svg",{className:"mr-2 w-5 h-5",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",width:48,height:48,...n},M.createElement("path",{fill:"#fbc02d",d:"M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20 s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"}),M.createElement("path",{fill:"#e53935",d:"M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039 l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"}),M.createElement("path",{fill:"#4caf50",d:"M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"}),M.createElement("path",{fill:"#1565c0",d:"M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"})),mu=n=>M.createElement("svg",{className:"mr-2 w-5 h-5",width:1024,height:1024,viewBox:"0 0 1024 1024",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},M.createElement("path",{d:"M44.522 44.5217H489.739V489.739H44.522V44.5217Z",fill:"#F35325"}),M.createElement("path",{d:"M534.261 44.5217H979.478V489.739H534.261V44.5217Z",fill:"#81BC06"}),M.createElement("path",{d:"M44.522 534.261H489.739V979.478H44.522V534.261Z",fill:"#05A6F0"}),M.createElement("path",{d:"M534.261 534.261H979.478V979.478H534.261V534.261Z",fill:"#FFBA08"})),fu=n=>M.createElement("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 287.56 191",...n},M.createElement("defs",null,M.createElement("style",null,".cls-1{fill:#0081fb;}.cls-2{fill:url(#linear-gradient);}.cls-3{fill:url(#linear-gradient-2);}"),M.createElement("linearGradient",{id:"linear-gradient",x1:62.34,y1:101.45,x2:260.34,y2:91.45,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},M.createElement("stop",{offset:0,stopColor:"#0064e1"}),M.createElement("stop",{offset:.4,stopColor:"#0064e1"}),M.createElement("stop",{offset:.83,stopColor:"#0073ee"}),M.createElement("stop",{offset:1,stopColor:"#0082fb"})),M.createElement("linearGradient",{id:"linear-gradient-2",x1:41.42,y1:53,x2:41.42,y2:126,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},M.createElement("stop",{offset:0,stopColor:"#0082fb"}),M.createElement("stop",{offset:1,stopColor:"#0064e0"}))),M.createElement("title",null,"facebook-meta"),M.createElement("path",{className:"cls-1",d:"M31.06,126c0,11,2.41,19.41,5.56,24.51A19,19,0,0,0,53.19,160c8.1,0,15.51-2,29.79-21.76,11.44-15.83,24.92-38,34-52l15.36-23.6c10.67-16.39,23-34.61,37.18-47C181.07,5.6,193.54,0,206.09,0c21.07,0,41.14,12.21,56.5,35.11,16.81,25.08,25,56.67,25,89.27,0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191V160c17.63,0,22-16.2,22-34.74,0-26.42-6.16-55.74-19.73-76.69-9.63-14.86-22.11-23.94-35.84-23.94-14.85,0-26.8,11.2-40.23,31.17-7.14,10.61-14.47,23.54-22.7,38.13l-9.06,16c-18.2,32.27-22.81,39.62-31.91,51.75C84.74,183,71.12,191,53.19,191c-21.27,0-34.72-9.21-43-23.09C3.34,156.6,0,141.76,0,124.85Z"}),M.createElement("path",{className:"cls-2",d:"M24.49,37.3C38.73,15.35,59.28,0,82.85,0c13.65,0,27.22,4,41.39,15.61,15.5,12.65,32,33.48,52.63,67.81l7.39,12.32c17.84,29.72,28,45,33.93,52.22,7.64,9.26,13,12,19.94,12,17.63,0,22-16.2,22-34.74l27.4-.86c0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191c-12.8,0-24.14-2.78-36.68-14.61-9.64-9.08-20.91-25.21-29.58-39.71L146.08,93.6c-12.94-21.62-24.81-37.74-31.68-45C107,40.71,97.51,31.23,82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78Z"}),M.createElement("path",{className:"cls-3",d:"M82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78C38.61,71.62,31.06,99.34,31.06,126c0,11,2.41,19.41,5.56,24.51L10.14,167.91C3.34,156.6,0,141.76,0,124.85,0,94.1,8.44,62.05,24.49,37.3,38.73,15.35,59.28,0,82.85,0Z"})),yu=n=>M.createElement("svg",{className:"mr-2 w-5 h-5",width:256,height:233,viewBox:"0 0 256 233",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},M.createElement("path",{d:"M186.182 0h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#f7d046",d:"M209.455 0H256v46.545h-46.545z"}),M.createElement("path",{d:"M0 0h46.545v46.545H0zm0 46.545h46.545V93.09H0zm0 46.546h46.545v46.545H0zm0 46.545h46.545v46.545H0zm0 46.546h46.545v46.545H0z"}),M.createElement("path",{fill:"#f7d046",d:"M23.273 0h46.545v46.545H23.273z"}),M.createElement("path",{fill:"#f2a73b",d:"M209.455 46.545H256V93.09h-46.545zm-186.182 0h46.545V93.09H23.273z"}),M.createElement("path",{d:"M139.636 46.545h46.545V93.09h-46.545z"}),M.createElement("path",{fill:"#f2a73b",d:"M162.909 46.545h46.545V93.09h-46.545zm-93.091 0h46.545V93.09H69.818z"}),M.createElement("path",{fill:"#ee792f",d:"M116.364 93.091h46.545v46.545h-46.545zm46.545 0h46.545v46.545h-46.545zm-93.091 0h46.545v46.545H69.818z"}),M.createElement("path",{d:"M93.091 139.636h46.545v46.545H93.091z"}),M.createElement("path",{fill:"#eb5829",d:"M116.364 139.636h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#ee792f",d:"M209.455 93.091H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"}),M.createElement("path",{d:"M186.182 139.636h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#eb5829",d:"M209.455 139.636H256v46.545h-46.545z"}),M.createElement("path",{d:"M186.182 186.182h46.545v46.545h-46.545z"}),M.createElement("path",{fill:"#eb5829",d:"M23.273 139.636h46.545v46.545H23.273z"}),M.createElement("path",{fill:"#ea3326",d:"M209.455 186.182H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"})),gu="/NoLLMChat/assets/qwen-B-gSh3_v.webp",bu="/NoLLMChat/assets/smollm-CikBjd4F.png",wu="/NoLLMChat/assets/stablelm-BquePdQ7.png",vu="/NoLLMChat/assets/nomic-BjJqoFji.webp",xu="/NoLLMChat/assets/joshua-ByaReJuI.webp",_u="/NoLLMChat/assets/deepseek-CRqFMahi.png",Ou="/NoLLMChat/assets/redpajama-CmUGqSQW.png",Mu=n=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...n},M.createElement("path",{fill:"#fff",d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),Au=n=>M.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...n},M.createElement("path",{d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),Uu=M.memo(({name:n,className:e,...t})=>{const s=v0(a=>a.theme);return n=n.toLowerCase(),n.includes("gpt")?s==="dark"?z.jsx(Mu,{className:Pe("w-5 h-5",e),...t}):z.jsx(Au,{className:Pe("w-5 h-5",e),...t}):n!=null&&n.includes("deepseek")?z.jsx("img",{className:Pe("w-5 h-5 rounded-full",e),src:_u,alt:"deepseek",...t}):n!=null&&n.includes("redpajama")?z.jsx("img",{className:Pe("w-5 h-5 rounded-full",e),src:Ou,alt:"deepseek",...t}):n.includes("gemma")||n.includes("gemini")?z.jsx(du,{className:Pe("w-5 h-5",e),...t}):n!=null&&n.includes("qwen")?z.jsx("img",{className:Pe("w-5 h-5",e),src:gu,alt:"qwen",...t}):n!=null&&n.includes("phi")?z.jsx(mu,{className:Pe("w-5 h-5",e),...t}):n!=null&&n.includes("llama")?z.jsx(fu,{className:Pe("w-5 h-5",e),...t}):n!=null&&n.includes("smollm")?z.jsx("img",{className:Pe("w-5 h-5",e),src:bu,alt:"smollm",...t}):n!=null&&n.includes("mistral")?z.jsx(yu,{className:Pe("w-5 h-5",e),...t}):n!=null&&n.includes("snowflake")?z.jsx(hu,{className:Pe("w-5 h-5 rounded-full",e),...t}):n!=null&&n.includes("stablelm")?z.jsx("img",{className:Pe("w-5 h-5 rounded-full",e),src:wu,alt:"stablelm",...t}):n!=null&&n.includes("nomic")?z.jsx("img",{className:Pe("w-5 h-5 rounded-full",e),src:vu,alt:"nomic",...t}):n!=null&&n.includes("Xenova")||n!=null&&n.includes("janus")?z.jsx("img",{className:Pe("w-5 h-5 rounded-full",e),src:xu,alt:"Xenova",...t}):z.jsx(x0,{className:Pe("w-5 h-5",e),name:"brain"})})});export{ua as G,Yi as I,er as L,H as O,tr as S,M0 as __tla,nr as a,Du as b,Uu as c,Wu as d,Mt as e,sr as f,pa as g,is as h,Bt as i,ha as j,zu as k,ar as l,ir as m,Zu as n,Vu as o,Ku as p,rs as q,rr as r,or as s,da as t,Qu as u,ma as w};
