var Xy=Object.defineProperty;var Yy=(kt,Mt,Yt)=>Mt in kt?Xy(kt,Mt,{enumerable:!0,configurable:!0,writable:!0,value:Yt}):kt[Mt]=Yt;var Ku=(kt,Mt,Yt)=>Yy(kt,typeof Mt!="symbol"?Mt+"":Mt,Yt);import{G as Ju,Y as eg,Z as Xt,g as tg,B as ze,r as E,j as H,c as Oe,v as ng,w as Hu,e as Gu,I as Hi,f as rg,d as sg,L as ig,__tla as ag}from"./index-CMO0DEG8.js";import{aH as Zu,aI as Xu,aJ as wn,aK as is,u as Yu,l as ep,aL as og,aM as tp,A as At,p as xt,t as lg,v as cg,w as ug,x as pg,aN as hg,aO as dg,B as mg,an as as,H as np,aP as fg,aQ as yg,S as rp,ah as os,aR as gg,aS as bg,aT as Zn,aU as sp,aV as wg,aW as _g,aX as ip,aY as Gi,aZ as ap,a_ as vg,a$ as op,b0 as Zi,b1 as qt,b2 as lp,b3 as Ot,b4 as St,b5 as cp,b6 as ls,b7 as xg,b8 as Og,b9 as Mg,ai as Eg,ba as Cg,bb as Dt,bc as Ag,bd as Sg,be as Pg,bf as kg,bg as Tg,bh as up,bi as Rg,bj as pp,ak as cs,bk as us,bl as hp,bm as _n,bn as ps,bo as dp,bp as mp,bq as fp,br as Ng,bs as jg,bt as Xi,bu as Yi,bv as Xn,bw as yp,bx as Ig,e as $g,__tla as Lg}from"./routes-PTuNXW4r.js";import gp from"./dot-DgXqs9Cs.js";let ea,hs,ta,Ye,Z,na,ra,sa,bp,ia,aa,Yn,ds,er,oa,ms,tr,wp,Pt,fs,_p,vp,la,xp,Ft,Op,nr,Bg=Promise.all([(()=>{try{return ag}catch{}})(),(()=>{try{return Lg}catch{}})()]).then(async()=>{ds=globalThis||void 0||self,sa=(n=>(n.Started="started",n.Downloading="downloading",n.Downloaded="downloaded",n.Loading="loading",n.Loaded="loaded",n))(sa||{}),oa=(n=>(n.LLM="LLM",n.embedding="embedding",n.VLM="VLM",n))(oa||{}),Ye=(n=>(n.WebLLM="WebLLM",n.Wllama="Wllama",n.OpenAI="OpenAI",n.Groq="Groq",n.GoogleGenerativeAI="GoogleGenerativeAI",n))(Ye||{});function kt(n,e,t,r,s){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Zu(e),a=Zu(n),o=!1,l=a.length-1;l>=0;l--){var c=a[l],u=n[c];if(Xu(e,c)&&!(e[c]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var p=e[c];typeof u=="object"&&u!=null&&typeof p=="object"&&p!=null&&Array.isArray(u)===Array.isArray(p)?kt(u,p,t,r+"/"+wn(c),s):u!==p&&(s&&t.push({op:"test",path:r+"/"+wn(c),value:is(u)}),t.push({op:"replace",path:r+"/"+wn(c),value:is(p)}))}else Array.isArray(n)===Array.isArray(e)?(s&&t.push({op:"test",path:r+"/"+wn(c),value:is(u)}),t.push({op:"remove",path:r+"/"+wn(c)}),o=!0):(s&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}))}if(!(!o&&i.length==a.length))for(var l=0;l<i.length;l++){var c=i[l];!Xu(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+wn(c),value:is(e[c])})}}}function Mt(n,e,t=!1){var r=[];return kt(n,e,r,"",t),r}er=function(n,e){const t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;const r=n.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!er(n[s],e[s]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;const r=Object.keys(n),s=Object.keys(e);if(r.length!==s.length)return!1;for(const i of r)if(!er(n[i],e[i]))return!1;return!0}return n===e};class Yt{getState(){return Yu.getState()}async loadModel(e){await this.getState().loadModel(e,{provider:"WebLLM"})}async unloadModel(){this.getState().unLoadModel()}async getCurrentModel(){var e;return(e=await this.getState().getCurrentModelInfo())==null?void 0:e.model}chatCompletion(e,t={}){const r=this.getState(),{stream:s=!0,response_format:i,tools:a,...o}=t,l={provider:"WebLLM",stream:s,...o};if((i==null?void 0:i.type)==="json_object"&&(l.response_format=i),a!=null&&a.length&&(l.tools=a),s){const c=r.chatCompletion(e,l);return this.streamResponse(c)}else return this.nonStreamResponse(r,e,l)}async nonStreamResponse(e,t,r){var s;return{content:((s=await e.chatCompletion(t,{...r,stream:!1}))==null?void 0:s.content)||"",usage:{}}}async*streamResponse(e){for await(const t of e)yield{content:(t==null?void 0:t.content)||"",chunk:t}}}const Ep=new Yt;class Cp{constructor(){Ku(this,"currentModel")}async loadModel(e){await ep(e,{provider:"Wllama"}),this.currentModel=e}async unloadModel(){await og(),this.currentModel=void 0}getCurrentModel(){return this.currentModel}chatCompletion(e,t={}){const{stream:r=!0,response_format:s,tools:i}=t;if((s==null?void 0:s.type)==="json_object")throw new Error("Structured output not supported in Wllama yet");if(i!=null&&i.length)throw new Error("Function calling not supported in Wllama yet");return r?this.streamResponse(e):this.nonStreamResponse(e)}async nonStreamResponse(e){let t="";return await tp(e,{onNewToken:(r,s,i)=>{t+=i}}),{content:t,usage:{}}}async*streamResponse(e){let t=null;const r=[],s=tp(e,{onNewToken:(a,o,l)=>{r.push({content:l,chunk:new At(l)}),t&&(t(),t=null)}});let i=0;for(;;)if(i<r.length)yield r[i],i++;else if(await Promise.race([s.then(()=>!0),new Promise(a=>{t=()=>a(!1)})])){for(;i<r.length;)yield r[i],i++;break}}}const vn=new Cp,ys=Ep,gs=vn;var ua={},pa;function Ap(){if(pa)return ua;pa=1;var n;return function(e){(function(t){var r=typeof globalThis=="object"?globalThis:typeof Ju=="object"?Ju:typeof self=="object"?self:typeof this=="object"?this:l(),s=i(e);typeof r.Reflect<"u"&&(s=i(r.Reflect,s)),t(s,r),typeof r.Reflect>"u"&&(r.Reflect=e);function i(c,u){return function(p,h){Object.defineProperty(c,p,{configurable:!0,writable:!0,value:h}),u&&u(p,h)}}function a(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function l(){return a()||o()}})(function(t,r){var s=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",a=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",l=typeof Object.create=="function",c={__proto__:[]}instanceof Array,u=!l&&!c,p={create:l?function(){return Gn(Object.create(null))}:c?function(){return Gn({__proto__:null})}:function(){return Gn({})},has:u?function(w,x){return s.call(w,x)}:function(w,x){return x in w},get:u?function(w,x){return s.call(w,x)?w[x]:void 0}:function(w,x){return w[x]}},h=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:rs(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:ss(),y=typeof WeakMap=="function"?WeakMap:Ji(),f=i?Symbol.for("@reflect-metadata:registry"):void 0,g=Xe(),b=_t(g);function _(w,x,O,A){if(L(O)){if(!Lt(w))throw new TypeError;if(!F(x))throw new TypeError;return ee(w,x)}else{if(!Lt(w))throw new TypeError;if(!ce(x))throw new TypeError;if(!ce(A)&&!L(A)&&!We(A))throw new TypeError;return We(A)&&(A=void 0),O=Ve(O),Ge(w,x,O,A)}}t("decorate",_);function M(w,x){function O(A,D){if(!ce(A))throw new TypeError;if(!L(D)&&!K(D))throw new TypeError;Ue(w,x,A,D)}return O}t("metadata",M);function S(w,x,O,A){if(!ce(O))throw new TypeError;return L(A)||(A=Ve(A)),Ue(w,x,O,A)}t("defineMetadata",S);function C(w,x,O){if(!ce(x))throw new TypeError;return L(O)||(O=Ve(O)),Be(w,x,O)}t("hasMetadata",C);function W(w,x,O){if(!ce(x))throw new TypeError;return L(O)||(O=Ve(O)),Fe(w,x,O)}t("hasOwnMetadata",W);function V(w,x,O){if(!ce(x))throw new TypeError;return L(O)||(O=Ve(O)),le(w,x,O)}t("getMetadata",V);function q(w,x,O){if(!ce(x))throw new TypeError;return L(O)||(O=Ve(O)),ut(w,x,O)}t("getOwnMetadata",q);function $(w,x){if(!ce(w))throw new TypeError;return L(x)||(x=Ve(x)),$t(w,x)}t("getMetadataKeys",$);function re(w,x){if(!ce(w))throw new TypeError;return L(x)||(x=Ve(x)),Ze(w,x)}t("getOwnMetadataKeys",re);function pe(w,x,O){if(!ce(x))throw new TypeError;if(L(O)||(O=Ve(O)),!ce(x))throw new TypeError;L(O)||(O=Ve(O));var A=nt(x,O,!1);return L(A)?!1:A.OrdinaryDeleteMetadata(w,x,O)}t("deleteMetadata",pe);function ee(w,x){for(var O=w.length-1;O>=0;--O){var A=w[O],D=A(x);if(!L(D)&&!We(D)){if(!F(D))throw new TypeError;x=D}}return x}function Ge(w,x,O,A){for(var D=w.length-1;D>=0;--D){var Ae=w[D],xe=Ae(x,O,A);if(!L(xe)&&!We(xe)){if(!ce(xe))throw new TypeError;A=xe}}return A}function Be(w,x,O){var A=Fe(w,x,O);if(A)return!0;var D=ue(x);return We(D)?!1:Be(w,D,O)}function Fe(w,x,O){var A=nt(x,O,!1);return L(A)?!1:et(A.OrdinaryHasOwnMetadata(w,x,O))}function le(w,x,O){var A=Fe(w,x,O);if(A)return ut(w,x,O);var D=ue(x);if(!We(D))return le(w,D,O)}function ut(w,x,O){var A=nt(x,O,!1);if(!L(A))return A.OrdinaryGetOwnMetadata(w,x,O)}function Ue(w,x,O,A){var D=nt(O,A,!0);D.OrdinaryDefineOwnMetadata(w,x,O,A)}function $t(w,x){var O=Ze(w,x),A=ue(w);if(A===null)return O;var D=$t(A,x);if(D.length<=0)return O;if(O.length<=0)return D;for(var Ae=new m,xe=[],X=0,R=O;X<R.length;X++){var N=R[X],j=Ae.has(N);j||(Ae.add(N),xe.push(N))}for(var I=0,Y=D;I<Y.length;I++){var N=Y[I],j=Ae.has(N);j||(Ae.add(N),xe.push(N))}return xe}function Ze(w,x){var O=nt(w,x,!1);return O?O.OrdinaryOwnMetadataKeys(w,x):[]}function bt(w){if(w===null)return 1;switch(typeof w){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return w===null?1:6;default:return 6}}function L(w){return w===void 0}function We(w){return w===null}function wt(w){return typeof w=="symbol"}function ce(w){return typeof w=="object"?w!==null:typeof w=="function"}function Zt(w,x){switch(bt(w)){case 0:return w;case 1:return w;case 2:return w;case 3:return w;case 4:return w;case 5:return w}var O="string",A=Re(w,a);if(A!==void 0){var D=A.call(w,O);if(ce(D))throw new TypeError;return D}return $e(w)}function $e(w,x){var O,A;{var D=w.toString;if(Bt(D)){var A=D.call(w);if(!ce(A))return A}var O=w.valueOf;if(Bt(O)){var A=O.call(w);if(!ce(A))return A}}throw new TypeError}function et(w){return!!w}function pt(w){return""+w}function Ve(w){var x=Zt(w);return wt(x)?x:pt(x)}function Lt(w){return Array.isArray?Array.isArray(w):w instanceof Object?w instanceof Array:Object.prototype.toString.call(w)==="[object Array]"}function Bt(w){return typeof w=="function"}function F(w){return typeof w=="function"}function K(w){switch(bt(w)){case 3:return!0;case 4:return!0;default:return!1}}function de(w,x){return w===x||w!==w&&x!==x}function Re(w,x){var O=w[x];if(O!=null){if(!Bt(O))throw new TypeError;return O}}function Ce(w){var x=Re(w,o);if(!Bt(x))throw new TypeError;var O=x.call(w);if(!ce(O))throw new TypeError;return O}function se(w){return w.value}function ve(w){var x=w.next();return x.done?!1:x}function me(w){var x=w.return;x&&x.call(w)}function ue(w){var x=Object.getPrototypeOf(w);if(typeof w!="function"||w===h||x!==h)return x;var O=w.prototype,A=O&&Object.getPrototypeOf(O);if(A==null||A===Object.prototype)return x;var D=A.constructor;return typeof D!="function"||D===w?x:D}function tt(){var w;!L(f)&&typeof r.Reflect<"u"&&!(f in r.Reflect)&&typeof r.Reflect.defineMetadata=="function"&&(w=vt(r.Reflect));var x,O,A,D=new y,Ae={registerProvider:xe,getProvider:R,setProvider:j};return Ae;function xe(I){if(!Object.isExtensible(Ae))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case w===I:break;case L(x):x=I;break;case x===I:break;case L(O):O=I;break;case O===I:break;default:A===void 0&&(A=new m),A.add(I);break}}function X(I,Y){if(!L(x)){if(x.isProviderFor(I,Y))return x;if(!L(O)){if(O.isProviderFor(I,Y))return x;if(!L(A))for(var oe=Ce(A);;){var ge=ve(oe);if(!ge)return;var ht=se(ge);if(ht.isProviderFor(I,Y))return me(oe),ht}}}if(!L(w)&&w.isProviderFor(I,Y))return w}function R(I,Y){var oe=D.get(I),ge;return L(oe)||(ge=oe.get(Y)),L(ge)&&(ge=X(I,Y),L(ge)||(L(oe)&&(oe=new d,D.set(I,oe)),oe.set(Y,ge))),ge}function N(I){if(L(I))throw new TypeError;return x===I||O===I||!L(A)&&A.has(I)}function j(I,Y,oe){if(!N(oe))throw new Error("Metadata provider not registered.");var ge=R(I,Y);if(ge!==oe){if(!L(ge))return!1;var ht=D.get(I);L(ht)&&(ht=new d,D.set(I,ht)),ht.set(Y,oe)}return!0}}function Xe(){var w;return!L(f)&&ce(r.Reflect)&&Object.isExtensible(r.Reflect)&&(w=r.Reflect[f]),L(w)&&(w=tt()),!L(f)&&ce(r.Reflect)&&Object.isExtensible(r.Reflect)&&Object.defineProperty(r.Reflect,f,{enumerable:!1,configurable:!1,writable:!1,value:w}),w}function _t(w){var x=new y,O={isProviderFor:function(N,j){var I=x.get(N);return L(I)?!1:I.has(j)},OrdinaryDefineOwnMetadata:xe,OrdinaryHasOwnMetadata:D,OrdinaryGetOwnMetadata:Ae,OrdinaryOwnMetadataKeys:X,OrdinaryDeleteMetadata:R};return g.registerProvider(O),O;function A(N,j,I){var Y=x.get(N),oe=!1;if(L(Y)){if(!I)return;Y=new d,x.set(N,Y),oe=!0}var ge=Y.get(j);if(L(ge)){if(!I)return;if(ge=new d,Y.set(j,ge),!w.setProvider(N,j,O))throw Y.delete(j),oe&&x.delete(N),new Error("Wrong provider for target.")}return ge}function D(N,j,I){var Y=A(j,I,!1);return L(Y)?!1:et(Y.has(N))}function Ae(N,j,I){var Y=A(j,I,!1);if(!L(Y))return Y.get(N)}function xe(N,j,I,Y){var oe=A(I,Y,!0);oe.set(N,j)}function X(N,j){var I=[],Y=A(N,j,!1);if(L(Y))return I;for(var oe=Y.keys(),ge=Ce(oe),ht=0;;){var Qu=ve(ge);if(!Qu)return I.length=ht,I;var Gy=se(Qu);try{I[ht]=Gy}catch(Zy){try{me(ge)}finally{throw Zy}}ht++}}function R(N,j,I){var Y=A(j,I,!1);if(L(Y)||!Y.delete(N))return!1;if(Y.size===0){var oe=x.get(j);L(oe)||(oe.delete(I),oe.size===0&&x.delete(oe))}return!0}}function vt(w){var x=w.defineMetadata,O=w.hasOwnMetadata,A=w.getOwnMetadata,D=w.getOwnMetadataKeys,Ae=w.deleteMetadata,xe=new y,X={isProviderFor:function(R,N){var j=xe.get(R);return!L(j)&&j.has(N)?!0:D(R,N).length?(L(j)&&(j=new m,xe.set(R,j)),j.add(N),!0):!1},OrdinaryDefineOwnMetadata:x,OrdinaryHasOwnMetadata:O,OrdinaryGetOwnMetadata:A,OrdinaryOwnMetadataKeys:D,OrdinaryDeleteMetadata:Ae};return X}function nt(w,x,O){var A=g.getProvider(w,x);if(!L(A))return A;if(O){if(g.setProvider(w,x,b))return b;throw new Error("Illegal state.")}}function rs(){var w={},x=[],O=function(){function X(R,N,j){this._index=0,this._keys=R,this._values=N,this._selector=j}return X.prototype["@@iterator"]=function(){return this},X.prototype[o]=function(){return this},X.prototype.next=function(){var R=this._index;if(R>=0&&R<this._keys.length){var N=this._selector(this._keys[R],this._values[R]);return R+1>=this._keys.length?(this._index=-1,this._keys=x,this._values=x):this._index++,{value:N,done:!1}}return{value:void 0,done:!0}},X.prototype.throw=function(R){throw this._index>=0&&(this._index=-1,this._keys=x,this._values=x),R},X.prototype.return=function(R){return this._index>=0&&(this._index=-1,this._keys=x,this._values=x),{value:R,done:!0}},X}(),A=function(){function X(){this._keys=[],this._values=[],this._cacheKey=w,this._cacheIndex=-2}return Object.defineProperty(X.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),X.prototype.has=function(R){return this._find(R,!1)>=0},X.prototype.get=function(R){var N=this._find(R,!1);return N>=0?this._values[N]:void 0},X.prototype.set=function(R,N){var j=this._find(R,!0);return this._values[j]=N,this},X.prototype.delete=function(R){var N=this._find(R,!1);if(N>=0){for(var j=this._keys.length,I=N+1;I<j;I++)this._keys[I-1]=this._keys[I],this._values[I-1]=this._values[I];return this._keys.length--,this._values.length--,de(R,this._cacheKey)&&(this._cacheKey=w,this._cacheIndex=-2),!0}return!1},X.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=w,this._cacheIndex=-2},X.prototype.keys=function(){return new O(this._keys,this._values,D)},X.prototype.values=function(){return new O(this._keys,this._values,Ae)},X.prototype.entries=function(){return new O(this._keys,this._values,xe)},X.prototype["@@iterator"]=function(){return this.entries()},X.prototype[o]=function(){return this.entries()},X.prototype._find=function(R,N){if(!de(this._cacheKey,R)){this._cacheIndex=-1;for(var j=0;j<this._keys.length;j++)if(de(this._keys[j],R)){this._cacheIndex=j;break}}return this._cacheIndex<0&&N&&(this._cacheIndex=this._keys.length,this._keys.push(R),this._values.push(void 0)),this._cacheIndex},X}();return A;function D(X,R){return X}function Ae(X,R){return R}function xe(X,R){return[X,R]}}function ss(){var w=function(){function x(){this._map=new d}return Object.defineProperty(x.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),x.prototype.has=function(O){return this._map.has(O)},x.prototype.add=function(O){return this._map.set(O,O),this},x.prototype.delete=function(O){return this._map.delete(O)},x.prototype.clear=function(){this._map.clear()},x.prototype.keys=function(){return this._map.keys()},x.prototype.values=function(){return this._map.keys()},x.prototype.entries=function(){return this._map.entries()},x.prototype["@@iterator"]=function(){return this.keys()},x.prototype[o]=function(){return this.keys()},x}();return w}function Ji(){var w=16,x=p.create(),O=A();return function(){function R(){this._key=A()}return R.prototype.has=function(N){var j=D(N,!1);return j!==void 0?p.has(j,this._key):!1},R.prototype.get=function(N){var j=D(N,!1);return j!==void 0?p.get(j,this._key):void 0},R.prototype.set=function(N,j){var I=D(N,!0);return I[this._key]=j,this},R.prototype.delete=function(N){var j=D(N,!1);return j!==void 0?delete j[this._key]:!1},R.prototype.clear=function(){this._key=A()},R}();function A(){var R;do R="@@WeakMap@@"+X();while(p.has(x,R));return x[R]=!0,R}function D(R,N){if(!s.call(R,O)){if(!N)return;Object.defineProperty(R,O,{value:p.create()})}return R[O]}function Ae(R,N){for(var j=0;j<N;++j)R[j]=Math.random()*255|0;return R}function xe(R){if(typeof Uint8Array=="function"){var N=new Uint8Array(R);return typeof crypto<"u"?crypto.getRandomValues(N):typeof msCrypto<"u"?msCrypto.getRandomValues(N):Ae(N,R),N}return Ae(new Array(R),R)}function X(){var R=xe(w);R[6]=R[6]&79|64,R[8]=R[8]&191|128;for(var N="",j=0;j<w;++j){var I=R[j];(j===4||j===6||j===8)&&(N+="-"),I<16&&(N+="0"),N+=I.toString(16).toLowerCase()}return N}}function Gn(w){return w.__=void 0,delete w.__,w}})}(n||(n={})),ua}Ap(),typeof window<"u"&&(window.Buffer=eg),typeof ds<"u"&&typeof require<"u"&&(ds.Buffer=require("buffer/").Buffer);class fe{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const r of t)for(const s of Object.getOwnPropertyNames(r))e[s]=r[s]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class T extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class en extends T{constructor(){super("Locking not supported on given driver.")}}class bs extends T{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class ie{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class Sp extends T{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return ie.isEntitySchema(e)?e.options.name:typeof e=="function"||fe.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class ha extends T{constructor(e,t,r){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${r}.`)}}class da extends T{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class Pp extends T{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class sr extends T{constructor(){super("OUTPUT or RETURNING clause only supported by Microsoft SQL Server or PostgreSQL or MariaDB databases.")}}class dt extends T{constructor(e,t){super(e),Object.setPrototypeOf(this,dt.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class kp extends T{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class Tp extends T{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class xn extends T{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class Rp extends T{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class Np extends T{constructor(){super("An open transaction is required for pessimistic lock.")}}class jp extends T{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class ma{constructor(e){fe.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new T(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class mt{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,r]=e.split(".");return!(!t||!r||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var ws={exports:{}},_s={exports:{}},fa;Ft=function(){return fa||(fa=1,typeof Object.create=="function"?_s.exports=function(n,e){e&&(n.super_=e,n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}))}:_s.exports=function(n,e){if(e){n.super_=e;var t=function(){};t.prototype=e.prototype,n.prototype=new t,n.prototype.constructor=n}}),_s.exports};var vs,ya;function tn(){if(ya)return vs;ya=1;var n=Xt().Buffer;function e(t,r){this._block=n.alloc(t),this._finalSize=r,this._blockSize=t,this._len=0}return e.prototype.update=function(t,r){typeof t=="string"&&(r=r||"utf8",t=n.from(t,r));for(var s=this._block,i=this._blockSize,a=t.length,o=this._len,l=0;l<a;){for(var c=o%i,u=Math.min(a-l,i-c),p=0;p<u;p++)s[c+p]=t[l+p];o+=u,l+=u,o%i===0&&this._update(s)}return this._len+=a,this},e.prototype.digest=function(t){var r=this._len%this._blockSize;this._block[r]=128,this._block.fill(0,r+1),r>=this._finalSize&&(this._update(this._block),this._block.fill(0));var s=this._len*8;if(s<=4294967295)this._block.writeUInt32BE(s,this._blockSize-4);else{var i=(s&4294967295)>>>0,a=(s-i)/4294967296;this._block.writeUInt32BE(a,this._blockSize-8),this._block.writeUInt32BE(i,this._blockSize-4)}this._update(this._block);var o=this._hash();return t?o.toString(t):o},e.prototype._update=function(){throw new Error("_update must be implemented by subclass")},vs=e,vs}var xs,ga;function Ip(){if(ga)return xs;ga=1;var n=Ft(),e=tn(),t=Xt().Buffer,r=[1518500249,1859775393,-1894007588,-899497514],s=new Array(80);function i(){this.init(),this._w=s,e.call(this,64,56)}n(i,e),i.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function a(c){return c<<5|c>>>27}function o(c){return c<<30|c>>>2}function l(c,u,p,h){return c===0?u&p|~u&h:c===2?u&p|u&h|p&h:u^p^h}return i.prototype._update=function(c){for(var u=this._w,p=this._a|0,h=this._b|0,d=this._c|0,m=this._d|0,y=this._e|0,f=0;f<16;++f)u[f]=c.readInt32BE(f*4);for(;f<80;++f)u[f]=u[f-3]^u[f-8]^u[f-14]^u[f-16];for(var g=0;g<80;++g){var b=~~(g/20),_=a(p)+l(b,h,d,m)+y+u[g]+r[b]|0;y=m,m=d,d=o(h),h=p,p=_}this._a=p+this._a|0,this._b=h+this._b|0,this._c=d+this._c|0,this._d=m+this._d|0,this._e=y+this._e|0},i.prototype._hash=function(){var c=t.allocUnsafe(20);return c.writeInt32BE(this._a|0,0),c.writeInt32BE(this._b|0,4),c.writeInt32BE(this._c|0,8),c.writeInt32BE(this._d|0,12),c.writeInt32BE(this._e|0,16),c},xs=i,xs}var Os,ba;function $p(){if(ba)return Os;ba=1;var n=Ft(),e=tn(),t=Xt().Buffer,r=[1518500249,1859775393,-1894007588,-899497514],s=new Array(80);function i(){this.init(),this._w=s,e.call(this,64,56)}n(i,e),i.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function a(u){return u<<1|u>>>31}function o(u){return u<<5|u>>>27}function l(u){return u<<30|u>>>2}function c(u,p,h,d){return u===0?p&h|~p&d:u===2?p&h|p&d|h&d:p^h^d}return i.prototype._update=function(u){for(var p=this._w,h=this._a|0,d=this._b|0,m=this._c|0,y=this._d|0,f=this._e|0,g=0;g<16;++g)p[g]=u.readInt32BE(g*4);for(;g<80;++g)p[g]=a(p[g-3]^p[g-8]^p[g-14]^p[g-16]);for(var b=0;b<80;++b){var _=~~(b/20),M=o(h)+c(_,d,m,y)+f+p[b]+r[_]|0;f=y,y=m,m=l(d),d=h,h=M}this._a=h+this._a|0,this._b=d+this._b|0,this._c=m+this._c|0,this._d=y+this._d|0,this._e=f+this._e|0},i.prototype._hash=function(){var u=t.allocUnsafe(20);return u.writeInt32BE(this._a|0,0),u.writeInt32BE(this._b|0,4),u.writeInt32BE(this._c|0,8),u.writeInt32BE(this._d|0,12),u.writeInt32BE(this._e|0,16),u},Os=i,Os}var Ms,wa;function _a(){if(wa)return Ms;wa=1;var n=Ft(),e=tn(),t=Xt().Buffer,r=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],s=new Array(64);function i(){this.init(),this._w=s,e.call(this,64,56)}n(i,e),i.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function a(h,d,m){return m^h&(d^m)}function o(h,d,m){return h&d|m&(h|d)}function l(h){return(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10)}function c(h){return(h>>>6|h<<26)^(h>>>11|h<<21)^(h>>>25|h<<7)}function u(h){return(h>>>7|h<<25)^(h>>>18|h<<14)^h>>>3}function p(h){return(h>>>17|h<<15)^(h>>>19|h<<13)^h>>>10}return i.prototype._update=function(h){for(var d=this._w,m=this._a|0,y=this._b|0,f=this._c|0,g=this._d|0,b=this._e|0,_=this._f|0,M=this._g|0,S=this._h|0,C=0;C<16;++C)d[C]=h.readInt32BE(C*4);for(;C<64;++C)d[C]=p(d[C-2])+d[C-7]+u(d[C-15])+d[C-16]|0;for(var W=0;W<64;++W){var V=S+c(b)+a(b,_,M)+r[W]+d[W]|0,q=l(m)+o(m,y,f)|0;S=M,M=_,_=b,b=g+V|0,g=f,f=y,y=m,m=V+q|0}this._a=m+this._a|0,this._b=y+this._b|0,this._c=f+this._c|0,this._d=g+this._d|0,this._e=b+this._e|0,this._f=_+this._f|0,this._g=M+this._g|0,this._h=S+this._h|0},i.prototype._hash=function(){var h=t.allocUnsafe(32);return h.writeInt32BE(this._a,0),h.writeInt32BE(this._b,4),h.writeInt32BE(this._c,8),h.writeInt32BE(this._d,12),h.writeInt32BE(this._e,16),h.writeInt32BE(this._f,20),h.writeInt32BE(this._g,24),h.writeInt32BE(this._h,28),h},Ms=i,Ms}var Es,va;function Lp(){if(va)return Es;va=1;var n=Ft(),e=_a(),t=tn(),r=Xt().Buffer,s=new Array(64);function i(){this.init(),this._w=s,t.call(this,64,56)}return n(i,e),i.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},i.prototype._hash=function(){var a=r.allocUnsafe(28);return a.writeInt32BE(this._a,0),a.writeInt32BE(this._b,4),a.writeInt32BE(this._c,8),a.writeInt32BE(this._d,12),a.writeInt32BE(this._e,16),a.writeInt32BE(this._f,20),a.writeInt32BE(this._g,24),a},Es=i,Es}var Cs,xa;function Oa(){if(xa)return Cs;xa=1;var n=Ft(),e=tn(),t=Xt().Buffer,r=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],s=new Array(160);function i(){this.init(),this._w=s,e.call(this,128,112)}n(i,e),i.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function a(y,f,g){return g^y&(f^g)}function o(y,f,g){return y&f|g&(y|f)}function l(y,f){return(y>>>28|f<<4)^(f>>>2|y<<30)^(f>>>7|y<<25)}function c(y,f){return(y>>>14|f<<18)^(y>>>18|f<<14)^(f>>>9|y<<23)}function u(y,f){return(y>>>1|f<<31)^(y>>>8|f<<24)^y>>>7}function p(y,f){return(y>>>1|f<<31)^(y>>>8|f<<24)^(y>>>7|f<<25)}function h(y,f){return(y>>>19|f<<13)^(f>>>29|y<<3)^y>>>6}function d(y,f){return(y>>>19|f<<13)^(f>>>29|y<<3)^(y>>>6|f<<26)}function m(y,f){return y>>>0<f>>>0?1:0}return i.prototype._update=function(y){for(var f=this._w,g=this._ah|0,b=this._bh|0,_=this._ch|0,M=this._dh|0,S=this._eh|0,C=this._fh|0,W=this._gh|0,V=this._hh|0,q=this._al|0,$=this._bl|0,re=this._cl|0,pe=this._dl|0,ee=this._el|0,Ge=this._fl|0,Be=this._gl|0,Fe=this._hl|0,le=0;le<32;le+=2)f[le]=y.readInt32BE(le*4),f[le+1]=y.readInt32BE(le*4+4);for(;le<160;le+=2){var ut=f[le-30],Ue=f[le-15*2+1],$t=u(ut,Ue),Ze=p(Ue,ut);ut=f[le-2*2],Ue=f[le-2*2+1];var bt=h(ut,Ue),L=d(Ue,ut),We=f[le-7*2],wt=f[le-7*2+1],ce=f[le-16*2],Zt=f[le-16*2+1],$e=Ze+wt|0,et=$t+We+m($e,Ze)|0;$e=$e+L|0,et=et+bt+m($e,L)|0,$e=$e+Zt|0,et=et+ce+m($e,Zt)|0,f[le]=et,f[le+1]=$e}for(var pt=0;pt<160;pt+=2){et=f[pt],$e=f[pt+1];var Ve=o(g,b,_),Lt=o(q,$,re),Bt=l(g,q),F=l(q,g),K=c(S,ee),de=c(ee,S),Re=r[pt],Ce=r[pt+1],se=a(S,C,W),ve=a(ee,Ge,Be),me=Fe+de|0,ue=V+K+m(me,Fe)|0;me=me+ve|0,ue=ue+se+m(me,ve)|0,me=me+Ce|0,ue=ue+Re+m(me,Ce)|0,me=me+$e|0,ue=ue+et+m(me,$e)|0;var tt=F+Lt|0,Xe=Bt+Ve+m(tt,F)|0;V=W,Fe=Be,W=C,Be=Ge,C=S,Ge=ee,ee=pe+me|0,S=M+ue+m(ee,pe)|0,M=_,pe=re,_=b,re=$,b=g,$=q,q=me+tt|0,g=ue+Xe+m(q,me)|0}this._al=this._al+q|0,this._bl=this._bl+$|0,this._cl=this._cl+re|0,this._dl=this._dl+pe|0,this._el=this._el+ee|0,this._fl=this._fl+Ge|0,this._gl=this._gl+Be|0,this._hl=this._hl+Fe|0,this._ah=this._ah+g+m(this._al,q)|0,this._bh=this._bh+b+m(this._bl,$)|0,this._ch=this._ch+_+m(this._cl,re)|0,this._dh=this._dh+M+m(this._dl,pe)|0,this._eh=this._eh+S+m(this._el,ee)|0,this._fh=this._fh+C+m(this._fl,Ge)|0,this._gh=this._gh+W+m(this._gl,Be)|0,this._hh=this._hh+V+m(this._hl,Fe)|0},i.prototype._hash=function(){var y=t.allocUnsafe(64);function f(g,b,_){y.writeInt32BE(g,_),y.writeInt32BE(b,_+4)}return f(this._ah,this._al,0),f(this._bh,this._bl,8),f(this._ch,this._cl,16),f(this._dh,this._dl,24),f(this._eh,this._el,32),f(this._fh,this._fl,40),f(this._gh,this._gl,48),f(this._hh,this._hl,56),y},Cs=i,Cs}var As,Ma;function Bp(){if(Ma)return As;Ma=1;var n=Ft(),e=Oa(),t=tn(),r=Xt().Buffer,s=new Array(160);function i(){this.init(),this._w=s,t.call(this,128,112)}return n(i,e),i.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},i.prototype._hash=function(){var a=r.allocUnsafe(48);function o(l,c,u){a.writeInt32BE(l,u),a.writeInt32BE(c,u+4)}return o(this._ah,this._al,0),o(this._bh,this._bl,8),o(this._ch,this._cl,16),o(this._dh,this._dl,24),o(this._eh,this._el,32),o(this._fh,this._fl,40),a},As=i,As}var Ea;function qp(){if(Ea)return ws.exports;Ea=1;var n=ws.exports=function(e){e=e.toLowerCase();var t=n[e];if(!t)throw new Error(e+" is not supported (we accept pull requests)");return new t};return n.sha=Ip(),n.sha1=$p(),n.sha224=Lp(),n.sha256=_a(),n.sha384=Bp(),n.sha512=Oa(),ws.exports}var Dp=qp();const Fp=tg(Dp);function Up(n,e={}){const{segmentLength:t=4,separator:r="__",termLength:s=2}=e;return n.split(r).reduce((i,a)=>{const o=a.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),l=o.length>1?s:t,c=o.map(u=>u.substr(0,l)).join("");return i.push(c),i},[]).join(r)}function Wp(n,e={}){const t=Fp("sha1");t.update(n,"utf8");const r=t.digest("hex");return e.length?r.slice(0,e.length):r}class Vp{static isGreaterOrEqual(e,t){const r=Ca(e),s=Ca(t);return r[0]>s[0]||r[0]===s[0]&&r[1]>s[1]||r[0]===s[0]&&r[1]===s[1]&&r[2]>=s[2]}}function Ca(n=""){const e=[0,0,0];return n.split(".").forEach((t,r)=>e[r]=parseInt(t,10)),e}class k{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return e.version!=null&&Vp.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const r=this.parseConnectionUrl(e.url);t&&t.useSid&&r.database&&(r.sid=r.database);for(const s of Object.keys(r))typeof r[s]>"u"&&delete r[s];return Object.assign({},e,r)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const r=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&r.database&&(r.sid=r.database);for(const s of Object.keys(r))typeof r[s]>"u"&&delete r[s];return Object.assign({},e,r)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...r){const s=t&&t.joiner?t.joiner:"_";let i=r.length===1?r[0]:r.join(s);if(e&&e>0&&i.length>e){if(t&&t.shorten===!0){const a=Up(i);if(a.length<e)return a}return Wp(i,{length:e})}return i}static buildColumnAlias({maxAliasLength:e},t,...r){return typeof t=="string"?(r.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...r)}static parseConnectionUrl(e){const t=e.split(":")[0],r=e.indexOf("//"),s=e.substr(r+2),i=s.indexOf("/"),a=i!==-1?s.substr(0,i):s;let o=i!==-1?s.substr(i+1):void 0;o&&o.indexOf("?")!==-1&&(o=o.substr(0,o.indexOf("?")));const l=a.lastIndexOf("@"),c=a.substr(0,l),u=a.substr(l+1);let p=c,h="";const d=c.indexOf(":");d!==-1&&(p=c.substr(0,d),h=c.substr(d+1));const[m,y]=u.split(":");return{type:t,host:m,username:decodeURIComponent(p),password:decodeURIComponent(h),port:y?parseInt(y):void 0,database:o||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],r=e.indexOf("//"),s=e.substr(r+2),i=s.indexOf("/"),a=i!==-1?s.substr(0,i):s;let o=i!==-1?s.substr(i+1):void 0,l="",c,u,p,h,d={};if(o&&o.indexOf("?")!==-1){l=o.substr(o.indexOf("?")+1,o.length);const S=l.split("&");let C,W;S.forEach(V=>{C=V.split("=")[0],W=V.split("=")[1],d[C]=W}),h=d.replicaSet,o=o.substr(0,o.indexOf("?"))}const m=a.lastIndexOf("@"),y=a.substr(0,m),f=a.substr(m+1);let g=y,b="";const _=y.indexOf(":");_!==-1&&(g=y.substr(0,_),b=y.substr(_+1)),h?p=f:[c,u]=f.split(":");let M={type:t,host:c,hostReplicaSet:p,username:decodeURIComponent(g),password:decodeURIComponent(b),port:u?parseInt(u):void 0,database:o||void 0};for(const[S,C]of Object.entries(d))M[S]=C;return M}}class Aa{constructor(e,t,r){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,r&&fe.assign(this,r)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(r=>t.selection===this.alias.name+"."+r.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(mt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(mt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!mt.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let r=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(r||t.metadata.parentEntityMetadata&&(r=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),r))return r;throw new T(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new T("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new T("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?k.buildAlias(this.connection.driver,void 0,e,this.alias.name):k.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class Ss{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,fe.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value must be a string representation of alias property");const e=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new T(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return e}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Ps{constructor(e,t){this.expressionMap=e,fe.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),r=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!r)throw new T(`Relation with property path ${t} in entity was not found.`);return r}get metadata(){if(!mt.isAliasProperty(this.relationName))throw new T("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class ks{constructor(e){var t;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((t=e.options)==null?void 0:t.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,r)=>(t[this.mainAlias.name+"."+r]=e[r],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const r=new ma;return r.type=e.type,t&&(r.name=t),e.metadata&&(r.metadata=e.metadata),e.target&&!r.hasMetadata&&(r.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(r.tablePath=e.tablePath),e.subQuery&&(r.subQuery=e.subQuery),this.aliases.push(r),r}findAliasByName(e){const t=this.aliases.find(r=>r.name===e);if(!t)throw new T(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,r]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(r)}get relationMetadata(){if(!this.mainAlias)throw new T("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new T(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new ks(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new ma(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Aa(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Ss(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Ps(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class Sa{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class Ts{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((r,s)=>s.from(r),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((r,s)=>s.to(r),t):e.to(t)}}class On{constructor(e,t,r=!0,s=!1,i,a){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=r,this._multipleParameters=s,this._getSql=i,this._objectLiteralParameters=a}get useParameter(){return ie.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return ie.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return ie.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return ie.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(ie.isFindOperator(this._value))return this._value}get getSql(){return ie.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof On?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&Ts.transformTo(e,t)):Ts.transformTo(e,this._value)}}ta=function(n){return new On("in",n,!0,!0)};const zp=/[.*+\-?^${}()|[\]\\]/g,Qp=n=>n.replace(zp,"\\$&");class he{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,ie.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new ks(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){he.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new T("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(r=>({selection:r})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),ie.isSelectQueryBuilder(this)?this:he.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",ie.isInsertQueryBuilder(this)?this:he.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const r=t||e;if(e=ie.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const s=this.createFromAlias(e);this.expressionMap.setMainAlias(s)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=r,ie.isUpdateQueryBuilder(this)?this:he.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",ie.isDeleteQueryBuilder(this)?this:he.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",ie.isSoftDeleteQueryBuilder(this)?this:he.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",ie.isSoftDeleteQueryBuilder(this)?this:he.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const r=arguments.length===2?e:void 0,s=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=s,r){const i=this.createFromAlias(r);this.expressionMap.setMainAlias(i)}return ie.isRelationQueryBuilder(this)?this:he.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const r=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(s=>!!r.findRelationWithPropertyPath(s))}hasParameter(e){var t;return((t=this.parentQueryBuilder)==null?void 0:t.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new T(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new T("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,r]of Object.entries(e))this.setParameter(t,r);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const r=t.childEntityMetadatas.filter(s=>s.discriminatorColumn).map(s=>s.discriminatorValue);r.push(t.discriminatorValue),e.discriminatorColumnValues=r}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner();try{return await r.query(e,t)}finally{r!==this.queryRunner&&await r.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,r){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:r||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new T('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const r=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:r.tablePath})}else{if(typeof e=="string"){const i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}const r=e(this.subQuery());this.setParameters(r.getParameters());const s=r.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:s})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const i of this.expressionMap.aliases){if(!i.hasMetadata)continue;const a=this.expressionMap.aliasNamePrefixingEnabled&&i.name?`${i.name}.`:"";t[a]||(t[a]={});for(const o of i.metadata.relations)o.joinColumns.length>0&&(t[a][o.propertyPath]=o.joinColumns[0].databaseName);for(const o of i.metadata.relations){const l=[...o.joinColumns,...o.inverseJoinColumns];for(const c of l){const u=`${o.propertyPath}.${c.referencedColumn.propertyPath}`;t[a][u]=c.databaseName}}for(const o of i.metadata.columns)t[a][o.databaseName]=o.databaseName;for(const o of i.metadata.columns)t[a][o.propertyName]=o.databaseName;for(const o of i.metadata.columns)t[a][o.propertyPath]=o.databaseName}const r=Object.keys(t),s=r.map(i=>Qp(i)).join("|");return r.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${s?"("+s+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...i)=>{let a,o,l;if(s){if(a=i[0],o=i[1],l=i[3],t[i[2]][l])return`${o}${this.escape(i[2].substring(0,i[2].length-1))}.${this.escape(t[i[2]][l])}`}else if(a=i[0],o=i[1],l=i[2],t[""][l])return`${o}${this.escape(t[""][l])}`;return a})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const s=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&s.deleteDateColumn){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+s.deleteDateColumn.propertyName:s.deleteDateColumn.propertyName,a=`${this.replacePropertyNames(i)} IS NULL`;e.push(a)}if(s.discriminatorColumn&&s.parentEntityMetadata){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+s.discriminatorColumn.databaseName:s.discriminatorColumn.databaseName,a=`${this.replacePropertyNames(i)} IN (:...discriminatorColumnValues)`;e.push(a)}}if(this.expressionMap.extraAppendedAndWhereCondition){const s=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(s)}let r="";return r+=this.createTimeTravelQuery(),e.length?e.length===1?r+=` WHERE ${e[0]}`:r+=` WHERE ( ${e.join(" ) AND ( ")} )`:r+="",r}createReturningExpression(e){const t=this.getReturningColumns(),r=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&r.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(s=>t.indexOf(s)===-1)),t.length){let s=t.map(i=>{const a=this.escape(i.databaseName);return r.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+a:this.escape(this.getMainTableName())+"."+a:a}).join(", ");return r.options.type==="oracle"&&(s+=" INTO "+t.map(i=>this.createParameter({type:r.columnTypeToNativeParameter(i.type),dir:r.oracle.BIND_OUT})).join(", ")),r.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(s+=" INTO @OutputTable"),s}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,r)=>{const s=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(r>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${s}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(r>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${s}${this.connection.options.isolateWhereStatements?")":""}`}return s}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:r}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return r.options.type==="postgres"||r.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return r.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${On.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(t=>{const r=typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.getQuery();if(typeof t.queryBuilder!="string"){if(t.queryBuilder.hasCommonTableExpressions())throw new T(`Nested CTEs aren't supported (CTE: ${t.alias})`);if(!this.connection.driver.cteCapabilities.writable&&!ie.isSelectQueryBuilder(t.queryBuilder))throw new T(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${t.alias})`);this.setParameters(t.queryBuilder.getParameters())}let s=this.escape(t.alias);if(t.options.columnNames){const o=t.options.columnNames.map(l=>this.escape(l));if(ie.isSelectQueryBuilder(t.queryBuilder)&&t.queryBuilder.expressionMap.selects.length&&t.options.columnNames.length!==t.queryBuilder.expressionMap.selects.length)throw new T(`cte.options.columnNames length (${t.options.columnNames.length}) doesn't match subquery select list length ${t.queryBuilder.expressionMap.selects.length} (CTE: ${t.alias})`);s+=`(${o.join(", ")})`}const i=t.options.recursive&&e?"RECURSIVE":"";let a="";return this.connection.driver.cteCapabilities.materializedHint&&t.options.materialized!==void 0&&(a=t.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[i,s,"AS",a,`(${r})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,r=(Array.isArray(e)?e:[e]).map(s=>t.ensureEntityIdMap(s));if(!t.hasMultiplePrimaryKeys){const s=t.primaryColumns[0];if(!s.transformer&&!s.relationMetadata&&!s.embeddedMetadata)return{[s.propertyName]:ta(r.map(i=>s.getEntityValue(i,!1)))}}return new Sa(s=>{for(const i of r)s.orWhere(new Sa(a=>a.where(i)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const r=[],s=e.split(".");for(;s.length>1;){const o=s[0];if(!(t!=null&&t.hasMetadata))break;if(t.metadata.hasEmbeddedWithPropertyPath(o)){s.unshift(`${s.shift()}.${s.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(o)){const l=this.expressionMap.joinAttributes.find(c=>c.relationPropertyPath===o);if(!(l!=null&&l.alias)){const c=r.length>0?`${r.join(".")}.${o}`:o;throw new Error(`Cannot find alias for relation at ${c}`)}t=l.alias,r.push(...o.split(".")),s.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const i=s.join("."),a=t.metadata.findColumnsWithPropertyPath(i);if(!a.length)throw new dt(e,t.metadata);return[t,r,a]}createPropertyPath(e,t,r=""){const s=[];for(const i of Object.keys(t)){const a=r?`${r}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||ie.isFindOperator(t[i])){s.push(a);continue}if(e.hasEmbeddedWithPropertyPath(a)){const o=this.createPropertyPath(e,t[i],a);s.push(...o);continue}if(e.hasRelationWithPropertyPath(a)){const o=e.findRelationWithPropertyPath(a);if(o.relationType==="one-to-one"||o.relationType==="many-to-one"){const u=o.joinColumns.map(p=>p.referencedColumn).filter(p=>!!p);if(u.length>0&&u.every(p=>p.getEntityValue(t[i],!1))){s.push(a);continue}}if(o.relationType==="one-to-many"||o.relationType==="many-to-many")throw new Error(`Cannot query across ${o.relationType} for property ${a}`);const l=o.inverseEntityMetadata.primaryColumns;if(l.length>0&&l.every(u=>u.getEntityValue(t[i],!1))){const u=l.map(p=>`${a}.${p.propertyPath}`);s.push(...u);continue}const c=this.createPropertyPath(o.inverseEntityMetadata,t[i]).map(u=>`${a}.${u}`);s.push(...c);continue}s.push(a)}return s}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const r of t){const[s,i,a]=this.findColumnsForPropertyPath(r);for(const o of a){let l=e;for(const p of i){if(!l||!(p in l)){l={};break}l=l[p]}const c=this.expressionMap.aliasNamePrefixingEnabled?`${s.name}.${o.propertyPath}`:o.propertyPath,u=o.getEntityValue(l,!0);yield[c,u]}}}else for(const t of Object.keys(e)){const r=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,r]}}getWherePredicateCondition(e,t){if(ie.isFindOperator(t)){let r=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const s of t.value)r.push(this.createParameter(s));else r.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...r]};if(t.type==="and"){const s=t.value;return{operator:t.type,parameters:s.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else if(t.type==="or"){const s=t.value;return{operator:t.type,parameters:s.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else return{operator:t.type,parameters:[e,...r]}}else return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(ie.isBrackets(e)){const s=this.createQueryBuilder();return s.parentQueryBuilder=this,s.expressionMap.mainAlias=this.expressionMap.mainAlias,s.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,s.expressionMap.parameters=this.expressionMap.parameters,s.expressionMap.nativeParameters=this.expressionMap.nativeParameters,s.expressionMap.wheres=[],e.whereFactory(s),{operator:ie.isNotBrackets(e)?"not":"brackets",condition:s.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],r=[];for(const s of t){const i=[];for(const[a,o]of this.getPredicates(s))i.push({type:"and",condition:this.getWherePredicateCondition(a,o)});r.push({type:"or",condition:i})}return r.length===1?r[0].condition:r}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}he.queryBuilderRegistry={};class Kp{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class Jp extends he{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner();let s=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),s=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const i=await r.query(e,t,!0),a=Kp.from(i);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),s&&await r.commitTransaction(),a}catch(i){if(s)try{await r.rollbackTransaction()}catch{}throw i}finally{r!==this.queryRunner&&await r.release()}}from(e,t){e=ie.isEntitySchema(e)?e.options.name:e;const r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}where(e,t){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new sr;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),r=this.createReturningExpression("delete");return r===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${r}${t}`:`DELETE FROM ${e}${t} RETURNING ${r}`}}let ir;const Hp=new Uint8Array(16);function Gp(){if(!ir&&(ir=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ir))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ir(Hp)}const Se=[];for(let n=0;n<256;++n)Se.push((n+256).toString(16).slice(1));function Zp(n,e=0){return Se[n[e+0]]+Se[n[e+1]]+Se[n[e+2]]+Se[n[e+3]]+"-"+Se[n[e+4]]+Se[n[e+5]]+"-"+Se[n[e+6]]+Se[n[e+7]]+"-"+Se[n[e+8]]+Se[n[e+9]]+"-"+Se[n[e+10]]+Se[n[e+11]]+Se[n[e+12]]+Se[n[e+13]]+Se[n[e+14]]+Se[n[e+15]]}const Xp=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Pa={randomUUID:Xp};function Yp(n,e,t){if(Pa.randomUUID&&!e&&!n)return Pa.randomUUID();n=n||{};const r=n.random||(n.rng||Gp)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Zp(r)}class ka{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class Ta{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Rs{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const r=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(s,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((l,c,u)=>(l[this.expressionMap.extraReturningColumns[u].databaseName]=c[0],l),{}));const a=Array.isArray(e.raw)?e.raw[i]:e.raw,o=this.queryRunner.connection.driver.createGeneratedMap(r,a);o&&(this.queryRunner.manager.merge(r.target,s,o),e.generatedMaps.push(o))}else{const a=this.expressionMap.extraReturningColumns;if(a.length>0){const o=this.expressionMap.mainAlias.metadata.getEntityIdMap(s);if(!o)throw new T("Cannot update entity because entity id is not set in the entity.");const l=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(c=>r.targetName+"."+c.propertyPath)).addSelect(a.map(c=>r.targetName+"."+c.propertyPath)).from(r.target,r.targetName).where(o).withDeleted().setOption("create-pojo").getOne();l&&(this.queryRunner.manager.merge(r.target,s,l),e.generatedMaps.push(l))}}}))}async insert(e,t){const r=this.expressionMap.mainAlias.metadata;let s=r.getInsertionReturningColumns();const i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");s=s.filter(o=>o.isGenerated?i===!0:!0);const a=t.map((o,l)=>{this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((p,h,d)=>(p[this.expressionMap.extraReturningColumns[d].databaseName]=h[0],p),{}));const c=Array.isArray(e.raw)?e.raw[l]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(r,c,l,t.length)||{};return l in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(r.target,u,this.expressionMap.locallyGenerated[l]),this.queryRunner.manager.merge(r.target,o,u),u});if(s.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const o=t.map(c=>{const u=r.getEntityIdMap(c);if(!u)throw new T("Cannot update entity because entity id is not set in the entity.");return u}),l=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(c=>r.targetName+"."+c.propertyPath)).addSelect(s.map(c=>r.targetName+"."+c.propertyPath)).from(r.target,r.targetName).where(o).setOption("create-pojo").getMany();t.forEach((c,u)=>{this.queryRunner.manager.merge(r.target,a[u],l[u]),this.queryRunner.manager.merge(r.target,c,l[u])})}t.forEach((o,l)=>{const c=r.getEntityIdMap(o);e.identifiers.push(c),e.generatedMaps.push(a[l])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class eh extends he{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new Ta;const t=this.obtainQueryRunner();let r=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),r=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const d=new ka;e.forEach(m=>{t.broadcaster.broadcastBeforeInsertEvent(d,this.expressionMap.mainAlias.metadata,m)}),await d.wait()}let s=null,i=null;const a=new Rs(t,this.expressionMap),o=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const d of this.expressionMap.returning)o.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(d));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),o.push(...this.expressionMap.extraReturningColumns.filter(d=>!o.includes(d)))),o.length>0&&this.connection.driver.options.type==="mssql"&&(s=this.connection.driver.buildTableVariableDeclaration("@OutputTable",o),i="SELECT * FROM @OutputTable");const[l,c]=this.getQueryAndParameters(),u=[s,l,i].filter(d=>d!=null).join(`;

`),p=await t.query(u,c,!0),h=Ta.from(p);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await a.insert(h,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const d=new ka;e.forEach(m=>{t.broadcaster.broadcastAfterInsertEvent(d,this.expressionMap.mainAlias.metadata,m)}),await d.wait()}return r&&await t.commitTransaction(),h}catch(s){if(r)try{await t.rollbackTransaction()}catch{}throw s}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=ie.isEntitySchema(e)?e.options.name:e;const r=this.createFromAlias(e);return this.expressionMap.setMainAlias(r),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new sr;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,r){return Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:r==null?void 0:r.skipUpdateIfNoValuesChanged,indexPredicate:r==null?void 0:r.indexPredicate,upsertType:r==null?void 0:r.upsertType},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:r==null?void 0:r.skipUpdateIfNoValuesChanged,upsertType:r==null?void 0:r.upsertType},this)}createInsertExpression(){var a,o;const e=this.getTableName(this.getMainTableName()),t=this.createValuesExpression(),r=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),s=this.createColumnNamesExpression();let i="INSERT ";if(((a=this.expressionMap.onUpdate)==null?void 0:a.upsertType)==="primary-key"&&(i="UPSERT "),(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(i+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),i+=`INTO ${e}`,this.alias!==this.getMainTableName()&&k.isPostgresFamily(this.connection.driver)&&(i+=` AS "${this.alias}"`),s?i+=`(${s})`:!t&&(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(i+="()"),r&&this.connection.driver.options.type==="mssql"&&(i+=` OUTPUT ${r}`),t?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?i+=` ${t}`:i+=` VALUES ${t}`:k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?i+=" VALUES ()":i+=" DEFAULT VALUES",((o=this.expressionMap.onUpdate)==null?void 0:o.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)i+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)i+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:l,columns:c,conflict:u,skipUpdateIfNoValuesChanged:p,indexPredicate:h}=this.expressionMap.onUpdate;let d="ON CONFLICT";if(Array.isArray(u)){if(d+=` ( ${u.map(y=>this.escape(y)).join(", ")} )`,h&&!k.isPostgresFamily(this.connection.driver))throw new T("indexPredicate option is not supported by the current database driver");h&&k.isPostgresFamily(this.connection.driver)&&(d+=` WHERE ( ${h} )`)}else u&&(d+=` ON CONSTRAINT ${this.escape(u)}`);const m=[];Array.isArray(l)?m.push(...l.map(y=>`${this.escape(y)} = EXCLUDED.${this.escape(y)}`)):c&&m.push(...c.map(y=>`${this.escape(y)} = :${y}`)),m.length>0&&(i+=` ${d} DO UPDATE SET `,m.push(...this.expressionMap.mainAlias.metadata.columns.filter(y=>y.isUpdateDate&&!(l!=null&&l.includes(y.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||k.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(y=>`${this.escape(y.databaseName)} = DEFAULT`)),i+=m.join(", "),i+=" "),Array.isArray(l)&&p&&k.isPostgresFamily(this.connection.driver)&&(i+=" WHERE (",i+=l.map(y=>`${e}.${this.escape(y)} IS DISTINCT FROM EXCLUDED.${this.escape(y)}`).join(" OR "),i+=") ")}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:l,columns:c}=this.expressionMap.onUpdate;Array.isArray(l)?(i+=" ON DUPLICATE KEY UPDATE ",i+=l.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),i+=" "):Array.isArray(c)&&(i+=" ON DUPLICATE KEY UPDATE ",i+=c.map(u=>`${this.escape(u)} = :${u}`).join(", "),i+=" ")}}else if(this.expressionMap.onUpdate)throw new T("onUpdate is not supported by the current database driver")}return r&&(k.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||k.isMySQLFamily(this.connection.driver))&&(i+=` RETURNING ${r}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(l=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(l.propertyPath)!==-1:l.isInsert).some(l=>this.isOverridingAutoIncrementBehavior(l))&&(i=`SET IDENTITY_INSERT ${e} ON; ${i}; SET IDENTITY_INSERT ${e} OFF`),i}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!k.isSQLiteFamily(this.connection.driver)&&!k.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(r=>this.escape(r)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let r="";return e.forEach((s,i)=>{t.forEach((a,o)=>{o===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?r+=" SELECT ":r+="(");let l=a.getEntityValue(s);if(typeof l!="function"&&(l=this.connection.driver.preparePersistentValue(l,a)),a.isVersion&&l===void 0)r+="1";else if(a.isDiscriminator)r+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(a.isGenerated&&a.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&l===void 0)l=Yp(),r+=this.createParameter(l),i in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[i]={}),a.setEntityValue(this.expressionMap.locallyGenerated[i],l);else if(l===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||k.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?a.default!==void 0&&a.default!==null?r+=this.connection.driver.normalizeDefault(a):r+="NULL":r+="DEFAULT";else if(l===null&&this.connection.driver.options.type==="spanner")r+="NULL";else if(typeof l=="function")r+=l();else{this.connection.driver.options.type==="mssql"&&(l=this.connection.driver.parametrizeValue(a,l));const c=this.createParameter(l);if((k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(a.type)!==-1){const u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";a.srid!=null?r+=`${u}(${c}, ${a.srid})`:r+=`${u}(${c})`}else k.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(a.type)!==-1?a.srid!=null?r+=`ST_SetSRID(ST_GeomFromGeoJSON(${c}), ${a.srid})::${a.type}`:r+=`ST_GeomFromGeoJSON(${c})::${a.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(a.type)!==-1?r+=a.type+"::STGeomFromText("+c+", "+(a.srid||"0")+")":r+=c}o===t.length-1?i===e.length-1?this.connection.driver.options.type==="oracle"&&e.length>1?r+=" FROM DUAL ":this.connection.driver.options.type==="sap"&&e.length>1?r+=" FROM dummy ":r+=")":this.connection.driver.options.type==="oracle"&&e.length>1?r+=" FROM DUAL UNION ALL ":this.connection.driver.options.type==="sap"&&e.length>1?r+=" FROM dummy UNION ALL ":r+="), ":r+=", "})}),r==="()"?"":r}else{let r="";return e.forEach((s,i)=>{Object.keys(s).forEach((a,o)=>{o===0&&(r+="(");const l=s[a];typeof l=="function"?r+=l():l===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||k.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r+="NULL":r+="DEFAULT":l===null&&this.connection.driver.options.type==="spanner"||(r+=this.createParameter(l)),o===Object.keys(s).length-1?i===e.length-1?r+=")":r+="), ":r+=", "})}),r==="()"?"":r}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(fe.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new Tp}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}}class Ra{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const r=t.joinColumns.reduce((s,i)=>{const a=fe.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(s,a),s},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(r).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const r={};t.inverseRelation.joinColumns.forEach(l=>{r[l.propertyName]=null});const s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},a=[];s.forEach((l,c)=>{t.inverseRelation.joinColumns.map((u,p)=>{const h="joinColumn_"+c+"_"+p;i[h]=fe.isObject(l)?u.referencedColumn.getEntityValue(l):l,a.push(`${u.propertyPath} = :${h}`)})});const o=a.map(l=>"("+l+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).where(o).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new T("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const r=this.expressionMap.of,s=t.inverseRelation.joinColumns.reduce((i,a)=>{const o=fe.isObject(r)?a.referencedColumn.getEntityValue(r):r;return a.setEntityValue(i,o),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(s).whereInIds(e).execute()}else{const r=t.junctionEntityMetadata,s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],a=t.isManyToManyOwner?s:i,o=t.isManyToManyOwner?i:s,l=[];if(a.forEach(c=>{o.forEach(u=>{const p={};r.ownerColumns.forEach(h=>{p[h.databaseName]=fe.isObject(c)?h.referencedColumn.getEntityValue(c):c}),r.inverseColumns.forEach(h=>{p[h.databaseName]=fe.isObject(u)?h.referencedColumn.getEntityValue(u):u}),l.push(p)})}),!l.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(l.map(c=>this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(c).execute())):await this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(l).execute()}}}class th{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],s=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(c=>{i[c.propertyName]=null});const a={},o=[];r.forEach((c,u)=>{o.push(...s.map((p,h)=>[...t.inverseRelation.joinColumns.map((d,m)=>{const y="joinColumn_"+u+"_"+h+"_"+m;return a[y]=fe.isObject(c)?d.referencedColumn.getEntityValue(c):c,`${d.propertyPath} = :${y}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((d,m)=>{const y="primaryColumn_"+h+"_"+h+"_"+m;return a[y]=fe.isObject(p)?d.getEntityValue(p):p,`${d.propertyPath} = :${y}`})].join(" AND ")))});const l=o.map(c=>"("+c+")").join(" OR ");if(!l)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(l).setParameters(a).execute()}else{const r=t.junctionEntityMetadata,s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],a=t.isManyToManyOwner?s:i,o=t.isManyToManyOwner?i:s,l={},c=[];a.forEach((p,h)=>{c.push(...o.map((d,m)=>[...r.ownerColumns.map((y,f)=>{const g="firstValue_"+h+"_"+m+"_"+f;return l[g]=fe.isObject(p)?y.referencedColumn.getEntityValue(p):p,`${y.databaseName} = :${g}`}),...r.inverseColumns.map((y,f)=>{const g="secondValue_"+h+"_"+m+"_"+f;return l[g]=fe.isObject(d)?y.referencedColumn.getEntityValue(d):d,`${y.databaseName} = :${g}`})].join(" AND ")))});const u=c.map(p=>"("+p+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(r.tableName).where(u).setParameters(l).execute()}}}class nh extends he{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new T("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new T(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!fe.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new T('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Ra(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new T("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new T(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!fe.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new T('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Ra(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new T("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new T(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new th(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!fe.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new T("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class Pe{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(r,s)=>e.slice(s*t,s*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((r,s)=>{const i=t(s);let a=r.find(o=>o.id===i);return a||(a={id:i,items:[]},r.push(a)),a.items.push(s),r},[])}static uniq(e,t){return e.reduce((r,s)=>{let i=!1;if(typeof t=="function"){const a=t(s);i=!!r.find(o=>t(o)===a)}else typeof t=="string"?i=!!r.find(a=>a[t]===s[t]):i=r.indexOf(s)!==-1;return i||r.push(s),r},[])}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,r,s){if(s.has(r)){e[t]=s.get(r);return}if(!(r instanceof Promise)){if(!this.isPlainObject(r)&&!Array.isArray(r)){e[t]=r;return}e[t]||(e[t]=Array.isArray(r)?[]:{}),s.set(r,e[t]),this.merge(e[t],r,s),s.delete(r)}}static mergeObjectKey(e,t,r,s){if(s.has(r)){Object.assign(e,{[t]:s.get(r)});return}if(!(r instanceof Promise)){if(!this.isPlainObject(r)&&!Array.isArray(r)){Object.assign(e,{[t]:r});return}e[t]||Object.assign(e,{[t]:Array.isArray(r)?[]:{}}),s.set(r,e[t]),this.merge(e[t],r,s),s.delete(r)}}static merge(e,t,r=new Map){if(this.isPlainObject(e)&&this.isPlainObject(t))for(const s of Object.keys(t))s!=="__proto__"&&this.mergeObjectKey(e,s,t[s],r);if(Array.isArray(e)&&Array.isArray(t))for(let s=0;s<t.length;s++)this.mergeArrayKey(e,s,t[s],r)}static mergeDeep(e,...t){if(!t.length)return e;for(const r of t)Pe.merge(e,r);return e}static deepCompare(...e){let t,r,s,i;if(arguments.length<1)return!0;for(t=1,r=arguments.length;t<r;t++)if(s=[],i=[],!this.compare2Objects(s,i,arguments[0],arguments[t]))return!1;return!0}static deepValue(e,t){const r=t.split(".");for(let s=0,i=r.length;s<i;s++)e=e[r[s]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:this.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let r of e){const s=r.split(".");if(!s.length)continue;(!t[s[0]]||t[s[0]]===!0)&&(t[s[0]]={});let i=t[s[0]];for(let[a,o]of s.entries())a!==0&&(i[o]?i=i[o]:a===s.length-1?(i[o]={},i=null):(i[o]={},i=i[o]))}return this.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:Pe.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static zipObject(e,t){return e.reduce((r,s,i)=>(r[s]=t[i],r),{})}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(r=>t.indexOf(r)!==-1)}static areMutuallyExclusive(...e){return!e.some(t=>{const r=e.filter(s=>s!==t);return t.some(s=>r.some(i=>i.includes(s)))})}static parseSqlCheckExpression(e,t){const r=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(r&&r.index){const s=e.substring(r.index+r[0].length);let i="",a="";const o=[];for(let l=0;l<s.length;l++){const c=s[l];switch(c){case",":i==""?(o.push(a),a=""):a+=c;break;case"'":i==c?s[l+1]===c?(a+=c,l+=1):i="":i=c;break;case")":if(i=="")return o.push(a),o;a+=c;break;default:i!=""&&(a+=c)}}}}static compare2Objects(e,t,r,s){let i;if(Number.isNaN(r)&&Number.isNaN(s)||r===s)return!0;if(r===null||s===null||r===void 0||s===void 0)return!1;if((typeof r.equals=="function"||typeof r.equals=="function")&&r.equals(s))return!0;if(typeof r=="function"&&typeof s=="function"||r instanceof Date&&s instanceof Date||r instanceof RegExp&&s instanceof RegExp||typeof r=="string"&&typeof s=="string"||typeof r=="number"&&typeof s=="number")return r.toString()===s.toString();if(!(typeof r=="object"&&typeof s=="object")||Object.prototype.isPrototypeOf.call(r,s)||Object.prototype.isPrototypeOf.call(s,r)||r.constructor!==s.constructor||r.prototype!==s.prototype||e.indexOf(r)>-1||t.indexOf(s)>-1)return!1;for(i in s)if(s.hasOwnProperty(i)!==r.hasOwnProperty(i)||typeof s[i]!=typeof r[i])return!1;for(i in r){if(s.hasOwnProperty(i)!==r.hasOwnProperty(i)||typeof s[i]!=typeof r[i])return!1;switch(typeof r[i]){case"object":case"function":if(e.push(r),t.push(s),!this.compare2Objects(e,t,r[i],s[i]))return!1;e.pop(),t.pop();break;default:if(r[i]!==s[i])return!1;break}}return!0}}class rh{constructor(e,t,r,s,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=r,this.rawRelationCountResults=s,this.queryRunner=i}transform(e,t){const r=this.group(e,t),s=[];return r.forEach(i=>{const a=this.transformRawResultsGroup(i,t);a!==void 0&&!Object.values(a).every(o=>o===null)&&s.push(a)}),s}group(e,t){const r=new Map,s=[];return t.metadata.tableType==="view"?s.push(...t.metadata.columns.map(i=>k.buildAlias(this.driver,void 0,t.name,i.databaseName))):s.push(...t.metadata.primaryColumns.map(i=>k.buildAlias(this.driver,void 0,t.name,i.databaseName))),e.forEach(i=>{const a=s.map(l=>{const c=i[l];return ze.isBuffer(c)?c.toString("hex"):fe.isObject(c)?JSON.stringify(c):c}).join("_"),o=r.get(a);o?o.push(i):r.set(a,[i])}),r}transformRawResultsGroup(e,t){let r=t.metadata;if(r.discriminatorColumn){const c=e.map(p=>p[k.buildAlias(this.driver,void 0,t.name,t.metadata.discriminatorColumn.databaseName)]),u=r.childEntityMetadatas.find(p=>typeof c.find(h=>h===p.discriminatorValue)<"u");u&&(r=u)}let s=r.create(this.queryRunner,{fromDeserializer:!0,pojo:this.expressionMap.options.indexOf("create-pojo")!==-1});const i=this.transformColumns(e,t,s,r),a=this.transformJoins(e,s,t,r),o=this.transformRelationIds(e,t,s,r),l=this.transformRelationCounts(e,t,s);if(i||r.primaryColumns.filter(c=>c.isVirtual===!1).length===0&&(a||o||l))return s}transformColumns(e,t,r,s){let i=!1;return s.columns.forEach(a=>{if(s.childEntityMetadatas.length>0&&s.childEntityMetadatas.findIndex(l=>l.target===a.target)!==-1)return;const o=e[0][k.buildAlias(this.driver,void 0,t.name,a.databaseName)];o===void 0||a.isVirtual||this.expressionMap.selects.find(l=>l.selection===t.name||l.selection===t.name+"."+a.propertyPath)&&(a.setEntityValue(r,this.driver.prepareHydratedValue(o,a)),o!==null&&(i=!0))}),i}transformJoins(e,t,r,s){let i=!1;return this.expressionMap.joinAttributes.forEach(a=>{if(!a.metadata||!a.isSelected||a.relation&&!s.relations.find(l=>l===a.relation))return;if(a.mapToProperty){if(a.mapToPropertyParentAlias!==r.name)return}else if(!a.relation||a.parentAlias!==r.name||a.relationPropertyPath!==a.relation.propertyPath)return;let o=this.transform(e,a.alias);o=a.isMany?o:o[0],o=!a.isMany&&o===void 0?null:o,o!==void 0&&(a.mapToPropertyPropertyName?t[a.mapToPropertyPropertyName]=o:a.relation.setEntityValue(t,o),i=!0)}),i}transformRelationIds(e,t,r,s){let i=!1;return this.rawRelationIdResults.forEach((a,o)=>{if(a.relationIdAttribute.parentAlias!==t.name)return;const l=a.relationIdAttribute.relation,c=this.createValueMapFromJoinColumns(l,a.relationIdAttribute.parentAlias,e);if(c==null)return;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(l,c),p=this.relationIdMaps[o][u]||[],h=a.relationIdAttribute.mapToPropertyPropertyPath.split("."),d=(m,y,f)=>{const g=m.shift();if(g&&m.length===0)return y[g]=f,y;if(g&&m.length>0)d(m,y[g],f);else return y};l.isOneToOne||l.isManyToOne?p[0]!==void 0&&(d(h,r,p[0]),i=!0):(d(h,r,p),i=i||p.length>0)}),i}transformRelationCounts(e,t,r){let s=!1;return this.rawRelationCountResults.filter(i=>i.relationCountAttribute.parentAlias===t.name).forEach(i=>{const a=i.relationCountAttribute.relation;let o;a.isOneToMany?o=a.inverseRelation.joinColumns[0].referencedColumn.databaseName:o=a.isOwning?a.joinColumns[0].referencedColumn.databaseName:a.inverseRelation.joinColumns[0].referencedColumn.databaseName;const l=e[0][k.buildAlias(this.driver,void 0,t.name,o)];l!=null&&(r[i.relationCountAttribute.mapToPropertyPropertyName]=0,i.results.filter(c=>c.parentId===l).forEach(c=>{r[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(c.cnt),s=!0}))}),s}createValueMapFromJoinColumns(e,t,r){let s;return e.isManyToOne||e.isOneToOneOwner?s=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?s=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?s=e.joinColumns.map(i=>i):s=e.inverseRelation.inverseJoinColumns.map(i=>i),s.reduce((i,a)=>(r.forEach(o=>{e.isManyToOne||e.isOneToOneOwner?i[a.databaseName]=this.driver.prepareHydratedValue(o[k.buildAlias(this.driver,void 0,t,a.databaseName)],a):i[a.databaseName]=this.driver.prepareHydratedValue(o[k.buildAlias(this.driver,void 0,t,a.referencedColumn.databaseName)],a.referencedColumn)}),i),{})}extractEntityPrimaryIds(e,t){let r;return e.isManyToOne||e.isOneToOneOwner?r=e.entityMetadata.primaryColumns.map(s=>s):e.isOneToMany||e.isOneToOneNotOwner?r=e.inverseRelation.joinColumns.map(s=>s):e.isOwning?r=e.joinColumns.map(s=>s):r=e.inverseRelation.inverseJoinColumns.map(s=>s),r.reduce((s,i)=>(s[i.databaseName]=t[i.databaseName],s),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let r;return t.isManyToOne||t.isOneToOneOwner?r=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?r=t.inverseEntityMetadata.primaryColumns:t.isOwning?r=t.inverseJoinColumns:r=t.inverseRelation.joinColumns,e.results.reduce((s,i)=>{let a=r.reduce((o,l)=>{let c=i[l.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(l.isVirtual&&l.referencedColumn&&l.referencedColumn.propertyName!==l.propertyName&&(c=l.referencedColumn.createValueMap(c)),Pe.mergeDeep(o,l.createValueMap(c))):(!l.isPrimary&&l.referencedColumn.referencedColumn&&(c=l.referencedColumn.referencedColumn.createValueMap(c)),Pe.mergeDeep(o,l.referencedColumn.createValueMap(c)))},{});if(r.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?a=r[0].getEntityValue(a):a=r[0].referencedColumn.getEntityValue(a)),a!==void 0){const o=this.hashEntityIds(t,i);s[o]?s[o].push(a):s[o]=[a]}return s},{})}))}hashEntityIds(e,t){const r=this.extractEntityPrimaryIds(e,t);return JSON.stringify(r)}}let sh=class{constructor(n,e,t){this.connection=n,this.queryRunner=e,this.relationIdAttributes=t}async load(n){const e=this.relationIdAttributes.map(async t=>{if(t.relation.isManyToOne||t.relation.isOneToOneOwner){if(t.queryBuilderFactory)throw new T("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const r={},s=n.map(i=>{const a={},o=[];t.relation.joinColumns.forEach(c=>{a[c.databaseName]=this.connection.driver.prepareHydratedValue(i[k.buildAlias(this.connection.driver,void 0,t.parentAlias,c.databaseName)],c.referencedColumn);const u=`${c.databaseName}:${a[c.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),t.relation.entityMetadata.primaryColumns.forEach(c=>{a[c.databaseName]=this.connection.driver.prepareHydratedValue(i[k.buildAlias(this.connection.driver,void 0,t.parentAlias,c.databaseName)],c);const u=`${c.databaseName}:${a[c.databaseName]}`;o.indexOf(u)===-1&&o.push(u)}),o.sort();const l=o.join("::");return r[l]?null:(r[l]=!0,a)}).filter(i=>i);return{relationIdAttribute:t,results:s}}else if(t.relation.isOneToMany||t.relation.isOneToOneNotOwner){const r=t.relation,s=r.isOwning?r.joinColumns:r.inverseRelation.joinColumns,i=r.inverseEntityMetadata.target,a=r.inverseEntityMetadata.tableName,o=t.alias||a,l={},c={},u=n.map((d,m)=>{const y=[],f={},g=s.map(_=>{const M=_.databaseName+m,S=d[k.buildAlias(this.connection.driver,void 0,t.parentAlias,_.referencedColumn.databaseName)],C=`${o}:${_.propertyPath}:${S}`;return y.indexOf(C)!==-1?"":(y.push(C),f[M]=S,o+"."+_.propertyPath+" = :"+M)}).filter(_=>_).join(" AND ");y.sort();const b=y.join("::");return l[b]?"":(l[b]=!0,Object.assign(c,f),g)}).filter(d=>d).map(d=>"("+d+")").join(" OR ");if(!u)return{relationIdAttribute:t,results:[]};const p=this.connection.createQueryBuilder(this.queryRunner);Pe.uniq([...s,...r.inverseRelation.entityMetadata.primaryColumns],d=>d.propertyPath).forEach(d=>{p.addSelect(o+"."+d.propertyPath,d.databaseName)}),p.from(i,o).where("("+u+")").setParameters(c),t.queryBuilderFactory&&t.queryBuilderFactory(p);const h=await p.getRawMany();return h.forEach(d=>{s.forEach(m=>{d[m.databaseName]=this.connection.driver.prepareHydratedValue(d[m.databaseName],m.referencedColumn)}),r.inverseRelation.entityMetadata.primaryColumns.forEach(m=>{d[m.databaseName]=this.connection.driver.prepareHydratedValue(d[m.databaseName],m)})}),{relationIdAttribute:t,results:h}}else{const r=t.relation,s=r.isOwning?r.joinColumns:r.inverseRelation.inverseJoinColumns,i=r.isOwning?r.inverseJoinColumns:r.inverseRelation.joinColumns,a=t.junctionAlias,o=t.joinInverseSideMetadata.tableName,l=t.alias||o,c=r.isOwning?r.junctionEntityMetadata.tableName:r.inverseRelation.junctionEntityMetadata.tableName,u=n.map(b=>s.reduce((_,M)=>(_[M.propertyPath]=b[k.buildAlias(this.connection.driver,void 0,t.parentAlias,M.referencedColumn.databaseName)],_),{}));if(u.length===0)return{relationIdAttribute:t,results:[]};const p={},h={},d=u.map((b,_)=>{const M=[],S={},C=Object.keys(b).map(V=>{const q=V+_,$=b[V],re=`${a}:${V}:${$}`;return M.indexOf(re)!==-1?"":(M.push(re),S[q]=$,a+"."+V+" = :"+q)}).filter(V=>V).join(" AND ");M.sort();const W=M.join("::");return h[W]?"":(h[W]=!0,Object.assign(p,S),C)}).filter(b=>b),m=i.map(b=>a+"."+b.propertyPath+" = "+l+"."+b.referencedColumn.propertyPath).join(" AND "),y=d.map(b=>"("+b+" AND "+m+")").join(" OR "),f=this.connection.createQueryBuilder(this.queryRunner);i.forEach(b=>{f.addSelect(a+"."+b.propertyPath,b.databaseName).addOrderBy(a+"."+b.propertyPath)}),s.forEach(b=>{f.addSelect(a+"."+b.propertyPath,b.databaseName).addOrderBy(a+"."+b.propertyPath)}),f.from(o,l).innerJoin(c,a,y).setParameters(p),t.queryBuilderFactory&&t.queryBuilderFactory(f);const g=await f.getRawMany();return g.forEach(b=>{[...s,...i].forEach(_=>{b[_.databaseName]=this.connection.driver.prepareHydratedValue(b[_.databaseName],_.referencedColumn)})}),{relationIdAttribute:t,results:g}}});return Promise.all(e)}};class ih{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,r){const s=Array.isArray(t)?t:[t],i=Array.isArray(r)?r:r?[r]:void 0;return e.isManyToMany?this.loadForManyToMany(e,s,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,s,i):this.loadForOneToManyAndOneToOneNotOwner(e,s,i)}async loadManyToManyRelationIdsAndGroup(e,t,r,s){const i=e.isManyToMany||e.isOneToMany,a=Array.isArray(t)?t:[t];if(!r&&(r=await this.connection.relationLoader.load(e,t,this.queryRunner,s),!r.length))return a.map(p=>({entity:p,related:i?[]:void 0}));const o=await this.load(e,t,r),l=Array.isArray(r)?r:[r];let c=[],u=[];return e.isManyToManyOwner?(c=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn)):e.isManyToManyNotOwner?(c=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(c=e.joinColumns.map(p=>p.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(c=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(p=>p.referencedColumn)),a.map(p=>{const h={entity:p,related:i?[]:void 0},d=o.filter(m=>u.every(y=>y.compareEntityValue(p,m[y.entityMetadata.name+"_"+y.propertyAliasName])));return d.length&&l.forEach(m=>{d.forEach(y=>{c.every(f=>f.compareEntityValue(m,y[k.buildAlias(this.connection.driver,void 0,f.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+f.propertyPath.replace(".","_"))]))&&(i?h.related.push(m):h.related=m)})}),h})}loadForManyToMany(e,t,r){const s=e.junctionEntityMetadata,i=s.name,a=e.isOwning?s.ownerColumns:s.inverseColumns,o=e.isOwning?s.inverseColumns:s.ownerColumns,l=this.connection.createQueryBuilder(this.queryRunner);a.forEach(h=>{const d=k.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"));l.addSelect(i+"."+h.propertyPath,d)}),o.forEach(h=>{const d=k.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_"));l.addSelect(i+"."+h.propertyPath,d)});let c="";if(a.length===1){const h=t.map(d=>a[0].referencedColumn.getEntityValue(d));h.every(d=>typeof d=="number")?c=`${i}.${a[0].propertyPath} IN (${h.join(", ")})`:(l.setParameter("values1",h),c=i+"."+a[0].propertyPath+" IN (:...values1)")}else c="("+t.map((h,d)=>a.map(m=>{const y="entity1_"+d+"_"+m.propertyName;return l.setParameter(y,m.referencedColumn.getEntityValue(h)),i+"."+m.propertyPath+" = :"+y}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";let u="";if(r)if(o.length===1){const h=r.map(d=>o[0].referencedColumn.getEntityValue(d));h.every(d=>typeof d=="number")?u=`${i}.${o[0].propertyPath} IN (${h.join(", ")})`:(l.setParameter("values2",h),u=i+"."+o[0].propertyPath+" IN (:...values2)")}else u="("+r.map((h,d)=>o.map(m=>{const y="entity2_"+d+"_"+m.propertyName;return l.setParameter(y,m.referencedColumn.getEntityValue(h)),i+"."+m.propertyPath+" = :"+y}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";const p=[c,u].filter(h=>h.length>0).join(" AND ");return l.from(s.target,i).where(p).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,r){const s=e.entityMetadata.targetName,i=e.joinColumns.every(l=>!!e.entityMetadata.nonVirtualColumns.find(c=>c===l));if(r&&i){let l=[];if(t.forEach(c=>{let u={};e.entityMetadata.primaryColumns.forEach(p=>{const h=p.entityMetadata.name+"_"+p.propertyPath.replace(".","_");u[h]=p.getEntityValue(c)}),r.forEach(p=>{e.joinColumns.forEach(h=>{const d=h.getEntityValue(c),m=h.referencedColumn.getEntityValue(p);if(!(d===void 0||m===void 0)&&d===m){const y=h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_");u[y]=m}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&l.push(u)}),l.length===t.length)return Promise.resolve(l)}const a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(l=>{const c=k.buildAlias(this.connection.driver,void 0,l.entityMetadata.name+"_"+l.propertyPath.replace(".","_"));a.addSelect(s+"."+l.propertyPath,c)}),e.joinColumns.forEach(l=>{const c=k.buildAlias(this.connection.driver,void 0,l.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+l.referencedColumn.propertyPath.replace(".","_"));a.addSelect(s+"."+l.propertyPath,c)});let o="";if(e.entityMetadata.primaryColumns.length===1){const l=t.map(c=>e.entityMetadata.primaryColumns[0].getEntityValue(c));l.every(c=>typeof c=="number")?o=`${s}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${l.join(", ")})`:(a.setParameter("values",l),o=s+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else o=t.map((l,c)=>e.entityMetadata.primaryColumns.map((u,p)=>{const h="entity"+c+"_"+p;return a.setParameter(h,u.getEntityValue(l)),s+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(l=>"("+l+")").join(" OR ");return a.from(e.entityMetadata.target,s).where(o).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,r){if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(o=>e.joinColumns.indexOf(o)!==-1))return Promise.resolve(t.map(o=>{const l={};return e.joinColumns.forEach(function(c){const u=c.referencedColumn.getEntityValue(o),p=c.referencedColumn.entityMetadata.name+"_"+c.referencedColumn.propertyPath.replace(".","_"),h=c.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+c.propertyPath.replace(".","_");l[p]=u,l[h]=u}),l}));const s=e.entityMetadata.targetName,i=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(o=>{const l=k.buildAlias(this.connection.driver,void 0,o.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));i.addSelect(s+"."+o.propertyPath,l)}),e.joinColumns.forEach(o=>{const l=k.buildAlias(this.connection.driver,void 0,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));i.addSelect(s+"."+o.propertyPath,l)});let a="";if(e.joinColumns.length===1){const o=t.map(l=>e.joinColumns[0].referencedColumn.getEntityValue(l));o.every(l=>typeof l=="number")?a=`${s}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(i.setParameter("values",o),a=s+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else a=t.map((o,l)=>e.joinColumns.map((c,u)=>{const p="entity"+l+"_"+u;return i.setParameter(p,c.referencedColumn.getEntityValue(o)),s+"."+c.propertyPath+" = :"+p}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return i.from(e.entityMetadata.target,s).where(a).getRawMany()}}class ah{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const r=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(r)})})}metadataToAttribute(e,t){return new Ss(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class oh{constructor(e,t,r){this.connection=e,this.queryRunner=t,this.relationCountAttributes=r}async load(e){const t=(s,i,a)=>a.indexOf(s)===i,r=this.relationCountAttributes.map(async s=>{if(s.relation.isOneToMany){const i=s.relation,a=i.inverseRelation,o=a.joinColumns[0].referencedColumn.propertyName,l=i.inverseEntityMetadata.target,c=i.inverseEntityMetadata.tableName,u=s.alias||c,p=a.propertyName;let h=e.map(m=>m[s.parentAlias+"_"+o]).filter(m=>!!m);if(h=h.filter(t),h.length===0)return{relationCountAttribute:s,results:[]};const d=this.connection.createQueryBuilder(this.queryRunner);return d.select(u+"."+p,"parentId").addSelect("COUNT(*)","cnt").from(l,u).where(u+"."+p+" IN (:...ids)").addGroupBy(u+"."+p).setParameter("ids",h),s.queryBuilderFactory&&s.queryBuilderFactory(d),{relationCountAttribute:s,results:await d.getRawMany()}}else{let i,a,o,l;s.relation.isOwning?(i=s.relation.joinColumns[0].referencedColumn.databaseName,a=s.relation.inverseJoinColumns[0].referencedColumn.databaseName,o=s.relation.junctionEntityMetadata.columns[0],l=s.relation.junctionEntityMetadata.columns[1]):(i=s.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,a=s.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,o=s.relation.junctionEntityMetadata.columns[1],l=s.relation.junctionEntityMetadata.columns[0]);let c=e.map(f=>f[s.parentAlias+"_"+i]).filter(f=>!!f);if(c=c.filter(t),c.length===0)return{relationCountAttribute:s,results:[]};const u=s.junctionAlias,p=s.joinInverseSideMetadata.tableName,h=s.alias||p,d=s.relation.junctionEntityMetadata.tableName,m=u+"."+o.propertyName+" IN ("+c.map(f=>isNaN(f)?"'"+f+"'":f)+") AND "+u+"."+l.propertyName+" = "+h+"."+a,y=this.connection.createQueryBuilder(this.queryRunner);return y.select(u+"."+o.propertyName,"parentId").addSelect("COUNT("+y.escape(h)+"."+y.escape(a)+")","cnt").from(p,h).innerJoin(d,u,m).addGroupBy(u+"."+o.propertyName),s.queryBuilderFactory&&s.queryBuilderFactory(y),{relationCountAttribute:s,results:await y.getRawMany()}}});return Promise.all(r)}}class lh{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const r=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(r)})})}metadataToAttribute(e,t){return new Ps(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Ns{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t!=null&&t.relations){const r=[...t.relations];if(Ns.applyRelationsRecursively(e,r,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),r.length>0)throw new Rp(r)}return e}static applyRelationsRecursively(e,t,r,s,i){let a=[];if(i){const o=new RegExp("^"+i.replace(".","\\.")+"\\.");a=t.filter(l=>l.match(o)).map(l=>s.findRelationWithPropertyPath(l.replace(o,""))).filter(l=>l)}else a=t.map(o=>s.findRelationWithPropertyPath(o)).filter(o=>o);a.forEach(o=>{let l=k.buildAlias(e.connection.driver,{joiner:"__"},r,o.propertyPath);const c=r+"."+o.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(o):e.leftJoinAndSelect(c,l),t.splice(t.indexOf(i?i+"."+o.propertyPath:o.propertyPath),1);let u,p;if(e.expressionMap.relationLoadStrategy==="query")u=o.inverseEntityMetadata,p=l;else{const h=e.expressionMap.joinAttributes.find(d=>d.entityOrProperty===c);u=h.metadata,p=h.alias.name}if(!p||!u)throw new dt(o.propertyPath,s);if(this.applyRelationsRecursively(e,t,p,u,i?i+"."+o.propertyPath:o.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const h=s.relations.find(d=>d.propertyName===o.propertyPath);h&&this.joinEagerRelations(e,l,h.inverseEntityMetadata)}})}static joinEagerRelations(e,t,r){r.eagerRelations.forEach(s=>{let i=k.buildAlias(e.connection.driver,{joiner:"__"},t,s.propertyName),a=!0;for(const c of e.expressionMap.joinAttributes)if(!(c.condition!==void 0||c.mapToProperty!==void 0||c.isMappingMany!==void 0||c.direction!=="LEFT"||c.entityOrProperty!==`${t}.${s.propertyPath}`)){a=!1,i=c.alias.name;break}const o=!!e.expressionMap.joinAttributes.find(c=>c.alias.name===i);a&&!o&&e.leftJoin(t+"."+s.propertyPath,i);let l=!0;for(const c of e.expressionMap.selects)if(!(c.aliasName!==void 0||c.virtual!==void 0||c.selection!==i)){l=!1;break}l&&e.addSelect(i),this.joinEagerRelations(e,i,s.inverseEntityMetadata)})}}class js extends he{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(r=>({selection:r}));else if(typeof e=="function"){const r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(r=>({selection:r})));else if(typeof e=="function"){const r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}addFrom(e,t){const r=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(r),this}innerJoin(e,t,r,s){return this.join("INNER",e,t,r,s),this}leftJoin(e,t,r,s){return this.join("LEFT",e,t,r,s),this}innerJoinAndSelect(e,t,r,s){return this.addSelect(t),this.innerJoin(e,t,r,s),this}leftJoinAndSelect(e,t,r,s){return this.addSelect(t),this.leftJoin(e,t,r,s),this}innerJoinAndMapMany(e,t,r,s,i){return this.addSelect(r),this.join("INNER",t,r,s,i,e,!0),this}innerJoinAndMapOne(e,t,r,s,i,a){return this.addSelect(r),this.join("INNER",t,r,s,i,e,!1,a),this}leftJoinAndMapMany(e,t,r,s,i){return this.addSelect(r),this.join("LEFT",t,r,s,i,e,!0),this}leftJoinAndMapOne(e,t,r,s,i,a){return this.addSelect(r),this.join("LEFT",t,r,s,i,e,!1,a),this}loadRelationIdAndMap(e,t,r,s){const i=new Ss(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof r=="string"&&(i.alias=r),typeof r=="object"&&r.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=s,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,r,s){const i=new Ps(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=r,i.queryBuilderFactory=s,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",r){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new T('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new T('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new T('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new T('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new T('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new T('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new T('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new T('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,r){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=r,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new xn;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const r=await this.loadRawResults(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const r=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const e=(await this.getRawAndEntities()).entities[0];if(e&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const t=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const r=t.updateDateColumn.getEntityValue(e);if(r.getTime()!==this.expressionMap.lockVersion.getTime())throw new ha(t.name,this.expressionMap.lockVersion,r)}else{const r=t.versionColumn.getEntityValue(e);if(r!==this.expressionMap.lockVersion)throw new ha(t.name,this.expressionMap.lockVersion,r)}}return e===void 0?null:e}async getOneOrFail(){const e=await this.getOne();if(!e)throw new Sp(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new xn;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new xn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const r=await this.executeCountQuery(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new xn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const r=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new xn;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const r=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;const s=this.expressionMap.cacheId;this.expressionMap.cacheId=s&&`${s}-count`;const i=await this.executeCountQuery(e),a=[r.entities,i];return t&&await e.commitTransaction(),a}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner();let s=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),s=!0);const i=()=>{if(r!==this.queryRunner)return r.release()},a=r.stream(e,t,i,i);return s&&await r.commitTransaction(),a}catch(i){if(s)try{await r.rollbackTransaction()}catch{}throw i}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,r,s,i,a,o,l){i&&this.setParameters(i);const c=new Aa(this.connection,this.expressionMap);c.direction=e,c.mapAsEntity=l,c.mapToProperty=a,c.isMappingMany=o,c.entityOrProperty=t,c.condition=s,this.expressionMap.joinAttributes.push(c);const u=c.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const p=`${r}.${u.deleteDateColumn.propertyName} IS NULL`;c.condition=c.condition?` ${c.condition} AND ${p}`:`${p}`}c.alias=this.expressionMap.createAlias({type:"join",name:r,metadata:u}),c.relation&&c.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:c.junctionAlias,metadata:c.relation.junctionEntityMetadata})}else{let p="";if(typeof t=="function"){const d=t(this.subQuery());this.setParameters(d.getParameters()),p=d.getQuery()}else p=t;const h=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";c.alias=this.expressionMap.createAlias({type:"join",name:r,tablePath:h===!1?t:void 0,subQuery:h===!0?p:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new T("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const o=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,o)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,o))}this.expressionMap.joinAttributes.forEach(o=>{if(o.metadata)e.push(...this.buildEscapedEntityColumnSelects(o.alias.name,o.metadata)),t.push(...this.findEntityColumnSelects(o.alias.name,o.metadata));else if(this.expressionMap.selects.some(l=>l.selection===o.alias.name)){e.push({selection:this.escape(o.alias.name)+".*"});const l=this.expressionMap.selects.find(c=>c.selection===o.alias.name);t.push(l)}}),this.expressionMap.selects.filter(o=>t.indexOf(o)===-1).forEach(o=>e.push({selection:this.replacePropertyNames(o.selection),aliasName:o.aliasName})),e.length===0&&e.push({selection:"*"});let r="";this.expressionMap.useIndex&&k.isMySQLFamily(this.connection.driver)&&(r=` USE INDEX (${this.expressionMap.useIndex})`);const s=this.expressionMap.aliases.filter(o=>o.type==="from"&&(o.tablePath||o.subQuery)).map(o=>o.subQuery?o.subQuery+" "+this.escape(o.name):this.getTableName(o.tablePath)+" "+this.escape(o.name)),i=this.createSelectDistinctExpression(),a=e.map(o=>o.selection+(o.aliasName?" AS "+this.escape(o.aliasName):"")).join(", ");return i+a+" FROM "+s.join(", ")+this.createTableLockExpression()+r}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:r}=this.expressionMap,{driver:s}=this.connection;let i="SELECT ";return r>0&&k.isMySQLFamily(s)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),k.isPostgresFamily(s)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(a=>this.replacePropertyNames(a)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(e=>{const t=e.relation,r=e.tablePath,s=e.alias.name;let i=e.condition?" AND ("+e.condition+")":"";const a=e.parentAlias;if(!a||!t){const o=e.alias.subQuery?e.alias.subQuery:this.getTableName(r);return" "+e.direction+" JOIN "+o+" "+this.escape(s)+this.createTableLockExpression()+(e.condition?" ON "+this.replacePropertyNames(e.condition):"")}if(t.isManyToOne||t.isOneToOneOwner){const o=t.joinColumns.map(l=>s+"."+l.referencedColumn.propertyPath+"="+a+"."+t.propertyPath+"."+l.referencedColumn.propertyPath).join(" AND ");return" "+e.direction+" JOIN "+this.getTableName(r)+" "+this.escape(s)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+i)}else if(t.isOneToMany||t.isOneToOneNotOwner){const o=t.inverseRelation.joinColumns.map(l=>(t.inverseEntityMetadata.tableType==="entity-child"&&t.inverseEntityMetadata.discriminatorColumn&&(i+=" AND "+s+"."+t.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+t.inverseEntityMetadata.discriminatorValue+"'"),s+"."+t.inverseRelation.propertyPath+"."+l.referencedColumn.propertyPath+"="+a+"."+l.referencedColumn.propertyPath)).join(" AND ");if(!o)throw new T(`Relation ${t.entityMetadata.name}.${t.propertyName} does not have join columns.`);return" "+e.direction+" JOIN "+this.getTableName(r)+" "+this.escape(s)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(o+i)}else{const o=t.junctionEntityMetadata.tablePath,l=e.junctionAlias;let c="",u="";return t.isOwning?(c=t.joinColumns.map(p=>l+"."+p.propertyPath+"="+a+"."+p.referencedColumn.propertyPath).join(" AND "),u=t.inverseJoinColumns.map(p=>s+"."+p.referencedColumn.propertyPath+"="+l+"."+p.propertyPath).join(" AND ")):(c=t.inverseRelation.inverseJoinColumns.map(p=>l+"."+p.propertyPath+"="+a+"."+p.referencedColumn.propertyPath).join(" AND "),u=t.inverseRelation.joinColumns.map(p=>s+"."+p.referencedColumn.propertyPath+"="+l+"."+p.propertyPath).join(" AND "))," "+e.direction+" JOIN "+this.getTableName(o)+" "+this.escape(l)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c)+" "+e.direction+" JOIN "+this.getTableName(r)+" "+this.escape(s)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u+i)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const r=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,s=this.expressionMap.selects.find(i=>i.selection===t);if(s&&!s.aliasName&&t.indexOf(".")!==-1){const i=t.split("."),a=i[0],o=i.slice(1).join("."),l=this.expressionMap.aliases.find(c=>c.name===a);if(l){const c=l.metadata.findColumnWithPropertyPath(o);if(c){const u=k.buildAlias(this.connection.driver,void 0,a,c.databaseName);return this.escape(u)+" "+r}}}return this.replacePropertyNames(t)+" "+r}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;if(!e&&!t&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take),this.connection.driver.options.type==="mssql"){let r="";if((t||e)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(r=" ORDER BY (SELECT NULL)"),t&&e)return r+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return r+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(e)return r+" OFFSET "+e+" ROWS"}else if(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)throw new jp}else if(k.isSQLiteFamily(this.connection.driver)){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(t&&e)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return" FETCH NEXT "+t+" ROWS ONLY";if(e)return" OFFSET "+e+" ROWS"}else{if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(k.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new T("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new T("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let r="";switch(this.expressionMap.onLocked==="nowait"?r=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(r=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return k.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+r:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(k.isPostgresFamily(e))return" FOR SHARE"+t+r;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new en;case"pessimistic_write":if(k.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+r;if(k.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+r;if(e.options.type==="mssql")return"";throw new en;case"pessimistic_partial_write":if(k.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(k.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new en;case"pessimistic_write_or_fail":if(k.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(k.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new en;case"for_no_key_update":if(k.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+r;throw new en;case"for_key_share":if(k.isPostgresFamily(e))return" FOR KEY SHARE"+t+r;throw new en;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,r)=>{switch(t.type){case"and":return(r>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(r>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const r=this.expressionMap.selects.some(c=>c.selection===e),s=[];if(r&&s.push(...t.columns.filter(c=>c.isSelect===!0)),s.push(...t.columns.filter(c=>this.expressionMap.selects.some(u=>u.selection===e+"."+c.propertyPath))),s.length===0)return[];const i=this.expressionMap.queryEntity?t.primaryColumns.filter(c=>s.indexOf(c)===-1):[],a=[...s,...i],o=[],l=this.escape(e);return a.forEach(c=>{let u=l+"."+this.escape(c.databaseName);c.isVirtualProperty&&c.query&&(u=`(${c.query(l)})`),this.connection.driver.spatialTypes.indexOf(c.type)!==-1&&((k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),k.isPostgresFamily(this.connection.driver)&&(c.precision?u=`ST_AsGeoJSON(${u}, ${c.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const p=this.expressionMap.selects.filter(h=>h.selection===e+"."+c.propertyPath);if(p.length)p.forEach(h=>{o.push({selection:u,aliasName:h.aliasName?h.aliasName:k.buildAlias(this.connection.driver,void 0,e,c.databaseName),virtual:h.virtual})});else{if(c.isVirtualProperty)return;o.push({selection:u,aliasName:k.buildAlias(this.connection.driver,void 0,e,c.databaseName),virtual:r})}}),o}findEntityColumnSelects(e,t){const r=this.expressionMap.selects.find(s=>s.selection===e);return r?[r]:this.expressionMap.selects.filter(s=>t.columns.some(i=>s.selection===e+"."+i.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,t=this.expressionMap.mainAlias.metadata.primaryColumns,r=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||k.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+t.map(s=>`${r}.${this.escape(s.databaseName)}`).join(", ")+"))";if(k.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+t.map(s=>`${r}.${this.escape(s.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const s=t.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", '|;|', ");return t.length===1?`COUNT(DISTINCT(${s}))`:`COUNT(DISTINCT(CONCAT(${s})))`}return this.connection.driver.options.type==="spanner"?t.length===1?`COUNT(DISTINCT(${r}.${this.escape(t[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${t.map(s=>`CAST(${r}.${this.escape(s.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+t.map(s=>`${r}.${this.escape(s.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),r=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!r||!r[0]||!r[0].cnt?0:parseInt(r[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?Pe.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?Pe.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const r=this.expressionMap.aliases.find(s=>s.metadata.tableNameWithoutPrefix===t);if(!r)throw new T(`"${t}" is not part of this query`);return this.escape(r.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Ns.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new T('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new Np;if(this.expressionMap.lockMode==="optimistic"){const a=this.expressionMap.mainAlias.metadata;if(!a.versionColumn&&!a.updateDateColumn)throw new kp(a.name)}const t=new sh(this.connection,e,this.expressionMap.relationIdAttributes),r=new oh(this.connection,e,this.expressionMap.relationCountAttributes);new ah(this.expressionMap).transform(),new lh(this.expressionMap).transform();let s=[],i=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[a,o]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),l=this.expressionMap.mainAlias.metadata,c=this.expressionMap.mainAlias.name,u=l.primaryColumns.map(d=>{const m=this.escape("distinctAlias"),y=this.escape(k.buildAlias(this.connection.driver,void 0,c,d.databaseName));o[y]||(o[y]="ASC");const f=k.buildAlias(this.connection.driver,void 0,"ids_"+c,d.databaseName);return`${m}.${y} AS ${this.escape(f)}`}),p=this.clone(),h=p.expressionMap.timeTravel;if(s=await new js(this.connection,e).select(`DISTINCT ${u.join(", ")}`).addSelect(a).from(`(${p.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(h).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(o).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),s.length>0){let d="";const m={};if(l.hasMultiplePrimaryKeys)d=s.map((y,f)=>l.primaryColumns.map(g=>{const b=`orm_distinct_ids_${f}_${g.databaseName}`,_=k.buildAlias(this.connection.driver,void 0,"ids_"+c,g.databaseName);return m[b]=y[_],`${c}.${g.propertyPath}=:${b}`}).join(" AND ")).join(" OR ");else{const y=k.buildAlias(this.connection.driver,void 0,"ids_"+c,l.primaryColumns[0].databaseName),f=s.map(g=>g[y]);f.every(g=>typeof g=="number")?d=`${c}.${l.primaryColumns[0].propertyPath} IN (${f.join(", ")})`:(m.orm_distinct_ids=f,d=c+"."+l.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}s=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:d}).setParameters(m).loadRawResults(e)}}else s=await this.loadRawResults(e);if(s.length>0){const a=await t.load(s),o=await r.load(s);i=new rh(this.expressionMap,this.connection.driver,a,o,this.queryRunner).transform(s,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,i)}if(this.expressionMap.relationLoadStrategy==="query"){const a=new ih(this.connection,e);await Promise.all(this.relationMetadatas.map(async o=>{const l=o.inverseEntityMetadata.target,c=o.inverseEntityMetadata.targetName,u=Array.isArray(this.findOptions.select)?Pe.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,p=Array.isArray(this.findOptions.relations)?Pe.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,h=this.createQueryBuilder(e).select(c).from(l,c).setFindOptions({select:u?Pe.deepValue(u,o.propertyPath):void 0,order:this.findOptions.order?Pe.deepValue(this.findOptions.order,o.propertyPath):void 0,relations:p?Pe.deepValue(p,o.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(i.length>0){const d=await a.loadManyToManyRelationIdsAndGroup(o,i,void 0,h);i.forEach(m=>{const y=d.find(f=>f.entity===m);if(y){const f=y.related===void 0?null:y.related;o.setEntityValue(m,f)}})}}))}return{raw:s,entities:i}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,r=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){const a=i.split("."),o=a[0],l=a.slice(1).join("."),c=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(l);return this.escape(e)+"."+this.escape(k.buildAlias(this.connection.driver,void 0,o,c.databaseName))}else return this.expressionMap.selects.find(a=>a.selection===i||a.aliasName===i)?this.escape(e)+"."+this.escape(i):""}).join(", "),s={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){const a=i.split("."),o=a[0],l=a.slice(1).join("."),c=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(l);s[this.escape(e)+"."+this.escape(k.buildAlias(this.connection.driver,void 0,o,c.databaseName))]=t[i]}else this.expressionMap.selects.find(a=>a.selection===i||a.aliasName===i)?s[this.escape(e)+"."+this.escape(i)]=t[i]:s[i]=t[i]}),[r,s]}async loadRawResults(e){const[t,r]=this.getQueryAndParameters(),s=t+" -- PARAMETERS: "+JSON.stringify(r,(u,p)=>typeof p=="bigint"?p.toString():p),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let a;const o=i.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let l=!1;if(this.connection.queryResultCache&&o)try{if(a=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:s,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),a&&!this.connection.queryResultCache.isExpired(a))return JSON.parse(a.result)}catch(u){if(!i.ignoreErrors)throw u;l=!0}const c=await e.query(t,r,!0);if(!l&&this.connection.queryResultCache&&o)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:s,time:new Date().getTime(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(c.records)},a,e)}catch(u){if(!i.ignoreErrors)throw u}return c.records}mergeExpressionMap(e){return fe.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,r,s){for(let i in e){if(e[i]===void 0||e[i]===!1)continue;const a=s?s+"."+i:i,o=t.findColumnWithPropertyPathStrict(a),l=t.findEmbeddedWithPropertyPath(a),c=t.findRelationWithPropertyPath(a);if(!l&&!o&&!c)throw new dt(a,t);o?this.selects.push(r+"."+a):l&&this.buildSelect(e[i],t,r,a)}}buildRelations(e,t,r,s,i){e&&Object.keys(e).forEach(a=>{const o=e[a],l=i?i+"."+a:a,c=r.findEmbeddedWithPropertyPath(l),u=r.findRelationWithPropertyPath(l);if(!c&&!u)throw new dt(l,r);if(c)this.buildRelations(o,typeof t=="object"?Pe.deepValue(t,c.propertyPath):void 0,r,s,l);else if(u){let p=s+"_"+l.replace(".","_");p=k.buildAlias(this.connection.driver,{joiner:"__"},s,p),(o===!0||typeof o=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[a]=="object"?t[a]:void 0,alias:p,parentAlias:s,relationMetadata:u}),t&&typeof t[a]=="object"&&this.buildSelect(t[a],u.inverseEntityMetadata,p))),typeof o=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(o,typeof t=="object"?Pe.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,p,void 0)}})}buildEagerRelations(e,t,r,s,i){e&&Object.keys(e).forEach(a=>{const o=e[a],l=i?i+"."+a:a,c=r.findEmbeddedWithPropertyPath(l),u=r.findRelationWithPropertyPath(l);if(!c&&!u)throw new dt(l,r);if(c)this.buildEagerRelations(o,typeof t=="object"?Pe.deepValue(t,c.propertyPath):void 0,r,s,l);else if(u){let p=s+"_"+l.replace(".","_");p=k.buildAlias(this.connection.driver,{joiner:"__"},s,p),(o===!0||typeof o=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(h=>{let d=p+"_"+h.propertyPath.replace(".","_");d=k.buildAlias(this.connection.driver,{joiner:"__"},p,d),this.joins.find(m=>m.alias===d)||this.joins.push({type:"left",select:!0,alias:d,parentAlias:p,selection:void 0,relationMetadata:h}),t&&typeof t[a]=="object"&&this.buildSelect(t[a],u.inverseEntityMetadata,p)}),typeof o=="object"&&this.buildEagerRelations(o,typeof t=="object"?Pe.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,p,void 0)}})}buildOrder(e,t,r,s){for(let i in e){if(e[i]===void 0)continue;const a=s?s+"."+i:i,o=t.findColumnWithPropertyPathStrict(a),l=t.findEmbeddedWithPropertyPath(a),c=t.findRelationWithPropertyPath(a);if(!l&&!o&&!c)throw new dt(a,t);if(o){let u=typeof e[i]=="object"?e[i].direction:e[i];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let p=typeof e[i]=="object"?e[i].nulls:void 0;p=(p==null?void 0:p.toLowerCase())==="first"?"NULLS FIRST":(p==null?void 0:p.toLowerCase())==="last"?"NULLS LAST":void 0;let h=`${r}.${a}`;this.addOrderBy(h,u,p)}else if(l)this.buildOrder(e[i],t,r,a);else if(c){let u=r+"_"+a.replace(".","_");u=k.buildAlias(this.connection.driver,{joiner:"__"},r,u),this.joins.find(p=>p.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:r,selection:void 0,relationMetadata:c}),this.buildOrder(e[i],c.inverseEntityMetadata,u)}}}buildWhere(e,t,r,s){let i="";if(Array.isArray(e))e.length&&(i=e.map(a=>this.buildWhere(a,t,r,s)).filter(a=>!!a).map(a=>"("+a+")").join(" OR "));else{let a=[];for(let o in e){if(e[o]===void 0||e[o]===null)continue;const l=s?s+"."+o:o,c=t.findColumnWithPropertyPathStrict(l),u=t.findEmbeddedWithPropertyPath(l),p=t.findRelationWithPropertyPath(l);if(!u&&!c&&!p)throw new dt(l,t);if(c){let h=`${r}.${l}`;c.isVirtualProperty&&c.query&&(h=`(${c.query(r)})`);let d=e[o];ie.isEqualOperator(e[o])&&(d=e[o].value),c.transformer&&(d instanceof On?d.transformValue(c.transformer):d=Ts.transformTo(c.transformer,d)),a.push(this.createWhereConditionExpression(this.getWherePredicateCondition(h,d)))}else if(u){const h=this.buildWhere(e[o],t,r,l);h&&a.push(h)}else if(p){if(typeof e[o]=="object"&&Object.keys(e[o]).every(h=>e[o][h]===void 0))continue;if(ie.isFindOperator(e[o]))if(e[o].type==="moreThan"||e[o].type==="lessThan"||e[o].type==="moreThanOrEqual"||e[o].type==="lessThanOrEqual"){let h="";e[o].type==="moreThan"?h=">":e[o].type==="lessThan"?h="<":e[o].type==="moreThanOrEqual"?h=">=":e[o].type==="lessThanOrEqual"&&(h="<=");const d=this.subQuery();if(p.isManyToManyOwner)d.select("COUNT(*)").from(p.joinTableName,p.joinTableName).where(p.joinColumns.map(m=>`${p.joinTableName}.${m.propertyName} = ${r}.${m.referencedColumn.propertyName}`).join(" AND "));else if(p.isManyToManyNotOwner)d.select("COUNT(*)").from(p.inverseRelation.joinTableName,p.inverseRelation.joinTableName).where(p.inverseRelation.inverseJoinColumns.map(m=>`${p.inverseRelation.joinTableName}.${m.propertyName} = ${r}.${m.referencedColumn.propertyName}`).join(" AND "));else if(p.isOneToMany)d.select("COUNT(*)").from(p.inverseEntityMetadata.target,p.inverseEntityMetadata.tableName).where(p.inverseRelation.joinColumns.map(m=>`${p.inverseEntityMetadata.tableName}.${m.propertyName} = ${r}.${m.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(d.getSql()+" "+h+" "+parseInt(e[o].value))}else if(p.isManyToOne||p.isOneToOne&&p.isOneToOneOwner){const h=`${r}.${l}`;a.push(this.createWhereConditionExpression(this.getWherePredicateCondition(h,e[o])))}else throw new Error("This relation isn't supported by given find operator");else{let h=r+"_"+p.propertyPath.replace(".","_");h=k.buildAlias(this.connection.driver,{joiner:"__"},r,h),this.joins.find(m=>m.alias===h)||this.joins.push({type:"left",select:!1,selection:void 0,alias:h,parentAlias:r,relationMetadata:p});const d=this.buildWhere(e[o],p.inverseEntityMetadata,h);d&&a.push(d)}}}i=a.length?"("+a.join(") AND (")+")":a.join(" AND ")}return i.length?"("+i+")":i}}class Na{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class ch extends he{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const r=new Rs(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getSoftDeletionReturningColumns());const[s,i]=this.getQueryAndParameters(),a=await e.query(s,i,!0),o=Na.from(a);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(o,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),o}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=ie.isEntitySchema(e)?e.options.name:e;const r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}where(e,t){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new sr;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new T(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(r=>{const s=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!s)throw new T("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(s)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new T(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new Pp(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new T('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new bs;const r=this.createWhereExpression(),s=this.createReturningExpression("update");return s===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${s}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${r} RETURNING ${s}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(k.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new da}return""}}class uh extends he{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let r=null,s=null;const i=new Rs(e,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=i.getUpdationReturningColumns(),a.push(...this.expressionMap.extraReturningColumns.filter(h=>!a.includes(h)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(r=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),s="SELECT * FROM @OutputTable");const[o,l]=this.getQueryAndParameters(),c=[r,o,s],u=await e.query(c.filter(h=>h!=null).join(`;

`),l,!0),p=Na.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await i.update(p,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),p}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new sr;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new T(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(r=>{const s=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!s)throw new T("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(s)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,r={};for(let l in e)e[l]!==void 0&&(r[l]=e[l]);const s=[],i=[];if(t?(this.createPropertyPath(t,r).forEach(l=>{const c=t.findColumnsWithPropertyPath(l);if(c.length<=0)throw new dt(l,t);c.forEach(u=>{if(!u.isUpdate||i.includes(u))return;i.push(u);let p=u.getEntityValue(r);if(u.referencedColumn&&typeof p=="object"&&!(p instanceof Date)&&p!==null&&!ze.isBuffer(p)?p=u.referencedColumn.getEntityValue(p):typeof p!="function"&&(p=this.connection.driver.preparePersistentValue(p,u)),typeof p=="function")s.push(this.escape(u.databaseName)+" = "+p());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&p===null)s.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(p=this.connection.driver.parametrizeValue(u,p));const h=this.createParameter(p);let d=null;if((k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const m=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?d=`${m}(${h}, ${u.srid})`:d=`${m}(${h})`}else k.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?d=`ST_SetSRID(ST_GeomFromGeoJSON(${h}), ${u.srid})::${u.type}`:d=`ST_GeomFromGeoJSON(${h})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?d=u.type+"::STGeomFromText("+h+", "+(u.srid||"0")+")":d=h;s.push(this.escape(u.databaseName)+" = "+d)}})}),(s.length>0||Object.keys(r).length===0)&&(t.versionColumn&&i.indexOf(t.versionColumn)===-1&&s.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&i.indexOf(t.updateDateColumn)===-1&&s.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(r).map(l=>{let c=r[l];if(typeof c=="function")s.push(this.escape(l)+" = "+c());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&c===null)s.push(this.escape(l)+" = NULL");else{const u=this.createParameter(c);s.push(this.escape(l)+" = "+u)}}),s.length<=0)throw new bs;const a=this.createWhereExpression(),o=this.createReturningExpression("update");return o===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${s.join(", ")}${a}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${s.join(", ")} OUTPUT ${o}${a}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${s.join(", ")}${a} RETURNING ${o}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(k.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new da}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new bs}}function ph(){he.registerQueryBuilderClass("DeleteQueryBuilder",n=>new Jp(n)),he.registerQueryBuilderClass("InsertQueryBuilder",n=>new eh(n)),he.registerQueryBuilderClass("RelationQueryBuilder",n=>new nh(n)),he.registerQueryBuilderClass("SelectQueryBuilder",n=>new js(n)),he.registerQueryBuilderClass("SoftDeleteQueryBuilder",n=>new ch(n)),he.registerQueryBuilderClass("UpdateQueryBuilder",n=>new uh(n))}var ja;(function(n){n.VIEW="VIEW",n.MATERIALIZED_VIEW="MATERIALIZED_VIEW",n.GENERATED_COLUMN="GENERATED_COLUMN"})(ja||(ja={}));var Is={exports:{}},$s,Ia;function hh(){if(Ia)return $s;Ia=1;var n=1e3,e=n*60,t=e*60,r=t*24,s=r*7,i=r*365.25;$s=function(u,p){p=p||{};var h=typeof u;if(h==="string"&&u.length>0)return a(u);if(h==="number"&&isFinite(u))return p.long?l(u):o(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function a(u){if(u=String(u),!(u.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(p){var h=parseFloat(p[1]),d=(p[2]||"ms").toLowerCase();switch(d){case"years":case"year":case"yrs":case"yr":case"y":return h*i;case"weeks":case"week":case"w":return h*s;case"days":case"day":case"d":return h*r;case"hours":case"hour":case"hrs":case"hr":case"h":return h*t;case"minutes":case"minute":case"mins":case"min":case"m":return h*e;case"seconds":case"second":case"secs":case"sec":case"s":return h*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function o(u){var p=Math.abs(u);return p>=r?Math.round(u/r)+"d":p>=t?Math.round(u/t)+"h":p>=e?Math.round(u/e)+"m":p>=n?Math.round(u/n)+"s":u+"ms"}function l(u){var p=Math.abs(u);return p>=r?c(u,p,r,"day"):p>=t?c(u,p,t,"hour"):p>=e?c(u,p,e,"minute"):p>=n?c(u,p,n,"second"):u+" ms"}function c(u,p,h,d){var m=p>=h*1.5;return Math.round(u/h)+" "+d+(m?"s":"")}return $s}var Ls,$a;function dh(){if($a)return Ls;$a=1;function n(e){r.debug=r,r.default=r,r.coerce=c,r.disable=a,r.enable=i,r.enabled=o,r.humanize=hh(),r.destroy=u,Object.keys(e).forEach(p=>{r[p]=e[p]}),r.names=[],r.skips=[],r.formatters={};function t(p){let h=0;for(let d=0;d<p.length;d++)h=(h<<5)-h+p.charCodeAt(d),h|=0;return r.colors[Math.abs(h)%r.colors.length]}r.selectColor=t;function r(p){let h,d=null,m,y;function f(...g){if(!f.enabled)return;const b=f,_=Number(new Date),M=_-(h||_);b.diff=M,b.prev=h,b.curr=_,h=_,g[0]=r.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let S=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(C,W)=>{if(C==="%%")return"%";S++;const V=r.formatters[W];if(typeof V=="function"){const q=g[S];C=V.call(b,q),g.splice(S,1),S--}return C}),r.formatArgs.call(b,g),(b.log||r.log).apply(b,g)}return f.namespace=p,f.useColors=r.useColors(),f.color=r.selectColor(p),f.extend=s,f.destroy=r.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(m!==r.namespaces&&(m=r.namespaces,y=r.enabled(p)),y),set:g=>{d=g}}),typeof r.init=="function"&&r.init(f),f}function s(p,h){const d=r(this.namespace+(typeof h>"u"?":":h)+p);return d.log=this.log,d}function i(p){r.save(p),r.namespaces=p,r.names=[],r.skips=[];let h;const d=(typeof p=="string"?p:"").split(/[\s,]+/),m=d.length;for(h=0;h<m;h++)d[h]&&(p=d[h].replace(/\*/g,".*?"),p[0]==="-"?r.skips.push(new RegExp("^"+p.slice(1)+"$")):r.names.push(new RegExp("^"+p+"$")))}function a(){const p=[...r.names.map(l),...r.skips.map(l).map(h=>"-"+h)].join(",");return r.enable(""),p}function o(p){if(p[p.length-1]==="*")return!0;let h,d;for(h=0,d=r.skips.length;h<d;h++)if(r.skips[h].test(p))return!1;for(h=0,d=r.names.length;h<d;h++)if(r.names[h].test(p))return!0;return!1}function l(p){return p.toString().substring(2,p.toString().length-2).replace(/\.\*\?$/,"*")}function c(p){return p instanceof Error?p.stack||p.message:p}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}return Ls=n,Ls}var La;function mh(){return La||(La=1,function(n,e){var t={};e.formatArgs=s,e.save=i,e.load=a,e.useColors=r,e.storage=o(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let c;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(c=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(c[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;c.splice(1,0,u,"color: inherit");let p=0,h=0;c[0].replace(/%[a-zA-Z%]/g,d=>{d!=="%%"&&(p++,d==="%c"&&(h=p))}),c.splice(h,0,u)}e.log=console.debug||console.log||(()=>{});function i(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch{}}function a(){let c;try{c=e.storage.getItem("debug")}catch{}return!c&&typeof xt<"u"&&"env"in xt&&(c=t.DEBUG),c}function o(){try{return localStorage}catch{}}n.exports=dh()(e);const{formatters:l}=n.exports;l.j=function(c){try{return JSON.stringify(c)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}}(Is,Is.exports)),Is.exports}mh(),ph();var fh=Object.defineProperty,yh=Object.defineProperties,gh=Object.getOwnPropertyDescriptors,ar=Object.getOwnPropertySymbols,Ba=Object.prototype.hasOwnProperty,qa=Object.prototype.propertyIsEnumerable,Da=(n,e,t)=>e in n?fh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,bh=(n,e)=>{for(var t in e||(e={}))Ba.call(e,t)&&Da(n,t,e[t]);if(ar)for(var t of ar(e))qa.call(e,t)&&Da(n,t,e[t]);return n},wh=(n,e)=>yh(n,gh(e)),_h=(n,e)=>{var t={};for(var r in n)Ba.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&ar)for(var r of ar(n))e.indexOf(r)<0&&qa.call(n,r)&&(t[r]=n[r]);return t};function vh(n){let e=setTimeout(n,0),t=setTimeout(n,10),r=setTimeout(n,50);return[e,t,r]}function xh(n){let e=E.useRef();return E.useEffect(()=>{e.current=n}),e.current}var Oh=18,Fa=40,Mh=`${Fa}px`,Eh=["[data-lastpass-icon-root]","com-1password-button","[data-dashlanecreated]",'[style$="2147483647 !important;"]'].join(",");function Ch({containerRef:n,inputRef:e,pushPasswordManagerStrategy:t,isFocused:r}){let[s,i]=E.useState(!1),[a,o]=E.useState(!1),[l,c]=E.useState(!1),u=E.useMemo(()=>t==="none"?!1:(t==="increase-width"||t==="experimental-no-flickering")&&s&&a,[s,a,t]),p=E.useCallback(()=>{let h=n.current,d=e.current;if(!h||!d||l||t==="none")return;let m=h,y=m.getBoundingClientRect().left+m.offsetWidth,f=m.getBoundingClientRect().top+m.offsetHeight/2,g=y-Oh,b=f;document.querySelectorAll(Eh).length===0&&document.elementFromPoint(g,b)===h||(i(!0),c(!0))},[n,e,l,t]);return E.useEffect(()=>{let h=n.current;if(!h||t==="none")return;function d(){let y=window.innerWidth-h.getBoundingClientRect().right;o(y>=Fa)}d();let m=setInterval(d,1e3);return()=>{clearInterval(m)}},[n,t]),E.useEffect(()=>{let h=r||document.activeElement===e.current;if(t==="none"||!h)return;let d=setTimeout(p,0),m=setTimeout(p,2e3),y=setTimeout(p,5e3),f=setTimeout(()=>{c(!0)},6e3);return()=>{clearTimeout(d),clearTimeout(m),clearTimeout(y),clearTimeout(f)}},[e,r,t,p]),{hasPWMBadge:s,willPushPWMBadge:u,PWM_BADGE_SPACE_WIDTH:Mh}}var Ua=E.createContext({}),Wa=E.forwardRef((n,e)=>{var t=n,{value:r,onChange:s,maxLength:i,textAlign:a="left",pattern:o,placeholder:l,inputMode:c="numeric",onComplete:u,pushPasswordManagerStrategy:p="increase-width",pasteTransformer:h,containerClassName:d,noScriptCSSFallback:m=Ah,render:y,children:f}=t,g=_h(t,["value","onChange","maxLength","textAlign","pattern","placeholder","inputMode","onComplete","pushPasswordManagerStrategy","pasteTransformer","containerClassName","noScriptCSSFallback","render","children"]),b,_,M,S,C;let[W,V]=E.useState(typeof g.defaultValue=="string"?g.defaultValue:""),q=r??W,$=xh(q),re=E.useCallback(F=>{s==null||s(F),V(F)},[s]),pe=E.useMemo(()=>o?typeof o=="string"?new RegExp(o):o:null,[o]),ee=E.useRef(null),Ge=E.useRef(null),Be=E.useRef({value:q,onChange:re,isIOS:typeof window<"u"&&((_=(b=window==null?void 0:window.CSS)==null?void 0:b.supports)==null?void 0:_.call(b,"-webkit-touch-callout","none"))}),Fe=E.useRef({prev:[(M=ee.current)==null?void 0:M.selectionStart,(S=ee.current)==null?void 0:S.selectionEnd,(C=ee.current)==null?void 0:C.selectionDirection]});E.useImperativeHandle(e,()=>ee.current,[]),E.useEffect(()=>{let F=ee.current,K=Ge.current;if(!F||!K)return;Be.current.value!==F.value&&Be.current.onChange(F.value),Fe.current.prev=[F.selectionStart,F.selectionEnd,F.selectionDirection];function de(){if(document.activeElement!==F){bt(null),We(null);return}let se=F.selectionStart,ve=F.selectionEnd,me=F.selectionDirection,ue=F.maxLength,tt=F.value,Xe=Fe.current.prev,_t=-1,vt=-1,nt;if(tt.length!==0&&se!==null&&ve!==null){let Gn=se===ve,w=se===tt.length&&tt.length<ue;if(Gn&&!w){let x=se;if(x===0)_t=0,vt=1,nt="forward";else if(x===ue)_t=x-1,vt=x,nt="backward";else if(ue>1&&tt.length>1){let O=0;if(Xe[0]!==null&&Xe[1]!==null){nt=x<Xe[1]?"backward":"forward";let A=Xe[0]===Xe[1]&&Xe[0]<ue;nt==="backward"&&!A&&(O=-1)}_t=O+x,vt=O+x+1}}_t!==-1&&vt!==-1&&_t!==vt&&ee.current.setSelectionRange(_t,vt,nt)}let rs=_t!==-1?_t:se,ss=vt!==-1?vt:ve,Ji=nt??me;bt(rs),We(ss),Fe.current.prev=[rs,ss,Ji]}if(document.addEventListener("selectionchange",de,{capture:!0}),de(),document.activeElement===F&&$t(!0),!document.getElementById("input-otp-style")){let se=document.createElement("style");if(se.id="input-otp-style",document.head.appendChild(se),se.sheet){let ve="background: transparent !important; color: transparent !important; border-color: transparent !important; opacity: 0 !important; box-shadow: none !important; -webkit-box-shadow: none !important; -webkit-text-fill-color: transparent !important;";Mn(se.sheet,"[data-input-otp]::selection { background: transparent !important; color: transparent !important; }"),Mn(se.sheet,`[data-input-otp]:autofill { ${ve} }`),Mn(se.sheet,`[data-input-otp]:-webkit-autofill { ${ve} }`),Mn(se.sheet,"@supports (-webkit-touch-callout: none) { [data-input-otp] { letter-spacing: -.6em !important; font-weight: 100 !important; font-stretch: ultra-condensed; font-optical-sizing: none !important; left: -1px !important; right: 1px !important; } }"),Mn(se.sheet,"[data-input-otp] + * { pointer-events: all !important; }")}}let Re=()=>{K&&K.style.setProperty("--root-height",`${F.clientHeight}px`)};Re();let Ce=new ResizeObserver(Re);return Ce.observe(F),()=>{document.removeEventListener("selectionchange",de,{capture:!0}),Ce.disconnect()}},[]);let[le,ut]=E.useState(!1),[Ue,$t]=E.useState(!1),[Ze,bt]=E.useState(null),[L,We]=E.useState(null);E.useEffect(()=>{vh(()=>{var F,K,de,Re;(F=ee.current)==null||F.dispatchEvent(new Event("input"));let Ce=(K=ee.current)==null?void 0:K.selectionStart,se=(de=ee.current)==null?void 0:de.selectionEnd,ve=(Re=ee.current)==null?void 0:Re.selectionDirection;Ce!==null&&se!==null&&(bt(Ce),We(se),Fe.current.prev=[Ce,se,ve])})},[q,Ue]),E.useEffect(()=>{$!==void 0&&q!==$&&$.length<i&&q.length===i&&(u==null||u(q))},[i,u,$,q]);let wt=Ch({containerRef:Ge,inputRef:ee,pushPasswordManagerStrategy:p,isFocused:Ue}),ce=E.useCallback(F=>{let K=F.currentTarget.value.slice(0,i);if(K.length>0&&pe&&!pe.test(K)){F.preventDefault();return}typeof $=="string"&&K.length<$.length&&document.dispatchEvent(new Event("selectionchange")),re(K)},[i,re,$,pe]),Zt=E.useCallback(()=>{var F;if(ee.current){let K=Math.min(ee.current.value.length,i-1),de=ee.current.value.length;(F=ee.current)==null||F.setSelectionRange(K,de),bt(K),We(de)}$t(!0)},[i]),$e=E.useCallback(F=>{var K,de;let Re=ee.current;if(!h&&(!Be.current.isIOS||!F.clipboardData||!Re))return;let Ce=F.clipboardData.getData("text/plain"),se=h?h(Ce):Ce;F.preventDefault();let ve=(K=ee.current)==null?void 0:K.selectionStart,me=(de=ee.current)==null?void 0:de.selectionEnd,ue=(ve!==me?q.slice(0,ve)+se+q.slice(me):q.slice(0,ve)+se+q.slice(ve)).slice(0,i);if(ue.length>0&&pe&&!pe.test(ue))return;Re.value=ue,re(ue);let tt=Math.min(ue.length,i-1),Xe=ue.length;Re.setSelectionRange(tt,Xe),bt(tt),We(Xe)},[i,re,pe,q]),et=E.useMemo(()=>({position:"relative",cursor:g.disabled?"default":"text",userSelect:"none",WebkitUserSelect:"none",pointerEvents:"none"}),[g.disabled]),pt=E.useMemo(()=>({position:"absolute",inset:0,width:wt.willPushPWMBadge?`calc(100% + ${wt.PWM_BADGE_SPACE_WIDTH})`:"100%",clipPath:wt.willPushPWMBadge?`inset(0 ${wt.PWM_BADGE_SPACE_WIDTH} 0 0)`:void 0,height:"100%",display:"flex",textAlign:a,opacity:"1",color:"transparent",pointerEvents:"all",background:"transparent",caretColor:"transparent",border:"0 solid transparent",outline:"0 solid transparent",boxShadow:"none",lineHeight:"1",letterSpacing:"-.5em",fontSize:"var(--root-height)",fontFamily:"monospace",fontVariantNumeric:"tabular-nums"}),[wt.PWM_BADGE_SPACE_WIDTH,wt.willPushPWMBadge,a]),Ve=E.useMemo(()=>E.createElement("input",wh(bh({autoComplete:g.autoComplete||"one-time-code"},g),{"data-input-otp":!0,"data-input-otp-placeholder-shown":q.length===0||void 0,"data-input-otp-mss":Ze,"data-input-otp-mse":L,inputMode:c,pattern:pe==null?void 0:pe.source,"aria-placeholder":l,style:pt,maxLength:i,value:q,ref:ee,onPaste:F=>{var K;$e(F),(K=g.onPaste)==null||K.call(g,F)},onChange:ce,onMouseOver:F=>{var K;ut(!0),(K=g.onMouseOver)==null||K.call(g,F)},onMouseLeave:F=>{var K;ut(!1),(K=g.onMouseLeave)==null||K.call(g,F)},onFocus:F=>{var K;Zt(),(K=g.onFocus)==null||K.call(g,F)},onBlur:F=>{var K;$t(!1),(K=g.onBlur)==null||K.call(g,F)}})),[ce,Zt,$e,c,pt,i,L,Ze,g,pe==null?void 0:pe.source,q]),Lt=E.useMemo(()=>({slots:Array.from({length:i}).map((F,K)=>{var de;let Re=Ue&&Ze!==null&&L!==null&&(Ze===L&&K===Ze||K>=Ze&&K<L),Ce=q[K]!==void 0?q[K]:null,se=q[0]!==void 0?null:(de=l==null?void 0:l[K])!=null?de:null;return{char:Ce,placeholderChar:se,isActive:Re,hasFakeCaret:Re&&Ce===null}}),isFocused:Ue,isHovering:!g.disabled&&le}),[Ue,le,i,L,Ze,g.disabled,q]),Bt=E.useMemo(()=>y?y(Lt):E.createElement(Ua.Provider,{value:Lt},f),[f,Lt,y]);return E.createElement(E.Fragment,null,m!==null&&E.createElement("noscript",null,E.createElement("style",null,m)),E.createElement("div",{ref:Ge,"data-input-otp-container":!0,style:et,className:d},Bt,E.createElement("div",{style:{position:"absolute",inset:0,pointerEvents:"none"}},Ve)))});Wa.displayName="Input";function Mn(n,e){try{n.insertRule(e)}catch{console.error("input-otp could not insert CSS rule:",e)}}var Ah=`
[data-input-otp] {
  --nojs-bg: white !important;
  --nojs-fg: black !important;

  background-color: var(--nojs-bg) !important;
  color: var(--nojs-fg) !important;
  caret-color: var(--nojs-fg) !important;
  letter-spacing: .25em !important;
  text-align: center !important;
  border: 1px solid var(--nojs-fg) !important;
  border-radius: 4px !important;
  width: 100% !important;
}
@media (prefers-color-scheme: dark) {
  [data-input-otp] {
    --nojs-bg: black !important;
    --nojs-fg: white !important;
  }
}`;ms=E.forwardRef(({className:n,containerClassName:e,...t},r)=>H.jsx(Wa,{ref:r,containerClassName:Oe("flex items-center gap-2 has-[:disabled]:opacity-50",e),className:Oe("disabled:cursor-not-allowed",n),...t})),ms.displayName="InputOTP",tr=E.forwardRef(({className:n,...e},t)=>H.jsx("div",{ref:t,className:Oe("flex items-center",n),...e})),tr.displayName="InputOTPGroup",Pt=E.forwardRef(({index:n,className:e,hidden:t,...r},s)=>{const i=E.useContext(Ua),{char:a,hasFakeCaret:o,isActive:l}=i.slots[n];return H.jsxs("div",{ref:s,className:Oe("relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",l&&"z-10 ring-2 ring-ring ring-offset-background",e),...r,children:[t&&a?H.jsx(gp,{}):a,o&&H.jsx("div",{className:"pointer-events-none absolute inset-0 flex items-center justify-center",children:H.jsx("div",{className:"h-4 w-px animate-caret-blink bg-foreground duration-1000"})})]})}),Pt.displayName="InputOTPSlot",fs=E.forwardRef(({...n},e)=>H.jsx("div",{ref:e,role:"separator",...n,children:H.jsx(gp,{})})),fs.displayName="InputOTPSeparator";let nn,Bs,Va,or,lr,qs,za,Qa;na=ng(({onConfirm:n,onCancel:e})=>{const t=Hu(),{t:r}=Gu("dialogs"),[s,i]=E.useState(""),a=c=>{i(c)},o=async()=>{(s==null?void 0:s.length)===6&&(await(n==null?void 0:n(s)),i(""),t.resolve(!0),t.hide())},l=async()=>{await(e==null?void 0:e()),i(""),t.resolve(!1),t.hide()};return H.jsx(lg,{open:t.visible,onOpenChange:l,children:H.jsxs(cg,{className:"w-[330px]",children:[H.jsxs(ug,{children:[H.jsx(pg,{children:r("session_passkey.title")}),H.jsx(hg,{children:r("session_passkey.description")})]}),H.jsx("div",{className:"py-4",children:H.jsxs(ms,{onChange:a,maxLength:6,children:[H.jsxs(tr,{children:[H.jsx(Pt,{index:0,hidden:!0}),H.jsx(Pt,{index:1,hidden:!0}),H.jsx(Pt,{index:2,hidden:!0})]}),H.jsx(fs,{}),H.jsxs(tr,{children:[H.jsx(Pt,{index:3,hidden:!0}),H.jsx(Pt,{index:4,hidden:!0}),H.jsx(Pt,{index:5,hidden:!0})]})]})}),H.jsx(dg,{children:H.jsx(mg,{disabled:(s==null?void 0:s.length)!==6,onClick:o,type:"submit",children:r("session_passkey.confirm")})})]})})}),nn=n=>{const e=n.match(/.{1,2}/g);if(!e)throw new Error("Invalid hexString");return Uint8Array.from(e.map(t=>parseInt(t,16))).buffer},Bs=n=>new TextEncoder().encode(n).buffer,Va=async n=>{const e=Bs(n);return await crypto.subtle.digest("SHA-256",e)},or=n=>[...new Uint8Array(n)].map(e=>e.toString(16).padStart(2,"0")).join(""),_p=async()=>{const n=crypto.getRandomValues(new Uint8Array(32));return or(n)},lr=async n=>{const e=await Va(n);return or(e)},qs=async n=>(await lr(n)).substring(0,32),la=async(n,e)=>{const t=await lr(e),r=await qs(e),s=Bs(n),i=await za(s,t,r);return or(i)},Yn=async(n,e)=>{const t=await lr(e),r=await qs(e),s=nn(n),i=await Qa(s,t,r);return new TextDecoder().decode(i)},za=async(n,e,t)=>{const r=nn(t),s=nn(e),i=await crypto.subtle.importKey("raw",s,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.encrypt({name:"AES-CBC",iv:r},i,n)},Qa=async(n,e,t)=>{const r=nn(t),s=nn(e),i=await crypto.subtle.importKey("raw",s,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"]);return await crypto.subtle.decrypt({name:"AES-CBC",iv:r},i,n)},xp=async(n,e)=>{const t={};return await Promise.all(Object.entries(n||{}).map(async([r,s])=>{const i=await la(s,e);t[r]=i})),t},vp=async(n,e)=>{let t;if(await new Promise((r,s)=>{e.show({onConfirm:async i=>{try{t=await Yn(n,i),await as.set("passphrase",t),r(!0)}catch(a){s(a)}finally{e.hide()}},onCancel:()=>{s()}})}),!t)throw new Error("Passphrase is required");return t},ra=n=>{const e=Hu(n),t=E.useRef(e);return t.current=e,{modal:e,modalRef:t}};class Ka extends fg{}ia=class extends Ka{static lc_name(){return"StringPromptValue"}constructor(n){super({value:n}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=n}toString(){return this.value}toChatMessages(){return[new np(this.value)]}};class Sh extends Ka{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return yg(this.messages)}toChatMessages(){return this.messages}}const Ph=`
# Response Instructions
You must respond in the following format:
{{format}}
You must reply in the following format:
  <response>{"field_name_1": "data extract from based on explain", "field_name_2": "data extract from based on explain"}</response>
Here is an example:
  Format: {"city": { "required": true, "explain": "City name. Example: Ha Noi, London, etc. Only one city name", "type": "string" }}
  Human: Ho Chi Minh is the largest city in Vietnam and has a population of 8.4 million.
  AI: <response>{"city": "Ho Chi Minh"}</response>
Reminder:
- Response MUST follow the specified format and use BOTH <response> and </response>
- Required fields MUST be specified
- Put the entire response reply on one line
You are a helpful Assistant.`;async function kh({format:n,stream:e,onChunk:t,messages:r}){const s=[new rp(Ph.replace("{{format}}",JSON.stringify(n))),...r];let i="";if(e){const o=await vn.chatCompletion(s,{stream:!0});if(o&&Symbol.asyncIterator in o)for await(const l of o){const c=l.content||"";i+=c,t==null||t({content:c,chunk:l.chunk||l})}}else{const o=await vn.chatCompletion(s,{stream:!1});typeof o=="string"&&(i=o)}const a=i==null?void 0:i.match(/<response>(.*)<\/response>/);return a?{content:a[1]||i||"",isStructured:!0}:{content:i||"",isStructured:!1}}const Ja=(n,e)=>{try{return JSON.parse(n)}catch(t){return Hi("[ManualFunctionCalling]",n,t),e!=null&&e.includes("retryWithMissingBracket")?(e=e.filter(r=>r==="retryWithMissingBracket"),Ja(`${n}}`,e)):void 0}},Th=`Cutting Knowledge Date: December 2023
Today Date: 23 Jul 2024
# Tool Instructions
- When looking for real time information use relevant functions if available
You have access to the following functions:

{{tools}}

If a you choose to call a function ONLY reply in the following format:
    <function>{"name": function name, "parameters": { dictionary of argument name and its value }}</function>
Here is an example,
    <function>{"name": "example_function_name", "parameters": {"example_name": "example_value"}}</function>
Reminder:
- Function calls MUST follow the specified format and use BOTH <function> and </function>
- Required parameters MUST be specified
- Only call one function at a time
- When calling a function, do NOT add any other words, ONLY the function calling
- Put the entire function call reply on one line
- Always add your sources when using search results to answer the user query
You are a helpful Assistant.`;async function Rh({tools:n,stream:e,onChunk:t,messages:r}){const s=n.map(u=>JSON.stringify({type:"function",function:{name:u.function.name,description:u.function.description,parameters:u.function.parameters}},null,2)).join(`
`),i=[new rp(Th.replace("{{tools}}",s)),...r];let a="";if(e){const u=await vn.chatCompletion(i,{stream:!0});if(u&&Symbol.asyncIterator in u)for await(const p of u){const h=p.content||"";a+=h,h&&(t==null||t(new At(h)))}}else{const u=await vn.chatCompletion(i,{stream:!1});typeof u=="object"&&u&&"content"in u&&(a=u.content||"")}const o=a==null?void 0:a.match(/<function>(.*)<\/function>/);if(!(o!=null&&o.length))return new At({content:a});const l=a.replace(o[0],""),c=[];if(o[1]){const u=Ja(o[1],["retryWithMissingBracket"]);u&&c.push({name:u.name,args:u.parameters})}return new At({content:c!=null&&c.length?l:a,tool_calls:c})}function Nh(n){return n!=null&&typeof n=="object"&&Symbol.asyncIterator in n}const Ha=async n=>{switch(n){case"WebLLM":return await ys.getCurrentModel();case"Wllama":return gs.getCurrentModel();default:return}},jh=async n=>{switch(n){case"WebLLM":return await ys.unloadModel();case"Wllama":return await gs.unloadModel();default:return}},Ga=async(n,e,t)=>{let r="",s;if(n&&Nh(n)){for await(const i of n)if(i&&typeof i=="object"&&"content"in i){const a=typeof i.content=="string"?i.content:"";a&&(r+=a,s=("chunk"in i?i.chunk:i)||i,e==null||e({content:r,chunk:s}))}}else{const i=n;r=i.content||"",s=i}return t==null||t({content:r,lastChunk:s}),{lastChunk:s,content:r}},Ih=async(n,e)=>{var l;const{tools:t,schemas:r,onMessageUpdate:s,onMessageFinish:i}=e||{};if(!(e!=null&&e.llm))throw new Error("LLM is not found");if(!await Ha((l=e==null?void 0:e.llm)==null?void 0:l.provider))throw new Error("Model is not found");const a={stream:!0};if(r!=null&&r.length){r&&(r==null?void 0:r.length)>1&&Hi("Multiple schemas are not supported. Only the first schema will be used.");const c=r[0].schema;a.response_format={type:"json_object",schema:c}}t!=null&&t.length&&(a.tools=t);const o=await ys.chatCompletion(n,a);if(!o)throw new Error("Chat completion is not supported");return await Ga(o,s,i)},$h=async(n,e)=>{var l,c;const{tools:t,schemas:r,onMessageUpdate:s,onMessageFinish:i}=e||{};if(!(e!=null&&e.llm))throw new Error("LLM is not found");await Ha((l=e==null?void 0:e.llm)==null?void 0:l.provider)&&await jh((c=e==null?void 0:e.llm)==null?void 0:c.provider);const a={stream:!0};if(r!=null&&r.length){r&&(r==null?void 0:r.length)>1&&Hi("Multiple schemas are not supported. Only the first schema will be used.");const u=r[0];let p="";const h=await kh({messages:n,format:u.schema,stream:!0,onChunk:({content:d,chunk:m})=>{p+=d,s==null||s({content:p,chunk:m})}});return i==null||i({content:h.content,lastChunk:void 0}),{lastChunk:void 0,content:h.content}}if(t!=null&&t.length){let u="";const p=await Rh({messages:n,tools:t,stream:!0,onChunk:d=>{const m=d.content||"";u+=m,s==null||s({content:u,chunk:d})}}),h=typeof p.content=="string"?p.content:JSON.stringify(p.content);return i==null||i({content:h,lastChunk:p}),{lastChunk:p,content:h}}const o=await gs.chatCompletion(n,a);if(!o)throw new Error("Chat completion is not supported");return await Ga(o,s,i)},Lh={async chatCompletion(n,e){var t;switch((t=e==null?void 0:e.llm)==null?void 0:t.provider){case"WebLLM":return Ih(n,e);case"Wllama":return $h(n,e);default:throw new Error("Local LLM provider is not supported")}},async stream(n,e){return this.chatCompletion(n,e)}};function z(n,e,t,r,s){if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}function v(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}let Za=function(){const{crypto:n}=globalThis;if(n!=null&&n.randomUUID)return Za=n.randomUUID.bind(n),n.randomUUID();const e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^t()&15>>+r/4).toString(16))};function Ds(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}const Fs=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){const e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};class U extends Error{}let qe=class ca extends U{constructor(e,t,r,s){super(`${ca.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.requestID=s==null?void 0:s.get("x-request-id"),this.error=t;const i=t;this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,t,r){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new cr({message:r,cause:Fs(t)});const i=t==null?void 0:t.error;return e===400?new Xa(e,i,r,s):e===401?new Ya(e,i,r,s):e===403?new eo(e,i,r,s):e===404?new to(e,i,r,s):e===409?new no(e,i,r,s):e===422?new ro(e,i,r,s):e===429?new so(e,i,r,s):e>=500?new io(e,i,r,s):new ca(e,i,r,s)}},Qe=class extends qe{constructor({message:n}={}){super(void 0,void 0,n||"Request was aborted.",void 0)}},cr=class extends qe{constructor({message:n,cause:e}){super(void 0,void 0,n||"Connection error.",void 0),e&&(this.cause=e)}},ur=class extends cr{constructor({message:n}={}){super({message:n??"Request timed out."})}},Xa=class extends qe{},Ya=class extends qe{},eo=class extends qe{},to=class extends qe{},no=class extends qe{},ro=class extends qe{},so=class extends qe{},io=class extends qe{};class ao extends U{constructor(){super("Could not parse response content as the length limit was reached")}}class oo extends U{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class En extends Error{constructor(e){super(e)}}const Bh=/^[a-z][a-z0-9+.-]*:/i,qh=n=>Bh.test(n);let De=n=>(De=Array.isArray,De(n)),lo=De;function Dh(n){return typeof n!="object"?{}:n??{}}function Fh(n){if(!n)return!0;for(const e in n)return!1;return!0}function Uh(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Us(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}const Wh=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new U(`${n} must be an integer`);if(e<0)throw new U(`${n} must be a positive integer`);return e},Vh=n=>{try{return JSON.parse(n)}catch{return}},Cn=n=>new Promise(e=>setTimeout(e,n)),rn="5.8.2",zh=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Qh(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const Kh=()=>{var t;const n=Qh();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":rn,"X-Stainless-OS":uo(Deno.build.os),"X-Stainless-Arch":co(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((t=Deno.version)==null?void 0:t.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":rn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":rn,"X-Stainless-OS":uo(globalThis.process.platform??"unknown"),"X-Stainless-Arch":co(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=Jh();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":rn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":rn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Jh(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const co=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",uo=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let po;const Hh=()=>po??(po=Kh());function Gh(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function ho(...n){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function mo(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return ho({start(){},async pull(t){const{done:r,value:s}=await e.next();r?t.close():t.enqueue(s)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function fo(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function Zh(n){var r,s;if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await((s=(r=n[Symbol.asyncIterator]()).return)==null?void 0:s.call(r));return}const e=n.getReader(),t=e.cancel();e.releaseLock(),await t}const Xh=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),yo="RFC3986",go=n=>String(n),bo={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:go},Yh="RFC1738";let Ws=(n,e)=>(Ws=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Ws(n,e));const ft=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),Vs=1024,ed=(n,e,t,r,s)=>{if(n.length===0)return n;let i=n;if(typeof n=="symbol"?i=Symbol.prototype.toString.call(n):typeof n!="string"&&(i=String(n)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=Vs){const l=i.length>=Vs?i.slice(o,o+Vs):i,c=[];for(let u=0;u<l.length;++u){let p=l.charCodeAt(u);if(p===45||p===46||p===95||p===126||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||s===Yh&&(p===40||p===41)){c[c.length]=l.charAt(u);continue}if(p<128){c[c.length]=ft[p];continue}if(p<2048){c[c.length]=ft[192|p>>6]+ft[128|p&63];continue}if(p<55296||p>=57344){c[c.length]=ft[224|p>>12]+ft[128|p>>6&63]+ft[128|p&63];continue}u+=1,p=65536+((p&1023)<<10|l.charCodeAt(u)&1023),c[c.length]=ft[240|p>>18]+ft[128|p>>12&63]+ft[128|p>>6&63]+ft[128|p&63]}a+=c.join("")}return a};function td(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function wo(n,e){if(De(n)){const t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}const _o={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},vo=function(n,e){Array.prototype.push.apply(n,De(e)?e:[e])};let xo;const be={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:ed,encodeValuesOnly:!1,format:yo,formatter:go,indices:!1,serializeDate(n){return(xo??(xo=Function.prototype.call.bind(Date.prototype.toISOString)))(n)},skipNulls:!1,strictNullHandling:!1};function nd(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const zs={};function Oo(n,e,t,r,s,i,a,o,l,c,u,p,h,d,m,y,f,g){let b=n,_=g,M=0,S=!1;for(;(_=_.get(zs))!==void 0&&!S;){const $=_.get(n);if(M+=1,typeof $<"u"){if($===M)throw new RangeError("Cyclic object value");S=!0}typeof _.get(zs)>"u"&&(M=0)}if(typeof c=="function"?b=c(e,b):b instanceof Date?b=h==null?void 0:h(b):t==="comma"&&De(b)&&(b=wo(b,function($){return $ instanceof Date?h==null?void 0:h($):$})),b===null){if(i)return l&&!y?l(e,be.encoder,f,"key",d):e;b=""}if(nd(b)||td(b)){if(l){const $=y?e:l(e,be.encoder,f,"key",d);return[(m==null?void 0:m($))+"="+(m==null?void 0:m(l(b,be.encoder,f,"value",d)))]}return[(m==null?void 0:m(e))+"="+(m==null?void 0:m(String(b)))]}const C=[];if(typeof b>"u")return C;let W;if(t==="comma"&&De(b))y&&l&&(b=wo(b,l)),W=[{value:b.length>0?b.join(",")||null:void 0}];else if(De(c))W=c;else{const $=Object.keys(b);W=u?$.sort(u):$}const V=o?String(e).replace(/\./g,"%2E"):String(e),q=r&&De(b)&&b.length===1?V+"[]":V;if(s&&De(b)&&b.length===0)return q+"[]";for(let $=0;$<W.length;++$){const re=W[$],pe=typeof re=="object"&&typeof re.value<"u"?re.value:b[re];if(a&&pe===null)continue;const ee=p&&o?re.replace(/\./g,"%2E"):re,Ge=De(b)?typeof t=="function"?t(q,ee):q:q+(p?"."+ee:"["+ee+"]");g.set(n,M);const Be=new WeakMap;Be.set(zs,g),vo(C,Oo(pe,Ge,t,r,s,i,a,o,t==="comma"&&y&&De(b)?null:l,c,u,p,h,d,m,y,f,Be))}return C}function rd(n=be){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||be.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=yo;if(typeof n.format<"u"){if(!Ws(bo,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const r=bo[t];let s=be.filter;(typeof n.filter=="function"||De(n.filter))&&(s=n.filter);let i;if(n.arrayFormat&&n.arrayFormat in _o?i=n.arrayFormat:"indices"in n?i=n.indices?"indices":"repeat":i=be.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:be.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:be.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:be.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:be.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?be.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:be.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:be.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:be.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:be.encodeValuesOnly,filter:s,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:be.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:be.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:be.strictNullHandling}}function sd(n,e={}){let t=n;const r=rd(e);let s,i;typeof r.filter=="function"?(i=r.filter,t=i("",t)):De(r.filter)&&(i=r.filter,s=i);const a=[];if(typeof t!="object"||t===null)return"";const o=_o[r.arrayFormat],l=o==="comma"&&r.commaRoundTrip;s||(s=Object.keys(t)),r.sort&&s.sort(r.sort);const c=new WeakMap;for(let h=0;h<s.length;++h){const d=s[h];r.skipNulls&&t[d]===null||vo(a,Oo(t[d],d,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const u=a.join(r.delimiter);let p=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),u.length>0?p+u:""}function id(n){let e=0;for(const s of n)e+=s.length;const t=new Uint8Array(e);let r=0;for(const s of n)t.set(s,r),r+=s.length;return t}let Mo;function Qs(n){let e;return(Mo??(e=new globalThis.TextEncoder,Mo=e.encode.bind(e)))(n)}let Eo;function Co(n){let e;return(Eo??(e=new globalThis.TextDecoder,Eo=e.decode.bind(e)))(n)}var Ke,Je;let pr=class{constructor(){Ke.set(this,void 0),Je.set(this,void 0),z(this,Ke,new Uint8Array),z(this,Je,null)}decode(n){if(n==null)return[];const e=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?Qs(n):n;z(this,Ke,id([v(this,Ke,"f"),e]));const t=[];let r;for(;(r=ad(v(this,Ke,"f"),v(this,Je,"f")))!=null;){if(r.carriage&&v(this,Je,"f")==null){z(this,Je,r.index);continue}if(v(this,Je,"f")!=null&&(r.index!==v(this,Je,"f")+1||r.carriage)){t.push(Co(v(this,Ke,"f").subarray(0,v(this,Je,"f")-1))),z(this,Ke,v(this,Ke,"f").subarray(v(this,Je,"f"))),z(this,Je,null);continue}const s=v(this,Je,"f")!==null?r.preceding-1:r.preceding,i=Co(v(this,Ke,"f").subarray(0,s));t.push(i),z(this,Ke,v(this,Ke,"f").subarray(r.index)),z(this,Je,null)}return t}flush(){return v(this,Ke,"f").length?this.decode(`
`):[]}};Ke=new WeakMap,Je=new WeakMap,pr.NEWLINE_CHARS=new Set([`
`,"\r"]),pr.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function ad(n,e){for(let t=e??0;t<n.length;t++){if(n[t]===10)return{preceding:t,index:t+1,carriage:!1};if(n[t]===13)return{preceding:t,index:t+1,carriage:!0}}return null}function od(n){for(let e=0;e<n.length-1;e++){if(n[e]===10&&n[e+1]===10||n[e]===13&&n[e+1]===13)return e+2;if(n[e]===13&&n[e+1]===10&&e+3<n.length&&n[e+2]===13&&n[e+3]===10)return e+4}return-1}let An=class rr{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*s(){if(r)throw new U("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(const a of ld(e,t))if(!i){if(a.data.startsWith("[DONE]")){i=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(o&&o.error)throw new qe(void 0,o.error,void 0,e.headers);yield o}else{let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(a.event=="error")throw new qe(void 0,o.error,o.message,void 0);yield{event:a.event,data:o}}}i=!0}catch(a){if(Ds(a))return;throw a}finally{i||t.abort()}}return new rr(s,t)}static fromReadableStream(e,t){let r=!1;async function*s(){const a=new pr,o=fo(e);for await(const l of o)for(const c of a.decode(l))yield c;for(const l of a.flush())yield l}async function*i(){if(r)throw new U("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(Ds(o))return;throw o}finally{a||t.abort()}}return new rr(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new rr(()=>s(e),this.controller),new rr(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;return ho({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{const{value:s,done:i}=await t.next();if(i)return r.close();const a=Qs(JSON.stringify(s)+`
`);r.enqueue(a)}catch(s){r.error(s)}},async cancel(){var r;await((r=t.return)==null?void 0:r.call(t))}})}};async function*ld(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new U("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new U("Attempted to iterate over a response with no body");const t=new ud,r=new pr,s=fo(n.body);for await(const i of cd(s))for(const a of r.decode(i)){const o=t.decode(a);o&&(yield o)}for(const i of r.flush()){const a=t.decode(i);a&&(yield a)}}async function*cd(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Qs(t):t;let s=new Uint8Array(e.length+r.length);s.set(e),s.set(r,e.length),e=s;let i;for(;(i=od(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}let ud=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(n){if(n.endsWith("\r")&&(n=n.substring(0,n.length-1)),!n){if(!this.event&&!this.data.length)return null;const s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(n),n.startsWith(":"))return null;let[e,t,r]=pd(n,":");return r.startsWith(" ")&&(r=r.substring(1)),e==="event"?this.event=r:e==="data"&&this.data.push(r),null}};function pd(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const hr={off:0,error:200,warn:300,info:400,debug:500},Ao=(n,e,t)=>{if(n){if(Uh(hr,n))return n;Ne(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(hr))}`)}};function Sn(){}function dr(n,e,t){return!e||hr[n]>hr[t]?Sn:e[n].bind(e)}const hd={error:Sn,warn:Sn,info:Sn,debug:Sn};let So=new WeakMap;function Ne(n){const e=n.logger,t=n.logLevel??"off";if(!e)return hd;const r=So.get(e);if(r&&r[0]===t)return r[1];const s={error:dr("error",e,t),warn:dr("warn",e,t),info:dr("info",e,t),debug:dr("debug",e,t)};return So.set(e,[t,s]),s}const Ut=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);async function Po(n,e){const{response:t,requestLogID:r,retryOfRequestLogID:s,startTime:i}=e,a=await(async()=>{var l,c;if(e.options.stream)return Ne(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):An.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const o=(c=(l=t.headers.get("content-type"))==null?void 0:l.split(";")[0])==null?void 0:c.trim();if(o!=null&&o.includes("application/json")||o!=null&&o.endsWith("+json")){const u=await t.json();return ko(u,t)}return await t.text()})();return Ne(n).debug(`[${r}] response parsed`,Ut({retryOfRequestLogID:s,url:t.url,status:t.status,body:a,durationMs:Date.now()-i})),a}function ko(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Pn;let To=class Mp extends Promise{constructor(e,t,r=Po){super(s=>{s(null)}),this.responsePromise=t,this.parseResponse=r,Pn.set(this,void 0),z(this,Pn,e)}_thenUnwrap(e){return new Mp(v(this,Pn,"f"),this.responsePromise,async(t,r)=>ko(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(v(this,Pn,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};Pn=new WeakMap;var mr;class Ro{constructor(e,t,r,s){mr.set(this,void 0),z(this,mr,e),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new U("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await v(this,mr,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(mr=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}let dd=class extends To{constructor(n,e,t){super(n,e,async(r,s)=>new t(r,s.response,await Po(r,s),s.options))}async*[Symbol.asyncIterator](){const n=await this;for await(const e of n)yield e}};class fr extends Ro{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class ye extends Ro{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var r;const e=this.getPaginatedItems(),t=(r=e[e.length-1])==null?void 0:r.id;return t?{...this.options,query:{...Dh(this.options.query),after:t}}:null}}const No=()=>{var n;if(typeof File>"u"){const{process:e}=globalThis,t=typeof((n=e==null?void 0:e.versions)==null?void 0:n.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function kn(n,e,t){return No(),new File(n,e??"unknown_file",t)}function yr(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}const jo=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Wt=async(n,e)=>({...n,body:await fd(n.body,e)}),Io=new WeakMap;function md(n){const e=typeof n=="function"?n:n.fetch,t=Io.get(e);if(t)return t;const r=(async()=>{try{const s="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new s(i).text()}catch{return!0}})();return Io.set(e,r),r}const fd=async(n,e)=>{if(!await md(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const t=new FormData;return await Promise.all(Object.entries(n||{}).map(([r,s])=>Ks(t,r,s))),t},yd=n=>n instanceof Blob&&"name"in n,Ks=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response)n.append(e,kn([await t.blob()],yr(t)));else if(jo(t))n.append(e,kn([await new Response(mo(t)).blob()],yr(t)));else if(yd(t))n.append(e,t,yr(t));else if(Array.isArray(t))await Promise.all(t.map(r=>Ks(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>Ks(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}},$o=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",gd=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&$o(n),bd=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function wd(n,e,t){if(No(),n=await n,gd(n))return n instanceof File?n:kn([await n.arrayBuffer()],n.name);if(bd(n)){const s=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),kn(await Js(s),e,t)}const r=await Js(n);if(e||(e=yr(n)),!(t!=null&&t.type)){const s=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof s=="string"&&(t={...t,type:s})}return kn(r,e,t)}async function Js(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if($o(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(jo(n))for await(const r of n)e.push(...await Js(r));else{const r=(t=n==null?void 0:n.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof n}${r?`; constructor: ${r}`:""}${_d(n)}`)}return e}function _d(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(e=>`"${e}"`).join(", ")}]`}let Q=class{constructor(n){this._client=n}};function Lo(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const vd=(n=Lo)=>function(e,...t){if(e.length===1)return e[0];let r=!1;const s=e.reduce((c,u,p)=>(/[?#]/.test(u)&&(r=!0),c+u+(p===t.length?"":(r?encodeURIComponent:n)(String(t[p])))),""),i=s.split(/[?#]/,1)[0],a=[],o=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let l;for(;(l=o.exec(i))!==null;)a.push({start:l.index,length:l[0].length});if(a.length>0){let c=0;const u=a.reduce((p,h)=>{const d=" ".repeat(h.start-c),m="^".repeat(h.length);return c=h.start+h.length,p+d+m},"");throw new U(`Path parameters result in path with invalid segments:
${s}
${u}`)}return s},P=vd(Lo);let Bo=class extends Q{list(n,e={},t){return this._client.getAPIList(P`/chat/completions/${n}/messages`,ye,{query:e,...t})}};function xd(n){return typeof n.parse=="function"}const gr=n=>(n==null?void 0:n.role)==="assistant",qo=n=>(n==null?void 0:n.role)==="tool";var Hs,br,wr,Tn,Rn,_r,Nn,Et,jn,vr,xr,sn,Do;class Gs{constructor(){Hs.add(this),this.controller=new AbortController,br.set(this,void 0),wr.set(this,()=>{}),Tn.set(this,()=>{}),Rn.set(this,void 0),_r.set(this,()=>{}),Nn.set(this,()=>{}),Et.set(this,{}),jn.set(this,!1),vr.set(this,!1),xr.set(this,!1),sn.set(this,!1),z(this,br,new Promise((e,t)=>{z(this,wr,e,"f"),z(this,Tn,t,"f")})),z(this,Rn,new Promise((e,t)=>{z(this,_r,e,"f"),z(this,Nn,t,"f")})),v(this,br,"f").catch(()=>{}),v(this,Rn,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},v(this,Hs,"m",Do).bind(this))},0)}_connected(){this.ended||(v(this,wr,"f").call(this),this._emit("connect"))}get ended(){return v(this,jn,"f")}get errored(){return v(this,vr,"f")}get aborted(){return v(this,xr,"f")}abort(){this.controller.abort()}on(e,t){return(v(this,Et,"f")[e]||(v(this,Et,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=v(this,Et,"f")[e];if(!r)return this;const s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(v(this,Et,"f")[e]||(v(this,Et,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{z(this,sn,!0),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){z(this,sn,!0),await v(this,Rn,"f")}_emit(e,...t){if(v(this,jn,"f"))return;e==="end"&&(z(this,jn,!0),v(this,_r,"f").call(this));const r=v(this,Et,"f")[e];if(r&&(v(this,Et,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){const s=t[0];!v(this,sn,"f")&&!(r!=null&&r.length)&&Promise.reject(s),v(this,Tn,"f").call(this,s),v(this,Nn,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=t[0];!v(this,sn,"f")&&!(r!=null&&r.length)&&Promise.reject(s),v(this,Tn,"f").call(this,s),v(this,Nn,"f").call(this,s),this._emit("end")}}_emitFinal(){}}br=new WeakMap,wr=new WeakMap,Tn=new WeakMap,Rn=new WeakMap,_r=new WeakMap,Nn=new WeakMap,Et=new WeakMap,jn=new WeakMap,vr=new WeakMap,xr=new WeakMap,sn=new WeakMap,Hs=new WeakSet,Do=function(n){if(z(this,vr,!0),n instanceof Error&&n.name==="AbortError"&&(n=new Qe),n instanceof Qe)return z(this,xr,!0),this._emit("abort",n);if(n instanceof U)return this._emit("error",n);if(n instanceof Error){const e=new U(n.message);return e.cause=n,this._emit("error",e)}return this._emit("error",new U(String(n)))};function Od(n,e){const t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function Zs(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function In(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Md(n,e){return!e||!Fo(e)?{...n,choices:n.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Xs(n,e)}function Xs(n,e){const t=n.choices.map(r=>{var s;if(r.finish_reason==="length")throw new ao;if(r.finish_reason==="content_filter")throw new oo;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:((s=r.message.tool_calls)==null?void 0:s.map(i=>Cd(e,i)))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?Ed(e,r.message.content):null}}});return{...n,choices:t}}function Ed(n,e){var t,r;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=n.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function Cd(n,e){var r;const t=(r=n.tools)==null?void 0:r.find(s=>{var i;return((i=s.function)==null?void 0:i.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:In(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function Ad(n,e){var r;if(!n)return!1;const t=(r=n.tools)==null?void 0:r.find(s=>{var i;return((i=s.function)==null?void 0:i.name)===e.function.name});return In(t)||(t==null?void 0:t.function.strict)||!1}function Fo(n){var e;return Zs(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(t=>In(t)||t.type==="function"&&t.function.strict===!0))??!1}function Sd(n){for(const e of n??[]){if(e.type!=="function")throw new U(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new U(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Le,Ys,Or,ei,ti,ni,Uo,Wo;const Pd=10;class Vo extends Gs{constructor(){super(...arguments),Le.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),qo(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(gr(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionToolCall",r.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new U("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),v(this,Le,"m",Ys).call(this)}async finalMessage(){return await this.done(),v(this,Le,"m",Or).call(this)}async finalFunctionToolCall(){return await this.done(),v(this,Le,"m",ei).call(this)}async finalFunctionToolCallResult(){return await this.done(),v(this,Le,"m",ti).call(this)}async totalUsage(){return await this.done(),v(this,Le,"m",ni).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=v(this,Le,"m",Or).call(this);t&&this._emit("finalMessage",t);const r=v(this,Le,"m",Ys).call(this);r&&this._emit("finalContent",r);const s=v(this,Le,"m",ei).call(this);s&&this._emit("finalFunctionToolCall",s);const i=v(this,Le,"m",ti).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",v(this,Le,"m",ni).call(this))}async _createChatCompletion(e,t,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),v(this,Le,"m",Uo).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Xs(i,t))}async _runChatCompletion(e,t,r){for(const s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runTools(e,t,r){var d,m,y;const s="tool",{tool_choice:i="auto",stream:a,...o}=t,l=typeof i!="string"&&((d=i==null?void 0:i.function)==null?void 0:d.name),{maxChatCompletions:c=Pd}=r||{},u=t.tools.map(f=>{if(In(f)){if(!f.$callback)throw new U("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:f.$callback,name:f.function.name,description:f.function.description||"",parameters:f.function.parameters,parse:f.$parseRaw,strict:!0}}}return f}),p={};for(const f of u)f.type==="function"&&(p[f.function.name||f.function.function.name]=f.function);const h="tools"in t?u.map(f=>f.type==="function"?{type:"function",function:{name:f.function.name||f.function.function.name,parameters:f.function.parameters,description:f.function.description,strict:f.function.strict}}:f):void 0;for(const f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){const g=(m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:m.message;if(!g)throw new U("missing message in ChatCompletion response");if(!((y=g.tool_calls)!=null&&y.length))return;for(const b of g.tool_calls){if(b.type!=="function")continue;const _=b.id,{name:M,arguments:S}=b.function,C=p[M];if(C){if(l&&l!==M){const $=`Invalid tool_call: ${JSON.stringify(M)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:s,tool_call_id:_,content:$});continue}}else{const $=`Invalid tool_call: ${JSON.stringify(M)}. Available options are: ${Object.keys(p).map(re=>JSON.stringify(re)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:_,content:$});continue}let W;try{W=xd(C)?await C.parse(S):S}catch($){const re=$ instanceof Error?$.message:String($);this._addMessage({role:s,tool_call_id:_,content:re});continue}const V=await C.function(W,this),q=v(this,Le,"m",Wo).call(this,V);if(this._addMessage({role:s,tool_call_id:_,content:q}),l)return}}}}Le=new WeakSet,Ys=function(){return v(this,Le,"m",Or).call(this).content??null},Or=function(){let n=this.messages.length;for(;n-- >0;){const e=this.messages[n];if(gr(e))return{...e,content:e.content??null,refusal:e.refusal??null}}throw new U("stream ended without producing a ChatCompletionMessage with role=assistant")},ei=function(){var n,e;for(let t=this.messages.length-1;t>=0;t--){const r=this.messages[t];if(gr(r)&&((n=r==null?void 0:r.tool_calls)!=null&&n.length))return(e=r.tool_calls.at(-1))==null?void 0:e.function}},ti=function(){for(let n=this.messages.length-1;n>=0;n--){const e=this.messages[n];if(qo(e)&&e.content!=null&&typeof e.content=="string"&&this.messages.some(t=>{var r;return t.role==="assistant"&&((r=t.tool_calls)==null?void 0:r.some(s=>s.type==="function"&&s.id===e.tool_call_id))}))return e.content}},ni=function(){const n={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:e}of this._chatCompletions)e&&(n.completion_tokens+=e.completion_tokens,n.prompt_tokens+=e.prompt_tokens,n.total_tokens+=e.total_tokens);return n},Uo=function(n){if(n.n!=null&&n.n>1)throw new U("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Wo=function(n){return typeof n=="string"?n:n===void 0?"undefined":JSON.stringify(n)};class ri extends Vo{static runTools(e,t,r){const s=new ri,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e,t=!0){super._addMessage(e,t),gr(e)&&e.content&&this._emit("content",e.content)}}const zo=1,Qo=2,Ko=4,Jo=8,Ho=16,Go=32,Zo=64,Xo=128,Yo=256,el=Xo|Yo,tl=Ho|Go|el|Zo,nl=zo|Qo|tl,rl=Ko|Jo,kd=nl|rl,Me={STR:zo,NUM:Qo,ARR:Ko,OBJ:Jo,NULL:Ho,BOOL:Go,NAN:Zo,INFINITY:Xo,MINUS_INFINITY:Yo,INF:el,SPECIAL:tl,ATOM:nl,COLLECTION:rl,ALL:kd};class Td extends Error{}class Rd extends Error{}function Nd(n,e=Me.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return jd(n.trim(),e)}const jd=(n,e)=>{const t=n.length;let r=0;const s=h=>{throw new Td(`${h} at position ${r}`)},i=h=>{throw new Rd(`${h} at position ${r}`)},a=()=>(p(),r>=t&&s("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?l():n[r]==="["?c():n.substring(r,r+4)==="null"||Me.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||Me.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||Me.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||Me.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||Me.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||Me.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):u()),o=()=>{const h=r;let d=!1;for(r++;r<t&&(n[r]!=='"'||d&&n[r-1]==="\\");)d=n[r]==="\\"?!d:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(d)))}catch(m){i(String(m))}else if(Me.STR&e)try{return JSON.parse(n.substring(h,r-Number(d))+'"')}catch{return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},l=()=>{r++,p();const h={};try{for(;n[r]!=="}";){if(p(),r>=t&&Me.OBJ&e)return h;const d=o();p(),r++;try{const m=a();Object.defineProperty(h,d,{value:m,writable:!0,enumerable:!0,configurable:!0})}catch(m){if(Me.OBJ&e)return h;throw m}p(),n[r]===","&&r++}}catch{if(Me.OBJ&e)return h;s("Expected '}' at end of object")}return r++,h},c=()=>{r++;const h=[];try{for(;n[r]!=="]";)h.push(a()),p(),n[r]===","&&r++}catch{if(Me.ARR&e)return h;s("Expected ']' at end of array")}return r++,h},u=()=>{if(r===0){n==="-"&&Me.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n)}catch(d){if(Me.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}i(String(d))}}const h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(Me.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch{n.substring(h,r)==="-"&&Me.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(d){i(String(d))}}},p=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return a()},sl=n=>Nd(n,Me.ALL^Me.NUM);var we,Ct,an,Tt,si,Mr,ii,ai,oi,Er,li,il;class $n extends Vo{constructor(e){super(),we.add(this),Ct.set(this,void 0),an.set(this,void 0),Tt.set(this,void 0),z(this,Ct,e),z(this,an,[])}get currentChatCompletionSnapshot(){return v(this,Tt,"f")}static fromReadableStream(e){const t=new $n(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const s=new $n(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){var a;super._createChatCompletion;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),v(this,we,"m",si).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of i)v(this,we,"m",ii).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new Qe;return this._addChatCompletion(v(this,we,"m",Er).call(this))}async _fromReadableStream(e,t){var a;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),v(this,we,"m",si).call(this),this._connected();const s=An.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(v(this,we,"m",Er).call(this)),v(this,we,"m",ii).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new Qe;return this._addChatCompletion(v(this,we,"m",Er).call(this))}[(Ct=new WeakMap,an=new WeakMap,Tt=new WeakMap,we=new WeakSet,si=function(){this.ended||z(this,Tt,void 0)},Mr=function(e){let t=v(this,an,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},v(this,an,"f")[e.index]=t,t)},ii=function(e){var r,s,i,a,o,l,c,u,p,h,d,m,y,f,g;if(this.ended)return;const t=v(this,we,"m",il).call(this,e);this._emit("chunk",e,t);for(const b of e.choices){const _=t.choices[b.index];b.delta.content!=null&&((r=_.message)==null?void 0:r.role)==="assistant"&&((s=_.message)!=null&&s.content)&&(this._emit("content",b.delta.content,_.message.content),this._emit("content.delta",{delta:b.delta.content,snapshot:_.message.content,parsed:_.message.parsed})),b.delta.refusal!=null&&((i=_.message)==null?void 0:i.role)==="assistant"&&((a=_.message)!=null&&a.refusal)&&this._emit("refusal.delta",{delta:b.delta.refusal,snapshot:_.message.refusal}),((o=b.logprobs)==null?void 0:o.content)!=null&&((l=_.message)==null?void 0:l.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(c=b.logprobs)==null?void 0:c.content,snapshot:((u=_.logprobs)==null?void 0:u.content)??[]}),((p=b.logprobs)==null?void 0:p.refusal)!=null&&((h=_.message)==null?void 0:h.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(d=b.logprobs)==null?void 0:d.refusal,snapshot:((m=_.logprobs)==null?void 0:m.refusal)??[]});const M=v(this,we,"m",Mr).call(this,_);_.finish_reason&&(v(this,we,"m",oi).call(this,_),M.current_tool_call_index!=null&&v(this,we,"m",ai).call(this,_,M.current_tool_call_index));for(const S of b.delta.tool_calls??[])M.current_tool_call_index!==S.index&&(v(this,we,"m",oi).call(this,_),M.current_tool_call_index!=null&&v(this,we,"m",ai).call(this,_,M.current_tool_call_index)),M.current_tool_call_index=S.index;for(const S of b.delta.tool_calls??[]){const C=(y=_.message.tool_calls)==null?void 0:y[S.index];C!=null&&C.type&&((C==null?void 0:C.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(f=C.function)==null?void 0:f.name,index:S.index,arguments:C.function.arguments,parsed_arguments:C.function.parsed_arguments,arguments_delta:((g=S.function)==null?void 0:g.arguments)??""}):C==null||C.type)}}},ai=function(e,t){var s,i,a;if(v(this,we,"m",Mr).call(this,e).done_tool_calls.has(t))return;const r=(s=e.message.tool_calls)==null?void 0:s[t];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if(r.type==="function"){const o=(a=(i=v(this,Ct,"f"))==null?void 0:i.tools)==null?void 0:a.find(l=>l.type==="function"&&l.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:t,arguments:r.function.arguments,parsed_arguments:In(o)?o.$parseRaw(r.function.arguments):o!=null&&o.function.strict?JSON.parse(r.function.arguments):null})}else r.type},oi=function(e){var r,s;const t=v(this,we,"m",Mr).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const i=v(this,we,"m",li).call(this);this._emit("content.done",{content:e.message.content,parsed:i?i.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),(r=e.logprobs)!=null&&r.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),(s=e.logprobs)!=null&&s.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Er=function(){if(this.ended)throw new U("stream has ended, this shouldn't happen");const e=v(this,Tt,"f");if(!e)throw new U("request ended without sending any chunks");return z(this,Tt,void 0),z(this,an,[]),Id(e,v(this,Ct,"f"))},li=function(){var t;const e=(t=v(this,Ct,"f"))==null?void 0:t.response_format;return Zs(e)?e:null},il=function(e){var t,r,s,i;let a=v(this,Tt,"f");const{choices:o,...l}=e;a?Object.assign(a,l):a=z(this,Tt,{...l,choices:[]});for(const{delta:c,finish_reason:u,index:p,logprobs:h=null,...d}of e.choices){let m=a.choices[p];if(m||(m=a.choices[p]={finish_reason:u,index:p,message:{},logprobs:h,...d}),h)if(!m.logprobs)m.logprobs=Object.assign({},h);else{const{content:S,refusal:C,...W}=h;Object.assign(m.logprobs,W),S&&((t=m.logprobs).content??(t.content=[]),m.logprobs.content.push(...S)),C&&((r=m.logprobs).refusal??(r.refusal=[]),m.logprobs.refusal.push(...C))}if(u&&(m.finish_reason=u,v(this,Ct,"f")&&Fo(v(this,Ct,"f")))){if(u==="length")throw new ao;if(u==="content_filter")throw new oo}if(Object.assign(m,d),!c)continue;const{content:y,refusal:f,function_call:g,role:b,tool_calls:_,...M}=c;if(Object.assign(m.message,M),f&&(m.message.refusal=(m.message.refusal||"")+f),b&&(m.message.role=b),g&&(m.message.function_call?(g.name&&(m.message.function_call.name=g.name),g.arguments&&((s=m.message.function_call).arguments??(s.arguments=""),m.message.function_call.arguments+=g.arguments)):m.message.function_call=g),y&&(m.message.content=(m.message.content||"")+y,!m.message.refusal&&v(this,we,"m",li).call(this)&&(m.message.parsed=sl(m.message.content))),_){m.message.tool_calls||(m.message.tool_calls=[]);for(const{index:S,id:C,type:W,function:V,...q}of _){const $=(i=m.message.tool_calls)[S]??(i[S]={});Object.assign($,q),C&&($.id=C),W&&($.type=W),V&&($.function??($.function={name:V.name??"",arguments:""})),V!=null&&V.name&&($.function.name=V.name),V!=null&&V.arguments&&($.function.arguments+=V.arguments,Ad(v(this,Ct,"f"),$)&&($.function.parsed_arguments=sl($.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",s=>{const i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(const i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(const i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new An(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Id(n,e){const{id:t,choices:r,created:s,model:i,system_fingerprint:a,...o}=n,l={...o,id:t,choices:r.map(({message:c,finish_reason:u,index:p,logprobs:h,...d})=>{if(!u)throw new U(`missing finish_reason for choice ${p}`);const{content:m=null,function_call:y,tool_calls:f,...g}=c,b=c.role;if(!b)throw new U(`missing role for choice ${p}`);if(y){const{arguments:_,name:M}=y;if(_==null)throw new U(`missing function_call.arguments for choice ${p}`);if(!M)throw new U(`missing function_call.name for choice ${p}`);return{...d,message:{content:m,function_call:{arguments:_,name:M},role:b,refusal:c.refusal??null},finish_reason:u,index:p,logprobs:h}}return f?{...d,index:p,finish_reason:u,logprobs:h,message:{...g,role:b,content:m,refusal:c.refusal??null,tool_calls:f.map((_,M)=>{const{function:S,type:C,id:W,...V}=_,{arguments:q,name:$,...re}=S||{};if(W==null)throw new U(`missing choices[${p}].tool_calls[${M}].id
${Cr(n)}`);if(C==null)throw new U(`missing choices[${p}].tool_calls[${M}].type
${Cr(n)}`);if($==null)throw new U(`missing choices[${p}].tool_calls[${M}].function.name
${Cr(n)}`);if(q==null)throw new U(`missing choices[${p}].tool_calls[${M}].function.arguments
${Cr(n)}`);return{...V,id:W,type:C,function:{...re,name:$,arguments:q}}})}}:{...d,message:{...g,content:m,role:b,refusal:c.refusal??null},finish_reason:u,index:p,logprobs:h}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return Md(l,e)}function Cr(n){return JSON.stringify(n)}class Ar extends $n{static fromReadableStream(e){const t=new Ar(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,r){const s=new Ar(t),i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}}let ci=class extends Q{constructor(){super(...arguments),this.messages=new Bo(this._client)}create(n,e){return this._client.post("/chat/completions",{body:n,...e,stream:n.stream??!1})}retrieve(n,e){return this._client.get(P`/chat/completions/${n}`,e)}update(n,e,t){return this._client.post(P`/chat/completions/${n}`,{body:e,...t})}list(n={},e){return this._client.getAPIList("/chat/completions",ye,{query:n,...e})}delete(n,e){return this._client.delete(P`/chat/completions/${n}`,e)}parse(n,e){return Sd(n.tools),this._client.chat.completions.create(n,{...e,headers:{...e==null?void 0:e.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>Xs(t,n))}runTools(n,e){return n.stream?Ar.runTools(this._client,n,e):ri.runTools(this._client,n,e)}stream(n,e){return $n.createChatCompletion(this._client,n,e)}};ci.Messages=Bo;let ui=class extends Q{constructor(){super(...arguments),this.completions=new ci(this._client)}};ui.Completions=ci;const al=Symbol("brand.privateNullableHeaders");function*$d(n){if(!n)return;if(al in n){const{values:r,nulls:s}=n;yield*r.entries();for(const i of s)yield[i,null];return}let e=!1,t;n instanceof Headers?t=n.entries():lo(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let r of t){const s=r[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");const i=lo(r[1])?r[1]:[r[1]];let a=!1;for(const o of i)o!==void 0&&(e&&!a&&(a=!0,yield[s,null]),yield[s,o])}}const B=n=>{const e=new Headers,t=new Set;for(const r of n){const s=new Set;for(const[i,a]of $d(r)){const o=i.toLowerCase();s.has(o)||(e.delete(i),s.add(o)),a===null?(e.delete(i),t.add(o)):(e.append(i,a),t.delete(o))}}return{[al]:!0,values:e,nulls:t}};let ol=class extends Q{create(n,e){return this._client.post("/audio/speech",{body:n,...e,headers:B([{Accept:"application/octet-stream"},e==null?void 0:e.headers]),__binaryResponse:!0})}},ll=class extends Q{create(n,e){return this._client.post("/audio/transcriptions",Wt({body:n,...e,stream:n.stream??!1,__metadata:{model:n.model}},this._client))}},cl=class extends Q{create(n,e){return this._client.post("/audio/translations",Wt({body:n,...e,__metadata:{model:n.model}},this._client))}},Ln=class extends Q{constructor(){super(...arguments),this.transcriptions=new ll(this._client),this.translations=new cl(this._client),this.speech=new ol(this._client)}};Ln.Transcriptions=ll,Ln.Translations=cl,Ln.Speech=ol;let ul=class extends Q{create(n,e){return this._client.post("/batches",{body:n,...e})}retrieve(n,e){return this._client.get(P`/batches/${n}`,e)}list(n={},e){return this._client.getAPIList("/batches",ye,{query:n,...e})}cancel(n,e){return this._client.post(P`/batches/${n}/cancel`,e)}};class pl extends Q{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(P`/assistants/${e}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,r){return this._client.post(P`/assistants/${e}`,{body:t,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},t){return this._client.getAPIList("/assistants",ye,{query:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(P`/assistants/${e}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class hl extends Q{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class dl extends Q{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}class Sr extends Q{constructor(){super(...arguments),this.sessions=new hl(this._client),this.transcriptionSessions=new dl(this._client)}}Sr.Sessions=hl,Sr.TranscriptionSessions=dl;class ml extends Q{create(e,t,r){return this._client.post(P`/threads/${e}/messages`,{body:t,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,t,r){const{thread_id:s}=t;return this._client.get(P`/threads/${s}/messages/${e}`,{...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,t,r){const{thread_id:s,...i}=t;return this._client.post(P`/threads/${s}/messages/${e}`,{body:i,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,t={},r){return this._client.getAPIList(P`/threads/${e}/messages`,ye,{query:t,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,t,r){const{thread_id:s}=t;return this._client.delete(P`/threads/${s}/messages/${e}`,{...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}class fl extends Q{retrieve(e,t,r){const{thread_id:s,run_id:i,...a}=t;return this._client.get(P`/threads/${s}/runs/${i}/steps/${e}`,{query:a,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,t,r){const{thread_id:s,...i}=t;return this._client.getAPIList(P`/threads/${s}/runs/${e}/steps`,ye,{query:i,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}const Ld=n=>{if(typeof ze<"u"){const e=ze.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(n),t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return Array.from(new Float32Array(r.buffer))}};var pi={};const on=n=>{var e,t,r,s;if(typeof globalThis.process<"u")return((e=pi==null?void 0:pi[n])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(s=(r=(t=globalThis.Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:s.trim()};var ke,Vt,hi,yt,Pr,rt,zt,ln,Qt,kr,He,Tr,Rr,Bn,qn,Dn,yl,gl,bl,wl,_l,vl,xl;class Fn extends Gs{constructor(){super(...arguments),ke.add(this),hi.set(this,[]),yt.set(this,{}),Pr.set(this,{}),rt.set(this,void 0),zt.set(this,void 0),ln.set(this,void 0),Qt.set(this,void 0),kr.set(this,void 0),He.set(this,void 0),Tr.set(this,void 0),Rr.set(this,void 0),Bn.set(this,void 0)}[(hi=new WeakMap,yt=new WeakMap,Pr=new WeakMap,rt=new WeakMap,zt=new WeakMap,ln=new WeakMap,Qt=new WeakMap,kr=new WeakMap,He=new WeakMap,Tr=new WeakMap,Rr=new WeakMap,Bn=new WeakMap,ke=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",s=>{const i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(const i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(const i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Vt;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var i;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=An.fromReadableStream(e,this.controller);for await(const a of s)v(this,ke,"m",qn).call(this,a);if((i=s.controller.signal)!=null&&i.aborted)throw new Qe;return this._addRun(v(this,ke,"m",Dn).call(this))}toReadableStream(){return new An(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,s){const i=new Vt;return i._run(()=>i._runToolAssistantStream(e,t,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,s){var l;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...r,stream:!0},o=await e.submitToolOutputs(t,a,{...s,signal:this.controller.signal});this._connected();for await(const c of o)v(this,ke,"m",qn).call(this,c);if((l=o.controller.signal)!=null&&l.aborted)throw new Qe;return this._addRun(v(this,ke,"m",Dn).call(this))}static createThreadAssistantStream(e,t,r){const s=new Vt;return s._run(()=>s._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,r,s){const i=new Vt;return i._run(()=>i._runAssistantStream(e,t,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return v(this,Tr,"f")}currentRun(){return v(this,Rr,"f")}currentMessageSnapshot(){return v(this,rt,"f")}currentRunStepSnapshot(){return v(this,Bn,"f")}async finalRunSteps(){return await this.done(),Object.values(v(this,yt,"f"))}async finalMessages(){return await this.done(),Object.values(v(this,Pr,"f"))}async finalRun(){if(await this.done(),!v(this,zt,"f"))throw Error("Final run was not received.");return v(this,zt,"f")}async _createThreadAssistantStream(e,t,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...t,stream:!0},a=await e.createAndRun(i,{...r,signal:this.controller.signal});this._connected();for await(const l of a)v(this,ke,"m",qn).call(this,l);if((o=a.controller.signal)!=null&&o.aborted)throw new Qe;return this._addRun(v(this,ke,"m",Dn).call(this))}async _createAssistantStream(e,t,r,s){var l;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...r,stream:!0},o=await e.create(t,a,{...s,signal:this.controller.signal});this._connected();for await(const c of o)v(this,ke,"m",qn).call(this,c);if((l=o.controller.signal)!=null&&l.aborted)throw new Qe;return this._addRun(v(this,ke,"m",Dn).call(this))}static accumulateDelta(e,t){for(const[r,s]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let i=e[r];if(i==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(Us(i)&&Us(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(const a of s){if(!Us(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const l=i[o];l==null?i.push(a):i[o]=this.accumulateDelta(l,a)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${i}`);e[r]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,s){return await this._createAssistantStream(t,e,r,s)}async _runToolAssistantStream(e,t,r,s){return await this._createToolAssistantStream(t,e,r,s)}}Vt=Fn,qn=function(n){if(!this.ended)switch(z(this,Tr,n),v(this,ke,"m",bl).call(this,n),n.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":v(this,ke,"m",xl).call(this,n);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":v(this,ke,"m",gl).call(this,n);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":v(this,ke,"m",yl).call(this,n);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Dn=function(){if(this.ended)throw new U("stream has ended, this shouldn't happen");if(!v(this,zt,"f"))throw Error("Final run has not been received");return v(this,zt,"f")},yl=function(n){const[e,t]=v(this,ke,"m",_l).call(this,n,v(this,rt,"f"));z(this,rt,e),v(this,Pr,"f")[e.id]=e;for(const r of t){const s=e.content[r.index];(s==null?void 0:s.type)=="text"&&this._emit("textCreated",s.text)}switch(n.event){case"thread.message.created":this._emit("messageCreated",n.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",n.data.delta,e),n.data.delta.content)for(const r of n.data.delta.content){if(r.type=="text"&&r.text){let s=r.text,i=e.content[r.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=v(this,ln,"f")){if(v(this,Qt,"f"))switch(v(this,Qt,"f").type){case"text":this._emit("textDone",v(this,Qt,"f").text,v(this,rt,"f"));break;case"image_file":this._emit("imageFileDone",v(this,Qt,"f").image_file,v(this,rt,"f"));break}z(this,ln,r.index)}z(this,Qt,e.content[r.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(v(this,ln,"f")!==void 0){const r=n.data.content[v(this,ln,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,v(this,rt,"f"));break;case"text":this._emit("textDone",r.text,v(this,rt,"f"));break}}v(this,rt,"f")&&this._emit("messageDone",n.data),z(this,rt,void 0)}},gl=function(n){const e=v(this,ke,"m",wl).call(this,n);switch(z(this,Bn,e),n.event){case"thread.run.step.created":this._emit("runStepCreated",n.data);break;case"thread.run.step.delta":const t=n.data.delta;if(t.step_details&&t.step_details.type=="tool_calls"&&t.step_details.tool_calls&&e.step_details.type=="tool_calls")for(const r of t.step_details.tool_calls)r.index==v(this,kr,"f")?this._emit("toolCallDelta",r,e.step_details.tool_calls[r.index]):(v(this,He,"f")&&this._emit("toolCallDone",v(this,He,"f")),z(this,kr,r.index),z(this,He,e.step_details.tool_calls[r.index]),v(this,He,"f")&&this._emit("toolCallCreated",v(this,He,"f")));this._emit("runStepDelta",n.data.delta,e);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":z(this,Bn,void 0),n.data.step_details.type=="tool_calls"&&v(this,He,"f")&&(this._emit("toolCallDone",v(this,He,"f")),z(this,He,void 0)),this._emit("runStepDone",n.data,e);break}},bl=function(n){v(this,hi,"f").push(n),this._emit("event",n)},wl=function(n){switch(n.event){case"thread.run.step.created":return v(this,yt,"f")[n.data.id]=n.data,n.data;case"thread.run.step.delta":let e=v(this,yt,"f")[n.data.id];if(!e)throw Error("Received a RunStepDelta before creation of a snapshot");let t=n.data;if(t.delta){const r=Vt.accumulateDelta(e,t.delta);v(this,yt,"f")[n.data.id]=r}return v(this,yt,"f")[n.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":v(this,yt,"f")[n.data.id]=n.data;break}if(v(this,yt,"f")[n.data.id])return v(this,yt,"f")[n.data.id];throw new Error("No snapshot available")},_l=function(n,e){let t=[];switch(n.event){case"thread.message.created":return[n.data,t];case"thread.message.delta":if(!e)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=n.data;if(r.delta.content)for(const s of r.delta.content)if(s.index in e.content){let i=e.content[s.index];e.content[s.index]=v(this,ke,"m",vl).call(this,s,i)}else e.content[s.index]=s,t.push(s);return[e,t];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(e)return[e,t];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},vl=function(n,e){return Vt.accumulateDelta(e,n)},xl=function(n){switch(z(this,Rr,n.data),n.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":z(this,zt,n.data),v(this,He,"f")&&(this._emit("toolCallDone",v(this,He,"f")),z(this,He,void 0));break}};let di=class extends Q{constructor(){super(...arguments),this.steps=new fl(this._client)}create(n,e,t){const{include:r,...s}=e;return this._client.post(P`/threads/${n}/runs`,{query:{include:r},body:s,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}retrieve(n,e,t){const{thread_id:r}=e;return this._client.get(P`/threads/${r}/runs/${n}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(n,e,t){const{thread_id:r,...s}=e;return this._client.post(P`/threads/${r}/runs/${n}`,{body:s,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}list(n,e={},t){return this._client.getAPIList(P`/threads/${n}/runs`,ye,{query:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}cancel(n,e,t){const{thread_id:r}=e;return this._client.post(P`/threads/${r}/runs/${n}/cancel`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}async createAndPoll(n,e,t){const r=await this.create(n,e,t);return await this.poll(r.id,{thread_id:n},t)}createAndStream(n,e,t){return Fn.createAssistantStream(n,this._client.beta.threads.runs,e,t)}async poll(n,e,t){var s;const r=B([t==null?void 0:t.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((s=t==null?void 0:t.pollIntervalMs)==null?void 0:s.toString())??void 0}]);for(;;){const{data:i,response:a}=await this.retrieve(n,e,{...t,headers:{...t==null?void 0:t.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(t!=null&&t.pollIntervalMs)o=t.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await Cn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(n,e,t){return Fn.createAssistantStream(n,this._client.beta.threads.runs,e,t)}submitToolOutputs(n,e,t){const{thread_id:r,...s}=e;return this._client.post(P`/threads/${r}/runs/${n}/submit_tool_outputs`,{body:s,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async submitToolOutputsAndPoll(n,e,t){const r=await this.submitToolOutputs(n,e,t);return await this.poll(r.id,e,t)}submitToolOutputsStream(n,e,t){return Fn.createToolAssistantStream(n,this._client.beta.threads.runs,e,t)}};di.Steps=fl;class Nr extends Q{constructor(){super(...arguments),this.runs=new di(this._client),this.messages=new ml(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(P`/threads/${e}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,r){return this._client.post(P`/threads/${e}`,{body:t,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,t){return this._client.delete(P`/threads/${e}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const r=await this.createAndRun(e,t);return await this.runs.poll(r.id,{thread_id:r.thread_id},t)}createAndRunStream(e,t){return Fn.createThreadAssistantStream(e,this._client.beta.threads,t)}}Nr.Runs=di,Nr.Messages=ml;class Un extends Q{constructor(){super(...arguments),this.realtime=new Sr(this._client),this.assistants=new pl(this._client),this.threads=new Nr(this._client)}}Un.Realtime=Sr,Un.Assistants=pl,Un.Threads=Nr;let Ol=class extends Q{create(n,e){return this._client.post("/completions",{body:n,...e,stream:n.stream??!1})}};class Ml extends Q{retrieve(e,t,r){const{container_id:s}=t;return this._client.get(P`/containers/${s}/files/${e}/content`,{...r,headers:B([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}}let mi=class extends Q{constructor(){super(...arguments),this.content=new Ml(this._client)}create(n,e,t){return this._client.post(P`/containers/${n}/files`,Wt({body:e,...t},this._client))}retrieve(n,e,t){const{container_id:r}=e;return this._client.get(P`/containers/${r}/files/${n}`,t)}list(n,e={},t){return this._client.getAPIList(P`/containers/${n}/files`,ye,{query:e,...t})}delete(n,e,t){const{container_id:r}=e;return this._client.delete(P`/containers/${r}/files/${n}`,{...t,headers:B([{Accept:"*/*"},t==null?void 0:t.headers])})}};mi.Content=Ml;class fi extends Q{constructor(){super(...arguments),this.files=new mi(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(P`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",ye,{query:e,...t})}delete(e,t){return this._client.delete(P`/containers/${e}`,{...t,headers:B([{Accept:"*/*"},t==null?void 0:t.headers])})}}fi.Files=mi;let El=class extends Q{create(n,e){const t=!!n.encoding_format;let r=t?n.encoding_format:"base64";t&&Ne(this._client).debug("embeddings/user defined encoding_format:",n.encoding_format);const s=this._client.post("/embeddings",{body:{...n,encoding_format:r},...e});return t?s:(Ne(this._client).debug("embeddings/decoding base64 embeddings from base64"),s._thenUnwrap(i=>(i&&i.data&&i.data.forEach(a=>{const o=a.embedding;a.embedding=Ld(o)}),i)))}};class Cl extends Q{retrieve(e,t,r){const{eval_id:s,run_id:i}=t;return this._client.get(P`/evals/${s}/runs/${i}/output_items/${e}`,r)}list(e,t,r){const{eval_id:s,...i}=t;return this._client.getAPIList(P`/evals/${s}/runs/${e}/output_items`,ye,{query:i,...r})}}class yi extends Q{constructor(){super(...arguments),this.outputItems=new Cl(this._client)}create(e,t,r){return this._client.post(P`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){const{eval_id:s}=t;return this._client.get(P`/evals/${s}/runs/${e}`,r)}list(e,t={},r){return this._client.getAPIList(P`/evals/${e}/runs`,ye,{query:t,...r})}delete(e,t,r){const{eval_id:s}=t;return this._client.delete(P`/evals/${s}/runs/${e}`,r)}cancel(e,t,r){const{eval_id:s}=t;return this._client.post(P`/evals/${s}/runs/${e}`,r)}}yi.OutputItems=Cl;class gi extends Q{constructor(){super(...arguments),this.runs=new yi(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(P`/evals/${e}`,t)}update(e,t,r){return this._client.post(P`/evals/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/evals",ye,{query:e,...t})}delete(e,t){return this._client.delete(P`/evals/${e}`,t)}}gi.Runs=yi;let Al=class extends Q{create(n,e){return this._client.post("/files",Wt({body:n,...e},this._client))}retrieve(n,e){return this._client.get(P`/files/${n}`,e)}list(n={},e){return this._client.getAPIList("/files",ye,{query:n,...e})}delete(n,e){return this._client.delete(P`/files/${n}`,e)}content(n,e){return this._client.get(P`/files/${n}/content`,{...e,headers:B([{Accept:"application/binary"},e==null?void 0:e.headers]),__binaryResponse:!0})}async waitForProcessing(n,{pollInterval:e=5e3,maxWait:t=30*60*1e3}={}){const r=new Set(["processed","error","deleted"]),s=Date.now();let i=await this.retrieve(n);for(;!i.status||!r.has(i.status);)if(await Cn(e),i=await this.retrieve(n),Date.now()-s>t)throw new ur({message:`Giving up on waiting for file ${n} to finish processing after ${t} milliseconds.`});return i}};class Sl extends Q{}let Pl=class extends Q{run(n,e){return this._client.post("/fine_tuning/alpha/graders/run",{body:n,...e})}validate(n,e){return this._client.post("/fine_tuning/alpha/graders/validate",{body:n,...e})}};class bi extends Q{constructor(){super(...arguments),this.graders=new Pl(this._client)}}bi.Graders=Pl;class kl extends Q{create(e,t,r){return this._client.getAPIList(P`/fine_tuning/checkpoints/${e}/permissions`,fr,{body:t,method:"post",...r})}retrieve(e,t={},r){return this._client.get(P`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}delete(e,t,r){const{fine_tuned_model_checkpoint:s}=t;return this._client.delete(P`/fine_tuning/checkpoints/${s}/permissions/${e}`,r)}}let wi=class extends Q{constructor(){super(...arguments),this.permissions=new kl(this._client)}};wi.Permissions=kl;class Tl extends Q{list(e,t={},r){return this._client.getAPIList(P`/fine_tuning/jobs/${e}/checkpoints`,ye,{query:t,...r})}}class _i extends Q{constructor(){super(...arguments),this.checkpoints=new Tl(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(P`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",ye,{query:e,...t})}cancel(e,t){return this._client.post(P`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return this._client.getAPIList(P`/fine_tuning/jobs/${e}/events`,ye,{query:t,...r})}pause(e,t){return this._client.post(P`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(P`/fine_tuning/jobs/${e}/resume`,t)}}_i.Checkpoints=Tl;class cn extends Q{constructor(){super(...arguments),this.methods=new Sl(this._client),this.jobs=new _i(this._client),this.checkpoints=new wi(this._client),this.alpha=new bi(this._client)}}cn.Methods=Sl,cn.Jobs=_i,cn.Checkpoints=wi,cn.Alpha=bi;class Rl extends Q{}class vi extends Q{constructor(){super(...arguments),this.graderModels=new Rl(this._client)}}vi.GraderModels=Rl;class Nl extends Q{createVariation(e,t){return this._client.post("/images/variations",Wt({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",Wt({body:e,...t},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}let jl=class extends Q{retrieve(n,e){return this._client.get(P`/models/${n}`,e)}list(n){return this._client.getAPIList("/models",fr,n)}delete(n,e){return this._client.delete(P`/models/${n}`,e)}};class Il extends Q{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function Bd(n,e){return!e||!Dd(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(r=>({...r,parsed:null}))}:t)}:$l(n,e)}function $l(n,e){const t=n.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:Wd(e,s)};if(s.type==="message"){const i=s.content.map(a=>a.type==="output_text"?{...a,parsed:qd(e,a.text)}:a);return{...s,content:i}}return s}),r=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||xi(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const s of r.output)if(s.type==="message"){for(const i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),r}function qd(n,e){var t,r,s,i;return((r=(t=n.text)==null?void 0:t.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((s=n.text)==null?void 0:s.format)?((i=n.text)==null?void 0:i.format).$parseRaw(e):JSON.parse(e)}function Dd(n){var e;return!!Zs((e=n.text)==null?void 0:e.format)}function Fd(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Ud(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function Wd(n,e){const t=Ud(n.tools??[],e.name);return{...e,...e,parsed_arguments:Fd(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function xi(n){const e=[];for(const t of n.output)if(t.type==="message")for(const r of t.content)r.type==="output_text"&&e.push(r.text);n.output_text=e.join("")}var un,jr,Rt,Ir,Ll,Bl,ql,Dl;class Oi extends Gs{constructor(e){super(),un.add(this),jr.set(this,void 0),Rt.set(this,void 0),Ir.set(this,void 0),z(this,jr,e)}static createResponse(e,t,r){const s=new Oi(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,r){var o;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),v(this,un,"m",Ll).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(const l of i)v(this,un,"m",Bl).call(this,l,a);if((o=i.controller.signal)!=null&&o.aborted)throw new Qe;return v(this,un,"m",ql).call(this)}[(jr=new WeakMap,Rt=new WeakMap,Ir=new WeakMap,un=new WeakSet,Ll=function(){this.ended||z(this,Rt,void 0)},Bl=function(e,t){if(this.ended)return;const r=(i,a)=>{(t==null||a.sequence_number>t)&&this._emit(i,a)},s=v(this,un,"m",Dl).call(this,e);switch(r("event",e),e.type){case"response.output_text.delta":{const i=s.output[e.output_index];if(!i)throw new U(`missing output at index ${e.output_index}`);if(i.type==="message"){const a=i.content[e.content_index];if(!a)throw new U(`missing content at index ${e.content_index}`);if(a.type!=="output_text")throw new U(`expected content to be 'output_text', got ${a.type}`);r("response.output_text.delta",{...e,snapshot:a.text})}break}case"response.function_call_arguments.delta":{const i=s.output[e.output_index];if(!i)throw new U(`missing output at index ${e.output_index}`);i.type==="function_call"&&r("response.function_call_arguments.delta",{...e,snapshot:i.arguments});break}default:r(e.type,e);break}},ql=function(){if(this.ended)throw new U("stream has ended, this shouldn't happen");const e=v(this,Rt,"f");if(!e)throw new U("request ended without sending any events");z(this,Rt,void 0);const t=Vd(e,v(this,jr,"f"));return z(this,Ir,t),t},Dl=function(e){let t=v(this,Rt,"f");if(!t){if(e.type!=="response.created")throw new U(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=z(this,Rt,e.response),t}switch(e.type){case"response.output_item.added":{t.output.push(e.item);break}case"response.content_part.added":{const r=t.output[e.output_index];if(!r)throw new U(`missing output at index ${e.output_index}`);r.type==="message"&&r.content.push(e.part);break}case"response.output_text.delta":{const r=t.output[e.output_index];if(!r)throw new U(`missing output at index ${e.output_index}`);if(r.type==="message"){const s=r.content[e.content_index];if(!s)throw new U(`missing content at index ${e.content_index}`);if(s.type!=="output_text")throw new U(`expected content to be 'output_text', got ${s.type}`);s.text+=e.delta}break}case"response.function_call_arguments.delta":{const r=t.output[e.output_index];if(!r)throw new U(`missing output at index ${e.output_index}`);r.type==="function_call"&&(r.arguments+=e.delta);break}case"response.completed":{z(this,Rt,e.response);break}}return t},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",s=>{const i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(const i of t)i.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(const i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=v(this,Ir,"f");if(!e)throw new U("stream ended without producing a ChatCompletion");return e}}function Vd(n,e){return Bd(n,e)}class Fl extends Q{list(e,t={},r){return this._client.getAPIList(P`/responses/${e}/input_items`,ye,{query:t,...r})}}class Mi extends Q{constructor(){super(...arguments),this.inputItems=new Fl(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&xi(r),r))}retrieve(e,t={},r){return this._client.get(P`/responses/${e}`,{query:t,...r,stream:(t==null?void 0:t.stream)??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&xi(s),s))}delete(e,t){return this._client.delete(P`/responses/${e}`,{...t,headers:B([{Accept:"*/*"},t==null?void 0:t.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(r=>$l(r,e))}stream(e,t){return Oi.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(P`/responses/${e}/cancel`,t)}}Mi.InputItems=Fl;class Ul extends Q{create(e,t,r){return this._client.post(P`/uploads/${e}/parts`,Wt({body:t,...r},this._client))}}class Ei extends Q{constructor(){super(...arguments),this.parts=new Ul(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(P`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(P`/uploads/${e}/complete`,{body:t,...r})}}Ei.Parts=Ul;const zd=async n=>{const e=await Promise.allSettled(n),t=e.filter(s=>s.status==="rejected");if(t.length){for(const s of t)console.error(s.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const r=[];for(const s of e)s.status==="fulfilled"&&r.push(s.value);return r};class Wl extends Q{create(e,t,r){return this._client.post(P`/vector_stores/${e}/file_batches`,{body:t,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,t,r){const{vector_store_id:s}=t;return this._client.get(P`/vector_stores/${s}/file_batches/${e}`,{...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,t,r){const{vector_store_id:s}=t;return this._client.post(P`/vector_stores/${s}/file_batches/${e}/cancel`,{...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,t,r){const s=await this.create(e,t);return await this.poll(e,s.id,r)}listFiles(e,t,r){const{vector_store_id:s,...i}=t;return this._client.getAPIList(P`/vector_stores/${s}/file_batches/${e}/files`,ye,{query:i,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async poll(e,t,r){var i;const s=B([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())??void 0}]);for(;;){const{data:a,response:o}=await this.retrieve(t,{vector_store_id:e},{...r,headers:s}).withResponse();switch(a.status){case"in_progress":let l=5e3;if(r!=null&&r.pollIntervalMs)l=r.pollIntervalMs;else{const c=o.headers.get("openai-poll-after-ms");if(c){const u=parseInt(c);isNaN(u)||(l=u)}}await Cn(l);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},s){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=(s==null?void 0:s.maxConcurrency)??5,a=Math.min(i,t.length),o=this._client,l=t.values(),c=[...r];async function u(h){for(let d of h){const m=await o.files.create({file:d,purpose:"assistants"},s);c.push(m.id)}}const p=Array(a).fill(l).map(u);return await zd(p),await this.createAndPoll(e,{file_ids:c})}}let Vl=class extends Q{create(n,e,t){return this._client.post(P`/vector_stores/${n}/files`,{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(n,e,t){const{vector_store_id:r}=e;return this._client.get(P`/vector_stores/${r}/files/${n}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(n,e,t){const{vector_store_id:r,...s}=e;return this._client.post(P`/vector_stores/${r}/files/${n}`,{body:s,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}list(n,e={},t){return this._client.getAPIList(P`/vector_stores/${n}/files`,ye,{query:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(n,e,t){const{vector_store_id:r}=e;return this._client.delete(P`/vector_stores/${r}/files/${n}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}async createAndPoll(n,e,t){const r=await this.create(n,e,t);return await this.poll(n,r.id,t)}async poll(n,e,t){var s;const r=B([t==null?void 0:t.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((s=t==null?void 0:t.pollIntervalMs)==null?void 0:s.toString())??void 0}]);for(;;){const i=await this.retrieve(e,{vector_store_id:n},{...t,headers:r}).withResponse(),a=i.data;switch(a.status){case"in_progress":let o=5e3;if(t!=null&&t.pollIntervalMs)o=t.pollIntervalMs;else{const l=i.response.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await Cn(o);break;case"failed":case"completed":return a}}}async upload(n,e,t){const r=await this._client.files.create({file:e,purpose:"assistants"},t);return this.create(n,{file_id:r.id},t)}async uploadAndPoll(n,e,t){const r=await this.upload(n,e,t);return await this.poll(n,r.id,t)}content(n,e,t){const{vector_store_id:r}=e;return this._client.getAPIList(P`/vector_stores/${r}/files/${n}/content`,fr,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};class $r extends Q{constructor(){super(...arguments),this.files=new Vl(this._client),this.fileBatches=new Wl(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(P`/vector_stores/${e}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,r){return this._client.post(P`/vector_stores/${e}`,{body:t,...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",ye,{query:e,...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(P`/vector_stores/${e}`,{...t,headers:B([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}search(e,t,r){return this._client.getAPIList(P`/vector_stores/${e}/search`,fr,{body:t,method:"post",...r,headers:B([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}}$r.Files=Vl,$r.FileBatches=Wl;var pn,zl,Lr;class Ql extends Q{constructor(){super(...arguments),pn.add(this)}async unwrap(e,t,r=this._client.webhookSecret,s=300){return await this.verifySignature(e,t,r,s),JSON.parse(e)}async verifySignature(e,t,r=this._client.webhookSecret,s=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");v(this,pn,"m",zl).call(this,r);const i=B([t]).values,a=v(this,pn,"m",Lr).call(this,i,"webhook-signature"),o=v(this,pn,"m",Lr).call(this,i,"webhook-timestamp"),l=v(this,pn,"m",Lr).call(this,i,"webhook-id"),c=parseInt(o,10);if(isNaN(c))throw new En("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-c>s)throw new En("Webhook timestamp is too old");if(c>u+s)throw new En("Webhook timestamp is too new");const p=a.split(" ").map(y=>y.startsWith("v1,")?y.substring(3):y),h=r.startsWith("whsec_")?ze.from(r.replace("whsec_",""),"base64"):ze.from(r,"utf-8"),d=l?`${l}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",h,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const y of p)try{const f=ze.from(y,"base64");if(await crypto.subtle.verify("HMAC",m,f,new TextEncoder().encode(d)))return}catch{continue}throw new En("The given webhook signature does not match the expected signature")}}pn=new WeakSet,zl=function(n){if(typeof n!="string"||n.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Lr=function(n,e){if(!n)throw new Error("Headers are required");const t=n.get(e);if(t==null)throw new Error(`Missing required header: ${e}`);return t};var Ci,Ai,Br,Kl;Z=class{constructor({baseURL:n=on("OPENAI_BASE_URL"),apiKey:e=on("OPENAI_API_KEY"),organization:t=on("OPENAI_ORG_ID")??null,project:r=on("OPENAI_PROJECT_ID")??null,webhookSecret:s=on("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(Ci.add(this),Br.set(this,void 0),this.completions=new Ol(this),this.chat=new ui(this),this.embeddings=new El(this),this.files=new Al(this),this.images=new Nl(this),this.audio=new Ln(this),this.moderations=new Il(this),this.models=new jl(this),this.fineTuning=new cn(this),this.graders=new vi(this),this.vectorStores=new $r(this),this.webhooks=new Ql(this),this.beta=new Un(this),this.batches=new ul(this),this.uploads=new Ei(this),this.responses=new Mi(this),this.evals=new gi(this),this.containers=new fi(this),e===void 0)throw new U("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:e,organization:t,project:r,webhookSecret:s,...i,baseURL:n||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&zh())throw new U(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=a.baseURL,this.timeout=a.timeout??Ai.DEFAULT_TIMEOUT,this.logger=a.logger??console;const o="warn";this.logLevel=o,this.logLevel=Ao(a.logLevel,"ClientOptions.logLevel",this)??Ao(on("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=a.fetchOptions,this.maxRetries=a.maxRetries??2,this.fetch=a.fetch??Gh(),z(this,Br,Xh),this._options=a,this.apiKey=e,this.organization=t,this.project=r,this.webhookSecret=s}withOptions(n){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...n})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:n,nulls:e}){}authHeaders(n){return B([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(n){return sd(n,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${rn}`}defaultIdempotencyKey(){return`stainless-node-retry-${Za()}`}makeStatusError(n,e,t,r){return qe.generate(n,e,t,r)}buildURL(n,e,t){const r=!v(this,Ci,"m",Kl).call(this)&&t||this.baseURL,s=qh(n)?new URL(n):new URL(r+(r.endsWith("/")&&n.startsWith("/")?n.slice(1):n)),i=this.defaultQuery();return Fh(i)||(e={...i,...e}),typeof e=="object"&&e&&!Array.isArray(e)&&(s.search=this.stringifyQuery(e)),s.toString()}async prepareOptions(n){}async prepareRequest(n,{url:e,options:t}){}get(n,e){return this.methodRequest("get",n,e)}post(n,e){return this.methodRequest("post",n,e)}patch(n,e){return this.methodRequest("patch",n,e)}put(n,e){return this.methodRequest("put",n,e)}delete(n,e){return this.methodRequest("delete",n,e)}methodRequest(n,e,t){return this.request(Promise.resolve(t).then(r=>({method:n,path:e,...r})))}request(n,e=null){return new To(this,this.makeRequest(n,e,void 0))}async makeRequest(n,e,t){var f,g;const r=await n,s=r.maxRetries??this.maxRetries;e==null&&(e=s),await this.prepareOptions(r);const{req:i,url:a,timeout:o}=this.buildRequest(r,{retryCount:s-e});await this.prepareRequest(i,{url:a,options:r});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),c=t===void 0?"":`, retryOf: ${t}`,u=Date.now();if(Ne(this).debug(`[${l}] sending request`,Ut({retryOfRequestLogID:t,method:r.method,url:a,options:r,headers:i.headers})),(f=r.signal)==null?void 0:f.aborted)throw new Qe;const p=new AbortController,h=await this.fetchWithTimeout(a,i,o,p).catch(Fs),d=Date.now();if(h instanceof Error){const b=`retrying, ${e} attempts remaining`;if((g=r.signal)!=null&&g.aborted)throw new Qe;const _=Ds(h)||/timed? ?out/i.test(String(h)+("cause"in h?String(h.cause):""));if(e)return Ne(this).info(`[${l}] connection ${_?"timed out":"failed"} - ${b}`),Ne(this).debug(`[${l}] connection ${_?"timed out":"failed"} (${b})`,Ut({retryOfRequestLogID:t,url:a,durationMs:d-u,message:h.message})),this.retryRequest(r,e,t??l);throw Ne(this).info(`[${l}] connection ${_?"timed out":"failed"} - error; no more retries left`),Ne(this).debug(`[${l}] connection ${_?"timed out":"failed"} (error; no more retries left)`,Ut({retryOfRequestLogID:t,url:a,durationMs:d-u,message:h.message})),_?new ur:new cr({cause:h})}const m=[...h.headers.entries()].filter(([b])=>b==="x-request-id").map(([b,_])=>", "+b+": "+JSON.stringify(_)).join(""),y=`[${l}${c}${m}] ${i.method} ${a} ${h.ok?"succeeded":"failed"} with status ${h.status} in ${d-u}ms`;if(!h.ok){const b=this.shouldRetry(h);if(e&&b){const W=`retrying, ${e} attempts remaining`;return await Zh(h.body),Ne(this).info(`${y} - ${W}`),Ne(this).debug(`[${l}] response error (${W})`,Ut({retryOfRequestLogID:t,url:h.url,status:h.status,headers:h.headers,durationMs:d-u})),this.retryRequest(r,e,t??l,h.headers)}const _=b?"error; no more retries left":"error; not retryable";Ne(this).info(`${y} - ${_}`);const M=await h.text().catch(W=>Fs(W).message),S=Vh(M),C=S?void 0:M;throw Ne(this).debug(`[${l}] response error (${_})`,Ut({retryOfRequestLogID:t,url:h.url,status:h.status,headers:h.headers,message:C,durationMs:Date.now()-u})),this.makeStatusError(h.status,S,C,h.headers)}return Ne(this).info(y),Ne(this).debug(`[${l}] response start`,Ut({retryOfRequestLogID:t,url:h.url,status:h.status,headers:h.headers,durationMs:d-u})),{response:h,options:r,controller:p,requestLogID:l,retryOfRequestLogID:t,startTime:u}}getAPIList(n,e,t){return this.requestAPIList(e,{method:"get",path:n,...t})}requestAPIList(n,e){const t=this.makeRequest(e,null,void 0);return new dd(this,t,n)}async fetchWithTimeout(n,e,t,r){const{signal:s,method:i,...a}=e||{};s&&s.addEventListener("abort",()=>r.abort());const o=setTimeout(()=>r.abort(),t),l=globalThis.ReadableStream&&a.body instanceof globalThis.ReadableStream||typeof a.body=="object"&&a.body!==null&&Symbol.asyncIterator in a.body,c={signal:r.signal,...l?{duplex:"half"}:{},method:"GET",...a};i&&(c.method=i.toUpperCase());try{return await this.fetch.call(void 0,n,c)}finally{clearTimeout(o)}}shouldRetry(n){const e=n.headers.get("x-should-retry");return e==="true"?!0:e==="false"?!1:n.status===408||n.status===409||n.status===429||n.status>=500}async retryRequest(n,e,t,r){let s;const i=r==null?void 0:r.get("retry-after-ms");if(i){const o=parseFloat(i);Number.isNaN(o)||(s=o)}const a=r==null?void 0:r.get("retry-after");if(a&&!s){const o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=n.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(e,o)}return await Cn(s),this.makeRequest(n,e-1,t)}calculateDefaultRetryTimeoutMillis(n,e){const t=e-n,r=Math.min(.5*Math.pow(2,t),8),s=1-Math.random()*.25;return r*s*1e3}buildRequest(n,{retryCount:e=0}={}){const t={...n},{method:r,path:s,query:i,defaultBaseURL:a}=t,o=this.buildURL(s,i,a);"timeout"in t&&Wh("timeout",t.timeout),t.timeout=t.timeout??this.timeout;const{bodyHeaders:l,body:c}=this.buildBody({options:t}),u=this.buildHeaders({options:n,method:r,bodyHeaders:l,retryCount:e});return{req:{method:r,headers:u,...t.signal&&{signal:t.signal},...globalThis.ReadableStream&&c instanceof globalThis.ReadableStream&&{duplex:"half"},...c&&{body:c},...this.fetchOptions??{},...t.fetchOptions??{}},url:o,timeout:t.timeout}}buildHeaders({options:n,method:e,bodyHeaders:t,retryCount:r}){let s={};this.idempotencyHeader&&e!=="get"&&(n.idempotencyKey||(n.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=n.idempotencyKey);const i=B([s,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...n.timeout?{"X-Stainless-Timeout":String(Math.trunc(n.timeout/1e3))}:{},...Hh(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},this.authHeaders(n),this._options.defaultHeaders,t,n.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:n,headers:e}}){if(!n)return{bodyHeaders:void 0,body:void 0};const t=B([e]);return ArrayBuffer.isView(n)||n instanceof ArrayBuffer||n instanceof DataView||typeof n=="string"&&t.values.has("content-type")||n instanceof Blob||n instanceof FormData||n instanceof URLSearchParams||globalThis.ReadableStream&&n instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:n}:typeof n=="object"&&(Symbol.asyncIterator in n||Symbol.iterator in n&&"next"in n&&typeof n.next=="function")?{bodyHeaders:void 0,body:mo(n)}:v(this,Br,"f").call(this,{body:n,headers:t})}},Ai=Z,Br=new WeakMap,Ci=new WeakSet,Kl=function(){return this.baseURL!=="https://api.openai.com/v1"},Z.OpenAI=Ai,Z.DEFAULT_TIMEOUT=6e5,Z.OpenAIError=U,Z.APIError=qe,Z.APIConnectionError=cr,Z.APIConnectionTimeoutError=ur,Z.APIUserAbortError=Qe,Z.NotFoundError=to,Z.ConflictError=no,Z.RateLimitError=so,Z.BadRequestError=Xa,Z.AuthenticationError=Ya,Z.InternalServerError=io,Z.PermissionDeniedError=eo,Z.UnprocessableEntityError=ro,Z.InvalidWebhookSignatureError=En,Z.toFile=wd,Z.Completions=Ol,Z.Chat=ui,Z.Embeddings=El,Z.Files=Al,Z.Images=Nl,Z.Audio=Ln,Z.Moderations=Il,Z.Models=jl,Z.FineTuning=cn,Z.Graders=vi,Z.VectorStores=$r,Z.Webhooks=Ql,Z.Beta=Un,Z.Batches=ul,Z.Uploads=Ei,Z.Responses=Mi,Z.Evals=gi,Z.Containers=fi;function Qd(n,e,t){function r(o,l){var c;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(c=o._zod).traits??(c.traits=new Set),o._zod.traits.add(n),e(o,l);for(const u in a.prototype)u in o||Object.defineProperty(o,u,{value:a.prototype[u].bind(o)});o._zod.constr=a,o._zod.def=l}const s=(t==null?void 0:t.Parent)??Object;class i extends s{}Object.defineProperty(i,"name",{value:n});function a(o){var l;const c=t!=null&&t.Parent?new i:this;r(c,o),(l=c._zod).deferred??(l.deferred=[]);for(const u of c._zod.deferred)u();return c}return Object.defineProperty(a,"init",{value:r}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>{var l,c;return t!=null&&t.Parent&&o instanceof t.Parent?!0:(c=(l=o==null?void 0:o._zod)==null?void 0:l.traits)==null?void 0:c.has(n)}}),Object.defineProperty(a,"name",{value:n}),a}class Kd extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const Jd={};function Hd(n){return Jd}function Gd(n){const e=Object.values(n).filter(t=>typeof t=="number");return Object.entries(n).filter(([t,r])=>e.indexOf(+t)===-1).map(([t,r])=>r)}function Zd(n,e){return typeof e=="bigint"?e.toString():e}const Xd=Error.captureStackTrace?Error.captureStackTrace:(...n)=>{};function qr(n){return typeof n=="string"?n:n==null?void 0:n.message}function Yd(n,e,t){var s,i,a,o,l,c;const r={...n,path:n.path??[]};if(!n.message){const u=qr((a=(i=(s=n.inst)==null?void 0:s._zod.def)==null?void 0:i.error)==null?void 0:a.call(i,n))??qr((o=e==null?void 0:e.error)==null?void 0:o.call(e,n))??qr((l=t.customError)==null?void 0:l.call(t,n))??qr((c=t.localeError)==null?void 0:c.call(t,n))??"Invalid input";r.message=u}return delete r.inst,delete r.continue,e!=null&&e.reportInput||delete r.input,r}const em=(n,e)=>{n.name="$ZodError",Object.defineProperty(n,"_zod",{value:n._zod,enumerable:!1}),Object.defineProperty(n,"issues",{value:e,enumerable:!1}),Object.defineProperty(n,"message",{get(){return JSON.stringify(e,Zd,2)},enumerable:!0})},tm=Qd("$ZodError",em,{Parent:Error}),nm=n=>(e,t,r,s)=>{const i=r?Object.assign(r,{async:!1}):{async:!1},a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise)throw new Kd;if(a.issues.length){const o=new((s==null?void 0:s.Err)??n)(a.issues.map(l=>Yd(l,i,Hd())));throw Xd(o,s==null?void 0:s.callee),o}return a.value},rm=nm(tm);class Jl{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}remove(e){return this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function sm(){return new Jl}const im=sm();class Hl{constructor(e){this.counter=0,this.metadataRegistry=(e==null?void 0:e.metadata)??im,this.target=(e==null?void 0:e.target)??"draft-2020-12",this.unrepresentable=(e==null?void 0:e.unrepresentable)??"throw",this.override=(e==null?void 0:e.override)??(()=>{}),this.io=(e==null?void 0:e.io)??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var u,p,h;var r;const s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,t.schemaPath.includes(e)&&(a.cycle=t.path),a.schema;const o={schema:{},count:1,cycle:void 0};this.seen.set(e,o);const l=(p=(u=e._zod).toJSONSchema)==null?void 0:p.call(u);if(l)o.schema=l;else{const d={...t,schemaPath:[...t.schemaPath,e],path:t.path},m=e._zod.parent;if(m)o.ref=m,this.process(m,d),this.seen.get(m).isParent=!0;else{const y=o.schema;switch(s.type){case"string":{const f=y;f.type="string";const{minimum:g,maximum:b,format:_,patterns:M,contentEncoding:S}=e._zod.bag;if(typeof g=="number"&&(f.minLength=g),typeof b=="number"&&(f.maxLength=b),_&&(f.format=i[_]??_,f.format===""&&delete f.format),S&&(f.contentEncoding=S),M&&M.size>0){const C=[...M];C.length===1?f.pattern=C[0].source:C.length>1&&(o.schema.allOf=[...C.map(W=>({...this.target==="draft-7"?{type:"string"}:{},pattern:W.source}))])}break}case"number":{const f=y,{minimum:g,maximum:b,format:_,multipleOf:M,exclusiveMaximum:S,exclusiveMinimum:C}=e._zod.bag;typeof _=="string"&&_.includes("int")?f.type="integer":f.type="number",typeof C=="number"&&(f.exclusiveMinimum=C),typeof g=="number"&&(f.minimum=g,typeof C=="number"&&(C>=g?delete f.minimum:delete f.exclusiveMinimum)),typeof S=="number"&&(f.exclusiveMaximum=S),typeof b=="number"&&(f.maximum=b,typeof S=="number"&&(S<=b?delete f.maximum:delete f.exclusiveMaximum)),typeof M=="number"&&(f.multipleOf=M);break}case"boolean":{const f=y;f.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"undefined":{const f=y;f.type="null";break}case"null":{y.type="null";break}case"any":break;case"unknown":break;case"never":{y.not={};break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{const f=y,{minimum:g,maximum:b}=e._zod.bag;typeof g=="number"&&(f.minItems=g),typeof b=="number"&&(f.maxItems=b),f.type="array",f.items=this.process(s.element,{...d,path:[...d.path,"items"]});break}case"object":{const f=y;f.type="object",f.properties={};const g=s.shape;for(const M in g)f.properties[M]=this.process(g[M],{...d,path:[...d.path,"properties",M]});const b=new Set(Object.keys(g)),_=new Set([...b].filter(M=>{const S=s.shape[M]._zod;return this.io==="input"?S.optin===void 0:S.optout===void 0}));_.size>0&&(f.required=Array.from(_)),((h=s.catchall)==null?void 0:h._zod.def.type)==="never"?f.additionalProperties=!1:s.catchall?s.catchall&&(f.additionalProperties=this.process(s.catchall,{...d,path:[...d.path,"additionalProperties"]})):this.io==="output"&&(f.additionalProperties=!1);break}case"union":{const f=y;f.anyOf=s.options.map((g,b)=>this.process(g,{...d,path:[...d.path,"anyOf",b]}));break}case"intersection":{const f=y,g=this.process(s.left,{...d,path:[...d.path,"allOf",0]}),b=this.process(s.right,{...d,path:[...d.path,"allOf",1]}),_=S=>"allOf"in S&&Object.keys(S).length===1,M=[..._(g)?g.allOf:[g],..._(b)?b.allOf:[b]];f.allOf=M;break}case"tuple":{const f=y;f.type="array";const g=s.items.map((M,S)=>this.process(M,{...d,path:[...d.path,"prefixItems",S]}));if(this.target==="draft-2020-12"?f.prefixItems=g:f.items=g,s.rest){const M=this.process(s.rest,{...d,path:[...d.path,"items"]});this.target==="draft-2020-12"?f.items=M:f.additionalItems=M}s.rest&&(f.items=this.process(s.rest,{...d,path:[...d.path,"items"]}));const{minimum:b,maximum:_}=e._zod.bag;typeof b=="number"&&(f.minItems=b),typeof _=="number"&&(f.maxItems=_);break}case"record":{const f=y;f.type="object",f.propertyNames=this.process(s.keyType,{...d,path:[...d.path,"propertyNames"]}),f.additionalProperties=this.process(s.valueType,{...d,path:[...d.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{const f=y,g=Gd(s.entries);g.every(b=>typeof b=="number")&&(f.type="number"),g.every(b=>typeof b=="string")&&(f.type="string"),f.enum=g;break}case"literal":{const f=y,g=[];for(const b of s.values)if(b===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof b=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");g.push(Number(b))}else g.push(b);if(g.length!==0)if(g.length===1){const b=g[0];f.type=b===null?"null":typeof b,f.const=b}else g.every(b=>typeof b=="number")&&(f.type="number"),g.every(b=>typeof b=="string")&&(f.type="string"),g.every(b=>typeof b=="boolean")&&(f.type="string"),g.every(b=>b===null)&&(f.type="null"),f.enum=g;break}case"file":{const f=y,g={type:"string",format:"binary",contentEncoding:"binary"},{minimum:b,maximum:_,mime:M}=e._zod.bag;b!==void 0&&(g.minLength=b),_!==void 0&&(g.maxLength=_),M?M.length===1?(g.contentMediaType=M[0],Object.assign(f,g)):f.anyOf=M.map(S=>({...g,contentMediaType:S})):Object.assign(f,g);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{const f=this.process(s.innerType,d);y.anyOf=[f,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,d),o.ref=s.innerType;break}case"success":{const f=y;f.type="boolean";break}case"default":{this.process(s.innerType,d),o.ref=s.innerType,y.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,d),o.ref=s.innerType,this.io==="input"&&(y._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,d),o.ref=s.innerType;let f;try{f=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}y.default=f;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{const f=y,g=e._zod.pattern;if(!g)throw new Error("Pattern not found in template literal");f.type="string",f.pattern=g.source;break}case"pipe":{const f=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(f,d),o.ref=f;break}case"readonly":{this.process(s.innerType,d),o.ref=s.innerType,y.readOnly=!0;break}case"promise":{this.process(s.innerType,d),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,d),o.ref=s.innerType;break}case"lazy":{const f=e._zod.innerType;this.process(f,d),o.ref=f;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(o.schema,c),this.io==="input"&&_e(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((r=o.schema).default??(r.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){var u,p,h,d;const r={cycles:(t==null?void 0:t.cycles)??"ref",reused:(t==null?void 0:t.reused)??"inline",external:(t==null?void 0:t.external)??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=m=>{var b;const y=this.target==="draft-2020-12"?"$defs":"definitions";if(r.external){const _=(b=r.external.registry.get(m[0]))==null?void 0:b.id;if(_)return{ref:r.external.uri(_)};const M=m[1].defId??m[1].schema.id??`schema${this.counter++}`;return m[1].defId=M,{defId:M,ref:`${r.external.uri("__shared")}#/${y}/${M}`}}if(m[1]===s)return{ref:"#"};const f=`#/${y}/`,g=m[1].schema.id??`__schema${this.counter++}`;return{defId:g,ref:f+g}},a=m=>{if(m[1].schema.$ref)return;const y=m[1],{ref:f,defId:g}=i(m);y.def={...y.schema},g&&(y.defId=g);const b=y.schema;for(const _ in b)delete b[_];b.$ref=f};for(const m of this.seen.entries()){const y=m[1];if(e===m[0]){a(m);continue}if(r.external){const f=(u=r.external.registry.get(m[0]))==null?void 0:u.id;if(e!==m[0]&&f){a(m);continue}}if((p=this.metadataRegistry.get(m[0]))!=null&&p.id){a(m);continue}if(y.cycle){if(r.cycles==="throw")throw new Error(`Cycle detected: #/${(h=y.cycle)==null?void 0:h.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`);r.cycles==="ref"&&a(m);continue}if(y.count>1&&r.reused==="ref"){a(m);continue}}const o=(m,y)=>{const f=this.seen.get(m),g=f.def??f.schema,b={...g};if(f.ref===null)return;const _=f.ref;if(f.ref=null,_){o(_,y);const M=this.seen.get(_).schema;M.$ref&&y.target==="draft-7"?(g.allOf=g.allOf??[],g.allOf.push(M)):(Object.assign(g,M),Object.assign(g,b))}f.isParent||this.override({zodSchema:m,jsonSchema:g})};for(const m of[...this.seen.entries()].reverse())o(m[0],{target:this.target});const l={};this.target==="draft-2020-12"?l.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?l.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),Object.assign(l,s.def);const c=((d=r.external)==null?void 0:d.defs)??{};for(const m of this.seen.entries()){const y=m[1];y.def&&y.defId&&(c[y.defId]=y.def)}!r.external&&Object.keys(c).length>0&&(this.target==="draft-2020-12"?l.$defs=c:l.definitions=c);try{return JSON.parse(JSON.stringify(l))}catch{throw new Error("Error converting schema to JSON.")}}}function am(n,e){if(n instanceof Jl){const r=new Hl(e),s={};for(const o of n._idmap.entries()){const[l,c]=o;r.process(c)}const i={},a={registry:n,uri:(e==null?void 0:e.uri)||(o=>o),defs:s};for(const o of n._idmap.entries()){const[l,c]=o;i[l]=r.emit(c,{...e,external:a})}if(Object.keys(s).length>0){const o=r.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}const t=new Hl(e);return t.process(n),t.emit(n,e)}function _e(n,e){const t=e??{seen:new Set};if(t.seen.has(n))return!1;t.seen.add(n);const r=n._zod.def;switch(r.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return _e(r.element,t);case"object":{for(const s in r.shape)if(_e(r.shape[s],t))return!0;return!1}case"union":{for(const s of r.options)if(_e(s,t))return!0;return!1}case"intersection":return _e(r.left,t)||_e(r.right,t);case"tuple":{for(const s of r.items)if(_e(s,t))return!0;return!!(r.rest&&_e(r.rest,t))}case"record":return _e(r.keyType,t)||_e(r.valueType,t);case"map":return _e(r.keyType,t)||_e(r.valueType,t);case"set":return _e(r.valueType,t);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return _e(r.innerType,t);case"lazy":return _e(r.getter(),t);case"default":return _e(r.innerType,t);case"prefault":return _e(r.innerType,t);case"custom":return!1;case"transform":return!0;case"pipe":return _e(r.in,t)||_e(r.out,t);case"success":return!1;case"catch":return!1}throw new Error(`Unknown schema type: ${r.type}`)}var om=typeof window=="object"?window:{},G="0123456789abcdef".split(""),lm=[-2147483648,8388608,32768,128],st=[24,16,8,0],Ee=[];function it(n){n?(Ee[0]=Ee[16]=Ee[1]=Ee[2]=Ee[3]=Ee[4]=Ee[5]=Ee[6]=Ee[7]=Ee[8]=Ee[9]=Ee[10]=Ee[11]=Ee[12]=Ee[13]=Ee[14]=Ee[15]=0,this.blocks=Ee):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}it.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===om.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,s,i=n.length||0,a=this.blocks;r<i;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),e)for(s=this.start;r<i&&s<64;++r)a[s>>2]|=n[r]<<st[s++&3];else for(s=this.start;r<i&&s<64;++r)t=n.charCodeAt(r),t<128?a[s>>2]|=t<<st[s++&3]:t<2048?(a[s>>2]|=(192|t>>6)<<st[s++&3],a[s>>2]|=(128|t&63)<<st[s++&3]):t<55296||t>=57344?(a[s>>2]|=(224|t>>12)<<st[s++&3],a[s>>2]|=(128|t>>6&63)<<st[s++&3],a[s>>2]|=(128|t&63)<<st[s++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),a[s>>2]|=(240|t>>18)<<st[s++&3],a[s>>2]|=(128|t>>12&63)<<st[s++&3],a[s>>2]|=(128|t>>6&63)<<st[s++&3],a[s>>2]|=(128|t&63)<<st[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=a[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},it.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=lm[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}},it.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4,i,a,o,l=this.blocks;for(a=16;a<80;++a)o=l[a-3]^l[a-8]^l[a-14]^l[a-16],l[a]=o<<1|o>>>31;for(a=0;a<20;a+=5)i=e&t|~e&r,o=n<<5|n>>>27,s=o+i+s+1518500249+l[a]<<0,e=e<<30|e>>>2,i=n&e|~n&t,o=s<<5|s>>>27,r=o+i+r+1518500249+l[a+1]<<0,n=n<<30|n>>>2,i=s&n|~s&e,o=r<<5|r>>>27,t=o+i+t+1518500249+l[a+2]<<0,s=s<<30|s>>>2,i=r&s|~r&n,o=t<<5|t>>>27,e=o+i+e+1518500249+l[a+3]<<0,r=r<<30|r>>>2,i=t&r|~t&s,o=e<<5|e>>>27,n=o+i+n+1518500249+l[a+4]<<0,t=t<<30|t>>>2;for(;a<40;a+=5)i=e^t^r,o=n<<5|n>>>27,s=o+i+s+1859775393+l[a]<<0,e=e<<30|e>>>2,i=n^e^t,o=s<<5|s>>>27,r=o+i+r+1859775393+l[a+1]<<0,n=n<<30|n>>>2,i=s^n^e,o=r<<5|r>>>27,t=o+i+t+1859775393+l[a+2]<<0,s=s<<30|s>>>2,i=r^s^n,o=t<<5|t>>>27,e=o+i+e+1859775393+l[a+3]<<0,r=r<<30|r>>>2,i=t^r^s,o=e<<5|e>>>27,n=o+i+n+1859775393+l[a+4]<<0,t=t<<30|t>>>2;for(;a<60;a+=5)i=e&t|e&r|t&r,o=n<<5|n>>>27,s=o+i+s-1894007588+l[a]<<0,e=e<<30|e>>>2,i=n&e|n&t|e&t,o=s<<5|s>>>27,r=o+i+r-1894007588+l[a+1]<<0,n=n<<30|n>>>2,i=s&n|s&e|n&e,o=r<<5|r>>>27,t=o+i+t-1894007588+l[a+2]<<0,s=s<<30|s>>>2,i=r&s|r&n|s&n,o=t<<5|t>>>27,e=o+i+e-1894007588+l[a+3]<<0,r=r<<30|r>>>2,i=t&r|t&s|r&s,o=e<<5|e>>>27,n=o+i+n-1894007588+l[a+4]<<0,t=t<<30|t>>>2;for(;a<80;a+=5)i=e^t^r,o=n<<5|n>>>27,s=o+i+s-899497514+l[a]<<0,e=e<<30|e>>>2,i=n^e^t,o=s<<5|s>>>27,r=o+i+r-899497514+l[a+1]<<0,n=n<<30|n>>>2,i=s^n^e,o=r<<5|r>>>27,t=o+i+t-899497514+l[a+2]<<0,s=s<<30|s>>>2,i=r^s^n,o=t<<5|t>>>27,e=o+i+e-899497514+l[a+3]<<0,r=r<<30|r>>>2,i=t^r^s,o=e<<5|e>>>27,n=o+i+n-899497514+l[a+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0},it.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return G[n>>28&15]+G[n>>24&15]+G[n>>20&15]+G[n>>16&15]+G[n>>12&15]+G[n>>8&15]+G[n>>4&15]+G[n&15]+G[e>>28&15]+G[e>>24&15]+G[e>>20&15]+G[e>>16&15]+G[e>>12&15]+G[e>>8&15]+G[e>>4&15]+G[e&15]+G[t>>28&15]+G[t>>24&15]+G[t>>20&15]+G[t>>16&15]+G[t>>12&15]+G[t>>8&15]+G[t>>4&15]+G[t&15]+G[r>>28&15]+G[r>>24&15]+G[r>>20&15]+G[r>>16&15]+G[r>>12&15]+G[r>>8&15]+G[r>>4&15]+G[r&15]+G[s>>28&15]+G[s>>24&15]+G[s>>20&15]+G[s>>16&15]+G[s>>12&15]+G[s>>8&15]+G[s>>4&15]+G[s&15]},it.prototype.toString=it.prototype.hex,it.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]},it.prototype.array=it.prototype.digest,it.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};let Gl=!1;const cm=n=>(Gl||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","\u2514> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),Gl=!0),new it(!0).update(n).hex()),um=(...n)=>cm(n.join("_"));class pm{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:um})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}const hm=new Map;class Si extends pm{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,r){this.cache.set(this.keyEncoder(e,t),r)}static global(){return new Si(hm)}}const dm=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;function Dr(n){return typeof n!="object"||!n?!1:!!("type"in n&&n.type==="function"&&"function"in n&&typeof n.function=="object"&&n.function&&"name"in n.function&&"parameters"in n.function)}const mm=()=>!1;ea=class extends os{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(n){super(n),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=n.verbose??mm(),this.callbacks=n.callbacks,this.tags=n.tags??[],this.metadata=n.metadata??{}}};class fm extends ea{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:s,...i}=r;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof s=="object"?this.cache=s:s?this.cache=Si.global():this.cache=void 0,this.caller=new gg(r??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let r=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await bg("modelName"in this?dm(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{r=this._encoding.encode(t).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return r}static _convertInputToPromptValue(e){return typeof e=="string"?new ia(e):Array.isArray(e)?new Sh(e.map(Zn)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([s,i])=>i!==void 0).map(([s,i])=>`${s}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Nt extends os{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=sp(t);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,t){const r=sp(t);let s,i=!0;for await(const a of this._transformStreamWithConfig(e,o=>o,r))if(yield a,i)if(s===void 0)s=a;else try{s=ip(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new wg(new _g({steps:e}))}}function Pi(n){const e=[];for(const t of n){let r=t;if(Array.isArray(t.content))for(let s=0;s<t.content.length;s++){const i=t.content[s];(xg(i)||Og(i))&&r===t&&(r=new t.constructor({...r,content:[...t.content.slice(0,s),Mg(i),...t.content.slice(s+1)]}))}e.push(r)}return e}class gt extends fm{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){const r=gt._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){var r;if(this._streamResponseChunks===gt.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const s=gt._convertInputToPromptValue(e).toChatMessages(),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...i.metadata,...this.getLsParams(a)},l=await Gi.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},u=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),[Pi(s)],i.runId,void 0,c,void 0,void 0,i.runName));let p,h;try{for await(const d of this._streamResponseChunks(s,a,u==null?void 0:u[0])){if(d.message.id==null){const m=(r=u==null?void 0:u.at(0))==null?void 0:r.runId;m!=null&&d.message._updateId(`run-${m}`)}d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,p?p=p.concat(d):p=d,ap(d.message)&&d.message.usage_metadata!==void 0&&(h={tokenUsage:{promptTokens:d.message.usage_metadata.input_tokens,completionTokens:d.message.usage_metadata.output_tokens,totalTokens:d.message.usage_metadata.total_tokens}})}}catch(d){throw await Promise.all((u??[]).map(m=>m==null?void 0:m.handleLLMError(d))),d}await Promise.all((u??[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[p]],llmOutput:h})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,s){var u,p;const i=e.map(h=>h.map(Zn));let a;if(s!==void 0&&s.length===i.length)a=s;else{const h={...r.metadata,...this.getLsParams(t)},d=await Gi.configure(r.callbacks,this.callbacks,r.tags,this.tags,h,this.metadata,{verbose:this.verbose}),m={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1};a=await(d==null?void 0:d.handleChatModelStart(this.toJSON(),i.map(Pi),r.runId,void 0,m,void 0,void 0,r.runName))}const o=[],l=[];if(a!=null&&a[0].handlers.find(vg)&&!this.disableStreaming&&i.length===1&&this._streamResponseChunks!==gt.prototype._streamResponseChunks)try{const h=await this._streamResponseChunks(i[0],t,a==null?void 0:a[0]);let d,m;for await(const y of h){if(y.message.id==null){const f=(u=a==null?void 0:a.at(0))==null?void 0:u.runId;f!=null&&y.message._updateId(`run-${f}`)}d===void 0?d=y:d=ip(d,y),ap(y.message)&&y.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:y.message.usage_metadata.input_tokens,completionTokens:y.message.usage_metadata.output_tokens,totalTokens:y.message.usage_metadata.total_tokens}})}if(d===void 0)throw new Error("Received empty response from chat model call.");o.push([d]),await(a==null?void 0:a[0].handleLLMEnd({generations:o,llmOutput:m}))}catch(h){throw await(a==null?void 0:a[0].handleLLMError(h)),h}else{const h=await Promise.allSettled(i.map((d,m)=>this._generate(d,{...t,promptIndex:m},a==null?void 0:a[m])));await Promise.all(h.map(async(d,m)=>{var y,f,g;if(d.status==="fulfilled"){const b=d.value;for(const _ of b.generations){if(_.message.id==null){const M=(y=a==null?void 0:a.at(0))==null?void 0:y.runId;M!=null&&_.message._updateId(`run-${M}`)}_.message.response_metadata={..._.generationInfo,..._.message.response_metadata}}return b.generations.length===1&&(b.generations[0].message.response_metadata={...b.llmOutput,...b.generations[0].message.response_metadata}),o[m]=b.generations,l[m]=b.llmOutput,(f=a==null?void 0:a[m])==null?void 0:f.handleLLMEnd({generations:[b.generations],llmOutput:b.llmOutput})}else return await((g=a==null?void 0:a[m])==null?void 0:g.handleLLMError(d.reason)),Promise.reject(d.reason)}))}const c={generations:o,llmOutput:l.length?(p=this._combineLLMOutput)==null?void 0:p.call(this,...l):void 0};return Object.defineProperty(c,op,{value:a?{runIds:a==null?void 0:a.map(h=>h.runId)}:void 0,configurable:!0}),c}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:s,handledOptions:i}){const a=e.map(y=>y.map(Zn)),o={...i.metadata,...this.getLsParams(s)},l=await Gi.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1},u=await(l==null?void 0:l.handleChatModelStart(this.toJSON(),a.map(Pi),i.runId,void 0,c,void 0,void 0,i.runName)),p=[],h=(await Promise.allSettled(a.map(async(y,f)=>{const g=gt._convertInputToPromptValue(y).toString(),b=await t.lookup(g,r);return b==null&&p.push(f),b}))).map((y,f)=>({result:y,runManager:u==null?void 0:u[f]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),d=[];await Promise.all(h.map(async({result:y,runManager:f},g)=>{if(y.status==="fulfilled"){const b=y.value;return d[g]=b.map(_=>("message"in _&&Zi(_.message)&&qt(_.message)&&(_.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),_.generationInfo={..._.generationInfo,tokenUsage:{}},_)),b.length&&await(f==null?void 0:f.handleLLMNewToken(b[0].text)),f==null?void 0:f.handleLLMEnd({generations:[b]},void 0,void 0,void 0,{cached:!0})}else return await(f==null?void 0:f.handleLLMError(y.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(y.reason)}));const m={generations:d,missingPromptIndices:p,startedRunManagers:u};return Object.defineProperty(m,op,{value:u?{runIds:u==null?void 0:u.map(y=>y.runId)}:void 0,configurable:!0}),m}async generate(e,t,r){let s;Array.isArray(t)?s={stop:t}:s=t;const i=e.map(m=>m.map(Zn)),[a,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(a.callbacks=a.callbacks??r,!this.cache)return this._generateUncached(i,o,a);const{cache:l}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:p,startedRunManagers:h}=await this._generateCached({messages:i,cache:l,llmStringKey:c,parsedOptions:o,handledOptions:a});let d={};if(p.length>0){const m=await this._generateUncached(p.map(y=>i[y]),o,a,h!==void 0?p.map(y=>h==null?void 0:h[y]):void 0);await Promise.all(m.generations.map(async(y,f)=>{const g=p[f];u[g]=y;const b=gt._convertInputToPromptValue(i[g]).toString();return l.update(b,c,y)})),d=m.llmOutput??{}}return{generations:u,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const s=e.map(i=>i.toChatMessages());return this.generate(s,t,r)}async call(e,t,r){return(await this.generate([e.map(Zn)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const s=e.toChatMessages();return this.call(s,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const s=new np(e),i=await this.call([s],t,r);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');const r=e,s=t==null?void 0:t.name,i=lp(r)??"A function available to call.",a=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(a==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let l=s??"extract",c;Ot(r)?c=[{type:"function",function:{name:l,description:i,parameters:St(r)}}]:("name"in r&&(l=r.name),c=[{type:"function",function:{name:l,description:i,parameters:r}}]);const u=this.bindTools(c),p=cp.from(y=>{if(!y.tool_calls||y.tool_calls.length===0)throw new Error("No tool calls found in the response.");const f=y.tool_calls.find(g=>g.name===l);if(!f)throw new Error(`No tool call found with name ${l}.`);return f.args});if(!o)return u.pipe(p).withConfig({runName:"StructuredOutput"});const h=Nt.assign({parsed:(y,f)=>p.invoke(y.raw,f)}),d=Nt.assign({parsed:()=>null}),m=h.withFallbacks({fallbacks:[d]});return ls.from([{raw:u},m]).withConfig({runName:"StructuredOutputRunnable"})}}class Zl extends os{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,s)=>this.parseResult([{text:r}],s==null?void 0:s.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,s)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],s==null?void 0:s.callbacks),e,{...t,runType:"parser"})}}class Xl extends Zl{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class Fr extends Error{constructor(e,t,r,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=s,s&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Eg(this,"OUTPUT_PARSING_FAILURE")}}class ym extends Xl{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Yl extends ym{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(e==null?void 0:e.diff)??this.diff}async*_transform(e){let t,r;for await(const s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(Cg(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new Dt({message:s,text:s.content})}else if(Zi(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new Dt({message:Ag(s),text:s.content})}else i=new Sg({text:s});r===void 0?r=i:r=r.concat(i);const a=await this.parsePartialResult([r]);a!=null&&!er(a,t)&&(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}}class ki extends Xl{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){const t=Pg(Object.fromEntries(Object.entries(e).map(([r,s])=>[r,kg().describe(s)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(St(this.schema))}
\`\`\`
`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(r,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await Tg(this.schema,JSON.parse(t))}catch(t){throw new Fr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class Ur extends Yl{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Mt(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return up(e[0].text)}async parse(e){return up(e,JSON.parse)}getFormatInstructions(){return""}}function Wr(n,e){if(n.function===void 0)return;let t;if(e!=null&&e.partial)try{t=Rg(n.function.arguments??"{}")}catch{return}else try{t=JSON.parse(n.function.arguments)}catch(s){throw new Fr([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}const r={name:n.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(r.id=n.id),r}function ec(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function Ti(n,e){var t,r;return{name:(t=n.function)==null?void 0:t.name,args:(r=n.function)==null?void 0:r.arguments,id:n.id,error:e,type:"invalid_tool_call"}}class gm extends Yl{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(e==null?void 0:e.returnId)??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var a;const r=e[0].message;let s;if(qt(r)&&((a=r.tool_calls)!=null&&a.length)?s=r.tool_calls.map(o=>{const{id:l,...c}=o;return this.returnId?{id:l,...c}:c}):r.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(o=>Wr(o,{returnId:this.returnId,partial:t}))),!s)return[];const i=[];for(const o of s)if(o!==void 0){const l={type:o.name,args:o.args,id:o.id};i.push(l)}return i}}class Vr extends gm{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){var r;if(this.zodSchema===void 0)return e;const t=await pp(this.zodSchema,e);if(t.success)return t.data;throw new Fr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify((r=t.error)==null?void 0:r.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(s=>s.type===this.keyName);let r=t;if(t.length)return this.returnId||(r=t.map(s=>s.args)),this.returnSingle?r[0]:r}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(s=>s.type===this.keyName);let r=t;return t.length?(this.returnId||(r=t.map(s=>s.args)),this.returnSingle?this._validateResult(r[0]):await Promise.all(r.map(s=>this._validateResult(s)))):void 0}}const bm=Symbol("Let zodToJsonSchema decide on which parser to use"),tc={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},wm=n=>typeof n=="string"?{...tc,basePath:["#"],definitions:{},name:n}:{...tc,basePath:["#"],definitions:{},...n},Ri=n=>"_def"in n?n._def:n;function _m(n){if(!n)return!0;for(const e in n)return!1;return!0}const vm=n=>{const e=wm(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[Ri(s),{def:Ri(s),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function nc(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ne(n,e,t,r,s){n[e]=t,nc(n,e,r,s)}var Wn;(function(n){n.assertEqual=s=>{};function e(s){}n.assertIs=e;function t(s){throw new Error}n.assertNever=t,n.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},n.getValidEnumValues=s=>{const i=n.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return n.objectValues(a)},n.objectValues=s=>n.objectKeys(s).map(function(i){return s[i]}),n.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},n.find=(s,i)=>{for(const a of s)if(i(a))return a},n.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function r(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}n.joinValues=r,n.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(Wn||(Wn={}));var rc;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(rc||(rc={})),Wn.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Wn.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class zr extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)r._errors.push(t(a));else{let o=r,l=0;for(;l<a.path.length;){const c=a.path[l];l===a.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(a))):o[c]=o[c]||{_errors:[]},o=o[c],l++}}};return s(this),r}static assert(e){if(!(e instanceof zr))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Wn.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}zr.create=n=>new zr(n);var sc;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(sc||(sc={}));var J;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(J||(J={}));function xm(){return{}}function Om(n,e){var r,s;const t={type:"array"};return((s=(r=n.type)==null?void 0:r._def)==null?void 0:s.typeName)!==J.ZodAny&&(t.items=te(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ne(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ne(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ne(t,"minItems",n.exactLength.value,n.exactLength.message,e),ne(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Mm(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?ne(t,"minimum",r.value,r.message,e):ne(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ne(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ne(t,"maximum",r.value,r.message,e):ne(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ne(t,"maximum",r.value,r.message,e));break;case"multipleOf":ne(t,"multipleOf",r.value,r.message,e);break}return t}function Em(){return{type:"boolean"}}function Cm(n,e){return te(n.type._def,e)}const Am=(n,e)=>te(n.innerType._def,e);function ic(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((s,i)=>ic(n,e,s))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Sm(n,e)}}const Sm=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":ne(t,"minimum",r.value,r.message,e);break;case"max":ne(t,"maximum",r.value,r.message,e);break}return t};function Pm(n,e){return{...te(n.innerType._def,e),default:n.defaultValue()}}function km(n,e,t){return e.effectStrategy==="input"?te(n.schema._def,e,t):{}}function Tm(n){return{type:"string",enum:[...n.values]}}const Rm=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Nm(n,e){const t=[te(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),te(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const s=[];return t.forEach(i=>{if(Rm(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...l}=i;a=l}else r=void 0;s.push(a)}}),s.length?{allOf:s,...r}:void 0}function jm(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Ni;const Kt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ni===void 0&&(Ni=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ni),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function ac(n,e){const t={type:"string"};function r(s){return e.patternStrategy==="escape"?Im(s):s}if(n.checks)for(const s of n.checks)switch(s.kind){case"min":ne(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e);break;case"max":ne(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":at(t,"email",s.message,e);break;case"format:idn-email":at(t,"idn-email",s.message,e);break;case"pattern:zod":ot(t,Kt.email,s.message,e);break}break;case"url":at(t,"uri",s.message,e);break;case"uuid":at(t,"uuid",s.message,e);break;case"regex":ot(t,s.regex,s.message,e);break;case"cuid":ot(t,Kt.cuid,s.message,e);break;case"cuid2":ot(t,Kt.cuid2,s.message,e);break;case"startsWith":ot(t,RegExp(`^${r(s.value)}`),s.message,e);break;case"endsWith":ot(t,RegExp(`${r(s.value)}$`),s.message,e);break;case"datetime":at(t,"date-time",s.message,e);break;case"date":at(t,"date",s.message,e);break;case"time":at(t,"time",s.message,e);break;case"duration":at(t,"duration",s.message,e);break;case"length":ne(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e),ne(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"includes":{ot(t,RegExp(r(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&at(t,"ipv4",s.message,e),s.version!=="v4"&&at(t,"ipv6",s.message,e);break}case"emoji":ot(t,Kt.emoji,s.message,e);break;case"ulid":{ot(t,Kt.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{at(t,"binary",s.message,e);break}case"contentEncoding:base64":{ne(t,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{ot(t,Kt.base64,s.message,e);break}}break}case"nanoid":ot(t,Kt.nanoid,s.message,e)}return t}const Im=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),at=(n,e,t,r)=>{var s;n.format||(s=n.anyOf)!=null&&s.some(i=>i.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):ne(n,"format",e,t,r)},ot=(n,e,t,r)=>{var s;n.pattern||(s=n.allOf)!=null&&s.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:oc(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):ne(n,"pattern",oc(e,r),t,r)},oc=(n,e)=>{var c;const t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;const r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},s=r.i?t.source.toLowerCase():t.source;let i="",a=!1,o=!1,l=!1;for(let u=0;u<s.length;u++){if(a){i+=s[u],a=!1;continue}if(r.i){if(o){if(s[u].match(/[a-z]/)){l?(i+=s[u],i+=`${s[u-2]}-${s[u]}`.toUpperCase(),l=!1):s[u+1]==="-"&&((c=s[u+2])!=null&&c.match(/[a-z]/))?(i+=s[u],l=!0):i+=`${s[u]}${s[u].toUpperCase()}`;continue}}else if(s[u].match(/[a-z]/)){i+=`[${s[u]}${s[u].toUpperCase()}]`;continue}}if(r.m){if(s[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(s[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(r.s&&s[u]==="."){i+=o?`${s[u]}\r
`:`[${s[u]}\r
]`;continue}i+=s[u],s[u]==="\\"?a=!0:o&&s[u]==="]"?o=!1:!o&&s[u]==="["&&(o=!0)}try{const u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i};function lc(n,e){var r,s,i,a;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===J.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((o,l)=>({...o,[l]:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===J.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){const o=Object.entries(ac(n.keyType._def,e)).reduce((l,[c,u])=>c==="type"?l:{...l,[c]:u},{});return{...t,propertyNames:o}}else if(((a=n.keyType)==null?void 0:a._def.typeName)===J.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function $m(n,e){if(e.mapStrategy==="record")return lc(n,e);const t=te(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=te(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Lm(n){const e=n.values,t=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),r=Array.from(new Set(t.map(s=>typeof s)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:t}}function Bm(){return{not:{}}}function qm(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Qr={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Dm(n,e){if(e.target==="openApi3")return cc(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Qr&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((s,i)=>{const a=Qr[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((s,i)=>{const a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===t.length){const s=r.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:t.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,s)=>[...r,...s._def.values.filter(i=>!r.includes(i))],[])};return cc(n,e)}const cc=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,s)=>te(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Fm(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Qr[n.innerType._def.typeName],nullable:!0}:{type:[Qr[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=te(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=te(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Um(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",nc(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?ne(t,"minimum",r.value,r.message,e):ne(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ne(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ne(t,"maximum",r.value,r.message,e):ne(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ne(t,"maximum",r.value,r.message,e));break;case"multipleOf":ne(t,"multipleOf",r.value,r.message,e);break}return t}function Wm(n,e){return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":te(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":te(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Vm(n,e){const t={type:"object",...Object.entries(n.shape()).reduce((r,[s,i])=>{var l;if(i===void 0||i._def===void 0)return r;const a=[...e.currentPath,"properties",s],o=te(i._def,{...e,currentPath:a,propertyPath:a});if(o===void 0)return r;if(e.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&typeof((l=i._def)==null?void 0:l.defaultValue)>"u")throw new Error(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...r.properties,[s]:o},required:i.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,s]}},{properties:{},required:[]}),additionalProperties:Wm(n,e)};return t.required.length||delete t.required,t}const zm=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return te(n.innerType._def,e);const t=te(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Qm=(n,e)=>{if(e.pipeStrategy==="input")return te(n.in._def,e);if(e.pipeStrategy==="output")return te(n.out._def,e);const t=te(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=te(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(s=>s!==void 0)}};function Km(n,e){return te(n.type._def,e)}function Jm(n,e){const t={type:"array",uniqueItems:!0,items:te(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ne(t,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ne(t,"maxItems",n.maxSize.value,n.maxSize.message,e),t}function Hm(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>te(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:te(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>te(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Gm(){return{not:{}}}function Zm(){return{}}const Xm=(n,e)=>te(n.innerType._def,e);function te(n,e,t=!1){var a;const r=e.seen.get(n);if(e.override){const o=(a=e.override)==null?void 0:a.call(e,n,e,r,t);if(o!==bm)return o}if(r&&!t){const o=Ym(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const s={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,s);const i=tf(n,n.typeName,e,t);return i&&nf(n,e,i),s.jsonSchema=i,i}const Ym=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":const t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:ef(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((r,s)=>e.currentPath[s]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},ef=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},tf=(n,e,t,r)=>{switch(e){case J.ZodString:return ac(n,t);case J.ZodNumber:return Um(n,t);case J.ZodObject:return Vm(n,t);case J.ZodBigInt:return Mm(n,t);case J.ZodBoolean:return Em();case J.ZodDate:return ic(n,t);case J.ZodUndefined:return Gm();case J.ZodNull:return qm(t);case J.ZodArray:return Om(n,t);case J.ZodUnion:case J.ZodDiscriminatedUnion:return Dm(n,t);case J.ZodIntersection:return Nm(n,t);case J.ZodTuple:return Hm(n,t);case J.ZodRecord:return lc(n,t);case J.ZodLiteral:return jm(n,t);case J.ZodEnum:return Tm(n);case J.ZodNativeEnum:return Lm(n);case J.ZodNullable:return Fm(n,t);case J.ZodOptional:return zm(n,t);case J.ZodMap:return $m(n,t);case J.ZodSet:return Jm(n,t);case J.ZodLazy:return te(n.getter()._def,t);case J.ZodPromise:return Km(n,t);case J.ZodNaN:case J.ZodNever:return Bm();case J.ZodEffects:return km(n,t,r);case J.ZodAny:return xm();case J.ZodUnknown:return Zm();case J.ZodDefault:return Pm(n,t);case J.ZodBranded:return Cm(n,t);case J.ZodReadonly:return Xm(n,t);case J.ZodCatch:return Am(n,t);case J.ZodPipeline:return Qm(n,t);case J.ZodFunction:case J.ZodVoid:case J.ZodSymbol:return;default:return(s=>{})()}},nf=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),rf=(n,e)=>{const t=vm(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=te(n._def,r===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,r]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);const a=(()=>{if(_m(t.definitions))return;const l={},c=new Set;for(let u=0;u<500;u++){const p=Object.entries(t.definitions).filter(([h])=>!c.has(h));if(p.length===0)break;for(const[h,d]of p)l[h]=te(Ri(d),{...t,currentPath:[...t.basePath,t.definitionPath,h]},!0)??{},c.add(h)}return l})(),o=r===void 0?a?{...s,[t.definitionPath]:a}:s:t.nameStrategy==="duplicate-ref"?{...s,...a||t.seenRefs.size?{[t.definitionPath]:{...a,...t.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,r].join("/"),[t.definitionPath]:{...a,[r]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function sf(n,e){return rf(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function af(n,e,t){return Od({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:sf(n,{name:e})}},r=>n.parse(JSON.parse(r)))}aa=function(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=n;if((r||a)&&s&&e)return`${s}/${e}`;if((r||a)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||a){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i};function of(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function lf(n){return n!==void 0&&os.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function cf(n){return!!n&&typeof n=="object"&&"name"in n&&"schema"in n&&(Ot(n.schema)||n.schema!=null&&typeof n.schema=="object"&&"type"in n.schema&&typeof n.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(n.schema.type))}function Kr(n){return cf(n)||lf(n)||of(n)}function uf(n,e){return{name:n.name,description:n.description,parameters:St(n.schema)}}function ji(n,e){let t;return Kr(n)?t={type:"function",function:uf(n)}:t=n,t}function Jr(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}nr=function(n){let e;return n.constructor.name===ur.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===Qe.name?(e=new Error(n.message),e.name="AbortError"):n.status===400&&n.message.includes("tool_calls")?e=Jr(n,"INVALID_TOOL_RESULTS"):n.status===401?e=Jr(n,"MODEL_AUTHENTICATION"):n.status===429?e=Jr(n,"MODEL_RATE_LIMIT"):n.status===404?e=Jr(n,"MODEL_NOT_FOUND"):e=n,e};function uc(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}function pf(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function hf(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(pc(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function pc(n,e){var r;const t=[];for(const[s,i]of Object.entries(n.properties??{}))i.description&&e<2&&t.push(`// ${i.description}`),(r=n.required)!=null&&r.includes(s)?t.push(`${s}: ${Hr(i,e)},`):t.push(`${s}?: ${Hr(i,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function Hr(n,e){if(pf(n))return n.anyOf.map(t=>Hr(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",pc(n,e+2),"}"].join(`
`);case"array":return n.items?`${Hr(n.items,e)}[]`:"any[]";default:return""}}function df(n,e){let t;return Kr(n)?t=ji(n):t=n,(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function mf(n){return n.role!=="system"&&n.role!=="developer"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function Ii(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!us.isInstance(n))throw new Error("Invalid generic chat message");return mf(n)}default:throw new Error(`Unknown message type: ${e}`)}}const hc={providerName:"ChatOpenAI",fromStandardTextBlock(n){return{type:"text",text:n.text}},fromStandardImageBlock(n){var e,t;if(n.source_type==="url")return{type:"image_url",image_url:{url:n.url,...(e=n.metadata)!=null&&e.detail?{detail:n.metadata.detail}:{}}};if(n.source_type==="base64")return{type:"image_url",image_url:{url:`data:${n.mime_type??""};base64,${n.data}`,...(t=n.metadata)!=null&&t.detail?{detail:n.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${n.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(n){if(n.source_type==="url"){const e=Xn({dataUrl:n.url});if(!e)throw new Error(`URL audio blocks with source_type ${n.source_type} must be formatted as a data URL for ChatOpenAI`);const t=e.mime_type||n.mime_type||"";let r;try{r=yp(t)}catch{throw new Error(`Audio blocks with source_type ${n.source_type} must have mime type of audio/wav or audio/mp3`)}if(r.type!=="audio"||r.subtype!=="wav"&&r.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${n.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:r.subtype,data:e.data}}}if(n.source_type==="base64"){let e;try{e=yp(n.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${n.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${n.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:n.data}}}throw new Error(`Audio content blocks with source_type ${n.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(n){var e,t,r,s,i,a,o,l,c,u;if(n.source_type==="url"){if(!Xn({dataUrl:n.url}))throw new Error(`URL file blocks with source_type ${n.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:n.url,...(e=n.metadata)!=null&&e.filename||(t=n.metadata)!=null&&t.name?{filename:((r=n.metadata)==null?void 0:r.filename)||((s=n.metadata)==null?void 0:s.name)}:{}}}}if(n.source_type==="base64")return{type:"file",file:{file_data:`data:${n.mime_type??""};base64,${n.data}`,...(i=n.metadata)!=null&&i.filename||(a=n.metadata)!=null&&a.name||(o=n.metadata)!=null&&o.title?{filename:((l=n.metadata)==null?void 0:l.filename)||((c=n.metadata)==null?void 0:c.name)||((u=n.metadata)==null?void 0:u.title)}:{}}};if(n.source_type==="id")return{type:"file",file:{file_id:n.id}};throw new Error(`File content blocks with source_type ${n.source_type} are not supported for ChatOpenAI`)}};function dc(n,e){return n.flatMap(t=>{var a;let r=Ii(t);r==="system"&&Gr(e)&&(r="developer");const s=typeof t.content=="string"?t.content:t.content.map(o=>Xi(o)?Yi(o,hc):o),i={role:r,content:s};if(t.name!=null&&(i.name=t.name),t.additional_kwargs.function_call!=null&&(i.function_call=t.additional_kwargs.function_call,i.content=""),qt(t)&&((a=t.tool_calls)!=null&&a.length)?(i.tool_calls=t.tool_calls.map(ec),i.content=""):(t.additional_kwargs.tool_calls!=null&&(i.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(i.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){const o={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[i,o]}return i})}const hn="__openai_function_call_ids__";function ff(n){const e=(n.summary.length>1?n.summary.reduce((t,r)=>{const s=t.at(-1);return s.index===r.index?s.text+=r.text:t.push(r),t},[{...n.summary[0]}]):n.summary).map(t=>Object.fromEntries(Object.entries(t).filter(([r])=>r!=="index")));return{...n,summary:e}}function mc(n,e,t){return n.flatMap(r=>{var a,o,l;const s=r.additional_kwargs;let i=Ii(r);if(i==="system"&&Gr(e)&&(i="developer"),i==="function")throw new Error("Function messages are not supported in Responses API");if(i==="tool"){const c=r;return(s==null?void 0:s.type)==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof c.content=="string")return{type:"computer_screenshot",image_url:c.content};if(Array.isArray(c.content)){const u=c.content.find(h=>h.type==="computer_screenshot");if(u)return u;const p=c.content.find(h=>h.type==="image_url");if(p)return{type:"computer_screenshot",image_url:typeof p.image_url=="string"?p.image_url:p.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:c.tool_call_id}:{type:"function_call_output",call_id:c.tool_call_id,id:(a=c.id)!=null&&a.startsWith("fc_")?c.id:void 0,output:typeof c.content!="string"?JSON.stringify(c.content):c.content}}if(i==="assistant"){if(!t&&r.response_metadata.output!=null&&Array.isArray(r.response_metadata.output)&&r.response_metadata.output.length>0&&r.response_metadata.output.every(m=>"type"in m))return r.response_metadata.output;const c=[];if(s!=null&&s.reasoning&&!t){const m=ff(s.reasoning);c.push(m)}let{content:u}=r;s!=null&&s.refusal&&(typeof u=="string"&&(u=[{type:"output_text",text:u,annotations:[]}]),u=[...u,{type:"refusal",refusal:s.refusal}]),c.push({type:"message",role:"assistant",...r.id&&!t?{id:r.id}:{},content:typeof u=="string"?u:u.flatMap(m=>m.type==="text"?{type:"output_text",text:m.text,annotations:m.annotations??[]}:m.type==="output_text"||m.type==="refusal"?m:[])});const p=s==null?void 0:s[hn];qt(r)&&((o=r.tool_calls)!=null&&o.length)?c.push(...r.tool_calls.map(m=>({type:"function_call",name:m.name,arguments:JSON.stringify(m.args),call_id:m.id,...t?{id:p==null?void 0:p[m.id]}:{}}))):s!=null&&s.tool_calls&&c.push(...s.tool_calls.map(m=>({type:"function_call",name:m.function.name,call_id:m.id,arguments:m.function.arguments,...t?{id:p==null?void 0:p[m.id]}:{}})));const h=(l=r.response_metadata.output)!=null&&l.length?r.response_metadata.output:s.tool_outputs,d=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(h!=null){const m=h==null?void 0:h.filter(y=>d.includes(y.type));m.length>0&&c.push(...m)}return c}if(i==="user"||i==="system"||i==="developer"){if(typeof r.content=="string")return{type:"message",role:i,content:r.content};const c=[],u=r.content.flatMap(p=>(p.type==="mcp_approval_response"&&c.push({type:"mcp_approval_response",approval_request_id:p.approval_request_id,approve:p.approve}),Xi(p)?Yi(p,hc):p.type==="text"?{type:"input_text",text:p.text}:p.type==="image_url"?{type:"input_image",image_url:typeof p.image_url=="string"?p.image_url:p.image_url.url,detail:typeof p.image_url=="string"?"auto":p.image_url.detail}:p.type==="input_text"||p.type==="input_image"||p.type==="input_file"?p:[]));return u.length>0&&c.push({type:"message",role:i,content:u}),c}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${i}`),[]})}function fc(n){if(n.error){const o=new Error(n.error.message);throw o.name=n.error.code,o}let e;const t=[],r=[],s=[],i={model:n.model,created_at:n.created_at,id:n.id,incomplete_details:n.incomplete_details,metadata:n.metadata,object:n.object,status:n.status,user:n.user,service_tier:n.service_tier,model_name:n.model},a={};for(const o of n.output)if(o.type==="message")e=o.id,t.push(...o.content.flatMap(l=>l.type==="output_text"?("parsed"in l&&l.parsed!=null&&(a.parsed=l.parsed),{type:"text",text:l.text,annotations:l.annotations}):l.type==="refusal"?(a.refusal=l.refusal,[]):l));else if(o.type==="function_call"){const l={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{r.push(Wr(l,{returnId:!0}))}catch(c){let u;typeof c=="object"&&c!=null&&"message"in c&&typeof c.message=="string"&&(u=c.message),s.push(Ti(l,u))}a[hn]??(a[hn]={}),o.id&&(a[hn][o.call_id]=o.id)}else o.type==="reasoning"?a.reasoning=o:(a.tool_outputs??(a.tool_outputs=[]),a.tool_outputs.push(o));return new At({id:e,content:t,tool_calls:r,invalid_tool_calls:s,usage_metadata:n.usage,additional_kwargs:a,response_metadata:i})}function yf(n){var l,c;const e=[];let t={},r;const s=[],i={},a={};let o;if(n.type==="response.output_text.delta")e.push({type:"text",text:n.delta,index:n.content_index});else if(n.type==="response.output_text_annotation.added")e.push({type:"text",text:"",annotations:[n.annotation],index:n.content_index});else if(n.type==="response.output_item.added"&&n.item.type==="message")o=n.item.id;else if(n.type==="response.output_item.added"&&n.item.type==="function_call")s.push({type:"tool_call_chunk",name:n.item.name,args:n.item.arguments,id:n.item.call_id,index:n.output_index}),a[hn]={[n.item.call_id]:n.item.id};else if(n.type==="response.output_item.done"&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call"].includes(n.item.type))a.tool_outputs=[n.item];else if(n.type==="response.created")i.id=n.response.id,i.model_name=n.response.model,i.model=n.response.model;else if(n.type==="response.completed"){const u=fc(n.response);r=n.response.usage,((c=(l=n.response.text)==null?void 0:l.format)==null?void 0:c.type)==="json_schema"&&(a.parsed??(a.parsed=JSON.parse(u.text)));for(const[p,h]of Object.entries(n.response))p!=="id"&&(i[p]=h)}else if(n.type==="response.function_call_arguments.delta")s.push({type:"tool_call_chunk",args:n.delta,index:n.output_index});else if(n.type==="response.web_search_call.completed"||n.type==="response.file_search_call.completed")t={tool_outputs:{id:n.item_id,type:n.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(n.type==="response.refusal.done")a.refusal=n.refusal;else if(n.type==="response.output_item.added"&&"item"in n&&n.item.type==="reasoning"){const u=n.item.summary?n.item.summary.map((p,h)=>({...p,index:h})):void 0;a.reasoning={id:n.item.id,type:n.item.type,...u?{summary:u}:{}}}else if(n.type==="response.reasoning_summary_part.added")a.reasoning={type:"reasoning",summary:[{...n.part,index:n.summary_index}]};else if(n.type==="response.reasoning_summary_text.delta")a.reasoning={type:"reasoning",summary:[{text:n.delta,type:"summary_text",index:n.summary_index}]};else return n.type,null;return new Dt({text:e.map(u=>u.text).join(""),message:new _n({id:o,content:e,tool_call_chunks:s,usage_metadata:r,additional_kwargs:a,response_metadata:i}),generationInfo:t})}function $i(n){return"type"in n&&n.type!=="function"}function gf(n){return n!=null&&typeof n=="object"&&"type"in n&&n.type!=="function"}function bf(n,e){const t=[];for(const r of n)$i(r)?(r.type==="image_generation"&&(e!=null&&e.stream)&&(r.partial_images=1),t.push(r)):Dr(r)&&t.push({type:"function",name:r.function.name,parameters:r.function.parameters,description:r.function.description,strict:(e==null?void 0:e.strict)??null});return t}function yc(n,e){return Dr(n)?(e==null?void 0:e.strict)!==void 0?{...n,function:{...n.function,strict:e.strict}}:n:df(n,e)}function Gr(n){return n&&/^o\d/.test(n)}class wf extends gt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort","service_tier"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","useResponsesApi","zdrEnabled","reasoning"]}constructor(e){var t,r,s;super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zdrEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"service_tier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.apiKey)??(e==null?void 0:e.openAIApiKey)??((t=e==null?void 0:e.configuration)==null?void 0:t.apiKey)??cs("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??cs("OPENAI_ORGANIZATION"),this.model=(e==null?void 0:e.model)??(e==null?void 0:e.modelName)??this.model,this.modelName=this.model,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(e==null?void 0:e.stopSequences)??(e==null?void 0:e.stop),this.stopSequences=this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=(e==null?void 0:e.reasoningEffort)??((s=e==null?void 0:e.reasoning)==null?void 0:s.effort),this.reasoning=(e==null?void 0:e.reasoning)??(e!=null&&e.reasoningEffort?{effort:e.reasoningEffort}:void 0),this.maxTokens=(e==null?void 0:e.maxCompletionTokens)??(e==null?void 0:e.maxTokens),this.useResponsesApi=(e==null?void 0:e.useResponsesApi)??this.useResponsesApi,this.disableStreaming=(e==null?void 0:e.disableStreaming)??this.disableStreaming,this.streaming=(e==null?void 0:e.streaming)??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=(e==null?void 0:e.streamUsage)??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),(e==null?void 0:e.service_tier)!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=(e==null?void 0:e.zdrEnabled)??!1}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return(t==null?void 0:t.strict)!==void 0?r=t.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.withConfig({tools:e.map(s=>$i(s)?s:yc(s,{strict:r})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Ot(e.json_schema.schema)?xf(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}getReasoningParams(e){if(!Gr(this.model))return;let t;return this.reasoningEffort!==void 0&&(t={effort:this.reasoningEffort}),this.reasoning!==void 0&&(t={...t,...this.reasoning}),(e==null?void 0:e.reasoning_effort)!==void 0&&(t={...t,effort:e.reasoning_effort}),(e==null?void 0:e.reasoning)!==void 0&&(t={...t,...e.reasoning}),t}invocationParams(e,t){var o,l;let r;if((e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this._useResponseApi(e)){const c={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e==null?void 0:e.previous_response_id,truncation:e==null?void 0:e.truncation,include:e==null?void 0:e.include,tools:(o=e==null?void 0:e.tools)!=null&&o.length?bf(e.tools,{stream:this.streaming,strict:r}):void 0,tool_choice:gf(e==null?void 0:e.tool_choice)?e==null?void 0:e.tool_choice:(()=>{const p=uc(e==null?void 0:e.tool_choice);if(typeof p=="object"&&"type"in p)return{type:"function",name:p.function.name}})(),text:(()=>{if(e!=null&&e.text)return e.text;const p=this.createResponseFormat(e==null?void 0:e.response_format);return(p==null?void 0:p.type)==="json_schema"?p.json_schema.schema!=null?{format:{type:"json_schema",schema:p.json_schema.schema,description:p.json_schema.description,name:p.json_schema.name,strict:p.json_schema.strict}}:void 0:{format:p}})(),parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},u=this.getReasoningParams(e);return u!==void 0&&(c.reasoning=u),c}let s={};(e==null?void 0:e.stream_options)!==void 0?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(s={stream_options:{include_usage:!0}});const i={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(l=e==null?void 0:e.tools)!=null&&l.length?e.tools.map(c=>yc(c,{strict:r})):void 0,tool_choice:uc(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...s,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(i.prediction=e.prediction),this.service_tier!==void 0&&(i.service_tier=this.service_tier),(e==null?void 0:e.service_tier)!==void 0&&(i.service_tier=e.service_tier);const a=this.getReasoningParams(e);return a!==void 0&&a.effort!==void 0&&(i.reasoning_effort=a.effort),Gr(i.model)?i.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:i.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,i}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){const r=e.tool_calls;switch(e.role){case"assistant":{const s=[],i=[];for(const l of r??[])try{s.push(Wr(l,{returnId:!0}))}catch(c){i.push(Ti(l,c.message))}const a={function_call:e.function_call,tool_calls:r};this.__includeRawResponse!==void 0&&(a.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(a.audio=e.audio),new At({content:e.content||"",tool_calls:s,invalid_tool_calls:i,additional_kwargs:a,response_metadata:o,id:t.id})}default:return new us(e.content||"",e.role??"unknown")}}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){var l,c;const s=e.role??r,i=e.content??"";let a;e.function_call?a={function_call:e.function_call}:e.tool_calls?a={tool_calls:e.tool_calls}:a={},this.__includeRawResponse&&(a.__raw_response=t),e.audio&&(a.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if(s==="user")return new hp({content:i,response_metadata:o});if(s==="assistant"){const u=[];if(Array.isArray(e.tool_calls))for(const p of e.tool_calls)u.push({name:(l=p.function)==null?void 0:l.name,args:(c=p.function)==null?void 0:c.arguments,id:p.id,index:p.index,type:"tool_call_chunk"});return new _n({content:i,tool_call_chunks:u,additional_kwargs:a,id:t.id,response_metadata:o})}else return s==="system"?new ps({content:i,response_metadata:o}):s==="developer"?new ps({content:i,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new dp({content:i,additional_kwargs:a,name:e.name,response_metadata:o}):s==="tool"?new mp({content:i,additional_kwargs:a,tool_call_id:e.tool_call_id,response_metadata:o}):new fp({content:i,role:s,response_metadata:o})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c,u,p,h,d,m,y,f,g,b;if(this._useResponseApi(t)){const _=await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:mc(e,this.model,this.zdrEnabled),stream:!0},t);for await(const M of _){const S=yf(M);S!=null&&(yield S)}return}const s=dc(e,this.model),i={...this.invocationParams(t,{streaming:!0}),messages:s,stream:!0};let a;const o=await this.completionWithRetry(i,t);let l;for await(const _ of o){const M=(c=_==null?void 0:_.choices)==null?void 0:c[0];if(_.usage&&(l=_.usage),!M)continue;const{delta:S}=M;if(!S)continue;const C=this._convertOpenAIDeltaToBaseMessageChunk(S,_,a);a=S.role??a;const W={prompt:t.promptIndex??0,completion:M.index??0};if(typeof C.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const V={...W};M.finish_reason!=null&&(V.finish_reason=M.finish_reason,V.system_fingerprint=_.system_fingerprint,V.model_name=_.model,V.service_tier=_.service_tier),this.logprobs&&(V.logprobs=M.logprobs);const q=new Dt({message:C,text:C.content,generationInfo:V});yield q,await(r==null?void 0:r.handleLLMNewToken(q.text??"",W,void 0,void 0,void 0,{chunk:q}))}if(l){const _={...((u=l.prompt_tokens_details)==null?void 0:u.audio_tokens)!==null&&{audio:(p=l.prompt_tokens_details)==null?void 0:p.audio_tokens},...((h=l.prompt_tokens_details)==null?void 0:h.cached_tokens)!==null&&{cache_read:(d=l.prompt_tokens_details)==null?void 0:d.cached_tokens}},M={...((m=l.completion_tokens_details)==null?void 0:m.audio_tokens)!==null&&{audio:(y=l.completion_tokens_details)==null?void 0:y.audio_tokens},...((f=l.completion_tokens_details)==null?void 0:f.reasoning_tokens)!==null&&{reasoning:(g=l.completion_tokens_details)==null?void 0:g.reasoning_tokens}};yield new Dt({message:new _n({content:"",response_metadata:{usage:{...l}},usage_metadata:{input_tokens:l.prompt_tokens,output_tokens:l.completion_tokens,total_tokens:l.total_tokens,...Object.keys(_).length>0&&{input_token_details:_},...Object.keys(M).length>0&&{output_token_details:M}}}),text:""})}if((b=t.signal)!=null&&b.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,r){var o;const s=this.invocationParams(t);if(s.stream){const l=this._streamResponseChunks(e,t,r);let c;for await(const u of l)u.message.response_metadata={...u.generationInfo,...u.message.response_metadata},c=(c==null?void 0:c.concat(u))??u;return{generations:c?[c]:[],llmOutput:{estimatedTokenUsage:(o=c==null?void 0:c.message)==null?void 0:o.usage_metadata}}}const i=mc(e,this.model,this.zdrEnabled),a=await this.responseApiWithRetry({input:i,...s},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});return{generations:[{text:a.output_text,message:fc(a)}],llmOutput:{id:a.id,estimatedTokenUsage:a.usage?{promptTokens:a.usage.input_tokens,completionTokens:a.usage.output_tokens,totalTokens:a.usage.total_tokens}:void 0}}}_useResponseApi(e){var s,i,a;const t=(s=e==null?void 0:e.tools)==null?void 0:s.some($i),r=(e==null?void 0:e.previous_response_id)!=null||(e==null?void 0:e.text)!=null||(e==null?void 0:e.truncation)!=null||(e==null?void 0:e.include)!=null||((i=e==null?void 0:e.reasoning)==null?void 0:i.summary)!=null||((a=this.reasoning)==null?void 0:a.summary)!=null;return this.useResponsesApi||t||r}async _generate(e,t,r){var o,l;if(this._useResponseApi(t))return this._responseApiGenerate(e,t,r);const s={},i=this.invocationParams(t),a=dc(e,this.model);if(i.stream){const c=this._streamResponseChunks(e,t,r),u={};for await(const f of c){f.message.response_metadata={...f.generationInfo,...f.message.response_metadata};const g=((o=f.generationInfo)==null?void 0:o.completion)??0;u[g]===void 0?u[g]=f:u[g]=u[g].concat(f)}const p=Object.entries(u).sort(([f],[g])=>parseInt(f,10)-parseInt(g,10)).map(([f,g])=>g),{functions:h,function_call:d}=this.invocationParams(t),m=await this.getEstimatedTokenCountFromPrompt(e,h,d),y=await this.getNumTokensFromGenerations(p);return s.input_tokens=m,s.output_tokens=y,s.total_tokens=m+y,{generations:p,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{let c;t.response_format&&t.response_format.type==="json_schema"?c=await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:a},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):c=await this.completionWithRetry({...i,stream:!1,messages:a},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});const{completion_tokens:u,prompt_tokens:p,total_tokens:h,prompt_tokens_details:d,completion_tokens_details:m}=(c==null?void 0:c.usage)??{};u&&(s.output_tokens=(s.output_tokens??0)+u),p&&(s.input_tokens=(s.input_tokens??0)+p),h&&(s.total_tokens=(s.total_tokens??0)+h),((d==null?void 0:d.audio_tokens)!==null||(d==null?void 0:d.cached_tokens)!==null)&&(s.input_token_details={...(d==null?void 0:d.audio_tokens)!==null&&{audio:d==null?void 0:d.audio_tokens},...(d==null?void 0:d.cached_tokens)!==null&&{cache_read:d==null?void 0:d.cached_tokens}}),((m==null?void 0:m.audio_tokens)!==null||(m==null?void 0:m.reasoning_tokens)!==null)&&(s.output_token_details={...(m==null?void 0:m.audio_tokens)!==null&&{audio:m==null?void 0:m.audio_tokens},...(m==null?void 0:m.reasoning_tokens)!==null&&{reasoning:m==null?void 0:m.reasoning_tokens}});const y=[];for(const f of(c==null?void 0:c.choices)??[]){const g={text:((l=f.message)==null?void 0:l.content)??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(f.message??{role:"assistant"},c)};g.generationInfo={...f.finish_reason?{finish_reason:f.finish_reason}:{},...f.logprobs?{logprobs:f.logprobs}:{}},qt(g.message)&&(g.message.usage_metadata=s),g.message=new At(Object.fromEntries(Object.entries(g.message).filter(([b])=>!b.startsWith("lc_")))),y.push(g)}return{generations:y,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){const i=hf(t);s+=await this.getNumTokens(i),s+=9}return t&&e.find(i=>i._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async t=>{var r;return(r=t.message.additional_kwargs)!=null&&r.function_call?(await this.getNumTokensFromMessages([t.message])).countPerMessage[0]:await this.getNumTokens(t.message.content)}))).reduce((t,r)=>t+r,0)}async getNumTokensFromMessages(e){let t=0,r=0,s=0;this.model==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const i=await Promise.all(e.map(async a=>{var h,d,m,y,f,g;const o=await this.getNumTokens(a.content),l=await this.getNumTokens(Ii(a)),c=a.name!==void 0?s+await this.getNumTokens(a.name):0;let u=o+r+l+c;const p=a;if(p._getType()==="function"&&(u-=2),(h=p.additional_kwargs)!=null&&h.function_call&&(u+=3),(d=p==null?void 0:p.additional_kwargs.function_call)!=null&&d.name&&(u+=await this.getNumTokens((m=p.additional_kwargs.function_call)==null?void 0:m.name)),(y=p.additional_kwargs.function_call)==null?void 0:y.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse((f=p.additional_kwargs.function_call)==null?void 0:f.arguments)))}catch(b){console.error("Error parsing function arguments",b,JSON.stringify(p.additional_kwargs.function_call)),u+=await this.getNumTokens((g=p.additional_kwargs.function_call)==null?void 0:g.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw nr(s)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{var s,i;const r=this._getClientOptions(t);try{return((i=(s=e.text)==null?void 0:s.format)==null?void 0:i.type)==="json_schema"&&!e.stream?await this.client.responses.parse(e,r):await this.client.responses.create(e,r)}catch(a){throw nr(a)}})}async betaParsedCompletionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.parse(e,r)}catch(s){throw nr(s)}})}_getClientOptions(e){if(!this.client){const t={baseURL:this.clientConfig.baseURL},r=aa(t),s={...this.clientConfig,baseURL:r,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new Z(s)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,s,i,a;_f(e)?(r=e.schema,s=e.name,i=e.method,a=e.includeRaw):(r=e,s=t==null?void 0:t.name,i=t==null?void 0:t.method,a=t==null?void 0:t.includeRaw);let o,l;if((t==null?void 0:t.strict)!==void 0&&i==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"?i===void 0&&(i="jsonSchema"):i==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`),i==="jsonMode"){let h;Ot(r)?(l=ki.fromZodSchema(r),h=St(r)):l=new Ur,o=this.withConfig({response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"jsonMode"},schema:h}})}else if(i==="jsonSchema")if(o=this.withConfig({response_format:{type:"json_schema",json_schema:{name:s??"extract",description:lp(r),schema:r,strict:t==null?void 0:t.strict}},ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:St(r)}}),Ot(r)){const h=ki.fromZodSchema(r);l=cp.from(d=>"parsed"in d.additional_kwargs?d.additional_kwargs.parsed:h)}else l=new Ur;else{let h=s??"extract";if(Ot(r)){const d=St(r);o=this.withConfig({tools:[{type:"function",function:{name:h,description:d.description,parameters:d}}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:d},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),l=new Vr({returnSingle:!0,keyName:h,zodSchema:r})}else{let d;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(d=r,h=r.name):(h=r.title??h,d={name:h,description:r.description??"",parameters:r}),o=this.withConfig({tools:[{type:"function",function:d}],tool_choice:{type:"function",function:{name:h}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:St(r)},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),l=new Vr({returnSingle:!0,keyName:h})}}if(!a)return o.pipe(l);const c=Nt.assign({parsed:(h,d)=>l.invoke(h.raw,d)}),u=Nt.assign({parsed:()=>null}),p=c.withFallbacks({fallbacks:[u]});return ls.from([{raw:o},p])}}function _f(n){return n!==void 0&&typeof n.schema=="object"}function vf(n,e){const t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function xf(n,e,t){if(Ng(n))return af(n,e,t);if(jg(n))return vf({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:am(n,{cycles:"ref",reused:"ref",override(r){r.jsonSchema.title=e}})}},r=>rm(n,JSON.parse(r)));throw new Error("Unsupported schema response format")}const dn="0.19.0";let gc=!1,Vn,bc,wc,Li,_c,vc,xc,Oc,Mc;function Of(n,e={auto:!1}){if(gc)throw new Error(`you must \`import 'groq-sdk/shims/${n.kind}'\` before importing anything else from groq-sdk`);if(Vn)throw new Error(`can't \`import 'groq-sdk/shims/${n.kind}'\` after \`import 'groq-sdk/shims/${Vn}'\``);gc=e.auto,Vn=n.kind,bc=n.fetch,wc=n.FormData,Li=n.File,_c=n.ReadableStream,vc=n.getMultipartRequestOptions,xc=n.getDefaultAgent,Oc=n.fileFromPath,Mc=n.isFsReadStream}class Mf{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Ef({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n";let t,r,s,i;try{t=fetch,r=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new Mf(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:a=>!1}}const Ec=()=>{Vn||Of(Ef(),{auto:!0})};Ec();class lt extends Error{}class je extends lt{constructor(e,t,r,s){super(`${je.makeMessage(e,t,r)}`),this.status=e,this.headers=s,this.error=t}static makeMessage(e,t,r){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e||!s)return new Zr({message:r,cause:Wi(t)});const i=t;return e===400?new Ac(e,i,r,s):e===401?new Sc(e,i,r,s):e===403?new Pc(e,i,r,s):e===404?new kc(e,i,r,s):e===409?new Tc(e,i,r,s):e===422?new Rc(e,i,r,s):e===429?new Nc(e,i,r,s):e>=500?new jc(e,i,r,s):new je(e,i,r,s)}}class Bi extends je{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Zr extends je{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Cc extends Zr{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Ac extends je{}class Sc extends je{}class Pc extends je{}class kc extends je{}class Tc extends je{}class Rc extends je{}class Nc extends je{}class jc extends je{}class mn{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;const s=new Cf;async function*i(){if(!e.body)throw t.abort(),new lt("Attempted to iterate over a response with no body");const o=new Jt,l=Ic(e.body);for await(const c of l)for(const u of o.decode(c)){const p=s.decode(u);p&&(yield p)}for(const c of o.flush()){const u=s.decode(c);u&&(yield u)}}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const l of i())if(!o){if(l.data.startsWith("[DONE]")){o=!0;continue}if(l.event===null||l.event==="error"){let c;try{c=JSON.parse(l.data)}catch(u){throw console.error("Could not parse message into JSON:",l.data),console.error("From chunk:",l.raw),u}if(c&&c.error)throw new je(c.error.status_code,c.error,c.error.message,void 0);yield c}}o=!0}catch(l){if(l instanceof Error&&l.name==="AbortError")return;throw l}finally{o||t.abort()}}return new mn(a,t)}static fromReadableStream(e,t){let r=!1;async function*s(){const a=new Jt,o=Ic(e);for await(const l of o)for(const c of a.decode(l))yield c;for(const l of a.flush())yield l}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new mn(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new mn(()=>s(e),this.controller),new mn(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new _c({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:i,done:a}=await t.next();if(a)return s.close();const o=r.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}class Cf{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=Af(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}class Jt{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const r=Jt.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(Jt.NEWLINE_REGEXP);return s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof ze<"u"){if(e instanceof ze)return e.toString();if(e instanceof Uint8Array)return ze.from(e).toString();throw new lt(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new lt(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new lt("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}Jt.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]),Jt.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function Af(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function Ic(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const $c=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Lc=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Xr(n),Xr=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Sf=n=>Lc(n)||$c(n)||Mc(n);async function Bc(n,e,t){var s;if(n=await n,Lc(n))return n;if($c(n)){const i=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=Xr(i)?[await i.arrayBuffer()]:[i];return new Li(a,e,t)}const r=await Pf(n);if(e||(e=Tf(n)??"unknown_file"),!(t!=null&&t.type)){const i=(s=r[0])==null?void 0:s.type;typeof i=="string"&&(t={...t,type:i})}return new Li(r,e,t)}async function Pf(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Xr(n))e.push(await n.arrayBuffer());else if(Rf(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${kf(n)}`);return e}function kf(n){return`[${Object.getOwnPropertyNames(n).map(e=>`"${e}"`).join(", ")}]`}function Tf(n){var e;return qi(n.name)||qi(n.filename)||((e=qi(n.path))==null?void 0:e.split(/[\\/]/).pop())}const qi=n=>{if(typeof n=="string")return n;if(typeof ze<"u"&&n instanceof ze)return String(n)},Rf=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",qc=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",Di=async n=>{const e=await Nf(n.body);return vc(e,n)},Nf=async n=>{const e=new wc;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Fi(e,t,r))),e},Fi=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Sf(t)){const r=await Bc(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Fi(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>Fi(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var fn={};Ec();async function Dc(n){var s,i;const{response:e}=n;if(n.options.stream)return yn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):mn.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=(i=(s=e.headers.get("content-type"))==null?void 0:s.split(";")[0])==null?void 0:i.trim();if(t!=null&&t.includes("application/json")||t!=null&&t.endsWith("+json")){const a=await e.json();return yn("response",e.status,e.url,e.headers,a),a}const r=await e.text();return yn("response",e.status,e.url,e.headers,r),r}class Yr extends Promise{constructor(e,t=Dc){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Yr(this.responsePromise,async t=>e(await this.parseResponse(t),t))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class jf{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e4,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=Ui("maxRetries",t),this.timeout=Ui("timeout",r),this.httpAgent=s,this.fetch=i??bc}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...qf(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Qf()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async s=>{const i=s&&Xr(s==null?void 0:s.body)?new DataView(await s.body.arrayBuffer()):(s==null?void 0:s.body)instanceof DataView?s.body:(s==null?void 0:s.body)instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s==null?void 0:s.body)?new DataView(s.body.buffer):s==null?void 0:s.body;return{method:e,path:t,...s,body:i}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof ze<"u")return ze.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var d;e={...e};const{method:r,path:s,query:i,headers:a={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:qc(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,l=this.calculateContentLength(o),c=this.buildURL(s,i);"timeout"in e&&Ui("timeout",e.timeout),e.timeout=e.timeout??this.timeout;const u=e.httpAgent??this.httpAgent??xc(c),p=e.timeout+1e3;typeof((d=u==null?void 0:u.options)==null?void 0:d.timeout)=="number"&&p>(u.options.timeout??0)&&(u.options.timeout=p),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:e,headers:a,contentLength:l,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...u&&{agent:u},signal:e.signal??null},url:c,timeout:e.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:s}){const i={};r&&(i["content-length"]=r);const a=this.defaultHeaders(e);return zc(i,a),zc(i,t),qc(e.body)&&Vn!=="node"&&delete i["content-type"],es(a,"x-stainless-retry-count")===void 0&&es(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(s)),es(a,"x-stainless-timeout")===void 0&&es(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(e.timeout)),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return je.generate(e,t,r,s)}request(e,t=null){return new Yr(this.makeRequest(e,t))}async makeRequest(e,t){var p,h;const r=await e,s=r.maxRetries??this.maxRetries;t==null&&(t=s),await this.prepareOptions(r);const{req:i,url:a,timeout:o}=this.buildRequest(r,{retryCount:s-t});if(await this.prepareRequest(i,{url:a,options:r}),yn("request",a,r,i.headers),(p=r.signal)==null?void 0:p.aborted)throw new Bi;const l=new AbortController,c=await this.fetchWithTimeout(a,i,o,l).catch(Wi);if(c instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new Bi;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new Cc:new Zr({cause:c})}const u=$f(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const f=`retrying, ${t} attempts remaining`;return yn(`response (error; ${f})`,c.status,a,u),this.retryRequest(r,t,u)}const d=await c.text().catch(f=>Wi(f).message),m=Df(d),y=m?void 0:d;throw yn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,u,y),this.makeStatusError(c.status,m,y,u)}return{response:c,options:r,controller:l}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new If(this,r,e)}buildURL(e,t){const r=Uf(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Vf(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new lt(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r),l={signal:s.signal,...a};return l.method&&(l.method=l.method.toUpperCase()),this.fetch.call(void 0,e,l).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let s;const i=r==null?void 0:r["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(s=o)}const a=r==null?void 0:r["retry-after"];if(a&&!s){const o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){const o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Wf(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const r=t-e,s=Math.min(.5*Math.pow(2,r),8),i=1-Math.random()*.25;return s*i*1e3}getUserAgent(){return`${this.constructor.name}/JS ${dn}`}}class If extends Yr{constructor(e,t,r){super(t,async s=>new r(e,s.response,await Dc(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const $f=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),Lf=()=>{var e;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dn,"X-Stainless-OS":Uc(Deno.build.os),"X-Stainless-Arch":Fc(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((e=Deno.version)==null?void 0:e.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":xt.version};if(Object.prototype.toString.call(typeof xt<"u"?xt:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dn,"X-Stainless-OS":Uc(xt.platform),"X-Stainless-Arch":Fc(xt.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":xt.version};const n=Bf();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":dn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Bf(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const Fc=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Uc=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Wc;const qf=()=>Wc??(Wc=Lf()),Df=n=>{try{return JSON.parse(n)}catch{return}},Ff=/^[a-z][a-z0-9+.-]*:/i,Uf=n=>Ff.test(n),Wf=n=>new Promise(e=>setTimeout(e,n)),Ui=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new lt(`${n} must be an integer`);if(e<0)throw new lt(`${n} must be a positive integer`);return e},Wi=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},Vc=n=>{var e,t,r,s;if(typeof xt<"u")return((e=fn==null?void 0:fn[n])==null?void 0:e.trim())??void 0;if(typeof Deno<"u")return(s=(r=(t=Deno.env)==null?void 0:t.get)==null?void 0:r.call(t,n))==null?void 0:s.trim()};function Vf(n){if(!n)return!0;for(const e in n)return!1;return!0}function zf(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function zc(n,e){for(const t in e){if(!zf(e,t))continue;const r=t.toLowerCase();if(!r)continue;const s=e[t];s===null?delete n[r]:s!==void 0&&(n[r]=s)}}function yn(n,...e){typeof xt<"u"&&(fn==null?void 0:fn.DEBUG)==="true"&&console.log(`Groq:DEBUG:${n}`,...e)}const Qf=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Kf=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Jf=n=>typeof(n==null?void 0:n.get)=="function",es=(n,e)=>{var r;const t=e.toLowerCase();if(Jf(n)){const s=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(i,a,o)=>a+o.toUpperCase());for(const i of[e,t,e.toUpperCase(),s]){const a=n.get(i);if(a)return a}}for(const[s,i]of Object.entries(n))if(s.toLowerCase()===t)return Array.isArray(i)?(i.length<=1||console.warn(`Received ${i.length} entries for the ${e} header, using the first entry.`),i[0]):i};class ct{constructor(e){this._client=e}}class Qc extends ct{create(e,t){return this._client.post("/openai/v1/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t==null?void 0:t.headers},__binaryResponse:!0})}}class Kc extends ct{create(e,t){return this._client.post("/openai/v1/audio/transcriptions",Di({body:e,...t}))}}class Jc extends ct{create(e,t){return this._client.post("/openai/v1/audio/translations",Di({body:e,...t}))}}class zn extends ct{constructor(){super(...arguments),this.speech=new Qc(this._client),this.transcriptions=new Kc(this._client),this.translations=new Jc(this._client)}}zn.Speech=Qc,zn.Transcriptions=Kc,zn.Translations=Jc;class Hc extends ct{create(e,t){return this._client.post("/openai/v1/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/openai/v1/batches/${e}`,t)}list(e){return this._client.get("/openai/v1/batches",e)}cancel(e,t){return this._client.post(`/openai/v1/batches/${e}/cancel`,t)}}let Gc=class extends ct{create(n,e){return this._client.post("/openai/v1/chat/completions",{body:n,...e,stream:n.stream??!1})}};class Vi extends ct{constructor(){super(...arguments),this.completions=new Gc(this._client)}}Vi.Completions=Gc;class Zc extends ct{}class Xc extends ct{create(e,t){return this._client.post("/openai/v1/embeddings",{body:e,...t})}}class Yc extends ct{create(e,t){return this._client.post("/openai/v1/files",Di({body:e,...t}))}list(e){return this._client.get("/openai/v1/files",e)}delete(e,t){return this._client.delete(`/openai/v1/files/${e}`,t)}content(e,t){return this._client.get(`/openai/v1/files/${e}/content`,t)}info(e,t){return this._client.get(`/openai/v1/files/${e}`,t)}}class eu extends ct{retrieve(e,t){return this._client.get(`/openai/v1/models/${e}`,t)}list(e){return this._client.get("/openai/v1/models",e)}delete(e,t){return this._client.delete(`/openai/v1/models/${e}`,t)}}var tu;class ae extends jf{constructor({baseURL:e=Vc("GROQ_BASE_URL"),apiKey:t=Vc("GROQ_API_KEY"),...r}={}){if(t===void 0)throw new lt("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");const s={apiKey:t,...r,baseURL:e||"https://api.groq.com"};if(!s.dangerouslyAllowBrowser&&Kf())throw new lt(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:s.baseURL,timeout:s.timeout??6e4,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Zc(this),this.chat=new Vi(this),this.embeddings=new Xc(this),this.audio=new zn(this),this.models=new eu(this),this.batches=new Hc(this),this.files=new Yc(this),this._options=s,this.apiKey=t}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}}tu=ae,ae.Groq=tu,ae.DEFAULT_TIMEOUT=6e4,ae.GroqError=lt,ae.APIError=je,ae.APIConnectionError=Zr,ae.APIConnectionTimeoutError=Cc,ae.APIUserAbortError=Bi,ae.NotFoundError=kc,ae.ConflictError=Tc,ae.RateLimitError=Nc,ae.BadRequestError=Ac,ae.AuthenticationError=Sc,ae.InternalServerError=jc,ae.PermissionDeniedError=Pc,ae.UnprocessableEntityError=Rc,ae.toFile=Bc,ae.fileFromPath=Oc,ae.Completions=Zc,ae.Chat=Vi,ae.Embeddings=Xc,ae.Audio=zn,ae.Models=eu,ae.Batches=Hc,ae.Files=Yc;const Hf=["frequency_penalty","function_call","functions","logit_bias","logprobs","max_completion_tokens","max_tokens","n","parallel_tool_calls","presence_penalty","reasoning_format","response_format","seed","service_tier","stop","temperature","tool_choice","top_logprobs","top_p"],Gf=["headers","promptIndex","stream_options","tools"],Zf=[...Hf,...Gf];function Xf(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}}function nu(n){return n.map(e=>{var r;if(typeof e.content!="string")throw new Error("Non string message content not supported");const t={role:Xf(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id};return qt(e)&&((r=e.tool_calls)!=null&&r.length)?t.tool_calls=e.tool_calls.map(ec):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}function Yf(n,e,t){const r=n.tool_calls;switch(n.role){case"assistant":{const s=[],i=[];for(const a of r??[])try{s.push(Wr(a,{returnId:!0}))}catch(o){i.push(Ti(a,o.message))}return new At({content:n.content||"",additional_kwargs:{tool_calls:r},tool_calls:s,invalid_tool_calls:i,usage_metadata:e,response_metadata:t})}default:return new us(n.content||"",n.role??"unknown")}}function ey(n,e,t,r){var h,d;const s=n.role??e,i=n.content??"";let a;n.function_call?a={function_call:n.function_call}:n.tool_calls?a={tool_calls:n.tool_calls}:a={},n.audio&&(a.audio={...n.audio,index:t.choices[0].index});let o,l=r,c;const u=t.x_groq;u!=null&&u.usage&&(o={input_tokens:u.usage.prompt_tokens,output_tokens:u.usage.completion_tokens,total_tokens:u.usage.total_tokens},c={completion_time:u.usage.completion_time,prompt_time:u.usage.prompt_time,queue_time:u.usage.queue_time,total_time:u.usage.total_time}),u!=null&&u.id&&(l=u.id);const p={usage:o,timing:c};if(s==="user")return new hp({content:i,response_metadata:p});if(s==="assistant"){const m=[];if(Array.isArray(n.tool_calls))for(const y of n.tool_calls)m.push({name:(h=y.function)==null?void 0:h.name,args:(d=y.function)==null?void 0:d.arguments,id:y.id,index:y.index,type:"tool_call_chunk"});return new _n({content:i,tool_call_chunks:m,additional_kwargs:a,id:l,response_metadata:p})}else return s==="system"?new ps({content:i,response_metadata:p}):s==="developer"?new ps({content:i,response_metadata:p,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new dp({content:i,additional_kwargs:a,name:n.name,response_metadata:p}):s==="tool"?new mp({content:i,additional_kwargs:a,tool_call_id:n.tool_call_id,response_metadata:p}):new fp({content:i,role:s,response_metadata:p})}class ty extends gt{get lc_serialized_keys(){return["client","model","temperature","stop","stopSequences","maxTokens","streaming","apiKey","streamUsage","topP","frequencyPenalty","presencePenalty","logprobs","n","logitBias","user","reasoningFormat","serviceTier","topLogprobs"]}static lc_name(){return"ChatGroq"}_llmType(){return"groq"}get lc_secrets(){return{apiKey:"GROQ_API_KEY"}}get callKeys(){return[...super.callKeys,...Zf]}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","groq"]}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serviceTier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=e.apiKey||cs("GROQ_API_KEY");if(!t)throw new Error('Groq API key not found. Please set the GROQ_API_KEY environment variable or provide the key into "apiKey"');const r={"User-Agent":"langchainjs",...e.defaultHeaders??{}};this.client=new ae({apiKey:t,dangerouslyAllowBrowser:!0,baseURL:e.baseUrl,timeout:e.timeout,httpAgent:e.httpAgent,fetch:e.fetch,maxRetries:0,defaultHeaders:r,defaultQuery:e.defaultQuery}),this.apiKey=t,this.temperature=e.temperature??this.temperature,this.model=e.model,this.streaming=e.streaming??this.streaming,this.stop=e.stopSequences??(typeof e.stop=="string"?[e.stop]:e.stop)??[],this.stopSequences=this.stop,this.maxTokens=e.maxTokens,this.topP=e.topP,this.frequencyPenalty=e.frequencyPenalty,this.presencePenalty=e.presencePenalty,this.logprobs=e.logprobs,this.n=e.n,this.logitBias=e.logitBias,this.user=e.user}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"groq",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??this.temperature,ls_max_tokens:t.max_tokens??this.maxTokens,ls_stop:e.stop}}async completionWithRetry(e,t){return this.caller.call(async()=>this.client.chat.completions.create(e,t))}invocationParams(e,t){var a;const r=super.invocationParams(e);let s={};(e==null?void 0:e.stream_options)!==void 0?s={stream_options:e.stream_options}:(this.streamUsage&&this.streaming||t!=null&&t.streaming)&&(s={stream_options:{include_usage:!0}});const i={model:this.model,frequency_penalty:this.frequencyPenalty,function_call:e==null?void 0:e.function_call,functions:e==null?void 0:e.functions,logit_bias:this.logitBias,logprobs:this.logprobs,n:this.n,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,presence_penalty:this.presencePenalty,reasoning_format:this.reasoningFormat,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,service_tier:this.serviceTier,stop:(e==null?void 0:e.stop)??this.stopSequences,temperature:(e==null?void 0:e.temperature)??this.temperature,tool_choice:ny(e==null?void 0:e.tool_choice),tools:(a=e==null?void 0:e.tools)!=null&&a.length?e.tools.map(o=>ji(o)):void 0,top_logprobs:this.topLogprobs,top_p:this.topP,user:this.user,stream:this.streaming,...r,...s};return i.max_completion_tokens=(e==null?void 0:e.max_completion_tokens)??(e==null?void 0:e.max_tokens)??this.maxTokens,i.max_completion_tokens===-1&&delete i.max_completion_tokens,i}bindTools(e,t){return this.withConfig({tools:e.map(r=>ji(r)),...t})}async*_streamResponseChunks(e,t,r){var u,p;const s=this.invocationParams(t,{streaming:!0}),i=nu(e),a=await this.completionWithRetry({...s,messages:i,stream:!0},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});let o,l,c;for await(const h of a){c=h;const d=h==null?void 0:h.choices[0];if(!d)continue;(u=d.delta)!=null&&u.role&&(o=d.delta.role);const m=ey(d.delta,o,h,l),y={prompt:t.promptIndex??0,completion:d.index??0};if(typeof m.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const f={...y};d.finish_reason!=null&&(f.finish_reason=d.finish_reason,f.system_fingerprint=h.system_fingerprint,f.model_name=h.model);const g=new Dt({message:m,text:m.content,generationInfo:f});yield g,await(r==null?void 0:r.handleLLMNewToken(g.text??"",y,void 0,void 0,void 0,{chunk:g}))}if(c&&("choices"in c&&delete c.choices,yield new Dt({message:new _n({content:"",response_metadata:c}),text:""})),(p=t.signal)==null?void 0:p.aborted)throw new Error("AbortError")}async _generate(e,t,r){var s;if(this.streaming){const i={},a=this._streamResponseChunks(e,t,r),o={};for await(const l of a){const c=((s=l.generationInfo)==null?void 0:s.completion)??0;o[c]===void 0?o[c]=l:o[c]=o[c].concat(l)}return{generations:Object.entries(o).sort(([l],[c])=>parseInt(l,10)-parseInt(c,10)).map(([l,c])=>c),llmOutput:{estimatedTokenUsage:i}}}else return this._generateNonStreaming(e,t,r)}async _generateNonStreaming(e,t,r){var c;const s={},i=this.invocationParams(t),a=nu(e),o=await this.completionWithRetry({...i,stream:!1,messages:a},{signal:t==null?void 0:t.signal,headers:t==null?void 0:t.headers});if("usage"in o&&o.usage){const{completion_tokens:u,prompt_tokens:p,total_tokens:h}=o.usage;u&&(s.completionTokens=(s.completionTokens??0)+u),p&&(s.promptTokens=(s.promptTokens??0)+p),h&&(s.totalTokens=(s.totalTokens??0)+h)}const l=[];if("choices"in o&&o.choices)for(const u of o.choices){const p=((c=u.message)==null?void 0:c.content)??"";let h;s.totalTokens!==void 0&&(h={input_tokens:s.promptTokens??0,output_tokens:s.completionTokens??0,total_tokens:s.totalTokens});const{choices:d,...m}=o,y={text:p,message:Yf(u.message??{role:"assistant"},h,m)};y.generationInfo={...u.finish_reason?{finish_reason:u.finish_reason}:{},...u.logprobs?{logprobs:u.logprobs}:{}},l.push(y)}return{generations:l,llmOutput:{tokenUsage:s}}}withStructuredOutput(e,t){const r=e,s=t==null?void 0:t.name,i=t==null?void 0:t.method,a=t==null?void 0:t.includeRaw;let o=s??"extract",l,c;if(i==="jsonMode")c=this.withConfig({response_format:{type:"json_object"}}),Ot(r)?l=ki.fromZodSchema(r):l=new Ur;else if(Ot(r)){const d=St(r);c=this.bindTools([{type:"function",function:{name:o,description:d.description,parameters:d}}]).withConfig({tool_choice:{type:"function",function:{name:o}}}),l=new Vr({returnSingle:!0,keyName:o,zodSchema:r})}else{let d;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(d=r,o=r.name):(o=r.title??o,d={name:o,description:r.description??"",parameters:r}),c=this.bindTools([{type:"function",function:d}]).withConfig({tool_choice:{type:"function",function:{name:o}}}),l=new Vr({returnSingle:!0,keyName:o})}if(!a)return c.pipe(l).withConfig({runName:"ChatGroqStructuredOutput"});const u=Nt.assign({parsed:(d,m)=>l.invoke(d.raw,m)}),p=Nt.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[p]});return ls.from([{raw:c},h]).withConfig({runName:"ChatGroqStructuredOutput"})}}function ny(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}var ru;(function(n){n.STRING="string",n.NUMBER="number",n.INTEGER="integer",n.BOOLEAN="boolean",n.ARRAY="array",n.OBJECT="object"})(ru||(ru={}));var su;(function(n){n.LANGUAGE_UNSPECIFIED="language_unspecified",n.PYTHON="python"})(su||(su={}));var iu;(function(n){n.OUTCOME_UNSPECIFIED="outcome_unspecified",n.OUTCOME_OK="outcome_ok",n.OUTCOME_FAILED="outcome_failed",n.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(iu||(iu={}));const au=["user","model","function","system"];var ou;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",n.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(ou||(ou={}));var lu;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(lu||(lu={}));var cu;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(cu||(cu={}));var uu;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(uu||(uu={}));var Qn;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.SPII="SPII",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.OTHER="OTHER"})(Qn||(Qn={}));var pu;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(pu||(pu={}));var gn;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE"})(gn||(gn={}));var hu;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(hu||(hu={}));class Ie extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class bn extends Ie{constructor(e,t){super(e),this.response=t}}class du extends Ie{constructor(e,t,r,s){super(e),this.status=t,this.statusText=r,this.errorDetails=s}}class jt extends Ie{}class mu extends Ie{}const ry="https://generativelanguage.googleapis.com",sy="v1beta",iy="0.24.1",ay="genai-js";var Ht;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(Ht||(Ht={}));class oy{constructor(e,t,r,s,i){this.model=e,this.task=t,this.apiKey=r,this.stream=s,this.requestOptions=i}toString(){var e,t;const r=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||sy;let s=`${((t=this.requestOptions)===null||t===void 0?void 0:t.baseUrl)||ry}/${r}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}}function ly(n){const e=[];return n!=null&&n.apiClient&&e.push(n.apiClient),e.push(`${ay}/${iy}`),e.join(" ")}async function cy(n){var e;const t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",ly(n.requestOptions)),t.append("x-goog-api-key",n.apiKey);let r=(e=n.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(r){if(!(r instanceof Headers))try{r=new Headers(r)}catch(s){throw new jt(`unable to convert customHeaders value ${JSON.stringify(r)} to Headers: ${s.message}`)}for(const[s,i]of r.entries()){if(s==="x-goog-api-key")throw new jt(`Cannot set reserved header name ${s}`);if(s==="x-goog-api-client")throw new jt(`Header name ${s} can only be set using the apiClient field`);t.append(s,i)}}return t}async function uy(n,e,t,r,s,i){const a=new oy(n,e,t,r,i);return{url:a.toString(),fetchOptions:Object.assign(Object.assign({},my(i)),{method:"POST",headers:await cy(a),body:s})}}async function Kn(n,e,t,r,s,i={},a=fetch){const{url:o,fetchOptions:l}=await uy(n,e,t,r,s,i);return py(o,l,a)}async function py(n,e,t=fetch){let r;try{r=await t(n,e)}catch(s){hy(s,n)}return r.ok||await dy(r,n),r}function hy(n,e){let t=n;throw t.name==="AbortError"?(t=new mu(`Request aborted when fetching ${e.toString()}: ${n.message}`),t.stack=n.stack):n instanceof du||n instanceof jt||(t=new Ie(`Error fetching from ${e.toString()}: ${n.message}`),t.stack=n.stack),t}async function dy(n,e){let t="",r;try{const s=await n.json();t=s.error.message,s.error.details&&(t+=` ${JSON.stringify(s.error.details)}`,r=s.error.details)}catch{}throw new du(`Error fetching from ${e.toString()}: [${n.status} ${n.statusText}] ${t}`,n.status,n.statusText,r)}function my(n){const e={};if((n==null?void 0:n.signal)!==void 0||(n==null?void 0:n.timeout)>=0){const t=new AbortController;(n==null?void 0:n.timeout)>=0&&setTimeout(()=>t.abort(),n.timeout),n!=null&&n.signal&&n.signal.addEventListener("abort",()=>{t.abort()}),e.signal=t.signal}return e}function zi(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),ts(n.candidates[0]))throw new bn(`${It(n)}`,n);return fy(n)}else if(n.promptFeedback)throw new bn(`Text not available. ${It(n)}`,n);return""},n.functionCall=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ts(n.candidates[0]))throw new bn(`${It(n)}`,n);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),fu(n)[0]}else if(n.promptFeedback)throw new bn(`Function call not available. ${It(n)}`,n)},n.functionCalls=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ts(n.candidates[0]))throw new bn(`${It(n)}`,n);return fu(n)}else if(n.promptFeedback)throw new bn(`Function call not available. ${It(n)}`,n)},n}function fy(n){var e,t,r,s;const i=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const a of(s=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||s===void 0?void 0:s.parts)a.text&&i.push(a.text),a.executableCode&&i.push("\n```"+a.executableCode.language+`
`+a.executableCode.code+"\n```\n"),a.codeExecutionResult&&i.push("\n```\n"+a.codeExecutionResult.output+"\n```\n");return i.length>0?i.join(""):""}function fu(n){var e,t,r,s;const i=[];if(!((t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0)&&t.parts)for(const a of(s=(r=n.candidates)===null||r===void 0?void 0:r[0].content)===null||s===void 0?void 0:s.parts)a.functionCall&&i.push(a.functionCall);if(i.length>0)return i}const yy=[Qn.RECITATION,Qn.SAFETY,Qn.LANGUAGE];function ts(n){return!!n.finishReason&&yy.includes(n.finishReason)}function It(n){var e,t,r;let s="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)s+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(s+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(s+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){const i=n.candidates[0];ts(i)&&(s+=`Candidate was blocked due to ${i.finishReason}`,i.finishMessage&&(s+=`: ${i.finishMessage}`))}return s}function Jn(n){return this instanceof Jn?(this.v=n,this):new Jn(n)}function gy(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),s,i=[];return s={},a("next"),a("throw"),a("return"),s[Symbol.asyncIterator]=function(){return this},s;function a(h){r[h]&&(s[h]=function(d){return new Promise(function(m,y){i.push([h,d,m,y])>1||o(h,d)})})}function o(h,d){try{l(r[h](d))}catch(m){p(i[0][3],m)}}function l(h){h.value instanceof Jn?Promise.resolve(h.value.v).then(c,u):p(i[0][2],h)}function c(h){o("next",h)}function u(h){o("throw",h)}function p(h,d){h(d),i.shift(),i.length&&o(i[0][0],i[0][1])}}const yu=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function by(n){const e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=vy(e),[r,s]=t.tee();return{stream:_y(r),response:wy(s)}}async function wy(n){const e=[],t=n.getReader();for(;;){const{done:r,value:s}=await t.read();if(r)return zi(xy(e));e.push(s)}}function _y(n){return gy(this,arguments,function*(){const e=n.getReader();for(;;){const{value:t,done:r}=yield Jn(e.read());if(r)break;yield yield Jn(zi(t))}})}function vy(n){const e=n.getReader();return new ReadableStream({start(t){let r="";return s();function s(){return e.read().then(({value:i,done:a})=>{if(a){if(r.trim()){t.error(new Ie("Failed to parse stream"));return}t.close();return}r+=i;let o=r.match(yu),l;for(;o;){try{l=JSON.parse(o[1])}catch{t.error(new Ie(`Error parsing JSON response: "${o[1]}"`));return}t.enqueue(l),r=r.substring(o[0].length),o=r.match(yu)}return s()}).catch(i=>{let a=i;throw a.stack=i.stack,a.name==="AbortError"?a=new mu("Request aborted when reading from the stream"):a=new Ie("Error reading from the stream"),a})}}})}function xy(n){const e=n[n.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(const r of n){if(r.candidates){let s=0;for(const i of r.candidates)if(t.candidates||(t.candidates=[]),t.candidates[s]||(t.candidates[s]={index:s}),t.candidates[s].citationMetadata=i.citationMetadata,t.candidates[s].groundingMetadata=i.groundingMetadata,t.candidates[s].finishReason=i.finishReason,t.candidates[s].finishMessage=i.finishMessage,t.candidates[s].safetyRatings=i.safetyRatings,i.content&&i.content.parts){t.candidates[s].content||(t.candidates[s].content={role:i.content.role||"user",parts:[]});const a={};for(const o of i.content.parts)o.text&&(a.text=o.text),o.functionCall&&(a.functionCall=o.functionCall),o.executableCode&&(a.executableCode=o.executableCode),o.codeExecutionResult&&(a.codeExecutionResult=o.codeExecutionResult),Object.keys(a).length===0&&(a.text=""),t.candidates[s].content.parts.push(a)}s++}r.usageMetadata&&(t.usageMetadata=r.usageMetadata)}return t}async function gu(n,e,t,r){const s=await Kn(e,Ht.STREAM_GENERATE_CONTENT,n,!0,JSON.stringify(t),r);return by(s)}async function bu(n,e,t,r){const s=await(await Kn(e,Ht.GENERATE_CONTENT,n,!1,JSON.stringify(t),r)).json();return{response:zi(s)}}function wu(n){if(n!=null){if(typeof n=="string")return{role:"system",parts:[{text:n}]};if(n.text)return{role:"system",parts:[n]};if(n.parts)return n.role?n:{role:"system",parts:n.parts}}}function Hn(n){let e=[];if(typeof n=="string")e=[{text:n}];else for(const t of n)typeof t=="string"?e.push({text:t}):e.push(t);return Oy(e)}function Oy(n){const e={role:"user",parts:[]},t={role:"function",parts:[]};let r=!1,s=!1;for(const i of n)"functionResponse"in i?(t.parts.push(i),s=!0):(e.parts.push(i),r=!0);if(r&&s)throw new Ie("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!s)throw new Ie("No content is provided for sending chat message.");return r?e:t}function My(n,e){var t;let r={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(t=e==null?void 0:e.cachedContent)===null||t===void 0?void 0:t.name,contents:[]};const s=n.generateContentRequest!=null;if(n.contents){if(s)throw new jt("CountTokensRequest must have one of contents or generateContentRequest, not both.");r.contents=n.contents}else if(s)r=Object.assign(Object.assign({},r),n.generateContentRequest);else{const i=Hn(n);r.contents=[i]}return{generateContentRequest:r}}function _u(n){let e;return n.contents?e=n:e={contents:[Hn(n)]},n.systemInstruction&&(e.systemInstruction=wu(n.systemInstruction)),e}function Ey(n){return typeof n=="string"||Array.isArray(n)?{content:Hn(n)}:n}const vu=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],Cy={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function Ay(n){let e=!1;for(const t of n){const{role:r,parts:s}=t;if(!e&&r!=="user")throw new Ie(`First content should be with role 'user', got ${r}`);if(!au.includes(r))throw new Ie(`Each item should include role field. Got ${r} but valid roles are: ${JSON.stringify(au)}`);if(!Array.isArray(s))throw new Ie("Content should have 'parts' property with an array of Parts");if(s.length===0)throw new Ie("Each Content should have at least one part");const i={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const o of s)for(const l of vu)l in o&&(i[l]+=1);const a=Cy[r];for(const o of vu)if(!a.includes(o)&&i[o]>0)throw new Ie(`Content with role '${r}' can't contain '${o}' part`);e=!0}}function xu(n){var e;if(n.candidates===void 0||n.candidates.length===0)return!1;const t=(e=n.candidates[0])===null||e===void 0?void 0:e.content;if(t===void 0||t.parts===void 0||t.parts.length===0)return!1;for(const r of t.parts)if(r===void 0||Object.keys(r).length===0||r.text!==void 0&&r.text==="")return!1;return!0}const Ou="SILENT_ERROR";class Sy{constructor(e,t,r,s={}){this.model=t,this.params=r,this._requestOptions=s,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r!=null&&r.history&&(Ay(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var r,s,i,a,o,l;await this._sendPromise;const c=Hn(e),u={safetySettings:(r=this.params)===null||r===void 0?void 0:r.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(i=this.params)===null||i===void 0?void 0:i.tools,toolConfig:(a=this.params)===null||a===void 0?void 0:a.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(l=this.params)===null||l===void 0?void 0:l.cachedContent,contents:[...this._history,c]},p=Object.assign(Object.assign({},this._requestOptions),t);let h;return this._sendPromise=this._sendPromise.then(()=>bu(this._apiKey,this.model,u,p)).then(d=>{var m;if(xu(d.response)){this._history.push(c);const y=Object.assign({parts:[],role:"model"},(m=d.response.candidates)===null||m===void 0?void 0:m[0].content);this._history.push(y)}else{const y=It(d.response);y&&console.warn(`sendMessage() was unsuccessful. ${y}. Inspect response object for details.`)}h=d}).catch(d=>{throw this._sendPromise=Promise.resolve(),d}),await this._sendPromise,h}async sendMessageStream(e,t={}){var r,s,i,a,o,l;await this._sendPromise;const c=Hn(e),u={safetySettings:(r=this.params)===null||r===void 0?void 0:r.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(i=this.params)===null||i===void 0?void 0:i.tools,toolConfig:(a=this.params)===null||a===void 0?void 0:a.toolConfig,systemInstruction:(o=this.params)===null||o===void 0?void 0:o.systemInstruction,cachedContent:(l=this.params)===null||l===void 0?void 0:l.cachedContent,contents:[...this._history,c]},p=Object.assign(Object.assign({},this._requestOptions),t),h=gu(this._apiKey,this.model,u,p);return this._sendPromise=this._sendPromise.then(()=>h).catch(d=>{throw new Error(Ou)}).then(d=>d.response).then(d=>{if(xu(d)){this._history.push(c);const m=Object.assign({},d.candidates[0].content);m.role||(m.role="model"),this._history.push(m)}else{const m=It(d);m&&console.warn(`sendMessageStream() was unsuccessful. ${m}. Inspect response object for details.`)}}).catch(d=>{d.message!==Ou&&console.error(d)}),h}}async function Py(n,e,t,r){return(await Kn(e,Ht.COUNT_TOKENS,n,!1,JSON.stringify(t),r)).json()}async function ky(n,e,t,r){return(await Kn(e,Ht.EMBED_CONTENT,n,!1,JSON.stringify(t),r)).json()}async function Ty(n,e,t,r){const s=t.requests.map(i=>Object.assign(Object.assign({},i),{model:e}));return(await Kn(e,Ht.BATCH_EMBED_CONTENTS,n,!1,JSON.stringify({requests:s}),r)).json()}class Mu{constructor(e,t,r={}){this.apiKey=e,this._requestOptions=r,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=wu(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var r;const s=_u(e),i=Object.assign(Object.assign({},this._requestOptions),t);return bu(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(r=this.cachedContent)===null||r===void 0?void 0:r.name},s),i)}async generateContentStream(e,t={}){var r;const s=_u(e),i=Object.assign(Object.assign({},this._requestOptions),t);return gu(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(r=this.cachedContent)===null||r===void 0?void 0:r.name},s),i)}startChat(e){var t;return new Sy(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(t=this.cachedContent)===null||t===void 0?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const r=My(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),t);return Py(this.apiKey,this.model,r,s)}async embedContent(e,t={}){const r=Ey(e),s=Object.assign(Object.assign({},this._requestOptions),t);return ky(this.apiKey,this.model,r,s)}async batchEmbedContents(e,t={}){const r=Object.assign(Object.assign({},this._requestOptions),t);return Ty(this.apiKey,this.model,e,r)}}hs=class{constructor(n){this.apiKey=n}getGenerativeModel(n,e){if(!n.model)throw new Ie("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Mu(this.apiKey,n,e)}getGenerativeModelFromCachedContent(n,e,t){if(!n.name)throw new jt("Cached content must contain a `name` field.");if(!n.model)throw new jt("Cached content must contain a `model` field.");const r=["model","systemInstruction"];for(const i of r)if(e!=null&&e[i]&&n[i]&&(e==null?void 0:e[i])!==n[i]){if(i==="model"){const a=e.model.startsWith("models/")?e.model.replace("models/",""):e.model,o=n.model.startsWith("models/")?n.model.replace("models/",""):n.model;if(a===o)continue}throw new jt(`Different value for "${i}" specified in modelParams (${e[i]}) and cachedContent (${n[i]})`)}const s=Object.assign(Object.assign({},e),{model:n.model,tools:n.tools,toolConfig:n.toolConfig,systemInstruction:n.systemInstruction,cachedContent:n});return new Mu(this.apiKey,s,t)}};function Gt(n){if(typeof n=="object"&&n!==null){const e={...n};"additionalProperties"in e&&delete e.additionalProperties,"$schema"in e&&delete e.$schema,"strict"in e&&delete e.strict;for(const t in e)t in e&&(Array.isArray(e[t])?e[t]=e[t].map(Gt):typeof e[t]=="object"&&e[t]!==null&&(e[t]=Gt(e[t])));return e}return n}function Qi(n){const e=Gt(Ot(n)?St(n):n),{$schema:t,...r}=e;return r}function Ry(n){const e=Gt(n),{$schema:t,...r}=e;return r}const Te=[];for(let n=0;n<256;++n)Te.push((n+256).toString(16).slice(1));function Ny(n,e=0){return(Te[n[e+0]]+Te[n[e+1]]+Te[n[e+2]]+Te[n[e+3]]+"-"+Te[n[e+4]]+Te[n[e+5]]+"-"+Te[n[e+6]]+Te[n[e+7]]+"-"+Te[n[e+8]]+Te[n[e+9]]+"-"+Te[n[e+10]]+Te[n[e+11]]+Te[n[e+12]]+Te[n[e+13]]+Te[n[e+14]]+Te[n[e+15]]).toLowerCase()}let Ki;const jy=new Uint8Array(16);function Iy(){if(!Ki){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ki=crypto.getRandomValues.bind(crypto)}return Ki(jy)}const $y=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Eu={randomUUID:$y};function Cu(n,e,t){var s;if(Eu.randomUUID&&!e&&!n)return Eu.randomUUID();n=n||{};const r=n.random??((s=n.rng)==null?void 0:s.call(n))??Iy();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Ny(r)}function Ly(n){const e=n._getType();return us.isInstance(n)?n.role:e==="tool"?e:n.name??e}function By(n){switch(n){case"supervisor":case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function qy(n){if("mimeType"in n&&"data"in n)return{inlineData:{mimeType:n.mimeType,data:n.data}};if("mimeType"in n&&"fileUri"in n)return{fileData:{mimeType:n.mimeType,fileUri:n.fileUri}};throw new Error("Invalid media content")}function Dy(n,e){var t;return(t=e.map(r=>qt(r)?r.tool_calls??[]:[]).flat().find(r=>r.id===n.tool_call_id))==null?void 0:t.name}function Fy(n){return{providerName:"Google Gemini",fromStandardTextBlock(e){return{text:e.text}},fromStandardImageBlock(e){if(!n)throw new Error("This model does not support images");if(e.source_type==="url"){const t=Xn({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)},fromStandardAudioBlock(e){if(!n)throw new Error("This model does not support audio");if(e.source_type==="url"){const t=Xn({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)},fromStandardFileBlock(e){if(!n)throw new Error("This model does not support files");if(e.source_type==="text")return{text:e.text};if(e.source_type==="url"){const t=Xn({dataUrl:e.url});return t?{inlineData:{mimeType:t.mime_type,data:t.data}}:{fileData:{mimeType:e.mime_type??"",fileUri:e.url}}}if(e.source_type==="base64")return{inlineData:{mimeType:e.mime_type??"",data:e.data}};throw new Error(`Unsupported source type: ${e.source_type}`)}}}function Au(n,e){var t;if(Xi(n))return Yi(n,Fy(e));if(n.type==="text")return{text:n.text};if(n.type==="executableCode")return{executableCode:n.executableCode};if(n.type==="codeExecutionResult")return{codeExecutionResult:n.codeExecutionResult};if(n.type==="image_url"){if(!e)throw new Error("This model does not support images");let r;if(typeof n.image_url=="string")r=n.image_url;else if(typeof n.image_url=="object"&&"url"in n.image_url)r=n.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");const[s,i]=r.split(",");if(!s.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[a,o]=s.replace(/^data:/,"").split(";");if(o!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:i,mimeType:a}}}else{if(n.type==="media")return qy(n);if(n.type==="tool_use")return{functionCall:{name:n.name,args:n.input}};if((t=n.type)!=null&&t.includes("/")&&n.type.split("/").length===2&&"data"in n&&typeof n.data=="string")return{inlineData:{mimeType:n.type,data:n.data}};if("functionCall"in n)return;throw"type"in n?new Error(`Unknown content type ${n.type}`):new Error(`Unknown content ${JSON.stringify(n)}`)}}function Uy(n,e,t){var i;if(Ig(n)){const a=n.name??Dy(n,t);if(a===void 0)throw new Error(`Google requires a tool name for each tool call response, and we could not infer a called tool name for ToolMessage "${n.id}" from your passed messages. Please populate a "name" field on that ToolMessage explicitly.`);const o=Array.isArray(n.content)?n.content.map(l=>Au(l,e)).filter(l=>l!==void 0):n.content;return n.status==="error"?[{functionResponse:{name:a,response:{error:{details:o}}}}]:[{functionResponse:{name:a,response:{result:o}}}]}let r=[];const s=[];return typeof n.content=="string"&&n.content&&s.push({text:n.content}),Array.isArray(n.content)&&s.push(...n.content.map(a=>Au(a,e)).filter(a=>a!==void 0)),qt(n)&&((i=n.tool_calls)!=null&&i.length)&&(r=n.tool_calls.map(a=>({functionCall:{name:a.name,args:a.args}}))),[...s,...r]}function Su(n,e,t=!1){return n.reduce((r,s,i)=>{if(!Zi(s))throw new Error("Unsupported message input");const a=Ly(s);if(a==="system"&&i!==0)throw new Error("System message should be the first one");const o=By(a),l=r.content[r.content.length];if(!r.mergeWithPreviousContent&&l&&l.role===o)throw new Error("Google Generative AI requires alternate messages between authors");const c=Uy(s,e,n.slice(0,i));if(r.mergeWithPreviousContent){const h=r.content[r.content.length-1];if(!h)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return h.parts.push(...c),{mergeWithPreviousContent:!1,content:r.content}}let u=o;(u==="function"||u==="system"&&!t)&&(u="user");const p={role:u,parts:c};return{mergeWithPreviousContent:a==="system"&&!t,content:[...r.content,p]}},{content:[],mergeWithPreviousContent:!1}).content}function Wy(n,e){var l,c,u,p;if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};const t=n.functionCalls(),[r]=n.candidates,{content:s,...i}=r;let a;Array.isArray(s==null?void 0:s.parts)&&s.parts.length===1&&s.parts[0].text?a=s.parts[0].text:Array.isArray(s==null?void 0:s.parts)&&s.parts.length>0?a=s.parts.map(h=>"text"in h?{type:"text",text:h.text}:"executableCode"in h?{type:"executableCode",executableCode:h.executableCode}:"codeExecutionResult"in h?{type:"codeExecutionResult",codeExecutionResult:h.codeExecutionResult}:h):a=[];let o="";return typeof a=="string"?o=a:Array.isArray(a)&&a.length>0&&(o=((l=a.find(h=>"text"in h))==null?void 0:l.text)??o),{generations:[{text:o,message:new At({content:a??"",tool_calls:t==null?void 0:t.map(h=>({...h,type:"tool_call",id:"id"in h&&typeof h.id=="string"?h.id:Cu()})),additional_kwargs:{...i},usage_metadata:e==null?void 0:e.usageMetadata}),generationInfo:i}],llmOutput:{tokenUsage:{promptTokens:(c=e==null?void 0:e.usageMetadata)==null?void 0:c.input_tokens,completionTokens:(u=e==null?void 0:e.usageMetadata)==null?void 0:u.output_tokens,totalTokens:(p=e==null?void 0:e.usageMetadata)==null?void 0:p.total_tokens}}}}function Vy(n,e){var c;if(!n.candidates||n.candidates.length===0)return null;const t=n.functionCalls(),[r]=n.candidates,{content:s,...i}=r;let a;Array.isArray(s==null?void 0:s.parts)&&s.parts.every(u=>"text"in u)?a=s.parts.map(u=>u.text).join(""):Array.isArray(s==null?void 0:s.parts)?a=s.parts.map(u=>"text"in u?{type:"text",text:u.text}:"executableCode"in u?{type:"executableCode",executableCode:u.executableCode}:"codeExecutionResult"in u?{type:"codeExecutionResult",codeExecutionResult:u.codeExecutionResult}:u):a=[];let o="";a&&typeof a=="string"?o=a:Array.isArray(a)&&(o=((c=a.find(u=>"text"in u))==null?void 0:c.text)??"");const l=[];return t&&l.push(...t.map(u=>({...u,args:JSON.stringify(u.args),index:e.index,type:"tool_call_chunk",id:"id"in u&&typeof u.id=="string"?u.id:Cu()}))),new Dt({text:o,message:new _n({content:a||"",name:s?s.role:void 0,tool_call_chunks:l,additional_kwargs:{},usage_metadata:e.usageMetadata}),generationInfo:i})}function zy(n){return n.every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?n:[{functionDeclarations:n.map(e=>{if(Kr(e)){const t=Qi(e.schema);return t.type==="object"&&"properties"in t&&Object.keys(t.properties).length===0?{name:e.name,description:e.description}:{name:e.name,description:e.description,parameters:t}}return Dr(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:Ry(e.function.parameters)}:e})}]}class Pu extends Zl{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;const t=await pp(this.zodSchema,e);if(t.success)return t.data;throw new Fr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.issues)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap(s=>{const{message:i}=s;return!("tool_calls"in i)||!Array.isArray(i.tool_calls)?[]:i.tool_calls});if(t[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[r]=t;return await this._validateResult(r.args)}}function ku(n,e){const t=Qy(n),r=Jy(t,e);return{tools:t,toolConfig:r}}function Qy(n){let e=[];const t=[];return n.forEach(r=>{if(Kr(r)){const[s]=zy([r]);s.functionDeclarations&&e.push(...s.functionDeclarations)}else if(Dr(r)){const{functionDeclarations:s}=Ky(r);if(s)e.push(...s);else throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else t.push(r)}),t.find(r=>"functionDeclarations"in r)?t.map(r=>{if((e==null?void 0:e.length)>0&&"functionDeclarations"in r){const s={functionDeclarations:[...r.functionDeclarations||[],...e]};return e=[],s}return r}):[...t,...e.length>0?[{functionDeclarations:e}]:[]]}function Ky(n){return{functionDeclarations:[{name:n.function.name,description:n.function.description,parameters:Gt(n.function.parameters)}]}}function Jy(n,e){if(!n.length||!e)return;const{toolChoice:t,allowedFunctionNames:r}=e,s={any:gn.ANY,auto:gn.AUTO,none:gn.NONE};if(t&&["any","auto","none"].includes(t))return{functionCallingConfig:{mode:s[t]??"MODE_UNSPECIFIED",allowedFunctionNames:r}};if(typeof t=="string"||r)return{functionCallingConfig:{mode:gn.ANY,allowedFunctionNames:[...r??[],...t&&typeof t=="string"?[t]:[]]}}}class Hy extends gt{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"json",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e.model.replace(/^models\//,""),this.maxOutputTokens=e.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw new Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=e.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e.stopSequences??this.stopSequences,this.apiKey=e.apiKey??cs("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(t=>t.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=e.streaming??this.streaming,this.json=e.json,this.client=new hs(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...this.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e.apiVersion,baseUrl:e.baseUrl}),this.streamUsage=e.streamUsage??this.streamUsage}useCachedContent(e,t,r){this.apiKey&&(this.client=new hs(this.apiKey).getGenerativeModelFromCachedContent(e,t,r))}get useSystemInstruction(){return typeof this.convertSystemMessageToHumanContent=="boolean"?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return this.model==="gemini-1.0-pro-001"||this.model.startsWith("gemini-pro-vision")||this.model.startsWith("gemini-1.0-pro-vision")?!1:this.model!=="gemini-pro"}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){var r;return this.withConfig({tools:(r=ku(e))==null?void 0:r.tools,...t})}invocationParams(e){var r;const t=(r=e==null?void 0:e.tools)!=null&&r.length?ku(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return e!=null&&e.responseSchema?(this.client.generationConfig.responseSchema=e.responseSchema,this.client.generationConfig.responseMimeType="application/json"):(this.client.generationConfig.responseSchema=void 0,this.client.generationConfig.responseMimeType=this.json?"application/json":void 0),{...t!=null&&t.tools?{tools:t.tools}:{},...t!=null&&t.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,r){var u,p,h;const s=Su(e,this._isMultimodalModel,this.useSystemInstruction);let i=s;if(s[0].role==="system"){const[d]=s;this.client.systemInstruction=d,i=s.slice(1)}const a=this.invocationParams(t);if(this.streaming){const d={},m=this._streamResponseChunks(e,t,r),y={};for await(const f of m){const g=((u=f.generationInfo)==null?void 0:u.completion)??0;y[g]===void 0?y[g]=f:y[g]=y[g].concat(f)}return{generations:Object.entries(y).sort(([f],[g])=>parseInt(f,10)-parseInt(g,10)).map(([f,g])=>g),llmOutput:{estimatedTokenUsage:d}}}const o=await this.completionWithRetry({...a,contents:i});let l;if("usageMetadata"in o.response){const d=o.response.usageMetadata;l={input_tokens:d.promptTokenCount??0,output_tokens:d.candidatesTokenCount??0,total_tokens:d.totalTokenCount??0}}const c=Wy(o.response,{usageMetadata:l});return((p=c.generations)==null?void 0:p.length)>0&&await(r==null?void 0:r.handleLLMNewToken(((h=c.generations[0])==null?void 0:h.text)??"")),c}async*_streamResponseChunks(e,t,r){const s=Su(e,this._isMultimodalModel,this.useSystemInstruction);let i=s;if(s[0].role==="system"){const[u]=s;this.client.systemInstruction=u,i=s.slice(1)}const a={...this.invocationParams(t),contents:i},o=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{const{stream:u}=await this.client.generateContentStream(a);return u});let l,c=0;for await(const u of o){if("usageMetadata"in u&&this.streamUsage!==!1&&t.streamUsage!==!1){const h=u.usageMetadata;if(!l)l={input_tokens:h.promptTokenCount??0,output_tokens:h.candidatesTokenCount??0,total_tokens:h.totalTokenCount??0};else{const d=(h.candidatesTokenCount??0)-l.output_tokens;l={input_tokens:0,output_tokens:d,total_tokens:d}}}const p=Vy(u,{usageMetadata:l,index:c});c+=1,p&&(yield p,await(r==null?void 0:r.handleLLMNewToken(p.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var r;try{return await this.client.generateContent(e)}catch(s){throw(r=s.message)!=null&&r.includes("400 Bad Request")&&(s.status=400),s}})}withStructuredOutput(e,t){const r=e,s=t==null?void 0:t.name,i=t==null?void 0:t.method,a=t==null?void 0:t.includeRaw;if(i==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "jsonSchema" or "functionCalling" as a method.');let o,l;if(i==="functionCalling"){let h=s??"extract",d;if(Ot(r)){const m=Qi(r);d=[{functionDeclarations:[{name:h,description:m.description??"A function available to call.",parameters:m}]}],l=new Pu({returnSingle:!0,keyName:h,zodSchema:r})}else{let m;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(m=r,m.parameters=Gt(r.parameters),h=r.name):m={name:h,description:r.description??"",parameters:Gt(r)},d=[{functionDeclarations:[m]}],l=new Pu({returnSingle:!0,keyName:h})}o=this.bindTools(d).withConfig({allowedFunctionNames:[h]})}else{const h=Qi(r);o=this.withConfig({responseSchema:h}),l=new Ur}if(!a)return o.pipe(l).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const c=Nt.assign({parsed:(h,d)=>l.invoke(h.raw,d)}),u=Nt.assign({parsed:()=>null}),p=c.withFallbacks({fallbacks:[u]});return ls.from([{raw:o},p]).withConfig({runName:"StructuredOutputRunnable"})}}let ns,Tu,Ru,Nu,ju,Iu,$u,Lu,Bu,qu,Du,Fu,Uu,Wu,Vu,zu;ns=async(n,e,{schemas:t,onMessageUpdate:r})=>{let s="",i;if(t!=null&&t.length){const a=t[0],o=await n.withStructuredOutput(a.schema).stream(e);for await(const l of o)s=JSON.stringify(l),r==null||r({content:s})}else{const a=await n.stream(e);for await(const o of a)s+=`${o.content}`,i=o,r==null||r({content:s,chunk:o})}return{lastChunk:i,content:s}},Tu={async stream(n,e){var p,h,d,m,y;const{schemas:t,onMessageUpdate:r,onMessageFinish:s}=e||{};let i=e==null?void 0:e.passphrase;if(!i&&(i=await as.get("passphrase")||void 0,!i))throw new Error("Passphrase is required. Either provide it as parameter, ensure it exists in secure session, or provide confirmPassphrase function.");const a=(p=e==null?void 0:e.llm)==null?void 0:p.encrypted,o=((h=e==null?void 0:e.llm)==null?void 0:h.options)||{};if(!(a!=null&&a.key)||typeof a.key!="string")throw new Error("API Key is not found");const l=await Yn(a.key,i);if(!l)throw new Error("API Key is not found");let c="",u;switch(e==null?void 0:e.provider){case Ye.GoogleGenerativeAI:{const f=new Hy({apiKey:l,model:((d=e==null?void 0:e.llm)==null?void 0:d.name)||"gemini-1.5-flash",temperature:o!=null&&o.temperature?+o.temperature:void 0,topK:o!=null&&o.topK?+o.topK:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxOutputTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0});if(a!=null&&a.enabled_google_search_retrieval){const b={googleSearchRetrieval:{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.7}}};f.bindTools([b])}const g=await ns(f,n,{schemas:t,onMessageUpdate:r});c=g.content,u=g.lastChunk}break;case Ye.Groq:{const f=new ty({apiKey:l,model:((m=e==null?void 0:e.llm)==null?void 0:m.name)||"",temperature:o!=null&&o.temperature?+o.temperature:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),g=await ns(f,n,{schemas:t,onMessageUpdate:r});c=g.content,u=g.lastChunk}break;case Ye.OpenAI:{const f=new wf({apiKey:l,model:(y=e==null?void 0:e.llm)==null?void 0:y.name,temperature:o!=null&&o.temperature?+o.temperature:void 0,topP:o!=null&&o.topP?+o.topP:void 0,stopSequences:o!=null&&o.stop?o.stop:void 0,maxTokens:o!=null&&o.maxTokens?+o.maxTokens:void 0}),g=await ns(f,n,{schemas:t,onMessageUpdate:r});c=g.content,u=g.lastChunk}break;default:throw new Error("Provider is not supported")}return s==null||s({content:c,lastChunk:u}),{lastChunk:u,content:c}}},wp={async loadModel(n,e,t){switch(n){case Ye.WebLLM:return await Yu.getState().loadModel(e,{provider:n,callback:t==null?void 0:t.callback});case Ye.Wllama:return await ep(e,{provider:n,callback:t==null?void 0:t.callback});default:throw new Error(`Load model not supported for provider: ${n}`)}},async stream(n,e,t){switch(n){case Ye.WebLLM:case Ye.Wllama:return Lh.stream(e,t);case Ye.GoogleGenerativeAI:case Ye.Groq:case Ye.OpenAI:return Tu.stream(e,{...t,provider:n});default:throw new Error(`Provider ${n} is not supported`)}}},Op=()=>{const{toast:n}=rg(),{t:e}=Gu("errors"),t=$g(s=>s.currentSession),{modalRef:r}=ra(na);return{confirmPassphrase:E.useCallback(async()=>{t!=null&&t.passphrase&&(await as.exists("passphrase")||await new Promise((s,i)=>{r.current.show({onConfirm:async a=>{try{const o=await Yn(t.passphrase,a);await as.set("passphrase",o),s()}catch(o){n({content:e("invalid_passphrase"),variant:"destructive"}),i(o)}finally{r.current.hide()}},onCancel:()=>{i()}})}))},[t==null?void 0:t.passphrase,r,e,n])}},Ru=n=>E.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",fill:"none",height:192,viewBox:"0 0 150 150",width:192,...n},E.createElement("clipPath",{id:"a"},E.createElement("path",{d:"m0 0h150v150h-150z"})),E.createElement("g",{clipPath:"url(#a)"},E.createElement("path",{d:"m150 0h-150v150h150z",fill:"#29b5e8"}),E.createElement("path",{clipRule:"evenodd",d:"m130.375 67.2532-14.096 8.1221 14.096 8.0536c.843.4872 1.581 1.1357 2.174 1.9084.592.7727 1.026 1.6545 1.278 2.5951.251.9406.315 1.9215.188 2.8867-.128.9652-.444 1.8959-.931 2.7388-.488.843-1.136 1.5817-1.909 2.174s-1.654 1.0267-2.595 1.2782-1.921.3154-2.887.1878c-.965-.1275-1.896-.444-2.739-.9312l-25.2559-14.5496c-1.1575-.6696-2.1128-1.6394-2.765-2.8068-.6523-1.1674-.9773-2.4893-.9408-3.826.0198-.5792.1089-1.1538.2653-1.7117.517-1.8711 1.7458-3.4654 3.4234-4.4419l25.256-14.4983c.847-.4892 1.782-.8067 2.751-.9343.97-.1275 1.955-.0627 2.899.1909.945.2536 1.83.6909 2.605 1.287.775.596 1.425 1.3391 1.913 2.1866.49.8402.808 1.7693.935 2.7334.128.964.063 1.9439-.191 2.8826-.254.9388-.692 1.8177-1.288 2.5859-.597.7681-1.34 1.4101-2.186 1.8887zm-13.343 39.3698-25.2478-14.5243c-1.1296-.6483-2.4091-.9896-3.7115-.9902s-2.5823.3397-3.7124.987c-1.1301.6472-2.0712 1.579-2.7297 2.7026-.6585 1.1237-1.0115 2.4001-1.0239 3.7024v29.0135c.0654 1.928.8772 3.755 2.264 5.095 1.3869 1.341 3.2403 2.09 5.1691 2.09 1.9289 0 3.7823-.749 5.1691-2.09 1.3868-1.34 2.1986-3.167 2.264-5.095v-16.261l14.1301 8.122c.843.488 1.774.805 2.739.933.966.128 1.947.064 2.888-.187s1.823-.685 2.596-1.277c.774-.592 1.423-1.331 1.91-2.174.488-.843.805-1.773.933-2.739.128-.965.065-1.946-.186-2.887s-.685-1.824-1.277-2.597-1.331-1.422-2.174-1.91zm-29.0992-28.3806-10.527 10.3986c-.3601.3349-.8269.5319-1.318.5563h-3.0897c-.49-.0294-.9551-.2257-1.318-.5563l-10.4671-10.4329c-.3274-.3573-.521-.817-.5478-1.3009v-3.081c.0283-.4861.2215-.9481.5478-1.3095l10.4671-10.4329c.3637-.3281.829-.5214 1.318-.5477h3.0897c.4899.0228.9562.2166 1.318.5477l10.4928 10.4329c.3237.3623.514.8243.5392 1.3095v3.081c-.0237.483-.2143.9428-.5392 1.3009zm-8.3874-2.8928c-.0404-.499-.2485-.9696-.5905-1.3352l-3.0383-3.004c-.3641-.3275-.8291-.5207-1.318-.5478h-.1113c-.4867.0255-.9495.2191-1.3094.5478l-3.0383 3.004c-.3262.3676-.5165.8358-.5392 1.3266v.1113c.0215.4834.2124.9439.5392 1.3009l3.0554 2.9955c.3607.3274.823.5208 1.3094.5477h.1113c.4889-.027.9539-.2203 1.318-.5477l3.0383-3.0212c.3282-.3576.5244-.8166.5563-1.3009zm-47.4914-31.2217 25.2563 14.4811c1.1308.648 2.4115.989 3.7149.9889 1.3033 0 2.584-.3409 3.7148-.989 1.1309-.648 2.0725-1.5806 2.7314-2.7051.659-1.1245 1.0123-2.4018 1.0249-3.7051v-28.9879c-.0654-1.9277-.8772-3.7546-2.264-5.0952s-3.2402-2.0899-5.1691-2.0899c-1.9288 0-3.7822.7493-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v16.2613l-14.1473-8.1307c-.8429-.4877-1.7737-.8047-2.7392-.9328-.9654-.1281-1.9466-.0647-2.8876.1864s-1.8232.6852-2.5965 1.2773c-.7732.5921-1.4222 1.3307-1.91 2.1736-.4878.843-.8048 1.7738-.9329 2.7392-.128.9655-.0647 1.9467.1864 2.8876.2512.941.6852 1.8233 1.2773 2.5965.5921.7733 1.3307 1.4223 2.1737 1.9101zm55.4252 15.4739c1.4914.118 2.9836-.2193 4.2793-.9671l25.2475-14.5496c.843-.4877 1.582-1.1368 2.174-1.91s1.026-1.6555 1.277-2.5965.315-1.9222.187-2.8876c-.128-.9655-.445-1.8962-.933-2.7392-.488-.8429-1.137-1.5816-1.91-2.1737-.774-.5921-1.656-1.0261-2.597-1.2772-1.9-.5072-3.924-.2387-5.627.7464l-14.1298 8.1991v-16.2613c-.0654-1.9277-.8772-3.7546-2.264-5.0952-1.3868-1.3405-3.2402-2.0899-5.1691-2.0899-1.9288 0-3.7822.7494-5.169 2.0899-1.3869 1.3406-2.1987 3.1675-2.2641 5.0952v29.0136c-.0023 1.8784.7086 3.6876 1.9892 5.0619 1.2805 1.3743 3.0351 2.2111 4.909 2.3412zm-25.8554 31.5298c-1.4916-.1213-2.9847.2162-4.2793.9671l-25.2905 14.4893c-1.7024.985-2.9438 2.607-3.451 4.507s-.2387 3.924.7465 5.627c.9851 1.702 2.6061 2.943 4.5065 3.451 1.9004.507 3.9244.238 5.6268-.747l14.1473-8.122v16.261c.0654 1.928.8772 3.755 2.2641 5.096 1.3868 1.34 3.2402 2.09 5.169 2.09 1.9289 0 3.7823-.75 5.1691-2.09 1.3868-1.341 2.1986-3.168 2.264-5.096v-29.0645c-.0038-1.869-.7144-3.6673-1.9891-5.0341s-3.0192-2.2009-4.8834-2.3348zm-6.8468-13.5825c.4875-1.6032.414-3.3247-.2083-4.8806-.6224-1.5559-1.7564-2.8532-3.2152-3.6779l-25.2306-14.541c-1.704-.976-3.7248-1.2385-5.6216-.7303-1.8968.5083-3.5155 1.7461-4.5032 3.4433-.4889.84-.8065 1.7686-.9343 2.732-.1278.9635-.0632 1.9428.1899 2.8811.2531.9384.6897 1.8173 1.2846 2.5858.595.7686 1.3364 1.4115 2.1814 1.8917l14.096 8.1221-14.096 8.0536c-.8429.4861-1.5819 1.1334-2.1746 1.9051-.5928.7717-1.0277 1.6526-1.2801 2.5923-.2523.9398-.317 1.9201-.1905 2.8849s.4418 1.8952.9279 2.7382c.4861.8429 1.1335 1.5819 1.9051 2.1746.7717.5928 1.6526 1.0277 2.5924 1.2801.9397.2523 1.92.317 2.8848.1905s1.8952-.4418 2.7382-.9279l25.2306-14.5496c1.6248-.9071 2.8451-2.3965 3.4149-4.168z",fill:"#fff",fillRule:"evenodd"}))),Nu=n=>E.createElement("svg",{className:"mr-2 w-5 h-5",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48",width:48,height:48,...n},E.createElement("path",{fill:"#fbc02d",d:"M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20 s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"}),E.createElement("path",{fill:"#e53935",d:"M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039 l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"}),E.createElement("path",{fill:"#4caf50",d:"M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36 c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"}),E.createElement("path",{fill:"#1565c0",d:"M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"})),ju=n=>E.createElement("svg",{className:"mr-2 w-5 h-5",width:1024,height:1024,viewBox:"0 0 1024 1024",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},E.createElement("path",{d:"M44.522 44.5217H489.739V489.739H44.522V44.5217Z",fill:"#F35325"}),E.createElement("path",{d:"M534.261 44.5217H979.478V489.739H534.261V44.5217Z",fill:"#81BC06"}),E.createElement("path",{d:"M44.522 534.261H489.739V979.478H44.522V534.261Z",fill:"#05A6F0"}),E.createElement("path",{d:"M534.261 534.261H979.478V979.478H534.261V534.261Z",fill:"#FFBA08"})),Iu=n=>E.createElement("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 287.56 191",...n},E.createElement("defs",null,E.createElement("style",null,".cls-1{fill:#0081fb;}.cls-2{fill:url(#linear-gradient);}.cls-3{fill:url(#linear-gradient-2);}"),E.createElement("linearGradient",{id:"linear-gradient",x1:62.34,y1:101.45,x2:260.34,y2:91.45,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},E.createElement("stop",{offset:0,stopColor:"#0064e1"}),E.createElement("stop",{offset:.4,stopColor:"#0064e1"}),E.createElement("stop",{offset:.83,stopColor:"#0073ee"}),E.createElement("stop",{offset:1,stopColor:"#0082fb"})),E.createElement("linearGradient",{id:"linear-gradient-2",x1:41.42,y1:53,x2:41.42,y2:126,gradientTransform:"matrix(1, 0, 0, -1, 0, 192)",gradientUnits:"userSpaceOnUse"},E.createElement("stop",{offset:0,stopColor:"#0082fb"}),E.createElement("stop",{offset:1,stopColor:"#0064e0"}))),E.createElement("title",null,"facebook-meta"),E.createElement("path",{className:"cls-1",d:"M31.06,126c0,11,2.41,19.41,5.56,24.51A19,19,0,0,0,53.19,160c8.1,0,15.51-2,29.79-21.76,11.44-15.83,24.92-38,34-52l15.36-23.6c10.67-16.39,23-34.61,37.18-47C181.07,5.6,193.54,0,206.09,0c21.07,0,41.14,12.21,56.5,35.11,16.81,25.08,25,56.67,25,89.27,0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191V160c17.63,0,22-16.2,22-34.74,0-26.42-6.16-55.74-19.73-76.69-9.63-14.86-22.11-23.94-35.84-23.94-14.85,0-26.8,11.2-40.23,31.17-7.14,10.61-14.47,23.54-22.7,38.13l-9.06,16c-18.2,32.27-22.81,39.62-31.91,51.75C84.74,183,71.12,191,53.19,191c-21.27,0-34.72-9.21-43-23.09C3.34,156.6,0,141.76,0,124.85Z"}),E.createElement("path",{className:"cls-2",d:"M24.49,37.3C38.73,15.35,59.28,0,82.85,0c13.65,0,27.22,4,41.39,15.61,15.5,12.65,32,33.48,52.63,67.81l7.39,12.32c17.84,29.72,28,45,33.93,52.22,7.64,9.26,13,12,19.94,12,17.63,0,22-16.2,22-34.74l27.4-.86c0,19.38-3.82,33.62-10.32,44.87C271,180.13,258.72,191,238.13,191c-12.8,0-24.14-2.78-36.68-14.61-9.64-9.08-20.91-25.21-29.58-39.71L146.08,93.6c-12.94-21.62-24.81-37.74-31.68-45C107,40.71,97.51,31.23,82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78Z"}),E.createElement("path",{className:"cls-3",d:"M82.35,31.23c-12.27,0-22.69,8.61-31.41,21.78C38.61,71.62,31.06,99.34,31.06,126c0,11,2.41,19.41,5.56,24.51L10.14,167.91C3.34,156.6,0,141.76,0,124.85,0,94.1,8.44,62.05,24.49,37.3,38.73,15.35,59.28,0,82.85,0Z"})),$u=n=>E.createElement("svg",{className:"mr-2 w-5 h-5",width:256,height:233,viewBox:"0 0 256 233",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},E.createElement("path",{d:"M186.182 0h46.545v46.545h-46.545z"}),E.createElement("path",{fill:"#f7d046",d:"M209.455 0H256v46.545h-46.545z"}),E.createElement("path",{d:"M0 0h46.545v46.545H0zm0 46.545h46.545V93.09H0zm0 46.546h46.545v46.545H0zm0 46.545h46.545v46.545H0zm0 46.546h46.545v46.545H0z"}),E.createElement("path",{fill:"#f7d046",d:"M23.273 0h46.545v46.545H23.273z"}),E.createElement("path",{fill:"#f2a73b",d:"M209.455 46.545H256V93.09h-46.545zm-186.182 0h46.545V93.09H23.273z"}),E.createElement("path",{d:"M139.636 46.545h46.545V93.09h-46.545z"}),E.createElement("path",{fill:"#f2a73b",d:"M162.909 46.545h46.545V93.09h-46.545zm-93.091 0h46.545V93.09H69.818z"}),E.createElement("path",{fill:"#ee792f",d:"M116.364 93.091h46.545v46.545h-46.545zm46.545 0h46.545v46.545h-46.545zm-93.091 0h46.545v46.545H69.818z"}),E.createElement("path",{d:"M93.091 139.636h46.545v46.545H93.091z"}),E.createElement("path",{fill:"#eb5829",d:"M116.364 139.636h46.545v46.545h-46.545z"}),E.createElement("path",{fill:"#ee792f",d:"M209.455 93.091H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"}),E.createElement("path",{d:"M186.182 139.636h46.545v46.545h-46.545z"}),E.createElement("path",{fill:"#eb5829",d:"M209.455 139.636H256v46.545h-46.545z"}),E.createElement("path",{d:"M186.182 186.182h46.545v46.545h-46.545z"}),E.createElement("path",{fill:"#eb5829",d:"M23.273 139.636h46.545v46.545H23.273z"}),E.createElement("path",{fill:"#ea3326",d:"M209.455 186.182H256v46.545h-46.545zm-186.182 0h46.545v46.545H23.273z"})),Lu="/NoLLMChat/assets/qwen-B-gSh3_v.webp",Bu="/NoLLMChat/assets/smollm-CikBjd4F.png",qu="/NoLLMChat/assets/stablelm-BquePdQ7.png",Du="/NoLLMChat/assets/nomic-BjJqoFji.webp",Fu="/NoLLMChat/assets/joshua-ByaReJuI.webp",Uu="/NoLLMChat/assets/deepseek-CRqFMahi.png",Wu="/NoLLMChat/assets/redpajama-CmUGqSQW.png",Vu=n=>E.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...n},E.createElement("path",{fill:"#fff",d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),zu=n=>E.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:256,height:260,preserveAspectRatio:"xMidYMid",viewBox:"0 0 256 260",...n},E.createElement("path",{d:"M239.184 106.203a64.716 64.716 0 0 0-5.576-53.103C219.452 28.459 191 15.784 163.213 21.74A65.586 65.586 0 0 0 52.096 45.22a64.716 64.716 0 0 0-43.23 31.36c-14.31 24.602-11.061 55.634 8.033 76.74a64.665 64.665 0 0 0 5.525 53.102c14.174 24.65 42.644 37.324 70.446 31.36a64.72 64.72 0 0 0 48.754 21.744c28.481.025 53.714-18.361 62.414-45.481a64.767 64.767 0 0 0 43.229-31.36c14.137-24.558 10.875-55.423-8.083-76.483Zm-97.56 136.338a48.397 48.397 0 0 1-31.105-11.255l1.535-.87 51.67-29.825a8.595 8.595 0 0 0 4.247-7.367v-72.85l21.845 12.636c.218.111.37.32.409.563v60.367c-.056 26.818-21.783 48.545-48.601 48.601Zm-104.466-44.61a48.345 48.345 0 0 1-5.781-32.589l1.534.921 51.722 29.826a8.339 8.339 0 0 0 8.441 0l63.181-36.425v25.221a.87.87 0 0 1-.358.665l-52.335 30.184c-23.257 13.398-52.97 5.431-66.404-17.803ZM23.549 85.38a48.499 48.499 0 0 1 25.58-21.333v61.39a8.288 8.288 0 0 0 4.195 7.316l62.874 36.272-21.845 12.636a.819.819 0 0 1-.767 0L41.353 151.53c-23.211-13.454-31.171-43.144-17.804-66.405v.256Zm179.466 41.695-63.08-36.63L161.73 77.86a.819.819 0 0 1 .768 0l52.233 30.184a48.6 48.6 0 0 1-7.316 87.635v-61.391a8.544 8.544 0 0 0-4.4-7.213Zm21.742-32.69-1.535-.922-51.619-30.081a8.39 8.39 0 0 0-8.492 0L99.98 99.808V74.587a.716.716 0 0 1 .307-.665l52.233-30.133a48.652 48.652 0 0 1 72.236 50.391v.205ZM88.061 139.097l-21.845-12.585a.87.87 0 0 1-.41-.614V65.685a48.652 48.652 0 0 1 79.757-37.346l-1.535.87-51.67 29.825a8.595 8.595 0 0 0-4.246 7.367l-.051 72.697Zm11.868-25.58 28.138-16.217 28.188 16.218v32.434l-28.086 16.218-28.188-16.218-.052-32.434Z"})),bp=E.memo(({name:n,className:e,...t})=>{const r=sg(s=>s.theme);return n=n.toLowerCase(),n.includes("gpt")?r==="dark"?H.jsx(Vu,{className:Oe("w-5 h-5",e),...t}):H.jsx(zu,{className:Oe("w-5 h-5",e),...t}):n!=null&&n.includes("deepseek")?H.jsx("img",{className:Oe("w-5 h-5 rounded-full",e),src:Uu,alt:"deepseek",...t}):n!=null&&n.includes("redpajama")?H.jsx("img",{className:Oe("w-5 h-5 rounded-full",e),src:Wu,alt:"deepseek",...t}):n.includes("gemma")||n.includes("gemini")?H.jsx(Nu,{className:Oe("w-5 h-5",e),...t}):n!=null&&n.includes("qwen")?H.jsx("img",{className:Oe("w-5 h-5",e),src:Lu,alt:"qwen",...t}):n!=null&&n.includes("phi")?H.jsx(ju,{className:Oe("w-5 h-5",e),...t}):n!=null&&n.includes("llama")?H.jsx(Iu,{className:Oe("w-5 h-5",e),...t}):n!=null&&n.includes("smollm")?H.jsx("img",{className:Oe("w-5 h-5",e),src:Bu,alt:"smollm",...t}):n!=null&&n.includes("mistral")?H.jsx($u,{className:Oe("w-5 h-5",e),...t}):n!=null&&n.includes("snowflake")?H.jsx(Ru,{className:Oe("w-5 h-5 rounded-full",e),...t}):n!=null&&n.includes("stablelm")?H.jsx("img",{className:Oe("w-5 h-5 rounded-full",e),src:qu,alt:"stablelm",...t}):n!=null&&n.includes("nomic")?H.jsx("img",{className:Oe("w-5 h-5 rounded-full",e),src:Du,alt:"nomic",...t}):n!=null&&n.includes("Xenova")||n!=null&&n.includes("janus")?H.jsx("img",{className:Oe("w-5 h-5 rounded-full",e),src:Fu,alt:"Xenova",...t}):H.jsx(ig,{className:Oe("w-5 h-5",e),name:"brain"})})});export{ea as B,hs as G,ta as I,Ye as L,Z as O,na as S,Bg as __tla,ra as a,sa as b,bp as c,ia as d,aa as e,Yn as f,ds as g,er as h,oa as i,ms as j,tr as k,wp as l,Pt as m,fs as n,_p as o,vp as p,la as q,xp as r,Ft as s,Op as u,nr as w};
