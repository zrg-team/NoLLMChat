const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-HBk6v5Fv.js","assets/index-Dm1R2z7R.js","assets/index-BHmW4Jet.css","assets/routes-BQtx4Swg.js","assets/use-prevent-pitch-zoom-CRhJfjI7.js","assets/index-yTRa8vdE.js","assets/chevron-right-Y8OgkNl0.js","assets/createLucideIcon-B-o_1Xz_.js","assets/check-CjRNSoFn.js","assets/circle-PgwYZjSO.js","assets/popover-Cui8Ka4E.js","assets/index-BohVFg5g.js","assets/index-yeDnoptH.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{r as i,q as b,o as E,v as F,w as x,$ as T,_ as O,j as d,g as z,L as N,X as A,__tla as D}from"./index-Dm1R2z7R.js";import{u as I,b as P,a as R,L as w,I as U,p as $,S as q,c as H,__tla as V}from"./LLMIcon-8SFnyBlJ.js";import{S as X,A as Y,H as S,aZ as Z,a_ as B,a$ as G,b0 as J,__tla as K}from"./routes-BQtx4Swg.js";import{p as Q,u as W,a as ee}from"./file-tree-JWOQ6MD3.js";import"./dot-C-EbcjRb.js";import"./createLucideIcon-B-o_1Xz_.js";let k,ae=Promise.all([(()=>{try{return D}catch{}})(),(()=>{try{return V}catch{}})(),(()=>{try{return K}catch{}})()]).then(async()=>{let C,j,M;C=()=>{const[a,e]=i.useState(!1),[t,o]=i.useState(),s=b(m=>m.currentSession),{t:_}=E("flows"),{toast:l}=F(),{loadModel:r}=I(),{stream:u}=P(),{modalRef:y}=R(q),g=i.useCallback(async(m,f,c)=>{if(s!=null&&s.main_node_id){if(!(t!=null&&t.llm)){l({variant:"destructive",description:_("editor_node.errors.llm_not_found")});return}(t==null?void 0:t.status)!==w.Loaded&&(await r(t.llm.provider,t.llm.name,n=>{o(p=>p&&{...p,progress:n.text})}),o(n=>n&&{...n,status:w.Loaded,progress:""}));try{const n=f.map(h=>h.role==="system"?new X(h.content):h.role==="assistant"?new Y(h.content):new S(h.content)),{content:p}=await u(t.llm.provider,[...n,new S(m)],{onMessageUpdate:({content:h})=>{c==null||c(h)},llm:t.llm});return c==null||c(p),p}catch(n){if(n instanceof Error&&n.message.includes("LLM_NOT_LOADED_YET")){l({title:_("editor_node.errors.llm_not_loaded_yet")});return}l({variant:"destructive",title:_("editor_node.errors.stream_message_failed")})}}},[s==null?void 0:s.main_node_id,t==null?void 0:t.llm,t==null?void 0:t.status,l,_,r,u]),L=i.useCallback(async()=>{try{if(e(!0),!(s!=null&&s.main_node_id))return;const m=await x("FlowEdge").find({where:{target:s.main_node_id}}),f=(await x("FlowNode").find({where:{id:U(m.map(n=>n.source))}})).find(n=>n.source_type===T.LLM);if(!f)return;const c=await x("LLM").findOne({where:{id:f.source_id}});if(!c)return;s.passphrase&&await $(s.passphrase,y.current),await r(c.provider,c.name,n=>{o(p=>p&&{...p,llm:c,progress:n.text})}),o({llm:c,status:w.Loaded})}finally{e(!1)}},[s==null?void 0:s.main_node_id,s==null?void 0:s.passphrase,r,y]),v=i.useCallback(async()=>{try{if(e(!0),!(t!=null&&t.llm))return;await r(t.llm.provider,t.llm.name,m=>{o(f=>f&&{...f,progress:m.text})}),o(m=>m&&{...m,status:w.Loaded,progress:""})}finally{e(!1)}},[r,t==null?void 0:t.llm]);return i.useEffect(()=>{s!=null&&s.main_node_id&&L()},[s==null?void 0:s.main_node_id,L]),{loading:a,mainLLMInfo:t,createMessage:g,loadCurrentModel:v}},j=()=>{const a=b(l=>l.currentSession),[e,t]=i.useState(),o=i.useCallback(async(l,r)=>{await x("FlowNode").update(l,{raw:Q(r)})},[]),s=i.useCallback(async l=>{a!=null&&a.main_node_id&&t(r=>{if(!(a!=null&&a.main_node_id))return r;const u=W(r||{},l);return o(a==null?void 0:a.main_node_id,u),u})},[a==null?void 0:a.main_node_id,o]),_=i.useCallback(async()=>{if(!(a!=null&&a.main_node_id))return;const l=await x("FlowNode").findOne({where:{id:a==null?void 0:a.main_node_id}});l&&t(l.raw?ee(l.raw):{})},[a==null?void 0:a.main_node_id]);return i.useEffect(()=>{a!=null&&a.main_node_id&&_()},[a==null?void 0:a.main_node_id,_]),{fileSystemTree:e,updateCodeContainerFile:s,updateCodeContainerData:o}},M=i.lazy(()=>O(()=>import("./index-HBk6v5Fv.js").then(async a=>(await a.__tla,a)),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]))),k=i.memo(()=>{var r,u,y,g;const{loading:a,mainLLMInfo:e,loadCurrentModel:t,createMessage:o}=C(),{fileSystemTree:s,updateCodeContainerFile:_}=j(),l=i.useCallback((L,v,m)=>o(L,v,m),[o]);return d.jsxs("div",{className:"h-full w-full relative","data-registry":"plate",children:[d.jsx(Z,{children:d.jsx(B,{children:d.jsxs("div",{className:z("flex absolute !z-[51] right-1 top-0 max-w-28 h-9 items-center justify-center flex-row"),children:[(e==null?void 0:e.status)===w.Loaded&&((r=e==null?void 0:e.llm)!=null&&r.name)?d.jsx(H,{name:(u=e==null?void 0:e.llm)==null?void 0:u.name,className:"w-5 h-5 mr-1"}):void 0,d.jsxs(G,{className:"overflow-hidden !text-ellipsis w-full max-w-full max-h-full whitespace-nowrap text-sm",children:[e!=null&&e.progress?e.progress:(e==null?void 0:e.status)===w.Loaded?((y=e==null?void 0:e.llm)==null?void 0:y.name)||"":a?d.jsx(N,{size:16,name:"loader-circle",className:"animate-spin ml-2"}):void 0,e!=null&&e.llm&&(e==null?void 0:e.status)!==w.Loaded?d.jsx(N,{size:16,name:"loader-circle",onClick:t,className:"animate-spin ml-2"}):void 0]}),d.jsx(J,{children:d.jsx("p",{children:(e==null?void 0:e.progress)||((g=e==null?void 0:e.llm)==null?void 0:g.name)||""})})]})})}),d.jsx(i.Suspense,{fallback:d.jsx(A,{simple:!0}),children:s!==void 0?d.jsx(M,{autoLoad:!0,hideAppName:!0,llm:e==null?void 0:e.llm,fileSystemTree:s,onUpdateFileContent:_,sendMessage:l}):void 0})]})})});export{ae as __tla,k as default};
