const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BuXK4Fyc.js","assets/index-pm_YnrGh.js","assets/index-BHmW4Jet.css","assets/use-prevent-pitch-zoom-D4Y157HE.js","assets/index-CAGplr8G.js","assets/chevron-right-BoYU_Yes.js","assets/createLucideIcon-DJguve4f.js","assets/check--X-qnp6V.js","assets/circle-D0MKcgZf.js","assets/popover-DijAlSSk.js","assets/index-oti-5Lj3.js","assets/index-B1xgEgxs.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{r as n,u as b,b as E,e as F,S as T,A as O,H as N,g as x,F as z,_ as A,j as d,U as D,W as I,c as U,X as P,L as S,Y as R,Z as Y,__tla as H}from"./index-pm_YnrGh.js";import{u as V,b as W,a as X,L as w,I as Z,p as q,S as B,c as G,__tla as J}from"./LLMIcon-Dy4TnfD2.js";import{p as K,u as Q,a as $,__tla as aa}from"./file-tree-D-p5d1dM.js";import{__tla as ea}from"./dot-BQCW_euz.js";import{__tla as ta}from"./createLucideIcon-DJguve4f.js";let k,sa=Promise.all([(()=>{try{return H}catch{}})(),(()=>{try{return J}catch{}})(),(()=>{try{return aa}catch{}})(),(()=>{try{return ea}catch{}})(),(()=>{try{return ta}catch{}})()]).then(async()=>{let C,j,M;C=()=>{const[e,a]=n.useState(!1),[t,o]=n.useState(),s=b(m=>m.currentSession),{t:c}=E("flows"),{toast:l}=F(),{loadModel:i}=V(),{stream:u}=W(),{modalRef:y}=X(B),g=n.useCallback(async(m,f,_)=>{if(s!=null&&s.main_node_id){if(!(t!=null&&t.llm)){l({variant:"destructive",description:c("editor_node.errors.llm_not_found")});return}(t==null?void 0:t.status)!==w.Loaded&&(await i(t.llm.provider,t.llm.name,r=>{o(p=>p&&{...p,progress:r.text})}),o(r=>r&&{...r,status:w.Loaded,progress:""}));try{const r=f.map(h=>h.role==="system"?new T(h.content):h.role==="assistant"?new O(h.content):new N(h.content)),{content:p}=await u(t.llm.provider,[...r,new N(m)],{onMessageUpdate:({content:h})=>{_==null||_(h)},llm:t.llm});return _==null||_(p),p}catch(r){if(r instanceof Error&&r.message.includes("LLM_NOT_LOADED_YET")){l({title:c("editor_node.errors.llm_not_loaded_yet")});return}l({variant:"destructive",title:c("editor_node.errors.stream_message_failed")})}}},[s==null?void 0:s.main_node_id,t==null?void 0:t.llm,t==null?void 0:t.status,l,c,i,u]),L=n.useCallback(async()=>{try{if(a(!0),!(s!=null&&s.main_node_id))return;const m=await x("FlowEdge").find({where:{target:s.main_node_id}}),f=(await x("FlowNode").find({where:{id:Z(m.map(r=>r.source))}})).find(r=>r.source_type===z.LLM);if(!f)return;const _=await x("LLM").findOne({where:{id:f.source_id}});if(!_)return;s.passphrase&&await q(s.passphrase,y.current),await i(_.provider,_.name,r=>{o(p=>p&&{...p,llm:_,progress:r.text})}),o({llm:_,status:w.Loaded})}finally{a(!1)}},[s==null?void 0:s.main_node_id,s==null?void 0:s.passphrase,i,y]),v=n.useCallback(async()=>{try{if(a(!0),!(t!=null&&t.llm))return;await i(t.llm.provider,t.llm.name,m=>{o(f=>f&&{...f,progress:m.text})}),o(m=>m&&{...m,status:w.Loaded,progress:""})}finally{a(!1)}},[i,t==null?void 0:t.llm]);return n.useEffect(()=>{s!=null&&s.main_node_id&&L()},[s==null?void 0:s.main_node_id,L]),{loading:e,mainLLMInfo:t,createMessage:g,loadCurrentModel:v}},j=()=>{const e=b(l=>l.currentSession),[a,t]=n.useState(),o=n.useCallback(async(l,i)=>{await x("FlowNode").update(l,{raw:K(i)})},[]),s=n.useCallback(async l=>{e!=null&&e.main_node_id&&t(i=>{if(!(e!=null&&e.main_node_id))return i;const u=Q(i||{},l);return o(e==null?void 0:e.main_node_id,u),u})},[e==null?void 0:e.main_node_id,o]),c=n.useCallback(async()=>{if(!(e!=null&&e.main_node_id))return;const l=await x("FlowNode").findOne({where:{id:e==null?void 0:e.main_node_id}});l&&t(l.raw?$(l.raw):{})},[e==null?void 0:e.main_node_id]);return n.useEffect(()=>{e!=null&&e.main_node_id&&c()},[e==null?void 0:e.main_node_id,c]),{fileSystemTree:a,updateCodeContainerFile:s,updateCodeContainerData:o}},M=n.lazy(()=>A(()=>import("./index-BuXK4Fyc.js").then(async e=>(await e.__tla,e)),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]))),k=n.memo(()=>{var i,u,y,g;const{loading:e,mainLLMInfo:a,loadCurrentModel:t,createMessage:o}=C(),{fileSystemTree:s,updateCodeContainerFile:c}=j(),l=n.useCallback((L,v,m)=>o(L,v,m),[o]);return d.jsxs("div",{className:"h-full w-full relative","data-registry":"plate",children:[d.jsx(D,{children:d.jsx(I,{children:d.jsxs("div",{className:U("flex absolute !z-[51] right-1 top-0 max-w-28 h-9 items-center justify-center flex-row"),children:[(a==null?void 0:a.status)===w.Loaded&&((i=a==null?void 0:a.llm)!=null&&i.name)?d.jsx(G,{name:(u=a==null?void 0:a.llm)==null?void 0:u.name,className:"w-5 h-5 mr-1"}):void 0,d.jsxs(P,{className:"overflow-hidden !text-ellipsis w-full max-w-full max-h-full whitespace-nowrap text-sm",children:[a!=null&&a.progress?a.progress:(a==null?void 0:a.status)===w.Loaded?((y=a==null?void 0:a.llm)==null?void 0:y.name)||"":e?d.jsx(S,{size:16,name:"loader-circle",className:"animate-spin ml-2"}):void 0,a!=null&&a.llm&&(a==null?void 0:a.status)!==w.Loaded?d.jsx(S,{size:16,name:"loader-circle",onClick:t,className:"animate-spin ml-2"}):void 0]}),d.jsx(R,{children:d.jsx("p",{children:(a==null?void 0:a.progress)||((g=a==null?void 0:a.llm)==null?void 0:g.name)||""})})]})})}),d.jsx(n.Suspense,{fallback:d.jsx(Y,{simple:!0}),children:s!==void 0?d.jsx(M,{autoLoad:!0,hideAppName:!0,llm:a==null?void 0:a.llm,fileSystemTree:s,onUpdateFileContent:c,sendMessage:l}):void 0})]})})});export{sa as __tla,k as default};
