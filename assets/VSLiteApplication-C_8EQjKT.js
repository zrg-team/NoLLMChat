const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B1H-yXGe.js","assets/index-D_ELiTRG.js","assets/index-BHmW4Jet.css","assets/routes-BC22d4F8.js","assets/use-prevent-pitch-zoom-Dmc7gmY8.js","assets/index-DFww-FF2.js","assets/chevron-right-BqJkiax2.js","assets/createLucideIcon-DAzac-JV.js","assets/check-DeHpOOeW.js","assets/circle-CtPWNQ66.js","assets/popover-exEqeTvl.js","assets/index-Dzfaeq0k.js","assets/index-BqcCmRFK.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{r,o as E,y as F,_ as T,j as d,g as O,L as M,M as z,__tla as A}from"./index-D_ELiTRG.js";import{u as D,b as I,a as P,L as w,I as R,p as U,S as H,c as V,__tla as Y}from"./LLMIcon-mV0klbiM.js";import{u as N,S as q,A as B,H as S,g as x,F as G,b2 as J,b3 as K,b4 as Q,b5 as W,__tla as X}from"./routes-BC22d4F8.js";import{p as Z,u as $,a as ee,__tla as ae}from"./file-tree-DF7B6FnT.js";import"./dot-BZFBpF5w.js";import"./createLucideIcon-DAzac-JV.js";let k,te=Promise.all([(()=>{try{return A}catch{}})(),(()=>{try{return Y}catch{}})(),(()=>{try{return X}catch{}})(),(()=>{try{return ae}catch{}})()]).then(async()=>{let C,j,b;C=()=>{const[a,e]=r.useState(!1),[t,o]=r.useState(),s=N(m=>m.currentSession),{t:c}=E("flows"),{toast:l}=F(),{loadModel:i}=D(),{stream:u}=I(),{modalRef:y}=P(H),g=r.useCallback(async(m,f,_)=>{if(s!=null&&s.main_node_id){if(!(t!=null&&t.llm)){l({variant:"destructive",description:c("editor_node.errors.llm_not_found")});return}(t==null?void 0:t.status)!==w.Loaded&&(await i(t.llm.provider,t.llm.name,n=>{o(p=>p&&{...p,progress:n.text})}),o(n=>n&&{...n,status:w.Loaded,progress:""}));try{const n=f.map(h=>h.role==="system"?new q(h.content):h.role==="assistant"?new B(h.content):new S(h.content)),{content:p}=await u(t.llm.provider,[...n,new S(m)],{onMessageUpdate:({content:h})=>{_==null||_(h)},llm:t.llm});return _==null||_(p),p}catch(n){if(n instanceof Error&&n.message.includes("LLM_NOT_LOADED_YET")){l({title:c("editor_node.errors.llm_not_loaded_yet")});return}l({variant:"destructive",title:c("editor_node.errors.stream_message_failed")})}}},[s==null?void 0:s.main_node_id,t==null?void 0:t.llm,t==null?void 0:t.status,l,c,i,u]),L=r.useCallback(async()=>{try{if(e(!0),!(s!=null&&s.main_node_id))return;const m=await x("FlowEdge").find({where:{target:s.main_node_id}}),f=(await x("FlowNode").find({where:{id:R(m.map(n=>n.source))}})).find(n=>n.source_type===G.LLM);if(!f)return;const _=await x("LLM").findOne({where:{id:f.source_id}});if(!_)return;s.passphrase&&await U(s.passphrase,y.current),await i(_.provider,_.name,n=>{o(p=>p&&{...p,llm:_,progress:n.text})}),o({llm:_,status:w.Loaded})}finally{e(!1)}},[s==null?void 0:s.main_node_id,s==null?void 0:s.passphrase,i,y]),v=r.useCallback(async()=>{try{if(e(!0),!(t!=null&&t.llm))return;await i(t.llm.provider,t.llm.name,m=>{o(f=>f&&{...f,progress:m.text})}),o(m=>m&&{...m,status:w.Loaded,progress:""})}finally{e(!1)}},[i,t==null?void 0:t.llm]);return r.useEffect(()=>{s!=null&&s.main_node_id&&L()},[s==null?void 0:s.main_node_id,L]),{loading:a,mainLLMInfo:t,createMessage:g,loadCurrentModel:v}},j=()=>{const a=N(l=>l.currentSession),[e,t]=r.useState(),o=r.useCallback(async(l,i)=>{await x("FlowNode").update(l,{raw:Z(i)})},[]),s=r.useCallback(async l=>{a!=null&&a.main_node_id&&t(i=>{if(!(a!=null&&a.main_node_id))return i;const u=$(i||{},l);return o(a==null?void 0:a.main_node_id,u),u})},[a==null?void 0:a.main_node_id,o]),c=r.useCallback(async()=>{if(!(a!=null&&a.main_node_id))return;const l=await x("FlowNode").findOne({where:{id:a==null?void 0:a.main_node_id}});l&&t(l.raw?ee(l.raw):{})},[a==null?void 0:a.main_node_id]);return r.useEffect(()=>{a!=null&&a.main_node_id&&c()},[a==null?void 0:a.main_node_id,c]),{fileSystemTree:e,updateCodeContainerFile:s,updateCodeContainerData:o}},b=r.lazy(()=>T(()=>import("./index-B1H-yXGe.js").then(async a=>(await a.__tla,a)),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]))),k=r.memo(()=>{var i,u,y,g;const{loading:a,mainLLMInfo:e,loadCurrentModel:t,createMessage:o}=C(),{fileSystemTree:s,updateCodeContainerFile:c}=j(),l=r.useCallback((L,v,m)=>o(L,v,m),[o]);return d.jsxs("div",{className:"h-full w-full relative","data-registry":"plate",children:[d.jsx(J,{children:d.jsx(K,{children:d.jsxs("div",{className:O("flex absolute !z-[51] right-1 top-0 max-w-28 h-9 items-center justify-center flex-row"),children:[(e==null?void 0:e.status)===w.Loaded&&((i=e==null?void 0:e.llm)!=null&&i.name)?d.jsx(V,{name:(u=e==null?void 0:e.llm)==null?void 0:u.name,className:"w-5 h-5 mr-1"}):void 0,d.jsxs(Q,{className:"overflow-hidden !text-ellipsis w-full max-w-full max-h-full whitespace-nowrap text-sm",children:[e!=null&&e.progress?e.progress:(e==null?void 0:e.status)===w.Loaded?((y=e==null?void 0:e.llm)==null?void 0:y.name)||"":a?d.jsx(M,{size:16,name:"loader-circle",className:"animate-spin ml-2"}):void 0,e!=null&&e.llm&&(e==null?void 0:e.status)!==w.Loaded?d.jsx(M,{size:16,name:"loader-circle",onClick:t,className:"animate-spin ml-2"}):void 0]}),d.jsx(W,{children:d.jsx("p",{children:(e==null?void 0:e.progress)||((g=e==null?void 0:e.llm)==null?void 0:g.name)||""})})]})})}),d.jsx(r.Suspense,{fallback:d.jsx(z,{simple:!0}),children:s!==void 0?d.jsx(b,{autoLoad:!0,hideAppName:!0,llm:e==null?void 0:e.llm,fileSystemTree:s,onUpdateFileContent:c,sendMessage:l}):void 0})]})})});export{te as __tla,k as default};
