const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D3ruEZVV.js","assets/index-CMO0DEG8.js","assets/index-Vcso_2OS.css","assets/routes-PTuNXW4r.js","assets/index-DBo_-Wpu.js","assets/index-h9WScZip.js","assets/chevron-right-CE9ClFSx.js","assets/createLucideIcon-D9I8Id43.js","assets/check-Cxgq5B0K.js","assets/circle-Gl6SVW0H.js","assets/popover-D5bX1ZI1.js","assets/index-Ddm2im3W.js","assets/index-HSnfLTSA.css"])))=>i.map(i=>d[i]);
import{r as i,e as E,f as F,_ as T,j as m,c as D,L,D as O,__tla as z}from"./index-CMO0DEG8.js";import{u as A,a as I,b as h,l as P,I as R,p as U,S as H,c as V,__tla as Y}from"./LLMIcon-tZAM1-Q5.js";import{e as M,S as q,A as B,H as N,g as x,F as G,f as J,h as K,i as Q,j as W,__tla as X}from"./routes-PTuNXW4r.js";import{u as Z,__tla as $}from"./use-load-model-D8cgNFQT.js";import{p as ee,u as ae,a as te,__tla as se}from"./file-tree-BZDpw5jz.js";import"./dot-DgXqs9Cs.js";import"./createLucideIcon-D9I8Id43.js";let S,re=Promise.all([(()=>{try{return z}catch{}})(),(()=>{try{return Y}catch{}})(),(()=>{try{return X}catch{}})(),(()=>{try{return $}catch{}})(),(()=>{try{return se}catch{}})()]).then(async()=>{let j,b,k;j=()=>{const[a,e]=i.useState(!1),[t,o]=i.useState(),s=M(c=>c.currentSession),{t:u}=E("flows"),{toast:r}=F(),{loadModel:n}=Z(),{confirmPassphrase:p}=A(),{modalRef:y}=I(H),v=i.useCallback(async(c,f,d)=>{if(s!=null&&s.main_node_id){if(!(t!=null&&t.llm)){r({variant:"destructive",description:u("editor_node.errors.llm_not_found")});return}(t==null?void 0:t.status)!==h.Loaded&&(await n(t.llm.provider,t.llm.name,{provider:t.llm.provider,callback:l=>{o(_=>_&&{..._,progress:l.text})}}),o(l=>l&&{...l,status:h.Loaded,progress:""}));try{const l=f.map(w=>w.role==="system"?new q(w.content):w.role==="assistant"?new B(w.content):new N(w.content));await p();const _=await P.stream(t.llm.provider,[...l,new N(c)],{onMessageUpdate:({content:w})=>{d==null||d(w)},llm:t.llm});return d==null||d((_==null?void 0:_.content)||""),_==null?void 0:_.content}catch(l){if(l instanceof Error&&l.message.includes("LLM_NOT_LOADED_YET")){r({title:u("editor_node.errors.llm_not_loaded_yet")});return}r({variant:"destructive",title:u("editor_node.errors.stream_message_failed")})}}},[s==null?void 0:s.main_node_id,t==null?void 0:t.llm,t==null?void 0:t.status,r,u,n]),g=i.useCallback(async()=>{try{if(e(!0),!(s!=null&&s.main_node_id))return;const c=await x("FlowEdge").find({where:{target:s.main_node_id}}),f=(await x("FlowNode").find({where:{id:R(c.map(l=>l.source))}})).find(l=>l.source_type===G.LLM);if(!f)return;const d=await x("LLM").findOne({where:{id:f.source_id}});if(!d)return;s.passphrase&&await U(s.passphrase,y.current),await n(d.provider,d.name,{provider:d.provider,callback:l=>{o(_=>_&&{..._,llm:d,progress:l.text})}}),o({llm:d,status:h.Loaded})}finally{e(!1)}},[s==null?void 0:s.main_node_id,s==null?void 0:s.passphrase,n,y]),C=i.useCallback(async()=>{try{if(e(!0),!(t!=null&&t.llm))return;await n(t.llm.provider,t.llm.name,{provider:t.llm.provider,callback:c=>{o(f=>f&&{...f,progress:c.text})}}),o(c=>c&&{...c,status:h.Loaded,progress:""})}finally{e(!1)}},[n,t==null?void 0:t.llm]);return i.useEffect(()=>{s!=null&&s.main_node_id&&g()},[s==null?void 0:s.main_node_id,g]),{loading:a,mainLLMInfo:t,createMessage:v,loadCurrentModel:C}},b=()=>{const a=M(r=>r.currentSession),[e,t]=i.useState(),o=i.useCallback(async(r,n)=>{await x("FlowNode").update(r,{raw:ee(n)})},[]),s=i.useCallback(async r=>{a!=null&&a.main_node_id&&t(n=>{if(!(a!=null&&a.main_node_id))return n;const p=ae(n||{},r);return o(a==null?void 0:a.main_node_id,p),p})},[a==null?void 0:a.main_node_id,o]),u=i.useCallback(async()=>{if(!(a!=null&&a.main_node_id))return;const r=await x("FlowNode").findOne({where:{id:a==null?void 0:a.main_node_id}});r&&t(r.raw?te(r.raw):{})},[a==null?void 0:a.main_node_id]);return i.useEffect(()=>{a!=null&&a.main_node_id&&u()},[a==null?void 0:a.main_node_id,u]),{fileSystemTree:e,updateCodeContainerFile:s,updateCodeContainerData:o}},k=i.lazy(()=>T(()=>import("./index-D3ruEZVV.js").then(async a=>(await a.__tla,a)),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12]))),S=i.memo(()=>{var n,p,y,v;const{loading:a,mainLLMInfo:e,loadCurrentModel:t,createMessage:o}=j(),{fileSystemTree:s,updateCodeContainerFile:u}=b(),r=i.useCallback((g,C,c)=>o(g,C,c),[o]);return m.jsxs("div",{className:"h-full w-full relative","data-registry":"plate",children:[m.jsx(J,{children:m.jsx(K,{children:m.jsxs("div",{className:D("flex absolute !z-[51] right-1 top-0 max-w-28 h-9 items-center justify-center flex-row"),children:[(e==null?void 0:e.status)===h.Loaded&&((n=e==null?void 0:e.llm)!=null&&n.name)?m.jsx(V,{name:(p=e==null?void 0:e.llm)==null?void 0:p.name,className:"w-5 h-5 mr-1"}):void 0,m.jsxs(Q,{className:"overflow-hidden !text-ellipsis w-full max-w-full max-h-full whitespace-nowrap text-sm",children:[e!=null&&e.progress?e.progress:(e==null?void 0:e.status)===h.Loaded?((y=e==null?void 0:e.llm)==null?void 0:y.name)||"":a?m.jsx(L,{size:16,name:"loader-circle",className:"animate-spin ml-2"}):void 0,e!=null&&e.llm&&(e==null?void 0:e.status)!==h.Loaded?m.jsx(L,{size:16,name:"loader-circle",onClick:t,className:"animate-spin ml-2"}):void 0]}),m.jsx(W,{children:m.jsx("p",{children:(e==null?void 0:e.progress)||((v=e==null?void 0:e.llm)==null?void 0:v.name)||""})})]})})}),m.jsx(i.Suspense,{fallback:m.jsx(O,{simple:!0}),children:s!==void 0?m.jsx(k,{autoLoad:!0,hideAppName:!0,llm:e==null?void 0:e.llm,fileSystemTree:s,onUpdateFileContent:u,sendMessage:r}):void 0})]})})});export{re as __tla,S as default};
