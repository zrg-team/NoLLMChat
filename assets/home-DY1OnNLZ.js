const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-GNJkwovY.js","assets/index-B1uyMJb5.js","assets/index-Cto61xuP.css","assets/routes-RIB_pvGL.js","assets/index-K_QcnF3W.css"])))=>i.map(i=>d[i]);
import{B as Ue,r as I,C as kp,j,E as tn,F as yO,G as gO,H as jp,I as Ip,J as xO,x as Me,q as Fn,K as Rp,M as bO,N as vO,O as wO,Q as $p,_ as MO,__tla as EO}from"./index-B1uyMJb5.js";let cs,nn,ti,ni,ri,ii,Te,zn,rn,ct,oi,Vn,qn,ls,us,ds,re,Wn,Hn,lt,ze,si,hs,ps,fs,Bp,Dp,_t,St,Lp,ut,Fp,nt,zp,Vp,ai,ms,ys,ci,gs,xs,li,bs,vs,ui,di,ws,Ms,on,Ot,Un,hi,Es,Cs,_s,qp,Wp,pi,fi,Ss,Os,As,Hp,Qn,Qe,Up,Qp,Yn,Ye,At,Xn,Yp,Xp,Zp,mi,Ns,Se,Ps,Ts,ks,js,yi,CO=Promise.all([(()=>{try{return EO}catch{}})()]).then(async()=>{let Is;Te=(t=>(t.Toolbox="TOOLBOX",t.LLM="LLM",t.NewMessage="NEW_MESSAGE",t.Thread="THREAD",t.Message="MESSAGE",t.Prompt="PROMPT",t.SessionInfo="SESSION_INFO",t.Schema="SCHEMA",t.ToolDefinition="TOOL_DEFINITION",t.ToolHandler="TOOL_HANDLER",t.FewShotExample="FEW_SHOT_EXAMPLE",t.CSVData="CSV_DATA",t.DefaultEmbeddingModel="DEFAULT_EMBEDDING_MODEL",t.VectorDatabase="VECTOR_DATABASE",t.JSONLData="JSONL_DATA",t.ApplicationBar="APPLICATION_BAR",t.Shape="SHAPE",t.CircleShape="CIRCLE_SHAPE",t.TriangleShape="TRIANGLE_SHAPE",t.EditorApp="EDITOR_APP",t))(Te||{}),qn=(t=>(t.Started="started",t.Downloading="downloading",t.Downloaded="downloaded",t.Loading="loading",t.Loaded="loaded",t))(qn||{}),As=(t=>(t.LLM="LLM",t.embedding="embedding",t.VLM="VLM",t))(As||{}),Os=(t=>(t.WebLLM="WebLLM",t.OpenAI="OpenAI",t))(Os||{}),Is=function(t){return Gp(t)&&!Kp(t)};function Gp(t){return!!t&&typeof t=="object"}function Kp(t){var e=Object.prototype.toString.call(t);return e==="[object RegExp]"||e==="[object Date]"||tf(t)}var Jp=typeof Symbol=="function"&&Symbol.for,ef=Jp?Symbol.for("react.element"):60103;function tf(t){return t.$$typeof===ef}function nf(t){return Array.isArray(t)?[]:{}}function sn(t,e){return e.clone!==!1&&e.isMergeableObject(t)?Nt(nf(t),t,e):t}function rf(t,e,n){return t.concat(e).map(function(r){return sn(r,n)})}function of(t,e){if(!e.customMerge)return Nt;var n=e.customMerge(t);return typeof n=="function"?n:Nt}function sf(t){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(t).filter(function(e){return Object.propertyIsEnumerable.call(t,e)}):[]}function Rs(t){return Object.keys(t).concat(sf(t))}function $s(t,e){try{return e in t}catch{return!1}}function af(t,e){return $s(t,e)&&!(Object.hasOwnProperty.call(t,e)&&Object.propertyIsEnumerable.call(t,e))}function cf(t,e,n){var r={};return n.isMergeableObject(t)&&Rs(t).forEach(function(i){r[i]=sn(t[i],n)}),Rs(e).forEach(function(i){af(t,i)||($s(t,i)&&n.isMergeableObject(e[i])?r[i]=of(i,n)(t[i],e[i],n):r[i]=sn(e[i],n))}),r}function Nt(t,e,n){n=n||{},n.arrayMerge=n.arrayMerge||rf,n.isMergeableObject=n.isMergeableObject||Is,n.cloneUnlessOtherwiseSpecified=sn;var r=Array.isArray(e),i=Array.isArray(t),o=r===i;return o?r?n.arrayMerge(t,e,n):cf(t,e,n):sn(e,n)}Nt.all=function(t,e){if(!Array.isArray(t))throw new Error("first argument should be an array");return t.reduce(function(n,r){return Nt(n,r,e)},{})};var lf=Nt,uf=lf;const Zn=Ue(uf);function Ee(t){if(typeof t=="string"||typeof t=="number")return""+t;let e="";if(Array.isArray(t))for(let n=0,r;n<t.length;n++)(r=Ee(t[n]))!==""&&(e+=(e&&" ")+r);else for(let n in t)t[n]&&(e+=(e&&" ")+n);return e}var df={value:()=>{}};function Gn(){for(var t=0,e=arguments.length,n={},r;t<e;++t){if(!(r=arguments[t]+"")||r in n||/[\s.]/.test(r))throw new Error("illegal type: "+r);n[r]=[]}return new Kn(n)}function Kn(t){this._=t}function hf(t,e){return t.trim().split(/^|\s+/).map(function(n){var r="",i=n.indexOf(".");if(i>=0&&(r=n.slice(i+1),n=n.slice(0,i)),n&&!e.hasOwnProperty(n))throw new Error("unknown type: "+n);return{type:n,name:r}})}Kn.prototype=Gn.prototype={constructor:Kn,on:function(t,e){var n=this._,r=hf(t+"",n),i,o=-1,s=r.length;if(arguments.length<2){for(;++o<s;)if((i=(t=r[o]).type)&&(i=pf(n[i],t.name)))return i;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++o<s;)if(i=(t=r[o]).type)n[i]=Bs(n[i],t.name,e);else if(e==null)for(i in n)n[i]=Bs(n[i],t.name,null);return this},copy:function(){var t={},e=this._;for(var n in e)t[n]=e[n].slice();return new Kn(t)},call:function(t,e){if((i=arguments.length-2)>0)for(var n=new Array(i),r=0,i,o;r<i;++r)n[r]=arguments[r+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=this._[t],r=0,i=o.length;r<i;++r)o[r].value.apply(e,n)},apply:function(t,e,n){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],i=0,o=r.length;i<o;++i)r[i].value.apply(e,n)}};function pf(t,e){for(var n=0,r=t.length,i;n<r;++n)if((i=t[n]).name===e)return i.value}function Bs(t,e,n){for(var r=0,i=t.length;r<i;++r)if(t[r].name===e){t[r]=df,t=t.slice(0,r).concat(t.slice(r+1));break}return n!=null&&t.push({name:e,value:n}),t}var gi="http://www.w3.org/1999/xhtml";const Ds={svg:"http://www.w3.org/2000/svg",xhtml:gi,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function Jn(t){var e=t+="",n=e.indexOf(":");return n>=0&&(e=t.slice(0,n))!=="xmlns"&&(t=t.slice(n+1)),Ds.hasOwnProperty(e)?{space:Ds[e],local:t}:t}function ff(t){return function(){var e=this.ownerDocument,n=this.namespaceURI;return n===gi&&e.documentElement.namespaceURI===gi?e.createElement(t):e.createElementNS(n,t)}}function mf(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}function Ls(t){var e=Jn(t);return(e.local?mf:ff)(e)}function yf(){}function xi(t){return t==null?yf:function(){return this.querySelector(t)}}function gf(t){typeof t!="function"&&(t=xi(t));for(var e=this._groups,n=e.length,r=new Array(n),i=0;i<n;++i)for(var o=e[i],s=o.length,a=r[i]=new Array(s),c,l,u=0;u<s;++u)(c=o[u])&&(l=t.call(c,c.__data__,u,o))&&("__data__"in c&&(l.__data__=c.__data__),a[u]=l);return new je(r,this._parents)}function xf(t){return t==null?[]:Array.isArray(t)?t:Array.from(t)}function bf(){return[]}function Fs(t){return t==null?bf:function(){return this.querySelectorAll(t)}}function vf(t){return function(){return xf(t.apply(this,arguments))}}function wf(t){typeof t=="function"?t=vf(t):t=Fs(t);for(var e=this._groups,n=e.length,r=[],i=[],o=0;o<n;++o)for(var s=e[o],a=s.length,c,l=0;l<a;++l)(c=s[l])&&(r.push(t.call(c,c.__data__,l,s)),i.push(c));return new je(r,i)}function zs(t){return function(){return this.matches(t)}}function Vs(t){return function(e){return e.matches(t)}}var Mf=Array.prototype.find;function Ef(t){return function(){return Mf.call(this.children,t)}}function Cf(){return this.firstElementChild}function _f(t){return this.select(t==null?Cf:Ef(typeof t=="function"?t:Vs(t)))}var Sf=Array.prototype.filter;function Of(){return Array.from(this.children)}function Af(t){return function(){return Sf.call(this.children,t)}}function Nf(t){return this.selectAll(t==null?Of:Af(typeof t=="function"?t:Vs(t)))}function Pf(t){typeof t!="function"&&(t=zs(t));for(var e=this._groups,n=e.length,r=new Array(n),i=0;i<n;++i)for(var o=e[i],s=o.length,a=r[i]=[],c,l=0;l<s;++l)(c=o[l])&&t.call(c,c.__data__,l,o)&&a.push(c);return new je(r,this._parents)}function qs(t){return new Array(t.length)}function Tf(){return new je(this._enter||this._groups.map(qs),this._parents)}function er(t,e){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=e}er.prototype={constructor:er,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,e){return this._parent.insertBefore(t,e)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}};function kf(t){return function(){return t}}function jf(t,e,n,r,i,o){for(var s=0,a,c=e.length,l=o.length;s<l;++s)(a=e[s])?(a.__data__=o[s],r[s]=a):n[s]=new er(t,o[s]);for(;s<c;++s)(a=e[s])&&(i[s]=a)}function If(t,e,n,r,i,o,s){var a,c,l=new Map,u=e.length,d=o.length,h=new Array(u),p;for(a=0;a<u;++a)(c=e[a])&&(h[a]=p=s.call(c,c.__data__,a,e)+"",l.has(p)?i[a]=c:l.set(p,c));for(a=0;a<d;++a)p=s.call(t,o[a],a,o)+"",(c=l.get(p))?(r[a]=c,c.__data__=o[a],l.delete(p)):n[a]=new er(t,o[a]);for(a=0;a<u;++a)(c=e[a])&&l.get(h[a])===c&&(i[a]=c)}function Rf(t){return t.__data__}function $f(t,e){if(!arguments.length)return Array.from(this,Rf);var n=e?If:jf,r=this._parents,i=this._groups;typeof t!="function"&&(t=kf(t));for(var o=i.length,s=new Array(o),a=new Array(o),c=new Array(o),l=0;l<o;++l){var u=r[l],d=i[l],h=d.length,p=Bf(t.call(u,u&&u.__data__,l,r)),f=p.length,m=a[l]=new Array(f),y=s[l]=new Array(f),g=c[l]=new Array(h);n(u,d,m,y,g,p,e);for(var w=0,v=0,x,C;w<f;++w)if(x=m[w]){for(w>=v&&(v=w+1);!(C=y[v])&&++v<f;);x._next=C||null}}return s=new je(s,r),s._enter=a,s._exit=c,s}function Bf(t){return typeof t=="object"&&"length"in t?t:Array.from(t)}function Df(){return new je(this._exit||this._groups.map(qs),this._parents)}function Lf(t,e,n){var r=this.enter(),i=this,o=this.exit();return typeof t=="function"?(r=t(r),r&&(r=r.selection())):r=r.append(t+""),e!=null&&(i=e(i),i&&(i=i.selection())),n==null?o.remove():n(o),r&&i?r.merge(i).order():i}function Ff(t){for(var e=t.selection?t.selection():t,n=this._groups,r=e._groups,i=n.length,o=r.length,s=Math.min(i,o),a=new Array(i),c=0;c<s;++c)for(var l=n[c],u=r[c],d=l.length,h=a[c]=new Array(d),p,f=0;f<d;++f)(p=l[f]||u[f])&&(h[f]=p);for(;c<i;++c)a[c]=n[c];return new je(a,this._parents)}function zf(){for(var t=this._groups,e=-1,n=t.length;++e<n;)for(var r=t[e],i=r.length-1,o=r[i],s;--i>=0;)(s=r[i])&&(o&&s.compareDocumentPosition(o)^4&&o.parentNode.insertBefore(s,o),o=s);return this}function Vf(t){t||(t=qf);function e(d,h){return d&&h?t(d.__data__,h.__data__):!d-!h}for(var n=this._groups,r=n.length,i=new Array(r),o=0;o<r;++o){for(var s=n[o],a=s.length,c=i[o]=new Array(a),l,u=0;u<a;++u)(l=s[u])&&(c[u]=l);c.sort(e)}return new je(i,this._parents).order()}function qf(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function Wf(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this}function Hf(){return Array.from(this)}function Uf(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var r=t[e],i=0,o=r.length;i<o;++i){var s=r[i];if(s)return s}return null}function Qf(){let t=0;for(const e of this)++t;return t}function Yf(){return!this.node()}function Xf(t){for(var e=this._groups,n=0,r=e.length;n<r;++n)for(var i=e[n],o=0,s=i.length,a;o<s;++o)(a=i[o])&&t.call(a,a.__data__,o,i);return this}function Zf(t){return function(){this.removeAttribute(t)}}function Gf(t){return function(){this.removeAttributeNS(t.space,t.local)}}function Kf(t,e){return function(){this.setAttribute(t,e)}}function Jf(t,e){return function(){this.setAttributeNS(t.space,t.local,e)}}function em(t,e){return function(){var n=e.apply(this,arguments);n==null?this.removeAttribute(t):this.setAttribute(t,n)}}function tm(t,e){return function(){var n=e.apply(this,arguments);n==null?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,n)}}function nm(t,e){var n=Jn(t);if(arguments.length<2){var r=this.node();return n.local?r.getAttributeNS(n.space,n.local):r.getAttribute(n)}return this.each((e==null?n.local?Gf:Zf:typeof e=="function"?n.local?tm:em:n.local?Jf:Kf)(n,e))}function Ws(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function rm(t){return function(){this.style.removeProperty(t)}}function im(t,e,n){return function(){this.style.setProperty(t,e,n)}}function om(t,e,n){return function(){var r=e.apply(this,arguments);r==null?this.style.removeProperty(t):this.style.setProperty(t,r,n)}}function sm(t,e,n){return arguments.length>1?this.each((e==null?rm:typeof e=="function"?om:im)(t,e,n??"")):Pt(this.node(),t)}function Pt(t,e){return t.style.getPropertyValue(e)||Ws(t).getComputedStyle(t,null).getPropertyValue(e)}function am(t){return function(){delete this[t]}}function cm(t,e){return function(){this[t]=e}}function lm(t,e){return function(){var n=e.apply(this,arguments);n==null?delete this[t]:this[t]=n}}function um(t,e){return arguments.length>1?this.each((e==null?am:typeof e=="function"?lm:cm)(t,e)):this.node()[t]}function Hs(t){return t.trim().split(/^|\s+/)}function bi(t){return t.classList||new Us(t)}function Us(t){this._node=t,this._names=Hs(t.getAttribute("class")||"")}Us.prototype={add:function(t){var e=this._names.indexOf(t);e<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var e=this._names.indexOf(t);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};function Qs(t,e){for(var n=bi(t),r=-1,i=e.length;++r<i;)n.add(e[r])}function Ys(t,e){for(var n=bi(t),r=-1,i=e.length;++r<i;)n.remove(e[r])}function dm(t){return function(){Qs(this,t)}}function hm(t){return function(){Ys(this,t)}}function pm(t,e){return function(){(e.apply(this,arguments)?Qs:Ys)(this,t)}}function fm(t,e){var n=Hs(t+"");if(arguments.length<2){for(var r=bi(this.node()),i=-1,o=n.length;++i<o;)if(!r.contains(n[i]))return!1;return!0}return this.each((typeof e=="function"?pm:e?dm:hm)(n,e))}function mm(){this.textContent=""}function ym(t){return function(){this.textContent=t}}function gm(t){return function(){var e=t.apply(this,arguments);this.textContent=e??""}}function xm(t){return arguments.length?this.each(t==null?mm:(typeof t=="function"?gm:ym)(t)):this.node().textContent}function bm(){this.innerHTML=""}function vm(t){return function(){this.innerHTML=t}}function wm(t){return function(){var e=t.apply(this,arguments);this.innerHTML=e??""}}function Mm(t){return arguments.length?this.each(t==null?bm:(typeof t=="function"?wm:vm)(t)):this.node().innerHTML}function Em(){this.nextSibling&&this.parentNode.appendChild(this)}function Cm(){return this.each(Em)}function _m(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Sm(){return this.each(_m)}function Om(t){var e=typeof t=="function"?t:Ls(t);return this.select(function(){return this.appendChild(e.apply(this,arguments))})}function Am(){return null}function Nm(t,e){var n=typeof t=="function"?t:Ls(t),r=e==null?Am:typeof e=="function"?e:xi(e);return this.select(function(){return this.insertBefore(n.apply(this,arguments),r.apply(this,arguments)||null)})}function Pm(){var t=this.parentNode;t&&t.removeChild(this)}function Tm(){return this.each(Pm)}function km(){var t=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function jm(){var t=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function Im(t){return this.select(t?jm:km)}function Rm(t){return arguments.length?this.property("__data__",t):this.node().__data__}function $m(t){return function(e){t.call(this,e,this.__data__)}}function Bm(t){return t.trim().split(/^|\s+/).map(function(e){var n="",r=e.indexOf(".");return r>=0&&(n=e.slice(r+1),e=e.slice(0,r)),{type:e,name:n}})}function Dm(t){return function(){var e=this.__on;if(e){for(var n=0,r=-1,i=e.length,o;n<i;++n)o=e[n],(!t.type||o.type===t.type)&&o.name===t.name?this.removeEventListener(o.type,o.listener,o.options):e[++r]=o;++r?e.length=r:delete this.__on}}}function Lm(t,e,n){return function(){var r=this.__on,i,o=$m(e);if(r){for(var s=0,a=r.length;s<a;++s)if((i=r[s]).type===t.type&&i.name===t.name){this.removeEventListener(i.type,i.listener,i.options),this.addEventListener(i.type,i.listener=o,i.options=n),i.value=e;return}}this.addEventListener(t.type,o,n),i={type:t.type,name:t.name,value:e,listener:o,options:n},r?r.push(i):this.__on=[i]}}function Fm(t,e,n){var r=Bm(t+""),i,o=r.length,s;if(arguments.length<2){var a=this.node().__on;if(a){for(var c=0,l=a.length,u;c<l;++c)for(i=0,u=a[c];i<o;++i)if((s=r[i]).type===u.type&&s.name===u.name)return u.value}return}for(a=e?Lm:Dm,i=0;i<o;++i)this.each(a(r[i],e,n));return this}function Xs(t,e,n){var r=Ws(t),i=r.CustomEvent;typeof i=="function"?i=new i(e,n):(i=r.document.createEvent("Event"),n?(i.initEvent(e,n.bubbles,n.cancelable),i.detail=n.detail):i.initEvent(e,!1,!1)),t.dispatchEvent(i)}function zm(t,e){return function(){return Xs(this,t,e)}}function Vm(t,e){return function(){return Xs(this,t,e.apply(this,arguments))}}function qm(t,e){return this.each((typeof e=="function"?Vm:zm)(t,e))}function*Wm(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var r=t[e],i=0,o=r.length,s;i<o;++i)(s=r[i])&&(yield s)}var Zs=[null];function je(t,e){this._groups=t,this._parents=e}function an(){return new je([[document.documentElement]],Zs)}function Hm(){return this}je.prototype=an.prototype={constructor:je,select:gf,selectAll:wf,selectChild:_f,selectChildren:Nf,filter:Pf,data:$f,enter:Tf,exit:Df,join:Lf,merge:Ff,selection:Hm,order:zf,sort:Vf,call:Wf,nodes:Hf,node:Uf,size:Qf,empty:Yf,each:Xf,attr:nm,style:sm,property:um,classed:fm,text:xm,html:Mm,raise:Cm,lower:Sm,append:Om,insert:Nm,remove:Tm,clone:Im,datum:Rm,on:Fm,dispatch:qm,[Symbol.iterator]:Wm};function Ie(t){return typeof t=="string"?new je([[document.querySelector(t)]],[document.documentElement]):new je([[t]],Zs)}function Um(t){let e;for(;e=t.sourceEvent;)t=e;return t}function $e(t,e){if(t=Um(t),e===void 0&&(e=t.currentTarget),e){var n=e.ownerSVGElement||e;if(n.createSVGPoint){var r=n.createSVGPoint();return r.x=t.clientX,r.y=t.clientY,r=r.matrixTransform(e.getScreenCTM().inverse()),[r.x,r.y]}if(e.getBoundingClientRect){var i=e.getBoundingClientRect();return[t.clientX-i.left-e.clientLeft,t.clientY-i.top-e.clientTop]}}return[t.pageX,t.pageY]}const Qm={passive:!1},cn={capture:!0,passive:!1};function vi(t){t.stopImmediatePropagation()}function Tt(t){t.preventDefault(),t.stopImmediatePropagation()}function Gs(t){var e=t.document.documentElement,n=Ie(t).on("dragstart.drag",Tt,cn);"onselectstart"in e?n.on("selectstart.drag",Tt,cn):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}function Ks(t,e){var n=t.document.documentElement,r=Ie(t).on("dragstart.drag",null);e&&(r.on("click.drag",Tt,cn),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in n?r.on("selectstart.drag",null):(n.style.MozUserSelect=n.__noselect,delete n.__noselect)}const tr=t=>()=>t;function wi(t,{sourceEvent:e,subject:n,target:r,identifier:i,active:o,x:s,y:a,dx:c,dy:l,dispatch:u}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:n,enumerable:!0,configurable:!0},target:{value:r,enumerable:!0,configurable:!0},identifier:{value:i,enumerable:!0,configurable:!0},active:{value:o,enumerable:!0,configurable:!0},x:{value:s,enumerable:!0,configurable:!0},y:{value:a,enumerable:!0,configurable:!0},dx:{value:c,enumerable:!0,configurable:!0},dy:{value:l,enumerable:!0,configurable:!0},_:{value:u}})}wi.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};function Ym(t){return!t.ctrlKey&&!t.button}function Xm(){return this.parentNode}function Zm(t,e){return e??{x:t.x,y:t.y}}function Gm(){return navigator.maxTouchPoints||"ontouchstart"in this}function Js(){var t=Ym,e=Xm,n=Zm,r=Gm,i={},o=Gn("start","drag","end"),s=0,a,c,l,u,d=0;function h(x){x.on("mousedown.drag",p).filter(r).on("touchstart.drag",y).on("touchmove.drag",g,Qm).on("touchend.drag touchcancel.drag",w).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function p(x,C){if(!(u||!t.call(this,x,C))){var $=v(this,e.call(this,x,C),x,C,"mouse");$&&(Ie(x.view).on("mousemove.drag",f,cn).on("mouseup.drag",m,cn),Gs(x.view),vi(x),l=!1,a=x.clientX,c=x.clientY,$("start",x))}}function f(x){if(Tt(x),!l){var C=x.clientX-a,$=x.clientY-c;l=C*C+$*$>d}i.mouse("drag",x)}function m(x){Ie(x.view).on("mousemove.drag mouseup.drag",null),Ks(x.view,l),Tt(x),i.mouse("end",x)}function y(x,C){if(t.call(this,x,C)){var $=x.changedTouches,O=e.call(this,x,C),E=$.length,T,A;for(T=0;T<E;++T)(A=v(this,O,x,C,$[T].identifier,$[T]))&&(vi(x),A("start",x,$[T]))}}function g(x){var C=x.changedTouches,$=C.length,O,E;for(O=0;O<$;++O)(E=i[C[O].identifier])&&(Tt(x),E("drag",x,C[O]))}function w(x){var C=x.changedTouches,$=C.length,O,E;for(u&&clearTimeout(u),u=setTimeout(function(){u=null},500),O=0;O<$;++O)(E=i[C[O].identifier])&&(vi(x),E("end",x,C[O]))}function v(x,C,$,O,E,T){var A=o.copy(),z=$e(T||$,C),V,F,b;if((b=n.call(x,new wi("beforestart",{sourceEvent:$,target:h,identifier:E,active:s,x:z[0],y:z[1],dx:0,dy:0,dispatch:A}),O))!=null)return V=b.x-z[0]||0,F=b.y-z[1]||0,function N(M,R,S){var P=z,D;switch(M){case"start":i[E]=N,D=s++;break;case"end":delete i[E],--s;case"drag":z=$e(S||R,C),D=s;break}A.call(M,x,new wi(M,{sourceEvent:R,subject:b,target:h,identifier:E,active:D,x:z[0]+V,y:z[1]+F,dx:z[0]-P[0],dy:z[1]-P[1],dispatch:A}),O)}}return h.filter=function(x){return arguments.length?(t=typeof x=="function"?x:tr(!!x),h):t},h.container=function(x){return arguments.length?(e=typeof x=="function"?x:tr(x),h):e},h.subject=function(x){return arguments.length?(n=typeof x=="function"?x:tr(x),h):n},h.touchable=function(x){return arguments.length?(r=typeof x=="function"?x:tr(!!x),h):r},h.on=function(){var x=o.on.apply(o,arguments);return x===o?h:x},h.clickDistance=function(x){return arguments.length?(d=(x=+x)*x,h):Math.sqrt(d)},h}function Mi(t,e,n){t.prototype=e.prototype=n,n.constructor=t}function ea(t,e){var n=Object.create(t.prototype);for(var r in e)n[r]=e[r];return n}function ln(){}var un=.7,nr=1/un,kt="\\s*([+-]?\\d+)\\s*",dn="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",Ve="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Km=/^#([0-9a-f]{3,8})$/,Jm=new RegExp(`^rgb\\(${kt},${kt},${kt}\\)$`),ey=new RegExp(`^rgb\\(${Ve},${Ve},${Ve}\\)$`),ty=new RegExp(`^rgba\\(${kt},${kt},${kt},${dn}\\)$`),ny=new RegExp(`^rgba\\(${Ve},${Ve},${Ve},${dn}\\)$`),ry=new RegExp(`^hsl\\(${dn},${Ve},${Ve}\\)$`),iy=new RegExp(`^hsla\\(${dn},${Ve},${Ve},${dn}\\)$`),ta={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Mi(ln,St,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:na,formatHex:na,formatHex8:oy,formatHsl:sy,formatRgb:ra,toString:ra});function na(){return this.rgb().formatHex()}function oy(){return this.rgb().formatHex8()}function sy(){return ca(this).formatHsl()}function ra(){return this.rgb().formatRgb()}St=function(t){var e,n;return t=(t+"").trim().toLowerCase(),(e=Km.exec(t))?(n=e[1].length,e=parseInt(e[1],16),n===6?ia(e):n===3?new ke(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):n===8?rr(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):n===4?rr(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=Jm.exec(t))?new ke(e[1],e[2],e[3],1):(e=ey.exec(t))?new ke(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=ty.exec(t))?rr(e[1],e[2],e[3],e[4]):(e=ny.exec(t))?rr(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=ry.exec(t))?aa(e[1],e[2]/100,e[3]/100,1):(e=iy.exec(t))?aa(e[1],e[2]/100,e[3]/100,e[4]):ta.hasOwnProperty(t)?ia(ta[t]):t==="transparent"?new ke(NaN,NaN,NaN,0):null};function ia(t){return new ke(t>>16&255,t>>8&255,t&255,1)}function rr(t,e,n,r){return r<=0&&(t=e=n=NaN),new ke(t,e,n,r)}function ay(t){return t instanceof ln||(t=St(t)),t?(t=t.rgb(),new ke(t.r,t.g,t.b,t.opacity)):new ke}function Ei(t,e,n,r){return arguments.length===1?ay(t):new ke(t,e,n,r??1)}function ke(t,e,n,r){this.r=+t,this.g=+e,this.b=+n,this.opacity=+r}Mi(ke,Ei,ea(ln,{brighter(t){return t=t==null?nr:Math.pow(nr,t),new ke(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=t==null?un:Math.pow(un,t),new ke(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new ke(dt(this.r),dt(this.g),dt(this.b),ir(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:oa,formatHex:oa,formatHex8:cy,formatRgb:sa,toString:sa}));function oa(){return`#${ht(this.r)}${ht(this.g)}${ht(this.b)}`}function cy(){return`#${ht(this.r)}${ht(this.g)}${ht(this.b)}${ht((isNaN(this.opacity)?1:this.opacity)*255)}`}function sa(){const t=ir(this.opacity);return`${t===1?"rgb(":"rgba("}${dt(this.r)}, ${dt(this.g)}, ${dt(this.b)}${t===1?")":`, ${t})`}`}function ir(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function dt(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function ht(t){return t=dt(t),(t<16?"0":"")+t.toString(16)}function aa(t,e,n,r){return r<=0?t=e=n=NaN:n<=0||n>=1?t=e=NaN:e<=0&&(t=NaN),new Be(t,e,n,r)}function ca(t){if(t instanceof Be)return new Be(t.h,t.s,t.l,t.opacity);if(t instanceof ln||(t=St(t)),!t)return new Be;if(t instanceof Be)return t;t=t.rgb();var e=t.r/255,n=t.g/255,r=t.b/255,i=Math.min(e,n,r),o=Math.max(e,n,r),s=NaN,a=o-i,c=(o+i)/2;return a?(e===o?s=(n-r)/a+(n<r)*6:n===o?s=(r-e)/a+2:s=(e-n)/a+4,a/=c<.5?o+i:2-o-i,s*=60):a=c>0&&c<1?0:s,new Be(s,a,c,t.opacity)}function ly(t,e,n,r){return arguments.length===1?ca(t):new Be(t,e,n,r??1)}function Be(t,e,n,r){this.h=+t,this.s=+e,this.l=+n,this.opacity=+r}Mi(Be,ly,ea(ln,{brighter(t){return t=t==null?nr:Math.pow(nr,t),new Be(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=t==null?un:Math.pow(un,t),new Be(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+(this.h<0)*360,e=isNaN(t)||isNaN(this.s)?0:this.s,n=this.l,r=n+(n<.5?n:1-n)*e,i=2*n-r;return new ke(Ci(t>=240?t-240:t+120,i,r),Ci(t,i,r),Ci(t<120?t+240:t-120,i,r),this.opacity)},clamp(){return new Be(la(this.h),or(this.s),or(this.l),ir(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=ir(this.opacity);return`${t===1?"hsl(":"hsla("}${la(this.h)}, ${or(this.s)*100}%, ${or(this.l)*100}%${t===1?")":`, ${t})`}`}}));function la(t){return t=(t||0)%360,t<0?t+360:t}function or(t){return Math.max(0,Math.min(1,t||0))}function Ci(t,e,n){return(t<60?e+(n-e)*t/60:t<180?n:t<240?e+(n-e)*(240-t)/60:e)*255}fi=t=>()=>t;function uy(t,e){return function(n){return t+n*e}}function dy(t,e,n){return t=Math.pow(t,n),e=Math.pow(e,n)-t,n=1/n,function(r){return Math.pow(t+r*e,n)}}function hy(t){return(t=+t)==1?ua:function(e,n){return n-e?dy(e,n,t):fi(isNaN(e)?n:e)}}function ua(t,e){var n=e-t;return n?uy(t,n):fi(isNaN(t)?e:t)}pi=function t(e){var n=hy(e);function r(i,o){var s=n((i=Ei(i)).r,(o=Ei(o)).r),a=n(i.g,o.g),c=n(i.b,o.b),l=ua(i.opacity,o.opacity);return function(u){return i.r=s(u),i.g=a(u),i.b=c(u),i.opacity=l(u),i+""}}return r.gamma=t,r}(1),Qe=function(t,e){return t=+t,e=+e,function(n){return t*(1-n)+e*n}};var _i=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Si=new RegExp(_i.source,"g");function py(t){return function(){return t}}function fy(t){return function(e){return t(e)+""}}Ss=function(t,e){var n=_i.lastIndex=Si.lastIndex=0,r,i,o,s=-1,a=[],c=[];for(t=t+"",e=e+"";(r=_i.exec(t))&&(i=Si.exec(e));)(o=i.index)>n&&(o=e.slice(n,o),a[s]?a[s]+=o:a[++s]=o),(r=r[0])===(i=i[0])?a[s]?a[s]+=i:a[++s]=i:(a[++s]=null,c.push({i:s,x:Qe(r,i)})),n=Si.lastIndex;return n<e.length&&(o=e.slice(n),a[s]?a[s]+=o:a[++s]=o),a.length<2?c[0]?fy(c[0].x):py(e):(e=c.length,function(l){for(var u=0,d;u<e;++u)a[(d=c[u]).i]=d.x(l);return a.join("")})};var da=180/Math.PI,ha={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function pa(t,e,n,r,i,o){var s,a,c;return(s=Math.sqrt(t*t+e*e))&&(t/=s,e/=s),(c=t*n+e*r)&&(n-=t*c,r-=e*c),(a=Math.sqrt(n*n+r*r))&&(n/=a,r/=a,c/=a),t*r<e*n&&(t=-t,e=-e,c=-c,s=-s),{translateX:i,translateY:o,rotate:Math.atan2(e,t)*da,skewX:Math.atan(c)*da,scaleX:s,scaleY:a}}var sr;function my(t){const e=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(t+"");return e.isIdentity?ha:pa(e.a,e.b,e.c,e.d,e.e,e.f)}function yy(t){return t==null||(sr||(sr=document.createElementNS("http://www.w3.org/2000/svg","g")),sr.setAttribute("transform",t),!(t=sr.transform.baseVal.consolidate()))?ha:(t=t.matrix,pa(t.a,t.b,t.c,t.d,t.e,t.f))}function fa(t,e,n,r){function i(l){return l.length?l.pop()+" ":""}function o(l,u,d,h,p,f){if(l!==d||u!==h){var m=p.push("translate(",null,e,null,n);f.push({i:m-4,x:Qe(l,d)},{i:m-2,x:Qe(u,h)})}else(d||h)&&p.push("translate("+d+e+h+n)}function s(l,u,d,h){l!==u?(l-u>180?u+=360:u-l>180&&(l+=360),h.push({i:d.push(i(d)+"rotate(",null,r)-2,x:Qe(l,u)})):u&&d.push(i(d)+"rotate("+u+r)}function a(l,u,d,h){l!==u?h.push({i:d.push(i(d)+"skewX(",null,r)-2,x:Qe(l,u)}):u&&d.push(i(d)+"skewX("+u+r)}function c(l,u,d,h,p,f){if(l!==d||u!==h){var m=p.push(i(p)+"scale(",null,",",null,")");f.push({i:m-4,x:Qe(l,d)},{i:m-2,x:Qe(u,h)})}else(d!==1||h!==1)&&p.push(i(p)+"scale("+d+","+h+")")}return function(l,u){var d=[],h=[];return l=t(l),u=t(u),o(l.translateX,l.translateY,u.translateX,u.translateY,d,h),s(l.rotate,u.rotate,d,h),a(l.skewX,u.skewX,d,h),c(l.scaleX,l.scaleY,u.scaleX,u.scaleY,d,h),l=u=null,function(p){for(var f=-1,m=h.length,y;++f<m;)d[(y=h[f]).i]=y.x(p);return d.join("")}}}var gy=fa(my,"px, ","px)","deg)"),xy=fa(yy,", ",")",")"),by=1e-12;function ma(t){return((t=Math.exp(t))+1/t)/2}function vy(t){return((t=Math.exp(t))-1/t)/2}function wy(t){return((t=Math.exp(2*t))-1)/(t+1)}const My=function t(e,n,r){function i(o,s){var a=o[0],c=o[1],l=o[2],u=s[0],d=s[1],h=s[2],p=u-a,f=d-c,m=p*p+f*f,y,g;if(m<by)g=Math.log(h/l)/e,y=function(O){return[a+O*p,c+O*f,l*Math.exp(e*O*g)]};else{var w=Math.sqrt(m),v=(h*h-l*l+r*m)/(2*l*n*w),x=(h*h-l*l-r*m)/(2*h*n*w),C=Math.log(Math.sqrt(v*v+1)-v),$=Math.log(Math.sqrt(x*x+1)-x);g=($-C)/e,y=function(O){var E=O*g,T=ma(C),A=l/(n*w)*(T*wy(e*E+C)-vy(C));return[a+A*p,c+A*f,l*T/ma(e*E+C)]}}return y.duration=g*1e3*e/Math.SQRT2,y}return i.rho=function(o){var s=Math.max(.001,+o),a=s*s,c=a*a;return t(s,a,c)},i}(Math.SQRT2,2,4);var jt=0,hn=0,pn=0,ya=1e3,ar,fn,cr=0,pt=0,lr=0,mn=typeof performance=="object"&&performance.now?performance:Date,ga=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function Oi(){return pt||(ga(Ey),pt=mn.now()+lr)}function Ey(){pt=0}function ur(){this._call=this._time=this._next=null}ur.prototype=xa.prototype={constructor:ur,restart:function(t,e,n){if(typeof t!="function")throw new TypeError("callback is not a function");n=(n==null?Oi():+n)+(e==null?0:+e),!this._next&&fn!==this&&(fn?fn._next=this:ar=this,fn=this),this._call=t,this._time=n,Ai()},stop:function(){this._call&&(this._call=null,this._time=1/0,Ai())}};function xa(t,e,n){var r=new ur;return r.restart(t,e,n),r}function Cy(){Oi(),++jt;for(var t=ar,e;t;)(e=pt-t._time)>=0&&t._call.call(void 0,e),t=t._next;--jt}function ba(){pt=(cr=mn.now())+lr,jt=hn=0;try{Cy()}finally{jt=0,Sy(),pt=0}}function _y(){var t=mn.now(),e=t-cr;e>ya&&(lr-=e,cr=t)}function Sy(){for(var t,e=ar,n,r=1/0;e;)e._call?(r>e._time&&(r=e._time),t=e,e=e._next):(n=e._next,e._next=null,e=t?t._next=n:ar=n);fn=t,Ai(r)}function Ai(t){if(!jt){hn&&(hn=clearTimeout(hn));var e=t-pt;e>24?(t<1/0&&(hn=setTimeout(ba,t-mn.now()-lr)),pn&&(pn=clearInterval(pn))):(pn||(cr=mn.now(),pn=setInterval(_y,ya)),jt=1,ga(ba))}}function va(t,e,n){var r=new ur;return e=e==null?0:+e,r.restart(i=>{r.stop(),t(i+e)},e,n),r}var Oy=Gn("start","end","cancel","interrupt"),Ay=[],wa=0,Ma=1,Ni=2,dr=3,Ea=4,Pi=5,hr=6;function pr(t,e,n,r,i,o){var s=t.__transition;if(!s)t.__transition={};else if(n in s)return;Ny(t,n,{name:e,index:r,group:i,on:Oy,tween:Ay,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:wa})}function Ti(t,e){var n=De(t,e);if(n.state>wa)throw new Error("too late; already scheduled");return n}function qe(t,e){var n=De(t,e);if(n.state>dr)throw new Error("too late; already running");return n}function De(t,e){var n=t.__transition;if(!n||!(n=n[e]))throw new Error("transition not found");return n}function Ny(t,e,n){var r=t.__transition,i;r[e]=n,n.timer=xa(o,0,n.time);function o(l){n.state=Ma,n.timer.restart(s,n.delay,n.time),n.delay<=l&&s(l-n.delay)}function s(l){var u,d,h,p;if(n.state!==Ma)return c();for(u in r)if(p=r[u],p.name===n.name){if(p.state===dr)return va(s);p.state===Ea?(p.state=hr,p.timer.stop(),p.on.call("interrupt",t,t.__data__,p.index,p.group),delete r[u]):+u<e&&(p.state=hr,p.timer.stop(),p.on.call("cancel",t,t.__data__,p.index,p.group),delete r[u])}if(va(function(){n.state===dr&&(n.state=Ea,n.timer.restart(a,n.delay,n.time),a(l))}),n.state=Ni,n.on.call("start",t,t.__data__,n.index,n.group),n.state===Ni){for(n.state=dr,i=new Array(h=n.tween.length),u=0,d=-1;u<h;++u)(p=n.tween[u].value.call(t,t.__data__,n.index,n.group))&&(i[++d]=p);i.length=d+1}}function a(l){for(var u=l<n.duration?n.ease.call(null,l/n.duration):(n.timer.restart(c),n.state=Pi,1),d=-1,h=i.length;++d<h;)i[d].call(t,u);n.state===Pi&&(n.on.call("end",t,t.__data__,n.index,n.group),c())}function c(){n.state=hr,n.timer.stop(),delete r[e];for(var l in r)return;delete t.__transition}}function fr(t,e){var n=t.__transition,r,i,o=!0,s;if(n){e=e==null?null:e+"";for(s in n){if((r=n[s]).name!==e){o=!1;continue}i=r.state>Ni&&r.state<Pi,r.state=hr,r.timer.stop(),r.on.call(i?"interrupt":"cancel",t,t.__data__,r.index,r.group),delete n[s]}o&&delete t.__transition}}function Py(t){return this.each(function(){fr(this,t)})}function Ty(t,e){var n,r;return function(){var i=qe(this,t),o=i.tween;if(o!==n){r=n=o;for(var s=0,a=r.length;s<a;++s)if(r[s].name===e){r=r.slice(),r.splice(s,1);break}}i.tween=r}}function ky(t,e,n){var r,i;if(typeof n!="function")throw new Error;return function(){var o=qe(this,t),s=o.tween;if(s!==r){i=(r=s).slice();for(var a={name:e,value:n},c=0,l=i.length;c<l;++c)if(i[c].name===e){i[c]=a;break}c===l&&i.push(a)}o.tween=i}}function jy(t,e){var n=this._id;if(t+="",arguments.length<2){for(var r=De(this.node(),n).tween,i=0,o=r.length,s;i<o;++i)if((s=r[i]).name===t)return s.value;return null}return this.each((e==null?Ty:ky)(n,t,e))}function ki(t,e,n){var r=t._id;return t.each(function(){var i=qe(this,r);(i.value||(i.value={}))[e]=n.apply(this,arguments)}),function(i){return De(i,r).value[e]}}function Ca(t,e){var n;return(typeof e=="number"?Qe:e instanceof St?pi:(n=St(e))?(e=n,pi):Ss)(t,e)}function Iy(t){return function(){this.removeAttribute(t)}}function Ry(t){return function(){this.removeAttributeNS(t.space,t.local)}}function $y(t,e,n){var r,i=n+"",o;return function(){var s=this.getAttribute(t);return s===i?null:s===r?o:o=e(r=s,n)}}function By(t,e,n){var r,i=n+"",o;return function(){var s=this.getAttributeNS(t.space,t.local);return s===i?null:s===r?o:o=e(r=s,n)}}function Dy(t,e,n){var r,i,o;return function(){var s,a=n(this),c;return a==null?void this.removeAttribute(t):(s=this.getAttribute(t),c=a+"",s===c?null:s===r&&c===i?o:(i=c,o=e(r=s,a)))}}function Ly(t,e,n){var r,i,o;return function(){var s,a=n(this),c;return a==null?void this.removeAttributeNS(t.space,t.local):(s=this.getAttributeNS(t.space,t.local),c=a+"",s===c?null:s===r&&c===i?o:(i=c,o=e(r=s,a)))}}function Fy(t,e){var n=Jn(t),r=n==="transform"?xy:Ca;return this.attrTween(t,typeof e=="function"?(n.local?Ly:Dy)(n,r,ki(this,"attr."+t,e)):e==null?(n.local?Ry:Iy)(n):(n.local?By:$y)(n,r,e))}function zy(t,e){return function(n){this.setAttribute(t,e.call(this,n))}}function Vy(t,e){return function(n){this.setAttributeNS(t.space,t.local,e.call(this,n))}}function qy(t,e){var n,r;function i(){var o=e.apply(this,arguments);return o!==r&&(n=(r=o)&&Vy(t,o)),n}return i._value=e,i}function Wy(t,e){var n,r;function i(){var o=e.apply(this,arguments);return o!==r&&(n=(r=o)&&zy(t,o)),n}return i._value=e,i}function Hy(t,e){var n="attr."+t;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(e==null)return this.tween(n,null);if(typeof e!="function")throw new Error;var r=Jn(t);return this.tween(n,(r.local?qy:Wy)(r,e))}function Uy(t,e){return function(){Ti(this,t).delay=+e.apply(this,arguments)}}function Qy(t,e){return e=+e,function(){Ti(this,t).delay=e}}function Yy(t){var e=this._id;return arguments.length?this.each((typeof t=="function"?Uy:Qy)(e,t)):De(this.node(),e).delay}function Xy(t,e){return function(){qe(this,t).duration=+e.apply(this,arguments)}}function Zy(t,e){return e=+e,function(){qe(this,t).duration=e}}function Gy(t){var e=this._id;return arguments.length?this.each((typeof t=="function"?Xy:Zy)(e,t)):De(this.node(),e).duration}function Ky(t,e){if(typeof e!="function")throw new Error;return function(){qe(this,t).ease=e}}function Jy(t){var e=this._id;return arguments.length?this.each(Ky(e,t)):De(this.node(),e).ease}function eg(t,e){return function(){var n=e.apply(this,arguments);if(typeof n!="function")throw new Error;qe(this,t).ease=n}}function tg(t){if(typeof t!="function")throw new Error;return this.each(eg(this._id,t))}function ng(t){typeof t!="function"&&(t=zs(t));for(var e=this._groups,n=e.length,r=new Array(n),i=0;i<n;++i)for(var o=e[i],s=o.length,a=r[i]=[],c,l=0;l<s;++l)(c=o[l])&&t.call(c,c.__data__,l,o)&&a.push(c);return new Xe(r,this._parents,this._name,this._id)}function rg(t){if(t._id!==this._id)throw new Error;for(var e=this._groups,n=t._groups,r=e.length,i=n.length,o=Math.min(r,i),s=new Array(r),a=0;a<o;++a)for(var c=e[a],l=n[a],u=c.length,d=s[a]=new Array(u),h,p=0;p<u;++p)(h=c[p]||l[p])&&(d[p]=h);for(;a<r;++a)s[a]=e[a];return new Xe(s,this._parents,this._name,this._id)}function ig(t){return(t+"").trim().split(/^|\s+/).every(function(e){var n=e.indexOf(".");return n>=0&&(e=e.slice(0,n)),!e||e==="start"})}function og(t,e,n){var r,i,o=ig(e)?Ti:qe;return function(){var s=o(this,t),a=s.on;a!==r&&(i=(r=a).copy()).on(e,n),s.on=i}}function sg(t,e){var n=this._id;return arguments.length<2?De(this.node(),n).on.on(t):this.each(og(n,t,e))}function ag(t){return function(){var e=this.parentNode;for(var n in this.__transition)if(+n!==t)return;e&&e.removeChild(this)}}function cg(){return this.on("end.remove",ag(this._id))}function lg(t){var e=this._name,n=this._id;typeof t!="function"&&(t=xi(t));for(var r=this._groups,i=r.length,o=new Array(i),s=0;s<i;++s)for(var a=r[s],c=a.length,l=o[s]=new Array(c),u,d,h=0;h<c;++h)(u=a[h])&&(d=t.call(u,u.__data__,h,a))&&("__data__"in u&&(d.__data__=u.__data__),l[h]=d,pr(l[h],e,n,h,l,De(u,n)));return new Xe(o,this._parents,e,n)}function ug(t){var e=this._name,n=this._id;typeof t!="function"&&(t=Fs(t));for(var r=this._groups,i=r.length,o=[],s=[],a=0;a<i;++a)for(var c=r[a],l=c.length,u,d=0;d<l;++d)if(u=c[d]){for(var h=t.call(u,u.__data__,d,c),p,f=De(u,n),m=0,y=h.length;m<y;++m)(p=h[m])&&pr(p,e,n,m,h,f);o.push(h),s.push(u)}return new Xe(o,s,e,n)}var dg=an.prototype.constructor;function hg(){return new dg(this._groups,this._parents)}function pg(t,e){var n,r,i;return function(){var o=Pt(this,t),s=(this.style.removeProperty(t),Pt(this,t));return o===s?null:o===n&&s===r?i:i=e(n=o,r=s)}}function _a(t){return function(){this.style.removeProperty(t)}}function fg(t,e,n){var r,i=n+"",o;return function(){var s=Pt(this,t);return s===i?null:s===r?o:o=e(r=s,n)}}function mg(t,e,n){var r,i,o;return function(){var s=Pt(this,t),a=n(this),c=a+"";return a==null&&(c=a=(this.style.removeProperty(t),Pt(this,t))),s===c?null:s===r&&c===i?o:(i=c,o=e(r=s,a))}}function yg(t,e){var n,r,i,o="style."+e,s="end."+o,a;return function(){var c=qe(this,t),l=c.on,u=c.value[o]==null?a||(a=_a(e)):void 0;(l!==n||i!==u)&&(r=(n=l).copy()).on(s,i=u),c.on=r}}function gg(t,e,n){var r=(t+="")=="transform"?gy:Ca;return e==null?this.styleTween(t,pg(t,r)).on("end.style."+t,_a(t)):typeof e=="function"?this.styleTween(t,mg(t,r,ki(this,"style."+t,e))).each(yg(this._id,t)):this.styleTween(t,fg(t,r,e),n).on("end.style."+t,null)}function xg(t,e,n){return function(r){this.style.setProperty(t,e.call(this,r),n)}}function bg(t,e,n){var r,i;function o(){var s=e.apply(this,arguments);return s!==i&&(r=(i=s)&&xg(t,s,n)),r}return o._value=e,o}function vg(t,e,n){var r="style."+(t+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(e==null)return this.tween(r,null);if(typeof e!="function")throw new Error;return this.tween(r,bg(t,e,n??""))}function wg(t){return function(){this.textContent=t}}function Mg(t){return function(){var e=t(this);this.textContent=e??""}}function Eg(t){return this.tween("text",typeof t=="function"?Mg(ki(this,"text",t)):wg(t==null?"":t+""))}function Cg(t){return function(e){this.textContent=t.call(this,e)}}function _g(t){var e,n;function r(){var i=t.apply(this,arguments);return i!==n&&(e=(n=i)&&Cg(i)),e}return r._value=t,r}function Sg(t){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(t==null)return this.tween(e,null);if(typeof t!="function")throw new Error;return this.tween(e,_g(t))}function Og(){for(var t=this._name,e=this._id,n=Sa(),r=this._groups,i=r.length,o=0;o<i;++o)for(var s=r[o],a=s.length,c,l=0;l<a;++l)if(c=s[l]){var u=De(c,e);pr(c,t,n,l,s,{time:u.time+u.delay+u.duration,delay:0,duration:u.duration,ease:u.ease})}return new Xe(r,this._parents,t,n)}function Ag(){var t,e,n=this,r=n._id,i=n.size();return new Promise(function(o,s){var a={value:s},c={value:function(){--i===0&&o()}};n.each(function(){var l=qe(this,r),u=l.on;u!==t&&(e=(t=u).copy(),e._.cancel.push(a),e._.interrupt.push(a),e._.end.push(c)),l.on=e}),i===0&&o()})}var Ng=0;function Xe(t,e,n,r){this._groups=t,this._parents=e,this._name=n,this._id=r}function Sa(){return++Ng}var Ze=an.prototype;Xe.prototype={constructor:Xe,select:lg,selectAll:ug,selectChild:Ze.selectChild,selectChildren:Ze.selectChildren,filter:ng,merge:rg,selection:hg,transition:Og,call:Ze.call,nodes:Ze.nodes,node:Ze.node,size:Ze.size,empty:Ze.empty,each:Ze.each,on:sg,attr:Fy,attrTween:Hy,style:gg,styleTween:vg,text:Eg,textTween:Sg,remove:cg,tween:jy,delay:Yy,duration:Gy,ease:Jy,easeVarying:tg,end:Ag,[Symbol.iterator]:Ze[Symbol.iterator]};function Pg(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}var Tg={time:null,delay:0,duration:250,ease:Pg};function kg(t,e){for(var n;!(n=t.__transition)||!(n=n[e]);)if(!(t=t.parentNode))throw new Error(`transition ${e} not found`);return n}function jg(t){var e,n;t instanceof Xe?(e=t._id,t=t._name):(e=Sa(),(n=Tg).time=Oi(),t=t==null?null:t+"");for(var r=this._groups,i=r.length,o=0;o<i;++o)for(var s=r[o],a=s.length,c,l=0;l<a;++l)(c=s[l])&&pr(c,t,e,l,s,n||kg(c,e));return new Xe(r,this._parents,t,e)}an.prototype.interrupt=Py,an.prototype.transition=jg;const mr=t=>()=>t;function Ig(t,{sourceEvent:e,target:n,transform:r,dispatch:i}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},transform:{value:r,enumerable:!0,configurable:!0},_:{value:i}})}function Ge(t,e,n){this.k=t,this.x=e,this.y=n}Ge.prototype={constructor:Ge,scale:function(t){return t===1?this:new Ge(this.k*t,this.x,this.y)},translate:function(t,e){return t===0&e===0?this:new Ge(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var yr=new Ge(1,0,0);Oa.prototype=Ge.prototype;function Oa(t){for(;!t.__zoom;)if(!(t=t.parentNode))return yr;return t.__zoom}function ji(t){t.stopImmediatePropagation()}function yn(t){t.preventDefault(),t.stopImmediatePropagation()}function Rg(t){return(!t.ctrlKey||t.type==="wheel")&&!t.button}function $g(){var t=this;return t instanceof SVGElement?(t=t.ownerSVGElement||t,t.hasAttribute("viewBox")?(t=t.viewBox.baseVal,[[t.x,t.y],[t.x+t.width,t.y+t.height]]):[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]):[[0,0],[t.clientWidth,t.clientHeight]]}function Aa(){return this.__zoom||yr}function Bg(t){return-t.deltaY*(t.deltaMode===1?.05:t.deltaMode?1:.002)*(t.ctrlKey?10:1)}function Dg(){return navigator.maxTouchPoints||"ontouchstart"in this}function Lg(t,e,n){var r=t.invertX(e[0][0])-n[0][0],i=t.invertX(e[1][0])-n[1][0],o=t.invertY(e[0][1])-n[0][1],s=t.invertY(e[1][1])-n[1][1];return t.translate(i>r?(r+i)/2:Math.min(0,r)||Math.max(0,i),s>o?(o+s)/2:Math.min(0,o)||Math.max(0,s))}function Na(){var t=Rg,e=$g,n=Lg,r=Bg,i=Dg,o=[0,1/0],s=[[-1/0,-1/0],[1/0,1/0]],a=250,c=My,l=Gn("start","zoom","end"),u,d,h,p=500,f=150,m=0,y=10;function g(b){b.property("__zoom",Aa).on("wheel.zoom",E,{passive:!1}).on("mousedown.zoom",T).on("dblclick.zoom",A).filter(i).on("touchstart.zoom",z).on("touchmove.zoom",V).on("touchend.zoom touchcancel.zoom",F).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}g.transform=function(b,N,M,R){var S=b.selection?b.selection():b;S.property("__zoom",Aa),b!==S?C(b,N,M,R):S.interrupt().each(function(){$(this,arguments).event(R).start().zoom(null,typeof N=="function"?N.apply(this,arguments):N).end()})},g.scaleBy=function(b,N,M,R){g.scaleTo(b,function(){var S=this.__zoom.k,P=typeof N=="function"?N.apply(this,arguments):N;return S*P},M,R)},g.scaleTo=function(b,N,M,R){g.transform(b,function(){var S=e.apply(this,arguments),P=this.__zoom,D=M==null?x(S):typeof M=="function"?M.apply(this,arguments):M,W=P.invert(D),B=typeof N=="function"?N.apply(this,arguments):N;return n(v(w(P,B),D,W),S,s)},M,R)},g.translateBy=function(b,N,M,R){g.transform(b,function(){return n(this.__zoom.translate(typeof N=="function"?N.apply(this,arguments):N,typeof M=="function"?M.apply(this,arguments):M),e.apply(this,arguments),s)},null,R)},g.translateTo=function(b,N,M,R,S){g.transform(b,function(){var P=e.apply(this,arguments),D=this.__zoom,W=R==null?x(P):typeof R=="function"?R.apply(this,arguments):R;return n(yr.translate(W[0],W[1]).scale(D.k).translate(typeof N=="function"?-N.apply(this,arguments):-N,typeof M=="function"?-M.apply(this,arguments):-M),P,s)},R,S)};function w(b,N){return N=Math.max(o[0],Math.min(o[1],N)),N===b.k?b:new Ge(N,b.x,b.y)}function v(b,N,M){var R=N[0]-M[0]*b.k,S=N[1]-M[1]*b.k;return R===b.x&&S===b.y?b:new Ge(b.k,R,S)}function x(b){return[(+b[0][0]+ +b[1][0])/2,(+b[0][1]+ +b[1][1])/2]}function C(b,N,M,R){b.on("start.zoom",function(){$(this,arguments).event(R).start()}).on("interrupt.zoom end.zoom",function(){$(this,arguments).event(R).end()}).tween("zoom",function(){var S=this,P=arguments,D=$(S,P).event(R),W=e.apply(S,P),B=M==null?x(W):typeof M=="function"?M.apply(S,P):M,J=Math.max(W[1][0]-W[0][0],W[1][1]-W[0][1]),Z=S.__zoom,q=typeof N=="function"?N.apply(S,P):N,ee=c(Z.invert(B).concat(J/Z.k),q.invert(B).concat(J/q.k));return function(ne){if(ne===1)ne=q;else{var H=ee(ne),ae=J/H[2];ne=new Ge(ae,B[0]-H[0]*ae,B[1]-H[1]*ae)}D.zoom(null,ne)}})}function $(b,N,M){return!M&&b.__zooming||new O(b,N)}function O(b,N){this.that=b,this.args=N,this.active=0,this.sourceEvent=null,this.extent=e.apply(b,N),this.taps=0}O.prototype={event:function(b){return b&&(this.sourceEvent=b),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(b,N){return this.mouse&&b!=="mouse"&&(this.mouse[1]=N.invert(this.mouse[0])),this.touch0&&b!=="touch"&&(this.touch0[1]=N.invert(this.touch0[0])),this.touch1&&b!=="touch"&&(this.touch1[1]=N.invert(this.touch1[0])),this.that.__zoom=N,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(b){var N=Ie(this.that).datum();l.call(b,this.that,new Ig(b,{sourceEvent:this.sourceEvent,target:g,type:b,transform:this.that.__zoom,dispatch:l}),N)}};function E(b,...N){if(!t.apply(this,arguments))return;var M=$(this,N).event(b),R=this.__zoom,S=Math.max(o[0],Math.min(o[1],R.k*Math.pow(2,r.apply(this,arguments)))),P=$e(b);if(M.wheel)(M.mouse[0][0]!==P[0]||M.mouse[0][1]!==P[1])&&(M.mouse[1]=R.invert(M.mouse[0]=P)),clearTimeout(M.wheel);else{if(R.k===S)return;M.mouse=[P,R.invert(P)],fr(this),M.start()}yn(b),M.wheel=setTimeout(D,f),M.zoom("mouse",n(v(w(R,S),M.mouse[0],M.mouse[1]),M.extent,s));function D(){M.wheel=null,M.end()}}function T(b,...N){if(h||!t.apply(this,arguments))return;var M=b.currentTarget,R=$(this,N,!0).event(b),S=Ie(b.view).on("mousemove.zoom",B,!0).on("mouseup.zoom",J,!0),P=$e(b,M),D=b.clientX,W=b.clientY;Gs(b.view),ji(b),R.mouse=[P,this.__zoom.invert(P)],fr(this),R.start();function B(Z){if(yn(Z),!R.moved){var q=Z.clientX-D,ee=Z.clientY-W;R.moved=q*q+ee*ee>m}R.event(Z).zoom("mouse",n(v(R.that.__zoom,R.mouse[0]=$e(Z,M),R.mouse[1]),R.extent,s))}function J(Z){S.on("mousemove.zoom mouseup.zoom",null),Ks(Z.view,R.moved),yn(Z),R.event(Z).end()}}function A(b,...N){if(t.apply(this,arguments)){var M=this.__zoom,R=$e(b.changedTouches?b.changedTouches[0]:b,this),S=M.invert(R),P=M.k*(b.shiftKey?.5:2),D=n(v(w(M,P),R,S),e.apply(this,N),s);yn(b),a>0?Ie(this).transition().duration(a).call(C,D,R,b):Ie(this).call(g.transform,D,R,b)}}function z(b,...N){if(t.apply(this,arguments)){var M=b.touches,R=M.length,S=$(this,N,b.changedTouches.length===R).event(b),P,D,W,B;for(ji(b),D=0;D<R;++D)W=M[D],B=$e(W,this),B=[B,this.__zoom.invert(B),W.identifier],S.touch0?!S.touch1&&S.touch0[2]!==B[2]&&(S.touch1=B,S.taps=0):(S.touch0=B,P=!0,S.taps=1+!!u);u&&(u=clearTimeout(u)),P&&(S.taps<2&&(d=B[0],u=setTimeout(function(){u=null},p)),fr(this),S.start())}}function V(b,...N){if(this.__zooming){var M=$(this,N).event(b),R=b.changedTouches,S=R.length,P,D,W,B;for(yn(b),P=0;P<S;++P)D=R[P],W=$e(D,this),M.touch0&&M.touch0[2]===D.identifier?M.touch0[0]=W:M.touch1&&M.touch1[2]===D.identifier&&(M.touch1[0]=W);if(D=M.that.__zoom,M.touch1){var J=M.touch0[0],Z=M.touch0[1],q=M.touch1[0],ee=M.touch1[1],ne=(ne=q[0]-J[0])*ne+(ne=q[1]-J[1])*ne,H=(H=ee[0]-Z[0])*H+(H=ee[1]-Z[1])*H;D=w(D,Math.sqrt(ne/H)),W=[(J[0]+q[0])/2,(J[1]+q[1])/2],B=[(Z[0]+ee[0])/2,(Z[1]+ee[1])/2]}else if(M.touch0)W=M.touch0[0],B=M.touch0[1];else return;M.zoom("touch",n(v(D,W,B),M.extent,s))}}function F(b,...N){if(this.__zooming){var M=$(this,N).event(b),R=b.changedTouches,S=R.length,P,D;for(ji(b),h&&clearTimeout(h),h=setTimeout(function(){h=null},p),P=0;P<S;++P)D=R[P],M.touch0&&M.touch0[2]===D.identifier?delete M.touch0:M.touch1&&M.touch1[2]===D.identifier&&delete M.touch1;if(M.touch1&&!M.touch0&&(M.touch0=M.touch1,delete M.touch1),M.touch0)M.touch0[1]=this.__zoom.invert(M.touch0[0]);else if(M.end(),M.taps===2&&(D=$e(D,this),Math.hypot(d[0]-D[0],d[1]-D[1])<y)){var W=Ie(this).on("dblclick.zoom");W&&W.apply(this,arguments)}}}return g.wheelDelta=function(b){return arguments.length?(r=typeof b=="function"?b:mr(+b),g):r},g.filter=function(b){return arguments.length?(t=typeof b=="function"?b:mr(!!b),g):t},g.touchable=function(b){return arguments.length?(i=typeof b=="function"?b:mr(!!b),g):i},g.extent=function(b){return arguments.length?(e=typeof b=="function"?b:mr([[+b[0][0],+b[0][1]],[+b[1][0],+b[1][1]]]),g):e},g.scaleExtent=function(b){return arguments.length?(o[0]=+b[0],o[1]=+b[1],g):[o[0],o[1]]},g.translateExtent=function(b){return arguments.length?(s[0][0]=+b[0][0],s[1][0]=+b[1][0],s[0][1]=+b[0][1],s[1][1]=+b[1][1],g):[[s[0][0],s[0][1]],[s[1][0],s[1][1]]]},g.constrain=function(b){return arguments.length?(n=b,g):n},g.duration=function(b){return arguments.length?(a=+b,g):a},g.interpolate=function(b){return arguments.length?(c=b,g):c},g.on=function(){var b=l.on.apply(l,arguments);return b===l?g:b},g.clickDistance=function(b){return arguments.length?(m=(b=+b)*b,g):Math.sqrt(m)},g.tapDistance=function(b){return arguments.length?(y=+b,g):y},g}const Ke={error001:()=>"[React Flow]: Seems like you have not used zustand provider as an ancestor. Help: https://reactflow.dev/error#001",error002:()=>"It looks like you've created a new nodeTypes or edgeTypes object. If this wasn't on purpose please define the nodeTypes/edgeTypes outside of the component or memoize them.",error003:t=>`Node type "${t}" not found. Using fallback type "default".`,error004:()=>"The React Flow parent container needs a width and a height to render the graph.",error005:()=>"Only child nodes can use a parent extent.",error006:()=>"Can't create edge. An edge needs a source and a target.",error007:t=>`The old edge with id=${t} does not exist.`,error009:t=>`Marker type "${t}" doesn't exist.`,error008:(t,{id:e,sourceHandle:n,targetHandle:r})=>`Couldn't create edge for ${t} handle id: "${t==="source"?n:r}", edge id: ${e}.`,error010:()=>"Handle: No node id found. Make sure to only use a Handle inside a custom Node.",error011:t=>`Edge type "${t}" not found. Using fallback type "default".`,error012:t=>`Node with id "${t}" does not exist, it may have been removed. This can happen when a node is deleted before the "onNodeClick" handler is called.`,error013:(t="react")=>`It seems that you haven't loaded the styles. Please import '@xyflow/${t}/dist/style.css' or base.css to make sure everything is working properly.`},gn=[[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY]],Pa=["Enter"," ","Escape"];var It;(function(t){t.Strict="strict",t.Loose="loose"})(It||(It={})),function(t){t.Free="free",t.Vertical="vertical",t.Horizontal="horizontal"}(ut||(ut={}));var xn;(function(t){t.Partial="partial",t.Full="full"})(xn||(xn={}));const Ta={inProgress:!1,isValid:null,from:null,fromHandle:null,fromPosition:null,fromNode:null,to:null,toHandle:null,toPosition:null,toNode:null};var rt;(function(t){t.Bezier="default",t.Straight="straight",t.Step="step",t.SmoothStep="smoothstep",t.SimpleBezier="simplebezier"})(rt||(rt={}));var gr;(function(t){t.Arrow="arrow",t.ArrowClosed="arrowclosed"})(gr||(gr={})),function(t){t.Left="left",t.Top="top",t.Right="right",t.Bottom="bottom"}(re||(re={}));const ka={[re.Left]:re.Right,[re.Right]:re.Left,[re.Top]:re.Bottom,[re.Bottom]:re.Top};function Fg(t,e){if(!t&&!e)return!0;if(!t||!e||t.size!==e.size)return!1;if(!t.size&&!e.size)return!0;for(const n of t.keys())if(!e.has(n))return!1;return!0}function ja(t,e,n){if(!n)return;const r=[];t.forEach((i,o)=>{e!=null&&e.has(o)||r.push(i)}),r.length&&n(r)}function Ia(t){return t===null?null:t?"valid":"invalid"}const Ra=t=>"id"in t&&"source"in t&&"target"in t,zg=t=>"id"in t&&"position"in t&&!("source"in t)&&!("target"in t),Ii=t=>"id"in t&&"internals"in t&&!("source"in t)&&!("target"in t),bn=(t,e=[0,0])=>{const{width:n,height:r}=Je(t),i=t.origin??e,o=n*i[0],s=r*i[1];return{x:t.position.x-o,y:t.position.y-s}},Vg=(t,e={nodeOrigin:[0,0],nodeLookup:void 0})=>{if(t.length===0)return{x:0,y:0,width:0,height:0};const n=t.reduce((r,i)=>{const o=typeof i=="string";let s=!e.nodeLookup&&!o?i:void 0;e.nodeLookup&&(s=o?e.nodeLookup.get(i):Ii(i)?i:e.nodeLookup.get(i.id));const a=s?vr(s,e.nodeOrigin):{x:0,y:0,x2:0,y2:0};return xr(r,a)},{x:1/0,y:1/0,x2:-1/0,y2:-1/0});return br(n)},vn=(t,e={})=>{if(t.size===0)return{x:0,y:0,width:0,height:0};let n={x:1/0,y:1/0,x2:-1/0,y2:-1/0};return t.forEach(r=>{if(e.filter===void 0||e.filter(r)){const i=vr(r);n=xr(n,i)}}),br(n)},$a=(t,e,[n,r,i]=[0,0,1],o=!1,s=!1)=>{const a={...Mn(e,[n,r,i]),width:e.width/i,height:e.height/i},c=[];for(const l of t.values()){const{measured:u,selectable:d=!0,hidden:h=!1}=l;if(s&&!d||h)continue;const p=u.width??l.width??l.initialWidth??null,f=u.height??l.height??l.initialHeight??null,m=wn(a,$t(l)),y=(p??0)*(f??0),g=o&&m>0;(!l.internals.handleBounds||g||m>=y||l.dragging)&&c.push(l)}return c},qg=(t,e)=>{const n=new Set;return t.forEach(r=>{n.add(r.id)}),e.filter(r=>n.has(r.source)||n.has(r.target))};function Ri(t,e){const n=new Map,r=e!=null&&e.nodes?new Set(e.nodes.map(i=>i.id)):null;return t.forEach(i=>{i.measured.width&&i.measured.height&&(e!=null&&e.includeHiddenNodes||!i.hidden)&&(!r||r.has(i.id))&&n.set(i.id,i)}),n}async function $i({nodes:t,width:e,height:n,panZoom:r,minZoom:i,maxZoom:o},s){if(t.size===0)return Promise.resolve(!1);const a=vn(t),c=Di(a,e,n,(s==null?void 0:s.minZoom)??i,(s==null?void 0:s.maxZoom)??o,(s==null?void 0:s.padding)??.1);return await r.setViewport(c,{duration:s==null?void 0:s.duration}),Promise.resolve(!0)}function Ba({nodeId:t,nextPosition:e,nodeLookup:n,nodeOrigin:r=[0,0],nodeExtent:i,onError:o}){const s=n.get(t),a=s.parentId?n.get(s.parentId):void 0,{x:c,y:l}=a?a.internals.positionAbsolute:{x:0,y:0},u=s.origin??r;let d=i;if(s.extent==="parent"&&!s.expandParent)if(!a)o==null||o("005",Ke.error005());else{const p=a.measured.width,f=a.measured.height;p&&f&&(d=[[c,l],[c+p,l+f]])}else a&&Bt(s.extent)&&(d=[[s.extent[0][0]+c,s.extent[0][1]+l],[s.extent[1][0]+c,s.extent[1][1]+l]]);const h=Bt(d)?ft(e,d,s.measured):e;return{position:{x:h.x-c+s.measured.width*u[0],y:h.y-l+s.measured.height*u[1]},positionAbsolute:h}}async function Wg({nodesToRemove:t=[],edgesToRemove:e=[],nodes:n,edges:r,onBeforeDelete:i}){const o=new Set(t.map(d=>d.id)),s=[];for(const d of n){if(d.deletable===!1)continue;const h=o.has(d.id),p=!h&&d.parentId&&s.find(f=>f.id===d.parentId);(h||p)&&s.push(d)}const a=new Set(e.map(d=>d.id)),c=r.filter(d=>d.deletable!==!1),l=qg(s,c);for(const d of c)a.has(d.id)&&!l.find(h=>h.id===d.id)&&l.push(d);if(!i)return{edges:l,nodes:s};const u=await i({nodes:s,edges:l});return typeof u=="boolean"?u?{edges:l,nodes:s}:{edges:[],nodes:[]}:u}const Rt=(t,e=0,n=1)=>Math.min(Math.max(t,e),n),ft=(t={x:0,y:0},e,n)=>({x:Rt(t.x,e[0][0],e[1][0]-((n==null?void 0:n.width)??0)),y:Rt(t.y,e[0][1],e[1][1]-((n==null?void 0:n.height)??0))});function Da(t,e,n){const{width:r,height:i}=Je(n),{x:o,y:s}=n.internals.positionAbsolute;return ft(t,[[o,s],[o+r,s+i]],e)}const La=(t,e,n)=>t<e?Rt(Math.abs(t-e),1,e)/e:t>n?-Rt(Math.abs(t-n),1,e)/e:0,Fa=(t,e,n=15,r=40)=>{const i=La(t.x,r,e.width-r)*n,o=La(t.y,r,e.height-r)*n;return[i,o]},xr=(t,e)=>({x:Math.min(t.x,e.x),y:Math.min(t.y,e.y),x2:Math.max(t.x2,e.x2),y2:Math.max(t.y2,e.y2)}),Bi=({x:t,y:e,width:n,height:r})=>({x:t,y:e,x2:t+n,y2:e+r}),br=({x:t,y:e,x2:n,y2:r})=>({x:t,y:e,width:n-t,height:r-e}),$t=(t,e=[0,0])=>{var i,o;const{x:n,y:r}=Ii(t)?t.internals.positionAbsolute:bn(t,e);return{x:n,y:r,width:((i=t.measured)==null?void 0:i.width)??t.width??t.initialWidth??0,height:((o=t.measured)==null?void 0:o.height)??t.height??t.initialHeight??0}},vr=(t,e=[0,0])=>{var i,o;const{x:n,y:r}=Ii(t)?t.internals.positionAbsolute:bn(t,e);return{x:n,y:r,x2:n+(((i=t.measured)==null?void 0:i.width)??t.width??t.initialWidth??0),y2:r+(((o=t.measured)==null?void 0:o.height)??t.height??t.initialHeight??0)}},za=(t,e)=>br(xr(Bi(t),Bi(e))),wn=(t,e)=>{const n=Math.max(0,Math.min(t.x+t.width,e.x+e.width)-Math.max(t.x,e.x)),r=Math.max(0,Math.min(t.y+t.height,e.y+e.height)-Math.max(t.y,e.y));return Math.ceil(n*r)},Va=t=>Le(t.width)&&Le(t.height)&&Le(t.x)&&Le(t.y),Le=t=>!isNaN(t)&&isFinite(t),Hg=(t,e)=>{},wr=(t,e=[1,1])=>({x:e[0]*Math.round(t.x/e[0]),y:e[1]*Math.round(t.y/e[1])}),Mn=({x:t,y:e},[n,r,i],o=!1,s=[1,1])=>{const a={x:(t-n)/i,y:(e-r)/i};return o?wr(a,s):a},qa=({x:t,y:e},[n,r,i])=>({x:t*i+n,y:e*i+r}),Di=(t,e,n,r,i,o)=>{const s=e/(t.width*(1+o)),a=n/(t.height*(1+o)),c=Math.min(s,a),l=Rt(c,r,i),u=t.x+t.width/2,d=t.y+t.height/2,h=e/2-u*l,p=n/2-d*l;return{x:h,y:p,zoom:l}},Mr=()=>{var t;return typeof navigator<"u"&&((t=navigator==null?void 0:navigator.userAgent)==null?void 0:t.indexOf("Mac"))>=0};function Bt(t){return t!==void 0&&t!=="parent"}function Je(t){var e,n;return{width:((e=t.measured)==null?void 0:e.width)??t.width??t.initialWidth??0,height:((n=t.measured)==null?void 0:n.height)??t.height??t.initialHeight??0}}function Wa(t){var e,n;return(((e=t.measured)==null?void 0:e.width)??t.width??t.initialWidth)!==void 0&&(((n=t.measured)==null?void 0:n.height)??t.height??t.initialHeight)!==void 0}function Ha(t,e={width:0,height:0},n,r,i){const o={...t},s=r.get(n);if(s){const a=s.origin||i;o.x+=s.internals.positionAbsolute.x-(e.width??0)*a[0],o.y+=s.internals.positionAbsolute.y-(e.height??0)*a[1]}return o}function En(t,{snapGrid:e=[0,0],snapToGrid:n=!1,transform:r,containerBounds:i}){const{x:o,y:s}=et(t),a=Mn({x:o-((i==null?void 0:i.left)??0),y:s-((i==null?void 0:i.top)??0)},r),{x:c,y:l}=n?wr(a,e):a;return{xSnapped:c,ySnapped:l,...a}}const Er=t=>({width:t.offsetWidth,height:t.offsetHeight}),Ua=t=>{var e;return((e=t.getRootNode)==null?void 0:e.call(t))||(window==null?void 0:window.document)},Ug=["INPUT","SELECT","TEXTAREA"];function Li(t){var n,r;const e=((r=(n=t.composedPath)==null?void 0:n.call(t))==null?void 0:r[0])||t.target;return Ug.includes(e==null?void 0:e.nodeName)||(e==null?void 0:e.hasAttribute("contenteditable"))||!!(e!=null&&e.closest(".nokey"))}const Qa=t=>"clientX"in t,et=(t,e)=>{var o,s;const n=Qa(t),r=n?t.clientX:(o=t.touches)==null?void 0:o[0].clientX,i=n?t.clientY:(s=t.touches)==null?void 0:s[0].clientY;return{x:r-((e==null?void 0:e.left)??0),y:i-((e==null?void 0:e.top)??0)}},Ya=(t,e,n,r,i)=>{const o=e.querySelectorAll(`.${t}`);return!o||!o.length?null:Array.from(o).map(s=>{const a=s.getBoundingClientRect();return{id:s.getAttribute("data-handleid"),type:t,nodeId:i,position:s.getAttribute("data-handlepos"),x:(a.left-n.left)/r,y:(a.top-n.top)/r,...Er(s)}})};function Xa({sourceX:t,sourceY:e,targetX:n,targetY:r,sourceControlX:i,sourceControlY:o,targetControlX:s,targetControlY:a}){const c=t*.125+i*.375+s*.375+n*.125,l=e*.125+o*.375+a*.375+r*.125,u=Math.abs(c-t),d=Math.abs(l-e);return[c,l,u,d]}function Cr(t,e){return t>=0?.5*t:e*25*Math.sqrt(-t)}function Za({pos:t,x1:e,y1:n,x2:r,y2:i,c:o}){switch(t){case re.Left:return[e-Cr(e-r,o),n];case re.Right:return[e+Cr(r-e,o),n];case re.Top:return[e,n-Cr(n-i,o)];case re.Bottom:return[e,n+Cr(i-n,o)]}}function Ga({sourceX:t,sourceY:e,sourcePosition:n=re.Bottom,targetX:r,targetY:i,targetPosition:o=re.Top,curvature:s=.25}){const[a,c]=Za({pos:n,x1:t,y1:e,x2:r,y2:i,c:s}),[l,u]=Za({pos:o,x1:r,y1:i,x2:t,y2:e,c:s}),[d,h,p,f]=Xa({sourceX:t,sourceY:e,targetX:r,targetY:i,sourceControlX:a,sourceControlY:c,targetControlX:l,targetControlY:u});return[`M${t},${e} C${a},${c} ${l},${u} ${r},${i}`,d,h,p,f]}function Ka({sourceX:t,sourceY:e,targetX:n,targetY:r}){const i=Math.abs(n-t)/2,o=n<t?n+i:n-i,s=Math.abs(r-e)/2,a=r<e?r+s:r-s;return[o,a,i,s]}function Qg({sourceNode:t,targetNode:e,selected:n=!1,zIndex:r=0,elevateOnSelect:i=!1}){if(!i)return r;const o=n||e.selected||t.selected,s=Math.max(t.internals.z||0,e.internals.z||0,1e3);return r+(o?s:0)}function Yg({sourceNode:t,targetNode:e,width:n,height:r,transform:i}){const o=xr(vr(t),vr(e));o.x===o.x2&&(o.x2+=1),o.y===o.y2&&(o.y2+=1);const s={x:-i[0]/i[2],y:-i[1]/i[2],width:n/i[2],height:r/i[2]};return wn(s,br(o))>0}const Xg=({source:t,sourceHandle:e,target:n,targetHandle:r})=>`xy-edge__${t}${e||""}-${n}${r||""}`,Zg=(t,e)=>e.some(n=>n.source===t.source&&n.target===t.target&&(n.sourceHandle===t.sourceHandle||!n.sourceHandle&&!t.sourceHandle)&&(n.targetHandle===t.targetHandle||!n.targetHandle&&!t.targetHandle)),Ja=(t,e)=>{if(!t.source||!t.target)return e;let n;return Ra(t)?n={...t}:n={...t,id:Xg(t)},Zg(n,e)?e:(n.sourceHandle===null&&delete n.sourceHandle,n.targetHandle===null&&delete n.targetHandle,e.concat(n))};function ec({sourceX:t,sourceY:e,targetX:n,targetY:r}){const[i,o,s,a]=Ka({sourceX:t,sourceY:e,targetX:n,targetY:r});return[`M ${t},${e}L ${n},${r}`,i,o,s,a]}const tc={[re.Left]:{x:-1,y:0},[re.Right]:{x:1,y:0},[re.Top]:{x:0,y:-1},[re.Bottom]:{x:0,y:1}},Gg=({source:t,sourcePosition:e=re.Bottom,target:n})=>e===re.Left||e===re.Right?t.x<n.x?{x:1,y:0}:{x:-1,y:0}:t.y<n.y?{x:0,y:1}:{x:0,y:-1},nc=(t,e)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2));function Kg({source:t,sourcePosition:e=re.Bottom,target:n,targetPosition:r=re.Top,center:i,offset:o}){const s=tc[e],a=tc[r],c={x:t.x+s.x*o,y:t.y+s.y*o},l={x:n.x+a.x*o,y:n.y+a.y*o},u=Gg({source:c,sourcePosition:e,target:l}),d=u.x!==0?"x":"y",h=u[d];let p=[],f,m;const y={x:0,y:0},g={x:0,y:0},[w,v,x,C]=Ka({sourceX:t.x,sourceY:t.y,targetX:n.x,targetY:n.y});if(s[d]*a[d]===-1){f=i.x??w,m=i.y??v;const $=[{x:f,y:c.y},{x:f,y:l.y}],O=[{x:c.x,y:m},{x:l.x,y:m}];s[d]===h?p=d==="x"?$:O:p=d==="x"?O:$}else{const $=[{x:c.x,y:l.y}],O=[{x:l.x,y:c.y}];if(d==="x"?p=s.x===h?O:$:p=s.y===h?$:O,e===r){const V=Math.abs(t[d]-n[d]);if(V<=o){const F=Math.min(o-1,o-V);s[d]===h?y[d]=(c[d]>t[d]?-1:1)*F:g[d]=(l[d]>n[d]?-1:1)*F}}if(e!==r){const V=d==="x"?"y":"x",F=s[d]===a[V],b=c[V]>l[V],N=c[V]<l[V];(s[d]===1&&(!F&&b||F&&N)||s[d]!==1&&(!F&&N||F&&b))&&(p=d==="x"?$:O)}const E={x:c.x+y.x,y:c.y+y.y},T={x:l.x+g.x,y:l.y+g.y},A=Math.max(Math.abs(E.x-p[0].x),Math.abs(T.x-p[0].x)),z=Math.max(Math.abs(E.y-p[0].y),Math.abs(T.y-p[0].y));A>=z?(f=(E.x+T.x)/2,m=p[0].y):(f=p[0].x,m=(E.y+T.y)/2)}return[[t,{x:c.x+y.x,y:c.y+y.y},...p,{x:l.x+g.x,y:l.y+g.y},n],f,m,x,C]}function Jg(t,e,n,r){const i=Math.min(nc(t,e)/2,nc(e,n)/2,r),{x:o,y:s}=e;if(t.x===o&&o===n.x||t.y===s&&s===n.y)return`L${o} ${s}`;if(t.y===s){const l=t.x<n.x?-1:1,u=t.y<n.y?1:-1;return`L ${o+i*l},${s}Q ${o},${s} ${o},${s+i*u}`}const a=t.x<n.x?1:-1,c=t.y<n.y?-1:1;return`L ${o},${s+i*c}Q ${o},${s} ${o+i*a},${s}`}function Fi({sourceX:t,sourceY:e,sourcePosition:n=re.Bottom,targetX:r,targetY:i,targetPosition:o=re.Top,borderRadius:s=5,centerX:a,centerY:c,offset:l=20}){const[u,d,h,p,f]=Kg({source:{x:t,y:e},sourcePosition:n,target:{x:r,y:i},targetPosition:o,center:{x:a,y:c},offset:l});return[u.reduce((m,y,g)=>{let w="";return g>0&&g<u.length-1?w=Jg(u[g-1],y,u[g+1],s):w=`${g===0?"M":"L"}${y.x} ${y.y}`,m+=w,m},""),d,h,p,f]}function rc(t){var e;return t&&!!(t.internals.handleBounds||(e=t.handles)!=null&&e.length)&&!!(t.measured.width||t.width||t.initialWidth)}function e0(t){var d;const{sourceNode:e,targetNode:n}=t;if(!rc(e)||!rc(n))return null;const r=e.internals.handleBounds||ic(e.handles),i=n.internals.handleBounds||ic(n.handles),o=oc((r==null?void 0:r.source)??[],t.sourceHandle),s=oc(t.connectionMode===It.Strict?(i==null?void 0:i.target)??[]:((i==null?void 0:i.target)??[]).concat((i==null?void 0:i.source)??[]),t.targetHandle);if(!o||!s)return(d=t.onError)==null||d.call(t,"008",Ke.error008(o?"target":"source",{id:t.id,sourceHandle:t.sourceHandle,targetHandle:t.targetHandle})),null;const a=(o==null?void 0:o.position)||re.Bottom,c=(s==null?void 0:s.position)||re.Top,l=Cn(e,o,a),u=Cn(n,s,c);return{sourceX:l.x,sourceY:l.y,targetX:u.x,targetY:u.y,sourcePosition:a,targetPosition:c}}function ic(t){if(!t)return null;const e=[],n=[];for(const r of t)r.width=r.width??1,r.height=r.height??1,r.type==="source"?e.push(r):r.type==="target"&&n.push(r);return{source:e,target:n}}function Cn(t,e,n=re.Left,r=!1){const i=((e==null?void 0:e.x)??0)+t.internals.positionAbsolute.x,o=((e==null?void 0:e.y)??0)+t.internals.positionAbsolute.y,{width:s,height:a}=e??Je(t);if(r)return{x:i+s/2,y:o+a/2};switch((e==null?void 0:e.position)??n){case re.Top:return{x:i+s/2,y:o};case re.Right:return{x:i+s,y:o+a/2};case re.Bottom:return{x:i+s/2,y:o+a};case re.Left:return{x:i,y:o+a/2}}}function oc(t,e){return t&&(e?t.find(n=>n.id===e):t[0])||null}function zi(t,e){return t?typeof t=="string"?t:`${e?`${e}__`:""}${Object.keys(t).sort().map(n=>`${n}=${t[n]}`).join("&")}`:""}function t0(t,{id:e,defaultColor:n,defaultMarkerStart:r,defaultMarkerEnd:i}){const o=new Set;return t.reduce((s,a)=>([a.markerStart||r,a.markerEnd||i].forEach(c=>{if(c&&typeof c=="object"){const l=zi(c,e);o.has(l)||(s.push({id:l,color:c.color||n,...c}),o.add(l))}}),s),[]).sort((s,a)=>s.id.localeCompare(a.id))}const Vi={nodeOrigin:[0,0],nodeExtent:gn,elevateNodesOnSelect:!0,defaults:{}},n0={...Vi,checkEquality:!0};function qi(t,e){const n={...t};for(const r in e)e[r]!==void 0&&(n[r]=e[r]);return n}function r0(t,e,n){const r=qi(Vi,n);for(const i of t.values())if(i.parentId)Hi(i,t,e,r);else{const o=bn(i,r.nodeOrigin),s=Bt(i.extent)?i.extent:r.nodeExtent,a=ft(o,s,Je(i));i.internals.positionAbsolute=a}}function Wi(t,e,n,r){var a,c;const i=qi(n0,r),o=new Map(e),s=i!=null&&i.elevateNodesOnSelect?1e3:0;e.clear(),n.clear();for(const l of t){let u=o.get(l.id);if(i.checkEquality&&l===(u==null?void 0:u.internals.userNode))e.set(l.id,u);else{const d=bn(l,i.nodeOrigin),h=Bt(l.extent)?l.extent:i.nodeExtent,p=ft(d,h,Je(l));u={...i.defaults,...l,measured:{width:(a=l.measured)==null?void 0:a.width,height:(c=l.measured)==null?void 0:c.height},internals:{positionAbsolute:p,handleBounds:l.measured?u==null?void 0:u.internals.handleBounds:void 0,z:sc(l,s),userNode:l}},e.set(l.id,u)}l.parentId&&Hi(u,e,n,r)}}function i0(t,e){if(!t.parentId)return;const n=e.get(t.parentId);n?n.set(t.id,t):e.set(t.parentId,new Map([[t.id,t]]))}function Hi(t,e,n,r){const{elevateNodesOnSelect:i,nodeOrigin:o,nodeExtent:s}=qi(Vi,r),a=t.parentId,c=e.get(a);if(!c){console.warn(`Parent node ${a} not found. Please make sure that parent nodes are in front of their child nodes in the nodes array.`);return}i0(t,n);const l=i?1e3:0,{x:u,y:d,z:h}=o0(t,c,o,s,l),{positionAbsolute:p}=t.internals,f=u!==p.x||d!==p.y;(f||h!==t.internals.z)&&(t.internals={...t.internals,positionAbsolute:f?{x:u,y:d}:p,z:h})}function sc(t,e){return(Le(t.zIndex)?t.zIndex:0)+(t.selected?e:0)}function o0(t,e,n,r,i){const{x:o,y:s}=e.internals.positionAbsolute,a=Je(t),c=bn(t,n),l=Bt(t.extent)?ft(c,t.extent,a):c;let u=ft({x:o+l.x,y:s+l.y},r,a);t.extent==="parent"&&(u=Da(u,a,e));const d=sc(t,i),h=e.internals.z??0;return{x:u.x,y:u.y,z:h>d?h:d}}function Ui(t,e,n,r=[0,0]){var s;const i=[],o=new Map;for(const a of t){const c=e.get(a.parentId);if(!c)continue;const l=((s=o.get(a.parentId))==null?void 0:s.expandedRect)??$t(c),u=za(l,a.rect);o.set(a.parentId,{expandedRect:u,parent:c})}return o.size>0&&o.forEach(({expandedRect:a,parent:c},l)=>{var v;const u=c.internals.positionAbsolute,d=Je(c),h=c.origin??r,p=a.x<u.x?Math.round(Math.abs(u.x-a.x)):0,f=a.y<u.y?Math.round(Math.abs(u.y-a.y)):0,m=Math.max(d.width,Math.round(a.width)),y=Math.max(d.height,Math.round(a.height)),g=(m-d.width)*h[0],w=(y-d.height)*h[1];(p>0||f>0||g||w)&&(i.push({id:l,type:"position",position:{x:c.position.x-p+g,y:c.position.y-f+w}}),(v=n.get(l))==null||v.forEach(x=>{t.some(C=>C.id===x.id)||i.push({id:x.id,type:"position",position:{x:x.position.x+p,y:x.position.y+f}})})),(d.width<a.width||d.height<a.height||p||f)&&i.push({id:l,type:"dimensions",setAttributes:!0,dimensions:{width:m+(p?h[0]*p-g:0),height:y+(f?h[1]*f-w:0)}})}),i}function s0(t,e,n,r,i,o){const s=r==null?void 0:r.querySelector(".xyflow__viewport");let a=!1;if(!s)return{changes:[],updatedInternals:a};const c=[],l=window.getComputedStyle(s),{m22:u}=new window.DOMMatrixReadOnly(l.transform),d=[];for(const h of t.values()){const p=e.get(h.id);if(p)if(p.hidden)p.internals={...p.internals,handleBounds:void 0},a=!0;else{const f=Er(h.nodeElement),m=p.measured.width!==f.width||p.measured.height!==f.height;if(f.width&&f.height&&(m||!p.internals.handleBounds||h.force)){const y=h.nodeElement.getBoundingClientRect(),g=Bt(p.extent)?p.extent:o;let{positionAbsolute:w}=p.internals;p.parentId&&p.extent==="parent"?w=Da(w,f,e.get(p.parentId)):g&&(w=ft(w,g,f)),p.measured=f,p.internals={...p.internals,positionAbsolute:w,handleBounds:{source:Ya("source",h.nodeElement,y,u,p.id),target:Ya("target",h.nodeElement,y,u,p.id)}},p.parentId&&Hi(p,e,n,{nodeOrigin:i}),a=!0,m&&(c.push({id:p.id,type:"dimensions",dimensions:f}),p.expandParent&&p.parentId&&d.push({id:p.id,parentId:p.parentId,rect:$t(p,i)}))}}}if(d.length>0){const h=Ui(d,e,n,i);c.push(...h)}return{changes:c,updatedInternals:a}}async function a0({delta:t,panZoom:e,transform:n,translateExtent:r,width:i,height:o}){if(!e||!t.x&&!t.y)return Promise.resolve(!1);const s=await e.setViewportConstrained({x:n[0]+t.x,y:n[1]+t.y,zoom:n[2]},[[0,0],[i,o]],r),a=!!s&&(s.x!==n[0]||s.y!==n[1]||s.k!==n[2]);return Promise.resolve(a)}function ac(t,e,n){t.clear(),e.clear();for(const r of n){const{source:i,target:o,sourceHandle:s=null,targetHandle:a=null}=r,c=`${i}-source-${s}`,l=`${o}-target-${a}`,u=t.get(c)||new Map,d=t.get(l)||new Map,h={edgeId:r.id,source:i,target:o,sourceHandle:s,targetHandle:a};e.set(r.id,r),t.set(c,u.set(`${o}-${a}`,h)),t.set(l,d.set(`${i}-${s}`,h))}}function cc(t,e){if(!t.parentId)return!1;const n=e.get(t.parentId);return n?n.selected?!0:cc(n,e):!1}function lc(t,e,n){let r=t;do{if(r!=null&&r.matches(e))return!0;if(r===n)return!1;r=r.parentElement}while(r);return!1}function c0(t,e,n,r){const i=new Map;for(const[o,s]of t)if((s.selected||s.id===r)&&(!s.parentId||!cc(s,t))&&(s.draggable||e&&typeof s.draggable>"u")){const a=t.get(o);a&&i.set(o,{id:o,position:a.position||{x:0,y:0},distance:{x:n.x-a.internals.positionAbsolute.x,y:n.y-a.internals.positionAbsolute.y},extent:a.extent,parentId:a.parentId,origin:a.origin,expandParent:a.expandParent,internals:{positionAbsolute:a.internals.positionAbsolute||{x:0,y:0}},measured:{width:a.measured.width??0,height:a.measured.height??0}})}return i}function Qi({nodeId:t,dragItems:e,nodeLookup:n,dragging:r=!0}){var s,a,c;const i=[];for(const[l,u]of e){const d=(s=n.get(l))==null?void 0:s.internals.userNode;d&&i.push({...d,position:u.position,dragging:r})}if(!t)return[i[0],i];const o=(a=n.get(t))==null?void 0:a.internals.userNode;return[o?{...o,position:((c=e.get(t))==null?void 0:c.position)||o.position,dragging:r}:i[0],i]}function l0({onNodeMouseDown:t,getStoreItems:e,onDragStart:n,onDrag:r,onDragStop:i}){let o={x:null,y:null},s=0,a=new Map,c=!1,l={x:0,y:0},u=null,d=!1,h=null,p=!1;function f({noDragClassName:y,handleSelector:g,domNode:w,isSelectable:v,nodeId:x,nodeClickDistance:C=0}){h=Ie(w);function $({x:A,y:z},V){const{nodeLookup:F,nodeExtent:b,snapGrid:N,snapToGrid:M,nodeOrigin:R,onNodeDrag:S,onSelectionDrag:P,onError:D,updateNodePositions:W}=e();o={x:A,y:z};let B=!1,J={x:0,y:0,x2:0,y2:0};if(a.size>1&&b){const Z=vn(a);J=Bi(Z)}for(const[Z,q]of a){if(!F.has(Z))continue;let ee={x:A-q.distance.x,y:z-q.distance.y};M&&(ee=wr(ee,N));let ne=[[b[0][0],b[0][1]],[b[1][0],b[1][1]]];if(a.size>1&&b&&!q.extent){const{positionAbsolute:oe}=q.internals,ce=oe.x-J.x+b[0][0],se=oe.x+q.measured.width-J.x2+b[1][0],he=oe.y-J.y+b[0][1],me=oe.y+q.measured.height-J.y2+b[1][1];ne=[[ce,he],[se,me]]}const{position:H,positionAbsolute:ae}=Ba({nodeId:Z,nextPosition:ee,nodeLookup:F,nodeExtent:ne,nodeOrigin:R,onError:D});B=B||q.position.x!==H.x||q.position.y!==H.y,q.position=H,q.internals.positionAbsolute=ae}if(B&&(W(a,!0),V&&(r||S||!x&&P))){const[Z,q]=Qi({nodeId:x,dragItems:a,nodeLookup:F});r==null||r(V,a,Z,q),S==null||S(V,Z,q),x||(P==null||P(V,q))}}async function O(){if(!u)return;const{transform:A,panBy:z,autoPanSpeed:V}=e(),[F,b]=Fa(l,u,V);(F!==0||b!==0)&&(o.x=(o.x??0)-F/A[2],o.y=(o.y??0)-b/A[2],await z({x:F,y:b})&&$(o,null)),s=requestAnimationFrame(O)}function E(A){var B;const{nodeLookup:z,multiSelectionActive:V,nodesDraggable:F,transform:b,snapGrid:N,snapToGrid:M,selectNodesOnDrag:R,onNodeDragStart:S,onSelectionDragStart:P,unselectNodesAndEdges:D}=e();d=!0,(!R||!v)&&!V&&x&&((B=z.get(x))!=null&&B.selected||D()),v&&R&&x&&(t==null||t(x));const W=En(A.sourceEvent,{transform:b,snapGrid:N,snapToGrid:M,containerBounds:u});if(o=W,a=c0(z,F,W,x),a.size>0&&(n||S||!x&&P)){const[J,Z]=Qi({nodeId:x,dragItems:a,nodeLookup:z});n==null||n(A.sourceEvent,a,J,Z),S==null||S(A.sourceEvent,J,Z),x||(P==null||P(A.sourceEvent,Z))}}const T=Js().clickDistance(C).on("start",A=>{const{domNode:z,nodeDragThreshold:V,transform:F,snapGrid:b,snapToGrid:N}=e();u=(z==null?void 0:z.getBoundingClientRect())||null,p=!1,V===0&&E(A),o=En(A.sourceEvent,{transform:F,snapGrid:b,snapToGrid:N,containerBounds:u}),l=et(A.sourceEvent,u)}).on("drag",A=>{const{autoPanOnNodeDrag:z,transform:V,snapGrid:F,snapToGrid:b,nodeDragThreshold:N,nodeLookup:M}=e(),R=En(A.sourceEvent,{transform:V,snapGrid:F,snapToGrid:b,containerBounds:u});if((A.sourceEvent.type==="touchmove"&&A.sourceEvent.touches.length>1||x&&!M.has(x))&&(p=!0),!p){if(!c&&z&&d&&(c=!0,O()),!d){const S=R.xSnapped-(o.x??0),P=R.ySnapped-(o.y??0);Math.sqrt(S*S+P*P)>N&&E(A)}(o.x!==R.xSnapped||o.y!==R.ySnapped)&&a&&d&&(l=et(A.sourceEvent,u),$(R,A.sourceEvent))}}).on("end",A=>{if(!(!d||p)&&(c=!1,d=!1,cancelAnimationFrame(s),a.size>0)){const{nodeLookup:z,updateNodePositions:V,onNodeDragStop:F,onSelectionDragStop:b}=e();if(V(a,!1),i||F||!x&&b){const[N,M]=Qi({nodeId:x,dragItems:a,nodeLookup:z,dragging:!1});i==null||i(A.sourceEvent,a,N,M),F==null||F(A.sourceEvent,N,M),x||(b==null||b(A.sourceEvent,M))}}}).filter(A=>{const z=A.target;return!A.button&&(!y||!lc(z,`.${y}`,w))&&(!g||lc(z,g,w))});h.call(T)}function m(){h==null||h.on(".drag",null)}return{update:f,destroy:m}}function u0(t,e,n){const r=[],i={x:t.x-n,y:t.y-n,width:n*2,height:n*2};for(const o of e.values())wn(i,$t(o))>0&&r.push(o);return r}const d0=250;function h0(t,e,n,r){var a,c;let i=[],o=1/0;const s=u0(t,n,e+d0);for(const l of s){const u=[...((a=l.internals.handleBounds)==null?void 0:a.source)??[],...((c=l.internals.handleBounds)==null?void 0:c.target)??[]];for(const d of u){if(r.nodeId===d.nodeId&&r.type===d.type&&r.id===d.id)continue;const{x:h,y:p}=Cn(l,d,d.position,!0),f=Math.sqrt(Math.pow(h-t.x,2)+Math.pow(p-t.y,2));f>e||(f<o?(i=[{...d,x:h,y:p}],o=f):f===o&&i.push({...d,x:h,y:p}))}}if(!i.length)return null;if(i.length>1){const l=r.type==="source"?"target":"source";return i.find(u=>u.type===l)??i[0]}return i[0]}function uc(t,e,n,r,i,o=!1){var l,u,d;const s=r.get(t);if(!s)return null;const a=i==="strict"?(l=s.internals.handleBounds)==null?void 0:l[e]:[...((u=s.internals.handleBounds)==null?void 0:u.source)??[],...((d=s.internals.handleBounds)==null?void 0:d.target)??[]],c=(n?a==null?void 0:a.find(h=>h.id===n):a==null?void 0:a[0])??null;return c&&o?{...c,...Cn(s,c,c.position,!0)}:c}function dc(t,e){return t||(e!=null&&e.classList.contains("target")?"target":e!=null&&e.classList.contains("source")?"source":null)}function p0(t,e){let n=null;return e?n=!0:t&&!e&&(n=!1),n}const hc=()=>!0;function f0(t,{connectionMode:e,connectionRadius:n,handleId:r,nodeId:i,edgeUpdaterType:o,isTarget:s,domNode:a,nodeLookup:c,lib:l,autoPanOnConnect:u,flowId:d,panBy:h,cancelConnection:p,onConnectStart:f,onConnect:m,onConnectEnd:y,isValidConnection:g=hc,onReconnectEnd:w,updateConnection:v,getTransform:x,getFromHandle:C,autoPanSpeed:$}){const O=Ua(t.target);let E=0,T;const{x:A,y:z}=et(t),V=O==null?void 0:O.elementFromPoint(A,z),F=dc(o,V),b=a==null?void 0:a.getBoundingClientRect();if(!b||!F)return;const N=uc(i,F,r,c,e);if(!N)return;let M=et(t,b),R=!1,S=null,P=!1,D=null;function W(){if(!u||!b)return;const[H,ae]=Fa(M,b,$);h({x:H,y:ae}),E=requestAnimationFrame(W)}const B={...N,nodeId:i,type:F,position:N.position},J=c.get(i),Z={inProgress:!0,isValid:null,from:Cn(J,B,re.Left,!0),fromHandle:B,fromPosition:B.position,fromNode:J,to:M,toHandle:null,toPosition:ka[B.position],toNode:null};v(Z);let q=Z;f==null||f(t,{nodeId:i,handleId:r,handleType:F});function ee(H){if(!C()||!B){ne(H);return}const ae=x();M=et(H,b),T=h0(Mn(M,ae,!1,[1,1]),n,c,B),R||(W(),R=!0);const oe=pc(H,{handle:T,connectionMode:e,fromNodeId:i,fromHandleId:r,fromType:s?"target":"source",isValidConnection:g,doc:O,lib:l,flowId:d,nodeLookup:c});D=oe.handleDomNode,S=oe.connection,P=p0(!!T,oe.isValid);const ce={...q,isValid:P,to:T&&P?qa({x:T.x,y:T.y},ae):M,toHandle:oe.toHandle,toPosition:P&&oe.toHandle?oe.toHandle.position:ka[B.position],toNode:oe.toHandle?c.get(oe.toHandle.nodeId):null};P&&T&&q.toHandle&&ce.toHandle&&q.toHandle.type===ce.toHandle.type&&q.toHandle.nodeId===ce.toHandle.nodeId&&q.toHandle.id===ce.toHandle.id&&q.to.x===ce.to.x&&q.to.y===ce.to.y||(v(ce),q=ce)}function ne(H){(T||D)&&S&&P&&(m==null||m(S));const{inProgress:ae,...oe}=q,ce={...oe,toPosition:q.toHandle?q.toPosition:null};y==null||y(H,ce),o&&(w==null||w(H,ce)),p(),cancelAnimationFrame(E),R=!1,P=!1,S=null,D=null,O.removeEventListener("mousemove",ee),O.removeEventListener("mouseup",ne),O.removeEventListener("touchmove",ee),O.removeEventListener("touchend",ne)}O.addEventListener("mousemove",ee),O.addEventListener("mouseup",ne),O.addEventListener("touchmove",ee),O.addEventListener("touchend",ne)}function pc(t,{handle:e,connectionMode:n,fromNodeId:r,fromHandleId:i,fromType:o,doc:s,lib:a,flowId:c,isValidConnection:l=hc,nodeLookup:u}){const d=o==="target",h=e?s.querySelector(`.${a}-flow__handle[data-id="${c}-${e==null?void 0:e.nodeId}-${e==null?void 0:e.id}-${e==null?void 0:e.type}"]`):null,{x:p,y:f}=et(t),m=s.elementFromPoint(p,f),y=m!=null&&m.classList.contains(`${a}-flow__handle`)?m:h,g={handleDomNode:y,isValid:!1,connection:null,toHandle:null};if(y){const w=dc(void 0,y),v=y.getAttribute("data-nodeid"),x=y.getAttribute("data-handleid"),C=y.classList.contains("connectable"),$=y.classList.contains("connectableend");if(!v||!w)return g;const O={source:d?v:r,sourceHandle:d?x:i,target:d?r:v,targetHandle:d?i:x};g.connection=O;const E=C&&$&&(n===It.Strict?d&&w==="source"||!d&&w==="target":v!==r||x!==i);g.isValid=E&&l(O),g.toHandle=uc(v,w,x,u,n,!1)}return g}const Yi={onPointerDown:f0,isValid:pc};function m0({domNode:t,panZoom:e,getTransform:n,getViewScale:r}){const i=Ie(t);function o({translateExtent:a,width:c,height:l,zoomStep:u=10,pannable:d=!0,zoomable:h=!0,inversePan:p=!1}){const f=v=>{const x=n();if(v.sourceEvent.type!=="wheel"||!e)return;const C=-v.sourceEvent.deltaY*(v.sourceEvent.deltaMode===1?.05:v.sourceEvent.deltaMode?1:.002)*u,$=x[2]*Math.pow(2,C);e.scaleTo($)};let m=[0,0];const y=v=>{(v.sourceEvent.type==="mousedown"||v.sourceEvent.type==="touchstart")&&(m=[v.sourceEvent.clientX??v.sourceEvent.touches[0].clientX,v.sourceEvent.clientY??v.sourceEvent.touches[0].clientY])},g=v=>{const x=n();if(v.sourceEvent.type!=="mousemove"&&v.sourceEvent.type!=="touchmove"||!e)return;const C=[v.sourceEvent.clientX??v.sourceEvent.touches[0].clientX,v.sourceEvent.clientY??v.sourceEvent.touches[0].clientY],$=[C[0]-m[0],C[1]-m[1]];m=C;const O=r()*Math.max(x[2],Math.log(x[2]))*(p?-1:1),E={x:x[0]-$[0]*O,y:x[1]-$[1]*O},T=[[0,0],[c,l]];e.setViewportConstrained({x:E.x,y:E.y,zoom:x[2]},T,a)},w=Na().on("start",y).on("zoom",d?g:null).on("zoom.wheel",h?f:null);i.call(w,{})}function s(){i.on("zoom",null)}return{update:o,destroy:s,pointer:$e}}const y0=(t,e)=>t.x!==e.x||t.y!==e.y||t.zoom!==e.k,_r=t=>({x:t.x,y:t.y,zoom:t.k}),Xi=({x:t,y:e,zoom:n})=>yr.translate(t,e).scale(n),Dt=(t,e)=>t.target.closest(`.${e}`),fc=(t,e)=>e===2&&Array.isArray(t)&&t.includes(2),Zi=(t,e=0,n=()=>{})=>{const r=typeof e=="number"&&e>0;return r||n(),r?t.transition().duration(e).on("end",n):t},mc=t=>{const e=t.ctrlKey&&Mr()?10:1;return-t.deltaY*(t.deltaMode===1?.05:t.deltaMode?1:.002)*e};function g0({zoomPanValues:t,noWheelClassName:e,d3Selection:n,d3Zoom:r,panOnScrollMode:i,panOnScrollSpeed:o,zoomOnPinch:s,onPanZoomStart:a,onPanZoom:c,onPanZoomEnd:l}){return u=>{if(Dt(u,e))return!1;u.preventDefault(),u.stopImmediatePropagation();const d=n.property("__zoom").k||1;if(u.ctrlKey&&s){const y=$e(u),g=mc(u),w=d*Math.pow(2,g);r.scaleTo(n,w,y,u);return}const h=u.deltaMode===1?20:1;let p=i===ut.Vertical?0:u.deltaX*h,f=i===ut.Horizontal?0:u.deltaY*h;!Mr()&&u.shiftKey&&i!==ut.Vertical&&(p=u.deltaY*h,f=0),r.translateBy(n,-(p/d)*o,-(f/d)*o,{internal:!0});const m=_r(n.property("__zoom"));clearTimeout(t.panScrollTimeout),t.isPanScrolling||(t.isPanScrolling=!0,a==null||a(u,m)),t.isPanScrolling&&(c==null||c(u,m),t.panScrollTimeout=setTimeout(()=>{l==null||l(u,m),t.isPanScrolling=!1},150))}}function x0({noWheelClassName:t,preventScrolling:e,d3ZoomHandler:n}){return function(r,i){if(!e&&r.type==="wheel"&&!r.ctrlKey||Dt(r,t))return null;r.preventDefault(),n.call(this,r,i)}}function b0({zoomPanValues:t,onDraggingChange:e,onPanZoomStart:n}){return r=>{var o,s,a;if((o=r.sourceEvent)!=null&&o.internal)return;const i=_r(r.transform);t.mouseButton=((s=r.sourceEvent)==null?void 0:s.button)||0,t.isZoomingOrPanning=!0,t.prevViewport=i,((a=r.sourceEvent)==null?void 0:a.type)==="mousedown"&&e(!0),n&&(n==null||n(r.sourceEvent,i))}}function v0({zoomPanValues:t,panOnDrag:e,onPaneContextMenu:n,onTransformChange:r,onPanZoom:i}){return o=>{var s,a;t.usedRightMouseButton=!!(n&&fc(e,t.mouseButton??0)),(s=o.sourceEvent)!=null&&s.sync||r([o.transform.x,o.transform.y,o.transform.k]),i&&!((a=o.sourceEvent)!=null&&a.internal)&&(i==null||i(o.sourceEvent,_r(o.transform)))}}function w0({zoomPanValues:t,panOnDrag:e,panOnScroll:n,onDraggingChange:r,onPanZoomEnd:i,onPaneContextMenu:o}){return s=>{var a;if(!((a=s.sourceEvent)!=null&&a.internal)&&(t.isZoomingOrPanning=!1,o&&fc(e,t.mouseButton??0)&&!t.usedRightMouseButton&&s.sourceEvent&&o(s.sourceEvent),t.usedRightMouseButton=!1,r(!1),i&&y0(t.prevViewport,s.transform))){const c=_r(s.transform);t.prevViewport=c,clearTimeout(t.timerId),t.timerId=setTimeout(()=>{i==null||i(s.sourceEvent,c)},n?150:0)}}}function M0({zoomActivationKeyPressed:t,zoomOnScroll:e,zoomOnPinch:n,panOnDrag:r,panOnScroll:i,zoomOnDoubleClick:o,userSelectionActive:s,noWheelClassName:a,noPanClassName:c,lib:l}){return u=>{var f;const d=t||e,h=n&&u.ctrlKey;if(u.button===1&&u.type==="mousedown"&&(Dt(u,`${l}-flow__node`)||Dt(u,`${l}-flow__edge`)))return!0;if(!r&&!d&&!i&&!o&&!n||s||Dt(u,a)&&u.type==="wheel"||Dt(u,c)&&(u.type!=="wheel"||i&&u.type==="wheel"&&!t)||!n&&u.ctrlKey&&u.type==="wheel")return!1;if(!n&&u.type==="touchstart"&&((f=u.touches)==null?void 0:f.length)>1)return u.preventDefault(),!1;if(!d&&!i&&!h&&u.type==="wheel"||!r&&(u.type==="mousedown"||u.type==="touchstart")||Array.isArray(r)&&!r.includes(u.button)&&u.type==="mousedown")return!1;const p=Array.isArray(r)&&r.includes(u.button)||!u.button||u.button<=1;return(!u.ctrlKey||u.type==="wheel")&&p}}function E0({domNode:t,minZoom:e,maxZoom:n,paneClickDistance:r,translateExtent:i,viewport:o,onPanZoom:s,onPanZoomStart:a,onPanZoomEnd:c,onDraggingChange:l}){const u={isZoomingOrPanning:!1,usedRightMouseButton:!1,prevViewport:{x:0,y:0,zoom:0},mouseButton:0,timerId:void 0,panScrollTimeout:void 0,isPanScrolling:!1},d=t.getBoundingClientRect(),h=Na().clickDistance(!Le(r)||r<0?0:r).scaleExtent([e,n]).translateExtent(i),p=Ie(t).call(h);v({x:o.x,y:o.y,zoom:Rt(o.zoom,e,n)},[[0,0],[d.width,d.height]],i);const f=p.on("wheel.zoom"),m=p.on("dblclick.zoom");h.wheelDelta(mc);function y(V,F){return p?new Promise(b=>{h==null||h.transform(Zi(p,F==null?void 0:F.duration,()=>b(!0)),V)}):Promise.resolve(!1)}function g({noWheelClassName:V,noPanClassName:F,onPaneContextMenu:b,userSelectionActive:N,panOnScroll:M,panOnDrag:R,panOnScrollMode:S,panOnScrollSpeed:P,preventScrolling:D,zoomOnPinch:W,zoomOnScroll:B,zoomOnDoubleClick:J,zoomActivationKeyPressed:Z,lib:q,onTransformChange:ee}){N&&!u.isZoomingOrPanning&&w();const ne=M&&!Z&&!N?g0({zoomPanValues:u,noWheelClassName:V,d3Selection:p,d3Zoom:h,panOnScrollMode:S,panOnScrollSpeed:P,zoomOnPinch:W,onPanZoomStart:a,onPanZoom:s,onPanZoomEnd:c}):x0({noWheelClassName:V,preventScrolling:D,d3ZoomHandler:f});if(p.on("wheel.zoom",ne,{passive:!1}),!N){const ae=b0({zoomPanValues:u,onDraggingChange:l,onPanZoomStart:a});h.on("start",ae);const oe=v0({zoomPanValues:u,panOnDrag:R,onPaneContextMenu:!!b,onPanZoom:s,onTransformChange:ee});h.on("zoom",oe);const ce=w0({zoomPanValues:u,panOnDrag:R,panOnScroll:M,onPaneContextMenu:b,onPanZoomEnd:c,onDraggingChange:l});h.on("end",ce)}const H=M0({zoomActivationKeyPressed:Z,panOnDrag:R,zoomOnScroll:B,panOnScroll:M,zoomOnDoubleClick:J,zoomOnPinch:W,userSelectionActive:N,noPanClassName:F,noWheelClassName:V,lib:q});h.filter(H),J?p.on("dblclick.zoom",m):p.on("dblclick.zoom",null)}function w(){h.on("zoom",null)}async function v(V,F,b){const N=Xi(V),M=h==null?void 0:h.constrain()(N,F,b);return M&&await y(M),new Promise(R=>R(M))}async function x(V,F){const b=Xi(V);return await y(b,F),new Promise(N=>N(b))}function C(V){if(p){const F=Xi(V),b=p.property("__zoom");(b.k!==V.zoom||b.x!==V.x||b.y!==V.y)&&(h==null||h.transform(p,F,null,{sync:!0}))}}function $(){const V=p?Oa(p.node()):{x:0,y:0,k:1};return{x:V.x,y:V.y,zoom:V.k}}function O(V,F){return p?new Promise(b=>{h==null||h.scaleTo(Zi(p,F==null?void 0:F.duration,()=>b(!0)),V)}):Promise.resolve(!1)}function E(V,F){return p?new Promise(b=>{h==null||h.scaleBy(Zi(p,F==null?void 0:F.duration,()=>b(!0)),V)}):Promise.resolve(!1)}function T(V){h==null||h.scaleExtent(V)}function A(V){h==null||h.translateExtent(V)}function z(V){const F=!Le(V)||V<0?0:V;h==null||h.clickDistance(F)}return{update:g,destroy:w,setViewport:x,setViewportConstrained:v,getViewport:$,scaleTo:O,scaleBy:E,setScaleExtent:T,setTranslateExtent:A,syncViewport:C,setClickDistance:z}}var Lt;(function(t){t.Line="line",t.Handle="handle"})(Lt||(Lt={}));const C0=["top-left","top-right","bottom-left","bottom-right"],_0=["top","right","bottom","left"];function S0({width:t,prevWidth:e,height:n,prevHeight:r,affectsX:i,affectsY:o}){const s=t-e,a=n-r,c=[s>0?1:s<0?-1:0,a>0?1:a<0?-1:0];return s&&i&&(c[0]=c[0]*-1),a&&o&&(c[1]=c[1]*-1),c}function O0(t){const e=t.includes("right")||t.includes("left"),n=t.includes("bottom")||t.includes("top"),r=t.includes("left"),i=t.includes("top");return{isHorizontal:e,isVertical:n,affectsX:r,affectsY:i}}function it(t,e){return Math.max(0,e-t)}function ot(t,e){return Math.max(0,t-e)}function Sr(t,e,n){return Math.max(0,e-t,t-n)}function yc(t,e){return t?!e:e}function A0(t,e,n,r,i,o,s,a){let{affectsX:c,affectsY:l}=e;const{isHorizontal:u,isVertical:d}=e,h=u&&d,{xSnapped:p,ySnapped:f}=n,{minWidth:m,maxWidth:y,minHeight:g,maxHeight:w}=r,{x:v,y:x,width:C,height:$,aspectRatio:O}=t;let E=Math.floor(u?p-t.pointerX:0),T=Math.floor(d?f-t.pointerY:0);const A=C+(c?-E:E),z=$+(l?-T:T),V=-o[0]*C,F=-o[1]*$;let b=Sr(A,m,y),N=Sr(z,g,w);if(s){let S=0,P=0;c&&E<0?S=it(v+E+V,s[0][0]):!c&&E>0&&(S=ot(v+A+V,s[1][0])),l&&T<0?P=it(x+T+F,s[0][1]):!l&&T>0&&(P=ot(x+z+F,s[1][1])),b=Math.max(b,S),N=Math.max(N,P)}if(a){let S=0,P=0;c&&E>0?S=ot(v+E,a[0][0]):!c&&E<0&&(S=it(v+A,a[1][0])),l&&T>0?P=ot(x+T,a[0][1]):!l&&T<0&&(P=it(x+z,a[1][1])),b=Math.max(b,S),N=Math.max(N,P)}if(i){if(u){const S=Sr(A/O,g,w)*O;if(b=Math.max(b,S),s){let P=0;!c&&!l||c&&!l&&h?P=ot(x+F+A/O,s[1][1])*O:P=it(x+F+(c?E:-E)/O,s[0][1])*O,b=Math.max(b,P)}if(a){let P=0;!c&&!l||c&&!l&&h?P=it(x+A/O,a[1][1])*O:P=ot(x+(c?E:-E)/O,a[0][1])*O,b=Math.max(b,P)}}if(d){const S=Sr(z*O,m,y)/O;if(N=Math.max(N,S),s){let P=0;!c&&!l||l&&!c&&h?P=ot(v+z*O+V,s[1][0])/O:P=it(v+(l?T:-T)*O+V,s[0][0])/O,N=Math.max(N,P)}if(a){let P=0;!c&&!l||l&&!c&&h?P=it(v+z*O,a[1][0])/O:P=ot(v+(l?T:-T)*O,a[0][0])/O,N=Math.max(N,P)}}}T=T+(T<0?N:-N),E=E+(E<0?b:-b),i&&(h?A>z*O?T=(yc(c,l)?-E:E)/O:E=(yc(c,l)?-T:T)*O:u?(T=E/O,l=c):(E=T*O,c=l));const M=c?v+E:v,R=l?x+T:x;return{width:C+(c?-E:E),height:$+(l?-T:T),x:o[0]*E*(c?-1:1)+M,y:o[1]*T*(l?-1:1)+R}}const gc={width:0,height:0,x:0,y:0},N0={...gc,pointerX:0,pointerY:0,aspectRatio:1};function P0(t){return[[0,0],[t.measured.width,t.measured.height]]}function T0(t,e,n){const r=e.position.x+t.position.x,i=e.position.y+t.position.y,o=t.measured.width??0,s=t.measured.height??0,a=n[0]*o,c=n[1]*s;return[[r-a,i-c],[r+o-a,i+s-c]]}function k0({domNode:t,nodeId:e,getStoreItems:n,onChange:r,onEnd:i}){const o=Ie(t);function s({controlPosition:c,boundaries:l,keepAspectRatio:u,onResizeStart:d,onResize:h,onResizeEnd:p,shouldResize:f}){let m={...gc},y={...N0};const g=O0(c);let w,v=null,x=[],C,$,O;const E=Js().on("start",T=>{const{nodeLookup:A,transform:z,snapGrid:V,snapToGrid:F,nodeOrigin:b,paneDomNode:N}=n();if(w=A.get(e),!w)return;v=(N==null?void 0:N.getBoundingClientRect())??null;const{xSnapped:M,ySnapped:R}=En(T.sourceEvent,{transform:z,snapGrid:V,snapToGrid:F,containerBounds:v});m={width:w.measured.width??0,height:w.measured.height??0,x:w.position.x??0,y:w.position.y??0},y={...m,pointerX:M,pointerY:R,aspectRatio:m.width/m.height},C=void 0,w.parentId&&(w.extent==="parent"||w.expandParent)&&(C=A.get(w.parentId),$=C&&w.extent==="parent"?P0(C):void 0),x=[],O=void 0;for(const[S,P]of A)if(P.parentId===e&&(x.push({id:S,position:{...P.position},extent:P.extent}),P.extent==="parent"||P.expandParent)){const D=T0(P,w,P.origin??b);O?O=[[Math.min(D[0][0],O[0][0]),Math.min(D[0][1],O[0][1])],[Math.max(D[1][0],O[1][0]),Math.max(D[1][1],O[1][1])]]:O=D}d==null||d(T,{...m})}).on("drag",T=>{const{transform:A,snapGrid:z,snapToGrid:V,nodeOrigin:F}=n(),b=En(T.sourceEvent,{transform:A,snapGrid:z,snapToGrid:V,containerBounds:v}),N=[];if(!w)return;const{x:M,y:R,width:S,height:P}=m,D={},W=w.origin??F,{width:B,height:J,x:Z,y:q}=A0(y,g,b,l,u,W,$,O),ee=B!==S,ne=J!==P,H=Z!==M&&ee,ae=q!==R&&ne;if(!H&&!ae&&!ee&&!ne)return;if((H||ae||W[0]===1||W[1]===1)&&(D.x=H?Z:m.x,D.y=ae?q:m.y,m.x=D.x,m.y=D.y,x.length>0)){const se=Z-M,he=q-R;for(const me of x)me.position={x:me.position.x-se+W[0]*(B-S),y:me.position.y-he+W[1]*(J-P)},N.push(me)}if((ee||ne)&&(D.width=ee?B:m.width,D.height=ne?J:m.height,m.width=D.width,m.height=D.height),C&&w.expandParent){const se=W[0]*(D.width??0);D.x&&D.x<se&&(m.x=se,y.x=y.x-(D.x-se));const he=W[1]*(D.height??0);D.y&&D.y<he&&(m.y=he,y.y=y.y-(D.y-he))}const oe=S0({width:m.width,prevWidth:S,height:m.height,prevHeight:P,affectsX:g.affectsX,affectsY:g.affectsY}),ce={...m,direction:oe};(f==null?void 0:f(T,ce))!==!1&&(h==null||h(T,ce),r(D,N))}).on("end",T=>{p==null||p(T,{...m}),i==null||i()});o.call(E)}function a(){o.on(".drag",null)}return{update:s,destroy:a}}var xc={exports:{}},bc={},vc={exports:{}},wc={},Ft=I;function j0(t,e){return t===e&&(t!==0||1/t===1/e)||t!==t&&e!==e}var I0=typeof Object.is=="function"?Object.is:j0,R0=Ft.useState,$0=Ft.useEffect,B0=Ft.useLayoutEffect,D0=Ft.useDebugValue;function L0(t,e){var n=e(),r=R0({inst:{value:n,getSnapshot:e}}),i=r[0].inst,o=r[1];return B0(function(){i.value=n,i.getSnapshot=e,Gi(i)&&o({inst:i})},[t,n,e]),$0(function(){return Gi(i)&&o({inst:i}),t(function(){Gi(i)&&o({inst:i})})},[t]),D0(n),n}function Gi(t){var e=t.getSnapshot;t=t.value;try{var n=e();return!I0(t,n)}catch{return!0}}function F0(t,e){return e()}var z0=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?F0:L0;wc.useSyncExternalStore=Ft.useSyncExternalStore!==void 0?Ft.useSyncExternalStore:z0,vc.exports=wc,mi=vc.exports,qp=Ue(mi);var Or=I,V0=mi;function q0(t,e){return t===e&&(t!==0||1/t===1/e)||t!==t&&e!==e}var W0=typeof Object.is=="function"?Object.is:q0,H0=V0.useSyncExternalStore,U0=Or.useRef,Q0=Or.useEffect,Y0=Or.useMemo,X0=Or.useDebugValue;bc.useSyncExternalStoreWithSelector=function(t,e,n,r,i){var o=U0(null);if(o.current===null){var s={hasValue:!1,value:null};o.current=s}else s=o.current;o=Y0(function(){function c(p){if(!l){if(l=!0,u=p,p=r(p),i!==void 0&&s.hasValue){var f=s.value;if(i(f,p))return d=f}return d=p}if(f=d,W0(u,p))return f;var m=r(p);return i!==void 0&&i(f,m)?f:(u=p,d=m)}var l=!1,u,d,h=n===void 0?null:n;return[function(){return c(e())},h===null?void 0:function(){return c(h())}]},[e,n,r,i]);var a=H0(t,o[0],o[1]);return Q0(function(){s.hasValue=!0,s.value=a},[a]),X0(a),a},xc.exports=bc;var Z0=xc.exports;let Mc,Ki,Ec,Cc,_c,Sc;Es=Ue(Z0),Mc={BASE_URL:"/NoLLMChat/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},Ki=t=>{let e;const n=new Set,r=(a,c)=>{const l=typeof a=="function"?a(e):a;if(!Object.is(l,e)){const u=e;e=c??(typeof l!="object"||l===null)?l:Object.assign({},e,l),n.forEach(d=>d(e,u))}},i=()=>e,o={setState:r,getState:i,getInitialState:()=>s,subscribe:a=>(n.add(a),()=>n.delete(a)),destroy:()=>{(Mc?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},s=e=t(r,i,o);return o},Ec=t=>t?Ki(t):Ki,{useDebugValue:Cc}=kp,{useSyncExternalStoreWithSelector:_c}=Es,Sc=t=>t;function Oc(t,e=Sc,n){const r=_c(t.subscribe,t.getState,t.getServerState||t.getInitialState,e,n);return Cc(r),r}const Ac=(t,e)=>{const n=Ec(t),r=(i,o=e)=>Oc(n,i,o);return Object.assign(r,n),r},G0=(t,e)=>t?Ac(t,e):Ac;function xe(t,e){if(Object.is(t,e))return!0;if(typeof t!="object"||t===null||typeof e!="object"||e===null)return!1;if(t instanceof Map&&e instanceof Map){if(t.size!==e.size)return!1;for(const[r,i]of t)if(!Object.is(i,e.get(r)))return!1;return!0}if(t instanceof Set&&e instanceof Set){if(t.size!==e.size)return!1;for(const r of t)if(!e.has(r))return!1;return!0}const n=Object.keys(t);if(n.length!==Object.keys(e).length)return!1;for(const r of n)if(!Object.prototype.hasOwnProperty.call(e,r)||!Object.is(t[r],e[r]))return!1;return!0}const Ar=I.createContext(null),K0=Ar.Provider,Nc=Ke.error001();function de(t,e){const n=I.useContext(Ar);if(n===null)throw new Error(Nc);return Oc(n,t,e)}function ge(){const t=I.useContext(Ar);if(t===null)throw new Error(Nc);return I.useMemo(()=>({getState:t.getState,setState:t.setState,subscribe:t.subscribe}),[t])}const Pc={display:"none"},J0={position:"absolute",width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0px, 0px, 0px, 0px)",clipPath:"inset(100%)"},Tc="react-flow__node-desc",kc="react-flow__edge-desc",ex="react-flow__aria-live",tx=t=>t.ariaLiveMessage;function nx({rfId:t}){const e=de(tx);return j.jsx("div",{id:`${ex}-${t}`,"aria-live":"assertive","aria-atomic":"true",style:J0,children:e})}function rx({rfId:t,disableKeyboardA11y:e}){return j.jsxs(j.Fragment,{children:[j.jsxs("div",{id:`${Tc}-${t}`,style:Pc,children:["Press enter or space to select a node.",!e&&"You can then use the arrow keys to move the node around."," Press delete to remove it and escape to cancel."," "]}),j.jsx("div",{id:`${kc}-${t}`,style:Pc,children:"Press enter or space to select an edge. You can then press delete to remove it or escape to cancel."}),!e&&j.jsx(nx,{rfId:t})]})}const ix=t=>t.userSelectionActive?"none":"all";function Ji({position:t="top-left",children:e,className:n,style:r,...i}){const o=de(ix),s=`${t}`.split("-");return j.jsx("div",{className:Ee(["react-flow__panel",n,...s]),style:{...r,pointerEvents:o},...i,children:e})}function ox({proOptions:t,position:e="bottom-right"}){return t!=null&&t.hideAttribution?null:j.jsx(Ji,{position:e,className:"react-flow__attribution","data-message":"Please only hide this attribution when you are subscribed to React Flow Pro: https://pro.reactflow.dev",children:j.jsx("a",{href:"https://reactflow.dev",target:"_blank",rel:"noopener noreferrer","aria-label":"React Flow attribution",children:"React Flow"})})}const sx=t=>{const e=[],n=[];for(const[,r]of t.nodeLookup)r.selected&&e.push(r.internals.userNode);for(const[,r]of t.edgeLookup)r.selected&&n.push(r);return{selectedNodes:e,selectedEdges:n}},Nr=t=>t.id;function ax(t,e){return xe(t.selectedNodes.map(Nr),e.selectedNodes.map(Nr))&&xe(t.selectedEdges.map(Nr),e.selectedEdges.map(Nr))}function cx({onSelectionChange:t}){const e=ge(),{selectedNodes:n,selectedEdges:r}=de(sx,ax);return I.useEffect(()=>{const i={nodes:n,edges:r};t==null||t(i),e.getState().onSelectionChangeHandlers.forEach(o=>o(i))},[n,r,t]),null}const lx=t=>!!t.onSelectionChangeHandlers;function ux({onSelectionChange:t}){const e=de(lx);return t||e?j.jsx(cx,{onSelectionChange:t}):null}const jc=[0,0],dx={x:0,y:0,zoom:1},hx=["nodes","edges","defaultNodes","defaultEdges","onConnect","onConnectStart","onConnectEnd","onClickConnectStart","onClickConnectEnd","nodesDraggable","nodesConnectable","nodesFocusable","edgesFocusable","edgesReconnectable","elevateNodesOnSelect","elevateEdgesOnSelect","minZoom","maxZoom","nodeExtent","onNodesChange","onEdgesChange","elementsSelectable","connectionMode","snapGrid","snapToGrid","translateExtent","connectOnClick","defaultEdgeOptions","fitView","fitViewOptions","onNodesDelete","onEdgesDelete","onDelete","onNodeDrag","onNodeDragStart","onNodeDragStop","onSelectionDrag","onSelectionDragStart","onSelectionDragStop","onMoveStart","onMove","onMoveEnd","noPanClassName","nodeOrigin","autoPanOnConnect","autoPanOnNodeDrag","onError","connectionRadius","isValidConnection","selectNodesOnDrag","nodeDragThreshold","onBeforeDelete","debug","autoPanSpeed","paneClickDistance"],Ic=[...hx,"rfId"],px=t=>({setNodes:t.setNodes,setEdges:t.setEdges,setMinZoom:t.setMinZoom,setMaxZoom:t.setMaxZoom,setTranslateExtent:t.setTranslateExtent,setNodeExtent:t.setNodeExtent,reset:t.reset,setDefaultNodesAndEdges:t.setDefaultNodesAndEdges,setPaneClickDistance:t.setPaneClickDistance}),Rc={translateExtent:gn,nodeOrigin:jc,minZoom:.5,maxZoom:2,elementsSelectable:!0,noPanClassName:"nopan",rfId:"1",paneClickDistance:0};function fx(t){const{setNodes:e,setEdges:n,setMinZoom:r,setMaxZoom:i,setTranslateExtent:o,setNodeExtent:s,reset:a,setDefaultNodesAndEdges:c,setPaneClickDistance:l}=de(px,xe),u=ge();I.useEffect(()=>(c(t.defaultNodes,t.defaultEdges),()=>{d.current=Rc,a()}),[]);const d=I.useRef(Rc);return I.useEffect(()=>{for(const h of Ic){const p=t[h],f=d.current[h];p!==f&&(typeof t[h]>"u"||(h==="nodes"?e(p):h==="edges"?n(p):h==="minZoom"?r(p):h==="maxZoom"?i(p):h==="translateExtent"?o(p):h==="nodeExtent"?s(p):h==="paneClickDistance"?l(p):h==="fitView"?u.setState({fitViewOnInit:p}):h==="fitViewOptions"?u.setState({fitViewOnInitOptions:p}):u.setState({[h]:p})))}d.current=t},Ic.map(h=>t[h])),null}function $c(){return typeof window>"u"||!window.matchMedia?null:window.matchMedia("(prefers-color-scheme: dark)")}function mx(t){var r;const[e,n]=I.useState(t==="system"?null:t);return I.useEffect(()=>{if(t!=="system"){n(t);return}const i=$c(),o=()=>n(i!=null&&i.matches?"dark":"light");return o(),i==null||i.addEventListener("change",o),()=>{i==null||i.removeEventListener("change",o)}},[t]),e!==null?e:(r=$c())!=null&&r.matches?"dark":"light"}const Bc=typeof document<"u"?document:null;function _n(t=null,e={target:Bc,actInsideInputWithModifier:!0}){const[n,r]=I.useState(!1),i=I.useRef(!1),o=I.useRef(new Set([])),[s,a]=I.useMemo(()=>{if(t!==null){const c=(Array.isArray(t)?t:[t]).filter(u=>typeof u=="string").map(u=>u.replace("+",`
`).replace(`

`,`
+`).split(`
`)),l=c.reduce((u,d)=>u.concat(...d),[]);return[c,l]}return[[],[]]},[t]);return I.useEffect(()=>{const c=(e==null?void 0:e.target)||Bc;if(t!==null){const l=h=>{if(i.current=h.ctrlKey||h.metaKey||h.shiftKey,(!i.current||i.current&&!e.actInsideInputWithModifier)&&Li(h))return!1;const p=Lc(h.code,a);o.current.add(h[p]),Dc(s,o.current,!1)&&(h.preventDefault(),r(!0))},u=h=>{if((!i.current||i.current&&!e.actInsideInputWithModifier)&&Li(h))return!1;const p=Lc(h.code,a);Dc(s,o.current,!0)?(r(!1),o.current.clear()):o.current.delete(h[p]),h.key==="Meta"&&o.current.clear(),i.current=!1},d=()=>{o.current.clear(),r(!1)};return c==null||c.addEventListener("keydown",l),c==null||c.addEventListener("keyup",u),window.addEventListener("blur",d),window.addEventListener("contextmenu",d),()=>{c==null||c.removeEventListener("keydown",l),c==null||c.removeEventListener("keyup",u),window.removeEventListener("blur",d),window.removeEventListener("contextmenu",d)}}},[t,r]),n}function Dc(t,e,n){return t.filter(r=>n||r.length===e.size).some(r=>r.every(i=>e.has(i)))}function Lc(t,e){return e.includes(t)?"code":"key"}const yx=()=>{const t=ge();return I.useMemo(()=>({zoomIn:e=>{const{panZoom:n}=t.getState();return n?n.scaleBy(1.2,{duration:e==null?void 0:e.duration}):Promise.resolve(!1)},zoomOut:e=>{const{panZoom:n}=t.getState();return n?n.scaleBy(1/1.2,{duration:e==null?void 0:e.duration}):Promise.resolve(!1)},zoomTo:(e,n)=>{const{panZoom:r}=t.getState();return r?r.scaleTo(e,{duration:n==null?void 0:n.duration}):Promise.resolve(!1)},getZoom:()=>t.getState().transform[2],setViewport:async(e,n)=>{const{transform:[r,i,o],panZoom:s}=t.getState();return s?(await s.setViewport({x:e.x??r,y:e.y??i,zoom:e.zoom??o},{duration:n==null?void 0:n.duration}),Promise.resolve(!0)):Promise.resolve(!1)},getViewport:()=>{const[e,n,r]=t.getState().transform;return{x:e,y:n,zoom:r}},fitView:e=>{const{nodeLookup:n,minZoom:r,maxZoom:i,panZoom:o,domNode:s}=t.getState();if(!o||!s)return Promise.resolve(!1);const a=Ri(n,e),{width:c,height:l}=Er(s);return $i({nodes:a,width:c,height:l,minZoom:r,maxZoom:i,panZoom:o},e)},setCenter:async(e,n,r)=>{const{width:i,height:o,maxZoom:s,panZoom:a}=t.getState(),c=typeof(r==null?void 0:r.zoom)<"u"?r.zoom:s,l=i/2-e*c,u=o/2-n*c;return a?(await a.setViewport({x:l,y:u,zoom:c},{duration:r==null?void 0:r.duration}),Promise.resolve(!0)):Promise.resolve(!1)},fitBounds:async(e,n)=>{const{width:r,height:i,minZoom:o,maxZoom:s,panZoom:a}=t.getState(),c=Di(e,r,i,o,s,(n==null?void 0:n.padding)??.1);return a?(await a.setViewport(c,{duration:n==null?void 0:n.duration}),Promise.resolve(!0)):Promise.resolve(!1)},screenToFlowPosition:(e,n={snapToGrid:!0})=>{const{transform:r,snapGrid:i,domNode:o}=t.getState();if(!o)return e;const{x:s,y:a}=o.getBoundingClientRect(),c={x:e.x-s,y:e.y-a};return Mn(c,r,n.snapToGrid,i)},flowToScreenPosition:e=>{const{transform:n,domNode:r}=t.getState();if(!r)return e;const{x:i,y:o}=r.getBoundingClientRect(),s=qa(e,n);return{x:s.x+i,y:s.y+o}}}),[])};function Fc(t,e){const n=[],r=new Map,i=[];for(const o of t)if(o.type==="add"){i.push(o);continue}else if(o.type==="remove"||o.type==="replace")r.set(o.id,[o]);else{const s=r.get(o.id);s?s.push(o):r.set(o.id,[o])}for(const o of e){const s=r.get(o.id);if(!s){n.push(o);continue}if(s[0].type==="remove")continue;if(s[0].type==="replace"){n.push({...s[0].item});continue}const a={...o};for(const c of s)gx(c,a);n.push(a)}return i.length&&i.forEach(o=>{o.index!==void 0?n.splice(o.index,0,{...o.item}):n.push({...o.item})}),n}function gx(t,e){switch(t.type){case"select":{e.selected=t.selected;break}case"position":{typeof t.position<"u"&&(e.position=t.position),typeof t.dragging<"u"&&(e.dragging=t.dragging);break}case"dimensions":{typeof t.dimensions<"u"&&(e.measured??(e.measured={}),e.measured.width=t.dimensions.width,e.measured.height=t.dimensions.height,t.setAttributes&&(e.width=t.dimensions.width,e.height=t.dimensions.height)),typeof t.resizing=="boolean"&&(e.resizing=t.resizing);break}}}function mt(t,e){return Fc(t,e)}function Sn(t,e){return Fc(t,e)}function yt(t,e){return{id:t,type:"select",selected:e}}function zt(t,e=new Set,n=!1){const r=[];for(const[i,o]of t){const s=e.has(i);!(o.selected===void 0&&!s)&&o.selected!==s&&(n&&(o.selected=s),r.push(yt(o.id,s)))}return r}function zc({items:t=[],lookup:e}){var i;const n=[],r=new Map(t.map(o=>[o.id,o]));for(const[o,s]of t.entries()){const a=e.get(s.id),c=((i=a==null?void 0:a.internals)==null?void 0:i.userNode)??a;c!==void 0&&c!==s&&n.push({id:s.id,item:s,type:"replace"}),c===void 0&&n.push({item:s,type:"add",index:o})}for(const[o]of e)r.get(o)===void 0&&n.push({id:o,type:"remove"});return n}function Vc(t){return{id:t.id,type:"remove"}}const qc=t=>zg(t),xx=t=>Ra(t);function Wc(t){return I.forwardRef(t)}const bx=typeof window<"u"?I.useLayoutEffect:I.useEffect;function Hc(t){const[e,n]=I.useState(BigInt(0)),[r]=I.useState(()=>vx(()=>n(i=>i+BigInt(1))));return bx(()=>{const i=r.get();i.length&&(t(i),r.reset())},[e]),r}function vx(t){let e=[];return{get:()=>e,reset:()=>{e=[]},push:n=>{e.push(n),t()}}}const Uc=I.createContext(null);function wx({children:t}){const e=ge(),n=I.useCallback(a=>{const{nodes:c=[],setNodes:l,hasDefaultNodes:u,onNodesChange:d,nodeLookup:h}=e.getState();let p=c;for(const f of a)p=typeof f=="function"?f(p):f;u?l(p):d&&d(zc({items:p,lookup:h}))},[]),r=Hc(n),i=I.useCallback(a=>{const{edges:c=[],setEdges:l,hasDefaultEdges:u,onEdgesChange:d,edgeLookup:h}=e.getState();let p=c;for(const f of a)p=typeof f=="function"?f(p):f;u?l(p):d&&d(zc({items:p,lookup:h}))},[]),o=Hc(i),s=I.useMemo(()=>({nodeQueue:r,edgeQueue:o}),[]);return j.jsx(Uc.Provider,{value:s,children:t})}function Mx(){const t=I.useContext(Uc);if(!t)throw new Error("useBatchContext must be used within a BatchProvider");return t}const Ex=t=>!!t.panZoom;Qn=function(){const t=yx(),e=ge(),n=Mx(),r=de(Ex),i=I.useMemo(()=>{const o=d=>e.getState().nodeLookup.get(d),s=d=>{n.nodeQueue.push(d)},a=d=>{n.edgeQueue.push(d)},c=d=>{var g,w;const{nodeLookup:h,nodeOrigin:p}=e.getState(),f=qc(d)?d:h.get(d.id),m=f.parentId?Ha(f.position,f.measured,f.parentId,h,p):f.position,y={id:f.id,position:m,width:((g=f.measured)==null?void 0:g.width)??f.width,height:((w=f.measured)==null?void 0:w.height)??f.height,data:f.data};return $t(y)},l=(d,h,p={replace:!1})=>{s(f=>f.map(m=>{if(m.id===d){const y=typeof h=="function"?h(m):h;return p.replace&&qc(y)?y:{...m,...y}}return m}))},u=(d,h,p={replace:!1})=>{a(f=>f.map(m=>{if(m.id===d){const y=typeof h=="function"?h(m):h;return p.replace&&xx(y)?y:{...m,...y}}return m}))};return{getNodes:()=>e.getState().nodes.map(d=>({...d})),getNode:d=>{var h;return(h=o(d))==null?void 0:h.internals.userNode},getInternalNode:o,getEdges:()=>{const{edges:d=[]}=e.getState();return d.map(h=>({...h}))},getEdge:d=>e.getState().edgeLookup.get(d),setNodes:s,setEdges:a,addNodes:d=>{const h=Array.isArray(d)?d:[d];n.nodeQueue.push(p=>[...p,...h])},addEdges:d=>{const h=Array.isArray(d)?d:[d];n.edgeQueue.push(p=>[...p,...h])},toObject:()=>{const{nodes:d=[],edges:h=[],transform:p}=e.getState(),[f,m,y]=p;return{nodes:d.map(g=>({...g})),edges:h.map(g=>({...g})),viewport:{x:f,y:m,zoom:y}}},deleteElements:async({nodes:d=[],edges:h=[]})=>{const{nodes:p,edges:f,onNodesDelete:m,onEdgesDelete:y,triggerNodeChanges:g,triggerEdgeChanges:w,onDelete:v,onBeforeDelete:x}=e.getState(),{nodes:C,edges:$}=await Wg({nodesToRemove:d,edgesToRemove:h,nodes:p,edges:f,onBeforeDelete:x}),O=$.length>0,E=C.length>0;if(O){const T=$.map(Vc);y==null||y($),w(T)}if(E){const T=C.map(Vc);m==null||m(C),g(T)}return(E||O)&&(v==null||v({nodes:C,edges:$})),{deletedNodes:C,deletedEdges:$}},getIntersectingNodes:(d,h=!0,p)=>{const f=Va(d),m=f?d:c(d),y=p!==void 0;return m?(p||e.getState().nodes).filter(g=>{const w=e.getState().nodeLookup.get(g.id);if(w&&!f&&(g.id===d.id||!w.internals.positionAbsolute))return!1;const v=$t(y?g:w),x=wn(v,m);return h&&x>0||x>=m.width*m.height}):[]},isNodeIntersecting:(d,h,p=!0)=>{const f=Va(d)?d:c(d);if(!f)return!1;const m=wn(f,h);return p&&m>0||m>=f.width*f.height},updateNode:l,updateNodeData:(d,h,p={replace:!1})=>{l(d,f=>{const m=typeof h=="function"?h(f):h;return p.replace?{...f,data:m}:{...f,data:{...f.data,...m}}},p)},updateEdge:u,updateEdgeData:(d,h,p={replace:!1})=>{u(d,f=>{const m=typeof h=="function"?h(f):h;return p.replace?{...f,data:m}:{...f,data:{...f.data,...m}}},p)},getNodesBounds:d=>{const{nodeLookup:h,nodeOrigin:p}=e.getState();return Vg(d,{nodeLookup:h,nodeOrigin:p})},getHandleConnections:({type:d,id:h,nodeId:p})=>{var f;return Array.from(((f=e.getState().connectionLookup.get(`${p}-${d}-${h??null}`))==null?void 0:f.values())??[])}}},[]);return I.useMemo(()=>({...i,...t,viewportInitialized:r}),[r])};const Qc=t=>t.selected,Cx={actInsideInputWithModifier:!1},_x=typeof window<"u"?window:void 0;function Sx({deleteKeyCode:t,multiSelectionKeyCode:e}){const n=ge(),{deleteElements:r}=Qn(),i=_n(t,Cx),o=_n(e,{target:_x});I.useEffect(()=>{if(i){const{edges:s,nodes:a}=n.getState();r({nodes:a.filter(Qc),edges:s.filter(Qc)}),n.setState({nodesSelectionActive:!1})}},[i]),I.useEffect(()=>{n.setState({multiSelectionActive:o})},[o])}function Ox(t){const e=ge();I.useEffect(()=>{const n=()=>{var i,o;if(!t.current)return!1;const r=Er(t.current);(r.height===0||r.width===0)&&((o=(i=e.getState()).onError)==null||o.call(i,"004",Ke.error004())),e.setState({width:r.width||500,height:r.height||500})};if(t.current){n(),window.addEventListener("resize",n);const r=new ResizeObserver(()=>n());return r.observe(t.current),()=>{window.removeEventListener("resize",n),r&&t.current&&r.unobserve(t.current)}}},[])}const Pr={position:"absolute",width:"100%",height:"100%",top:0,left:0},Ax=t=>({userSelectionActive:t.userSelectionActive,lib:t.lib});function Nx({onPaneContextMenu:t,zoomOnScroll:e=!0,zoomOnPinch:n=!0,panOnScroll:r=!1,panOnScrollSpeed:i=.5,panOnScrollMode:o=ut.Free,zoomOnDoubleClick:s=!0,panOnDrag:a=!0,defaultViewport:c,translateExtent:l,minZoom:u,maxZoom:d,zoomActivationKeyCode:h,preventScrolling:p=!0,children:f,noWheelClassName:m,noPanClassName:y,onViewportChange:g,isControlledViewport:w,paneClickDistance:v}){const x=ge(),C=I.useRef(null),{userSelectionActive:$,lib:O}=de(Ax,xe),E=_n(h),T=I.useRef();Ox(C);const A=I.useCallback(z=>{g==null||g({x:z[0],y:z[1],zoom:z[2]}),w||x.setState({transform:z})},[g,w]);return I.useEffect(()=>{if(C.current){T.current=E0({domNode:C.current,minZoom:u,maxZoom:d,translateExtent:l,viewport:c,paneClickDistance:v,onDraggingChange:b=>x.setState({paneDragging:b}),onPanZoomStart:(b,N)=>{const{onViewportChangeStart:M,onMoveStart:R}=x.getState();R==null||R(b,N),M==null||M(N)},onPanZoom:(b,N)=>{const{onViewportChange:M,onMove:R}=x.getState();R==null||R(b,N),M==null||M(N)},onPanZoomEnd:(b,N)=>{const{onViewportChangeEnd:M,onMoveEnd:R}=x.getState();R==null||R(b,N),M==null||M(N)}});const{x:z,y:V,zoom:F}=T.current.getViewport();return x.setState({panZoom:T.current,transform:[z,V,F],domNode:C.current.closest(".react-flow")}),()=>{var b;(b=T.current)==null||b.destroy()}}},[]),I.useEffect(()=>{var z;(z=T.current)==null||z.update({onPaneContextMenu:t,zoomOnScroll:e,zoomOnPinch:n,panOnScroll:r,panOnScrollSpeed:i,panOnScrollMode:o,zoomOnDoubleClick:s,panOnDrag:a,zoomActivationKeyPressed:E,preventScrolling:p,noPanClassName:y,userSelectionActive:$,noWheelClassName:m,lib:O,onTransformChange:A})},[t,e,n,r,i,o,s,a,E,p,y,$,m,O,A]),j.jsx("div",{className:"react-flow__renderer",ref:C,style:Pr,children:f})}const Px=t=>({userSelectionActive:t.userSelectionActive,userSelectionRect:t.userSelectionRect});function Tx(){const{userSelectionActive:t,userSelectionRect:e}=de(Px,xe);return t&&e?j.jsx("div",{className:"react-flow__selection react-flow__container",style:{width:e.width,height:e.height,transform:`translate(${e.x}px, ${e.y}px)`}}):null}const eo=(t,e)=>n=>{n.target===e.current&&(t==null||t(n))},kx=t=>({userSelectionActive:t.userSelectionActive,elementsSelectable:t.elementsSelectable,dragging:t.paneDragging});function jx({isSelecting:t,selectionKeyPressed:e,selectionMode:n=xn.Full,panOnDrag:r,selectionOnDrag:i,onSelectionStart:o,onSelectionEnd:s,onPaneClick:a,onPaneContextMenu:c,onPaneScroll:l,onPaneMouseEnter:u,onPaneMouseMove:d,onPaneMouseLeave:h,children:p}){const f=I.useRef(null),m=ge(),y=I.useRef(0),g=I.useRef(0),w=I.useRef(),v=I.useRef(new Map),{userSelectionActive:x,elementsSelectable:C,dragging:$}=de(kx,xe),O=C&&(t||x),E=I.useRef(!1),T=I.useRef(!1),A=()=>{m.setState({userSelectionActive:!1,userSelectionRect:null}),y.current=0,g.current=0},z=S=>{if(E.current){E.current=!1;return}a==null||a(S),m.getState().resetSelectedElements(),m.setState({nodesSelectionActive:!1})},V=S=>{if(Array.isArray(r)&&(r!=null&&r.includes(2))){S.preventDefault();return}c==null||c(S)},F=l?S=>l(S):void 0,b=S=>{var Z,q,ee,ne;const{resetSelectedElements:P,domNode:D,edgeLookup:W}=m.getState();if(w.current=D==null?void 0:D.getBoundingClientRect(),!C||!t||S.button!==0||S.target!==f.current||!w.current)return;(q=(Z=S.target)==null?void 0:Z.setPointerCapture)==null||q.call(Z,S.pointerId),T.current=!0,E.current=!1,v.current=new Map;for(const[H,ae]of W)v.current.set(ae.source,((ee=v.current.get(ae.source))==null?void 0:ee.add(H))||new Set([H])),v.current.set(ae.target,((ne=v.current.get(ae.target))==null?void 0:ne.add(H))||new Set([H]));const{x:B,y:J}=et(S.nativeEvent,w.current);P(),m.setState({userSelectionRect:{width:0,height:0,startX:B,startY:J,x:B,y:J}}),o==null||o(S)},N=S=>{const{userSelectionRect:P,edgeLookup:D,transform:W,nodeLookup:B,triggerNodeChanges:J,triggerEdgeChanges:Z}=m.getState();if(!w.current||!P)return;E.current=!0;const{x:q,y:ee}=et(S.nativeEvent,w.current),{startX:ne,startY:H}=P,ae={startX:ne,startY:H,x:q<ne?q:ne,y:ee<H?ee:H,width:Math.abs(q-ne),height:Math.abs(ee-H)},oe=$a(B,ae,W,n===xn.Partial,!0),ce=new Set,se=new Set;for(const he of oe){se.add(he.id);const me=v.current.get(he.id);if(me)for(const Pe of me)ce.add(Pe)}if(y.current!==se.size){y.current=se.size;const he=zt(B,se,!0);J(he)}if(g.current!==ce.size){g.current=ce.size;const he=zt(D,ce);Z(he)}m.setState({userSelectionRect:ae,userSelectionActive:!0,nodesSelectionActive:!1})},M=S=>{var D,W;if(S.button!==0||!T.current)return;(W=(D=S.target)==null?void 0:D.releasePointerCapture)==null||W.call(D,S.pointerId);const{userSelectionRect:P}=m.getState();!x&&P&&S.target===f.current&&(z==null||z(S)),y.current>0&&m.setState({nodesSelectionActive:!0}),A(),s==null||s(S),(e||i)&&(E.current=!1),T.current=!1},R=r===!0||Array.isArray(r)&&r.includes(0);return j.jsxs("div",{className:Ee(["react-flow__pane",{draggable:R,dragging:$,selection:t}]),onClick:O?void 0:eo(z,f),onContextMenu:eo(V,f),onWheel:eo(F,f),onPointerEnter:O?void 0:u,onPointerDown:O?b:d,onPointerMove:O?N:d,onPointerUp:O?M:void 0,onPointerLeave:h,ref:f,style:Pr,children:[p,j.jsx(Tx,{})]})}function to({id:t,store:e,unselect:n=!1,nodeRef:r}){const{addSelectedNodes:i,unselectNodesAndEdges:o,multiSelectionActive:s,nodeLookup:a,onError:c}=e.getState(),l=a.get(t);if(!l){c==null||c("012",Ke.error012(t));return}e.setState({nodesSelectionActive:!1}),l.selected?(n||l.selected&&s)&&(o({nodes:[l],edges:[]}),requestAnimationFrame(()=>{var u;return(u=r==null?void 0:r.current)==null?void 0:u.blur()})):i([t])}function Yc({nodeRef:t,disabled:e=!1,noDragClassName:n,handleSelector:r,nodeId:i,isSelectable:o,nodeClickDistance:s}){const a=ge(),[c,l]=I.useState(!1),u=I.useRef();return I.useEffect(()=>{u.current=l0({getStoreItems:()=>a.getState(),onNodeMouseDown:d=>{to({id:d,store:a,nodeRef:t})},onDragStart:()=>{l(!0)},onDragStop:()=>{l(!1)}})},[]),I.useEffect(()=>{var d,h;if(e)(d=u.current)==null||d.destroy();else if(t.current)return(h=u.current)==null||h.update({noDragClassName:n,handleSelector:r,domNode:t.current,isSelectable:o,nodeId:i,nodeClickDistance:s}),()=>{var p;(p=u.current)==null||p.destroy()}},[n,r,e,o,t,i]),c}const Ix=t=>e=>e.selected&&(e.draggable||t&&typeof e.draggable>"u");function Xc(){const t=ge();return I.useCallback(e=>{const{nodeExtent:n,snapToGrid:r,snapGrid:i,nodesDraggable:o,onError:s,updateNodePositions:a,nodeLookup:c,nodeOrigin:l}=t.getState(),u=new Map,d=Ix(o),h=r?i[0]:5,p=r?i[1]:5,f=e.direction.x*h*e.factor,m=e.direction.y*p*e.factor;for(const[,y]of c){if(!d(y))continue;let g={x:y.internals.positionAbsolute.x+f,y:y.internals.positionAbsolute.y+m};r&&(g=wr(g,i));const{position:w,positionAbsolute:v}=Ba({nodeId:y.id,nextPosition:g,nodeLookup:c,nodeExtent:n,nodeOrigin:l,onError:s});y.position=w,y.internals.positionAbsolute=v,u.set(y.id,y)}a(u)},[])}const no=I.createContext(null),Rx=no.Provider;no.Consumer;const ro=()=>I.useContext(no),$x=t=>({connectOnClick:t.connectOnClick,noPanClassName:t.noPanClassName,rfId:t.rfId}),Bx=(t,e,n)=>r=>{const{connectionClickStartHandle:i,connectionMode:o,connection:s}=r,{fromHandle:a,toHandle:c,isValid:l}=s,u=(c==null?void 0:c.nodeId)===t&&(c==null?void 0:c.id)===e&&(c==null?void 0:c.type)===n;return{connectingFrom:(a==null?void 0:a.nodeId)===t&&(a==null?void 0:a.id)===e&&(a==null?void 0:a.type)===n,connectingTo:u,clickConnecting:(i==null?void 0:i.nodeId)===t&&(i==null?void 0:i.id)===e&&(i==null?void 0:i.type)===n,isPossibleEndHandle:o===It.Strict?(a==null?void 0:a.type)!==n:t!==(a==null?void 0:a.nodeId)||e!==(a==null?void 0:a.id),connectionInProcess:!!a,valid:u&&l}};function Dx({type:t="source",position:e=re.Top,isValidConnection:n,isConnectable:r=!0,isConnectableStart:i=!0,isConnectableEnd:o=!0,id:s,onConnect:a,children:c,className:l,onMouseDown:u,onTouchStart:d,...h},p){var b,N;const f=s||null,m=t==="target",y=ge(),g=ro(),{connectOnClick:w,noPanClassName:v,rfId:x}=de($x,xe),{connectingFrom:C,connectingTo:$,clickConnecting:O,isPossibleEndHandle:E,connectionInProcess:T,valid:A}=de(Bx(g,f,t),xe);g||((N=(b=y.getState()).onError)==null||N.call(b,"010",Ke.error010()));const z=M=>{const{defaultEdgeOptions:R,onConnect:S,hasDefaultEdges:P}=y.getState(),D={...R,...M};if(P){const{edges:W,setEdges:B}=y.getState();B(Ja(D,W))}S==null||S(D),a==null||a(D)},V=M=>{if(!g)return;const R=Qa(M.nativeEvent);if(i&&(R&&M.button===0||!R)){const S=y.getState();Yi.onPointerDown(M.nativeEvent,{autoPanOnConnect:S.autoPanOnConnect,connectionMode:S.connectionMode,connectionRadius:S.connectionRadius,domNode:S.domNode,nodeLookup:S.nodeLookup,lib:S.lib,isTarget:m,handleId:f,nodeId:g,flowId:S.rfId,panBy:S.panBy,cancelConnection:S.cancelConnection,onConnectStart:S.onConnectStart,onConnectEnd:S.onConnectEnd,updateConnection:S.updateConnection,onConnect:z,isValidConnection:n||S.isValidConnection,getTransform:()=>y.getState().transform,getFromHandle:()=>y.getState().connection.fromHandle,autoPanSpeed:S.autoPanSpeed})}R?u==null||u(M):d==null||d(M)},F=M=>{const{onClickConnectStart:R,onClickConnectEnd:S,connectionClickStartHandle:P,connectionMode:D,isValidConnection:W,lib:B,rfId:J,nodeLookup:Z,connection:q}=y.getState();if(!g||!P&&!i)return;if(!P){R==null||R(M.nativeEvent,{nodeId:g,handleId:f,handleType:t}),y.setState({connectionClickStartHandle:{nodeId:g,type:t,id:f}});return}const ee=Ua(M.target),ne=n||W,{connection:H,isValid:ae}=Yi.isValid(M.nativeEvent,{handle:{nodeId:g,id:f,type:t},connectionMode:D,fromNodeId:P.nodeId,fromHandleId:P.id||null,fromType:P.type,isValidConnection:ne,flowId:J,doc:ee,lib:B,nodeLookup:Z});ae&&H&&z(H);const oe=structuredClone(q);delete oe.inProgress,oe.toPosition=oe.toHandle?oe.toHandle.position:null,S==null||S(M,oe),y.setState({connectionClickStartHandle:null})};return j.jsx("div",{"data-handleid":f,"data-nodeid":g,"data-handlepos":e,"data-id":`${x}-${g}-${f}-${t}`,className:Ee(["react-flow__handle",`react-flow__handle-${e}`,"nodrag",v,l,{source:!m,target:m,connectable:r,connectablestart:i,connectableend:o,clickconnecting:O,connectingfrom:C,connectingto:$,valid:A,connectionindicator:r&&(!T||E)&&(T?o:i)}]),onMouseDown:V,onTouchStart:V,onClick:w?F:void 0,ref:p,...h,children:c})}rn=I.memo(Wc(Dx));function Lx({data:t,isConnectable:e,sourcePosition:n=re.Bottom}){return j.jsxs(j.Fragment,{children:[t==null?void 0:t.label,j.jsx(rn,{type:"source",position:n,isConnectable:e})]})}function Fx({data:t,isConnectable:e,targetPosition:n=re.Top,sourcePosition:r=re.Bottom}){return j.jsxs(j.Fragment,{children:[j.jsx(rn,{type:"target",position:n,isConnectable:e}),t==null?void 0:t.label,j.jsx(rn,{type:"source",position:r,isConnectable:e})]})}function zx(){return null}function Vx({data:t,isConnectable:e,targetPosition:n=re.Top}){return j.jsxs(j.Fragment,{children:[j.jsx(rn,{type:"target",position:n,isConnectable:e}),t==null?void 0:t.label]})}const Tr={ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0}},Zc={input:Lx,default:Fx,output:Vx,group:zx};function qx(t){var e,n,r,i;return t.internals.handleBounds===void 0?{width:t.width??t.initialWidth??((e=t.style)==null?void 0:e.width),height:t.height??t.initialHeight??((n=t.style)==null?void 0:n.height)}:{width:t.width??((r=t.style)==null?void 0:r.width),height:t.height??((i=t.style)==null?void 0:i.height)}}const Wx=t=>{const{width:e,height:n,x:r,y:i}=vn(t.nodeLookup,{filter:o=>!!o.selected});return{width:Le(e)?e:null,height:Le(n)?n:null,userSelectionActive:t.userSelectionActive,transformString:`translate(${t.transform[0]}px,${t.transform[1]}px) scale(${t.transform[2]}) translate(${r}px,${i}px)`}};function Hx({onSelectionContextMenu:t,noPanClassName:e,disableKeyboardA11y:n}){const r=ge(),{width:i,height:o,transformString:s,userSelectionActive:a}=de(Wx,xe),c=Xc(),l=I.useRef(null);if(I.useEffect(()=>{var h;n||((h=l.current)==null||h.focus({preventScroll:!0}))},[n]),Yc({nodeRef:l}),a||!i||!o)return null;const u=t?h=>{const p=r.getState().nodes.filter(f=>f.selected);t(h,p)}:void 0,d=h=>{Object.prototype.hasOwnProperty.call(Tr,h.key)&&c({direction:Tr[h.key],factor:h.shiftKey?4:1})};return j.jsx("div",{className:Ee(["react-flow__nodesselection","react-flow__container",e]),style:{transform:s},children:j.jsx("div",{ref:l,className:"react-flow__nodesselection-rect",onContextMenu:u,tabIndex:n?void 0:-1,onKeyDown:n?void 0:d,style:{width:i,height:o}})})}const Gc=typeof window<"u"?window:void 0,Ux=t=>({nodesSelectionActive:t.nodesSelectionActive,userSelectionActive:t.userSelectionActive});function Kc({children:t,onPaneClick:e,onPaneMouseEnter:n,onPaneMouseMove:r,onPaneMouseLeave:i,onPaneContextMenu:o,onPaneScroll:s,paneClickDistance:a,deleteKeyCode:c,selectionKeyCode:l,selectionOnDrag:u,selectionMode:d,onSelectionStart:h,onSelectionEnd:p,multiSelectionKeyCode:f,panActivationKeyCode:m,zoomActivationKeyCode:y,elementsSelectable:g,zoomOnScroll:w,zoomOnPinch:v,panOnScroll:x,panOnScrollSpeed:C,panOnScrollMode:$,zoomOnDoubleClick:O,panOnDrag:E,defaultViewport:T,translateExtent:A,minZoom:z,maxZoom:V,preventScrolling:F,onSelectionContextMenu:b,noWheelClassName:N,noPanClassName:M,disableKeyboardA11y:R,onViewportChange:S,isControlledViewport:P}){const{nodesSelectionActive:D,userSelectionActive:W}=de(Ux),B=_n(l,{target:Gc}),J=_n(m,{target:Gc}),Z=J||E,q=J||x,ee=u&&Z!==!0,ne=B||W||ee;return Sx({deleteKeyCode:c,multiSelectionKeyCode:f}),j.jsx(Nx,{onPaneContextMenu:o,elementsSelectable:g,zoomOnScroll:w,zoomOnPinch:v,panOnScroll:q,panOnScrollSpeed:C,panOnScrollMode:$,zoomOnDoubleClick:O,panOnDrag:!B&&Z,defaultViewport:T,translateExtent:A,minZoom:z,maxZoom:V,zoomActivationKeyCode:y,preventScrolling:F,noWheelClassName:N,noPanClassName:M,onViewportChange:S,isControlledViewport:P,paneClickDistance:a,children:j.jsxs(jx,{onSelectionStart:h,onSelectionEnd:p,onPaneClick:e,onPaneMouseEnter:n,onPaneMouseMove:r,onPaneMouseLeave:i,onPaneContextMenu:o,onPaneScroll:s,panOnDrag:Z,isSelecting:!!ne,selectionMode:d,selectionKeyPressed:B,selectionOnDrag:ee,children:[t,D&&j.jsx(Hx,{onSelectionContextMenu:b,noPanClassName:M,disableKeyboardA11y:R})]})})}Kc.displayName="FlowRenderer";const Qx=I.memo(Kc),Yx=t=>e=>t?$a(e.nodeLookup,{x:0,y:0,width:e.width,height:e.height},e.transform,!0).map(n=>n.id):Array.from(e.nodeLookup.keys());function Xx(t){return de(I.useCallback(Yx(t),[t]),xe)}const Zx=t=>t.updateNodeInternals;function Gx(){const t=de(Zx),[e]=I.useState(()=>typeof ResizeObserver>"u"?null:new ResizeObserver(n=>{const r=new Map;n.forEach(i=>{const o=i.target.getAttribute("data-id");r.set(o,{id:o,nodeElement:i.target,force:!0})}),t(r)}));return I.useEffect(()=>()=>{e==null||e.disconnect()},[e]),e}function Kx({node:t,nodeType:e,hasDimensions:n,resizeObserver:r}){const i=ge(),o=I.useRef(null),s=I.useRef(null),a=I.useRef(t.sourcePosition),c=I.useRef(t.targetPosition),l=I.useRef(e),u=n&&!!t.internals.handleBounds;return I.useEffect(()=>{o.current&&!t.hidden&&(!u||s.current!==o.current)&&(s.current&&(r==null||r.unobserve(s.current)),r==null||r.observe(o.current),s.current=o.current)},[u,t.hidden]),I.useEffect(()=>()=>{s.current&&(r==null||r.unobserve(s.current),s.current=null)},[]),I.useEffect(()=>{if(o.current){const d=l.current!==e,h=a.current!==t.sourcePosition,p=c.current!==t.targetPosition;(d||h||p)&&(l.current=e,a.current=t.sourcePosition,c.current=t.targetPosition,i.getState().updateNodeInternals(new Map([[t.id,{id:t.id,nodeElement:o.current,force:!0}]])))}},[t.id,e,t.sourcePosition,t.targetPosition]),o}function Jx({id:t,onClick:e,onMouseEnter:n,onMouseMove:r,onMouseLeave:i,onContextMenu:o,onDoubleClick:s,nodesDraggable:a,elementsSelectable:c,nodesConnectable:l,nodesFocusable:u,resizeObserver:d,noDragClassName:h,noPanClassName:p,disableKeyboardA11y:f,rfId:m,nodeTypes:y,nodeExtent:g,nodeClickDistance:w,onError:v}){const{node:x,internals:C,isParent:$}=de(H=>{const ae=H.nodeLookup.get(t),oe=H.parentLookup.has(t);return{node:ae,internals:ae.internals,isParent:oe}},xe);let O=x.type||"default",E=(y==null?void 0:y[O])||Zc[O];E===void 0&&(v==null||v("003",Ke.error003(O)),O="default",E=Zc.default);const T=!!(x.draggable||a&&typeof x.draggable>"u"),A=!!(x.selectable||c&&typeof x.selectable>"u"),z=!!(x.connectable||l&&typeof x.connectable>"u"),V=!!(x.focusable||u&&typeof x.focusable>"u"),F=ge(),b=Wa(x),N=Kx({node:x,nodeType:O,hasDimensions:b,resizeObserver:d}),M=Yc({nodeRef:N,disabled:x.hidden||!T,noDragClassName:h,handleSelector:x.dragHandle,nodeId:t,isSelectable:A,nodeClickDistance:w}),R=Xc();if(x.hidden)return null;const S=Je(x),P=qx(x),D=A||T||e||n||r||i,W=n?H=>n(H,{...C.userNode}):void 0,B=r?H=>r(H,{...C.userNode}):void 0,J=i?H=>i(H,{...C.userNode}):void 0,Z=o?H=>o(H,{...C.userNode}):void 0,q=s?H=>s(H,{...C.userNode}):void 0,ee=H=>{const{selectNodesOnDrag:ae,nodeDragThreshold:oe}=F.getState();A&&(!ae||!T||oe>0)&&to({id:t,store:F,nodeRef:N}),e&&e(H,{...C.userNode})},ne=H=>{if(!(Li(H.nativeEvent)||f))if(Pa.includes(H.key)&&A){const ae=H.key==="Escape";to({id:t,store:F,unselect:ae,nodeRef:N})}else T&&x.selected&&Object.prototype.hasOwnProperty.call(Tr,H.key)&&(F.setState({ariaLiveMessage:`Moved selected node ${H.key.replace("Arrow","").toLowerCase()}. New position, x: ${~~C.positionAbsolute.x}, y: ${~~C.positionAbsolute.y}`}),R({direction:Tr[H.key],factor:H.shiftKey?4:1}))};return j.jsx("div",{className:Ee(["react-flow__node",`react-flow__node-${O}`,{[p]:T},x.className,{selected:x.selected,selectable:A,parent:$,draggable:T,dragging:M}]),ref:N,style:{zIndex:C.z,transform:`translate(${C.positionAbsolute.x}px,${C.positionAbsolute.y}px)`,pointerEvents:D?"all":"none",visibility:b?"visible":"hidden",...x.style,...P},"data-id":t,"data-testid":`rf__node-${t}`,onMouseEnter:W,onMouseMove:B,onMouseLeave:J,onContextMenu:Z,onClick:ee,onDoubleClick:q,onKeyDown:V?ne:void 0,tabIndex:V?0:void 0,role:V?"button":void 0,"aria-describedby":f?void 0:`${Tc}-${m}`,"aria-label":x.ariaLabel,children:j.jsx(Rx,{value:t,children:j.jsx(E,{id:t,data:x.data,type:O,positionAbsoluteX:C.positionAbsolute.x,positionAbsoluteY:C.positionAbsolute.y,selected:x.selected,selectable:A,draggable:T,deletable:x.deletable??!0,isConnectable:z,sourcePosition:x.sourcePosition,targetPosition:x.targetPosition,dragging:M,dragHandle:x.dragHandle,zIndex:C.z,parentId:x.parentId,...S})})})}const eb=t=>({nodesDraggable:t.nodesDraggable,nodesConnectable:t.nodesConnectable,nodesFocusable:t.nodesFocusable,elementsSelectable:t.elementsSelectable,onError:t.onError});function Jc(t){const{nodesDraggable:e,nodesConnectable:n,nodesFocusable:r,elementsSelectable:i,onError:o}=de(eb,xe),s=Xx(t.onlyRenderVisibleElements),a=Gx();return j.jsx("div",{className:"react-flow__nodes",style:Pr,children:s.map(c=>j.jsx(Jx,{id:c,nodeTypes:t.nodeTypes,nodeExtent:t.nodeExtent,onClick:t.onNodeClick,onMouseEnter:t.onNodeMouseEnter,onMouseMove:t.onNodeMouseMove,onMouseLeave:t.onNodeMouseLeave,onContextMenu:t.onNodeContextMenu,onDoubleClick:t.onNodeDoubleClick,noDragClassName:t.noDragClassName,noPanClassName:t.noPanClassName,rfId:t.rfId,disableKeyboardA11y:t.disableKeyboardA11y,resizeObserver:a,nodesDraggable:e,nodesConnectable:n,nodesFocusable:r,elementsSelectable:i,nodeClickDistance:t.nodeClickDistance,onError:o},c))})}Jc.displayName="NodeRenderer";const tb=I.memo(Jc);function nb(t){return de(I.useCallback(e=>{if(!t)return e.edges.map(r=>r.id);const n=[];if(e.width&&e.height)for(const r of e.edges){const i=e.nodeLookup.get(r.source),o=e.nodeLookup.get(r.target);i&&o&&Yg({sourceNode:i,targetNode:o,width:e.width,height:e.height,transform:e.transform})&&n.push(r.id)}return n},[t]),xe)}const rb=({color:t="none",strokeWidth:e=1})=>j.jsx("polyline",{style:{stroke:t,strokeWidth:e},strokeLinecap:"round",strokeLinejoin:"round",fill:"none",points:"-5,-4 0,0 -5,4"}),ib=({color:t="none",strokeWidth:e=1})=>j.jsx("polyline",{style:{stroke:t,fill:t,strokeWidth:e},strokeLinecap:"round",strokeLinejoin:"round",points:"-5,-4 0,0 -5,4 -5,-4"}),el={[gr.Arrow]:rb,[gr.ArrowClosed]:ib};function ob(t){const e=ge();return I.useMemo(()=>{var n,r;return Object.prototype.hasOwnProperty.call(el,t)?el[t]:((r=(n=e.getState()).onError)==null||r.call(n,"009",Ke.error009(t)),null)},[t])}const sb=({id:t,type:e,color:n,width:r=12.5,height:i=12.5,markerUnits:o="strokeWidth",strokeWidth:s,orient:a="auto-start-reverse"})=>{const c=ob(e);return c?j.jsx("marker",{className:"react-flow__arrowhead",id:t,markerWidth:`${r}`,markerHeight:`${i}`,viewBox:"-10 -10 20 20",markerUnits:o,orient:a,refX:"0",refY:"0",children:j.jsx(c,{color:n,strokeWidth:s})}):null},tl=({defaultColor:t,rfId:e})=>{const n=de(o=>o.edges),r=de(o=>o.defaultEdgeOptions),i=I.useMemo(()=>t0(n,{id:e,defaultColor:t,defaultMarkerStart:r==null?void 0:r.markerStart,defaultMarkerEnd:r==null?void 0:r.markerEnd}),[n,r,e,t]);return i.length?j.jsx("svg",{className:"react-flow__marker",children:j.jsx("defs",{children:i.map(o=>j.jsx(sb,{id:o.id,type:o.type,color:o.color,width:o.width,height:o.height,markerUnits:o.markerUnits,strokeWidth:o.strokeWidth,orient:o.orient},o.id))})}):null};tl.displayName="MarkerDefinitions";var ab=I.memo(tl);function nl({x:t,y:e,label:n,labelStyle:r={},labelShowBg:i=!0,labelBgStyle:o={},labelBgPadding:s=[2,4],labelBgBorderRadius:a=2,children:c,className:l,...u}){const[d,h]=I.useState({x:1,y:0,width:0,height:0}),p=Ee(["react-flow__edge-textwrapper",l]),f=I.useRef(null);return I.useEffect(()=>{if(f.current){const m=f.current.getBBox();h({x:m.x,y:m.y,width:m.width,height:m.height})}},[n]),typeof n>"u"||!n?null:j.jsxs("g",{transform:`translate(${t-d.width/2} ${e-d.height/2})`,className:p,visibility:d.width?"visible":"hidden",...u,children:[i&&j.jsx("rect",{width:d.width+2*s[0],x:-s[0],y:-s[1],height:d.height+2*s[1],className:"react-flow__edge-textbg",style:o,rx:a,ry:a}),j.jsx("text",{className:"react-flow__edge-text",y:d.height/2,dy:"0.3em",ref:f,style:r,children:n}),c]})}nl.displayName="EdgeText";const cb=I.memo(nl);function kr({id:t,path:e,labelX:n,labelY:r,label:i,labelStyle:o,labelShowBg:s,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l,style:u,markerEnd:d,markerStart:h,className:p,interactionWidth:f=20}){return j.jsxs(j.Fragment,{children:[j.jsx("path",{id:t,style:u,d:e,fill:"none",className:Ee(["react-flow__edge-path",p]),markerEnd:d,markerStart:h}),f&&j.jsx("path",{d:e,fill:"none",strokeOpacity:0,strokeWidth:f,className:"react-flow__edge-interaction"}),i&&Le(n)&&Le(r)?j.jsx(cb,{x:n,y:r,label:i,labelStyle:o,labelShowBg:s,labelBgStyle:a,labelBgPadding:c,labelBgBorderRadius:l}):null]})}function rl({pos:t,x1:e,y1:n,x2:r,y2:i}){return t===re.Left||t===re.Right?[.5*(e+r),n]:[e,.5*(n+i)]}function il({sourceX:t,sourceY:e,sourcePosition:n=re.Bottom,targetX:r,targetY:i,targetPosition:o=re.Top}){const[s,a]=rl({pos:n,x1:t,y1:e,x2:r,y2:i}),[c,l]=rl({pos:o,x1:r,y1:i,x2:t,y2:e}),[u,d,h,p]=Xa({sourceX:t,sourceY:e,targetX:r,targetY:i,sourceControlX:s,sourceControlY:a,targetControlX:c,targetControlY:l});return[`M${t},${e} C${s},${a} ${c},${l} ${r},${i}`,u,d,h,p]}function ol(t){return I.memo(({id:e,sourceX:n,sourceY:r,targetX:i,targetY:o,sourcePosition:s=re.Bottom,targetPosition:a=re.Top,label:c,labelStyle:l,labelShowBg:u,labelBgStyle:d,labelBgPadding:h,labelBgBorderRadius:p,style:f,markerEnd:m,markerStart:y,interactionWidth:g})=>{const[w,v,x]=il({sourceX:n,sourceY:r,sourcePosition:s,targetX:i,targetY:o,targetPosition:a}),C=t.isInternal?void 0:e;return j.jsx(kr,{id:C,path:w,labelX:v,labelY:x,label:c,labelStyle:l,labelShowBg:u,labelBgStyle:d,labelBgPadding:h,labelBgBorderRadius:p,style:f,markerEnd:m,markerStart:y,interactionWidth:g})})}const lb=ol({isInternal:!1}),sl=ol({isInternal:!0});lb.displayName="SimpleBezierEdge",sl.displayName="SimpleBezierEdgeInternal";function al(t){return I.memo(({id:e,sourceX:n,sourceY:r,targetX:i,targetY:o,label:s,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,sourcePosition:p=re.Bottom,targetPosition:f=re.Top,markerEnd:m,markerStart:y,pathOptions:g,interactionWidth:w})=>{const[v,x,C]=Fi({sourceX:n,sourceY:r,sourcePosition:p,targetX:i,targetY:o,targetPosition:f,borderRadius:g==null?void 0:g.borderRadius,offset:g==null?void 0:g.offset}),$=t.isInternal?void 0:e;return j.jsx(kr,{id:$,path:v,labelX:x,labelY:C,label:s,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:m,markerStart:y,interactionWidth:w})})}const cl=al({isInternal:!1}),ll=al({isInternal:!0});cl.displayName="SmoothStepEdge",ll.displayName="SmoothStepEdgeInternal";function ul(t){return I.memo(({id:e,...n})=>{var i;const r=t.isInternal?void 0:e;return j.jsx(cl,{...n,id:r,pathOptions:I.useMemo(()=>{var o;return{borderRadius:0,offset:(o=n.pathOptions)==null?void 0:o.offset}},[(i=n.pathOptions)==null?void 0:i.offset])})})}const ub=ul({isInternal:!1}),dl=ul({isInternal:!0});ub.displayName="StepEdge",dl.displayName="StepEdgeInternal";function hl(t){return I.memo(({id:e,sourceX:n,sourceY:r,targetX:i,targetY:o,label:s,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:p,markerStart:f,interactionWidth:m})=>{const[y,g,w]=ec({sourceX:n,sourceY:r,targetX:i,targetY:o}),v=t.isInternal?void 0:e;return j.jsx(kr,{id:v,path:y,labelX:g,labelY:w,label:s,labelStyle:a,labelShowBg:c,labelBgStyle:l,labelBgPadding:u,labelBgBorderRadius:d,style:h,markerEnd:p,markerStart:f,interactionWidth:m})})}const db=hl({isInternal:!1}),pl=hl({isInternal:!0});db.displayName="StraightEdge",pl.displayName="StraightEdgeInternal";function fl(t){return I.memo(({id:e,sourceX:n,sourceY:r,targetX:i,targetY:o,sourcePosition:s=re.Bottom,targetPosition:a=re.Top,label:c,labelStyle:l,labelShowBg:u,labelBgStyle:d,labelBgPadding:h,labelBgBorderRadius:p,style:f,markerEnd:m,markerStart:y,pathOptions:g,interactionWidth:w})=>{const[v,x,C]=Ga({sourceX:n,sourceY:r,sourcePosition:s,targetX:i,targetY:o,targetPosition:a,curvature:g==null?void 0:g.curvature}),$=t.isInternal?void 0:e;return j.jsx(kr,{id:$,path:v,labelX:x,labelY:C,label:c,labelStyle:l,labelShowBg:u,labelBgStyle:d,labelBgPadding:h,labelBgBorderRadius:p,style:f,markerEnd:m,markerStart:y,interactionWidth:w})})}const hb=fl({isInternal:!1}),ml=fl({isInternal:!0});hb.displayName="BezierEdge",ml.displayName="BezierEdgeInternal";const yl={default:ml,straight:pl,step:dl,smoothstep:ll,simplebezier:sl},gl={sourceX:null,sourceY:null,targetX:null,targetY:null,sourcePosition:null,targetPosition:null},pb=(t,e,n)=>n===re.Left?t-e:n===re.Right?t+e:t,fb=(t,e,n)=>n===re.Top?t-e:n===re.Bottom?t+e:t,xl="react-flow__edgeupdater";function bl({position:t,centerX:e,centerY:n,radius:r=10,onMouseDown:i,onMouseEnter:o,onMouseOut:s,type:a}){return j.jsx("circle",{onMouseDown:i,onMouseEnter:o,onMouseOut:s,className:Ee([xl,`${xl}-${a}`]),cx:pb(e,r,t),cy:fb(n,r,t),r,stroke:"transparent",fill:"transparent"})}function mb({isReconnectable:t,reconnectRadius:e,edge:n,sourceX:r,sourceY:i,targetX:o,targetY:s,sourcePosition:a,targetPosition:c,onReconnect:l,onReconnectStart:u,onReconnectEnd:d,setReconnecting:h,setUpdateHover:p}){const f=ge(),m=(x,C)=>{if(x.button!==0)return;const{autoPanOnConnect:$,domNode:O,isValidConnection:E,connectionMode:T,connectionRadius:A,lib:z,onConnectStart:V,onConnectEnd:F,cancelConnection:b,nodeLookup:N,rfId:M,panBy:R,updateConnection:S}=f.getState(),P=C.type==="target";h(!0),u==null||u(x,n,C.type);const D=(B,J)=>{h(!1),d==null||d(B,n,C.type,J)},W=B=>l==null?void 0:l(n,B);Yi.onPointerDown(x.nativeEvent,{autoPanOnConnect:$,connectionMode:T,connectionRadius:A,domNode:O,handleId:C.id,nodeId:C.nodeId,nodeLookup:N,isTarget:P,edgeUpdaterType:C.type,lib:z,flowId:M,cancelConnection:b,panBy:R,isValidConnection:E,onConnect:W,onConnectStart:V,onConnectEnd:F,onReconnectEnd:D,updateConnection:S,getTransform:()=>f.getState().transform,getFromHandle:()=>f.getState().connection.fromHandle})},y=x=>m(x,{nodeId:n.target,id:n.targetHandle??null,type:"target"}),g=x=>m(x,{nodeId:n.source,id:n.sourceHandle??null,type:"source"}),w=()=>p(!0),v=()=>p(!1);return j.jsxs(j.Fragment,{children:[(t===!0||t==="source")&&j.jsx(bl,{position:a,centerX:r,centerY:i,radius:e,onMouseDown:y,onMouseEnter:w,onMouseOut:v,type:"source"}),(t===!0||t==="target")&&j.jsx(bl,{position:c,centerX:o,centerY:s,radius:e,onMouseDown:g,onMouseEnter:w,onMouseOut:v,type:"target"})]})}function yb({id:t,edgesFocusable:e,edgesReconnectable:n,elementsSelectable:r,onClick:i,onDoubleClick:o,onContextMenu:s,onMouseEnter:a,onMouseMove:c,onMouseLeave:l,reconnectRadius:u,onReconnect:d,onReconnectStart:h,onReconnectEnd:p,rfId:f,edgeTypes:m,noPanClassName:y,onError:g,disableKeyboardA11y:w}){let v=de(se=>se.edgeLookup.get(t));const x=de(se=>se.defaultEdgeOptions);v=x?{...x,...v}:v;let C=v.type||"default",$=(m==null?void 0:m[C])||yl[C];$===void 0&&(g==null||g("011",Ke.error011(C)),C="default",$=yl.default);const O=!!(v.focusable||e&&typeof v.focusable>"u"),E=typeof d<"u"&&(v.reconnectable||n&&typeof v.reconnectable>"u"),T=!!(v.selectable||r&&typeof v.selectable>"u"),A=I.useRef(null),[z,V]=I.useState(!1),[F,b]=I.useState(!1),N=ge(),{zIndex:M,sourceX:R,sourceY:S,targetX:P,targetY:D,sourcePosition:W,targetPosition:B}=de(I.useCallback(se=>{const he=se.nodeLookup.get(v.source),me=se.nodeLookup.get(v.target);if(!he||!me)return{zIndex:v.zIndex,...gl};const Pe=e0({id:t,sourceNode:he,targetNode:me,sourceHandle:v.sourceHandle||null,targetHandle:v.targetHandle||null,connectionMode:se.connectionMode,onError:g});return{zIndex:Qg({selected:v.selected,zIndex:v.zIndex,sourceNode:he,targetNode:me,elevateOnSelect:se.elevateEdgesOnSelect}),...Pe||gl}},[v.source,v.target,v.sourceHandle,v.targetHandle,v.selected,v.zIndex]),xe),J=I.useMemo(()=>v.markerStart?`url('#${zi(v.markerStart,f)}')`:void 0,[v.markerStart,f]),Z=I.useMemo(()=>v.markerEnd?`url('#${zi(v.markerEnd,f)}')`:void 0,[v.markerEnd,f]);if(v.hidden||R===null||S===null||P===null||D===null)return null;const q=se=>{var tt;const{addSelectedEdges:he,unselectNodesAndEdges:me,multiSelectionActive:Pe}=N.getState();T&&(N.setState({nodesSelectionActive:!1}),v.selected&&Pe?(me({nodes:[],edges:[v]}),(tt=A.current)==null||tt.blur()):he([t])),i&&i(se,v)},ee=o?se=>{o(se,{...v})}:void 0,ne=s?se=>{s(se,{...v})}:void 0,H=a?se=>{a(se,{...v})}:void 0,ae=c?se=>{c(se,{...v})}:void 0,oe=l?se=>{l(se,{...v})}:void 0,ce=se=>{var he;if(!w&&Pa.includes(se.key)&&T){const{unselectNodesAndEdges:me,addSelectedEdges:Pe}=N.getState();se.key==="Escape"?((he=A.current)==null||he.blur(),me({edges:[v]})):Pe([t])}};return j.jsx("svg",{style:{zIndex:M},children:j.jsxs("g",{className:Ee(["react-flow__edge",`react-flow__edge-${C}`,v.className,y,{selected:v.selected,animated:v.animated,inactive:!T&&!i,updating:z,selectable:T}]),onClick:q,onDoubleClick:ee,onContextMenu:ne,onMouseEnter:H,onMouseMove:ae,onMouseLeave:oe,onKeyDown:O?ce:void 0,tabIndex:O?0:void 0,role:O?"button":"img","data-id":t,"data-testid":`rf__edge-${t}`,"aria-label":v.ariaLabel===null?void 0:v.ariaLabel||`Edge from ${v.source} to ${v.target}`,"aria-describedby":O?`${kc}-${f}`:void 0,ref:A,children:[!F&&j.jsx($,{id:t,source:v.source,target:v.target,type:v.type,selected:v.selected,animated:v.animated,selectable:T,deletable:v.deletable??!0,label:v.label,labelStyle:v.labelStyle,labelShowBg:v.labelShowBg,labelBgStyle:v.labelBgStyle,labelBgPadding:v.labelBgPadding,labelBgBorderRadius:v.labelBgBorderRadius,sourceX:R,sourceY:S,targetX:P,targetY:D,sourcePosition:W,targetPosition:B,data:v.data,style:v.style,sourceHandleId:v.sourceHandle,targetHandleId:v.targetHandle,markerStart:J,markerEnd:Z,pathOptions:"pathOptions"in v?v.pathOptions:void 0,interactionWidth:v.interactionWidth}),E&&j.jsx(mb,{edge:v,isReconnectable:E,reconnectRadius:u,onReconnect:d,onReconnectStart:h,onReconnectEnd:p,sourceX:R,sourceY:S,targetX:P,targetY:D,sourcePosition:W,targetPosition:B,setUpdateHover:V,setReconnecting:b})]})})}const gb=t=>({width:t.width,height:t.height,edgesFocusable:t.edgesFocusable,edgesReconnectable:t.edgesReconnectable,elementsSelectable:t.elementsSelectable,connectionMode:t.connectionMode,onError:t.onError});function vl({defaultMarkerColor:t,onlyRenderVisibleElements:e,rfId:n,edgeTypes:r,noPanClassName:i,onReconnect:o,onEdgeContextMenu:s,onEdgeMouseEnter:a,onEdgeMouseMove:c,onEdgeMouseLeave:l,onEdgeClick:u,reconnectRadius:d,onEdgeDoubleClick:h,onReconnectStart:p,onReconnectEnd:f,disableKeyboardA11y:m}){const{edgesFocusable:y,edgesReconnectable:g,elementsSelectable:w,onError:v}=de(gb,xe),x=nb(e);return j.jsxs("div",{className:"react-flow__edges",children:[j.jsx(ab,{defaultColor:t,rfId:n}),x.map(C=>j.jsx(yb,{id:C,edgesFocusable:y,edgesReconnectable:g,elementsSelectable:w,noPanClassName:i,onReconnect:o,onContextMenu:s,onMouseEnter:a,onMouseMove:c,onMouseLeave:l,onClick:u,reconnectRadius:d,onDoubleClick:h,onReconnectStart:p,onReconnectEnd:f,rfId:n,onError:v,edgeTypes:r,disableKeyboardA11y:m},C))]})}vl.displayName="EdgeRenderer";const xb=I.memo(vl),bb=t=>`translate(${t.transform[0]}px,${t.transform[1]}px) scale(${t.transform[2]})`;function vb({children:t}){const e=de(bb);return j.jsx("div",{className:"react-flow__viewport xyflow__viewport react-flow__container",style:{transform:e},children:t})}function wb(t){const e=Qn(),n=I.useRef(!1);I.useEffect(()=>{!n.current&&e.viewportInitialized&&t&&(setTimeout(()=>t(e),1),n.current=!0)},[t,e.viewportInitialized])}const Mb=t=>{var e;return(e=t.panZoom)==null?void 0:e.syncViewport};function Eb(t){const e=de(Mb),n=ge();return I.useEffect(()=>{t&&(e==null||e(t),n.setState({transform:[t.x,t.y,t.zoom]}))},[t,e]),null}function Cb(t){return t.connection.inProgress?{...t.connection,to:Mn(t.connection.to,t.transform)}:{...t.connection}}function _b(t){return Cb}function Sb(t){const e=_b();return de(e,xe)}const Ob=t=>({nodesConnectable:t.nodesConnectable,isValid:t.connection.isValid,inProgress:t.connection.inProgress,width:t.width,height:t.height});function Ab({containerStyle:t,style:e,type:n,component:r}){const{nodesConnectable:i,width:o,height:s,isValid:a,inProgress:c}=de(Ob,xe);return o&&i&&c?j.jsx("svg",{style:t,width:o,height:s,className:"react-flow__connectionline react-flow__container",children:j.jsx("g",{className:Ee(["react-flow__connection",Ia(a)]),children:j.jsx(wl,{style:e,type:n,CustomComponent:r,isValid:a})})}):null}const wl=({style:t,type:e=rt.Bezier,CustomComponent:n,isValid:r})=>{const{inProgress:i,from:o,fromNode:s,fromHandle:a,fromPosition:c,to:l,toNode:u,toHandle:d,toPosition:h}=Sb();if(!i)return;if(n)return j.jsx(n,{connectionLineType:e,connectionLineStyle:t,fromNode:s,fromHandle:a,fromX:o.x,fromY:o.y,toX:l.x,toY:l.y,fromPosition:c,toPosition:h,connectionStatus:Ia(r),toNode:u,toHandle:d});let p="";const f={sourceX:o.x,sourceY:o.y,sourcePosition:c,targetX:l.x,targetY:l.y,targetPosition:h};switch(e){case rt.Bezier:[p]=Ga(f);break;case rt.SimpleBezier:[p]=il(f);break;case rt.Step:[p]=Fi({...f,borderRadius:0});break;case rt.SmoothStep:[p]=Fi(f);break;default:[p]=ec(f)}return j.jsx("path",{d:p,fill:"none",className:"react-flow__connection-path",style:t})};wl.displayName="ConnectionLine";const Nb={};function Ml(t=Nb){I.useRef(t),ge(),I.useEffect(()=>{},[t])}function Pb(){ge(),I.useRef(!1),I.useEffect(()=>{},[])}function El({nodeTypes:t,edgeTypes:e,onInit:n,onNodeClick:r,onEdgeClick:i,onNodeDoubleClick:o,onEdgeDoubleClick:s,onNodeMouseEnter:a,onNodeMouseMove:c,onNodeMouseLeave:l,onNodeContextMenu:u,onSelectionContextMenu:d,onSelectionStart:h,onSelectionEnd:p,connectionLineType:f,connectionLineStyle:m,connectionLineComponent:y,connectionLineContainerStyle:g,selectionKeyCode:w,selectionOnDrag:v,selectionMode:x,multiSelectionKeyCode:C,panActivationKeyCode:$,zoomActivationKeyCode:O,deleteKeyCode:E,onlyRenderVisibleElements:T,elementsSelectable:A,defaultViewport:z,translateExtent:V,minZoom:F,maxZoom:b,preventScrolling:N,defaultMarkerColor:M,zoomOnScroll:R,zoomOnPinch:S,panOnScroll:P,panOnScrollSpeed:D,panOnScrollMode:W,zoomOnDoubleClick:B,panOnDrag:J,onPaneClick:Z,onPaneMouseEnter:q,onPaneMouseMove:ee,onPaneMouseLeave:ne,onPaneScroll:H,onPaneContextMenu:ae,paneClickDistance:oe,nodeClickDistance:ce,onEdgeContextMenu:se,onEdgeMouseEnter:he,onEdgeMouseMove:me,onEdgeMouseLeave:Pe,reconnectRadius:tt,onReconnect:Gt,onReconnectStart:Kt,onReconnectEnd:Jt,noDragClassName:at,noWheelClassName:wt,noPanClassName:Mt,disableKeyboardA11y:Et,nodeExtent:Bn,rfId:Ct,viewport:Fe,onViewportChange:en}){return Ml(t),Ml(e),Pb(),wb(n),Eb(Fe),j.jsx(Qx,{onPaneClick:Z,onPaneMouseEnter:q,onPaneMouseMove:ee,onPaneMouseLeave:ne,onPaneContextMenu:ae,onPaneScroll:H,paneClickDistance:oe,deleteKeyCode:E,selectionKeyCode:w,selectionOnDrag:v,selectionMode:x,onSelectionStart:h,onSelectionEnd:p,multiSelectionKeyCode:C,panActivationKeyCode:$,zoomActivationKeyCode:O,elementsSelectable:A,zoomOnScroll:R,zoomOnPinch:S,zoomOnDoubleClick:B,panOnScroll:P,panOnScrollSpeed:D,panOnScrollMode:W,panOnDrag:J,defaultViewport:z,translateExtent:V,minZoom:F,maxZoom:b,onSelectionContextMenu:d,preventScrolling:N,noDragClassName:at,noWheelClassName:wt,noPanClassName:Mt,disableKeyboardA11y:Et,onViewportChange:en,isControlledViewport:!!Fe,children:j.jsxs(vb,{children:[j.jsx(xb,{edgeTypes:e,onEdgeClick:i,onEdgeDoubleClick:s,onReconnect:Gt,onReconnectStart:Kt,onReconnectEnd:Jt,onlyRenderVisibleElements:T,onEdgeContextMenu:se,onEdgeMouseEnter:he,onEdgeMouseMove:me,onEdgeMouseLeave:Pe,reconnectRadius:tt,defaultMarkerColor:M,noPanClassName:Mt,disableKeyboardA11y:Et,rfId:Ct}),j.jsx(Ab,{style:m,type:f,component:y,containerStyle:g}),j.jsx("div",{className:"react-flow__edgelabel-renderer"}),j.jsx(tb,{nodeTypes:t,onNodeClick:r,onNodeDoubleClick:o,onNodeMouseEnter:a,onNodeMouseMove:c,onNodeMouseLeave:l,onNodeContextMenu:u,nodeClickDistance:ce,onlyRenderVisibleElements:T,noPanClassName:Mt,noDragClassName:at,disableKeyboardA11y:Et,nodeExtent:Bn,rfId:Ct}),j.jsx("div",{className:"react-flow__viewport-portal"})]})})}El.displayName="GraphView";const Tb=I.memo(El),Cl=({nodes:t,edges:e,defaultNodes:n,defaultEdges:r,width:i,height:o,fitView:s,nodeOrigin:a,nodeExtent:c}={})=>{const l=new Map,u=new Map,d=new Map,h=new Map,p=r??e??[],f=n??t??[],m=a??[0,0],y=c??gn;ac(d,h,p),Wi(f,l,u,{nodeOrigin:m,nodeExtent:y,elevateNodesOnSelect:!1});let g=[0,0,1];if(s&&i&&o){const w=vn(l,{filter:$=>!!(($.width||$.initialWidth)&&($.height||$.initialHeight))}),{x:v,y:x,zoom:C}=Di(w,i,o,.5,2,.1);g=[v,x,C]}return{rfId:"1",width:0,height:0,transform:g,nodes:f,nodeLookup:l,parentLookup:u,edges:p,edgeLookup:h,connectionLookup:d,onNodesChange:null,onEdgesChange:null,hasDefaultNodes:n!==void 0,hasDefaultEdges:r!==void 0,panZoom:null,minZoom:.5,maxZoom:2,translateExtent:gn,nodeExtent:y,nodesSelectionActive:!1,userSelectionActive:!1,userSelectionRect:null,connectionMode:It.Strict,domNode:null,paneDragging:!1,noPanClassName:"nopan",nodeOrigin:m,nodeDragThreshold:1,snapGrid:[15,15],snapToGrid:!1,nodesDraggable:!0,nodesConnectable:!0,nodesFocusable:!0,edgesFocusable:!0,edgesReconnectable:!0,elementsSelectable:!0,elevateNodesOnSelect:!0,elevateEdgesOnSelect:!1,fitViewOnInit:!1,fitViewDone:!1,fitViewOnInitOptions:void 0,selectNodesOnDrag:!0,multiSelectionActive:!1,connection:{...Ta},connectionClickStartHandle:null,connectOnClick:!0,ariaLiveMessage:"",autoPanOnConnect:!0,autoPanOnNodeDrag:!0,autoPanSpeed:15,connectionRadius:20,onError:Hg,isValidConnection:void 0,onSelectionChangeHandlers:[],lib:"react",debug:!1}},kb=({nodes:t,edges:e,defaultNodes:n,defaultEdges:r,width:i,height:o,fitView:s,nodeOrigin:a,nodeExtent:c})=>G0((l,u)=>({...Cl({nodes:t,edges:e,width:i,height:o,fitView:s,nodeOrigin:a,nodeExtent:c,defaultNodes:n,defaultEdges:r}),setNodes:d=>{const{nodeLookup:h,parentLookup:p,nodeOrigin:f,elevateNodesOnSelect:m}=u();Wi(d,h,p,{nodeOrigin:f,nodeExtent:c,elevateNodesOnSelect:m,checkEquality:!0}),l({nodes:d})},setEdges:d=>{const{connectionLookup:h,edgeLookup:p}=u();ac(h,p,d),l({edges:d})},setDefaultNodesAndEdges:(d,h)=>{if(d){const{setNodes:p}=u();p(d),l({hasDefaultNodes:!0})}if(h){const{setEdges:p}=u();p(h),l({hasDefaultEdges:!0})}},updateNodeInternals:(d,h={triggerFitView:!0})=>{const{triggerNodeChanges:p,nodeLookup:f,parentLookup:m,fitViewOnInit:y,fitViewDone:g,fitViewOnInitOptions:w,domNode:v,nodeOrigin:x,nodeExtent:C,debug:$,fitViewSync:O}=u(),{changes:E,updatedInternals:T}=s0(d,f,m,v,x,C);if(T){if(r0(f,m,{nodeOrigin:x,nodeExtent:C}),h.triggerFitView){let A=g;!g&&y&&(A=O({...w,nodes:w==null?void 0:w.nodes})),l({fitViewDone:A})}else l({});(E==null?void 0:E.length)>0&&($&&console.log("React Flow: trigger node changes",E),p==null||p(E))}},updateNodePositions:(d,h=!1)=>{const p=[],f=[];for(const[m,y]of d){const g={id:m,type:"position",position:y.position,dragging:h};y!=null&&y.expandParent&&(y!=null&&y.parentId)&&g.position&&(p.push({id:m,parentId:y.parentId,rect:{...y.internals.positionAbsolute,width:y.measured.width,height:y.measured.height}}),g.position.x=Math.max(0,g.position.x),g.position.y=Math.max(0,g.position.y)),f.push(g)}if(p.length>0){const{nodeLookup:m,parentLookup:y,nodeOrigin:g}=u(),w=Ui(p,m,y,g);f.push(...w)}u().triggerNodeChanges(f)},triggerNodeChanges:d=>{const{onNodesChange:h,setNodes:p,nodes:f,hasDefaultNodes:m,debug:y}=u();if(d!=null&&d.length){if(m){const g=mt(d,f);p(g)}y&&console.log("React Flow: trigger node changes",d),h==null||h(d)}},triggerEdgeChanges:d=>{const{onEdgesChange:h,setEdges:p,edges:f,hasDefaultEdges:m,debug:y}=u();if(d!=null&&d.length){if(m){const g=Sn(d,f);p(g)}y&&console.log("React Flow: trigger edge changes",d),h==null||h(d)}},addSelectedNodes:d=>{const{multiSelectionActive:h,edgeLookup:p,nodeLookup:f,triggerNodeChanges:m,triggerEdgeChanges:y}=u();if(h){const g=d.map(w=>yt(w,!0));m(g);return}m(zt(f,new Set([...d]),!0)),y(zt(p))},addSelectedEdges:d=>{const{multiSelectionActive:h,edgeLookup:p,nodeLookup:f,triggerNodeChanges:m,triggerEdgeChanges:y}=u();if(h){const g=d.map(w=>yt(w,!0));y(g);return}y(zt(p,new Set([...d]))),m(zt(f,new Set,!0))},unselectNodesAndEdges:({nodes:d,edges:h}={})=>{const{edges:p,nodes:f,nodeLookup:m,triggerNodeChanges:y,triggerEdgeChanges:g}=u(),w=d||f,v=h||p,x=w.map($=>{const O=m.get($.id);return O&&(O.selected=!1),yt($.id,!1)}),C=v.map($=>yt($.id,!1));y(x),g(C)},setMinZoom:d=>{const{panZoom:h,maxZoom:p}=u();h==null||h.setScaleExtent([d,p]),l({minZoom:d})},setMaxZoom:d=>{const{panZoom:h,minZoom:p}=u();h==null||h.setScaleExtent([p,d]),l({maxZoom:d})},setTranslateExtent:d=>{var h;(h=u().panZoom)==null||h.setTranslateExtent(d),l({translateExtent:d})},setPaneClickDistance:d=>{var h;(h=u().panZoom)==null||h.setClickDistance(d)},resetSelectedElements:()=>{const{edges:d,nodes:h,triggerNodeChanges:p,triggerEdgeChanges:f}=u(),m=h.reduce((g,w)=>w.selected?[...g,yt(w.id,!1)]:g,[]),y=d.reduce((g,w)=>w.selected?[...g,yt(w.id,!1)]:g,[]);p(m),f(y)},setNodeExtent:d=>{const{nodes:h,nodeLookup:p,parentLookup:f,nodeOrigin:m,elevateNodesOnSelect:y,nodeExtent:g}=u();d[0][0]===g[0][0]&&d[0][1]===g[0][1]&&d[1][0]===g[1][0]&&d[1][1]===g[1][1]||(Wi(h,p,f,{nodeOrigin:m,nodeExtent:d,elevateNodesOnSelect:y,checkEquality:!1}),l({nodeExtent:d}))},panBy:d=>{const{transform:h,width:p,height:f,panZoom:m,translateExtent:y}=u();return a0({delta:d,panZoom:m,transform:h,translateExtent:y,width:p,height:f})},fitView:d=>{const{panZoom:h,width:p,height:f,minZoom:m,maxZoom:y,nodeLookup:g}=u();if(!h)return Promise.resolve(!1);const w=Ri(g,d);return $i({nodes:w,width:p,height:f,panZoom:h,minZoom:m,maxZoom:y},d)},fitViewSync:d=>{const{panZoom:h,width:p,height:f,minZoom:m,maxZoom:y,nodeLookup:g}=u();if(!h)return!1;const w=Ri(g,d);return $i({nodes:w,width:p,height:f,panZoom:h,minZoom:m,maxZoom:y},d),w.size>0},cancelConnection:()=>{l({connection:{...Ta}})},updateConnection:d=>{l({connection:d})},reset:()=>l({...Cl()})}),Object.is);function jb({initialNodes:t,initialEdges:e,defaultNodes:n,defaultEdges:r,initialWidth:i,initialHeight:o,fitView:s,nodeOrigin:a,nodeExtent:c,children:l}){const[u]=I.useState(()=>kb({nodes:t,edges:e,defaultNodes:n,defaultEdges:r,width:i,height:o,fitView:s,nodeOrigin:a,nodeExtent:c}));return j.jsx(K0,{value:u,children:j.jsx(wx,{children:l})})}function Ib({children:t,nodes:e,edges:n,defaultNodes:r,defaultEdges:i,width:o,height:s,fitView:a,nodeOrigin:c,nodeExtent:l}){return I.useContext(Ar)?j.jsx(j.Fragment,{children:t}):j.jsx(jb,{initialNodes:e,initialEdges:n,defaultNodes:r,defaultEdges:i,initialWidth:o,initialHeight:s,fitView:a,nodeOrigin:c,nodeExtent:l,children:t})}const Rb={width:"100%",height:"100%",overflow:"hidden",position:"relative",zIndex:0};function $b({nodes:t,edges:e,defaultNodes:n,defaultEdges:r,className:i,nodeTypes:o,edgeTypes:s,onNodeClick:a,onEdgeClick:c,onInit:l,onMove:u,onMoveStart:d,onMoveEnd:h,onConnect:p,onConnectStart:f,onConnectEnd:m,onClickConnectStart:y,onClickConnectEnd:g,onNodeMouseEnter:w,onNodeMouseMove:v,onNodeMouseLeave:x,onNodeContextMenu:C,onNodeDoubleClick:$,onNodeDragStart:O,onNodeDrag:E,onNodeDragStop:T,onNodesDelete:A,onEdgesDelete:z,onDelete:V,onSelectionChange:F,onSelectionDragStart:b,onSelectionDrag:N,onSelectionDragStop:M,onSelectionContextMenu:R,onSelectionStart:S,onSelectionEnd:P,onBeforeDelete:D,connectionMode:W,connectionLineType:B=rt.Bezier,connectionLineStyle:J,connectionLineComponent:Z,connectionLineContainerStyle:q,deleteKeyCode:ee="Backspace",selectionKeyCode:ne="Shift",selectionOnDrag:H=!1,selectionMode:ae=xn.Full,panActivationKeyCode:oe="Space",multiSelectionKeyCode:ce=Mr()?"Meta":"Control",zoomActivationKeyCode:se=Mr()?"Meta":"Control",snapToGrid:he,snapGrid:me,onlyRenderVisibleElements:Pe=!1,selectNodesOnDrag:tt,nodesDraggable:Gt,nodesConnectable:Kt,nodesFocusable:Jt,nodeOrigin:at=jc,edgesFocusable:wt,edgesReconnectable:Mt,elementsSelectable:Et=!0,defaultViewport:Bn=dx,minZoom:Ct=.5,maxZoom:Fe=2,translateExtent:en=gn,preventScrolling:is=!0,nodeExtent:Dn,defaultMarkerColor:Ln="#b1b1b7",zoomOnScroll:_=!0,zoomOnPinch:k=!0,panOnScroll:L=!1,panOnScrollSpeed:U=.5,panOnScrollMode:ie=ut.Free,zoomOnDoubleClick:_e=!0,panOnDrag:we=!0,onPaneClick:le,onPaneMouseEnter:Y,onPaneMouseMove:G,onPaneMouseLeave:K,onPaneScroll:te,onPaneContextMenu:ue,paneClickDistance:pe=0,nodeClickDistance:ve=0,children:Re,onReconnect:ei,onReconnectStart:os,onReconnectEnd:ss,onEdgeContextMenu:$S,onEdgeDoubleClick:BS,onEdgeMouseEnter:DS,onEdgeMouseMove:LS,onEdgeMouseLeave:FS,reconnectRadius:zS=10,onNodesChange:VS,onEdgesChange:qS,noDragClassName:WS="nodrag",noWheelClassName:HS="nowheel",noPanClassName:Ap="nopan",fitView:Np,fitViewOptions:US,connectOnClick:QS,attributionPosition:YS,proOptions:XS,defaultEdgeOptions:ZS,elevateNodesOnSelect:GS,elevateEdgesOnSelect:KS,disableKeyboardA11y:Pp=!1,autoPanOnConnect:JS,autoPanOnNodeDrag:eO,autoPanSpeed:tO,connectionRadius:nO,isValidConnection:rO,onError:iO,style:oO,id:Tp,nodeDragThreshold:sO,viewport:aO,onViewportChange:cO,width:lO,height:uO,colorMode:dO="light",debug:hO,...pO},fO){const as=Tp||"1",mO=mx(dO);return j.jsx("div",{...pO,style:{...oO,...Rb},ref:fO,className:Ee(["react-flow",i,mO]),"data-testid":"rf__wrapper",id:Tp,children:j.jsxs(Ib,{nodes:t,edges:e,width:lO,height:uO,fitView:Np,nodeOrigin:at,nodeExtent:Dn,children:[j.jsx(Tb,{onInit:l,onNodeClick:a,onEdgeClick:c,onNodeMouseEnter:w,onNodeMouseMove:v,onNodeMouseLeave:x,onNodeContextMenu:C,onNodeDoubleClick:$,nodeTypes:o,edgeTypes:s,connectionLineType:B,connectionLineStyle:J,connectionLineComponent:Z,connectionLineContainerStyle:q,selectionKeyCode:ne,selectionOnDrag:H,selectionMode:ae,deleteKeyCode:ee,multiSelectionKeyCode:ce,panActivationKeyCode:oe,zoomActivationKeyCode:se,onlyRenderVisibleElements:Pe,defaultViewport:Bn,translateExtent:en,minZoom:Ct,maxZoom:Fe,preventScrolling:is,zoomOnScroll:_,zoomOnPinch:k,zoomOnDoubleClick:_e,panOnScroll:L,panOnScrollSpeed:U,panOnScrollMode:ie,panOnDrag:we,onPaneClick:le,onPaneMouseEnter:Y,onPaneMouseMove:G,onPaneMouseLeave:K,onPaneScroll:te,onPaneContextMenu:ue,paneClickDistance:pe,nodeClickDistance:ve,onSelectionContextMenu:R,onSelectionStart:S,onSelectionEnd:P,onReconnect:ei,onReconnectStart:os,onReconnectEnd:ss,onEdgeContextMenu:$S,onEdgeDoubleClick:BS,onEdgeMouseEnter:DS,onEdgeMouseMove:LS,onEdgeMouseLeave:FS,reconnectRadius:zS,defaultMarkerColor:Ln,noDragClassName:WS,noWheelClassName:HS,noPanClassName:Ap,rfId:as,disableKeyboardA11y:Pp,nodeExtent:Dn,viewport:aO,onViewportChange:cO}),j.jsx(fx,{nodes:t,edges:e,defaultNodes:n,defaultEdges:r,onConnect:p,onConnectStart:f,onConnectEnd:m,onClickConnectStart:y,onClickConnectEnd:g,nodesDraggable:Gt,nodesConnectable:Kt,nodesFocusable:Jt,edgesFocusable:wt,edgesReconnectable:Mt,elementsSelectable:Et,elevateNodesOnSelect:GS,elevateEdgesOnSelect:KS,minZoom:Ct,maxZoom:Fe,nodeExtent:Dn,onNodesChange:VS,onEdgesChange:qS,snapToGrid:he,snapGrid:me,connectionMode:W,translateExtent:en,connectOnClick:QS,defaultEdgeOptions:ZS,fitView:Np,fitViewOptions:US,onNodesDelete:A,onEdgesDelete:z,onDelete:V,onNodeDragStart:O,onNodeDrag:E,onNodeDragStop:T,onSelectionDrag:N,onSelectionDragStart:b,onSelectionDragStop:M,onMove:u,onMoveStart:d,onMoveEnd:h,noPanClassName:Ap,nodeOrigin:at,rfId:as,autoPanOnConnect:JS,autoPanOnNodeDrag:eO,autoPanSpeed:tO,onError:iO,connectionRadius:nO,isValidConnection:rO,selectNodesOnDrag:tt,nodeDragThreshold:sO,onBeforeDelete:D,paneClickDistance:pe,debug:hO}),j.jsx(ux,{onSelectionChange:F}),Re,j.jsx(ox,{proOptions:XS,position:YS}),j.jsx(rx,{rfId:as,disableKeyboardA11y:Pp})]})})}Lp=Wc($b),Up=function({type:t,id:e=null,nodeId:n,onConnect:r,onDisconnect:i}){const o=ro(),s=n??o,a=I.useRef(null),c=de(l=>l.connectionLookup.get(`${s}-${t}-${e}`),Fg);return I.useEffect(()=>{if(a.current&&a.current!==c){const l=c??new Map;ja(a.current,l,i),ja(l,a.current,r)}a.current=c??new Map},[c,r,i]),I.useMemo(()=>Array.from((c==null?void 0:c.values())??[]),[c])},Hp=function(t){return de(I.useCallback(e=>e.nodeLookup.get(t),[t]),xe)};function Bb({dimensions:t,lineWidth:e,variant:n,className:r}){return j.jsx("path",{strokeWidth:e,d:`M${t[0]/2} 0 V${t[1]} M0 ${t[1]/2} H${t[0]}`,className:Ee(["react-flow__background-pattern",n,r])})}function Db({radius:t,className:e}){return j.jsx("circle",{cx:t,cy:t,r:t,className:Ee(["react-flow__background-pattern","dots",e])})}(function(t){t.Lines="lines",t.Dots="dots",t.Cross="cross"})(nt||(nt={}));const Lb={[nt.Dots]:1,[nt.Lines]:1,[nt.Cross]:6},Fb=t=>({transform:t.transform,patternId:`pattern-${t.rfId}`});function _l({id:t,variant:e=nt.Dots,gap:n=20,size:r,lineWidth:i=1,offset:o=0,color:s,bgColor:a,style:c,className:l,patternClassName:u}){const d=I.useRef(null),{transform:h,patternId:p}=de(Fb,xe),f=r||Lb[e],m=e===nt.Dots,y=e===nt.Cross,g=Array.isArray(n)?n:[n,n],w=[g[0]*h[2]||1,g[1]*h[2]||1],v=f*h[2],x=Array.isArray(o)?o:[o,o],C=y?[v,v]:w,$=[x[0]*h[2]||1+C[0]/2,x[1]*h[2]||1+C[1]/2],O=`${p}${t||""}`;return j.jsxs("svg",{className:Ee(["react-flow__background",l]),style:{...c,...Pr,"--xy-background-color-props":a,"--xy-background-pattern-color-props":s},ref:d,"data-testid":"rf__background",children:[j.jsx("pattern",{id:O,x:h[0]%w[0],y:h[1]%w[1],width:w[0],height:w[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${$[0]},-${$[1]})`,children:m?j.jsx(Db,{radius:v/2,className:u}):j.jsx(Bb,{dimensions:C,lineWidth:i,variant:e,className:u})}),j.jsx("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${O})`})]})}_l.displayName="Background",Fp=I.memo(_l);function zb(){return j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32",children:j.jsx("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"})})}function Vb(){return j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5",children:j.jsx("path",{d:"M0 0h32v4.2H0z"})})}function qb(){return j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30",children:j.jsx("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"})})}function Wb(){return j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32",children:j.jsx("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"})})}function Hb(){return j.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32",children:j.jsx("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"})})}function jr({children:t,className:e,...n}){return j.jsx("button",{type:"button",className:Ee(["react-flow__controls-button",e]),...n,children:t})}const Ub=t=>({isInteractive:t.nodesDraggable||t.nodesConnectable||t.elementsSelectable,minZoomReached:t.transform[2]<=t.minZoom,maxZoomReached:t.transform[2]>=t.maxZoom});function Sl({style:t,showZoom:e=!0,showFitView:n=!0,showInteractive:r=!0,fitViewOptions:i,onZoomIn:o,onZoomOut:s,onFitView:a,onInteractiveChange:c,className:l,children:u,position:d="bottom-left",orientation:h="vertical","aria-label":p="React Flow controls"}){const f=ge(),{isInteractive:m,minZoomReached:y,maxZoomReached:g}=de(Ub,xe),{zoomIn:w,zoomOut:v,fitView:x}=Qn(),C=()=>{w(),o==null||o()},$=()=>{v(),s==null||s()},O=()=>{x(i),a==null||a()},E=()=>{f.setState({nodesDraggable:!m,nodesConnectable:!m,elementsSelectable:!m}),c==null||c(!m)},T=h==="horizontal"?"horizontal":"vertical";return j.jsxs(Ji,{className:Ee(["react-flow__controls",T,l]),position:d,style:t,"data-testid":"rf__controls","aria-label":p,children:[e&&j.jsxs(j.Fragment,{children:[j.jsx(jr,{onClick:C,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:g,children:j.jsx(zb,{})}),j.jsx(jr,{onClick:$,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:y,children:j.jsx(Vb,{})})]}),n&&j.jsx(jr,{className:"react-flow__controls-fitview",onClick:O,title:"fit view","aria-label":"fit view",children:j.jsx(qb,{})}),r&&j.jsx(jr,{className:"react-flow__controls-interactive",onClick:E,title:"toggle interactivity","aria-label":"toggle interactivity",children:m?j.jsx(Hb,{}):j.jsx(Wb,{})}),u]})}Sl.displayName="Controls",zp=I.memo(Sl);function Qb({id:t,x:e,y:n,width:r,height:i,style:o,color:s,strokeColor:a,strokeWidth:c,className:l,borderRadius:u,shapeRendering:d,selected:h,onClick:p}){const{background:f,backgroundColor:m}=o||{},y=s||f||m;return j.jsx("rect",{className:Ee(["react-flow__minimap-node",{selected:h},l]),x:e,y:n,rx:u,ry:u,width:r,height:i,style:{fill:y,stroke:a,strokeWidth:c},shapeRendering:d,onClick:p?g=>p(g,t):void 0})}const Yb=I.memo(Qb),Xb=t=>t.nodes.map(e=>e.id),io=t=>t instanceof Function?t:()=>t;function Zb({nodeStrokeColor:t,nodeColor:e,nodeClassName:n="",nodeBorderRadius:r=5,nodeStrokeWidth:i,nodeComponent:o=Yb,onClick:s}){const a=de(Xb,xe),c=io(e),l=io(t),u=io(n),d=typeof window>"u"||window.chrome?"crispEdges":"geometricPrecision";return j.jsx(j.Fragment,{children:a.map(h=>j.jsx(Kb,{id:h,nodeColorFunc:c,nodeStrokeColorFunc:l,nodeClassNameFunc:u,nodeBorderRadius:r,nodeStrokeWidth:i,NodeComponent:o,onClick:s,shapeRendering:d},h))})}function Gb({id:t,nodeColorFunc:e,nodeStrokeColorFunc:n,nodeClassNameFunc:r,nodeBorderRadius:i,nodeStrokeWidth:o,shapeRendering:s,NodeComponent:a,onClick:c}){const{node:l,x:u,y:d,width:h,height:p}=de(f=>{const m=f.nodeLookup.get(t),{x:y,y:g}=m.internals.positionAbsolute,{width:w,height:v}=Je(m);return{node:m,x:y,y:g,width:w,height:v}},xe);return!l||l.hidden||!Wa(l)?null:j.jsx(a,{x:u,y:d,width:h,height:p,style:l.style,selected:!!l.selected,className:r(l),color:e(l),borderRadius:i,strokeColor:n(l),strokeWidth:o,shapeRendering:s,onClick:c,id:l.id})}const Kb=I.memo(Gb);var Jb=I.memo(Zb);const ev=200,tv=150,nv=t=>{const e={x:-t.transform[0]/t.transform[2],y:-t.transform[1]/t.transform[2],width:t.width/t.transform[2],height:t.height/t.transform[2]};return{viewBB:e,boundingRect:t.nodeLookup.size>0?za(vn(t.nodeLookup),e):e,rfId:t.rfId,panZoom:t.panZoom,translateExtent:t.translateExtent,flowWidth:t.width,flowHeight:t.height}},rv="react-flow__minimap-desc";function Ol({style:t,className:e,nodeStrokeColor:n,nodeColor:r,nodeClassName:i="",nodeBorderRadius:o=5,nodeStrokeWidth:s,nodeComponent:a,bgColor:c,maskColor:l,maskStrokeColor:u,maskStrokeWidth:d,position:h="bottom-right",onClick:p,onNodeClick:f,pannable:m=!1,zoomable:y=!1,ariaLabel:g="React Flow mini map",inversePan:w,zoomStep:v=10,offsetScale:x=5}){const C=ge(),$=I.useRef(null),{boundingRect:O,viewBB:E,rfId:T,panZoom:A,translateExtent:z,flowWidth:V,flowHeight:F}=de(nv,xe),b=(t==null?void 0:t.width)??ev,N=(t==null?void 0:t.height)??tv,M=O.width/b,R=O.height/N,S=Math.max(M,R),P=S*b,D=S*N,W=x*S,B=O.x-(P-O.width)/2-W,J=O.y-(D-O.height)/2-W,Z=P+W*2,q=D+W*2,ee=`${rv}-${T}`,ne=I.useRef(0),H=I.useRef();ne.current=S,I.useEffect(()=>{if($.current&&A)return H.current=m0({domNode:$.current,panZoom:A,getTransform:()=>C.getState().transform,getViewScale:()=>ne.current}),()=>{var ce;(ce=H.current)==null||ce.destroy()}},[A]),I.useEffect(()=>{var ce;(ce=H.current)==null||ce.update({translateExtent:z,width:V,height:F,inversePan:w,pannable:m,zoomStep:v,zoomable:y})},[m,y,w,v,z,V,F]);const ae=p?ce=>{var me;const[se,he]=((me=H.current)==null?void 0:me.pointer(ce))||[0,0];p(ce,{x:se,y:he})}:void 0,oe=f?I.useCallback((ce,se)=>{const he=C.getState().nodeLookup.get(se);f(ce,he)},[]):void 0;return j.jsx(Ji,{position:h,style:{...t,"--xy-minimap-background-color-props":typeof c=="string"?c:void 0,"--xy-minimap-mask-background-color-props":typeof l=="string"?l:void 0,"--xy-minimap-mask-stroke-color-props":typeof u=="string"?u:void 0,"--xy-minimap-mask-stroke-width-props":typeof d=="number"?d*S:void 0,"--xy-minimap-node-background-color-props":typeof r=="string"?r:void 0,"--xy-minimap-node-stroke-color-props":typeof n=="string"?n:void 0,"--xy-minimap-node-stroke-width-props":typeof s=="string"?s:void 0},className:Ee(["react-flow__minimap",e]),"data-testid":"rf__minimap",children:j.jsxs("svg",{width:b,height:N,viewBox:`${B} ${J} ${Z} ${q}`,className:"react-flow__minimap-svg",role:"img","aria-labelledby":ee,ref:$,onClick:ae,children:[g&&j.jsx("title",{id:ee,children:g}),j.jsx(Jb,{onClick:oe,nodeColor:r,nodeStrokeColor:n,nodeBorderRadius:o,nodeClassName:i,nodeStrokeWidth:s,nodeComponent:a}),j.jsx("path",{className:"react-flow__minimap-mask",d:`M${B-W},${J-W}h${Z+W*2}v${q+W*2}h${-Z-W*2}z
        M${E.x},${E.y}h${E.width}v${E.height}h${-E.width}z`,fillRule:"evenodd",pointerEvents:"none"})]})})}Ol.displayName="MiniMap",Vp=I.memo(Ol);function iv({nodeId:t,position:e,variant:n=Lt.Handle,className:r,style:i={},children:o,color:s,minWidth:a=10,minHeight:c=10,maxWidth:l=Number.MAX_VALUE,maxHeight:u=Number.MAX_VALUE,keepAspectRatio:d=!1,shouldResize:h,onResizeStart:p,onResize:f,onResizeEnd:m}){const y=ro(),g=typeof t=="string"?t:y,w=ge(),v=I.useRef(null),x=n===Lt.Line?"right":"bottom-right",C=e??x,$=I.useRef(null);I.useEffect(()=>{if(!(!v.current||!g))return $.current||($.current=k0({domNode:v.current,nodeId:g,getStoreItems:()=>{const{nodeLookup:A,transform:z,snapGrid:V,snapToGrid:F,nodeOrigin:b,domNode:N}=w.getState();return{nodeLookup:A,transform:z,snapGrid:V,snapToGrid:F,nodeOrigin:b,paneDomNode:N}},onChange:(A,z)=>{const{triggerNodeChanges:V,nodeLookup:F,parentLookup:b,nodeOrigin:N}=w.getState(),M=[],R={x:A.x,y:A.y},S=F.get(g);if(S&&S.expandParent&&S.parentId){const P=S.origin??N,D=A.width??S.measured.width,W=A.height??S.measured.height,B={id:S.id,parentId:S.parentId,rect:{width:D,height:W,...Ha({x:A.x??S.position.x,y:A.y??S.position.y},{width:D,height:W},S.parentId,F,P)}},J=Ui([B],F,b,N);M.push(...J),R.x=A.x?Math.max(P[0]*D,A.x):void 0,R.y=A.y?Math.max(P[1]*W,A.y):void 0}if(R.x!==void 0&&R.y!==void 0){const P={id:g,type:"position",position:{...R}};M.push(P)}if(A.width!==void 0&&A.height!==void 0){const P={id:g,type:"dimensions",resizing:!0,setAttributes:!0,dimensions:{width:A.width,height:A.height}};M.push(P)}for(const P of z){const D={...P,type:"position"};M.push(D)}V(M)},onEnd:()=>{const A={id:g,type:"dimensions",resizing:!1};w.getState().triggerNodeChanges([A])}})),$.current.update({controlPosition:C,boundaries:{minWidth:a,minHeight:c,maxWidth:l,maxHeight:u},keepAspectRatio:d,onResizeStart:p,onResize:f,onResizeEnd:m,shouldResize:h}),()=>{var A;(A=$.current)==null||A.destroy()}},[C,a,c,l,u,d,p,f,m,h]);const O=C.split("-"),E=n===Lt.Line?"borderColor":"backgroundColor",T=s?{...i,[E]:s}:i;return j.jsx("div",{className:Ee(["react-flow__resize-control","nodrag",...O,n,r]),ref:v,style:T,children:o})}const Al=I.memo(iv);Dp=function({nodeId:t,isVisible:e=!0,handleClassName:n,handleStyle:r,lineClassName:i,lineStyle:o,color:s,minWidth:a=10,minHeight:c=10,maxWidth:l=Number.MAX_VALUE,maxHeight:u=Number.MAX_VALUE,keepAspectRatio:d=!1,shouldResize:h,onResizeStart:p,onResize:f,onResizeEnd:m}){return e?j.jsxs(j.Fragment,{children:[_0.map(y=>j.jsx(Al,{className:i,style:o,nodeId:t,position:y,variant:Lt.Line,color:s,minWidth:a,minHeight:c,maxWidth:l,maxHeight:u,onResizeStart:p,keepAspectRatio:d,shouldResize:h,onResize:f,onResizeEnd:m},y)),C0.map(y=>j.jsx(Al,{className:n,style:r,nodeId:t,position:y,color:s,minWidth:a,minHeight:c,maxWidth:l,maxHeight:u,onResizeStart:p,keepAspectRatio:d,shouldResize:h,onResize:f,onResizeEnd:m},y))]}):null};var Nl;(function(t){(function(e){var n=typeof globalThis=="object"?globalThis:typeof tn=="object"?tn:typeof self=="object"?self:typeof this=="object"?this:a(),r=i(t);typeof n.Reflect<"u"&&(r=i(n.Reflect,r)),e(r,n),typeof n.Reflect>"u"&&(n.Reflect=t);function i(c,l){return function(u,d){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:d}),l&&l(u,d)}}function o(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return o()||s()}})(function(e,n){var r=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",o=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,u={create:a?function(){return Ln(Object.create(null))}:c?function(){return Ln({__proto__:null})}:function(){return Ln({})},has:l?function(_,k){return r.call(_,k)}:function(_,k){return k in _},get:l?function(_,k){return r.call(_,k)?_[k]:void 0}:function(_,k){return _[k]}},d=Object.getPrototypeOf(Function),h=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:en(),p=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:is(),f=typeof WeakMap=="function"?WeakMap:Dn(),m=i?Symbol.for("@reflect-metadata:registry"):void 0,y=Et(),g=Bn(y);function w(_,k,L,U){if(B(L)){if(!ce(_))throw new TypeError;if(!he(k))throw new TypeError;return V(_,k)}else{if(!ce(_))throw new TypeError;if(!q(k))throw new TypeError;if(!q(U)&&!B(U)&&!J(U))throw new TypeError;return J(U)&&(U=void 0),L=oe(L),F(_,k,L,U)}}e("decorate",w);function v(_,k){function L(U,ie){if(!q(U))throw new TypeError;if(!B(ie)&&!me(ie))throw new TypeError;S(_,k,U,ie)}return L}e("metadata",v);function x(_,k,L,U){if(!q(L))throw new TypeError;return B(U)||(U=oe(U)),S(_,k,L,U)}e("defineMetadata",x);function C(_,k,L){if(!q(k))throw new TypeError;return B(L)||(L=oe(L)),b(_,k,L)}e("hasMetadata",C);function $(_,k,L){if(!q(k))throw new TypeError;return B(L)||(L=oe(L)),N(_,k,L)}e("hasOwnMetadata",$);function O(_,k,L){if(!q(k))throw new TypeError;return B(L)||(L=oe(L)),M(_,k,L)}e("getMetadata",O);function E(_,k,L){if(!q(k))throw new TypeError;return B(L)||(L=oe(L)),R(_,k,L)}e("getOwnMetadata",E);function T(_,k){if(!q(_))throw new TypeError;return B(k)||(k=oe(k)),P(_,k)}e("getMetadataKeys",T);function A(_,k){if(!q(_))throw new TypeError;return B(k)||(k=oe(k)),D(_,k)}e("getOwnMetadataKeys",A);function z(_,k,L){if(!q(k))throw new TypeError;if(B(L)||(L=oe(L)),!q(k))throw new TypeError;B(L)||(L=oe(L));var U=Fe(k,L,!1);return B(U)?!1:U.OrdinaryDeleteMetadata(_,k,L)}e("deleteMetadata",z);function V(_,k){for(var L=_.length-1;L>=0;--L){var U=_[L],ie=U(k);if(!B(ie)&&!J(ie)){if(!he(ie))throw new TypeError;k=ie}}return k}function F(_,k,L,U){for(var ie=_.length-1;ie>=0;--ie){var _e=_[ie],we=_e(k,L,U);if(!B(we)&&!J(we)){if(!q(we))throw new TypeError;U=we}}return U}function b(_,k,L){var U=N(_,k,L);if(U)return!0;var ie=wt(k);return J(ie)?!1:b(_,ie,L)}function N(_,k,L){var U=Fe(k,L,!1);return B(U)?!1:H(U.OrdinaryHasOwnMetadata(_,k,L))}function M(_,k,L){var U=N(_,k,L);if(U)return R(_,k,L);var ie=wt(k);if(!J(ie))return M(_,ie,L)}function R(_,k,L){var U=Fe(k,L,!1);if(!B(U))return U.OrdinaryGetOwnMetadata(_,k,L)}function S(_,k,L,U){var ie=Fe(L,U,!0);ie.OrdinaryDefineOwnMetadata(_,k,L,U)}function P(_,k){var L=D(_,k),U=wt(_);if(U===null)return L;var ie=P(U,k);if(ie.length<=0)return L;if(L.length<=0)return ie;for(var _e=new p,we=[],le=0,Y=L;le<Y.length;le++){var G=Y[le],K=_e.has(G);K||(_e.add(G),we.push(G))}for(var te=0,ue=ie;te<ue.length;te++){var G=ue[te],K=_e.has(G);K||(_e.add(G),we.push(G))}return we}function D(_,k){var L=Fe(_,k,!1);return L?L.OrdinaryOwnMetadataKeys(_,k):[]}function W(_){if(_===null)return 1;switch(typeof _){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return _===null?1:6;default:return 6}}function B(_){return _===void 0}function J(_){return _===null}function Z(_){return typeof _=="symbol"}function q(_){return typeof _=="object"?_!==null:typeof _=="function"}function ee(_,k){switch(W(_)){case 0:return _;case 1:return _;case 2:return _;case 3:return _;case 4:return _;case 5:return _}var L="string",U=tt(_,o);if(U!==void 0){var ie=U.call(_,L);if(q(ie))throw new TypeError;return ie}return ne(_)}function ne(_,k){var L,U;{var ie=_.toString;if(se(ie)){var U=ie.call(_);if(!q(U))return U}var L=_.valueOf;if(se(L)){var U=L.call(_);if(!q(U))return U}}throw new TypeError}function H(_){return!!_}function ae(_){return""+_}function oe(_){var k=ee(_);return Z(k)?k:ae(k)}function ce(_){return Array.isArray?Array.isArray(_):_ instanceof Object?_ instanceof Array:Object.prototype.toString.call(_)==="[object Array]"}function se(_){return typeof _=="function"}function he(_){return typeof _=="function"}function me(_){switch(W(_)){case 3:return!0;case 4:return!0;default:return!1}}function Pe(_,k){return _===k||_!==_&&k!==k}function tt(_,k){var L=_[k];if(L!=null){if(!se(L))throw new TypeError;return L}}function Gt(_){var k=tt(_,s);if(!se(k))throw new TypeError;var L=k.call(_);if(!q(L))throw new TypeError;return L}function Kt(_){return _.value}function Jt(_){var k=_.next();return k.done?!1:k}function at(_){var k=_.return;k&&k.call(_)}function wt(_){var k=Object.getPrototypeOf(_);if(typeof _!="function"||_===d||k!==d)return k;var L=_.prototype,U=L&&Object.getPrototypeOf(L);if(U==null||U===Object.prototype)return k;var ie=U.constructor;return typeof ie!="function"||ie===_?k:ie}function Mt(){var _;!B(m)&&typeof n.Reflect<"u"&&!(m in n.Reflect)&&typeof n.Reflect.defineMetadata=="function"&&(_=Ct(n.Reflect));var k,L,U,ie=new f,_e={registerProvider:we,getProvider:Y,setProvider:K};return _e;function we(te){if(!Object.isExtensible(_e))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case _===te:break;case B(k):k=te;break;case k===te:break;case B(L):L=te;break;case L===te:break;default:U===void 0&&(U=new p),U.add(te);break}}function le(te,ue){if(!B(k)){if(k.isProviderFor(te,ue))return k;if(!B(L)){if(L.isProviderFor(te,ue))return k;if(!B(U))for(var pe=Gt(U);;){var ve=Jt(pe);if(!ve)return;var Re=Kt(ve);if(Re.isProviderFor(te,ue))return at(pe),Re}}}if(!B(_)&&_.isProviderFor(te,ue))return _}function Y(te,ue){var pe=ie.get(te),ve;return B(pe)||(ve=pe.get(ue)),B(ve)&&(ve=le(te,ue),B(ve)||(B(pe)&&(pe=new h,ie.set(te,pe)),pe.set(ue,ve))),ve}function G(te){if(B(te))throw new TypeError;return k===te||L===te||!B(U)&&U.has(te)}function K(te,ue,pe){if(!G(pe))throw new Error("Metadata provider not registered.");var ve=Y(te,ue);if(ve!==pe){if(!B(ve))return!1;var Re=ie.get(te);B(Re)&&(Re=new h,ie.set(te,Re)),Re.set(ue,pe)}return!0}}function Et(){var _;return!B(m)&&q(n.Reflect)&&Object.isExtensible(n.Reflect)&&(_=n.Reflect[m]),B(_)&&(_=Mt()),!B(m)&&q(n.Reflect)&&Object.isExtensible(n.Reflect)&&Object.defineProperty(n.Reflect,m,{enumerable:!1,configurable:!1,writable:!1,value:_}),_}function Bn(_){var k=new f,L={isProviderFor:function(G,K){var te=k.get(G);return B(te)?!1:te.has(K)},OrdinaryDefineOwnMetadata:we,OrdinaryHasOwnMetadata:ie,OrdinaryGetOwnMetadata:_e,OrdinaryOwnMetadataKeys:le,OrdinaryDeleteMetadata:Y};return y.registerProvider(L),L;function U(G,K,te){var ue=k.get(G),pe=!1;if(B(ue)){if(!te)return;ue=new h,k.set(G,ue),pe=!0}var ve=ue.get(K);if(B(ve)){if(!te)return;if(ve=new h,ue.set(K,ve),!_.setProvider(G,K,L))throw ue.delete(K),pe&&k.delete(G),new Error("Wrong provider for target.")}return ve}function ie(G,K,te){var ue=U(K,te,!1);return B(ue)?!1:H(ue.has(G))}function _e(G,K,te){var ue=U(K,te,!1);if(!B(ue))return ue.get(G)}function we(G,K,te,ue){var pe=U(te,ue,!0);pe.set(G,K)}function le(G,K){var te=[],ue=U(G,K,!1);if(B(ue))return te;for(var pe=ue.keys(),ve=Gt(pe),Re=0;;){var ei=Jt(ve);if(!ei)return te.length=Re,te;var os=Kt(ei);try{te[Re]=os}catch(ss){try{at(ve)}finally{throw ss}}Re++}}function Y(G,K,te){var ue=U(K,te,!1);if(B(ue)||!ue.delete(G))return!1;if(ue.size===0){var pe=k.get(K);B(pe)||(pe.delete(te),pe.size===0&&k.delete(pe))}return!0}}function Ct(_){var k=_.defineMetadata,L=_.hasOwnMetadata,U=_.getOwnMetadata,ie=_.getOwnMetadataKeys,_e=_.deleteMetadata,we=new f,le={isProviderFor:function(Y,G){var K=we.get(Y);return!B(K)&&K.has(G)?!0:ie(Y,G).length?(B(K)&&(K=new p,we.set(Y,K)),K.add(G),!0):!1},OrdinaryDefineOwnMetadata:k,OrdinaryHasOwnMetadata:L,OrdinaryGetOwnMetadata:U,OrdinaryOwnMetadataKeys:ie,OrdinaryDeleteMetadata:_e};return le}function Fe(_,k,L){var U=y.getProvider(_,k);if(!B(U))return U;if(L){if(y.setProvider(_,k,g))return g;throw new Error("Illegal state.")}}function en(){var _={},k=[],L=function(){function le(Y,G,K){this._index=0,this._keys=Y,this._values=G,this._selector=K}return le.prototype["@@iterator"]=function(){return this},le.prototype[s]=function(){return this},le.prototype.next=function(){var Y=this._index;if(Y>=0&&Y<this._keys.length){var G=this._selector(this._keys[Y],this._values[Y]);return Y+1>=this._keys.length?(this._index=-1,this._keys=k,this._values=k):this._index++,{value:G,done:!1}}return{value:void 0,done:!0}},le.prototype.throw=function(Y){throw this._index>=0&&(this._index=-1,this._keys=k,this._values=k),Y},le.prototype.return=function(Y){return this._index>=0&&(this._index=-1,this._keys=k,this._values=k),{value:Y,done:!0}},le}(),U=function(){function le(){this._keys=[],this._values=[],this._cacheKey=_,this._cacheIndex=-2}return Object.defineProperty(le.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),le.prototype.has=function(Y){return this._find(Y,!1)>=0},le.prototype.get=function(Y){var G=this._find(Y,!1);return G>=0?this._values[G]:void 0},le.prototype.set=function(Y,G){var K=this._find(Y,!0);return this._values[K]=G,this},le.prototype.delete=function(Y){var G=this._find(Y,!1);if(G>=0){for(var K=this._keys.length,te=G+1;te<K;te++)this._keys[te-1]=this._keys[te],this._values[te-1]=this._values[te];return this._keys.length--,this._values.length--,Pe(Y,this._cacheKey)&&(this._cacheKey=_,this._cacheIndex=-2),!0}return!1},le.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=_,this._cacheIndex=-2},le.prototype.keys=function(){return new L(this._keys,this._values,ie)},le.prototype.values=function(){return new L(this._keys,this._values,_e)},le.prototype.entries=function(){return new L(this._keys,this._values,we)},le.prototype["@@iterator"]=function(){return this.entries()},le.prototype[s]=function(){return this.entries()},le.prototype._find=function(Y,G){if(!Pe(this._cacheKey,Y)){this._cacheIndex=-1;for(var K=0;K<this._keys.length;K++)if(Pe(this._keys[K],Y)){this._cacheIndex=K;break}}return this._cacheIndex<0&&G&&(this._cacheIndex=this._keys.length,this._keys.push(Y),this._values.push(void 0)),this._cacheIndex},le}();return U;function ie(le,Y){return le}function _e(le,Y){return Y}function we(le,Y){return[le,Y]}}function is(){var _=function(){function k(){this._map=new h}return Object.defineProperty(k.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),k.prototype.has=function(L){return this._map.has(L)},k.prototype.add=function(L){return this._map.set(L,L),this},k.prototype.delete=function(L){return this._map.delete(L)},k.prototype.clear=function(){this._map.clear()},k.prototype.keys=function(){return this._map.keys()},k.prototype.values=function(){return this._map.keys()},k.prototype.entries=function(){return this._map.entries()},k.prototype["@@iterator"]=function(){return this.keys()},k.prototype[s]=function(){return this.keys()},k}();return _}function Dn(){var _=16,k=u.create(),L=U();return function(){function Y(){this._key=U()}return Y.prototype.has=function(G){var K=ie(G,!1);return K!==void 0?u.has(K,this._key):!1},Y.prototype.get=function(G){var K=ie(G,!1);return K!==void 0?u.get(K,this._key):void 0},Y.prototype.set=function(G,K){var te=ie(G,!0);return te[this._key]=K,this},Y.prototype.delete=function(G){var K=ie(G,!1);return K!==void 0?delete K[this._key]:!1},Y.prototype.clear=function(){this._key=U()},Y}();function U(){var Y;do Y="@@WeakMap@@"+le();while(u.has(k,Y));return k[Y]=!0,Y}function ie(Y,G){if(!r.call(Y,L)){if(!G)return;Object.defineProperty(Y,L,{value:u.create()})}return Y[L]}function _e(Y,G){for(var K=0;K<G;++K)Y[K]=Math.random()*255|0;return Y}function we(Y){if(typeof Uint8Array=="function"){var G=new Uint8Array(Y);return typeof crypto<"u"?crypto.getRandomValues(G):typeof msCrypto<"u"?msCrypto.getRandomValues(G):_e(G,Y),G}return _e(new Array(Y),Y)}function le(){var Y=we(_);Y[6]=Y[6]&79|64,Y[8]=Y[8]&191|128;for(var G="",K=0;K<_;++K){var te=Y[K];(K===4||K===6||K===8)&&(G+="-"),te<16&&(G+="0"),G+=te.toString(16).toLowerCase()}return G}}function Ln(_){return _.__=void 0,delete _.__,_}})})(Nl||(Nl={})),ai=globalThis||void 0||self,typeof window<"u"&&(window.Buffer=yO),typeof ai<"u"&&typeof require<"u"&&(ai.Buffer=require("buffer/").Buffer);class Ce{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...n){for(const r of n)for(const i of Object.getOwnPropertyNames(r))e[i]=r[i]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(n=>e[n]):e}}class X extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class Vt extends X{constructor(){super("Locking not supported on given driver.")}}class oo extends X{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class fe{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,n){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(n)}}class ov extends X{constructor(e,n){super(),this.entityClass=e,this.criteria=n,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(n)}`}stringifyTarget(e){return fe.isEntitySchema(e)?e.options.name:typeof e=="function"||Ce.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class Pl extends X{constructor(e,n,r){super(`The optimistic lock on entity ${e} failed, version ${n} was expected, but is actually ${r}.`)}}class Tl extends X{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class sv extends X{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class Ir extends X{constructor(){super("OUTPUT or RETURNING clause only supported by Microsoft SQL Server or PostgreSQL or MariaDB databases.")}}class We extends X{constructor(e,n){super(e),Object.setPrototypeOf(this,We.prototype),this.message=`Property "${e}" was not found in "${n.targetName}". Make sure your query is correct.`}}class av extends X{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class cv extends X{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class On extends X{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class lv extends X{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(n=>`"${n}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class uv extends X{constructor(){super("An open transaction is required for pessimistic lock.")}}class dv extends X{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class kl{constructor(e){Ce.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new X(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class He{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[n,r]=e.split(".");return!(!n||!r||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var jl={exports:{}},so={exports:{}};typeof Object.create=="function"?so.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:so.exports=function(t,e){if(e){t.super_=e;var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}};var qt=so.exports,ao={exports:{}};(function(t,e){var n=gO,r=n.Buffer;function i(s,a){for(var c in s)a[c]=s[c]}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?t.exports=n:(i(n,e),e.Buffer=o);function o(s,a,c){return r(s,a,c)}o.prototype=Object.create(r.prototype),i(r,o),o.from=function(s,a,c){if(typeof s=="number")throw new TypeError("Argument must not be a number");return r(s,a,c)},o.alloc=function(s,a,c){if(typeof s!="number")throw new TypeError("Argument must be a number");var l=r(s);return a!==void 0?typeof c=="string"?l.fill(a,c):l.fill(a):l.fill(0),l},o.allocUnsafe=function(s){if(typeof s!="number")throw new TypeError("Argument must be a number");return r(s)},o.allocUnsafeSlow=function(s){if(typeof s!="number")throw new TypeError("Argument must be a number");return n.SlowBuffer(s)}})(ao,ao.exports);var gt=ao.exports,Il=gt.Buffer;function Rr(t,e){this._block=Il.alloc(t),this._finalSize=e,this._blockSize=t,this._len=0}Rr.prototype.update=function(t,e){typeof t=="string"&&(e=e||"utf8",t=Il.from(t,e));for(var n=this._block,r=this._blockSize,i=t.length,o=this._len,s=0;s<i;){for(var a=o%r,c=Math.min(i-s,r-a),l=0;l<c;l++)n[a+l]=t[s+l];o+=c,s+=c,o%r===0&&this._update(n)}return this._len+=i,this},Rr.prototype.digest=function(t){var e=this._len%this._blockSize;this._block[e]=128,this._block.fill(0,e+1),e>=this._finalSize&&(this._update(this._block),this._block.fill(0));var n=this._len*8;if(n<=4294967295)this._block.writeUInt32BE(n,this._blockSize-4);else{var r=(n&4294967295)>>>0,i=(n-r)/4294967296;this._block.writeUInt32BE(i,this._blockSize-8),this._block.writeUInt32BE(r,this._blockSize-4)}this._update(this._block);var o=this._hash();return t?o.toString(t):o},Rr.prototype._update=function(){throw new Error("_update must be implemented by subclass")};var Wt=Rr,hv=qt,Rl=Wt,pv=gt.Buffer,fv=[1518500249,1859775393,-1894007588,-899497514],mv=new Array(80);function An(){this.init(),this._w=mv,Rl.call(this,64,56)}hv(An,Rl),An.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function yv(t){return t<<5|t>>>27}function gv(t){return t<<30|t>>>2}function xv(t,e,n,r){return t===0?e&n|~e&r:t===2?e&n|e&r|n&r:e^n^r}An.prototype._update=function(t){for(var e=this._w,n=this._a|0,r=this._b|0,i=this._c|0,o=this._d|0,s=this._e|0,a=0;a<16;++a)e[a]=t.readInt32BE(a*4);for(;a<80;++a)e[a]=e[a-3]^e[a-8]^e[a-14]^e[a-16];for(var c=0;c<80;++c){var l=~~(c/20),u=yv(n)+xv(l,r,i,o)+s+e[c]+fv[l]|0;s=o,o=i,i=gv(r),r=n,n=u}this._a=n+this._a|0,this._b=r+this._b|0,this._c=i+this._c|0,this._d=o+this._d|0,this._e=s+this._e|0},An.prototype._hash=function(){var t=pv.allocUnsafe(20);return t.writeInt32BE(this._a|0,0),t.writeInt32BE(this._b|0,4),t.writeInt32BE(this._c|0,8),t.writeInt32BE(this._d|0,12),t.writeInt32BE(this._e|0,16),t};var bv=An,vv=qt,$l=Wt,wv=gt.Buffer,Mv=[1518500249,1859775393,-1894007588,-899497514],Ev=new Array(80);function Nn(){this.init(),this._w=Ev,$l.call(this,64,56)}vv(Nn,$l),Nn.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function Cv(t){return t<<1|t>>>31}function _v(t){return t<<5|t>>>27}function Sv(t){return t<<30|t>>>2}function Ov(t,e,n,r){return t===0?e&n|~e&r:t===2?e&n|e&r|n&r:e^n^r}Nn.prototype._update=function(t){for(var e=this._w,n=this._a|0,r=this._b|0,i=this._c|0,o=this._d|0,s=this._e|0,a=0;a<16;++a)e[a]=t.readInt32BE(a*4);for(;a<80;++a)e[a]=Cv(e[a-3]^e[a-8]^e[a-14]^e[a-16]);for(var c=0;c<80;++c){var l=~~(c/20),u=_v(n)+Ov(l,r,i,o)+s+e[c]+Mv[l]|0;s=o,o=i,i=Sv(r),r=n,n=u}this._a=n+this._a|0,this._b=r+this._b|0,this._c=i+this._c|0,this._d=o+this._d|0,this._e=s+this._e|0},Nn.prototype._hash=function(){var t=wv.allocUnsafe(20);return t.writeInt32BE(this._a|0,0),t.writeInt32BE(this._b|0,4),t.writeInt32BE(this._c|0,8),t.writeInt32BE(this._d|0,12),t.writeInt32BE(this._e|0,16),t};var Av=Nn,Nv=qt,Bl=Wt,Pv=gt.Buffer,Tv=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],kv=new Array(64);function Pn(){this.init(),this._w=kv,Bl.call(this,64,56)}Nv(Pn,Bl),Pn.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function jv(t,e,n){return n^t&(e^n)}function Iv(t,e,n){return t&e|n&(t|e)}function Rv(t){return(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10)}function $v(t){return(t>>>6|t<<26)^(t>>>11|t<<21)^(t>>>25|t<<7)}function Bv(t){return(t>>>7|t<<25)^(t>>>18|t<<14)^t>>>3}function Dv(t){return(t>>>17|t<<15)^(t>>>19|t<<13)^t>>>10}Pn.prototype._update=function(t){for(var e=this._w,n=this._a|0,r=this._b|0,i=this._c|0,o=this._d|0,s=this._e|0,a=this._f|0,c=this._g|0,l=this._h|0,u=0;u<16;++u)e[u]=t.readInt32BE(u*4);for(;u<64;++u)e[u]=Dv(e[u-2])+e[u-7]+Bv(e[u-15])+e[u-16]|0;for(var d=0;d<64;++d){var h=l+$v(s)+jv(s,a,c)+Tv[d]+e[d]|0,p=Rv(n)+Iv(n,r,i)|0;l=c,c=a,a=s,s=o+h|0,o=i,i=r,r=n,n=h+p|0}this._a=n+this._a|0,this._b=r+this._b|0,this._c=i+this._c|0,this._d=o+this._d|0,this._e=s+this._e|0,this._f=a+this._f|0,this._g=c+this._g|0,this._h=l+this._h|0},Pn.prototype._hash=function(){var t=Pv.allocUnsafe(32);return t.writeInt32BE(this._a,0),t.writeInt32BE(this._b,4),t.writeInt32BE(this._c,8),t.writeInt32BE(this._d,12),t.writeInt32BE(this._e,16),t.writeInt32BE(this._f,20),t.writeInt32BE(this._g,24),t.writeInt32BE(this._h,28),t};var Dl=Pn,Lv=qt,Fv=Dl,zv=Wt,Vv=gt.Buffer,qv=new Array(64);function $r(){this.init(),this._w=qv,zv.call(this,64,56)}Lv($r,Fv),$r.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},$r.prototype._hash=function(){var t=Vv.allocUnsafe(28);return t.writeInt32BE(this._a,0),t.writeInt32BE(this._b,4),t.writeInt32BE(this._c,8),t.writeInt32BE(this._d,12),t.writeInt32BE(this._e,16),t.writeInt32BE(this._f,20),t.writeInt32BE(this._g,24),t};var Wv=$r,Hv=qt,Ll=Wt,Uv=gt.Buffer,Fl=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],Qv=new Array(160);function Tn(){this.init(),this._w=Qv,Ll.call(this,128,112)}Hv(Tn,Ll),Tn.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function zl(t,e,n){return n^t&(e^n)}function Vl(t,e,n){return t&e|n&(t|e)}function ql(t,e){return(t>>>28|e<<4)^(e>>>2|t<<30)^(e>>>7|t<<25)}function Wl(t,e){return(t>>>14|e<<18)^(t>>>18|e<<14)^(e>>>9|t<<23)}function Yv(t,e){return(t>>>1|e<<31)^(t>>>8|e<<24)^t>>>7}function Xv(t,e){return(t>>>1|e<<31)^(t>>>8|e<<24)^(t>>>7|e<<25)}function Zv(t,e){return(t>>>19|e<<13)^(e>>>29|t<<3)^t>>>6}function Gv(t,e){return(t>>>19|e<<13)^(e>>>29|t<<3)^(t>>>6|e<<26)}function Oe(t,e){return t>>>0<e>>>0?1:0}Tn.prototype._update=function(t){for(var e=this._w,n=this._ah|0,r=this._bh|0,i=this._ch|0,o=this._dh|0,s=this._eh|0,a=this._fh|0,c=this._gh|0,l=this._hh|0,u=this._al|0,d=this._bl|0,h=this._cl|0,p=this._dl|0,f=this._el|0,m=this._fl|0,y=this._gl|0,g=this._hl|0,w=0;w<32;w+=2)e[w]=t.readInt32BE(w*4),e[w+1]=t.readInt32BE(w*4+4);for(;w<160;w+=2){var v=e[w-30],x=e[w-15*2+1],C=Yv(v,x),$=Xv(x,v);v=e[w-2*2],x=e[w-2*2+1];var O=Zv(v,x),E=Gv(x,v),T=e[w-7*2],A=e[w-7*2+1],z=e[w-16*2],V=e[w-16*2+1],F=$+A|0,b=C+T+Oe(F,$)|0;F=F+E|0,b=b+O+Oe(F,E)|0,F=F+V|0,b=b+z+Oe(F,V)|0,e[w]=b,e[w+1]=F}for(var N=0;N<160;N+=2){b=e[N],F=e[N+1];var M=Vl(n,r,i),R=Vl(u,d,h),S=ql(n,u),P=ql(u,n),D=Wl(s,f),W=Wl(f,s),B=Fl[N],J=Fl[N+1],Z=zl(s,a,c),q=zl(f,m,y),ee=g+W|0,ne=l+D+Oe(ee,g)|0;ee=ee+q|0,ne=ne+Z+Oe(ee,q)|0,ee=ee+J|0,ne=ne+B+Oe(ee,J)|0,ee=ee+F|0,ne=ne+b+Oe(ee,F)|0;var H=P+R|0,ae=S+M+Oe(H,P)|0;l=c,g=y,c=a,y=m,a=s,m=f,f=p+ee|0,s=o+ne+Oe(f,p)|0,o=i,p=h,i=r,h=d,r=n,d=u,u=ee+H|0,n=ne+ae+Oe(u,ee)|0}this._al=this._al+u|0,this._bl=this._bl+d|0,this._cl=this._cl+h|0,this._dl=this._dl+p|0,this._el=this._el+f|0,this._fl=this._fl+m|0,this._gl=this._gl+y|0,this._hl=this._hl+g|0,this._ah=this._ah+n+Oe(this._al,u)|0,this._bh=this._bh+r+Oe(this._bl,d)|0,this._ch=this._ch+i+Oe(this._cl,h)|0,this._dh=this._dh+o+Oe(this._dl,p)|0,this._eh=this._eh+s+Oe(this._el,f)|0,this._fh=this._fh+a+Oe(this._fl,m)|0,this._gh=this._gh+c+Oe(this._gl,y)|0,this._hh=this._hh+l+Oe(this._hl,g)|0},Tn.prototype._hash=function(){var t=Uv.allocUnsafe(64);function e(n,r,i){t.writeInt32BE(n,i),t.writeInt32BE(r,i+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),e(this._gh,this._gl,48),e(this._hh,this._hl,56),t};var Hl=Tn,Kv=qt,Jv=Hl,ew=Wt,tw=gt.Buffer,nw=new Array(160);function Br(){this.init(),this._w=nw,ew.call(this,128,112)}Kv(Br,Jv),Br.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},Br.prototype._hash=function(){var t=tw.allocUnsafe(48);function e(n,r,i){t.writeInt32BE(n,i),t.writeInt32BE(r,i+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),t};var rw=Br,xt=jl.exports=function(t){t=t.toLowerCase();var e=xt[t];if(!e)throw new Error(t+" is not supported (we accept pull requests)");return new e};xt.sha=bv,xt.sha1=Av,xt.sha224=Wv,xt.sha256=Dl,xt.sha384=rw,xt.sha512=Hl;var iw=jl.exports;const ow=Ue(iw);function sw(t,e={}){const{segmentLength:n=4,separator:r="__",termLength:i=2}=e;return t.split(r).reduce((o,s)=>{const a=s.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),c=a.length>1?i:n,l=a.map(u=>u.substr(0,c)).join("");return o.push(l),o},[]).join(r)}function aw(t,e={}){const n=ow("sha1");n.update(t,"utf8");const r=n.digest("hex");return e.length?r.slice(0,e.length):r}class cw{static isGreaterOrEqual(e,n){const r=Ul(e),i=Ul(n);return r[0]>i[0]||r[0]===i[0]&&r[1]>i[1]||r[0]===i[0]&&r[1]===i[1]&&r[2]>=i[2]}}function Ul(t=""){const e=[0,0,0];return t.split(".").forEach((n,r)=>e[r]=parseInt(n,10)),e}class Q{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,n){return e.version!=null&&cw.isGreaterOrEqual(e.version,n)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,n){if(e.url){const r=this.parseConnectionUrl(e.url);n&&n.useSid&&r.database&&(r.sid=r.database);for(const i of Object.keys(r))typeof r[i]>"u"&&delete r[i];return Object.assign({},e,r)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,n){if(e.url){const r=this.parseMongoDBConnectionUrl(e.url);n&&n.useSid&&r.database&&(r.sid=r.database);for(const i of Object.keys(r))typeof r[i]>"u"&&delete r[i];return Object.assign({},e,r)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},n,...r){const i=n&&n.joiner?n.joiner:"_";let o=r.length===1?r[0]:r.join(i);if(e&&e>0&&o.length>e){if(n&&n.shorten===!0){const s=sw(o);if(s.length<e)return s}return aw(o,{length:e})}return o}static buildColumnAlias({maxAliasLength:e},n,...r){return typeof n=="string"?(r.unshift(n),n={shorten:!1,joiner:"_"}):n=Object.assign({shorten:!1,joiner:"_"},n),this.buildAlias({maxAliasLength:e},n,...r)}static parseConnectionUrl(e){const n=e.split(":")[0],r=e.indexOf("//"),i=e.substr(r+2),o=i.indexOf("/"),s=o!==-1?i.substr(0,o):i;let a=o!==-1?i.substr(o+1):void 0;a&&a.indexOf("?")!==-1&&(a=a.substr(0,a.indexOf("?")));const c=s.lastIndexOf("@"),l=s.substr(0,c),u=s.substr(c+1);let d=l,h="";const p=l.indexOf(":");p!==-1&&(d=l.substr(0,p),h=l.substr(p+1));const[f,m]=u.split(":");return{type:n,host:f,username:decodeURIComponent(d),password:decodeURIComponent(h),port:m?parseInt(m):void 0,database:a||void 0}}static parseMongoDBConnectionUrl(e){const n=e.split(":")[0],r=e.indexOf("//"),i=e.substr(r+2),o=i.indexOf("/"),s=o!==-1?i.substr(0,o):i;let a=o!==-1?i.substr(o+1):void 0,c="",l,u,d,h,p={};if(a&&a.indexOf("?")!==-1){c=a.substr(a.indexOf("?")+1,a.length);const C=c.split("&");let $,O;C.forEach(E=>{$=E.split("=")[0],O=E.split("=")[1],p[$]=O}),h=p.replicaSet,a=a.substr(0,a.indexOf("?"))}const f=s.lastIndexOf("@"),m=s.substr(0,f),y=s.substr(f+1);let g=m,w="";const v=m.indexOf(":");v!==-1&&(g=m.substr(0,v),w=m.substr(v+1)),h?d=y:[l,u]=y.split(":");let x={type:n,host:l,hostReplicaSet:d,username:decodeURIComponent(g),password:decodeURIComponent(w),port:u?parseInt(u):void 0,database:a||void 0};for(const[C,$]of Object.entries(p))x[C]=$;return x}}class Ql{constructor(e,n,r){this.connection=e,this.queryExpressionMap=n,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,r&&Ce.assign(this,r)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(const n of this.queryExpressionMap.selects)if(n.selection===this.alias.name||this.metadata&&this.metadata.columns.find(r=>n.selection===this.alias.name+"."+r.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(He.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(He.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!He.isAliasProperty(this.entityOrProperty))return;const n=this.queryExpressionMap.findAliasByName(this.parentAlias);let r=n.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(r||n.metadata.parentEntityMetadata&&(r=n.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),r))return r;throw new X(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new X("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new X("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?Q.buildAlias(this.connection.driver,void 0,e,this.alias.name):Q.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class co{constructor(e,n){this.queryExpressionMap=e,this.disableMixedMap=!1,Ce.assign(this,n||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!He.isAliasProperty(this.relationName))throw new X("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!He.isAliasProperty(this.relationName))throw new X("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!He.isAliasProperty(this.relationName))throw new X("Given value must be a string representation of alias property");const e=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new X(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return e}get junctionAlias(){const[e,n]=this.relationName.split(".");return e+"_"+n+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class lo{constructor(e,n){this.expressionMap=e,Ce.assign(this,n||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!He.isAliasProperty(this.relationName))throw new X("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!He.isAliasProperty(this.relationName))throw new X("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,n]=this.relationName.split(".");return e+"_"+n+"_rc"}get relation(){if(!He.isAliasProperty(this.relationName))throw new X("Given value is a string representation of alias property");const[e,n]=this.relationName.split("."),r=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(n);if(!r)throw new X(`Relation with property path ${n} in entity was not found.`);return r}get metadata(){if(!He.isAliasProperty(this.relationName))throw new X("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class uo{constructor(e){var n;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((n=e.options)==null?void 0:n.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((n,r)=>(n[this.mainAlias.name+"."+r]=e[r],n),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let n=e.name;!n&&e.tablePath&&(n=e.tablePath),!n&&typeof e.target=="function"&&(n=e.target.name),!n&&typeof e.target=="string"&&(n=e.target);const r=new kl;return r.type=e.type,n&&(r.name=n),e.metadata&&(r.metadata=e.metadata),e.target&&!r.hasMetadata&&(r.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(r.tablePath=e.tablePath),e.subQuery&&(r.subQuery=e.subQuery),this.aliases.push(r),r}findAliasByName(e){const n=this.aliases.find(r=>r.name===e);if(!n)throw new X(`"${e}" alias was not found. Maybe you forgot to join it?`);return n}findColumnByAliasExpression(e){const[n,r]=e.split(".");return this.findAliasByName(n).metadata.findColumnWithPropertyName(r)}get relationMetadata(){if(!this.mainAlias)throw new X("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new X(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new uo(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(n=>n),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(n=>e.aliases.push(new kl(n))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(n=>new Ql(this.connection,this,n)),e.relationIdAttributes=this.relationIdAttributes.map(n=>new co(this,n)),e.relationCountAttributes=this.relationCountAttributes.map(n=>new lo(this,n)),e.wheres=this.wheres.map(n=>({...n})),e.havings=this.havings.map(n=>({...n})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(n=>n),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(n=>({alias:n.alias,queryBuilder:typeof n.queryBuilder=="string"?n.queryBuilder:n.queryBuilder.clone(),options:n.options})),e}}class Yl{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class ho{static transformFrom(e,n){return Array.isArray(e)?e.slice().reverse().reduce((r,i)=>i.from(r),n):e.from(n)}static transformTo(e,n){return Array.isArray(e)?e.reduce((r,i)=>i.to(r),n):e.to(n)}}class kn{constructor(e,n,r=!0,i=!1,o,s){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=n,this._useParameter=r,this._multipleParameters=i,this._getSql=o,this._objectLiteralParameters=s}get useParameter(){return fe.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return fe.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return fe.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return fe.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(fe.isFindOperator(this._value))return this._value}get getSql(){return fe.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof kn?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(n=>e&&ho.transformTo(e,n)):ho.transformTo(e,this._value)}}ct=function(t){return new kn("in",t,!0,!0)};const lw=/[.*+\-?^${}()|[\]\\]/g,uw=t=>t.replace(lw,"\\$&");class be{constructor(e,n){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,fe.isDataSource(e)?(this.connection=e,this.queryRunner=n,this.expressionMap=new uo(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,n){be.queryBuilderRegistry[e]=n}get alias(){if(!this.expressionMap.mainAlias)throw new X("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,n){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(r=>({selection:r})):e&&(this.expressionMap.selects=[{selection:e,aliasName:n}]),fe.isSelectQueryBuilder(this)?this:be.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",fe.isInsertQueryBuilder(this)?this:be.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,n){const r=n||e;if(e=fe.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const i=this.createFromAlias(e);this.expressionMap.setMainAlias(i)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=r,fe.isUpdateQueryBuilder(this)?this:be.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",fe.isDeleteQueryBuilder(this)?this:be.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",fe.isSoftDeleteQueryBuilder(this)?this:be.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",fe.isSoftDeleteQueryBuilder(this)?this:be.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,n){const r=arguments.length===2?e:void 0,i=arguments.length===2?n:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=i,r){const o=this.createFromAlias(r);this.expressionMap.setMainAlias(o)}return fe.isRelationQueryBuilder(this)?this:be.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,n){const r=this.connection.getMetadata(e);return(Array.isArray(n)?n:[n]).every(i=>!!r.findRelationWithPropertyPath(i))}hasParameter(e){var n;return((n=this.parentQueryBuilder)==null?void 0:n.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,n){if(typeof n=="function")throw new X(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new X("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,n),this.expressionMap.parameters[e]=n,this}setParameters(e){for(const[n,r]of Object.entries(e))this.setParameter(n,r);return this}createParameter(e){let n;do n=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(n));return this.setParameter(n,e),`:${n}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(n=>{this.expressionMap.nativeParameters[n]=e[n]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const n=this.expressionMap.mainAlias.metadata;if(n.discriminatorColumn&&n.parentEntityMetadata){const r=n.childEntityMetadatas.filter(i=>i.discriminatorColumn).map(i=>i.discriminatorValue);r.push(n.discriminatorValue),e.discriminatorColumnValues=r}}return e}printSql(){const[e,n]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,n),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),n=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,n,this.expressionMap.nativeParameters)}async execute(){const[e,n]=this.getQueryAndParameters(),r=this.obtainQueryRunner();try{return await r.query(e,n)}finally{r!==this.queryRunner&&await r.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,n,r){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:n,options:r||{}}),this}getTableName(e){return e.split(".").map(n=>n===""?n:this.escape(n)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new X('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,n){if(this.connection.hasMetadata(e)){const r=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:n,metadata:this.connection.getMetadata(e),tablePath:r.tablePath})}else{if(typeof e=="string"){const o=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:n,tablePath:o?void 0:e,subQuery:o?e:void 0})}const r=e(this.subQuery());this.setParameters(r.getParameters());const i=r.getQuery();return this.expressionMap.createAlias({type:"from",name:n,subQuery:i})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const n={};for(const o of this.expressionMap.aliases){if(!o.hasMetadata)continue;const s=this.expressionMap.aliasNamePrefixingEnabled&&o.name?`${o.name}.`:"";n[s]||(n[s]={});for(const a of o.metadata.relations)a.joinColumns.length>0&&(n[s][a.propertyPath]=a.joinColumns[0].databaseName);for(const a of o.metadata.relations){const c=[...a.joinColumns,...a.inverseJoinColumns];for(const l of c){const u=`${a.propertyPath}.${l.referencedColumn.propertyPath}`;n[s][u]=l.databaseName}}for(const a of o.metadata.columns)n[s][a.databaseName]=a.databaseName;for(const a of o.metadata.columns)n[s][a.propertyName]=a.databaseName;for(const a of o.metadata.columns)n[s][a.propertyPath]=a.databaseName}const r=Object.keys(n),i=r.map(o=>uw(o)).join("|");return r.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${i?"("+i+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...o)=>{let s,a,c;if(i){if(s=o[0],a=o[1],c=o[3],n[o[2]][c])return`${a}${this.escape(o[2].substring(0,o[2].length-1))}.${this.escape(n[o[2]][c])}`}else if(s=o[0],a=o[1],c=o[2],n[""][c])return`${a}${this.escape(n[""][c])}`;return s})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],n=this.createWhereClausesExpression(this.expressionMap.wheres);if(n.length>0&&n!=="1=1"&&e.push(this.replacePropertyNames(n)),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const o=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName,s=`${this.replacePropertyNames(o)} IS NULL`;e.push(s)}if(i.discriminatorColumn&&i.parentEntityMetadata){const o=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName,s=`${this.replacePropertyNames(o)} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(i)}let r="";return r+=this.createTimeTravelQuery(),e.length?e.length===1?r+=` WHERE ${e[0]}`:r+=` WHERE ( ${e.join(" ) AND ( ")} )`:r+="",r}createReturningExpression(e){const n=this.getReturningColumns(),r=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&r.isReturningSqlSupported(e)&&n.push(...this.expressionMap.extraReturningColumns.filter(i=>n.indexOf(i)===-1)),n.length){let i=n.map(o=>{const s=this.escape(o.databaseName);return r.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+s:this.escape(this.getMainTableName())+"."+s:s}).join(", ");return r.options.type==="oracle"&&(i+=" INTO "+n.map(o=>this.createParameter({type:r.columnTypeToNativeParameter(o.type),dir:r.oracle.BIND_OUT})).join(", ")),r.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(i+=" INTO @OutputTable"),i}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(n=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(n))}),e}createWhereClausesExpression(e){return e.map((n,r)=>{const i=this.createWhereConditionExpression(n.condition);switch(n.type){case"and":return(r>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(r>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`}return i}).join(" ").trim()}createWhereConditionExpression(e,n=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!n?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:r}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return r.options.type==="postgres"||r.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return r.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${kn.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(n=>{const r=typeof n.queryBuilder=="string"?n.queryBuilder:n.queryBuilder.getQuery();if(typeof n.queryBuilder!="string"){if(n.queryBuilder.hasCommonTableExpressions())throw new X(`Nested CTEs aren't supported (CTE: ${n.alias})`);if(!this.connection.driver.cteCapabilities.writable&&!fe.isSelectQueryBuilder(n.queryBuilder))throw new X(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${n.alias})`);this.setParameters(n.queryBuilder.getParameters())}let i=this.escape(n.alias);if(n.options.columnNames){const a=n.options.columnNames.map(c=>this.escape(c));if(fe.isSelectQueryBuilder(n.queryBuilder)&&n.queryBuilder.expressionMap.selects.length&&n.options.columnNames.length!==n.queryBuilder.expressionMap.selects.length)throw new X(`cte.options.columnNames length (${n.options.columnNames.length}) doesn't match subquery select list length ${n.queryBuilder.expressionMap.selects.length} (CTE: ${n.alias})`);i+=`(${a.join(", ")})`}const o=n.options.recursive&&e?"RECURSIVE":"";let s="";return this.connection.driver.cteCapabilities.materializedHint&&n.options.materialized!==void 0&&(s=n.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[o,i,"AS",s,`(${r})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const n=this.expressionMap.mainAlias.metadata,r=(Array.isArray(e)?e:[e]).map(i=>n.ensureEntityIdMap(i));if(!n.hasMultiplePrimaryKeys){const i=n.primaryColumns[0];if(!i.transformer&&!i.relationMetadata&&!i.embeddedMetadata)return{[i.propertyName]:ct(r.map(o=>i.getEntityValue(o,!1)))}}return new Yl(i=>{for(const o of r)i.orWhere(new Yl(s=>s.where(o)))})}getExistsCondition(e){const n=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${n.getQuery()})`,n.getParameters()]}findColumnsForPropertyPath(e){let n=this.expressionMap.mainAlias;const r=[],i=e.split(".");for(;i.length>1;){const a=i[0];if(!(n!=null&&n.hasMetadata))break;if(n.metadata.hasEmbeddedWithPropertyPath(a)){i.unshift(`${i.shift()}.${i.shift()}`);continue}if(n.metadata.hasRelationWithPropertyPath(a)){const c=this.expressionMap.joinAttributes.find(l=>l.relationPropertyPath===a);if(!(c!=null&&c.alias)){const l=r.length>0?`${r.join(".")}.${a}`:a;throw new Error(`Cannot find alias for relation at ${l}`)}n=c.alias,r.push(...a.split(".")),i.shift();continue}break}if(!n)throw new Error(`Cannot find alias for property ${e}`);const o=i.join("."),s=n.metadata.findColumnsWithPropertyPath(o);if(!s.length)throw new We(e,n.metadata);return[n,r,s]}createPropertyPath(e,n,r=""){const i=[];for(const o of Object.keys(n)){const s=r?`${r}.${o}`:o;if(n[o]===null||typeof n[o]!="object"||fe.isFindOperator(n[o])){i.push(s);continue}if(e.hasEmbeddedWithPropertyPath(s)){const a=this.createPropertyPath(e,n[o],s);i.push(...a);continue}if(e.hasRelationWithPropertyPath(s)){const a=e.findRelationWithPropertyPath(s);if(a.relationType==="one-to-one"||a.relationType==="many-to-one"){const u=a.joinColumns.map(d=>d.referencedColumn).filter(d=>!!d);if(u.length>0&&u.every(d=>d.getEntityValue(n[o],!1))){i.push(s);continue}}if(a.relationType==="one-to-many"||a.relationType==="many-to-many")throw new Error(`Cannot query across ${a.relationType} for property ${s}`);const c=a.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(u=>u.getEntityValue(n[o],!1))){const u=c.map(d=>`${s}.${d.propertyPath}`);i.push(...u);continue}const l=this.createPropertyPath(a.inverseEntityMetadata,n[o]).map(u=>`${s}.${u}`);i.push(...l);continue}i.push(s)}return i}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const n=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const r of n){const[i,o,s]=this.findColumnsForPropertyPath(r);for(const a of s){let c=e;for(const d of o){if(!c||!(d in c)){c={};break}c=c[d]}const l=this.expressionMap.aliasNamePrefixingEnabled?`${i.name}.${a.propertyPath}`:a.propertyPath,u=a.getEntityValue(c,!0);yield[l,u]}}}else for(const n of Object.keys(e)){const r=e[n];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${n}`:n,r]}}getWherePredicateCondition(e,n){if(fe.isFindOperator(n)){let r=[];if(n.useParameter)if(n.objectLiteralParameters)this.setParameters(n.objectLiteralParameters);else if(n.multipleParameters)for(const i of n.value)r.push(this.createParameter(i));else r.push(this.createParameter(n.value));if(n.type==="raw")return n.getSql?n.getSql(e):{operator:"equal",parameters:[e,n.value]};if(n.type==="not")return n.child?{operator:n.type,condition:this.getWherePredicateCondition(e,n.child)}:{operator:"notEqual",parameters:[e,...r]};if(n.type==="and"){const i=n.value;return{operator:n.type,parameters:i.map(o=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,o)))}}else if(n.type==="or"){const i=n.value;return{operator:n.type,parameters:i.map(o=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,o)))}}else return{operator:n.type,parameters:[e,...r]}}else return{operator:"equal",parameters:[e,this.createParameter(n)]}}getWhereCondition(e){if(typeof e=="string")return e;if(fe.isBrackets(e)){const i=this.createQueryBuilder();return i.parentQueryBuilder=this,i.expressionMap.mainAlias=this.expressionMap.mainAlias,i.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,i.expressionMap.parameters=this.expressionMap.parameters,i.expressionMap.nativeParameters=this.expressionMap.nativeParameters,i.expressionMap.wheres=[],e.whereFactory(i),{operator:fe.isNotBrackets(e)?"not":"brackets",condition:i.expressionMap.wheres}}if(typeof e=="function")return e(this);const n=Array.isArray(e)?e:[e],r=[];for(const i of n){const o=[];for(const[s,a]of this.getPredicates(i))o.push({type:"and",condition:this.getWherePredicateCondition(s,a)});r.push({type:"or",condition:o})}return r.length===1?r[0].condition:r}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}be.queryBuilderRegistry={};class dw{static from(e){const n=new this;return n.raw=e.records,n.affected=e.affected,n}}class hw extends be{constructor(e,n){super(e,n),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,n]=this.getQueryAndParameters(),r=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),i=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const o=await r.query(e,n,!0),s=dw.from(o);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),i&&await r.commitTransaction(),s}catch(o){if(i)try{await r.rollbackTransaction()}catch{}throw o}finally{r!==this.queryRunner&&await r.release()}}from(e,n){e=fe.isEntitySchema(e)?e.options.name:e;const r=this.createFromAlias(e,n);return this.expressionMap.setMainAlias(r),this}where(e,n){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),n&&this.setParameters(n),this}andWhere(e,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}orWhere(e,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new Ir;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),n=this.createWhereExpression(),r=this.createReturningExpression("delete");return r===""?`DELETE FROM ${e}${n}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${r}${n}`:`DELETE FROM ${e}${n} RETURNING ${r}`}}let Dr;const pw=new Uint8Array(16);function fw(){if(!Dr&&(Dr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Dr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Dr(pw)}const Ae=[];for(let t=0;t<256;++t)Ae.push((t+256).toString(16).slice(1));function mw(t,e=0){return Ae[t[e+0]]+Ae[t[e+1]]+Ae[t[e+2]]+Ae[t[e+3]]+"-"+Ae[t[e+4]]+Ae[t[e+5]]+"-"+Ae[t[e+6]]+Ae[t[e+7]]+"-"+Ae[t[e+8]]+Ae[t[e+9]]+"-"+Ae[t[e+10]]+Ae[t[e+11]]+Ae[t[e+12]]+Ae[t[e+13]]+Ae[t[e+14]]+Ae[t[e+15]]}const yw=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Xl={randomUUID:yw};function gw(t,e,n){if(Xl.randomUUID&&!e&&!t)return Xl.randomUUID();t=t||{};const r=t.random||(t.rng||fw)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,mw(r)}class Zl{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class Gl{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const n=new this;return n.raw=e.raw,n}}class po{constructor(e,n){this.queryRunner=e,this.expressionMap=n}async update(e,n){const r=this.expressionMap.mainAlias.metadata;await Promise.all(n.map(async(i,o)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,l,u)=>(c[this.expressionMap.extraReturningColumns[u].databaseName]=l[0],c),{}));const s=Array.isArray(e.raw)?e.raw[o]:e.raw,a=this.queryRunner.connection.driver.createGeneratedMap(r,s);a&&(this.queryRunner.manager.merge(r.target,i,a),e.generatedMaps.push(a))}else{const s=this.expressionMap.extraReturningColumns;if(s.length>0){const a=this.expressionMap.mainAlias.metadata.getEntityIdMap(i);if(!a)throw new X("Cannot update entity because entity id is not set in the entity.");const c=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(l=>r.targetName+"."+l.propertyPath)).addSelect(s.map(l=>r.targetName+"."+l.propertyPath)).from(r.target,r.targetName).where(a).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(r.target,i,c),e.generatedMaps.push(c))}}}))}async insert(e,n){const r=this.expressionMap.mainAlias.metadata;let i=r.getInsertionReturningColumns();const o=this.queryRunner.connection.driver.isReturningSqlSupported("insert");i=i.filter(a=>a.isGenerated?o===!0:!0);const s=n.map((a,c)=>{this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((d,h,p)=>(d[this.expressionMap.extraReturningColumns[p].databaseName]=h[0],d),{}));const l=Array.isArray(e.raw)?e.raw[c]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(r,l,c,n.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(r.target,u,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(r.target,a,u),u});if(i.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const a=n.map(l=>{const u=r.getEntityIdMap(l);if(!u)throw new X("Cannot update entity because entity id is not set in the entity.");return u}),c=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(l=>r.targetName+"."+l.propertyPath)).addSelect(i.map(l=>r.targetName+"."+l.propertyPath)).from(r.target,r.targetName).where(a).setOption("create-pojo").getMany();n.forEach((l,u)=>{this.queryRunner.manager.merge(r.target,s[u],c[u]),this.queryRunner.manager.merge(r.target,l,c[u])})}n.forEach((a,c)=>{const l=r.getEntityIdMap(a);e.identifiers.push(l),e.generatedMaps.push(s[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class xw extends be{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new Gl;const n=this.obtainQueryRunner();let r=!1;try{if(this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),r=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const p=new Zl;e.forEach(f=>{n.broadcaster.broadcastBeforeInsertEvent(p,this.expressionMap.mainAlias.metadata,f)}),await p.wait()}let i=null,o=null;const s=new po(n,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const p of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(p));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),a.push(...this.expressionMap.extraReturningColumns.filter(p=>!a.includes(p)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(i=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),o="SELECT * FROM @OutputTable");const[c,l]=this.getQueryAndParameters(),u=[i,c,o].filter(p=>p!=null).join(`;

`),d=await n.query(u,l,!0),h=Gl.from(d);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.insert(h,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const p=new Zl;e.forEach(f=>{n.broadcaster.broadcastAfterInsertEvent(p,this.expressionMap.mainAlias.metadata,f)}),await p.wait()}return r&&await n.commitTransaction(),h}catch(i){if(r)try{await n.rollbackTransaction()}catch{}throw i}finally{n!==this.queryRunner&&await n.release()}}into(e,n){e=fe.isEntitySchema(e)?e.options.name:e;const r=this.createFromAlias(e);return this.expressionMap.setMainAlias(r),this.expressionMap.insertColumns=n||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new Ir;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,n,r){return Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:n,skipUpdateIfNoValuesChanged:r==null?void 0:r.skipUpdateIfNoValuesChanged,indexPredicate:r==null?void 0:r.indexPredicate,upsertType:r==null?void 0:r.upsertType},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:r==null?void 0:r.skipUpdateIfNoValuesChanged,upsertType:r==null?void 0:r.upsertType},this)}createInsertExpression(){var s,a;const e=this.getTableName(this.getMainTableName()),n=this.createValuesExpression(),r=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression();let o="INSERT ";if(((s=this.expressionMap.onUpdate)==null?void 0:s.upsertType)==="primary-key"&&(o="UPSERT "),(Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(o+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),o+=`INTO ${e}`,this.alias!==this.getMainTableName()&&Q.isPostgresFamily(this.connection.driver)&&(o+=` AS "${this.alias}"`),i?o+=`(${i})`:!n&&(Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(o+="()"),r&&this.connection.driver.options.type==="mssql"&&(o+=` OUTPUT ${r}`),n?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?o+=` ${n}`:o+=` VALUES ${n}`:Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?o+=" VALUES ()":o+=" DEFAULT VALUES",((a=this.expressionMap.onUpdate)==null?void 0:a.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)o+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)o+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:c,columns:l,conflict:u,skipUpdateIfNoValuesChanged:d,indexPredicate:h}=this.expressionMap.onUpdate;let p="ON CONFLICT";if(Array.isArray(u)){if(p+=` ( ${u.map(m=>this.escape(m)).join(", ")} )`,h&&!Q.isPostgresFamily(this.connection.driver))throw new X("indexPredicate option is not supported by the current database driver");h&&Q.isPostgresFamily(this.connection.driver)&&(p+=` WHERE ( ${h} )`)}else u&&(p+=` ON CONSTRAINT ${this.escape(u)}`);const f=[];Array.isArray(c)?f.push(...c.map(m=>`${this.escape(m)} = EXCLUDED.${this.escape(m)}`)):l&&f.push(...l.map(m=>`${this.escape(m)} = :${m}`)),f.length>0&&(o+=` ${p} DO UPDATE SET `,f.push(...this.expressionMap.mainAlias.metadata.columns.filter(m=>m.isUpdateDate&&!(c!=null&&c.includes(m.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||Q.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(m=>`${this.escape(m.databaseName)} = DEFAULT`)),o+=f.join(", "),o+=" "),Array.isArray(c)&&d&&Q.isPostgresFamily(this.connection.driver)&&(o+=" WHERE (",o+=c.map(m=>`${e}.${this.escape(m)} IS DISTINCT FROM EXCLUDED.${this.escape(m)}`).join(" OR "),o+=") ")}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:c,columns:l}=this.expressionMap.onUpdate;Array.isArray(c)?(o+=" ON DUPLICATE KEY UPDATE ",o+=c.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),o+=" "):Array.isArray(l)&&(o+=" ON DUPLICATE KEY UPDATE ",o+=l.map(u=>`${this.escape(u)} = :${u}`).join(", "),o+=" ")}}else if(this.expressionMap.onUpdate)throw new X("onUpdate is not supported by the current database driver")}return r&&(Q.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||Q.isMySQLFamily(this.connection.driver))&&(o+=` RETURNING ${r}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(c=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(c.propertyPath)!==-1:c.isInsert).some(c=>this.isOverridingAutoIncrementBehavior(c))&&(o=`SET IDENTITY_INSERT ${e} ON; ${o}; SET IDENTITY_INSERT ${e} OFF`),o}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!Q.isSQLiteFamily(this.connection.driver)&&!Q.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(n=>this.escape(n.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const n=this.getValueSets();if(n.length===1)return Object.keys(n[0]).map(r=>this.escape(r)).join(", ")}return this.expressionMap.insertColumns.map(n=>this.escape(n)).join(", ")}createValuesExpression(){const e=this.getValueSets(),n=this.getInsertedColumns();if(n.length>0){let r="";return e.forEach((i,o)=>{n.forEach((s,a)=>{a===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?r+=" SELECT ":r+="(");let c=s.getEntityValue(i);if(typeof c!="function"&&(c=this.connection.driver.preparePersistentValue(c,s)),s.isVersion&&c===void 0)r+="1";else if(s.isDiscriminator)r+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(s.isGenerated&&s.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&c===void 0)c=gw(),r+=this.createParameter(c),o in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[o]={}),s.setEntityValue(this.expressionMap.locallyGenerated[o],c);else if(c===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||Q.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?s.default!==void 0&&s.default!==null?r+=this.connection.driver.normalizeDefault(s):r+="NULL":r+="DEFAULT";else if(c===null&&this.connection.driver.options.type==="spanner")r+="NULL";else if(typeof c=="function")r+=c();else{this.connection.driver.options.type==="mssql"&&(c=this.connection.driver.parametrizeValue(s,c));const l=this.createParameter(c);if((Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(s.type)!==-1){const u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";s.srid!=null?r+=`${u}(${l}, ${s.srid})`:r+=`${u}(${l})`}else Q.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(s.type)!==-1?s.srid!=null?r+=`ST_SetSRID(ST_GeomFromGeoJSON(${l}), ${s.srid})::${s.type}`:r+=`ST_GeomFromGeoJSON(${l})::${s.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(s.type)!==-1?r+=s.type+"::STGeomFromText("+l+", "+(s.srid||"0")+")":r+=l}a===n.length-1?o===e.length-1?this.connection.driver.options.type==="oracle"&&e.length>1?r+=" FROM DUAL ":this.connection.driver.options.type==="sap"&&e.length>1?r+=" FROM dummy ":r+=")":this.connection.driver.options.type==="oracle"&&e.length>1?r+=" FROM DUAL UNION ALL ":this.connection.driver.options.type==="sap"&&e.length>1?r+=" FROM dummy UNION ALL ":r+="), ":r+=", "})}),r==="()"?"":r}else{let r="";return e.forEach((i,o)=>{Object.keys(i).forEach((s,a)=>{a===0&&(r+="(");const c=i[s];typeof c=="function"?r+=c():c===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||Q.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r+="NULL":r+="DEFAULT":c===null&&this.connection.driver.options.type==="spanner"||(r+=this.createParameter(c)),a===Object.keys(i).length-1?o===e.length-1?r+=")":r+="), ":r+=", "})}),r==="()"?"":r}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(Ce.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new cv}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(n=>e.getEntityValue(n)!==void 0&&e.getEntityValue(n)!==null)}}class Kl{constructor(e,n){this.queryBuilder=e,this.expressionMap=n}async update(e){const n=this.expressionMap.relationMetadata;if(n.isManyToOne||n.isOneToOneOwner){const r=n.joinColumns.reduce((i,o)=>{const s=Ce.isObject(e)?o.referencedColumn.getEntityValue(e):e;return o.setEntityValue(i,s),i},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(n.entityMetadata.target).set(r).whereInIds(this.expressionMap.of).execute()}else if((n.isOneToOneNotOwner||n.isOneToMany)&&e===null){const r={};n.inverseRelation.joinColumns.forEach(c=>{r[c.propertyName]=null});const i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],o={},s=[];i.forEach((c,l)=>{n.inverseRelation.joinColumns.map((u,d)=>{const h="joinColumn_"+l+"_"+d;o[h]=Ce.isObject(c)?u.referencedColumn.getEntityValue(c):c,s.push(`${u.propertyPath} = :${h}`)})});const a=s.map(c=>"("+c+")").join(" OR ");if(!a)return;await this.queryBuilder.createQueryBuilder().update(n.inverseEntityMetadata.target).set(r).where(a).setParameters(o).execute()}else if(n.isOneToOneNotOwner||n.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new X("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const r=this.expressionMap.of,i=n.inverseRelation.joinColumns.reduce((o,s)=>{const a=Ce.isObject(r)?s.referencedColumn.getEntityValue(r):r;return s.setEntityValue(o,a),o},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(n.inverseEntityMetadata.target).set(i).whereInIds(e).execute()}else{const r=n.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],o=Array.isArray(e)?e:[e],s=n.isManyToManyOwner?i:o,a=n.isManyToManyOwner?o:i,c=[];if(s.forEach(l=>{a.forEach(u=>{const d={};r.ownerColumns.forEach(h=>{d[h.databaseName]=Ce.isObject(l)?h.referencedColumn.getEntityValue(l):l}),r.inverseColumns.forEach(h=>{d[h.databaseName]=Ce.isObject(u)?h.referencedColumn.getEntityValue(u):u}),c.push(d)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(l=>this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(l).execute())):await this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(c).execute()}}}class bw{constructor(e,n){this.queryBuilder=e,this.expressionMap=n}async remove(e){const n=this.expressionMap.relationMetadata;if(n.isOneToMany){const r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],o={};n.inverseRelation.joinColumns.forEach(l=>{o[l.propertyName]=null});const s={},a=[];r.forEach((l,u)=>{a.push(...i.map((d,h)=>[...n.inverseRelation.joinColumns.map((p,f)=>{const m="joinColumn_"+u+"_"+h+"_"+f;return s[m]=Ce.isObject(l)?p.referencedColumn.getEntityValue(l):l,`${p.propertyPath} = :${m}`}),...n.inverseRelation.entityMetadata.primaryColumns.map((p,f)=>{const m="primaryColumn_"+h+"_"+h+"_"+f;return s[m]=Ce.isObject(d)?p.getEntityValue(d):d,`${p.propertyPath} = :${m}`})].join(" AND ")))});const c=a.map(l=>"("+l+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(n.inverseEntityMetadata.target).set(o).where(c).setParameters(s).execute()}else{const r=n.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],o=Array.isArray(e)?e:[e],s=n.isManyToManyOwner?i:o,a=n.isManyToManyOwner?o:i,c={},l=[];s.forEach((d,h)=>{l.push(...a.map((p,f)=>[...r.ownerColumns.map((m,y)=>{const g="firstValue_"+h+"_"+f+"_"+y;return c[g]=Ce.isObject(d)?m.referencedColumn.getEntityValue(d):d,`${m.databaseName} = :${g}`}),...r.inverseColumns.map((m,y)=>{const g="secondValue_"+h+"_"+f+"_"+y;return c[g]=Ce.isObject(p)?m.referencedColumn.getEntityValue(p):p,`${m.databaseName} = :${g}`})].join(" AND ")))});const u=l.map(d=>"("+d+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(r.tableName).where(u).setParameters(c).execute()}}}class vw extends be{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const n=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new X("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(n.isManyToMany||n.isOneToMany)throw new X(`Set operation is only supported for many-to-one and one-to-one relations. However given "${n.propertyPath}" has ${n.relationType} relation. Use .add() method instead.`);if(n.joinColumns&&n.joinColumns.length>1&&(!Ce.isObject(e)||Object.keys(e).length<n.joinColumns.length))throw new X('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Kl(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const n=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new X("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(n.isManyToOne||n.isOneToOne)throw new X(`Add operation is only supported for many-to-many and one-to-many relations. However given "${n.propertyPath}" has ${n.relationType} relation. Use .set() method instead.`);if(n.joinColumns&&n.joinColumns.length>1&&(!Ce.isObject(e)||Object.keys(e).length<n.joinColumns.length))throw new X('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Kl(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const n=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new X("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(n.isManyToOne||n.isOneToOne)throw new X(`Add operation is only supported for many-to-many and one-to-many relations. However given "${n.propertyPath}" has ${n.relationType} relation. Use .set(null) method instead.`);return new bw(this,this.expressionMap).remove(e)}async addAndRemove(e,n){await this.remove(n),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!Ce.isObject(e)){const n=this.expressionMap.mainAlias.metadata;if(n.hasMultiplePrimaryKeys)throw new X("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=n.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class Ne{static chunk(e,n){return Array.from(Array(Math.ceil(e.length/n)),(r,i)=>e.slice(i*n,i*n+n))}static splitClassesAndStrings(e){return[e.filter(n=>typeof n!="string"),e.filter(n=>typeof n=="string")]}static groupBy(e,n){return e.reduce((r,i)=>{const o=n(i);let s=r.find(a=>a.id===o);return s||(s={id:o,items:[]},r.push(s)),s.items.push(i),r},[])}static uniq(e,n){return e.reduce((r,i)=>{let o=!1;if(typeof n=="function"){const s=n(i);o=!!r.find(a=>n(a)===s)}else typeof n=="string"?o=!!r.find(s=>s[n]===i[n]):o=r.indexOf(i)!==-1;return o||r.push(i),r},[])}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,n,r,i){if(i.has(r)){e[n]=i.get(r);return}if(!(r instanceof Promise)){if(!this.isPlainObject(r)&&!Array.isArray(r)){e[n]=r;return}e[n]||(e[n]=Array.isArray(r)?[]:{}),i.set(r,e[n]),this.merge(e[n],r,i),i.delete(r)}}static mergeObjectKey(e,n,r,i){if(i.has(r)){Object.assign(e,{[n]:i.get(r)});return}if(!(r instanceof Promise)){if(!this.isPlainObject(r)&&!Array.isArray(r)){Object.assign(e,{[n]:r});return}e[n]||Object.assign(e,{[n]:Array.isArray(r)?[]:{}}),i.set(r,e[n]),this.merge(e[n],r,i),i.delete(r)}}static merge(e,n,r=new Map){if(this.isPlainObject(e)&&this.isPlainObject(n))for(const i of Object.keys(n))i!=="__proto__"&&this.mergeObjectKey(e,i,n[i],r);if(Array.isArray(e)&&Array.isArray(n))for(let i=0;i<n.length;i++)this.mergeArrayKey(e,i,n[i],r)}static mergeDeep(e,...n){if(!n.length)return e;for(const r of n)Ne.merge(e,r);return e}static deepCompare(...e){let n,r,i,o;if(arguments.length<1)return!0;for(n=1,r=arguments.length;n<r;n++)if(i=[],o=[],!this.compare2Objects(i,o,arguments[0],arguments[n]))return!1;return!0}static deepValue(e,n){const r=n.split(".");for(let i=0,o=r.length;i<o;i++)e=e[r[i]];return e}static replaceEmptyObjectsWithBooleans(e){for(let n in e)e[n]&&typeof e[n]=="object"&&(Object.keys(e[n]).length===0?e[n]=!0:this.replaceEmptyObjectsWithBooleans(e[n]))}static propertyPathsToTruthyObject(e){let n={};for(let r of e){const i=r.split(".");if(!i.length)continue;(!n[i[0]]||n[i[0]]===!0)&&(n[i[0]]={});let o=n[i[0]];for(let[s,a]of i.entries())s!==0&&(o[a]?o=o[a]:s===i.length-1?(o[a]={},o=null):(o[a]={},o=o[a]))}return this.replaceEmptyObjectsWithBooleans(n),n}static compareIds(e,n){return e==null||n===void 0||n===null?!1:(typeof e.id=="string"&&typeof n.id=="string"||typeof e.id=="number"&&typeof n.id=="number")&&Object.keys(e).length===1&&Object.keys(n).length===1?e.id===n.id:Ne.deepCompare(e,n)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static zipObject(e,n){return e.reduce((r,i,o)=>(r[i]=n[o],r),{})}static isArraysEqual(e,n){return e.length!==n.length?!1:e.every(r=>n.indexOf(r)!==-1)}static areMutuallyExclusive(...e){return!e.some(n=>{const r=e.filter(i=>i!==n);return n.some(i=>r.some(o=>o.includes(i)))})}static parseSqlCheckExpression(e,n){const r=e.match(new RegExp(`"${n}" varchar CHECK\\s*\\(\\s*"${n}"\\s+IN\\s*`));if(r&&r.index){const i=e.substring(r.index+r[0].length);let o="",s="";const a=[];for(let c=0;c<i.length;c++){const l=i[c];switch(l){case",":o==""?(a.push(s),s=""):s+=l;break;case"'":o==l?i[c+1]===l?(s+=l,c+=1):o="":o=l;break;case")":if(o=="")return a.push(s),a;s+=l;break;default:o!=""&&(s+=l)}}}}static compare2Objects(e,n,r,i){let o;if(Number.isNaN(r)&&Number.isNaN(i)||r===i)return!0;if(r===null||i===null||r===void 0||i===void 0)return!1;if((typeof r.equals=="function"||typeof r.equals=="function")&&r.equals(i))return!0;if(typeof r=="function"&&typeof i=="function"||r instanceof Date&&i instanceof Date||r instanceof RegExp&&i instanceof RegExp||typeof r=="string"&&typeof i=="string"||typeof r=="number"&&typeof i=="number")return r.toString()===i.toString();if(!(typeof r=="object"&&typeof i=="object")||Object.prototype.isPrototypeOf.call(r,i)||Object.prototype.isPrototypeOf.call(i,r)||r.constructor!==i.constructor||r.prototype!==i.prototype||e.indexOf(r)>-1||n.indexOf(i)>-1)return!1;for(o in i)if(i.hasOwnProperty(o)!==r.hasOwnProperty(o)||typeof i[o]!=typeof r[o])return!1;for(o in r){if(i.hasOwnProperty(o)!==r.hasOwnProperty(o)||typeof i[o]!=typeof r[o])return!1;switch(typeof r[o]){case"object":case"function":if(e.push(r),n.push(i),!this.compare2Objects(e,n,r[o],i[o]))return!1;e.pop(),n.pop();break;default:if(r[o]!==i[o])return!1;break}}return!0}}class ww{constructor(e,n,r,i,o){this.expressionMap=e,this.driver=n,this.rawRelationIdResults=r,this.rawRelationCountResults=i,this.queryRunner=o}transform(e,n){const r=this.group(e,n),i=[];return r.forEach(o=>{const s=this.transformRawResultsGroup(o,n);s!==void 0&&!Object.values(s).every(a=>a===null)&&i.push(s)}),i}group(e,n){const r=new Map,i=[];return n.metadata.tableType==="view"?i.push(...n.metadata.columns.map(o=>Q.buildAlias(this.driver,void 0,n.name,o.databaseName))):i.push(...n.metadata.primaryColumns.map(o=>Q.buildAlias(this.driver,void 0,n.name,o.databaseName))),e.forEach(o=>{const s=i.map(c=>{const l=o[c];return jp.isBuffer(l)?l.toString("hex"):Ce.isObject(l)?JSON.stringify(l):l}).join("_"),a=r.get(s);a?a.push(o):r.set(s,[o])}),r}transformRawResultsGroup(e,n){let r=n.metadata;if(r.discriminatorColumn){const l=e.map(d=>d[Q.buildAlias(this.driver,void 0,n.name,n.metadata.discriminatorColumn.databaseName)]),u=r.childEntityMetadatas.find(d=>typeof l.find(h=>h===d.discriminatorValue)<"u");u&&(r=u)}let i=r.create(this.queryRunner,{fromDeserializer:!0,pojo:this.expressionMap.options.indexOf("create-pojo")!==-1});const o=this.transformColumns(e,n,i,r),s=this.transformJoins(e,i,n,r),a=this.transformRelationIds(e,n,i,r),c=this.transformRelationCounts(e,n,i);if(o||r.primaryColumns.filter(l=>l.isVirtual===!1).length===0&&(s||a||c))return i}transformColumns(e,n,r,i){let o=!1;return i.columns.forEach(s=>{if(i.childEntityMetadatas.length>0&&i.childEntityMetadatas.findIndex(c=>c.target===s.target)!==-1)return;const a=e[0][Q.buildAlias(this.driver,void 0,n.name,s.databaseName)];a===void 0||s.isVirtual||this.expressionMap.selects.find(c=>c.selection===n.name||c.selection===n.name+"."+s.propertyPath)&&(s.setEntityValue(r,this.driver.prepareHydratedValue(a,s)),a!==null&&(o=!0))}),o}transformJoins(e,n,r,i){let o=!1;return this.expressionMap.joinAttributes.forEach(s=>{if(!s.metadata||!s.isSelected||s.relation&&!i.relations.find(c=>c===s.relation))return;if(s.mapToProperty){if(s.mapToPropertyParentAlias!==r.name)return}else if(!s.relation||s.parentAlias!==r.name||s.relationPropertyPath!==s.relation.propertyPath)return;let a=this.transform(e,s.alias);a=s.isMany?a:a[0],a=!s.isMany&&a===void 0?null:a,a!==void 0&&(s.mapToPropertyPropertyName?n[s.mapToPropertyPropertyName]=a:s.relation.setEntityValue(n,a),o=!0)}),o}transformRelationIds(e,n,r,i){let o=!1;return this.rawRelationIdResults.forEach((s,a)=>{if(s.relationIdAttribute.parentAlias!==n.name)return;const c=s.relationIdAttribute.relation,l=this.createValueMapFromJoinColumns(c,s.relationIdAttribute.parentAlias,e);if(l==null)return;this.prepareDataForTransformRelationIds();const u=this.hashEntityIds(c,l),d=this.relationIdMaps[a][u]||[],h=s.relationIdAttribute.mapToPropertyPropertyPath.split("."),p=(f,m,y)=>{const g=f.shift();if(g&&f.length===0)return m[g]=y,m;if(g&&f.length>0)p(f,m[g],y);else return m};c.isOneToOne||c.isManyToOne?d[0]!==void 0&&(p(h,r,d[0]),o=!0):(p(h,r,d),o=o||d.length>0)}),o}transformRelationCounts(e,n,r){let i=!1;return this.rawRelationCountResults.filter(o=>o.relationCountAttribute.parentAlias===n.name).forEach(o=>{const s=o.relationCountAttribute.relation;let a;s.isOneToMany?a=s.inverseRelation.joinColumns[0].referencedColumn.databaseName:a=s.isOwning?s.joinColumns[0].referencedColumn.databaseName:s.inverseRelation.joinColumns[0].referencedColumn.databaseName;const c=e[0][Q.buildAlias(this.driver,void 0,n.name,a)];c!=null&&(r[o.relationCountAttribute.mapToPropertyPropertyName]=0,o.results.filter(l=>l.parentId===c).forEach(l=>{r[o.relationCountAttribute.mapToPropertyPropertyName]=parseInt(l.cnt),i=!0}))}),i}createValueMapFromJoinColumns(e,n,r){let i;return e.isManyToOne||e.isOneToOneOwner?i=e.entityMetadata.primaryColumns.map(o=>o):e.isOneToMany||e.isOneToOneNotOwner?i=e.inverseRelation.joinColumns.map(o=>o):e.isOwning?i=e.joinColumns.map(o=>o):i=e.inverseRelation.inverseJoinColumns.map(o=>o),i.reduce((o,s)=>(r.forEach(a=>{e.isManyToOne||e.isOneToOneOwner?o[s.databaseName]=this.driver.prepareHydratedValue(a[Q.buildAlias(this.driver,void 0,n,s.databaseName)],s):o[s.databaseName]=this.driver.prepareHydratedValue(a[Q.buildAlias(this.driver,void 0,n,s.referencedColumn.databaseName)],s.referencedColumn)}),o),{})}extractEntityPrimaryIds(e,n){let r;return e.isManyToOne||e.isOneToOneOwner?r=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?r=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?r=e.joinColumns.map(i=>i):r=e.inverseRelation.inverseJoinColumns.map(i=>i),r.reduce((i,o)=>(i[o.databaseName]=n[o.databaseName],i),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const n=e.relationIdAttribute.relation;let r;return n.isManyToOne||n.isOneToOneOwner?r=n.joinColumns:n.isOneToMany||n.isOneToOneNotOwner?r=n.inverseEntityMetadata.primaryColumns:n.isOwning?r=n.inverseJoinColumns:r=n.inverseRelation.joinColumns,e.results.reduce((i,o)=>{let s=r.reduce((a,c)=>{let l=o[c.databaseName];return n.isOneToMany||n.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(l=c.referencedColumn.createValueMap(l)),Ne.mergeDeep(a,c.createValueMap(l))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(l=c.referencedColumn.referencedColumn.createValueMap(l)),Ne.mergeDeep(a,c.referencedColumn.createValueMap(l)))},{});if(r.length===1&&!e.relationIdAttribute.disableMixedMap&&(n.isOneToMany||n.isOneToOneNotOwner?s=r[0].getEntityValue(s):s=r[0].referencedColumn.getEntityValue(s)),s!==void 0){const a=this.hashEntityIds(n,o);i[a]?i[a].push(s):i[a]=[s]}return i},{})}))}hashEntityIds(e,n){const r=this.extractEntityPrimaryIds(e,n);return JSON.stringify(r)}}let Mw=class{constructor(t,e,n){this.connection=t,this.queryRunner=e,this.relationIdAttributes=n}async load(t){const e=this.relationIdAttributes.map(async n=>{if(n.relation.isManyToOne||n.relation.isOneToOneOwner){if(n.queryBuilderFactory)throw new X("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const r={},i=t.map(o=>{const s={},a=[];n.relation.joinColumns.forEach(l=>{s[l.databaseName]=this.connection.driver.prepareHydratedValue(o[Q.buildAlias(this.connection.driver,void 0,n.parentAlias,l.databaseName)],l.referencedColumn);const u=`${l.databaseName}:${s[l.databaseName]}`;a.indexOf(u)===-1&&a.push(u)}),n.relation.entityMetadata.primaryColumns.forEach(l=>{s[l.databaseName]=this.connection.driver.prepareHydratedValue(o[Q.buildAlias(this.connection.driver,void 0,n.parentAlias,l.databaseName)],l);const u=`${l.databaseName}:${s[l.databaseName]}`;a.indexOf(u)===-1&&a.push(u)}),a.sort();const c=a.join("::");return r[c]?null:(r[c]=!0,s)}).filter(o=>o);return{relationIdAttribute:n,results:i}}else if(n.relation.isOneToMany||n.relation.isOneToOneNotOwner){const r=n.relation,i=r.isOwning?r.joinColumns:r.inverseRelation.joinColumns,o=r.inverseEntityMetadata.target,s=r.inverseEntityMetadata.tableName,a=n.alias||s,c={},l={},u=t.map((p,f)=>{const m=[],y={},g=i.map(v=>{const x=v.databaseName+f,C=p[Q.buildAlias(this.connection.driver,void 0,n.parentAlias,v.referencedColumn.databaseName)],$=`${a}:${v.propertyPath}:${C}`;return m.indexOf($)!==-1?"":(m.push($),y[x]=C,a+"."+v.propertyPath+" = :"+x)}).filter(v=>v).join(" AND ");m.sort();const w=m.join("::");return c[w]?"":(c[w]=!0,Object.assign(l,y),g)}).filter(p=>p).map(p=>"("+p+")").join(" OR ");if(!u)return{relationIdAttribute:n,results:[]};const d=this.connection.createQueryBuilder(this.queryRunner);Ne.uniq([...i,...r.inverseRelation.entityMetadata.primaryColumns],p=>p.propertyPath).forEach(p=>{d.addSelect(a+"."+p.propertyPath,p.databaseName)}),d.from(o,a).where("("+u+")").setParameters(l),n.queryBuilderFactory&&n.queryBuilderFactory(d);const h=await d.getRawMany();return h.forEach(p=>{i.forEach(f=>{p[f.databaseName]=this.connection.driver.prepareHydratedValue(p[f.databaseName],f.referencedColumn)}),r.inverseRelation.entityMetadata.primaryColumns.forEach(f=>{p[f.databaseName]=this.connection.driver.prepareHydratedValue(p[f.databaseName],f)})}),{relationIdAttribute:n,results:h}}else{const r=n.relation,i=r.isOwning?r.joinColumns:r.inverseRelation.inverseJoinColumns,o=r.isOwning?r.inverseJoinColumns:r.inverseRelation.joinColumns,s=n.junctionAlias,a=n.joinInverseSideMetadata.tableName,c=n.alias||a,l=r.isOwning?r.junctionEntityMetadata.tableName:r.inverseRelation.junctionEntityMetadata.tableName,u=t.map(w=>i.reduce((v,x)=>(v[x.propertyPath]=w[Q.buildAlias(this.connection.driver,void 0,n.parentAlias,x.referencedColumn.databaseName)],v),{}));if(u.length===0)return{relationIdAttribute:n,results:[]};const d={},h={},p=u.map((w,v)=>{const x=[],C={},$=Object.keys(w).map(E=>{const T=E+v,A=w[E],z=`${s}:${E}:${A}`;return x.indexOf(z)!==-1?"":(x.push(z),C[T]=A,s+"."+E+" = :"+T)}).filter(E=>E).join(" AND ");x.sort();const O=x.join("::");return h[O]?"":(h[O]=!0,Object.assign(d,C),$)}).filter(w=>w),f=o.map(w=>s+"."+w.propertyPath+" = "+c+"."+w.referencedColumn.propertyPath).join(" AND "),m=p.map(w=>"("+w+" AND "+f+")").join(" OR "),y=this.connection.createQueryBuilder(this.queryRunner);o.forEach(w=>{y.addSelect(s+"."+w.propertyPath,w.databaseName).addOrderBy(s+"."+w.propertyPath)}),i.forEach(w=>{y.addSelect(s+"."+w.propertyPath,w.databaseName).addOrderBy(s+"."+w.propertyPath)}),y.from(a,c).innerJoin(l,s,m).setParameters(d),n.queryBuilderFactory&&n.queryBuilderFactory(y);const g=await y.getRawMany();return g.forEach(w=>{[...i,...o].forEach(v=>{w[v.databaseName]=this.connection.driver.prepareHydratedValue(w[v.databaseName],v.referencedColumn)})}),{relationIdAttribute:n,results:g}}});return Promise.all(e)}};class Ew{constructor(e,n){this.connection=e,this.queryRunner=n}load(e,n,r){const i=Array.isArray(n)?n:[n],o=Array.isArray(r)?r:r?[r]:void 0;return e.isManyToMany?this.loadForManyToMany(e,i,o):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,i,o):this.loadForOneToManyAndOneToOneNotOwner(e,i,o)}async loadManyToManyRelationIdsAndGroup(e,n,r,i){const o=e.isManyToMany||e.isOneToMany,s=Array.isArray(n)?n:[n];if(!r&&(r=await this.connection.relationLoader.load(e,n,this.queryRunner,i),!r.length))return s.map(d=>({entity:d,related:o?[]:void 0}));const a=await this.load(e,n,r),c=Array.isArray(r)?r:[r];let l=[],u=[];return e.isManyToManyOwner?(l=e.junctionEntityMetadata.inverseColumns.map(d=>d.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(d=>d.referencedColumn)):e.isManyToManyNotOwner?(l=e.junctionEntityMetadata.ownerColumns.map(d=>d.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(d=>d.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(l=e.joinColumns.map(d=>d.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(l=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(d=>d.referencedColumn)),s.map(d=>{const h={entity:d,related:o?[]:void 0},p=a.filter(f=>u.every(m=>m.compareEntityValue(d,f[m.entityMetadata.name+"_"+m.propertyAliasName])));return p.length&&c.forEach(f=>{p.forEach(m=>{l.every(y=>y.compareEntityValue(f,m[Q.buildAlias(this.connection.driver,void 0,y.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+y.propertyPath.replace(".","_"))]))&&(o?h.related.push(f):h.related=f)})}),h})}loadForManyToMany(e,n,r){const i=e.junctionEntityMetadata,o=i.name,s=e.isOwning?i.ownerColumns:i.inverseColumns,a=e.isOwning?i.inverseColumns:i.ownerColumns,c=this.connection.createQueryBuilder(this.queryRunner);s.forEach(h=>{const p=Q.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"));c.addSelect(o+"."+h.propertyPath,p)}),a.forEach(h=>{const p=Q.buildAlias(this.connection.driver,void 0,h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_"));c.addSelect(o+"."+h.propertyPath,p)});let l="";if(s.length===1){const h=n.map(p=>s[0].referencedColumn.getEntityValue(p));h.every(p=>typeof p=="number")?l=`${o}.${s[0].propertyPath} IN (${h.join(", ")})`:(c.setParameter("values1",h),l=o+"."+s[0].propertyPath+" IN (:...values1)")}else l="("+n.map((h,p)=>s.map(f=>{const m="entity1_"+p+"_"+f.propertyName;return c.setParameter(m,f.referencedColumn.getEntityValue(h)),o+"."+f.propertyPath+" = :"+m}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";let u="";if(r)if(a.length===1){const h=r.map(p=>a[0].referencedColumn.getEntityValue(p));h.every(p=>typeof p=="number")?u=`${o}.${a[0].propertyPath} IN (${h.join(", ")})`:(c.setParameter("values2",h),u=o+"."+a[0].propertyPath+" IN (:...values2)")}else u="("+r.map((h,p)=>a.map(f=>{const m="entity2_"+p+"_"+f.propertyName;return c.setParameter(m,f.referencedColumn.getEntityValue(h)),o+"."+f.propertyPath+" = :"+m}).join(" AND ")).map(h=>"("+h+")").join(" OR ")+")";const d=[l,u].filter(h=>h.length>0).join(" AND ");return c.from(i.target,o).where(d).getRawMany()}loadForManyToOneAndOneToOneOwner(e,n,r){const i=e.entityMetadata.targetName,o=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(l=>l===c));if(r&&o){let c=[];if(n.forEach(l=>{let u={};e.entityMetadata.primaryColumns.forEach(d=>{const h=d.entityMetadata.name+"_"+d.propertyPath.replace(".","_");u[h]=d.getEntityValue(l)}),r.forEach(d=>{e.joinColumns.forEach(h=>{const p=h.getEntityValue(l),f=h.referencedColumn.getEntityValue(d);if(!(p===void 0||f===void 0)&&p===f){const m=h.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+h.referencedColumn.propertyPath.replace(".","_");u[m]=f}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(u)}),c.length===n.length)return Promise.resolve(c)}const s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{const l=Q.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));s.addSelect(i+"."+c.propertyPath,l)}),e.joinColumns.forEach(c=>{const l=Q.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));s.addSelect(i+"."+c.propertyPath,l)});let a="";if(e.entityMetadata.primaryColumns.length===1){const c=n.map(l=>e.entityMetadata.primaryColumns[0].getEntityValue(l));c.every(l=>typeof l=="number")?a=`${i}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(s.setParameter("values",c),a=i+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else a=n.map((c,l)=>e.entityMetadata.primaryColumns.map((u,d)=>{const h="entity"+l+"_"+d;return s.setParameter(h,u.getEntityValue(c)),i+"."+u.propertyPath+" = :"+h}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return s.from(e.entityMetadata.target,i).where(a).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,n,r){if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(a=>e.joinColumns.indexOf(a)!==-1))return Promise.resolve(n.map(a=>{const c={};return e.joinColumns.forEach(function(l){const u=l.referencedColumn.getEntityValue(a),d=l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"),h=l.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_");c[d]=u,c[h]=u}),c}));const i=e.entityMetadata.targetName,o=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(a=>{const c=Q.buildAlias(this.connection.driver,void 0,a.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+a.propertyPath.replace(".","_"));o.addSelect(i+"."+a.propertyPath,c)}),e.joinColumns.forEach(a=>{const c=Q.buildAlias(this.connection.driver,void 0,a.referencedColumn.entityMetadata.name+"_"+a.referencedColumn.propertyPath.replace(".","_"));o.addSelect(i+"."+a.propertyPath,c)});let s="";if(e.joinColumns.length===1){const a=n.map(c=>e.joinColumns[0].referencedColumn.getEntityValue(c));a.every(c=>typeof c=="number")?s=`${i}.${e.joinColumns[0].propertyPath} IN (${a.join(", ")})`:(o.setParameter("values",a),s=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else s=n.map((a,c)=>e.joinColumns.map((l,u)=>{const d="entity"+c+"_"+u;return o.setParameter(d,l.referencedColumn.getEntityValue(a)),i+"."+l.propertyPath+" = :"+d}).join(" AND ")).map(a=>"("+a+")").join(" OR ");return o.from(e.entityMetadata.target,i).where(s).getRawMany()}}class Cw{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const n=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(n)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(n=>{const r=this.metadataToAttribute(e.alias.name,n);this.expressionMap.relationIdAttributes.push(r)})})}metadataToAttribute(e,n){return new co(this.expressionMap,{relationName:e+"."+n.relation.propertyName,mapToProperty:e+"."+n.propertyName,alias:n.alias,queryBuilderFactory:n.queryBuilderFactory})}}class _w{constructor(e,n,r){this.connection=e,this.queryRunner=n,this.relationCountAttributes=r}async load(e){const n=(i,o,s)=>s.indexOf(i)===o,r=this.relationCountAttributes.map(async i=>{if(i.relation.isOneToMany){const o=i.relation,s=o.inverseRelation,a=s.joinColumns[0].referencedColumn.propertyName,c=o.inverseEntityMetadata.target,l=o.inverseEntityMetadata.tableName,u=i.alias||l,d=s.propertyName;let h=e.map(f=>f[i.parentAlias+"_"+a]).filter(f=>!!f);if(h=h.filter(n),h.length===0)return{relationCountAttribute:i,results:[]};const p=this.connection.createQueryBuilder(this.queryRunner);return p.select(u+"."+d,"parentId").addSelect("COUNT(*)","cnt").from(c,u).where(u+"."+d+" IN (:...ids)").addGroupBy(u+"."+d).setParameter("ids",h),i.queryBuilderFactory&&i.queryBuilderFactory(p),{relationCountAttribute:i,results:await p.getRawMany()}}else{let o,s,a,c;i.relation.isOwning?(o=i.relation.joinColumns[0].referencedColumn.databaseName,s=i.relation.inverseJoinColumns[0].referencedColumn.databaseName,a=i.relation.junctionEntityMetadata.columns[0],c=i.relation.junctionEntityMetadata.columns[1]):(o=i.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,s=i.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,a=i.relation.junctionEntityMetadata.columns[1],c=i.relation.junctionEntityMetadata.columns[0]);let l=e.map(y=>y[i.parentAlias+"_"+o]).filter(y=>!!y);if(l=l.filter(n),l.length===0)return{relationCountAttribute:i,results:[]};const u=i.junctionAlias,d=i.joinInverseSideMetadata.tableName,h=i.alias||d,p=i.relation.junctionEntityMetadata.tableName,f=u+"."+a.propertyName+" IN ("+l.map(y=>isNaN(y)?"'"+y+"'":y)+") AND "+u+"."+c.propertyName+" = "+h+"."+s,m=this.connection.createQueryBuilder(this.queryRunner);return m.select(u+"."+a.propertyName,"parentId").addSelect("COUNT("+m.escape(h)+"."+m.escape(s)+")","cnt").from(d,h).innerJoin(p,u,f).addGroupBy(u+"."+a.propertyName),i.queryBuilderFactory&&i.queryBuilderFactory(m),{relationCountAttribute:i,results:await m.getRawMany()}}});return Promise.all(r)}}class Sw{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const n=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(n)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(n=>{const r=this.metadataToAttribute(e.alias.name,n);this.expressionMap.relationCountAttributes.push(r)})})}metadataToAttribute(e,n){return new lo(this.expressionMap,{relationName:e+"."+n.relation.propertyName,mapToProperty:e+"."+n.propertyName,alias:n.alias,queryBuilderFactory:n.queryBuilderFactory})}}class fo{static isFindOneOptions(e){const n=e;return n&&(Array.isArray(n.select)||Array.isArray(n.relations)||typeof n.select=="object"||typeof n.relations=="object"||typeof n.where=="object"||typeof n.join=="object"||typeof n.order=="object"||typeof n.cache=="object"||typeof n.cache=="boolean"||typeof n.cache=="number"||typeof n.comment=="string"||typeof n.lock=="object"||typeof n.loadRelationIds=="object"||typeof n.loadRelationIds=="boolean"||typeof n.loadEagerRelations=="boolean"||typeof n.withDeleted=="boolean"||typeof n.relationLoadStrategy=="string"||typeof n.transaction=="boolean")}static isFindManyOptions(e){const n=e;return n&&(this.isFindOneOptions(n)||typeof n.skip=="number"||typeof n.take=="number"||typeof n.skip=="string"||typeof n.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,n){if(n!=null&&n.relations){const r=[...n.relations];if(fo.applyRelationsRecursively(e,r,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),r.length>0)throw new lv(r)}return e}static applyRelationsRecursively(e,n,r,i,o){let s=[];if(o){const a=new RegExp("^"+o.replace(".","\\.")+"\\.");s=n.filter(c=>c.match(a)).map(c=>i.findRelationWithPropertyPath(c.replace(a,""))).filter(c=>c)}else s=n.map(a=>i.findRelationWithPropertyPath(a)).filter(a=>a);s.forEach(a=>{let c=Q.buildAlias(e.connection.driver,{joiner:"__"},r,a.propertyPath);const l=r+"."+a.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(a):e.leftJoinAndSelect(l,c),n.splice(n.indexOf(o?o+"."+a.propertyPath:a.propertyPath),1);let u,d;if(e.expressionMap.relationLoadStrategy==="query")u=a.inverseEntityMetadata,d=c;else{const h=e.expressionMap.joinAttributes.find(p=>p.entityOrProperty===l);u=h.metadata,d=h.alias.name}if(!d||!u)throw new We(a.propertyPath,i);if(this.applyRelationsRecursively(e,n,d,u,o?o+"."+a.propertyPath:a.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const h=i.relations.find(p=>p.propertyName===a.propertyPath);h&&this.joinEagerRelations(e,c,h.inverseEntityMetadata)}})}static joinEagerRelations(e,n,r){r.eagerRelations.forEach(i=>{let o=Q.buildAlias(e.connection.driver,{joiner:"__"},n,i.propertyName),s=!0;for(const l of e.expressionMap.joinAttributes)if(!(l.condition!==void 0||l.mapToProperty!==void 0||l.isMappingMany!==void 0||l.direction!=="LEFT"||l.entityOrProperty!==`${n}.${i.propertyPath}`)){s=!1,o=l.alias.name;break}const a=!!e.expressionMap.joinAttributes.find(l=>l.alias.name===o);s&&!a&&e.leftJoin(n+"."+i.propertyPath,o);let c=!0;for(const l of e.expressionMap.selects)if(!(l.aliasName!==void 0||l.virtual!==void 0||l.selection!==o)){c=!1;break}c&&e.addSelect(o),this.joinEagerRelations(e,o,i.inverseEntityMetadata)})}}class mo extends be{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,n){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(r=>({selection:r}));else if(typeof e=="function"){const r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:n})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:n}]);return this}addSelect(e,n){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(r=>({selection:r})));else if(typeof e=="function"){const r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:n})}else e&&this.expressionMap.selects.push({selection:e,aliasName:n});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,n){const r=this.createFromAlias(e,n);return this.expressionMap.setMainAlias(r),this}addFrom(e,n){const r=this.createFromAlias(e,n);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(r),this}innerJoin(e,n,r,i){return this.join("INNER",e,n,r,i),this}leftJoin(e,n,r,i){return this.join("LEFT",e,n,r,i),this}innerJoinAndSelect(e,n,r,i){return this.addSelect(n),this.innerJoin(e,n,r,i),this}leftJoinAndSelect(e,n,r,i){return this.addSelect(n),this.leftJoin(e,n,r,i),this}innerJoinAndMapMany(e,n,r,i,o){return this.addSelect(r),this.join("INNER",n,r,i,o,e,!0),this}innerJoinAndMapOne(e,n,r,i,o,s){return this.addSelect(r),this.join("INNER",n,r,i,o,e,!1,s),this}leftJoinAndMapMany(e,n,r,i,o){return this.addSelect(r),this.join("LEFT",n,r,i,o,e,!0),this}leftJoinAndMapOne(e,n,r,i,o,s){return this.addSelect(r),this.join("LEFT",n,r,i,o,e,!1,s),this}loadRelationIdAndMap(e,n,r,i){const o=new co(this.expressionMap);return o.mapToProperty=e,o.relationName=n,typeof r=="string"&&(o.alias=r),typeof r=="object"&&r.disableMixedMap&&(o.disableMixedMap=!0),o.queryBuilderFactory=i,this.expressionMap.relationIdAttributes.push(o),o.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:o.junctionAlias,metadata:o.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,n,r,i){const o=new lo(this.expressionMap);return o.mapToProperty=e,o.relationName=n,o.alias=r,o.queryBuilderFactory=i,this.expressionMap.relationCountAttributes.push(o),this.expressionMap.createAlias({type:"other",name:o.junctionAlias}),o.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:o.junctionAlias,metadata:o.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(n=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(n.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+n.propertyPath,this.expressionMap.mainAlias.name+"."+n.propertyPath,e)}),this}where(e,n){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),n&&this.setParameters(n),this}andWhere(e,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}orWhere(e,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,n){return this.expressionMap.havings.push({type:"simple",condition:e}),n&&this.setParameters(n),this}andHaving(e,n){return this.expressionMap.havings.push({type:"and",condition:e}),n&&this.setParameters(n),this}orHaving(e,n){return this.expressionMap.havings.push({type:"or",condition:e}),n&&this.setParameters(n),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,n="ASC",r){if(n!==void 0&&n!=="ASC"&&n!=="DESC")throw new X('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new X('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:n,nulls:r}}:this.expressionMap.orderBys={[e]:n}:this.expressionMap.orderBys={},this}addOrderBy(e,n="ASC",r){if(n!==void 0&&n!=="ASC"&&n!=="DESC")throw new X('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new X('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return r?this.expressionMap.orderBys[e]={order:n,nulls:r}:this.expressionMap.orderBys[e]=n,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new X('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new X('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new X('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new X('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,n,r){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=n,this.expressionMap.lockTables=r,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new On;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0);const r=await this.loadRawResults(e);return n&&await e.commitTransaction(),r}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0),this.expressionMap.queryEntity=!0;const r=await this.executeEntitiesAndRawResults(e);return n&&await e.commitTransaction(),r}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const e=(await this.getRawAndEntities()).entities[0];if(e&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const r=n.updateDateColumn.getEntityValue(e);if(r.getTime()!==this.expressionMap.lockVersion.getTime())throw new Pl(n.name,this.expressionMap.lockVersion,r)}else{const r=n.versionColumn.getEntityValue(e);if(r!==this.expressionMap.lockVersion)throw new Pl(n.name,this.expressionMap.lockVersion,r)}}return e===void 0?null:e}async getOneOrFail(){const e=await this.getOne();if(!e)throw new ov(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new On;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new On;const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0),this.expressionMap.queryEntity=!1;const r=await this.executeCountQuery(e);return n&&await e.commitTransaction(),r}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new On;const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0),this.expressionMap.queryEntity=!1;const r=await this.executeExistsQuery(e);return n&&await e.commitTransaction(),r}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new On;const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0),this.expressionMap.queryEntity=!0;const r=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;const i=this.expressionMap.cacheId;this.expressionMap.cacheId=i&&`${i}-count`;const o=await this.executeCountQuery(e),s=[r.entities,o];return n&&await e.commitTransaction(),s}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async stream(){this.expressionMap.queryEntity=!1;const[e,n]=this.getQueryAndParameters(),r=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),i=!0);const o=()=>{if(r!==this.queryRunner)return r.release()},s=r.stream(e,n,o,o);return i&&await r.commitTransaction(),s}catch(o){if(i)try{await r.rollbackTransaction()}catch{}throw o}}cache(e,n){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),n&&(this.expressionMap.cacheDuration=n),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,n,r,i,o,s,a,c){o&&this.setParameters(o);const l=new Ql(this.connection,this.expressionMap);l.direction=e,l.mapAsEntity=c,l.mapToProperty=s,l.isMappingMany=a,l.entityOrProperty=n,l.condition=i,this.expressionMap.joinAttributes.push(l);const u=l.metadata;if(u){if(u.deleteDateColumn&&!this.expressionMap.withDeleted){const d=`${r}.${u.deleteDateColumn.propertyName} IS NULL`;l.condition=l.condition?` ${l.condition} AND ${d}`:`${d}`}l.alias=this.expressionMap.createAlias({type:"join",name:r,metadata:u}),l.relation&&l.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:l.junctionAlias,metadata:l.relation.junctionEntityMetadata})}else{let d="";if(typeof n=="function"){const p=n(this.subQuery());this.setParameters(p.getParameters()),d=p.getQuery()}else d=n;const h=typeof n=="function"||n.substr(0,1)==="("&&n.substr(-1)===")";l.alias=this.expressionMap.createAlias({type:"join",name:r,tablePath:h===!1?n:void 0,subQuery:h===!0?d:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new X("Cannot build query because main alias is not set (call qb#from method)");const e=[],n=[];if(this.expressionMap.mainAlias.hasMetadata){const a=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,a)),n.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,a))}this.expressionMap.joinAttributes.forEach(a=>{if(a.metadata)e.push(...this.buildEscapedEntityColumnSelects(a.alias.name,a.metadata)),n.push(...this.findEntityColumnSelects(a.alias.name,a.metadata));else if(this.expressionMap.selects.some(c=>c.selection===a.alias.name)){e.push({selection:this.escape(a.alias.name)+".*"});const c=this.expressionMap.selects.find(l=>l.selection===a.alias.name);n.push(c)}}),this.expressionMap.selects.filter(a=>n.indexOf(a)===-1).forEach(a=>e.push({selection:this.replacePropertyNames(a.selection),aliasName:a.aliasName})),e.length===0&&e.push({selection:"*"});let r="";this.expressionMap.useIndex&&Q.isMySQLFamily(this.connection.driver)&&(r=` USE INDEX (${this.expressionMap.useIndex})`);const i=this.expressionMap.aliases.filter(a=>a.type==="from"&&(a.tablePath||a.subQuery)).map(a=>a.subQuery?a.subQuery+" "+this.escape(a.name):this.getTableName(a.tablePath)+" "+this.escape(a.name)),o=this.createSelectDistinctExpression(),s=e.map(a=>a.selection+(a.aliasName?" AS "+this.escape(a.aliasName):"")).join(", ");return o+s+" FROM "+i.join(", ")+this.createTableLockExpression()+r}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:n,maxExecutionTime:r}=this.expressionMap,{driver:i}=this.connection;let o="SELECT ";return r>0&&Q.isMySQLFamily(i)&&(o+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),Q.isPostgresFamily(i)&&n.length>0?o=`SELECT DISTINCT ON (${n.map(s=>this.replacePropertyNames(s)).join(", ")}) `:e&&(o="SELECT DISTINCT "),o}createJoinExpression(){return this.expressionMap.joinAttributes.map(e=>{const n=e.relation,r=e.tablePath,i=e.alias.name;let o=e.condition?" AND ("+e.condition+")":"";const s=e.parentAlias;if(!s||!n){const a=e.alias.subQuery?e.alias.subQuery:this.getTableName(r);return" "+e.direction+" JOIN "+a+" "+this.escape(i)+this.createTableLockExpression()+(e.condition?" ON "+this.replacePropertyNames(e.condition):"")}if(n.isManyToOne||n.isOneToOneOwner){const a=n.joinColumns.map(c=>i+"."+c.referencedColumn.propertyPath+"="+s+"."+n.propertyPath+"."+c.referencedColumn.propertyPath).join(" AND ");return" "+e.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(a+o)}else if(n.isOneToMany||n.isOneToOneNotOwner){const a=n.inverseRelation.joinColumns.map(c=>(n.inverseEntityMetadata.tableType==="entity-child"&&n.inverseEntityMetadata.discriminatorColumn&&(o+=" AND "+i+"."+n.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+n.inverseEntityMetadata.discriminatorValue+"'"),i+"."+n.inverseRelation.propertyPath+"."+c.referencedColumn.propertyPath+"="+s+"."+c.referencedColumn.propertyPath)).join(" AND ");if(!a)throw new X(`Relation ${n.entityMetadata.name}.${n.propertyName} does not have join columns.`);return" "+e.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(a+o)}else{const a=n.junctionEntityMetadata.tablePath,c=e.junctionAlias;let l="",u="";return n.isOwning?(l=n.joinColumns.map(d=>c+"."+d.propertyPath+"="+s+"."+d.referencedColumn.propertyPath).join(" AND "),u=n.inverseJoinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+c+"."+d.propertyPath).join(" AND ")):(l=n.inverseRelation.inverseJoinColumns.map(d=>c+"."+d.propertyPath+"="+s+"."+d.referencedColumn.propertyPath).join(" AND "),u=n.inverseRelation.joinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+c+"."+d.propertyPath).join(" AND "))," "+e.direction+" JOIN "+this.getTableName(a)+" "+this.escape(c)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l)+" "+e.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u+o)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(n=>{const r=typeof e[n]=="string"?e[n]:e[n].order+" "+e[n].nulls,i=this.expressionMap.selects.find(o=>o.selection===n);if(i&&!i.aliasName&&n.indexOf(".")!==-1){const o=n.split("."),s=o[0],a=o.slice(1).join("."),c=this.expressionMap.aliases.find(l=>l.name===s);if(c){const l=c.metadata.findColumnWithPropertyPath(a);if(l){const u=Q.buildAlias(this.connection.driver,void 0,s,l.databaseName);return this.escape(u)+" "+r}}}return this.replacePropertyNames(n)+" "+r}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,n=this.expressionMap.limit;if(!e&&!n&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,n=this.expressionMap.take),this.connection.driver.options.type==="mssql"){let r="";if((n||e)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(r=" ORDER BY (SELECT NULL)"),n&&e)return r+" OFFSET "+e+" ROWS FETCH NEXT "+n+" ROWS ONLY";if(n)return r+" OFFSET 0 ROWS FETCH NEXT "+n+" ROWS ONLY";if(e)return r+" OFFSET "+e+" ROWS"}else if(Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(n&&e)return" LIMIT "+n+" OFFSET "+e;if(n)return" LIMIT "+n;if(e)throw new dv}else if(Q.isSQLiteFamily(this.connection.driver)){if(n&&e)return" LIMIT "+n+" OFFSET "+e;if(n)return" LIMIT "+n;if(e)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(n&&e)return" OFFSET "+e+" ROWS FETCH NEXT "+n+" ROWS ONLY";if(n)return" FETCH NEXT "+n+" ROWS ONLY";if(e)return" OFFSET "+e+" ROWS"}else{if(n&&e)return" LIMIT "+n+" OFFSET "+e;if(n)return" LIMIT "+n;if(e)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let n="";if(this.expressionMap.lockTables){if(!(Q.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new X("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new X("lockTables cannot be an empty array");n=" OF "+this.expressionMap.lockTables.join(", ")}let r="";switch(this.expressionMap.onLocked==="nowait"?r=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(r=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return Q.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+n+r:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(Q.isPostgresFamily(e))return" FOR SHARE"+n+r;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new Vt;case"pessimistic_write":if(Q.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+r;if(Q.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+n+r;if(e.options.type==="mssql")return"";throw new Vt;case"pessimistic_partial_write":if(Q.isPostgresFamily(e))return" FOR UPDATE"+n+" SKIP LOCKED";if(Q.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new Vt;case"pessimistic_write_or_fail":if(Q.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+n+" NOWAIT";if(Q.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new Vt;case"for_no_key_update":if(Q.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+n+r;throw new Vt;case"for_key_share":if(Q.isPostgresFamily(e))return" FOR KEY SHARE"+n+r;throw new Vt;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((n,r)=>{switch(n.type){case"and":return(r>0?"AND ":"")+this.replacePropertyNames(n.condition);case"or":return(r>0?"OR ":"")+this.replacePropertyNames(n.condition);default:return this.replacePropertyNames(n.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,n){const r=this.expressionMap.selects.some(l=>l.selection===e),i=[];if(r&&i.push(...n.columns.filter(l=>l.isSelect===!0)),i.push(...n.columns.filter(l=>this.expressionMap.selects.some(u=>u.selection===e+"."+l.propertyPath))),i.length===0)return[];const o=this.expressionMap.queryEntity?n.primaryColumns.filter(l=>i.indexOf(l)===-1):[],s=[...i,...o],a=[],c=this.escape(e);return s.forEach(l=>{let u=c+"."+this.escape(l.databaseName);l.isVirtualProperty&&l.query&&(u=`(${l.query(c)})`),this.connection.driver.spatialTypes.indexOf(l.type)!==-1&&((Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(u=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${u})`),Q.isPostgresFamily(this.connection.driver)&&(l.precision?u=`ST_AsGeoJSON(${u}, ${l.precision})::json`:u=`ST_AsGeoJSON(${u})::json`),this.connection.driver.options.type==="mssql"&&(u=`${u}.ToString()`));const d=this.expressionMap.selects.filter(h=>h.selection===e+"."+l.propertyPath);if(d.length)d.forEach(h=>{a.push({selection:u,aliasName:h.aliasName?h.aliasName:Q.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:h.virtual})});else{if(l.isVirtualProperty)return;a.push({selection:u,aliasName:Q.buildAlias(this.connection.driver,void 0,e,l.databaseName),virtual:r})}}),a}findEntityColumnSelects(e,n){const r=this.expressionMap.selects.find(i=>i.selection===e);return r?[r]:this.expressionMap.selects.filter(i=>n.columns.some(o=>i.selection===e+"."+o.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,n=this.expressionMap.mainAlias.metadata.primaryColumns,r=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||Q.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", ")+"))";if(Q.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const i=n.map(o=>`${r}.${this.escape(o.databaseName)}`).join(", '|;|', ");return n.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?n.length===1?`COUNT(DISTINCT(${r}.${this.escape(n[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${n.map(i=>`CAST(${r}.${this.escape(i.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const n=this.computeCountExpression(),r=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(n,"cnt").setOption("disable-global-order").loadRawResults(e);return!r||!r[0]||!r[0].cnt?0:parseInt(r[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?Ne.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?Ne.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(n=>{const r=this.expressionMap.aliases.find(i=>i.metadata.tableNameWithoutPrefix===n);if(!r)throw new X(`"${n}" is not part of this query`);return this.escape(r.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&fo.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new X('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new uv;if(this.expressionMap.lockMode==="optimistic"){const s=this.expressionMap.mainAlias.metadata;if(!s.versionColumn&&!s.updateDateColumn)throw new av(s.name)}const n=new Mw(this.connection,e,this.expressionMap.relationIdAttributes),r=new _w(this.connection,e,this.expressionMap.relationCountAttributes);new Cw(this.expressionMap).transform(),new Sw(this.expressionMap).transform();let i=[],o=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[s,a]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),c=this.expressionMap.mainAlias.metadata,l=this.expressionMap.mainAlias.name,u=c.primaryColumns.map(p=>{const f=this.escape("distinctAlias"),m=this.escape(Q.buildAlias(this.connection.driver,void 0,l,p.databaseName));a[m]||(a[m]="ASC");const y=Q.buildAlias(this.connection.driver,void 0,"ids_"+l,p.databaseName);return`${f}.${m} AS ${this.escape(y)}`}),d=this.clone(),h=d.expressionMap.timeTravel;if(i=await new mo(this.connection,e).select(`DISTINCT ${u.join(", ")}`).addSelect(s).from(`(${d.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(h).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(a).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),i.length>0){let p="";const f={};if(c.hasMultiplePrimaryKeys)p=i.map((m,y)=>c.primaryColumns.map(g=>{const w=`orm_distinct_ids_${y}_${g.databaseName}`,v=Q.buildAlias(this.connection.driver,void 0,"ids_"+l,g.databaseName);return f[w]=m[v],`${l}.${g.propertyPath}=:${w}`}).join(" AND ")).join(" OR ");else{const m=Q.buildAlias(this.connection.driver,void 0,"ids_"+l,c.primaryColumns[0].databaseName),y=i.map(g=>g[m]);y.every(g=>typeof g=="number")?p=`${l}.${c.primaryColumns[0].propertyPath} IN (${y.join(", ")})`:(f.orm_distinct_ids=y,p=l+"."+c.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}i=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:p}).setParameters(f).loadRawResults(e)}}else i=await this.loadRawResults(e);if(i.length>0){const s=await n.load(i),a=await r.load(i);o=new ww(this.expressionMap,this.connection.driver,s,a,this.queryRunner).transform(i,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,o)}if(this.expressionMap.relationLoadStrategy==="query"){const s=new Ew(this.connection,e);await Promise.all(this.relationMetadatas.map(async a=>{const c=a.inverseEntityMetadata.target,l=a.inverseEntityMetadata.targetName,u=Array.isArray(this.findOptions.select)?Ne.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,d=Array.isArray(this.findOptions.relations)?Ne.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,h=this.createQueryBuilder(e).select(l).from(c,l).setFindOptions({select:u?Ne.deepValue(u,a.propertyPath):void 0,order:this.findOptions.order?Ne.deepValue(this.findOptions.order,a.propertyPath):void 0,relations:d?Ne.deepValue(d,a.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(o.length>0){const p=await s.loadManyToManyRelationIdsAndGroup(a,o,void 0,h);o.forEach(f=>{const m=p.find(y=>y.entity===f);if(m){const y=m.related===void 0?null:m.related;a.setEntityValue(f,y)}})}}))}return{raw:i,entities:o}}createOrderByCombinedWithSelectExpression(e){const n=this.expressionMap.allOrderBys,r=Object.keys(n).map(o=>{if(o.indexOf(".")!==-1){const s=o.split("."),a=s[0],c=s.slice(1).join("."),l=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(Q.buildAlias(this.connection.driver,void 0,a,l.databaseName))}else return this.expressionMap.selects.find(s=>s.selection===o||s.aliasName===o)?this.escape(e)+"."+this.escape(o):""}).join(", "),i={};return Object.keys(n).forEach(o=>{if(o.indexOf(".")!==-1){const s=o.split("."),a=s[0],c=s.slice(1).join("."),l=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(c);i[this.escape(e)+"."+this.escape(Q.buildAlias(this.connection.driver,void 0,a,l.databaseName))]=n[o]}else this.expressionMap.selects.find(s=>s.selection===o||s.aliasName===o)?i[this.escape(e)+"."+this.escape(o)]=n[o]:i[o]=n[o]}),[r,i]}async loadRawResults(e){const[n,r]=this.getQueryAndParameters(),i=n+" -- PARAMETERS: "+JSON.stringify(r,(u,d)=>typeof d=="bigint"?d.toString():d),o=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let s;const a=o.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let c=!1;if(this.connection.queryResultCache&&a)try{if(s=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:i,duration:this.expressionMap.cacheDuration||o.duration||1e3},e),s&&!this.connection.queryResultCache.isExpired(s))return JSON.parse(s.result)}catch(u){if(!o.ignoreErrors)throw u;c=!0}const l=await e.query(n,r,!0);if(!c&&this.connection.queryResultCache&&a)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:i,time:new Date().getTime(),duration:this.expressionMap.cacheDuration||o.duration||1e3,result:JSON.stringify(l.records)},s,e)}catch(u){if(!o.ignoreErrors)throw u}return l.records}mergeExpressionMap(e){return Ce.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,n,r,i){for(let o in e){if(e[o]===void 0||e[o]===!1)continue;const s=i?i+"."+o:o,a=n.findColumnWithPropertyPathStrict(s),c=n.findEmbeddedWithPropertyPath(s),l=n.findRelationWithPropertyPath(s);if(!c&&!a&&!l)throw new We(s,n);a?this.selects.push(r+"."+s):c&&this.buildSelect(e[o],n,r,s)}}buildRelations(e,n,r,i,o){e&&Object.keys(e).forEach(s=>{const a=e[s],c=o?o+"."+s:s,l=r.findEmbeddedWithPropertyPath(c),u=r.findRelationWithPropertyPath(c);if(!l&&!u)throw new We(c,r);if(l)this.buildRelations(a,typeof n=="object"?Ne.deepValue(n,l.propertyPath):void 0,r,i,c);else if(u){let d=i+"_"+c.replace(".","_");d=Q.buildAlias(this.connection.driver,{joiner:"__"},i,d),(a===!0||typeof a=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(u):(this.joins.push({type:"left",select:!0,selection:n&&typeof n[s]=="object"?n[s]:void 0,alias:d,parentAlias:i,relationMetadata:u}),n&&typeof n[s]=="object"&&this.buildSelect(n[s],u.inverseEntityMetadata,d))),typeof a=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(a,typeof n=="object"?Ne.deepValue(n,u.propertyPath):void 0,u.inverseEntityMetadata,d,void 0)}})}buildEagerRelations(e,n,r,i,o){e&&Object.keys(e).forEach(s=>{const a=e[s],c=o?o+"."+s:s,l=r.findEmbeddedWithPropertyPath(c),u=r.findRelationWithPropertyPath(c);if(!l&&!u)throw new We(c,r);if(l)this.buildEagerRelations(a,typeof n=="object"?Ne.deepValue(n,l.propertyPath):void 0,r,i,c);else if(u){let d=i+"_"+c.replace(".","_");d=Q.buildAlias(this.connection.driver,{joiner:"__"},i,d),(a===!0||typeof a=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(h=>{let p=d+"_"+h.propertyPath.replace(".","_");p=Q.buildAlias(this.connection.driver,{joiner:"__"},d,p),this.joins.find(f=>f.alias===p)||this.joins.push({type:"left",select:!0,alias:p,parentAlias:d,selection:void 0,relationMetadata:h}),n&&typeof n[s]=="object"&&this.buildSelect(n[s],u.inverseEntityMetadata,d)}),typeof a=="object"&&this.buildEagerRelations(a,typeof n=="object"?Ne.deepValue(n,u.propertyPath):void 0,u.inverseEntityMetadata,d,void 0)}})}buildOrder(e,n,r,i){for(let o in e){if(e[o]===void 0)continue;const s=i?i+"."+o:o,a=n.findColumnWithPropertyPathStrict(s),c=n.findEmbeddedWithPropertyPath(s),l=n.findRelationWithPropertyPath(s);if(!c&&!a&&!l)throw new We(s,n);if(a){let u=typeof e[o]=="object"?e[o].direction:e[o];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let d=typeof e[o]=="object"?e[o].nulls:void 0;d=(d==null?void 0:d.toLowerCase())==="first"?"NULLS FIRST":(d==null?void 0:d.toLowerCase())==="last"?"NULLS LAST":void 0;let h=`${r}.${s}`;this.addOrderBy(h,u,d)}else if(c)this.buildOrder(e[o],n,r,s);else if(l){let u=r+"_"+s.replace(".","_");u=Q.buildAlias(this.connection.driver,{joiner:"__"},r,u),this.joins.find(d=>d.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:r,selection:void 0,relationMetadata:l}),this.buildOrder(e[o],l.inverseEntityMetadata,u)}}}buildWhere(e,n,r,i){let o="";if(Array.isArray(e))e.length&&(o=e.map(s=>this.buildWhere(s,n,r,i)).filter(s=>!!s).map(s=>"("+s+")").join(" OR "));else{let s=[];for(let a in e){if(e[a]===void 0||e[a]===null)continue;const c=i?i+"."+a:a,l=n.findColumnWithPropertyPathStrict(c),u=n.findEmbeddedWithPropertyPath(c),d=n.findRelationWithPropertyPath(c);if(!u&&!l&&!d)throw new We(c,n);if(l){let h=`${r}.${c}`;l.isVirtualProperty&&l.query&&(h=`(${l.query(r)})`);let p=e[a];fe.isEqualOperator(e[a])&&(p=e[a].value),l.transformer&&(p instanceof kn?p.transformValue(l.transformer):p=ho.transformTo(l.transformer,p)),s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(h,p)))}else if(u){const h=this.buildWhere(e[a],n,r,c);h&&s.push(h)}else if(d){if(typeof e[a]=="object"&&Object.keys(e[a]).every(h=>e[a][h]===void 0))continue;if(fe.isFindOperator(e[a]))if(e[a].type==="moreThan"||e[a].type==="lessThan"||e[a].type==="moreThanOrEqual"||e[a].type==="lessThanOrEqual"){let h="";e[a].type==="moreThan"?h=">":e[a].type==="lessThan"?h="<":e[a].type==="moreThanOrEqual"?h=">=":e[a].type==="lessThanOrEqual"&&(h="<=");const p=this.subQuery();if(d.isManyToManyOwner)p.select("COUNT(*)").from(d.joinTableName,d.joinTableName).where(d.joinColumns.map(f=>`${d.joinTableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else if(d.isManyToManyNotOwner)p.select("COUNT(*)").from(d.inverseRelation.joinTableName,d.inverseRelation.joinTableName).where(d.inverseRelation.inverseJoinColumns.map(f=>`${d.inverseRelation.joinTableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else if(d.isOneToMany)p.select("COUNT(*)").from(d.inverseEntityMetadata.target,d.inverseEntityMetadata.tableName).where(d.inverseRelation.joinColumns.map(f=>`${d.inverseEntityMetadata.tableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(p.getSql()+" "+h+" "+parseInt(e[a].value))}else if(d.isManyToOne||d.isOneToOne&&d.isOneToOneOwner){const h=`${r}.${c}`;s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(h,e[a])))}else throw new Error("This relation isn't supported by given find operator");else{let h=r+"_"+d.propertyPath.replace(".","_");h=Q.buildAlias(this.connection.driver,{joiner:"__"},r,h),this.joins.find(f=>f.alias===h)||this.joins.push({type:"left",select:!1,selection:void 0,alias:h,parentAlias:r,relationMetadata:d});const p=this.buildWhere(e[a],d.inverseEntityMetadata,h);p&&s.push(p)}}}o=s.length?"("+s.join(") AND (")+")":s.join(" AND ")}return o.length?"("+o+")":o}}class Jl{constructor(){this.generatedMaps=[]}static from(e){const n=new this;return n.raw=e.records,n.affected=e.affected,n}}class Ow extends be{constructor(e,n){super(e,n),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const r=new po(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getSoftDeletionReturningColumns());const[i,o]=this.getQueryAndParameters(),s=await e.query(i,o,!0),a=Jl.from(s);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(a,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),n&&await e.commitTransaction(),a}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}from(e,n){e=fe.isEntitySchema(e)?e.options.name:e;const r=this.createFromAlias(e,n);return this.expressionMap.setMainAlias(r),this}where(e,n){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),n&&this.setParameters(n),this}andWhere(e,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}orWhere(e,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Ir;return this.expressionMap.returning=e,this}orderBy(e,n="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:n,nulls:r}}:this.expressionMap.orderBys={[e]:n}:this.expressionMap.orderBys={},this}addOrderBy(e,n="ASC",r){return r?this.expressionMap.orderBys[e]={order:n,nulls:r}:this.expressionMap.orderBys[e]=n,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new X(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const n=Array.isArray(e)?e:[e];return n.forEach(r=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!i)throw new X("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=n,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new X(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new sv(e);const n=[];switch(this.expressionMap.queryType){case"soft-delete":n.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":n.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new X('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&n.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&n.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),n.length<=0)throw new oo;const r=this.createWhereExpression(),i=this.createReturningExpression("update");return i===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")} OUTPUT ${i}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${r} RETURNING ${i}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(n=>typeof e[n]=="string"?this.replacePropertyNames(n)+" "+e[n]:this.replacePropertyNames(n)+" "+e[n].order+" "+e[n].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(Q.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new Tl}return""}}class Aw extends be{constructor(e,n){super(e,n),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let n=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let r=null,i=null;const o=new po(e,this.expressionMap),s=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const h of this.expressionMap.returning)s.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(h));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=o.getUpdationReturningColumns(),s.push(...this.expressionMap.extraReturningColumns.filter(h=>!s.includes(h)))),s.length>0&&this.connection.driver.options.type==="mssql"&&(r=this.connection.driver.buildTableVariableDeclaration("@OutputTable",s),i="SELECT * FROM @OutputTable");const[a,c]=this.getQueryAndParameters(),l=[r,a,i],u=await e.query(l.filter(h=>h!=null).join(`;

`),c,!0),d=Jl.from(u);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await o.update(d,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),n&&await e.commitTransaction(),d}catch(r){if(n)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,n){this.expressionMap.wheres=[];const r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),n&&this.setParameters(n),this}andWhere(e,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}orWhere(e,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),n&&this.setParameters(n),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Ir;return this.expressionMap.returning=e,this}orderBy(e,n="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:n,nulls:r}}:this.expressionMap.orderBys={[e]:n}:this.expressionMap.orderBys={},this}addOrderBy(e,n="ASC",r){return r?this.expressionMap.orderBys[e]={order:n,nulls:r}:this.expressionMap.orderBys[e]=n,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new X(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const n=Array.isArray(e)?e:[e];return n.forEach(r=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!i)throw new X("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=n,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),n=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,r={};for(let c in e)e[c]!==void 0&&(r[c]=e[c]);const i=[],o=[];if(n?(this.createPropertyPath(n,r).forEach(c=>{const l=n.findColumnsWithPropertyPath(c);if(l.length<=0)throw new We(c,n);l.forEach(u=>{if(!u.isUpdate||o.includes(u))return;o.push(u);let d=u.getEntityValue(r);if(u.referencedColumn&&typeof d=="object"&&!(d instanceof Date)&&d!==null&&!jp.isBuffer(d)?d=u.referencedColumn.getEntityValue(d):typeof d!="function"&&(d=this.connection.driver.preparePersistentValue(d,u)),typeof d=="function")i.push(this.escape(u.databaseName)+" = "+d());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&d===null)i.push(this.escape(u.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(d=this.connection.driver.parametrizeValue(u,d));const h=this.createParameter(d);let p=null;if((Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1){const f=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";u.srid!=null?p=`${f}(${h}, ${u.srid})`:p=`${f}(${h})`}else Q.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?u.srid!=null?p=`ST_SetSRID(ST_GeomFromGeoJSON(${h}), ${u.srid})::${u.type}`:p=`ST_GeomFromGeoJSON(${h})::${u.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(u.type)!==-1?p=u.type+"::STGeomFromText("+h+", "+(u.srid||"0")+")":p=h;i.push(this.escape(u.databaseName)+" = "+p)}})}),(i.length>0||Object.keys(r).length===0)&&(n.versionColumn&&o.indexOf(n.versionColumn)===-1&&i.push(this.escape(n.versionColumn.databaseName)+" = "+this.escape(n.versionColumn.databaseName)+" + 1"),n.updateDateColumn&&o.indexOf(n.updateDateColumn)===-1&&i.push(this.escape(n.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(r).map(c=>{let l=r[c];if(typeof l=="function")i.push(this.escape(c)+" = "+l());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&l===null)i.push(this.escape(c)+" = NULL");else{const u=this.createParameter(l);i.push(this.escape(c)+" = "+u)}}),i.length<=0)throw new oo;const s=this.createWhereExpression(),a=this.createReturningExpression("update");return a===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")} OUTPUT ${a}${s}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${s} RETURNING ${a}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(n=>typeof e[n]=="string"?this.replacePropertyNames(n)+" "+e[n]:this.replacePropertyNames(n)+" "+e[n].order+" "+e[n].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(Q.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new Tl}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new oo}}function Nw(){be.registerQueryBuilderClass("DeleteQueryBuilder",t=>new hw(t)),be.registerQueryBuilderClass("InsertQueryBuilder",t=>new xw(t)),be.registerQueryBuilderClass("RelationQueryBuilder",t=>new vw(t)),be.registerQueryBuilderClass("SelectQueryBuilder",t=>new mo(t)),be.registerQueryBuilderClass("SoftDeleteQueryBuilder",t=>new Ow(t)),be.registerQueryBuilderClass("UpdateQueryBuilder",t=>new Aw(t))}var eu;(function(t){t.VIEW="VIEW",t.MATERIALIZED_VIEW="MATERIALIZED_VIEW",t.GENERATED_COLUMN="GENERATED_COLUMN"})(eu||(eu={}));var tu={exports:{}},yo,nu;function Pw(){if(nu)return yo;nu=1;var t=1e3,e=t*60,n=e*60,r=n*24,i=r*7,o=r*365.25;yo=function(u,d){d=d||{};var h=typeof u;if(h==="string"&&u.length>0)return s(u);if(h==="number"&&isFinite(u))return d.long?c(u):a(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function s(u){if(u=String(u),!(u.length>100)){var d=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(d){var h=parseFloat(d[1]),p=(d[2]||"ms").toLowerCase();switch(p){case"years":case"year":case"yrs":case"yr":case"y":return h*o;case"weeks":case"week":case"w":return h*i;case"days":case"day":case"d":return h*r;case"hours":case"hour":case"hrs":case"hr":case"h":return h*n;case"minutes":case"minute":case"mins":case"min":case"m":return h*e;case"seconds":case"second":case"secs":case"sec":case"s":return h*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function a(u){var d=Math.abs(u);return d>=r?Math.round(u/r)+"d":d>=n?Math.round(u/n)+"h":d>=e?Math.round(u/e)+"m":d>=t?Math.round(u/t)+"s":u+"ms"}function c(u){var d=Math.abs(u);return d>=r?l(u,d,r,"day"):d>=n?l(u,d,n,"hour"):d>=e?l(u,d,e,"minute"):d>=t?l(u,d,t,"second"):u+" ms"}function l(u,d,h,p){var f=d>=h*1.5;return Math.round(u/h)+" "+p+(f?"s":"")}return yo}function Tw(t){n.debug=n,n.default=n,n.coerce=c,n.disable=o,n.enable=i,n.enabled=s,n.humanize=Pw(),n.destroy=l,Object.keys(t).forEach(u=>{n[u]=t[u]}),n.names=[],n.skips=[],n.formatters={};function e(u){let d=0;for(let h=0;h<u.length;h++)d=(d<<5)-d+u.charCodeAt(h),d|=0;return n.colors[Math.abs(d)%n.colors.length]}n.selectColor=e;function n(u){let d,h=null,p,f;function m(...y){if(!m.enabled)return;const g=m,w=Number(new Date),v=w-(d||w);g.diff=v,g.prev=d,g.curr=w,d=w,y[0]=n.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let x=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(C,$)=>{if(C==="%%")return"%";x++;const O=n.formatters[$];if(typeof O=="function"){const E=y[x];C=O.call(g,E),y.splice(x,1),x--}return C}),n.formatArgs.call(g,y),(g.log||n.log).apply(g,y)}return m.namespace=u,m.useColors=n.useColors(),m.color=n.selectColor(u),m.extend=r,m.destroy=n.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(p!==n.namespaces&&(p=n.namespaces,f=n.enabled(u)),f),set:y=>{h=y}}),typeof n.init=="function"&&n.init(m),m}function r(u,d){const h=n(this.namespace+(typeof d>"u"?":":d)+u);return h.log=this.log,h}function i(u){n.save(u),n.namespaces=u,n.names=[],n.skips=[];let d;const h=(typeof u=="string"?u:"").split(/[\s,]+/),p=h.length;for(d=0;d<p;d++)h[d]&&(u=h[d].replace(/\*/g,".*?"),u[0]==="-"?n.skips.push(new RegExp("^"+u.slice(1)+"$")):n.names.push(new RegExp("^"+u+"$")))}function o(){const u=[...n.names.map(a),...n.skips.map(a).map(d=>"-"+d)].join(",");return n.enable(""),u}function s(u){if(u[u.length-1]==="*")return!0;let d,h;for(d=0,h=n.skips.length;d<h;d++)if(n.skips[d].test(u))return!1;for(d=0,h=n.names.length;d<h;d++)if(n.names[d].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}var kw=Tw;(function(t,e){var n={};e.formatArgs=i,e.save=o,e.load=s,e.useColors=r,e.storage=a(),e.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let l;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(l=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(l[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;l.splice(1,0,u,"color: inherit");let d=0,h=0;l[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(d++,p==="%c"&&(h=d))}),l.splice(h,0,u)}e.log=console.debug||console.log||(()=>{});function o(l){try{l?e.storage.setItem("debug",l):e.storage.removeItem("debug")}catch{}}function s(){let l;try{l=e.storage.getItem("debug")}catch{}return!l&&typeof Ip<"u"&&"env"in Ip&&(l=n.DEBUG),l}function a(){try{return localStorage}catch{}}t.exports=kw(e);const{formatters:c}=t.exports;c.j=function(l){try{return JSON.stringify(l)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(tu,tu.exports),Nw();function jw(){this.__data__=[],this.size=0}var Iw=jw;function Rw(t,e){return t===e||t!==t&&e!==e}let ru;Wn=Rw,ru=Wn;function $w(t,e){for(var n=t.length;n--;)if(ru(t[n][0],e))return n;return-1}var Lr=$w,Bw=Lr,Dw=Array.prototype,Lw=Dw.splice;function Fw(t){var e=this.__data__,n=Bw(e,t);if(n<0)return!1;var r=e.length-1;return n==r?e.pop():Lw.call(e,n,1),--this.size,!0}var zw=Fw,Vw=Lr;function qw(t){var e=this.__data__,n=Vw(e,t);return n<0?void 0:e[n][1]}var Ww=qw,Hw=Lr;function Uw(t){return Hw(this.__data__,t)>-1}var Qw=Uw,Yw=Lr;function Xw(t,e){var n=this.__data__,r=Yw(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this}var Zw=Xw,Gw=Iw,Kw=zw,Jw=Ww,eM=Qw,tM=Zw;function Ht(t){var e=-1,n=t==null?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}Ht.prototype.clear=Gw,Ht.prototype.delete=Kw,Ht.prototype.get=Jw,Ht.prototype.has=eM,Ht.prototype.set=tM;var Fr=Ht,nM=Fr;function rM(){this.__data__=new nM,this.size=0}var iM=rM;function oM(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n}var sM=oM;function aM(t){return this.__data__.get(t)}var cM=aM;function lM(t){return this.__data__.has(t)}let iu,ou,go,su,au,cu,lu,uu,xo,bo,du,hu,Ut;iu=lM,ou=typeof tn=="object"&&tn&&tn.Object===Object&&tn,go=ou,su=go,au=typeof self=="object"&&self&&self.Object===Object&&self,cu=su||au||Function("return this")(),ze=cu,lu=ze,uu=lu.Symbol,nn=uu,xo=nn,bo=Object.prototype,du=bo.hasOwnProperty,hu=bo.toString,Ut=xo?xo.toStringTag:void 0;function uM(t){var e=du.call(t,Ut),n=t[Ut];try{t[Ut]=void 0;var r=!0}catch{}var i=hu.call(t);return r&&(e?t[Ut]=n:delete t[Ut]),i}var dM=uM,hM=Object.prototype,pM=hM.toString;function fM(t){return pM.call(t)}var mM=fM,pu=nn,yM=dM,gM=mM,xM="[object Null]",bM="[object Undefined]",fu=pu?pu.toStringTag:void 0;function vM(t){return t==null?t===void 0?bM:xM:fu&&fu in Object(t)?yM(t):gM(t)}_t=vM;function wM(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}lt=wM,Xp=Ue(lt);var MM=_t,EM=lt,CM="[object AsyncFunction]",_M="[object Function]",SM="[object GeneratorFunction]",OM="[object Proxy]";function AM(t){if(!EM(t))return!1;var e=MM(t);return e==_M||e==SM||e==CM||e==OM}Un=AM,Zp=Ue(Un);var NM=ze,PM=NM["__core-js_shared__"],TM=PM,vo=TM,mu=function(){var t=/[^.]+$/.exec(vo&&vo.keys&&vo.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function kM(t){return!!mu&&mu in t}var jM=kM,IM=Function.prototype,RM=IM.toString;function $M(t){if(t!=null){try{return RM.call(t)}catch{}try{return t+""}catch{}}return""}var yu=$M,BM=Un,DM=jM,LM=lt,FM=yu,zM=/[\\^$.*+?()[\]{}|]/g,VM=/^\[object .+?Constructor\]$/,qM=Function.prototype,WM=Object.prototype,HM=qM.toString,UM=WM.hasOwnProperty,QM=RegExp("^"+HM.call(UM).replace(zM,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function YM(t){if(!LM(t)||DM(t))return!1;var e=BM(t)?QM:VM;return e.test(FM(t))}var XM=YM;function ZM(t,e){return t==null?void 0:t[e]}var GM=ZM,KM=XM,JM=GM;function e1(t,e){var n=JM(t,e);return KM(n)?n:void 0}var bt=e1,t1=bt,n1=ze,r1=t1(n1,"Map"),wo=r1,i1=bt,o1=i1(Object,"create"),zr=o1,gu=zr;function s1(){this.__data__=gu?gu(null):{},this.size=0}var a1=s1;function c1(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var l1=c1,u1=zr,d1="__lodash_hash_undefined__",h1=Object.prototype,p1=h1.hasOwnProperty;function f1(t){var e=this.__data__;if(u1){var n=e[t];return n===d1?void 0:n}return p1.call(e,t)?e[t]:void 0}var m1=f1,y1=zr,g1=Object.prototype,x1=g1.hasOwnProperty;function b1(t){var e=this.__data__;return y1?e[t]!==void 0:x1.call(e,t)}var v1=b1,w1=zr,M1="__lodash_hash_undefined__";function E1(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=w1&&e===void 0?M1:e,this}var C1=E1,_1=a1,S1=l1,O1=m1,A1=v1,N1=C1;function Qt(t){var e=-1,n=t==null?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}Qt.prototype.clear=_1,Qt.prototype.delete=S1,Qt.prototype.get=O1,Qt.prototype.has=A1,Qt.prototype.set=N1;var P1=Qt,xu=P1,T1=Fr,k1=wo;function j1(){this.size=0,this.__data__={hash:new xu,map:new(k1||T1),string:new xu}}var I1=j1;function R1(t){var e=typeof t;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?t!=="__proto__":t===null}var $1=R1,B1=$1;function D1(t,e){var n=t.__data__;return B1(e)?n[typeof e=="string"?"string":"hash"]:n.map}var Vr=D1,L1=Vr;function F1(t){var e=L1(this,t).delete(t);return this.size-=e?1:0,e}var z1=F1,V1=Vr;function q1(t){return V1(this,t).get(t)}var W1=q1,H1=Vr;function U1(t){return H1(this,t).has(t)}var Q1=U1,Y1=Vr;function X1(t,e){var n=Y1(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this}var Z1=X1,G1=I1,K1=z1,J1=W1,eE=Q1,tE=Z1;function Yt(t){var e=-1,n=t==null?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}Yt.prototype.clear=G1,Yt.prototype.delete=K1,Yt.prototype.get=J1,Yt.prototype.has=eE,Yt.prototype.set=tE;var Mo=Yt,nE=Fr,rE=wo,iE=Mo,oE=200;function sE(t,e){var n=this.__data__;if(n instanceof nE){var r=n.__data__;if(!rE||r.length<oE-1)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new iE(r)}return n.set(t,e),this.size=n.size,this}var aE=sE,cE=Fr,lE=iM,uE=sM,dE=cM,hE=iu,pE=aE;function Xt(t){var e=this.__data__=new cE(t);this.size=e.size}Xt.prototype.clear=lE,Xt.prototype.delete=uE,Xt.prototype.get=dE,Xt.prototype.has=hE,Xt.prototype.set=pE;let bu;ui=Xt,bu="__lodash_hash_undefined__";function fE(t){return this.__data__.set(t,bu),this}var mE=fE;function yE(t){return this.__data__.has(t)}var gE=yE,xE=Mo,bE=mE,vE=gE;function qr(t){var e=-1,n=t==null?0:t.length;for(this.__data__=new xE;++e<n;)this.add(t[e])}qr.prototype.add=qr.prototype.push=bE,qr.prototype.has=vE,ks=qr;function wE(t,e){for(var n=-1,r=t==null?0:t.length;++n<r;)if(e(t[n],n,t))return!0;return!1}ps=wE;function ME(t,e){return t.has(e)}let vu,wu,Mu,Eu,Cu;js=ME,vu=ks,wu=ps,Mu=js,Eu=1,Cu=2;function EE(t,e,n,r,i,o){var s=n&Eu,a=t.length,c=e.length;if(a!=c&&!(s&&c>a))return!1;var l=o.get(t),u=o.get(e);if(l&&u)return l==e&&u==t;var d=-1,h=!0,p=n&Cu?new vu:void 0;for(o.set(t,e),o.set(e,t);++d<a;){var f=t[d],m=e[d];if(r)var y=s?r(m,f,d,e,t,o):r(f,m,d,t,e,o);if(y!==void 0){if(y)continue;h=!1;break}if(p){if(!wu(e,function(g,w){if(!Mu(p,w)&&(f===g||i(f,g,n,r,o)))return p.push(w)})){h=!1;break}}else if(!(f===m||i(f,m,n,r,o))){h=!1;break}}return o.delete(t),o.delete(e),h}let Eo,_u,Su;Eo=EE,_u=ze,Su=_u.Uint8Array,xs=Su;function CE(t){var e=-1,n=Array(t.size);return t.forEach(function(r,i){n[++e]=[i,r]}),n}var _E=CE;function SE(t){var e=-1,n=Array(t.size);return t.forEach(function(r){n[++e]=r}),n}let Co,_o,Ou,Au,Nu,Pu,Tu,ku,ju,Iu,Ru,$u,Bu,Du,Lu,Fu,zu,Vu,qu,So,Wr;Ts=SE,Co=nn,_o=xs,Ou=Wn,Au=Eo,Nu=_E,Pu=Ts,Tu=1,ku=2,ju="[object Boolean]",Iu="[object Date]",Ru="[object Error]",$u="[object Map]",Bu="[object Number]",Du="[object RegExp]",Lu="[object Set]",Fu="[object String]",zu="[object Symbol]",Vu="[object ArrayBuffer]",qu="[object DataView]",So=Co?Co.prototype:void 0,Wr=So?So.valueOf:void 0;function OE(t,e,n,r,i,o,s){switch(n){case qu:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case Vu:return!(t.byteLength!=e.byteLength||!o(new _o(t),new _o(e)));case ju:case Iu:case Bu:return Ou(+t,+e);case Ru:return t.name==e.name&&t.message==e.message;case Du:case Fu:return t==e+"";case $u:var a=Nu;case Lu:var c=r&Tu;if(a||(a=Pu),t.size!=e.size&&!c)return!1;var l=s.get(t);if(l)return l==e;r|=ku,s.set(t,e);var u=Au(a(t),a(e),r,i,o,s);return s.delete(t),u;case zu:if(Wr)return Wr.call(t)==Wr.call(e)}return!1}var AE=OE;function NE(t,e){for(var n=-1,r=e.length,i=t.length;++n<r;)t[i+n]=e[n];return t}let Wu,Hu,Uu;ni=NE,Wu=Array.isArray,Ye=Wu,Hu=ni,Uu=Ye;function PE(t,e,n){var r=e(t);return Uu(t)?r:Hu(r,n(t))}var Qu=PE;function TE(t,e){for(var n=-1,r=t==null?0:t.length,i=0,o=[];++n<r;){var s=t[n];e(s,n,t)&&(o[i++]=s)}return o}var kE=TE;function jE(){return[]}let Oo,Yu,Xu,Zu,Gu,Ao,Ku;Oo=jE,Yu=kE,Xu=Oo,Zu=Object.prototype,Gu=Zu.propertyIsEnumerable,Ao=Object.getOwnPropertySymbols,Ku=Ao?function(t){return t==null?[]:(t=Object(t),Yu(Ao(t),function(e){return Gu.call(t,e)}))}:Xu,ci=Ku;function IE(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}var RE=IE;function $E(t){return t!=null&&typeof t=="object"}let Ju,ed,td;At=$E,Ju=_t,ed=At,td="[object Arguments]";function BE(t){return ed(t)&&Ju(t)==td}let nd,No,rd,Po,id,od,sd,jn;nd=BE,No=nd,rd=At,Po=Object.prototype,id=Po.hasOwnProperty,od=Po.propertyIsEnumerable,sd=No(function(){return arguments}())?No:function(t){return rd(t)&&id.call(t,"callee")&&!od.call(t,"callee")},ti=sd,jn={exports:{}};function DE(){return!1}var LE=DE;jn.exports,function(t,e){var n=ze,r=LE,i=e&&!e.nodeType&&e,o=i&&!0&&t&&!t.nodeType&&t,s=o&&o.exports===i,a=s?n.Buffer:void 0,c=a?a.isBuffer:void 0,l=c||r;t.exports=l}(jn,jn.exports);let ad,cd;di=jn.exports,ad=9007199254740991,cd=/^(?:0|[1-9]\d*)$/;function FE(t,e){var n=typeof t;return e=e??ad,!!e&&(n=="number"||n!="symbol"&&cd.test(t))&&t>-1&&t%1==0&&t<e}let ld;Hn=FE,ld=9007199254740991;function zE(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=ld}var To=zE,VE=_t,qE=To,WE=At,HE="[object Arguments]",UE="[object Array]",QE="[object Boolean]",YE="[object Date]",XE="[object Error]",ZE="[object Function]",GE="[object Map]",KE="[object Number]",JE="[object Object]",eC="[object RegExp]",tC="[object Set]",nC="[object String]",rC="[object WeakMap]",iC="[object ArrayBuffer]",oC="[object DataView]",sC="[object Float32Array]",aC="[object Float64Array]",cC="[object Int8Array]",lC="[object Int16Array]",uC="[object Int32Array]",dC="[object Uint8Array]",hC="[object Uint8ClampedArray]",pC="[object Uint16Array]",fC="[object Uint32Array]",ye={};ye[sC]=ye[aC]=ye[cC]=ye[lC]=ye[uC]=ye[dC]=ye[hC]=ye[pC]=ye[fC]=!0,ye[HE]=ye[UE]=ye[iC]=ye[QE]=ye[oC]=ye[YE]=ye[XE]=ye[ZE]=ye[GE]=ye[KE]=ye[JE]=ye[eC]=ye[tC]=ye[nC]=ye[rC]=!1;function mC(t){return WE(t)&&qE(t.length)&&!!ye[VE(t)]}var yC=mC;function gC(t){return function(e){return t(e)}}let In;ls=gC,In={exports:{}},In.exports,function(t,e){var n=go,r=e&&!e.nodeType&&e,i=r&&!0&&t&&!t.nodeType&&t,o=i&&i.exports===r,s=o&&n.process,a=function(){try{var c=i&&i.require&&i.require("util").types;return c||s&&s.binding&&s.binding("util")}catch{}}();t.exports=a}(In,In.exports);let ud,dd,ko,jo,hd,pd,fd,md,yd,gd,xd,bd,vd;vs=In.exports,ud=yC,dd=ls,ko=vs,jo=ko&&ko.isTypedArray,hd=jo?dd(jo):ud,hi=hd,pd=RE,fd=ti,md=Ye,yd=di,gd=Hn,xd=hi,bd=Object.prototype,vd=bd.hasOwnProperty;function xC(t,e){var n=md(t),r=!n&&fd(t),i=!n&&!r&&yd(t),o=!n&&!r&&!i&&xd(t),s=n||r||i||o,a=s?pd(t.length,String):[],c=a.length;for(var l in t)(e||vd.call(t,l))&&!(s&&(l=="length"||i&&(l=="offset"||l=="parent")||o&&(l=="buffer"||l=="byteLength"||l=="byteOffset")||gd(l,c)))&&a.push(l);return a}var wd=xC,bC=Object.prototype;function vC(t){var e=t&&t.constructor,n=typeof e=="function"&&e.prototype||bC;return t===n}li=vC;function wC(t,e){return function(n){return t(e(n))}}var Md=wC,MC=Md,EC=MC(Object.keys,Object),CC=EC,_C=li,SC=CC,OC=Object.prototype,AC=OC.hasOwnProperty;function NC(t){if(!_C(t))return SC(t);var e=[];for(var n in Object(t))AC.call(t,n)&&n!="constructor"&&e.push(n);return e}var PC=NC,TC=Un,kC=To;function jC(t){return t!=null&&kC(t.length)&&!TC(t)}let Ed,Cd,_d;ii=jC,Ed=wd,Cd=PC,_d=ii;function IC(t){return _d(t)?Ed(t):Cd(t)}let Sd,Od,Ad;ri=IC,Sd=Qu,Od=ci,Ad=ri;function RC(t){return Sd(t,Ad,Od)}let Io,Nd,Pd,Td;ws=RC,Io=ws,Nd=1,Pd=Object.prototype,Td=Pd.hasOwnProperty;function $C(t,e,n,r,i,o){var s=n&Nd,a=Io(t),c=a.length,l=Io(e),u=l.length;if(c!=u&&!s)return!1;for(var d=c;d--;){var h=a[d];if(!(s?h in e:Td.call(e,h)))return!1}var p=o.get(t),f=o.get(e);if(p&&f)return p==e&&f==t;var m=!0;o.set(t,e),o.set(e,t);for(var y=s;++d<c;){h=a[d];var g=t[h],w=e[h];if(r)var v=s?r(w,g,h,e,t,o):r(g,w,h,t,e,o);if(!(v===void 0?g===w||i(g,w,n,r,o):v)){m=!1;break}y||(y=h=="constructor")}if(m&&!y){var x=t.constructor,C=e.constructor;x!=C&&"constructor"in t&&"constructor"in e&&!(typeof x=="function"&&x instanceof x&&typeof C=="function"&&C instanceof C)&&(m=!1)}return o.delete(t),o.delete(e),m}let kd,jd,Id,Rd,$d,Bd,Dd,Ld,Fd,zd,Vd,qd,Wd,Hd,Ud,Qd,Hr,Ur,Qr,Yr,Xr,Ro,vt,$o,Yd,Bo,Do,Lo,Fo,Xd,Zd,Gd,Kd,Jd,st;kd=$C,jd=bt,Id=ze,Rd=jd(Id,"DataView"),$d=Rd,Bd=bt,Dd=ze,Ld=Bd(Dd,"Promise"),Fd=Ld,zd=bt,Vd=ze,qd=zd(Vd,"Set"),Ps=qd,Wd=bt,Hd=ze,Ud=Wd(Hd,"WeakMap"),Qd=Ud,Hr=$d,Ur=wo,Qr=Fd,Yr=Ps,Xr=Qd,Ro=_t,vt=yu,$o="[object Map]",Yd="[object Object]",Bo="[object Promise]",Do="[object Set]",Lo="[object WeakMap]",Fo="[object DataView]",Xd=vt(Hr),Zd=vt(Ur),Gd=vt(Qr),Kd=vt(Yr),Jd=vt(Xr),st=Ro,(Hr&&st(new Hr(new ArrayBuffer(1)))!=Fo||Ur&&st(new Ur)!=$o||Qr&&st(Qr.resolve())!=Bo||Yr&&st(new Yr)!=Do||Xr&&st(new Xr)!=Lo)&&(st=function(t){var e=Ro(t),n=e==Yd?t.constructor:void 0,r=n?vt(n):"";if(r)switch(r){case Xd:return Fo;case Zd:return $o;case Gd:return Bo;case Kd:return Do;case Jd:return Lo}return e});let Zr,eh,th,nh,zo,Vo,qo,rh,ih,Wo,Ho,Rn,oh,Uo;bs=st,Zr=ui,eh=Eo,th=AE,nh=kd,zo=bs,Vo=Ye,qo=di,rh=hi,ih=1,Wo="[object Arguments]",Ho="[object Array]",Rn="[object Object]",oh=Object.prototype,Uo=oh.hasOwnProperty;function BC(t,e,n,r,i,o){var s=Vo(t),a=Vo(e),c=s?Ho:zo(t),l=a?Ho:zo(e);c=c==Wo?Rn:c,l=l==Wo?Rn:l;var u=c==Rn,d=l==Rn,h=c==l;if(h&&qo(t)){if(!qo(e))return!1;s=!0,u=!1}if(h&&!u)return o||(o=new Zr),s||rh(t)?eh(t,e,n,r,i,o):th(t,e,c,n,r,i,o);if(!(n&ih)){var p=u&&Uo.call(t,"__wrapped__"),f=d&&Uo.call(e,"__wrapped__");if(p||f){var m=p?t.value():t,y=f?e.value():e;return o||(o=new Zr),i(m,y,n,r,o)}}return h?(o||(o=new Zr),nh(t,e,n,r,i,o)):!1}var DC=BC,LC=DC,sh=At;function ah(t,e,n,r,i){return t===e?!0:t==null||e==null||!sh(t)&&!sh(e)?t!==t&&e!==e:LC(t,e,n,r,ah,i)}let ch,lh,uh,dh;si=ah,ch=ui,lh=si,uh=1,dh=2;function FC(t,e,n,r){var i=n.length,o=i,s=!r;if(t==null)return!o;for(t=Object(t);i--;){var a=n[i];if(s&&a[2]?a[1]!==t[a[0]]:!(a[0]in t))return!1}for(;++i<o;){a=n[i];var c=a[0],l=t[c],u=a[1];if(s&&a[2]){if(l===void 0&&!(c in t))return!1}else{var d=new ch;if(r)var h=r(l,u,c,t,e,d);if(!(h===void 0?lh(u,l,uh|dh,r,d):h))return!1}}return!0}var zC=FC,VC=lt;function qC(t){return t===t&&!VC(t)}var hh=qC,WC=hh,HC=ri;function UC(t){for(var e=HC(t),n=e.length;n--;){var r=e[n],i=t[r];e[n]=[r,i,WC(i)]}return e}var QC=UC;function YC(t,e){return function(n){return n==null?!1:n[t]===e&&(e!==void 0||t in Object(n))}}var ph=YC,XC=zC,ZC=QC,GC=ph;function KC(t){var e=ZC(t);return e.length==1&&e[0][2]?GC(e[0][0],e[0][1]):function(n){return n===t||XC(n,t,e)}}var JC=KC,e_=_t,t_=At,n_="[object Symbol]";function r_(t){return typeof t=="symbol"||t_(t)&&e_(t)==n_}let fh,mh,yh,gh;zn=r_,fh=Ye,mh=zn,yh=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,gh=/^\w*$/;function i_(t,e){if(fh(t))return!1;var n=typeof t;return n=="number"||n=="symbol"||n=="boolean"||t==null||mh(t)?!0:gh.test(t)||!yh.test(t)||e!=null&&t in Object(e)}var Qo=i_,xh=Mo,o_="Expected a function";function Yo(t,e){if(typeof t!="function"||e!=null&&typeof e!="function")throw new TypeError(o_);var n=function(){var r=arguments,i=e?e.apply(this,r):r[0],o=n.cache;if(o.has(i))return o.get(i);var s=t.apply(this,r);return n.cache=o.set(i,s)||o,s};return n.cache=new(Yo.Cache||xh),n}Yo.Cache=xh;var bh=Yo;Bp=Ue(bh);var s_=bh,a_=500;function c_(t){var e=s_(t,function(r){return n.size===a_&&n.clear(),r}),n=e.cache;return e}var l_=c_,u_=l_,d_=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,h_=/\\(\\)?/g,p_=u_(function(t){var e=[];return t.charCodeAt(0)===46&&e.push(""),t.replace(d_,function(n,r,i,o){e.push(i?o.replace(h_,"$1"):r||n)}),e}),f_=p_;function m_(t,e){for(var n=-1,r=t==null?0:t.length,i=Array(r);++n<r;)i[n]=e(t[n],n,t);return i}let Xo,vh,wh,Mh,Eh,Zo,Go;oi=m_,Xo=nn,vh=oi,wh=Ye,Mh=zn,Eh=1/0,Zo=Xo?Xo.prototype:void 0,Go=Zo?Zo.toString:void 0;function Ch(t){if(typeof t=="string")return t;if(wh(t))return vh(t,Ch)+"";if(Mh(t))return Go?Go.call(t):"";var e=t+"";return e=="0"&&1/t==-Eh?"-0":e}var y_=Ch,g_=y_;function x_(t){return t==null?"":g_(t)}let _h,Sh,Oh,Ah;Ns=x_,_h=Ye,Sh=Qo,Oh=f_,Ah=Ns;function b_(t,e){return _h(t)?t:Sh(t,e)?[t]:Oh(Ah(t))}let Nh,Ph;on=b_,Nh=zn,Ph=1/0;function v_(t){if(typeof t=="string"||Nh(t))return t;var e=t+"";return e=="0"&&1/t==-Ph?"-0":e}let Th,kh;Ot=v_,Th=on,kh=Ot;function w_(t,e){e=Th(e,t);for(var n=0,r=e.length;t!=null&&n<r;)t=t[kh(e[n++])];return n&&n==r?t:void 0}let jh;Vn=w_,jh=Vn;function M_(t,e,n){var r=t==null?void 0:jh(t,e);return r===void 0?n:r}var Ih=M_;Yp=Ue(Ih);function E_(t,e){return t!=null&&e in Object(t)}var C_=E_,__=on,S_=ti,O_=Ye,A_=Hn,N_=To,P_=Ot;function T_(t,e,n){e=__(e,t);for(var r=-1,i=e.length,o=!1;++r<i;){var s=P_(e[r]);if(!(o=t!=null&&n(t,s)))break;t=t[s]}return o||++r!=i?o:(i=t==null?0:t.length,!!i&&N_(i)&&A_(s,i)&&(O_(t)||S_(t)))}var k_=T_,j_=C_,I_=k_;function R_(t,e){return t!=null&&I_(t,e,j_)}let Rh,$h,Bh,Dh,Lh,Fh,zh,Vh,qh;_s=R_,Rh=si,$h=Ih,Bh=_s,Dh=Qo,Lh=hh,Fh=ph,zh=Ot,Vh=1,qh=2;function $_(t,e){return Dh(t)&&Lh(e)?Fh(zh(t),e):function(n){var r=$h(n,t);return r===void 0&&r===e?Bh(n,t):Rh(e,r,Vh|qh)}}var B_=$_;function D_(t){return t}us=D_;function L_(t){return function(e){return e==null?void 0:e[t]}}var F_=L_,z_=Vn;function V_(t){return function(e){return z_(e,t)}}var q_=V_,W_=F_,H_=q_,U_=Qo,Q_=Ot;function Y_(t){return U_(t)?W_(Q_(t)):H_(t)}var X_=Y_,Z_=JC,G_=B_,K_=us,J_=Ye,eS=X_;function tS(t){return typeof t=="function"?t:t==null?K_:typeof t=="object"?J_(t)?G_(t[0],t[1]):Z_(t):eS(t)}let Wh;yi=tS,Wh="Expected a function";function nS(t){if(typeof t!="function")throw new TypeError(Wh);return function(){var e=arguments;switch(e.length){case 0:return!t.call(this);case 1:return!t.call(this,e[0]);case 2:return!t.call(this,e[0],e[1]);case 3:return!t.call(this,e[0],e[1],e[2])}return!t.apply(this,e)}}let Hh,Uh,Qh,Ko;Hh=nS,Uh=bt,Qh=function(){try{var t=Uh(Object,"defineProperty");return t({},"",{}),t}catch{}}(),ds=Qh,Ko=ds;function rS(t,e,n){e=="__proto__"&&Ko?Ko(t,e,{configurable:!0,enumerable:!0,value:n,writable:!0}):t[e]=n}let Yh,Xh,Zh,Gh;fs=rS,Yh=fs,Xh=Wn,Zh=Object.prototype,Gh=Zh.hasOwnProperty;function iS(t,e,n){var r=t[e];(!(Gh.call(t,e)&&Xh(r,n))||n===void 0&&!(e in t))&&Yh(t,e,n)}let Kh,Jh,ep,Jo,tp;ms=iS,Kh=ms,Jh=on,ep=Hn,Jo=lt,tp=Ot;function oS(t,e,n,r){if(!Jo(t))return t;e=Jh(e,t);for(var i=-1,o=e.length,s=o-1,a=t;a!=null&&++i<o;){var c=tp(e[i]),l=n;if(c==="__proto__"||c==="constructor"||c==="prototype")return t;if(i!=s){var u=a[c];l=r?r(u,c,a):void 0,l===void 0&&(l=Jo(u)?u:ep(e[i+1])?[]:{})}Kh(a,c,l),a=a[c]}return t}var sS=oS,aS=Vn,cS=sS,lS=on;function uS(t,e,n){for(var r=-1,i=e.length,o={};++r<i;){var s=e[r],a=aS(t,s);n(a,s)&&cS(o,lS(s,t),a)}return o}let np,rp,ip,op,sp,ap,cp,lp;Cs=uS,np=Md,rp=np(Object.getPrototypeOf,Object),hs=rp,ip=ni,op=hs,sp=ci,ap=Oo,cp=Object.getOwnPropertySymbols,lp=cp?function(t){for(var e=[];t;)ip(e,sp(t)),t=op(t);return e}:ap,gs=lp;function dS(t){var e=[];if(t!=null)for(var n in Object(t))e.push(n);return e}var hS=dS,pS=lt,fS=li,mS=hS,yS=Object.prototype,gS=yS.hasOwnProperty;function xS(t){if(!pS(t))return mS(t);var e=fS(t),n=[];for(var r in t)r=="constructor"&&(e||!gS.call(t,r))||n.push(r);return n}var bS=xS,vS=wd,wS=bS,MS=ii;function ES(t){return MS(t)?vS(t,!0):wS(t)}let up,dp,hp;ys=ES,up=Qu,dp=gs,hp=ys;function CS(t){return up(t,hp,dp)}let pp,fp,mp,yp;Ms=CS,pp=oi,fp=yi,mp=Cs,yp=Ms;function _S(t,e){if(t==null)return{};var n=pp(yp(t),function(r){return[r]});return e=fp(e),mp(t,n,function(r,i){return e(r,i[0])})}var SS=_S,OS=yi,AS=Hh,NS=SS;function PS(t,e){return NS(t,AS(OS(e)))}var TS=PS;Xn=Ue(TS);function kS(t){return t===void 0}var jS=kS;let es,gp,ts,Gr,Kr,Jr,$n,Zt,xp,bp,vp,wp,Mp,ns,Ep,Cp,_p,Sp,Op,rs;Yn=Ue(jS),es=(t,e)=>({id:t.id,type:t.node_type,position:{x:t.x||0,y:t.y||0},width:t.width||void 0,height:t.height||void 0,data:{loading:!1,flowNode:t,...e}}),gp=t=>({id:t.id,target:t.target,source:t.target,targetHandle:t.targetHandle,sourceHandle:t.sourceHandle}),ts=t=>({id:t.id,source:t.source,target:t.target,targetHandle:t.targetHandle,sourceHandle:t.sourceHandle}),Qp=t=>t.filter(e=>"edgeId"in e?`${e.edgeId}`.startsWith("xy-edge__"):!1),Gr=(t,e,n)=>{const r=[];return{changes:t.map(i=>{var c;const o=e.find(l=>i.id===l.id);o||r.push(i.id);const s=(c=n==null?void 0:n[i.source_type])==null?void 0:c.find(l=>(l==null?void 0:l.id)===i.source_id),a=es(i,{...o==null?void 0:o.data,entity:s});return{type:o?"replace":"add",id:i.id,item:o?Zn({...o||{},data:void 0},Xn(a,Yn)):a}}),newIds:[]}},Kr=(t,e)=>{const n=[],r=[],i=t.map(o=>{const s=e.find(a=>o.source===a.source&&o.target===a.target);return!s||s.id!==o.id?(s&&r.push(s.id),{type:"add",item:ts(o)}):(n.push(o.id),{type:"replace",item:ts(o)})});return e.forEach(o=>{n.includes(o.id)||r.push(o.id)}),{changes:i,updatedIds:n,deletedIds:r}},Jr={width:440,height:360},$n={width:380,height:650},Zt={[Te.Toolbox]:"toolbox",[Te.SessionInfo]:"session-info",[Te.DefaultEmbeddingModel]:"default-embedding-model",[Te.ApplicationBar]:"application-bar"},xp={id:Zt[Te.Toolbox],type:Te.Toolbox,position:{x:10+$n.width+20,y:10},measured:Jr,data:{}},bp={id:Zt[Te.SessionInfo],type:Te.SessionInfo,position:{x:10,y:10},measured:$n,data:{}},vp={id:Zt[Te.DefaultEmbeddingModel],type:Te.DefaultEmbeddingModel,position:{x:10+$n.width+Jr.width+40,y:10},data:{model:xO}},wp={id:Zt[Te.ApplicationBar],type:Te.ApplicationBar,position:{x:10+$n.width+Jr.width+40,y:80},data:{}},Mp=[xp,bp,vp,wp],ns={flowNodes:[],flowEdges:[],ready:!0,flowEdgeLoading:!1,flowNodeLoading:!1,syncedNodes:[],syncedEdges:[],syncNodeQueue:[],syncEdgeQueue:[],edges:[],nodes:Mp},Ep=(t,e)=>({reset:()=>{t(ns)},setNodes:n=>{if(typeof n=="function"){t({nodes:n(e().nodes)});return}t({nodes:n})},setEdges:n=>{if(typeof n=="function"){t({edges:n(e().edges)});return}t({edges:n})},updateNodes:n=>{const r=e().nodes;t({nodes:mt(n,r)})},updateEdges:n=>{const r=e().edges;t({edges:Sn(n,r)})},addConnectionToEdges:n=>{const r=e().edges;t({edges:Ja(n,r)})},flowNodesToNodes:(n,r={})=>{const i=e().nodes,{changes:o}=Gr(n,i,r);t({nodes:mt(o,i)})},flowEdgesToEdges:n=>{const r=e().edges,{changes:i,updatedIds:o,deletedIds:s}=Kr(n,r);r.forEach(a=>{o.includes(a.id)||s.push(a.id)}),s.forEach(a=>{i.push({type:"remove",id:a})}),t({edges:Sn(i,r)})},getNodes:n=>e().nodes.filter(r=>n.includes(r.id)),removeSyncNodeQueue:n=>{const{syncNodeQueue:r}=e();for(const i of n){const o=r.findIndex(s=>s.timestamp===i);o>-1&&r.splice(o,1)}t({syncNodeQueue:r})},removeSyncEdgeQueue:n=>{const{syncEdgeQueue:r}=e();for(const i of n){const o=r.findIndex(s=>s.timestamp===i);o>-1&&r.splice(o,1)}t({syncEdgeQueue:r})},pushSyncNodeQueue:(n,r)=>{const{syncNodeQueue:i}=e();t({syncNodeQueue:[...i,{query:r,timestamp:Date.now(),syncType:n}]})},pushSyncEdgeQueue:()=>{const{syncEdgeQueue:n}=e();t({syncEdgeQueue:[...n,{timestamp:Date.now()}]})},findFlowNodesWithSource:async(n,r)=>{try{t({flowNodeLoading:!0});const i=await Me("FlowNode").find(n),o=i.reduce((a,c)=>{var l;return a[c.source_type]||(a[c.source_type]=[]),(l=a[c.source_type])==null||l.push(c),a},{}),s={};if(await Promise.all(Object.entries(o).map(async([a,c])=>{const l=a;s[l]=await Me(l).find({where:{id:ct(c.map(u=>u.source_id))}})})),r==null?void 0:r.clean)t({flowNodes:i,nodes:i.map(a=>{var l;const c=(l=s==null?void 0:s[a.source_type])==null?void 0:l.find(u=>u.id===a.source_id);return es(a,{data:c})})});else{const a=e().flowNodes,c=i.map(d=>d.id),l=e().nodes,{changes:u}=Gr(i,l,s);t({flowNodes:[...a.filter(d=>!c.includes(d.id)),...i],nodes:mt(u,l)})}return i}finally{t({flowNodeLoading:!1})}},findFlowEdges:async(n,r)=>{try{t({flowEdgeLoading:!0});const i=await Me("FlowEdge").find(n),o=e().flowEdges,s=i.map(a=>a.id);if(r!=null&&r.clean)t({flowEdges:i,edges:i.map(a=>gp(a))});else{const a=e().edges,{changes:c}=Kr(i,a);t({flowEdges:[...o.filter(l=>!s.includes(l.id)),...i],edges:Sn(c,a)})}return i}finally{t({flowEdgeLoading:!1})}},deleteFlowNode:async n=>{try{if(!n.id&&!n.source_type&&!n.source_id)throw new Error("Missing flow node indentify");const r=await Me("FlowNode").findOne({where:n.id?{id:n.id}:{source_type:n.source_type,source_id:n.source_id}});if(r){await Me("FlowNode").delete(r.id);const i=e().flowNodes;r.source_type&&r.source_id&&await Me(r.source_type).delete(r.source_id).catch(s=>{console.warn("Failed to delete source entity",r.source_type,r.source_id,s)});const o=e().nodes;t({flowNodes:i.filter(s=>s.id!==r.id),nodes:mt([{type:"remove",id:r.id}],o)})}}catch(r){console.warn("Failed to delete flow node",r)}},deleteFlowEdge:async n=>{try{if(!n.id&&!n.source&&!n.target)throw new Error("Missing flow edge indentify");const r=await Me("FlowEdge").findOne({where:n.id?{id:n.id}:{source:n.source,target:n.target}});if(r){await Me("FlowEdge").delete(r.id);const i=e().flowEdges;t({flowEdges:i.filter(o=>o.id!==r.id)})}}catch(r){console.warn("Failed to delete flow edge",r)}},updateFlowNode:async(n,r)=>{var i;try{if(!((i=Fn.getState().currentSession)!=null&&i.id))throw new Error("Session not found");if(!n.id)throw new Error("Missing flow node indentify");await Me("FlowNode").update(n.id,n);const o=e().flowNodes.map(s=>s.id===n.id?{...s,...n}:s);t({flowNodes:r!=null&&r.silent?o:[...o]})}catch(o){console.warn("Failed to create or update flow node",o,n)}},createOrUpdateFlowNode:async(n,r)=>{var i;try{const o=Fn.getState().currentSession;if(!(o!=null&&o.id))throw new Error("Session not found");if(!n.id&&(!n.source_type||!n.source_id))throw new Error("Missing flow node indentify");let s,a=n!=null&&n.id?e().flowNodes.find(p=>p.id===n.id):void 0;if(!a&&(n.id||n.source_type&&n.source_id)&&(a=await Me("FlowNode").findOne({where:n.id?{id:n.id}:{source_type:n.source_type,source_id:n.source_id}})),a)s=Zn(a,Xn(n,Yn)),r!=null&&r.lazy?Me("FlowNode").update(a.id,s):await Me("FlowNode").update(a.id,s);else if(n.source_id&&n.source_type)s={...n,source_id:`${n.source_id}`,source_type:`${n.source_type}`,node_type:n.node_type||"NEW_MESSAGE",session_id:n.session_id||(o==null?void 0:o.id)},r!=null&&r.lazy?(s.id=Rp(),Me("FlowNode").save(s)):s=await Me("FlowNode").save(s);else throw new Error("Missing source id and type");let c;const l=e().nodes.find(p=>p.id===s.id);s.source_type&&!l?c=await Me(s.source_type).findOne({where:{id:n.source_id}}):s.source_type&&l&&(c=(i=l==null?void 0:l.data)==null?void 0:i.entity);const u=e().flowNodes,d=e().nodes,{changes:h}=Gr([s],d,{[s.source_type]:[c]});return t({flowNodes:[...u.filter(p=>p.id!==s.id),s],nodes:mt(h,d)}),s}catch(o){console.warn("Failed to create or update flow node",o,n)}},createOrUpdateFlowEdge:async(n,r)=>{try{const i=Fn.getState().currentSession;if(!(i!=null&&i.id))throw new Error("Session not found");if(!n.id&&(!n.source||!n.target))throw new Error("Missing flow node indentify");let o,s=n!=null&&n.id?e().flowEdges.find(l=>l.id===n.id):void 0;if(s&&(n.id||n.source&&n.target)&&(s=await Me("FlowEdge").findOne({where:n.id?{id:n.id}:{source:n.source,target:n.target}})),s)o=Zn(s,Xn(n,Yn)),r!=null&&r.lazy?Me("FlowEdge").update(s.id,o):await Me("FlowEdge").update(s.id,o);else if(n.source&&n.target)o={...n,source:`${n.source}`,target:`${n.target}`,session_id:n.session_id||(i==null?void 0:i.id)},r!=null&&r.lazy?(o.id=Rp(),Me("FlowEdge").save(o)):o=await Me("FlowEdge").save(o);else throw new Error("Missing source and target");const a=e().flowEdges,c=e().edges;return t({flowEdges:[...a.filter(l=>l.id!==o.id),o],edges:Sn(Kr([o],c).changes,c)}),o}catch(i){console.warn("Failed to create or update flow node",i)}}}),Se=bO()(vO(wO((t,e)=>({...ns,...Ep(t,e)})))),Cp=()=>{const t=Se(E=>E.flowEdges),e=Fn(E=>E.currentSession),n=Se(E=>E.setNodes),r=Se(E=>E.updateNodes),i=Se(E=>E.updateEdges),o=Se(E=>E.addConnectionToEdges),s=Se(E=>E.reset),a=Se(E=>E.findFlowEdges),c=Se(E=>E.deleteFlowNode),l=Se(E=>E.deleteFlowEdge),u=Se(E=>E.updateFlowNode),d=Se(E=>E.getNodes),h=Se(E=>E.findFlowNodesWithSource),p=I.useRef(t),f=I.useRef(),[m,y]=I.useState({loading:!1});p.current=t;const g=I.useCallback(async(E,T)=>{try{f.current=E,s(),await(T==null?void 0:T())}catch{f.current=void 0}},[s]),w=I.useCallback(async E=>{try{if(!(e!=null&&e.id))return;y(z=>({...z,loading:!0}));const T=await h({...E,where:{...E.where,session_id:e.id}}),A=await a({where:[{source:ct(T.map(z=>z.id))},{target:ct(T.map(z=>z.id))}]});return{flowNodes:T,flowEdges:A}}finally{y(T=>({...T,loading:!1}))}},[h,a,e==null?void 0:e.id]),v=I.useCallback(async E=>{var T;for(const A of E)if("id"in A&&Object.values(Zt).includes(A.id))r([A]);else if(A.type==="position"&&A.position&&!isNaN(A.position.x)&&!isNaN(A.position.y))r([A]),await u({id:A.id,x:A.position.x,y:A.position.y},{silent:!0});else if(A.type==="remove")await c({id:A.id});else if(A.type==="dimensions"&&A.dimensions&&!isNaN(A.dimensions.width)&&!isNaN(A.dimensions.height)){const z=(T=d([A.id]))==null?void 0:T[0];if(!(z!=null&&z.width)&&!(z!=null&&z.height))return;r([A]),await u({id:A.id,width:A.dimensions.width,height:A.dimensions.height},{silent:!0})}else A.type==="select"&&r([A])},[r,u,c,d]),x=I.useCallback(E=>{Promise.all(E.map(async T=>{if(T.type==="remove")return l({id:T.id})})),i(E)},[l,i]),C=I.useCallback(E=>{o(E)},[o]),$=I.useCallback(()=>{var E;(E=p.current)==null||E.length},[]),O=I.useCallback(E=>{n(T=>{var F,b;let A;if(typeof E=="function"?A=E(T):A=E,!A)return T;const z=T==null?void 0:T.find(N=>N.id===A.id),V={id:A.id,item:z?Zn(z,A):{...A,position:{x:((F=A.position)==null?void 0:F.x)||0,y:((b=A.position)==null?void 0:b.y)||0}},type:z?"replace":"add"};return mt([V],T)})},[n]);return{syncEdges:$,initialFlow:g,loadingState:m,prepareFlowInfo:w,updateNodeChanges:v,updateEdgeChanges:x,updateOrCreateNode:O,currentSessionIdRef:f,updateEdgeConnection:C}},_p={initializing:!0,updateNodeChanges:function(t){throw new Error(JSON.stringify(t))},updateEdgeChanges:function(t){throw new Error(JSON.stringify(t))},updateEdgeConnection:function(t){throw new Error(JSON.stringify(t))}},cs=kp.createContext(_p),Sp=cs.Provider,Op=t=>{const e=Fn(u=>{var d;return(d=u.currentSession)==null?void 0:d.id}),{loadingState:n,prepareFlowInfo:r,syncEdges:i,initialFlow:o,currentSessionIdRef:s}=t,a=Se(u=>u.ready),c=Se(u=>u.removeSyncNodeQueue),l=Se(u=>u.removeSyncEdgeQueue);I.useLayoutEffect(()=>{},[e]),I.useEffect(()=>{n.loading||!a||!e||s.current===e||o(e,async()=>{await r({where:{session_id:e}})})},[o,r,n.loading,s,a,e]),I.useEffect(()=>{const u=Se.subscribe(h=>h.syncNodeQueue,async(h,p)=>{var y;const f=p.map(g=>g.timestamp),m=h.filter(g=>!f.includes(g.timestamp));if(m.length){c(m.map(g=>g.timestamp));for(const g of m){const w=await r(g.query);switch(g.syncType){case"Thread":{const v=(y=w==null?void 0:w.flowNodes)==null?void 0:y.map(x=>{if(x.source_id&&x.source_type==="Thread")return x.source_id}).filter(Boolean);if(v!=null&&v.length){const x=await Me("Message").find({where:{thread_id:ct(v)}});await r({where:{source_type:"Message",source_id:ct(x.map(C=>C.id))}})}}break}}}}),d=Se.subscribe(h=>h.syncEdgeQueue,async(h,p)=>{const f=p.map(y=>y.timestamp),m=h.filter(y=>!f.includes(y.timestamp));m.length&&(l(m.map(y=>y.timestamp)),i())});return()=>{u(),d()}},[r,l,c,i])},rs=({children:t})=>{const[e,n]=I.useState(!0),r=Cp(),i=$p(h=>h.selectedModel),o=I.useRef(i),s=$p(h=>h.setInitProgressCallback),{updateOrCreateNode:a,updateNodeChanges:c,updateEdgeChanges:l,updateEdgeConnection:u}=r;Op(r),o.current=i,I.useEffect(()=>{const h=s==null?void 0:s(p=>{if(!o.current)return;const f=`${o.current}`;a(m=>{const y=m==null?void 0:m.find(g=>{var w;return(w=g.data)!=null&&w.entity&&typeof g.data.entity=="object"&&"name"in g.data.entity?g.data.entity.name===f:!1});if(y)return y.data.label=p.text,y.data.status=qn.Loading,p.progress===100&&(y.data.label="",y.data.status=qn.Loaded),y})});return()=>{h==null||h()}},[s,a]);const d=I.useMemo(()=>({updateNodeChanges:c,updateEdgeChanges:l,initializing:e,setInitializing:n,updateEdgeConnection:u}),[c,l,e,n,u]);return j.jsx(Sp,{value:d,children:t})},rs.displayName="HomePageProvider";const IS=I.lazy(()=>MO(()=>import("./index-GNJkwovY.js").then(async t=>(await t.__tla,t)).then(t=>t.r),__vite__mapDeps([0,1,2,3,4])));function RS(){return j.jsx(rs,{children:j.jsx(I.Suspense,{children:j.jsx(IS,{})})})}Wp=Object.freeze(Object.defineProperty({__proto__:null,default:RS},Symbol.toStringTag,{value:"Module"}))});export{cs as $,nn as A,ti as B,ni as C,ri as D,ii as E,Te as F,zn as G,rn as H,ct as I,oi as J,Vn as K,qn as L,ls as M,us as N,ds as O,re as P,Wn as Q,Hn as R,lt as S,ze as T,si as U,hs as V,ps as W,fs as X,Bp as Y,Dp as Z,_t as _,CO as __tla,St as a,Lp as a0,ut as a1,Fp as a2,nt as a3,zp as a4,Vp as a5,ai as a6,ms as a7,ys as a8,ci as a9,gs as aa,xs as ab,li as ac,bs as ad,vs as ae,ui as af,di as ag,ws as ah,Ms as ai,on as aj,Ot as ak,Un as al,hi as am,Es as an,Cs as ao,_s as ap,qp as aq,Wp as ar,pi as b,fi as c,Ss as d,Os as e,As as f,Hp as g,Qn as h,Qe as i,Up as j,Qp as k,Yn as l,Ye as m,At as n,Xn as o,Yp as p,Xp as q,Zp as r,mi as s,Ns as t,Se as u,Ps as v,Ts as w,ks as x,js as y,yi as z};
